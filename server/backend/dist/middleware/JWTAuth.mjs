import fs from 'fs';
import jwt from 'jsonwebtoken';
import lockfile from 'proper-lockfile';
import { HandleErrorStaticParameters } from '../index/interfaces/main.mjs';
import { LoggerServiceFactory } from '../index/factory/subfactories/LoggerServiceFactory.mjs';
import { ErrorHandlerServiceFactory } from '../index/factory/subfactories/ErrorHandlerServiceFactory.mjs';
import { GatekeeperServiceFactory } from '../index/factory/subfactories/GatekeeperServiceFactory.mjs';
import { CacheLayerServiceFactory } from '../index/factory/subfactories/CacheLayerServiceFactory.mjs';
import { EnvConfigServiceFactory } from '../index/factory/subfactories/EnvConfigServiceFactory.mjs';
import { AuthServiceFactory } from '../index/factory/subfactories/AuthServiceFactory.mjs';
export class JWTAuthMiddlewareService {
	static instance = null;
	logger;
	errorLogger;
	errorHandler;
	gatekeeperService;
	cacheService;
	expiredTokens = new Set();
	revokedTokens = new Set();
	expiryListFilePath;
	revocationListFilePath;
	expiryListCacheKey = 'tokenExpirationList';
	revocationListCacheKey = 'tokenRevocationList';
	cacheDuration;
	cleanupExpiredTokensInterval = null;
	cleanupRevokedTokensInterval = null;
	constructor(
		logger,
		errorLogger,
		errorHandler,
		gatekeeperService,
		cacheService,
		envConfig
	) {
		this.logger = logger;
		this.errorLogger = errorLogger;
		this.errorHandler = errorHandler;
		this.gatekeeperService = gatekeeperService;
		this.cacheService = cacheService;
		this.expiryListFilePath = envConfig.getEnvVariable(
			'tokenExpiryListPath'
		);
		this.revocationListFilePath = envConfig.getEnvVariable(
			'tokenRevokedListPath'
		);
		this.cacheDuration =
			envConfig.getEnvVariable('tokenCacheDuration') || 3600;
		this.loadExpiredTokens();
		this.loadRevokedTokens();
		this.cleanupExpiredTokensInterval = setInterval(
			() => this.cleanupExpiredTokens(),
			60 * 1000
		);
		this.cleanupRevokedTokensInterval = setInterval(
			() => this.cleanupRevokedTokens(),
			60 * 1000
		);
	}
	static async getInstance() {
		if (!JWTAuthMiddlewareService.instance) {
			const logger = await LoggerServiceFactory.getLoggerService();
			const errorLogger =
				await LoggerServiceFactory.getErrorLoggerService();
			const errorHandler =
				await ErrorHandlerServiceFactory.getErrorHandlerService();
			const gatekeeperService =
				await GatekeeperServiceFactory.getGatekeeperService();
			const cacheService =
				await CacheLayerServiceFactory.getCacheService();
			const envConfig =
				await EnvConfigServiceFactory.getEnvConfigService();
			JWTAuthMiddlewareService.instance = new JWTAuthMiddlewareService(
				logger,
				errorLogger,
				errorHandler,
				gatekeeperService,
				cacheService,
				envConfig
			);
		}
		return JWTAuthMiddlewareService.instance;
	}
	initializeJWTAuthMiddleware() {
		return async (req, res, next) => {
			try {
				const ip = req.ip;
				if (!ip) {
					this.logger.warn('No IP address found in request');
					return res.status(403).json({ error: 'Access denied' });
				}
				if (await this.gatekeeperService.isTemporarilyBlacklisted(ip)) {
					this.logger.warn(`IP ${ip} is temporarily blacklisted.`);
					return res
						.status(403)
						.json({ error: 'Access temporarily denied' });
				}
				if (await this.gatekeeperService.isBlacklisted(ip)) {
					this.logger.warn(`IP ${ip} is blacklisted.`);
					return res.status(403).json({ error: 'Access denied' });
				}
				const authHeader = req.headers.authorization;
				const token = authHeader?.split(' ')[1];
				if (!token) {
					this.errorLogger.logWarn(
						'No JWT token found in the authorization header'
					);
					return res.sendStatus(403);
				}
				if (await this.isTokenRevoked(token)) {
					this.logger.warn(`JWT token is revoked: ${token}`);
					return res.status(403).json({ error: 'Token revoked' });
				}
				if (await this.isTokenExpired(token)) {
					this.logger.warn(`JWT token has expired: ${token}`);
					return res.status(403).json({ error: 'Token expired' });
				}
				const jwtService = await AuthServiceFactory.getJWTService();
				const user = await jwtService.verifyJWT(token);
				if (!user) {
					this.logger.warn('Invalid JWT token');
					return res.status(403).json({ error: 'Invalid token' });
				}
				req.user = user;
				next();
			} catch (expressError) {
				const expressMiddlewareError =
					new this.errorHandler.ErrorClasses.ExpressError(
						`Error in JWTAuthMiddleware: ${expressError instanceof Error ? expressError.message : String(expressError)}`,
						{
							middleware: 'JWTAuthMiddleware',
							originalError: expressError
						}
					);
				this.errorLogger.logError(expressMiddlewareError.message);
				if (expressError instanceof Error) {
					this.errorHandler.expressErrorHandler()(
						expressError,
						req,
						res,
						next
					);
				} else {
					this.errorHandler.handleError({
						...HandleErrorStaticParameters,
						error: expressMiddlewareError
					});
				}
				res.sendStatus(500);
			}
		};
	}
	async isTokenExpired(token) {
		let isExpired = await this.cacheService.get(
			`expiredToken:${token}`,
			'bouncerService'
		);
		if (isExpired === null) {
			isExpired = false;
			await this.cacheService.set(
				`expiredToken:${token}`,
				isExpired,
				'bouncerService',
				this.cacheDuration
			);
		}
		return isExpired;
	}
	async isTokenRevoked(token) {
		const revokedTokens = await this.getCachedTokenList(
			this.revocationListCacheKey,
			this.loadRevokedTokens.bind(this)
		);
		return revokedTokens.has(token);
	}
	async expireToken(token, ttl) {
		const remainingTime = ttl - Math.floor(Date.now() / 1000);
		await this.cacheService.set(
			`expiredToken:${token}`,
			true,
			'bouncerService',
			Math.min(this.cacheDuration, remainingTime)
		);
		this.expiredTokens.add(token);
		await this.saveExpiredTokens();
	}
	async revokeToken(token) {
		const revokedTokens = await this.loadRevokedTokens();
		revokedTokens.add(token);
		await this.saveRevokedTokens(revokedTokens);
		await this.cacheService.del(
			this.revocationListCacheKey,
			'bouncerService'
		);
	}
	async getCachedTokenList(cacheKey, fileLoader) {
		let tokenList = await this.cacheService.get(cacheKey, 'bouncerService');
		if (!tokenList) {
			const tokenSet = await fileLoader();
			tokenList = Array.from(tokenSet);
			await this.cacheService.set(
				cacheKey,
				tokenList,
				'bouncerService',
				this.cacheDuration
			);
		}
		return new Set(tokenList);
	}
	async loadRevokedTokens() {
		const revokedTokens = new Set();
		try {
			if (await fs.promises.stat(this.revocationListFilePath)) {
				const fileData = await fs.promises.readFile(
					this.revocationListFilePath,
					'utf8'
				);
				const tokenList = JSON.parse(fileData);
				tokenList.forEach(token => revokedTokens.add(token));
				this.logger.info('Token revocation list loaded successfully.');
			}
		} catch (error) {
			this.logger.error(`Error loading token revocation list: ${error}`);
		}
		return revokedTokens;
	}
	async loadExpiredTokens() {
		const expiredTokens = new Set();
		try {
			if (await fs.promises.stat(this.expiryListFilePath)) {
				const fileData = await fs.promises.readFile(
					this.expiryListFilePath,
					'utf8'
				);
				const tokenList = JSON.parse(fileData);
				tokenList.forEach(token => expiredTokens.add(token));
				this.logger.info('Expired token list loaded successfully.');
			}
		} catch (error) {
			this.logger.error(`Error loading expired token list: ${error}`);
		}
		return expiredTokens;
	}
	async saveExpiredTokens() {
		await this.withFileLock(this.expiryListFilePath, async () => {
			const tokenList = Array.from(this.expiredTokens);
			await fs.promises.writeFile(
				this.expiryListFilePath,
				JSON.stringify(tokenList)
			);
			this.logger.info('Expired token list saved successfully.');
			await this.cacheService.del(
				this.expiryListCacheKey,
				'bouncerService'
			);
		});
	}
	async saveRevokedTokens(tokens) {
		await this.withFileLock(this.revocationListFilePath, async () => {
			const tokenList = Array.from(tokens);
			await fs.promises.writeFile(
				this.revocationListFilePath,
				JSON.stringify(tokenList)
			);
			this.logger.info('Revoked token list saved successfully.');
		});
		await this.cacheService.del(
			this.revocationListCacheKey,
			'bouncerService'
		);
	}
	async cleanupExpiredTokens() {
		const now = Date.now();
		this.expiredTokens.forEach(token => {
			const tokenData = jwt.decode(token);
			if (
				tokenData &&
				typeof tokenData !== 'string' &&
				tokenData.exp &&
				tokenData.exp * 1000 < now
			) {
				this.expiredTokens.delete(token);
				this.logger.info(`Removed expired token: ${token}`);
			}
		});
		await this.saveExpiredTokens();
	}
	async cleanupRevokedTokens() {
		const envConfig = await EnvConfigServiceFactory.getEnvConfigService();
		const revocationRetentionPeriod =
			envConfig.getEnvVariable('revokedTokenRetentionPeriod') ||
			30 * 24 * 60 * 60 * 1000; // 30 days in milliseconds
		const now = Date.now();
		let revokedTokenRemoved = false;
		this.revokedTokens.forEach(token => {
			const tokenData = jwt.decode(token);
			if (
				tokenData &&
				typeof tokenData !== 'string' &&
				tokenData.iat &&
				tokenData.iat * 1000 < now - revocationRetentionPeriod
			) {
				this.revokedTokens.delete(token);
				revokedTokenRemoved = true;
				this.logger.info(`Removed revoked token: ${token}`);
			}
		});
		if (revokedTokenRemoved) {
			await this.saveRevokedTokens(this.revokedTokens);
			this.logger.info('Revoked tokens cleanup completed and saved.');
		} else {
			this.logger.info('No revoked tokens required cleanup.');
		}
	}
	async withFileLock(filePath, operation) {
		let release = () => {};
		try {
			release = await lockfile.lock(filePath);
			await operation();
		} catch (error) {
			this.logger.error(
				`Error during file operation with lock: ${error}`
			);
		} finally {
			if (release) {
				release();
			}
		}
	}
	async shutdown() {
		try {
			if (this.cleanupExpiredTokensInterval) {
				clearInterval(this.cleanupExpiredTokensInterval);
			}
			if (this.cleanupRevokedTokensInterval) {
				clearInterval(this.cleanupRevokedTokensInterval);
			}
			await this.cacheService.del(
				this.expiryListCacheKey,
				'gatekeeperService'
			);
			await this.cacheService.del(
				this.revocationListCacheKey,
				'gatekeeperService'
			);
			JWTAuthMiddlewareService.instance = null;
			this.logger.info('JWTAuthMiddlewareService shutdown successfully.');
		} catch (error) {
			this.errorLogger.logError(
				`Error shutting down JWTAuthMiddlewareService: ${error instanceof Error ? error.message : error}`
			);
		}
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSldUQXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlL0pXVEF1dGgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3BCLE9BQU8sR0FBRyxNQUFNLGNBQWMsQ0FBQztBQUMvQixPQUFPLFFBQVEsTUFBTSxpQkFBaUIsQ0FBQztBQVV2QyxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN2RSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxvREFBb0QsQ0FBQztBQUMxRixPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSwwREFBMEQsQ0FBQztBQUN0RyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSx3REFBd0QsQ0FBQztBQUNsRyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSx3REFBd0QsQ0FBQztBQUNsRyxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSx1REFBdUQsQ0FBQztBQUNoRyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxrREFBa0QsQ0FBQztBQUV0RixNQUFNLE9BQU8sd0JBQXdCO0lBRzVCLE1BQU0sQ0FBQyxRQUFRLEdBQW9DLElBQUksQ0FBQztJQUV4RCxNQUFNLENBQTRCO0lBQ2xDLFdBQVcsQ0FBOEI7SUFDekMsWUFBWSxDQUErQjtJQUMzQyxpQkFBaUIsQ0FBNkI7SUFDOUMsWUFBWSxDQUF3QjtJQUVwQyxhQUFhLEdBQWdCLElBQUksR0FBRyxFQUFFLENBQUM7SUFDdkMsYUFBYSxHQUFnQixJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ3ZDLGtCQUFrQixDQUFTO0lBQzNCLHNCQUFzQixDQUFTO0lBQy9CLGtCQUFrQixHQUFHLHFCQUFxQixDQUFDO0lBQzNDLHNCQUFzQixHQUFHLHFCQUFxQixDQUFDO0lBQy9DLGFBQWEsQ0FBUztJQUN0Qiw0QkFBNEIsR0FBMEIsSUFBSSxDQUFDO0lBQzNELDRCQUE0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SyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQ2pHLENBQUM7UUFDSCxDQUFDO0lBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5leHRGdW5jdGlvbiwgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgand0IGZyb20gJ2pzb253ZWJ0b2tlbic7XG5pbXBvcnQgbG9ja2ZpbGUgZnJvbSAncHJvcGVyLWxvY2tmaWxlJztcbmltcG9ydCB7XG5cdEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdENhY2hlU2VydmljZUludGVyZmFjZSxcblx0RW52Q29uZmlnU2VydmljZUludGVyZmFjZSxcblx0RXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZSxcblx0RXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRHYXRla2VlcGVyU2VydmljZUludGVyZmFjZSxcblx0SldUQXV0aE1pZGRsZXdhcmVTZXJ2aWNlSW50ZXJmYWNlXG59IGZyb20gJy4uL2luZGV4L2ludGVyZmFjZXMvbWFpbic7XG5pbXBvcnQgeyBIYW5kbGVFcnJvclN0YXRpY1BhcmFtZXRlcnMgfSBmcm9tICcuLi9pbmRleC9pbnRlcmZhY2VzL21haW4nO1xuaW1wb3J0IHsgTG9nZ2VyU2VydmljZUZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5L3N1YmZhY3Rvcmllcy9Mb2dnZXJTZXJ2aWNlRmFjdG9yeSc7XG5pbXBvcnQgeyBFcnJvckhhbmRsZXJTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4uL2luZGV4L2ZhY3Rvcnkvc3ViZmFjdG9yaWVzL0Vycm9ySGFuZGxlclNlcnZpY2VGYWN0b3J5JztcbmltcG9ydCB7IEdhdGVrZWVwZXJTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4uL2luZGV4L2ZhY3Rvcnkvc3ViZmFjdG9yaWVzL0dhdGVrZWVwZXJTZXJ2aWNlRmFjdG9yeSc7XG5pbXBvcnQgeyBDYWNoZUxheWVyU2VydmljZUZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5L3N1YmZhY3Rvcmllcy9DYWNoZUxheWVyU2VydmljZUZhY3RvcnknO1xuaW1wb3J0IHsgRW52Q29uZmlnU2VydmljZUZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5L3N1YmZhY3Rvcmllcy9FbnZDb25maWdTZXJ2aWNlRmFjdG9yeSc7XG5pbXBvcnQgeyBBdXRoU2VydmljZUZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5L3N1YmZhY3Rvcmllcy9BdXRoU2VydmljZUZhY3RvcnknO1xuXG5leHBvcnQgY2xhc3MgSldUQXV0aE1pZGRsZXdhcmVTZXJ2aWNlXG5cdGltcGxlbWVudHMgSldUQXV0aE1pZGRsZXdhcmVTZXJ2aWNlSW50ZXJmYWNlXG57XG5cdHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBKV1RBdXRoTWlkZGxld2FyZVNlcnZpY2UgfCBudWxsID0gbnVsbDtcblxuXHRwcml2YXRlIGxvZ2dlcjogQXBwTG9nZ2VyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBlcnJvckxvZ2dlcjogRXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIGVycm9ySGFuZGxlcjogRXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBnYXRla2VlcGVyU2VydmljZTogR2F0ZWtlZXBlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgY2FjaGVTZXJ2aWNlOiBDYWNoZVNlcnZpY2VJbnRlcmZhY2U7XG5cblx0cHJpdmF0ZSBleHBpcmVkVG9rZW5zOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTtcblx0cHJpdmF0ZSByZXZva2VkVG9rZW5zOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTtcblx0cHJpdmF0ZSBleHBpcnlMaXN0RmlsZVBhdGg6IHN0cmluZztcblx0cHJpdmF0ZSByZXZvY2F0aW9uTGlzdEZpbGVQYXRoOiBzdHJpbmc7XG5cdHByaXZhdGUgZXhwaXJ5TGlzdENhY2hlS2V5ID0gJ3Rva2VuRXhwaXJhdGlvbkxpc3QnO1xuXHRwcml2YXRlIHJldm9jYXRpb25MaXN0Q2FjaGVLZXkgPSAndG9rZW5SZXZvY2F0aW9uTGlzdCc7XG5cdHByaXZhdGUgY2FjaGVEdXJhdGlvbjogbnVtYmVyO1xuXHRwcml2YXRlIGNsZWFudXBFeHBpcmVkVG9rZW5zSW50ZXJ2YWw6IE5vZGVKUy5UaW1lb3V0IHwgbnVsbCA9IG51bGw7XG5cdHByaXZhdGUgY2xlYW51cFJldm9rZWRUb2tlbnNJbnRlcnZhbDogTm9kZUpTLlRpbWVvdXQgfCBudWxsID0gbnVsbDtcblxuXHRwcml2YXRlIGNvbnN0cnVjdG9yKFxuXHRcdGxvZ2dlcjogQXBwTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0XHRlcnJvckxvZ2dlcjogRXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGVycm9ySGFuZGxlcjogRXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZSxcblx0XHRnYXRla2VlcGVyU2VydmljZTogR2F0ZWtlZXBlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0Y2FjaGVTZXJ2aWNlOiBDYWNoZVNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0ZW52Q29uZmlnOiBFbnZDb25maWdTZXJ2aWNlSW50ZXJmYWNlXG5cdCkge1xuXHRcdHRoaXMubG9nZ2VyID0gbG9nZ2VyO1xuXHRcdHRoaXMuZXJyb3JMb2dnZXIgPSBlcnJvckxvZ2dlcjtcblx0XHR0aGlzLmVycm9ySGFuZGxlciA9IGVycm9ySGFuZGxlcjtcblx0XHR0aGlzLmdhdGVrZWVwZXJTZXJ2aWNlID0gZ2F0ZWtlZXBlclNlcnZpY2U7XG5cdFx0dGhpcy5jYWNoZVNlcnZpY2UgPSBjYWNoZVNlcnZpY2U7XG5cblx0XHR0aGlzLmV4cGlyeUxpc3RGaWxlUGF0aCA9IGVudkNvbmZpZy5nZXRFbnZWYXJpYWJsZShcblx0XHRcdCd0b2tlbkV4cGlyeUxpc3RQYXRoJ1xuXHRcdCk7XG5cdFx0dGhpcy5yZXZvY2F0aW9uTGlzdEZpbGVQYXRoID0gZW52Q29uZmlnLmdldEVudlZhcmlhYmxlKFxuXHRcdFx0J3Rva2VuUmV2b2tlZExpc3RQYXRoJ1xuXHRcdCk7XG5cdFx0dGhpcy5jYWNoZUR1cmF0aW9uID1cblx0XHRcdGVudkNvbmZpZy5nZXRFbnZWYXJpYWJsZSgndG9rZW5DYWNoZUR1cmF0aW9uJykgfHwgMzYwMDtcblxuXHRcdHRoaXMubG9hZEV4cGlyZWRUb2tlbnMoKTtcblx0XHR0aGlzLmxvYWRSZXZva2VkVG9rZW5zKCk7XG5cdFx0dGhpcy5jbGVhbnVwRXhwaXJlZFRva2Vuc0ludGVydmFsID0gc2V0SW50ZXJ2YWwoXG5cdFx0XHQoKSA9PiB0aGlzLmNsZWFudXBFeHBpcmVkVG9rZW5zKCksXG5cdFx0XHQ2MCAqIDEwMDBcblx0XHQpO1xuXHRcdHRoaXMuY2xlYW51cFJldm9rZWRUb2tlbnNJbnRlcnZhbCA9IHNldEludGVydmFsKFxuXHRcdFx0KCkgPT4gdGhpcy5jbGVhbnVwUmV2b2tlZFRva2VucygpLFxuXHRcdFx0NjAgKiAxMDAwXG5cdFx0KTtcblx0fVxuXG5cdHB1YmxpYyBzdGF0aWMgYXN5bmMgZ2V0SW5zdGFuY2UoKTogUHJvbWlzZTxKV1RBdXRoTWlkZGxld2FyZVNlcnZpY2U+IHtcblx0XHRpZiAoIUpXVEF1dGhNaWRkbGV3YXJlU2VydmljZS5pbnN0YW5jZSkge1xuXHRcdFx0Y29uc3QgbG9nZ2VyID0gYXdhaXQgTG9nZ2VyU2VydmljZUZhY3RvcnkuZ2V0TG9nZ2VyU2VydmljZSgpO1xuXHRcdFx0Y29uc3QgZXJyb3JMb2dnZXIgPVxuXHRcdFx0XHRhd2FpdCBMb2dnZXJTZXJ2aWNlRmFjdG9yeS5nZXRFcnJvckxvZ2dlclNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGVycm9ySGFuZGxlciA9XG5cdFx0XHRcdGF3YWl0IEVycm9ySGFuZGxlclNlcnZpY2VGYWN0b3J5LmdldEVycm9ySGFuZGxlclNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGdhdGVrZWVwZXJTZXJ2aWNlID1cblx0XHRcdFx0YXdhaXQgR2F0ZWtlZXBlclNlcnZpY2VGYWN0b3J5LmdldEdhdGVrZWVwZXJTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBjYWNoZVNlcnZpY2UgPVxuXHRcdFx0XHRhd2FpdCBDYWNoZUxheWVyU2VydmljZUZhY3RvcnkuZ2V0Q2FjaGVTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBlbnZDb25maWcgPVxuXHRcdFx0XHRhd2FpdCBFbnZDb25maWdTZXJ2aWNlRmFjdG9yeS5nZXRFbnZDb25maWdTZXJ2aWNlKCk7XG5cblx0XHRcdEpXVEF1dGhNaWRkbGV3YXJlU2VydmljZS5pbnN0YW5jZSA9IG5ldyBKV1RBdXRoTWlkZGxld2FyZVNlcnZpY2UoXG5cdFx0XHRcdGxvZ2dlcixcblx0XHRcdFx0ZXJyb3JMb2dnZXIsXG5cdFx0XHRcdGVycm9ySGFuZGxlcixcblx0XHRcdFx0Z2F0ZWtlZXBlclNlcnZpY2UsXG5cdFx0XHRcdGNhY2hlU2VydmljZSxcblx0XHRcdFx0ZW52Q29uZmlnXG5cdFx0XHQpO1xuXHRcdH1cblxuXHRcdHJldHVybiBKV1RBdXRoTWlkZGxld2FyZVNlcnZpY2UuaW5zdGFuY2U7XG5cdH1cblxuXHRwdWJsaWMgaW5pdGlhbGl6ZUpXVEF1dGhNaWRkbGV3YXJlKCk6IChcblx0XHRyZXE6IFJlcXVlc3QsXG5cdFx0cmVzOiBSZXNwb25zZSxcblx0XHRuZXh0OiBOZXh0RnVuY3Rpb25cblx0KSA9PiBQcm9taXNlPHZvaWQgfCBSZXNwb25zZT4ge1xuXHRcdHJldHVybiBhc3luYyAoXG5cdFx0XHRyZXE6IFJlcXVlc3QsXG5cdFx0XHRyZXM6IFJlc3BvbnNlLFxuXHRcdFx0bmV4dDogTmV4dEZ1bmN0aW9uXG5cdFx0KTogUHJvbWlzZTx2b2lkIHwgUmVzcG9uc2U+ID0+IHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdGNvbnN0IGlwID0gcmVxLmlwO1xuXG5cdFx0XHRcdGlmICghaXApIHtcblx0XHRcdFx0XHR0aGlzLmxvZ2dlci53YXJuKCdObyBJUCBhZGRyZXNzIGZvdW5kIGluIHJlcXVlc3QnKTtcblx0XHRcdFx0XHRyZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ0FjY2VzcyBkZW5pZWQnIH0pO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0aWYgKGF3YWl0IHRoaXMuZ2F0ZWtlZXBlclNlcnZpY2UuaXNUZW1wb3JhcmlseUJsYWNrbGlzdGVkKGlwKSkge1xuXHRcdFx0XHRcdHRoaXMubG9nZ2VyLndhcm4oYElQICR7aXB9IGlzIHRlbXBvcmFyaWx5IGJsYWNrbGlzdGVkLmApO1xuXHRcdFx0XHRcdHJldHVybiByZXNcblx0XHRcdFx0XHRcdC5zdGF0dXMoNDAzKVxuXHRcdFx0XHRcdFx0Lmpzb24oeyBlcnJvcjogJ0FjY2VzcyB0ZW1wb3JhcmlseSBkZW5pZWQnIH0pO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0aWYgKGF3YWl0IHRoaXMuZ2F0ZWtlZXBlclNlcnZpY2UuaXNCbGFja2xpc3RlZChpcCkpIHtcblx0XHRcdFx0XHR0aGlzLmxvZ2dlci53YXJuKGBJUCAke2lwfSBpcyBibGFja2xpc3RlZC5gKTtcblx0XHRcdFx0XHRyZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ0FjY2VzcyBkZW5pZWQnIH0pO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0Y29uc3QgYXV0aEhlYWRlciA9IHJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb247XG5cdFx0XHRcdGNvbnN0IHRva2VuID0gYXV0aEhlYWRlcj8uc3BsaXQoJyAnKVsxXTtcblxuXHRcdFx0XHRpZiAoIXRva2VuKSB7XG5cdFx0XHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dXYXJuKFxuXHRcdFx0XHRcdFx0J05vIEpXVCB0b2tlbiBmb3VuZCBpbiB0aGUgYXV0aG9yaXphdGlvbiBoZWFkZXInXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRyZXR1cm4gcmVzLnNlbmRTdGF0dXMoNDAzKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGlmIChhd2FpdCB0aGlzLmlzVG9rZW5SZXZva2VkKHRva2VuKSkge1xuXHRcdFx0XHRcdHRoaXMubG9nZ2VyLndhcm4oYEpXVCB0b2tlbiBpcyByZXZva2VkOiAke3Rva2VufWApO1xuXHRcdFx0XHRcdHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnVG9rZW4gcmV2b2tlZCcgfSk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRpZiAoYXdhaXQgdGhpcy5pc1Rva2VuRXhwaXJlZCh0b2tlbikpIHtcblx0XHRcdFx0XHR0aGlzLmxvZ2dlci53YXJuKGBKV1QgdG9rZW4gaGFzIGV4cGlyZWQ6ICR7dG9rZW59YCk7XG5cdFx0XHRcdFx0cmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICdUb2tlbiBleHBpcmVkJyB9KTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGNvbnN0IGp3dFNlcnZpY2UgPSBhd2FpdCBBdXRoU2VydmljZUZhY3RvcnkuZ2V0SldUU2VydmljZSgpO1xuXHRcdFx0XHRjb25zdCB1c2VyID0gYXdhaXQgand0U2VydmljZS52ZXJpZnlKV1QodG9rZW4pO1xuXG5cdFx0XHRcdGlmICghdXNlcikge1xuXHRcdFx0XHRcdHRoaXMubG9nZ2VyLndhcm4oJ0ludmFsaWQgSldUIHRva2VuJyk7XG5cdFx0XHRcdFx0cmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICdJbnZhbGlkIHRva2VuJyB9KTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdHJlcS51c2VyID0gdXNlcjtcblx0XHRcdFx0bmV4dCgpO1xuXHRcdFx0fSBjYXRjaCAoZXhwcmVzc0Vycm9yKSB7XG5cdFx0XHRcdGNvbnN0IGV4cHJlc3NNaWRkbGV3YXJlRXJyb3IgPVxuXHRcdFx0XHRcdG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuRXhwcmVzc0Vycm9yKFxuXHRcdFx0XHRcdFx0YEVycm9yIGluIEpXVEF1dGhNaWRkbGV3YXJlOiAke2V4cHJlc3NFcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXhwcmVzc0Vycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXhwcmVzc0Vycm9yKX1gLFxuXHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRtaWRkbGV3YXJlOiAnSldUQXV0aE1pZGRsZXdhcmUnLFxuXHRcdFx0XHRcdFx0XHRvcmlnaW5hbEVycm9yOiBleHByZXNzRXJyb3Jcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKGV4cHJlc3NNaWRkbGV3YXJlRXJyb3IubWVzc2FnZSk7XG5cblx0XHRcdFx0aWYgKGV4cHJlc3NFcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XG5cdFx0XHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuZXhwcmVzc0Vycm9ySGFuZGxlcigpKFxuXHRcdFx0XHRcdFx0ZXhwcmVzc0Vycm9yLFxuXHRcdFx0XHRcdFx0cmVxLFxuXHRcdFx0XHRcdFx0cmVzLFxuXHRcdFx0XHRcdFx0bmV4dFxuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3Ioe1xuXHRcdFx0XHRcdFx0Li4uSGFuZGxlRXJyb3JTdGF0aWNQYXJhbWV0ZXJzLFxuXHRcdFx0XHRcdFx0ZXJyb3I6IGV4cHJlc3NNaWRkbGV3YXJlRXJyb3Jcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fVxuXHRcdFx0XHRyZXMuc2VuZFN0YXR1cyg1MDApO1xuXHRcdFx0fVxuXHRcdH07XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIGlzVG9rZW5FeHBpcmVkKHRva2VuOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcblx0XHRsZXQgaXNFeHBpcmVkID0gYXdhaXQgdGhpcy5jYWNoZVNlcnZpY2UuZ2V0PGJvb2xlYW4+KFxuXHRcdFx0YGV4cGlyZWRUb2tlbjoke3Rva2VufWAsXG5cdFx0XHQnYm91bmNlclNlcnZpY2UnXG5cdFx0KTtcblxuXHRcdGlmIChpc0V4cGlyZWQgPT09IG51bGwpIHtcblx0XHRcdGlzRXhwaXJlZCA9IGZhbHNlO1xuXG5cdFx0XHRhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5zZXQoXG5cdFx0XHRcdGBleHBpcmVkVG9rZW46JHt0b2tlbn1gLFxuXHRcdFx0XHRpc0V4cGlyZWQsXG5cdFx0XHRcdCdib3VuY2VyU2VydmljZScsXG5cdFx0XHRcdHRoaXMuY2FjaGVEdXJhdGlvblxuXHRcdFx0KTtcblx0XHR9XG5cdFx0cmV0dXJuIGlzRXhwaXJlZDtcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgaXNUb2tlblJldm9rZWQodG9rZW46IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuXHRcdGNvbnN0IHJldm9rZWRUb2tlbnMgPSBhd2FpdCB0aGlzLmdldENhY2hlZFRva2VuTGlzdChcblx0XHRcdHRoaXMucmV2b2NhdGlvbkxpc3RDYWNoZUtleSxcblx0XHRcdHRoaXMubG9hZFJldm9rZWRUb2tlbnMuYmluZCh0aGlzKVxuXHRcdCk7XG5cblx0XHRyZXR1cm4gcmV2b2tlZFRva2Vucy5oYXModG9rZW4pO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGV4cGlyZVRva2VuKHRva2VuOiBzdHJpbmcsIHR0bDogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgcmVtYWluaW5nVGltZSA9IHR0bCAtIE1hdGguZmxvb3IoRGF0ZS5ub3coKSAvIDEwMDApO1xuXG5cdFx0YXdhaXQgdGhpcy5jYWNoZVNlcnZpY2Uuc2V0KFxuXHRcdFx0YGV4cGlyZWRUb2tlbjoke3Rva2VufWAsXG5cdFx0XHR0cnVlLFxuXHRcdFx0J2JvdW5jZXJTZXJ2aWNlJyxcblx0XHRcdE1hdGgubWluKHRoaXMuY2FjaGVEdXJhdGlvbiwgcmVtYWluaW5nVGltZSlcblx0XHQpO1xuXG5cdFx0dGhpcy5leHBpcmVkVG9rZW5zLmFkZCh0b2tlbik7XG5cdFx0YXdhaXQgdGhpcy5zYXZlRXhwaXJlZFRva2VucygpO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIHJldm9rZVRva2VuKHRva2VuOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRjb25zdCByZXZva2VkVG9rZW5zID0gYXdhaXQgdGhpcy5sb2FkUmV2b2tlZFRva2VucygpO1xuXG5cdFx0cmV2b2tlZFRva2Vucy5hZGQodG9rZW4pO1xuXG5cdFx0YXdhaXQgdGhpcy5zYXZlUmV2b2tlZFRva2VucyhyZXZva2VkVG9rZW5zKTtcblx0XHRhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5kZWwoXG5cdFx0XHR0aGlzLnJldm9jYXRpb25MaXN0Q2FjaGVLZXksXG5cdFx0XHQnYm91bmNlclNlcnZpY2UnXG5cdFx0KTtcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgZ2V0Q2FjaGVkVG9rZW5MaXN0KFxuXHRcdGNhY2hlS2V5OiBzdHJpbmcsXG5cdFx0ZmlsZUxvYWRlcjogKCkgPT4gUHJvbWlzZTxTZXQ8c3RyaW5nPj5cblx0KTogUHJvbWlzZTxTZXQ8c3RyaW5nPj4ge1xuXHRcdGxldCB0b2tlbkxpc3QgPSBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5nZXQ8c3RyaW5nW10+KFxuXHRcdFx0Y2FjaGVLZXksXG5cdFx0XHQnYm91bmNlclNlcnZpY2UnXG5cdFx0KTtcblxuXHRcdGlmICghdG9rZW5MaXN0KSB7XG5cdFx0XHRjb25zdCB0b2tlblNldCA9IGF3YWl0IGZpbGVMb2FkZXIoKTtcblx0XHRcdHRva2VuTGlzdCA9IEFycmF5LmZyb20odG9rZW5TZXQpO1xuXG5cdFx0XHRhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5zZXQoXG5cdFx0XHRcdGNhY2hlS2V5LFxuXHRcdFx0XHR0b2tlbkxpc3QsXG5cdFx0XHRcdCdib3VuY2VyU2VydmljZScsXG5cdFx0XHRcdHRoaXMuY2FjaGVEdXJhdGlvblxuXHRcdFx0KTtcblx0XHR9XG5cblx0XHRyZXR1cm4gbmV3IFNldCh0b2tlbkxpc3QpO1xuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBsb2FkUmV2b2tlZFRva2VucygpOiBQcm9taXNlPFNldDxzdHJpbmc+PiB7XG5cdFx0Y29uc3QgcmV2b2tlZFRva2VucyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuXHRcdHRyeSB7XG5cdFx0XHRpZiAoYXdhaXQgZnMucHJvbWlzZXMuc3RhdCh0aGlzLnJldm9jYXRpb25MaXN0RmlsZVBhdGgpKSB7XG5cdFx0XHRcdGNvbnN0IGZpbGVEYXRhID0gYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUoXG5cdFx0XHRcdFx0dGhpcy5yZXZvY2F0aW9uTGlzdEZpbGVQYXRoLFxuXHRcdFx0XHRcdCd1dGY4J1xuXHRcdFx0XHQpO1xuXHRcdFx0XHRjb25zdCB0b2tlbkxpc3Q6IHN0cmluZ1tdID0gSlNPTi5wYXJzZShmaWxlRGF0YSk7XG5cdFx0XHRcdHRva2VuTGlzdC5mb3JFYWNoKHRva2VuID0+IHJldm9rZWRUb2tlbnMuYWRkKHRva2VuKSk7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ1Rva2VuIHJldm9jYXRpb24gbGlzdCBsb2FkZWQgc3VjY2Vzc2Z1bGx5LicpO1xuXHRcdFx0fVxuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5lcnJvcihgRXJyb3IgbG9hZGluZyB0b2tlbiByZXZvY2F0aW9uIGxpc3Q6ICR7ZXJyb3J9YCk7XG5cdFx0fVxuXHRcdHJldHVybiByZXZva2VkVG9rZW5zO1xuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBsb2FkRXhwaXJlZFRva2VucygpOiBQcm9taXNlPFNldDxzdHJpbmc+PiB7XG5cdFx0Y29uc3QgZXhwaXJlZFRva2VucyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuXHRcdHRyeSB7XG5cdFx0XHRpZiAoYXdhaXQgZnMucHJvbWlzZXMuc3RhdCh0aGlzLmV4cGlyeUxpc3RGaWxlUGF0aCkpIHtcblx0XHRcdFx0Y29uc3QgZmlsZURhdGEgPSBhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZShcblx0XHRcdFx0XHR0aGlzLmV4cGlyeUxpc3RGaWxlUGF0aCxcblx0XHRcdFx0XHQndXRmOCdcblx0XHRcdFx0KTtcblx0XHRcdFx0Y29uc3QgdG9rZW5MaXN0OiBzdHJpbmdbXSA9IEpTT04ucGFyc2UoZmlsZURhdGEpO1xuXHRcdFx0XHR0b2tlbkxpc3QuZm9yRWFjaCh0b2tlbiA9PiBleHBpcmVkVG9rZW5zLmFkZCh0b2tlbikpO1xuXHRcdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdFeHBpcmVkIHRva2VuIGxpc3QgbG9hZGVkIHN1Y2Nlc3NmdWxseS4nKTtcblx0XHRcdH1cblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5sb2dnZXIuZXJyb3IoYEVycm9yIGxvYWRpbmcgZXhwaXJlZCB0b2tlbiBsaXN0OiAke2Vycm9yfWApO1xuXHRcdH1cblx0XHRyZXR1cm4gZXhwaXJlZFRva2Vucztcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgc2F2ZUV4cGlyZWRUb2tlbnMoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0YXdhaXQgdGhpcy53aXRoRmlsZUxvY2sodGhpcy5leHBpcnlMaXN0RmlsZVBhdGgsIGFzeW5jICgpID0+IHtcblx0XHRcdGNvbnN0IHRva2VuTGlzdCA9IEFycmF5LmZyb20odGhpcy5leHBpcmVkVG9rZW5zKTtcblxuXHRcdFx0YXdhaXQgZnMucHJvbWlzZXMud3JpdGVGaWxlKFxuXHRcdFx0XHR0aGlzLmV4cGlyeUxpc3RGaWxlUGF0aCxcblx0XHRcdFx0SlNPTi5zdHJpbmdpZnkodG9rZW5MaXN0KVxuXHRcdFx0KTtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ0V4cGlyZWQgdG9rZW4gbGlzdCBzYXZlZCBzdWNjZXNzZnVsbHkuJyk7XG5cblx0XHRcdGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLmRlbChcblx0XHRcdFx0dGhpcy5leHBpcnlMaXN0Q2FjaGVLZXksXG5cdFx0XHRcdCdib3VuY2VyU2VydmljZSdcblx0XHRcdCk7XG5cdFx0fSk7XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIHNhdmVSZXZva2VkVG9rZW5zKHRva2VuczogU2V0PHN0cmluZz4pOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRhd2FpdCB0aGlzLndpdGhGaWxlTG9jayh0aGlzLnJldm9jYXRpb25MaXN0RmlsZVBhdGgsIGFzeW5jICgpID0+IHtcblx0XHRcdGNvbnN0IHRva2VuTGlzdCA9IEFycmF5LmZyb20odG9rZW5zKTtcblx0XHRcdGF3YWl0IGZzLnByb21pc2VzLndyaXRlRmlsZShcblx0XHRcdFx0dGhpcy5yZXZvY2F0aW9uTGlzdEZpbGVQYXRoLFxuXHRcdFx0XHRKU09OLnN0cmluZ2lmeSh0b2tlbkxpc3QpXG5cdFx0XHQpO1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnUmV2b2tlZCB0b2tlbiBsaXN0IHNhdmVkIHN1Y2Nlc3NmdWxseS4nKTtcblx0XHR9KTtcblxuXHRcdGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLmRlbChcblx0XHRcdHRoaXMucmV2b2NhdGlvbkxpc3RDYWNoZUtleSxcblx0XHRcdCdib3VuY2VyU2VydmljZSdcblx0XHQpO1xuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBjbGVhbnVwRXhwaXJlZFRva2VucygpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuXHRcdHRoaXMuZXhwaXJlZFRva2Vucy5mb3JFYWNoKHRva2VuID0+IHtcblx0XHRcdGNvbnN0IHRva2VuRGF0YSA9IGp3dC5kZWNvZGUodG9rZW4pO1xuXG5cdFx0XHRpZiAoXG5cdFx0XHRcdHRva2VuRGF0YSAmJlxuXHRcdFx0XHR0eXBlb2YgdG9rZW5EYXRhICE9PSAnc3RyaW5nJyAmJlxuXHRcdFx0XHR0b2tlbkRhdGEuZXhwICYmXG5cdFx0XHRcdHRva2VuRGF0YS5leHAgKiAxMDAwIDwgbm93XG5cdFx0XHQpIHtcblx0XHRcdFx0dGhpcy5leHBpcmVkVG9rZW5zLmRlbGV0ZSh0b2tlbik7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oYFJlbW92ZWQgZXhwaXJlZCB0b2tlbjogJHt0b2tlbn1gKTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdGF3YWl0IHRoaXMuc2F2ZUV4cGlyZWRUb2tlbnMoKTtcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgY2xlYW51cFJldm9rZWRUb2tlbnMoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgZW52Q29uZmlnID0gYXdhaXQgRW52Q29uZmlnU2VydmljZUZhY3RvcnkuZ2V0RW52Q29uZmlnU2VydmljZSgpO1xuXHRcdGNvbnN0IHJldm9jYXRpb25SZXRlbnRpb25QZXJpb2QgPVxuXHRcdFx0ZW52Q29uZmlnLmdldEVudlZhcmlhYmxlKCdyZXZva2VkVG9rZW5SZXRlbnRpb25QZXJpb2QnKSB8fFxuXHRcdFx0MzAgKiAyNCAqIDYwICogNjAgKiAxMDAwOyAvLyAzMCBkYXlzIGluIG1pbGxpc2Vjb25kc1xuXHRcdGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG5cdFx0bGV0IHJldm9rZWRUb2tlblJlbW92ZWQgPSBmYWxzZTtcblxuXHRcdHRoaXMucmV2b2tlZFRva2Vucy5mb3JFYWNoKHRva2VuID0+IHtcblx0XHRcdGNvbnN0IHRva2VuRGF0YSA9IGp3dC5kZWNvZGUodG9rZW4pO1xuXG5cdFx0XHRpZiAoXG5cdFx0XHRcdHRva2VuRGF0YSAmJlxuXHRcdFx0XHR0eXBlb2YgdG9rZW5EYXRhICE9PSAnc3RyaW5nJyAmJlxuXHRcdFx0XHR0b2tlbkRhdGEuaWF0ICYmXG5cdFx0XHRcdHRva2VuRGF0YS5pYXQgKiAxMDAwIDwgbm93IC0gcmV2b2NhdGlvblJldGVudGlvblBlcmlvZFxuXHRcdFx0KSB7XG5cdFx0XHRcdHRoaXMucmV2b2tlZFRva2Vucy5kZWxldGUodG9rZW4pO1xuXHRcdFx0XHRyZXZva2VkVG9rZW5SZW1vdmVkID0gdHJ1ZTtcblx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhgUmVtb3ZlZCByZXZva2VkIHRva2VuOiAke3Rva2VufWApO1xuXHRcdFx0fVxuXHRcdH0pO1xuXG5cdFx0aWYgKHJldm9rZWRUb2tlblJlbW92ZWQpIHtcblx0XHRcdGF3YWl0IHRoaXMuc2F2ZVJldm9rZWRUb2tlbnModGhpcy5yZXZva2VkVG9rZW5zKTtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ1Jldm9rZWQgdG9rZW5zIGNsZWFudXAgY29tcGxldGVkIGFuZCBzYXZlZC4nKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnTm8gcmV2b2tlZCB0b2tlbnMgcmVxdWlyZWQgY2xlYW51cC4nKTtcblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIHdpdGhGaWxlTG9jayhcblx0XHRmaWxlUGF0aDogc3RyaW5nLFxuXHRcdG9wZXJhdGlvbjogKCkgPT4gUHJvbWlzZTx2b2lkPlxuXHQpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRsZXQgcmVsZWFzZTogKCkgPT4gdm9pZCA9ICgpID0+IHt9O1xuXHRcdHRyeSB7XG5cdFx0XHRyZWxlYXNlID0gYXdhaXQgbG9ja2ZpbGUubG9jayhmaWxlUGF0aCk7XG5cdFx0XHRhd2FpdCBvcGVyYXRpb24oKTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5sb2dnZXIuZXJyb3IoXG5cdFx0XHRcdGBFcnJvciBkdXJpbmcgZmlsZSBvcGVyYXRpb24gd2l0aCBsb2NrOiAke2Vycm9yfWBcblx0XHRcdCk7XG5cdFx0fSBmaW5hbGx5IHtcblx0XHRcdGlmIChyZWxlYXNlKSB7XG5cdFx0XHRcdHJlbGVhc2UoKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgc2h1dGRvd24oKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGlmICh0aGlzLmNsZWFudXBFeHBpcmVkVG9rZW5zSW50ZXJ2YWwpIHtcblx0XHRcdFx0Y2xlYXJJbnRlcnZhbCh0aGlzLmNsZWFudXBFeHBpcmVkVG9rZW5zSW50ZXJ2YWwpO1xuXHRcdFx0fVxuXHRcdFx0aWYgKHRoaXMuY2xlYW51cFJldm9rZWRUb2tlbnNJbnRlcnZhbCkge1xuXHRcdFx0XHRjbGVhckludGVydmFsKHRoaXMuY2xlYW51cFJldm9rZWRUb2tlbnNJbnRlcnZhbCk7XG5cdFx0XHR9XG5cblx0XHRcdGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLmRlbChcblx0XHRcdFx0dGhpcy5leHBpcnlMaXN0Q2FjaGVLZXksXG5cdFx0XHRcdCdnYXRla2VlcGVyU2VydmljZSdcblx0XHRcdCk7XG5cdFx0XHRhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5kZWwoXG5cdFx0XHRcdHRoaXMucmV2b2NhdGlvbkxpc3RDYWNoZUtleSxcblx0XHRcdFx0J2dhdGVrZWVwZXJTZXJ2aWNlJ1xuXHRcdFx0KTtcblxuXHRcdFx0SldUQXV0aE1pZGRsZXdhcmVTZXJ2aWNlLmluc3RhbmNlID0gbnVsbDtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ0pXVEF1dGhNaWRkbGV3YXJlU2VydmljZSBzaHV0ZG93biBzdWNjZXNzZnVsbHkuJyk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nRXJyb3IoXG5cdFx0XHRcdGBFcnJvciBzaHV0dGluZyBkb3duIEpXVEF1dGhNaWRkbGV3YXJlU2VydmljZTogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yfWBcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG59XG4iXX0=
