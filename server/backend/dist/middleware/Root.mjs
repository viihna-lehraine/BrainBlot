import cookieParser from 'cookie-parser';
import cors from 'cors';
import express from 'express';
import morgan from 'morgan';
import rawBody from 'raw-body';
import responseTime from 'response-time';
import { XMLParser } from 'fast-xml-parser';
import { withRetry } from '../utils/helpers.mjs';
import {
	blankRequest,
	blankResponse,
	blankNextFunction
} from '../config/express.mjs';
import { LoggerServiceFactory } from '../index/factory/subfactories/LoggerServiceFactory.mjs';
import { ErrorHandlerServiceFactory } from '../index/factory/subfactories/ErrorHandlerServiceFactory.mjs';
import { MiddlewareStatusServiceFactory } from '../index/factory/subfactories/MiddlewareStatusServiceFactory.mjs';
export class RootMiddlewareService {
	static instance = null;
	logger;
	errorLogger;
	errorHandler;
	middlewareStatusService;
	totalResponseTime = 0;
	requestCount = 0;
	errorCount = 0;
	openConnections = 0;
	requestsPerSecond = 0;
	requestStatsInterval = null;
	constructor(logger, errorLogger, errorHandler, middlewareStatusService) {
		this.logger = logger;
		this.errorLogger = errorLogger;
		this.errorHandler = errorHandler;
		this.middlewareStatusService = middlewareStatusService;
	}
	static async getInstance() {
		if (!RootMiddlewareService.instance) {
			const logger = await LoggerServiceFactory.getLoggerService();
			const errorLogger =
				await LoggerServiceFactory.getErrorLoggerService();
			const errorHandler =
				await ErrorHandlerServiceFactory.getErrorHandlerService();
			const middlewareStatusService =
				await MiddlewareStatusServiceFactory.getMiddlewareStatusService();
			RootMiddlewareService.instance = new RootMiddlewareService(
				logger,
				errorLogger,
				errorHandler,
				middlewareStatusService
			);
		}
		return RootMiddlewareService.instance;
	}
	async initialize() {
		try {
			const app = express();
			await this.applyMiddlewares(app);
			this.calculateRequestsPerSecond();
		} catch (error) {
			const initializationError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Error during RootMiddlewareService initialization: ${error instanceof Error ? error.message : 'Unknown error'}`
				);
			this.errorLogger.logError(initializationError.message);
			this.errorHandler.handleError({ error: initializationError });
		}
	}
	trackResponseTime(req, res, next) {
		const startHrTime = process.hrtime();
		this.openConnections += 1;
		res.on('finish', () => {
			const diff = process.hrtime(startHrTime);
			const duration = diff[0] * 1e3 + diff[1] / 1e6;
			this.totalResponseTime += duration;
			this.requestCount += 1;
			this.openConnections -= 1;
			const averageResponseTime =
				this.totalResponseTime / this.requestCount;
			if (res.statusCode >= 400) {
				this.errorCount += 1;
			}
			this.logMetrics(averageResponseTime);
		});
		next();
	}
	calculateRequestsPerSecond() {
		setInterval(() => {
			this.requestsPerSecond = this.requestCount / process.uptime();
		}, 1000);
	}
	getAverageResponseTime() {
		const averageResponseTime =
			this.totalResponseTime / (this.requestCount || 1);
		return averageResponseTime;
	}
	logMetrics(averageResponseTime) {
		this.logger.info(
			`Average Response Time: ${averageResponseTime.toFixed(2)} ms`
		);
		this.logger.info(`Total Requests: ${this.requestCount}`);
		this.logger.info(`Requests Per Second: ${this.requestsPerSecond}`);
		this.logger.info(`Open Connections: ${this.openConnections}`);
		this.logger.info(`Error Count: ${this.errorCount}`);
	}
	xmlParserMiddleware(req, res, next) {
		const contentType = req.headers['content-type'];
		if (contentType === 'application/xml') {
			rawBody(req, { encoding: 'utf-8' })
				.then(xmlData => {
					try {
						req.parsedXmlBody = new XMLParser().parse(xmlData);
						next();
					} catch (err) {
						res.status(400).send('Invalid XML format');
						next(err);
					}
				})
				.catch(err => {
					res.status(500).send('Error reading XML body');
					next(err);
				});
		} else {
			next();
		}
	}
	async applyMiddlewares(app) {
		const stream = {
			write: message => this.logger.info(message.trim())
		};
		const setMiddlewareStatus = (name, status, error) => {
			this.middlewareStatusService.setStatus(name, status);
			if (status === 'off') {
				this.errorLogger.logError(
					`Middleware "${name}" has failed: ${error}`
				);
			}
		};
		const addMiddleware = async (name, middlewareFn) => {
			try {
				await withRetry(
					async () => {
						if (this.middlewareStatusService.isMiddlewareOn(name)) {
							middlewareFn();
							setMiddlewareStatus(name, 'on');
						}
					},
					5,
					2000
				);
			} catch (err) {
				setMiddlewareStatus(name, 'off', err);
				const middlewareError =
					new this.errorHandler.ErrorClasses.RootMiddlewareError(
						`Error occurred while applying middleware: ${name}`,
						{ exposeToClient: false }
					);
				this.errorHandler.expressErrorHandler()(
					middlewareError,
					blankRequest,
					blankResponse,
					blankNextFunction
				);
			}
		};
		try {
			await addMiddleware('express.text', () => app.use(express.text()));
			await addMiddleware('express.json', () => app.use(express.json()));
			await addMiddleware('express.urlencoded', () =>
				app.use(express.urlencoded({ extended: true }))
			);
			await addMiddleware('cookieParser', () => app.use(cookieParser()));
			await addMiddleware('xmlParserMiddleware', () =>
				app.use(this.xmlParserMiddleware)
			);
			await addMiddleware('morganLogger', () =>
				app.use(morgan('combined', { stream }))
			);
			await addMiddleware('cors', () => app.use(cors()));
			await addMiddleware('responseTime', () => app.use(responseTime()));
			await addMiddleware('trackResponseTime', () =>
				app.use(this.trackResponseTime.bind(this))
			);
			await addMiddleware('etag (strong)', () =>
				app.set('etag', 'strong')
			);
			await addMiddleware('trustProxy', () =>
				app.set('trust proxy', true)
			);
		} catch (err) {
			this.errorLogger.logError(
				`Error applying root level middleware\n${err instanceof Error ? err.message : String(err)}`
			);
			const rootMiddlewareError =
				new this.errorHandler.ErrorClasses.RootMiddlewareError(
					`Error occurred while applying root level middleware`,
					{ exposeToClient: false }
				);
			this.errorHandler.expressErrorHandler()(
				rootMiddlewareError,
				{},
				{},
				() => {}
			);
		}
	}
	async shutdown() {
		try {
			this.logger.info('Shutting down RootMiddlewareService...');
			if (this.requestStatsInterval) {
				clearInterval(this.requestStatsInterval);
				this.logger.info('Cleared requests per second interval.');
			}
			this.totalResponseTime = 0;
			this.requestCount = 0;
			this.errorCount = 0;
			this.openConnections = 0;
			this.requestsPerSecond = 0;
			RootMiddlewareService.instance = null;
			this.logger.info('RootMiddlewareService shutdown completed.');
		} catch (error) {
			const shutdownError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Error during RootMiddlewareService shutdown: ${error instanceof Error ? error.message : 'Unknown error'}`
				);
			this.errorLogger.logError(shutdownError.message);
			this.errorHandler.handleError({ error: shutdownError });
		}
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUm9vdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlL1Jvb3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxZQUFZLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUN4QixPQUFPLE9BQTRDLE1BQU0sU0FBUyxDQUFDO0FBRW5FLE9BQU8sTUFBeUIsTUFBTSxRQUFRLENBQUM7QUFDL0MsT0FBTyxPQUFPLE1BQU0sVUFBVSxDQUFDO0FBQy9CLE9BQU8sWUFBWSxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDNUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzdDLE9BQU8sRUFDTixZQUFZLEVBQ1osYUFBYSxFQUNiLGlCQUFpQixFQUNqQixNQUFNLG1CQUFtQixDQUFDO0FBUzNCLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLG9EQUFvRCxDQUFDO0FBQzFGLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLDBEQUEwRCxDQUFDO0FBQ3RHLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLDhEQUE4RCxDQUFDO0FBRTlHLE1BQU0sT0FBTyxxQkFBcUI7SUFDekIsTUFBTSxDQUFDLFFBQVEsR0FBaUMsSUFBSSxDQUFDO0lBRXJELE1BQU0sQ0FBNEI7SUFDbEMsV0FBVyxDQUE4QjtJQUN6QyxZQUFZLENBQStCO0lBQzNDLHVCQUF1QixDQUFtQztJQUUxRCxpQkFBaUIsR0FBRyxDQUFDLENBQUM7SUFDdEIsWUFBWSxHQUFHLENBQUMsQ0FBQztJQUNqQixVQUFVLEdBQUcsQ0FBQyxDQUFDO0lBQ2YsZUFBZSxHQUFHLENBQUMsQ0FBQztJQUNwQixpQkFBaUIsR0FBRyxDQUFDLENBQUM7SUFDdEIsb0JBQW9CLEdBQTBCLElBQUksQ0FBQztJQUUzRCxZQUNDLE1BQWlDLEVBQ2pD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QUM7WUFFM0IscUJBQXFCLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztZQUV0QyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDO1FBQy9ELENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2hCLE1BQU0sYUFBYSxHQUNsQixJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLHVCQUF1QixDQUN6RCxnREFBZ0QsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsZUFBZSxFQUFFLENBQzFHLENBQUM7WUFDSCxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDakQsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsRUFBRSxLQUFLLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQztRQUN6RCxDQUFDO0lBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjb29raWVQYXJzZXIgZnJvbSAnY29va2llLXBhcnNlcic7XG5pbXBvcnQgY29ycyBmcm9tICdjb3JzJztcbmltcG9ydCBleHByZXNzLCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IEluY29taW5nTWVzc2FnZSB9IGZyb20gJ2h0dHAnO1xuaW1wb3J0IG1vcmdhbiwgeyBTdHJlYW1PcHRpb25zIH0gZnJvbSAnbW9yZ2FuJztcbmltcG9ydCByYXdCb2R5IGZyb20gJ3Jhdy1ib2R5JztcbmltcG9ydCByZXNwb25zZVRpbWUgZnJvbSAncmVzcG9uc2UtdGltZSc7XG5pbXBvcnQgeyBYTUxQYXJzZXIgfSBmcm9tICdmYXN0LXhtbC1wYXJzZXInO1xuaW1wb3J0IHsgd2l0aFJldHJ5IH0gZnJvbSAnLi4vdXRpbHMvaGVscGVycyc7XG5pbXBvcnQge1xuXHRibGFua1JlcXVlc3QsXG5cdGJsYW5rUmVzcG9uc2UsXG5cdGJsYW5rTmV4dEZ1bmN0aW9uXG59IGZyb20gJy4uL2NvbmZpZy9leHByZXNzJztcbmltcG9ydCB7XG5cdEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0RXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZSxcblx0TWlkZGxld2FyZVN0YXR1c1NlcnZpY2VJbnRlcmZhY2UsXG5cdFJvb3RNaWRkbGV3YXJlU2VydmljZUludGVyZmFjZSxcblx0WE1MUGFyc2VkUmVxdWVzdFxufSBmcm9tICcuLi9pbmRleC9pbnRlcmZhY2VzL21haW4nO1xuaW1wb3J0IHsgTG9nZ2VyU2VydmljZUZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5L3N1YmZhY3Rvcmllcy9Mb2dnZXJTZXJ2aWNlRmFjdG9yeSc7XG5pbXBvcnQgeyBFcnJvckhhbmRsZXJTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4uL2luZGV4L2ZhY3Rvcnkvc3ViZmFjdG9yaWVzL0Vycm9ySGFuZGxlclNlcnZpY2VGYWN0b3J5JztcbmltcG9ydCB7IE1pZGRsZXdhcmVTdGF0dXNTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4uL2luZGV4L2ZhY3Rvcnkvc3ViZmFjdG9yaWVzL01pZGRsZXdhcmVTdGF0dXNTZXJ2aWNlRmFjdG9yeSc7XG5cbmV4cG9ydCBjbGFzcyBSb290TWlkZGxld2FyZVNlcnZpY2UgaW1wbGVtZW50cyBSb290TWlkZGxld2FyZVNlcnZpY2VJbnRlcmZhY2Uge1xuXHRwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTogUm9vdE1pZGRsZXdhcmVTZXJ2aWNlIHwgbnVsbCA9IG51bGw7XG5cblx0cHJpdmF0ZSBsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBlcnJvckhhbmRsZXI6IEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgbWlkZGxld2FyZVN0YXR1c1NlcnZpY2U6IE1pZGRsZXdhcmVTdGF0dXNTZXJ2aWNlSW50ZXJmYWNlO1xuXG5cdHByaXZhdGUgdG90YWxSZXNwb25zZVRpbWUgPSAwO1xuXHRwcml2YXRlIHJlcXVlc3RDb3VudCA9IDA7XG5cdHByaXZhdGUgZXJyb3JDb3VudCA9IDA7XG5cdHByaXZhdGUgb3BlbkNvbm5lY3Rpb25zID0gMDtcblx0cHJpdmF0ZSByZXF1ZXN0c1BlclNlY29uZCA9IDA7XG5cdHByaXZhdGUgcmVxdWVzdFN0YXRzSW50ZXJ2YWw6IE5vZGVKUy5UaW1lb3V0IHwgbnVsbCA9IG51bGw7XG5cblx0cHJpdmF0ZSBjb25zdHJ1Y3Rvcihcblx0XHRsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0ZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0XHRlcnJvckhhbmRsZXI6IEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0bWlkZGxld2FyZVN0YXR1c1NlcnZpY2U6IE1pZGRsZXdhcmVTdGF0dXNTZXJ2aWNlSW50ZXJmYWNlXG5cdCkge1xuXHRcdHRoaXMubG9nZ2VyID0gbG9nZ2VyO1xuXHRcdHRoaXMuZXJyb3JMb2dnZXIgPSBlcnJvckxvZ2dlcjtcblx0XHR0aGlzLmVycm9ySGFuZGxlciA9IGVycm9ySGFuZGxlcjtcblx0XHR0aGlzLm1pZGRsZXdhcmVTdGF0dXNTZXJ2aWNlID0gbWlkZGxld2FyZVN0YXR1c1NlcnZpY2U7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGFzeW5jIGdldEluc3RhbmNlKCk6IFByb21pc2U8Um9vdE1pZGRsZXdhcmVTZXJ2aWNlPiB7XG5cdFx0aWYgKCFSb290TWlkZGxld2FyZVNlcnZpY2UuaW5zdGFuY2UpIHtcblx0XHRcdGNvbnN0IGxvZ2dlciA9IGF3YWl0IExvZ2dlclNlcnZpY2VGYWN0b3J5LmdldExvZ2dlclNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGVycm9yTG9nZ2VyID1cblx0XHRcdFx0YXdhaXQgTG9nZ2VyU2VydmljZUZhY3RvcnkuZ2V0RXJyb3JMb2dnZXJTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBlcnJvckhhbmRsZXIgPVxuXHRcdFx0XHRhd2FpdCBFcnJvckhhbmRsZXJTZXJ2aWNlRmFjdG9yeS5nZXRFcnJvckhhbmRsZXJTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBtaWRkbGV3YXJlU3RhdHVzU2VydmljZSA9XG5cdFx0XHRcdGF3YWl0IE1pZGRsZXdhcmVTdGF0dXNTZXJ2aWNlRmFjdG9yeS5nZXRNaWRkbGV3YXJlU3RhdHVzU2VydmljZSgpO1xuXHRcdFx0Um9vdE1pZGRsZXdhcmVTZXJ2aWNlLmluc3RhbmNlID0gbmV3IFJvb3RNaWRkbGV3YXJlU2VydmljZShcblx0XHRcdFx0bG9nZ2VyLFxuXHRcdFx0XHRlcnJvckxvZ2dlcixcblx0XHRcdFx0ZXJyb3JIYW5kbGVyLFxuXHRcdFx0XHRtaWRkbGV3YXJlU3RhdHVzU2VydmljZVxuXHRcdFx0KTtcblx0XHR9XG5cblx0XHRyZXR1cm4gUm9vdE1pZGRsZXdhcmVTZXJ2aWNlLmluc3RhbmNlO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGluaXRpYWxpemUoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IGFwcCA9IGV4cHJlc3MoKTtcblx0XHRcdGF3YWl0IHRoaXMuYXBwbHlNaWRkbGV3YXJlcyhhcHApO1xuXHRcdFx0dGhpcy5jYWxjdWxhdGVSZXF1ZXN0c1BlclNlY29uZCgpO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHRjb25zdCBpbml0aWFsaXphdGlvbkVycm9yID1cblx0XHRcdFx0bmV3IHRoaXMuZXJyb3JIYW5kbGVyLkVycm9yQ2xhc3Nlcy5VdGlsaXR5RXJyb3JSZWNvdmVyYWJsZShcblx0XHRcdFx0XHRgRXJyb3IgZHVyaW5nIFJvb3RNaWRkbGV3YXJlU2VydmljZSBpbml0aWFsaXphdGlvbjogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ31gXG5cdFx0XHRcdCk7XG5cdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKGluaXRpYWxpemF0aW9uRXJyb3IubWVzc2FnZSk7XG5cdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7IGVycm9yOiBpbml0aWFsaXphdGlvbkVycm9yIH0pO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyB0cmFja1Jlc3BvbnNlVGltZShcblx0XHRyZXE6IFJlcXVlc3QsXG5cdFx0cmVzOiBSZXNwb25zZSxcblx0XHRuZXh0OiBOZXh0RnVuY3Rpb25cblx0KTogdm9pZCB7XG5cdFx0Y29uc3Qgc3RhcnRIclRpbWUgPSBwcm9jZXNzLmhydGltZSgpO1xuXHRcdHRoaXMub3BlbkNvbm5lY3Rpb25zICs9IDE7XG5cblx0XHRyZXMub24oJ2ZpbmlzaCcsICgpID0+IHtcblx0XHRcdGNvbnN0IGRpZmYgPSBwcm9jZXNzLmhydGltZShzdGFydEhyVGltZSk7XG5cdFx0XHRjb25zdCBkdXJhdGlvbiA9IGRpZmZbMF0gKiAxZTMgKyBkaWZmWzFdIC8gMWU2O1xuXG5cdFx0XHR0aGlzLnRvdGFsUmVzcG9uc2VUaW1lICs9IGR1cmF0aW9uO1xuXHRcdFx0dGhpcy5yZXF1ZXN0Q291bnQgKz0gMTtcblx0XHRcdHRoaXMub3BlbkNvbm5lY3Rpb25zIC09IDE7XG5cblx0XHRcdGNvbnN0IGF2ZXJhZ2VSZXNwb25zZVRpbWUgPVxuXHRcdFx0XHR0aGlzLnRvdGFsUmVzcG9uc2VUaW1lIC8gdGhpcy5yZXF1ZXN0Q291bnQ7XG5cblx0XHRcdGlmIChyZXMuc3RhdHVzQ29kZSA+PSA0MDApIHtcblx0XHRcdFx0dGhpcy5lcnJvckNvdW50ICs9IDE7XG5cdFx0XHR9XG5cblx0XHRcdHRoaXMubG9nTWV0cmljcyhhdmVyYWdlUmVzcG9uc2VUaW1lKTtcblx0XHR9KTtcblxuXHRcdG5leHQoKTtcblx0fVxuXG5cdHB1YmxpYyBjYWxjdWxhdGVSZXF1ZXN0c1BlclNlY29uZCgpOiB2b2lkIHtcblx0XHRzZXRJbnRlcnZhbCgoKSA9PiB7XG5cdFx0XHR0aGlzLnJlcXVlc3RzUGVyU2Vjb25kID0gdGhpcy5yZXF1ZXN0Q291bnQgLyBwcm9jZXNzLnVwdGltZSgpO1xuXHRcdH0sIDEwMDApO1xuXHR9XG5cblx0cHVibGljIGdldEF2ZXJhZ2VSZXNwb25zZVRpbWUoKTogbnVtYmVyIHtcblx0XHRjb25zdCBhdmVyYWdlUmVzcG9uc2VUaW1lID1cblx0XHRcdHRoaXMudG90YWxSZXNwb25zZVRpbWUgLyAodGhpcy5yZXF1ZXN0Q291bnQgfHwgMSk7XG5cdFx0cmV0dXJuIGF2ZXJhZ2VSZXNwb25zZVRpbWU7XG5cdH1cblxuXHRwcml2YXRlIGxvZ01ldHJpY3MoYXZlcmFnZVJlc3BvbnNlVGltZTogbnVtYmVyKTogdm9pZCB7XG5cdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdGBBdmVyYWdlIFJlc3BvbnNlIFRpbWU6ICR7YXZlcmFnZVJlc3BvbnNlVGltZS50b0ZpeGVkKDIpfSBtc2Bcblx0XHQpO1xuXHRcdHRoaXMubG9nZ2VyLmluZm8oYFRvdGFsIFJlcXVlc3RzOiAke3RoaXMucmVxdWVzdENvdW50fWApO1xuXHRcdHRoaXMubG9nZ2VyLmluZm8oYFJlcXVlc3RzIFBlciBTZWNvbmQ6ICR7dGhpcy5yZXF1ZXN0c1BlclNlY29uZH1gKTtcblx0XHR0aGlzLmxvZ2dlci5pbmZvKGBPcGVuIENvbm5lY3Rpb25zOiAke3RoaXMub3BlbkNvbm5lY3Rpb25zfWApO1xuXHRcdHRoaXMubG9nZ2VyLmluZm8oYEVycm9yIENvdW50OiAke3RoaXMuZXJyb3JDb3VudH1gKTtcblx0fVxuXG5cdHByaXZhdGUgeG1sUGFyc2VyTWlkZGxld2FyZShcblx0XHRyZXE6IFJlcXVlc3QsXG5cdFx0cmVzOiBSZXNwb25zZSxcblx0XHRuZXh0OiBOZXh0RnVuY3Rpb25cblx0KTogdm9pZCB7XG5cdFx0Y29uc3QgY29udGVudFR5cGUgPSByZXEuaGVhZGVyc1snY29udGVudC10eXBlJ10gYXMgc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG5cdFx0aWYgKGNvbnRlbnRUeXBlID09PSAnYXBwbGljYXRpb24veG1sJykge1xuXHRcdFx0cmF3Qm9keShyZXEgYXMgdW5rbm93biBhcyBJbmNvbWluZ01lc3NhZ2UsIHsgZW5jb2Rpbmc6ICd1dGYtOCcgfSlcblx0XHRcdFx0LnRoZW4oKHhtbERhdGE6IHN0cmluZykgPT4ge1xuXHRcdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0XHQocmVxIGFzIFhNTFBhcnNlZFJlcXVlc3QpLnBhcnNlZFhtbEJvZHkgPVxuXHRcdFx0XHRcdFx0XHRuZXcgWE1MUGFyc2VyKCkucGFyc2UoeG1sRGF0YSk7XG5cdFx0XHRcdFx0XHRuZXh0KCk7XG5cdFx0XHRcdFx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0XHRcdFx0XHRyZXMuc3RhdHVzKDQwMCkuc2VuZCgnSW52YWxpZCBYTUwgZm9ybWF0Jyk7XG5cdFx0XHRcdFx0XHRuZXh0KGVycik7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KVxuXHRcdFx0XHQuY2F0Y2goZXJyID0+IHtcblx0XHRcdFx0XHRyZXMuc3RhdHVzKDUwMCkuc2VuZCgnRXJyb3IgcmVhZGluZyBYTUwgYm9keScpO1xuXHRcdFx0XHRcdG5leHQoZXJyKTtcblx0XHRcdFx0fSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdG5leHQoKTtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgYXBwbHlNaWRkbGV3YXJlcyhhcHA6IGV4cHJlc3MuQXBwbGljYXRpb24pOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRjb25zdCBzdHJlYW06IFN0cmVhbU9wdGlvbnMgPSB7XG5cdFx0XHR3cml0ZTogKG1lc3NhZ2U6IHN0cmluZykgPT4gdGhpcy5sb2dnZXIuaW5mbyhtZXNzYWdlLnRyaW0oKSlcblx0XHR9O1xuXG5cdFx0Y29uc3Qgc2V0TWlkZGxld2FyZVN0YXR1cyA9IChcblx0XHRcdG5hbWU6IHN0cmluZyxcblx0XHRcdHN0YXR1czogJ29uJyB8ICdvZmYnLFxuXHRcdFx0ZXJyb3I/OiB1bmtub3duXG5cdFx0KTogdm9pZCA9PiB7XG5cdFx0XHR0aGlzLm1pZGRsZXdhcmVTdGF0dXNTZXJ2aWNlLnNldFN0YXR1cyhuYW1lLCBzdGF0dXMpO1xuXHRcdFx0aWYgKHN0YXR1cyA9PT0gJ29mZicpIHtcblx0XHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcihcblx0XHRcdFx0XHRgTWlkZGxld2FyZSBcIiR7bmFtZX1cIiBoYXMgZmFpbGVkOiAke2Vycm9yfWBcblx0XHRcdFx0KTtcblx0XHRcdH1cblx0XHR9O1xuXG5cdFx0Y29uc3QgYWRkTWlkZGxld2FyZSA9IGFzeW5jIChcblx0XHRcdG5hbWU6IHN0cmluZyxcblx0XHRcdG1pZGRsZXdhcmVGbjogKCkgPT4gdm9pZFxuXHRcdCk6IFByb21pc2U8dm9pZD4gPT4ge1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0YXdhaXQgd2l0aFJldHJ5KFxuXHRcdFx0XHRcdGFzeW5jICgpID0+IHtcblx0XHRcdFx0XHRcdGlmICh0aGlzLm1pZGRsZXdhcmVTdGF0dXNTZXJ2aWNlLmlzTWlkZGxld2FyZU9uKG5hbWUpKSB7XG5cdFx0XHRcdFx0XHRcdG1pZGRsZXdhcmVGbigpO1xuXHRcdFx0XHRcdFx0XHRzZXRNaWRkbGV3YXJlU3RhdHVzKG5hbWUsICdvbicpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0NSxcblx0XHRcdFx0XHQyMDAwXG5cdFx0XHRcdCk7XG5cdFx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdFx0c2V0TWlkZGxld2FyZVN0YXR1cyhuYW1lLCAnb2ZmJywgZXJyKTtcblx0XHRcdFx0Y29uc3QgbWlkZGxld2FyZUVycm9yID1cblx0XHRcdFx0XHRuZXcgdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JDbGFzc2VzLlJvb3RNaWRkbGV3YXJlRXJyb3IoXG5cdFx0XHRcdFx0XHRgRXJyb3Igb2NjdXJyZWQgd2hpbGUgYXBwbHlpbmcgbWlkZGxld2FyZTogJHtuYW1lfWAsXG5cdFx0XHRcdFx0XHR7IGV4cG9zZVRvQ2xpZW50OiBmYWxzZSB9XG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuZXhwcmVzc0Vycm9ySGFuZGxlcigpKFxuXHRcdFx0XHRcdG1pZGRsZXdhcmVFcnJvcixcblx0XHRcdFx0XHRibGFua1JlcXVlc3QsXG5cdFx0XHRcdFx0YmxhbmtSZXNwb25zZSxcblx0XHRcdFx0XHRibGFua05leHRGdW5jdGlvblxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXHRcdH07XG5cblx0XHR0cnkge1xuXHRcdFx0YXdhaXQgYWRkTWlkZGxld2FyZSgnZXhwcmVzcy50ZXh0JywgKCkgPT4gYXBwLnVzZShleHByZXNzLnRleHQoKSkpO1xuXHRcdFx0YXdhaXQgYWRkTWlkZGxld2FyZSgnZXhwcmVzcy5qc29uJywgKCkgPT4gYXBwLnVzZShleHByZXNzLmpzb24oKSkpO1xuXHRcdFx0YXdhaXQgYWRkTWlkZGxld2FyZSgnZXhwcmVzcy51cmxlbmNvZGVkJywgKCkgPT5cblx0XHRcdFx0YXBwLnVzZShleHByZXNzLnVybGVuY29kZWQoeyBleHRlbmRlZDogdHJ1ZSB9KSlcblx0XHRcdCk7XG5cdFx0XHRhd2FpdCBhZGRNaWRkbGV3YXJlKCdjb29raWVQYXJzZXInLCAoKSA9PiBhcHAudXNlKGNvb2tpZVBhcnNlcigpKSk7XG5cdFx0XHRhd2FpdCBhZGRNaWRkbGV3YXJlKCd4bWxQYXJzZXJNaWRkbGV3YXJlJywgKCkgPT5cblx0XHRcdFx0YXBwLnVzZSh0aGlzLnhtbFBhcnNlck1pZGRsZXdhcmUpXG5cdFx0XHQpO1xuXHRcdFx0YXdhaXQgYWRkTWlkZGxld2FyZSgnbW9yZ2FuTG9nZ2VyJywgKCkgPT5cblx0XHRcdFx0YXBwLnVzZShtb3JnYW4oJ2NvbWJpbmVkJywgeyBzdHJlYW0gfSkpXG5cdFx0XHQpO1xuXHRcdFx0YXdhaXQgYWRkTWlkZGxld2FyZSgnY29ycycsICgpID0+IGFwcC51c2UoY29ycygpKSk7XG5cdFx0XHRhd2FpdCBhZGRNaWRkbGV3YXJlKCdyZXNwb25zZVRpbWUnLCAoKSA9PiBhcHAudXNlKHJlc3BvbnNlVGltZSgpKSk7XG5cdFx0XHRhd2FpdCBhZGRNaWRkbGV3YXJlKCd0cmFja1Jlc3BvbnNlVGltZScsICgpID0+XG5cdFx0XHRcdGFwcC51c2UodGhpcy50cmFja1Jlc3BvbnNlVGltZS5iaW5kKHRoaXMpKVxuXHRcdFx0KTtcblx0XHRcdGF3YWl0IGFkZE1pZGRsZXdhcmUoJ2V0YWcgKHN0cm9uZyknLCAoKSA9PlxuXHRcdFx0XHRhcHAuc2V0KCdldGFnJywgJ3N0cm9uZycpXG5cdFx0XHQpO1xuXHRcdFx0YXdhaXQgYWRkTWlkZGxld2FyZSgndHJ1c3RQcm94eScsICgpID0+XG5cdFx0XHRcdGFwcC5zZXQoJ3RydXN0IHByb3h5JywgdHJ1ZSlcblx0XHRcdCk7XG5cdFx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKFxuXHRcdFx0XHRgRXJyb3IgYXBwbHlpbmcgcm9vdCBsZXZlbCBtaWRkbGV3YXJlXFxuJHtlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogU3RyaW5nKGVycil9YFxuXHRcdFx0KTtcblx0XHRcdGNvbnN0IHJvb3RNaWRkbGV3YXJlRXJyb3IgPVxuXHRcdFx0XHRuZXcgdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JDbGFzc2VzLlJvb3RNaWRkbGV3YXJlRXJyb3IoXG5cdFx0XHRcdFx0YEVycm9yIG9jY3VycmVkIHdoaWxlIGFwcGx5aW5nIHJvb3QgbGV2ZWwgbWlkZGxld2FyZWAsXG5cdFx0XHRcdFx0eyBleHBvc2VUb0NsaWVudDogZmFsc2UgfVxuXHRcdFx0XHQpO1xuXHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuZXhwcmVzc0Vycm9ySGFuZGxlcigpKFxuXHRcdFx0XHRyb290TWlkZGxld2FyZUVycm9yLFxuXHRcdFx0XHR7fSBhcyBleHByZXNzLlJlcXVlc3QsXG5cdFx0XHRcdHt9IGFzIGV4cHJlc3MuUmVzcG9uc2UsXG5cdFx0XHRcdCgpID0+IHt9XG5cdFx0XHQpO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBzaHV0ZG93bigpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHR0cnkge1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnU2h1dHRpbmcgZG93biBSb290TWlkZGxld2FyZVNlcnZpY2UuLi4nKTtcblxuXHRcdFx0aWYgKHRoaXMucmVxdWVzdFN0YXRzSW50ZXJ2YWwpIHtcblx0XHRcdFx0Y2xlYXJJbnRlcnZhbCh0aGlzLnJlcXVlc3RTdGF0c0ludGVydmFsKTtcblx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnQ2xlYXJlZCByZXF1ZXN0cyBwZXIgc2Vjb25kIGludGVydmFsLicpO1xuXHRcdFx0fVxuXG5cdFx0XHR0aGlzLnRvdGFsUmVzcG9uc2VUaW1lID0gMDtcblx0XHRcdHRoaXMucmVxdWVzdENvdW50ID0gMDtcblx0XHRcdHRoaXMuZXJyb3JDb3VudCA9IDA7XG5cdFx0XHR0aGlzLm9wZW5Db25uZWN0aW9ucyA9IDA7XG5cdFx0XHR0aGlzLnJlcXVlc3RzUGVyU2Vjb25kID0gMDtcblxuXHRcdFx0Um9vdE1pZGRsZXdhcmVTZXJ2aWNlLmluc3RhbmNlID0gbnVsbDtcblxuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnUm9vdE1pZGRsZXdhcmVTZXJ2aWNlIHNodXRkb3duIGNvbXBsZXRlZC4nKTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0Y29uc3Qgc2h1dGRvd25FcnJvciA9XG5cdFx0XHRcdG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuVXRpbGl0eUVycm9yUmVjb3ZlcmFibGUoXG5cdFx0XHRcdFx0YEVycm9yIGR1cmluZyBSb290TWlkZGxld2FyZVNlcnZpY2Ugc2h1dGRvd246ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9YFxuXHRcdFx0XHQpO1xuXHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcihzaHV0ZG93bkVycm9yLm1lc3NhZ2UpO1xuXHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3IoeyBlcnJvcjogc2h1dGRvd25FcnJvciB9KTtcblx0XHR9XG5cdH1cbn1cbiJdfQ==
