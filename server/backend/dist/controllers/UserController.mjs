import { User } from '../models/User.mjs';
import { validateDependencies } from '../utils/helpers.mjs';
import { AuthServiceFactory } from '../index/factory/subfactories/AuthServiceFactory.mjs';
import { ErrorHandlerServiceFactory } from '../index/factory/subfactories/ErrorHandlerServiceFactory.mjs';
import { LoggerServiceFactory } from '../index/factory/subfactories/LoggerServiceFactory.mjs';
import { EnvConfigServiceFactory } from '../index/factory/subfactories/EnvConfigServiceFactory.mjs';
import { VaultServiceFactory } from '../index/factory/subfactories/VaultServiceFactory.mjs';
import { PreHTTPSFactory } from '../index/factory/subfactories/PreHTTPSFactory.mjs';
export class UserController {
	static instance = null;
	passwordService;
	logger;
	errorLogger;
	errorHandler;
	envConfig;
	vault;
	mailer;
	userModel;
	constructor(
		passwordService,
		logger,
		errorLogger,
		errorHandler,
		envConfig,
		secrets,
		mailer,
		userModel = User
	) {
		this.passwordService = passwordService;
		this.logger = logger;
		this.errorLogger = errorLogger;
		this.errorHandler = errorHandler;
		this.envConfig = envConfig;
		this.vault = secrets;
		this.mailer = mailer;
		this.userModel = userModel;
		validateDependencies(
			[{ name: 'userModel', instance: this.userModel }],
			this.logger
		);
	}
	static async getInstance() {
		if (!UserController.instance) {
			const passwordService =
				await AuthServiceFactory.getPasswordService();
			const logger = await LoggerServiceFactory.getLoggerService();
			const errorLogger =
				await LoggerServiceFactory.getErrorLoggerService();
			const errorHandler =
				await ErrorHandlerServiceFactory.getErrorHandlerService();
			const envConfig =
				await EnvConfigServiceFactory.getEnvConfigService();
			const secrets = await VaultServiceFactory.getVaultService();
			const mailer = await PreHTTPSFactory.getMailerService();
			UserController.instance = new UserController(
				passwordService,
				logger,
				errorLogger,
				errorHandler,
				envConfig,
				secrets,
				mailer
			);
		}
		return UserController.instance;
	}
	mapToUserInstance(user) {
		return {
			id: user.id,
			userId: user.userId || undefined,
			username: user.username,
			password: user.password,
			email: user.email,
			isAccountVerified: user.isVerified,
			resetPasswordToken: user.resetPasswordToken,
			resetPasswordExpires: user.resetPasswordExpires,
			isMFAEnabled: user.isMFAEnabled,
			totpSecret: user.totpSecret,
			emailMFAToken: user.emailMFAToken,
			emailMFATokenExpires: user.emailMFATokenExpires,
			creationDate: user.creationDate,
			comparePassword: async (password, argon2) => {
				return await argon2.verify(
					user.password,
					password + process.env.PEPPER
				);
			},
			save: async () => {
				await user.save();
			}
		};
	}
	async findOne(criteria) {
		try {
			const user = await this.userModel.findOne({ where: criteria });
			if (!user) {
				this.logger.debug('User not found with provided criteria');
				return null;
			}
			return this.mapToUserInstance(user);
		} catch (error) {
			this.errorHandler.handleError({ error, action: 'findOne' });
			return null;
		}
	}
	async findUserById(userId) {
		try {
			const user = await this.userModel.findOne({
				where: { id: userId }
			});
			if (!user) {
				this.logger.warn(`User with ID ${userId} not found`);
				return null;
			}
			return this.mapToUserInstance(user);
		} catch (error) {
			this.logger.error(`Error finding user by ID ${userId}: ${error}`);
			this.errorHandler.handleError({ error, action: 'findUserById' });
			return null;
		}
	}
	async findUserByEmail(email) {
		const user = await this.userModel.findOne({ where: { email } });
		if (!user) {
			return null;
		}
		return this.mapToUserInstance(user);
	}
	async createUser(userDetails) {
		try {
			const isPasswordStrong = await this.checkPasswordStrength(
				userDetails.password
			);
			if (!isPasswordStrong) {
				this.logger.warn('Password strength validation failed');
				throw new this.errorHandler.ErrorClasses.PasswordValidationError(
					'Password does not meet strength requirements',
					{ exposeToClient: true }
				);
			}
			const pepper = this.vault.retrieveSecret(
				'PEPPER',
				secret => secret
			);
			if (!pepper || typeof pepper !== 'string') {
				throw new this.errorHandler.ErrorClasses.ServiceUnavailableError(
					10,
					'Invalid pepper',
					{ exposeToClient: false }
				);
			}
			const hashedPassword = await this.passwordService.hashPassword(
				userDetails.password,
				pepper
			);
			const userUuid = await this.loadUuidv4();
			const newUser = await this.userModel.create({
				id: userUuid,
				...userDetails,
				password: hashedPassword,
				isVerified: false,
				resetPasswordToken: null,
				resetPasswordExpires: null,
				creationDate: new Date()
			});
			this.logger.info(`User ${newUser.username} created successfully`);
			await this.sendConfirmationEmail(newUser);
			return this.mapToUserInstance(newUser);
		} catch (err) {
			this.logger.error(`Error creating user: ${String(err)}`);
			this.errorHandler.handleError({
				error: err || 'User creation failed'
			});
			throw err;
		}
	}
	async checkPasswordStrength(password) {
		const zxcvbn = await this.loadZxcvbn();
		const { score } = zxcvbn(password);
		if (score < 3) {
			this.logger.warn('Password strength too weak');
			return false;
		}
		try {
			const axios = await this.loadAxios();
			const firstFiveChars = password.substring(0, 5);
			const remainingChars = password.substring(5).toUpperCase();
			const pwnedResponse = await axios.get(
				`https://api.pwnedpasswords.com/range/${firstFiveChars}`
			);
			const pwnedList = pwnedResponse.data
				.split('\n')
				.map(line => line.split(':')[0]);
			if (pwnedList.includes(remainingChars)) {
				this.logger.warn('Password found in breach');
				return false;
			}
		} catch (error) {
			this.logger.error(
				`Error checking password breach status: ${String(error)}`
			);
		}
		return true;
	}
	async verifyUserAccount(userId) {
		try {
			const user = await this.userModel.findOne({
				where: { id: userId }
			});
			if (!user) {
				this.logger.warn(`User with ID ${userId} not found`);
				return false;
			}
			user.isVerified = true;
			await user.save();
			this.logger.info(`User ${user.username} verified successfully`);
			return true;
		} catch (error) {
			this.errorHandler.handleError({
				error,
				action: 'verifyUserAccount',
				details: { userId }
			});
			return false;
		}
	}
	removeUndefinedFields(obj) {
		return Object.fromEntries(
			Object.entries(obj).filter(([, v]) => v !== undefined)
		);
	}
	async updateUser(user, updatedDetails) {
		try {
			const fullUser = await this.userModel.findOne({
				where: { id: user.id }
			});
			if (!fullUser) {
				this.logger.warn(`User with id ${user.id} not found`);
				return null;
			}
			const pepper = this.vault.retrieveSecret(
				'PEPPER',
				secret => secret
			);
			if (!pepper || typeof pepper !== 'string') {
				throw new this.errorHandler.ErrorClasses.ServiceUnavailableError(
					10,
					'Invalid pepper',
					{ exposeToClient: false }
				);
			}
			if (updatedDetails.password) {
				const hashedPassword = await this.passwordService.hashPassword(
					updatedDetails.password,
					pepper
				);
				updatedDetails.password = hashedPassword;
			}
			const cleanUpdatedDetails =
				this.removeUndefinedFields(updatedDetails);
			const updateData = cleanUpdatedDetails;
			const updatedUser = await fullUser.update(updateData);
			this.logger.info(
				`User ${updatedUser.username} updated successfully`
			);
			return this.mapToUserInstance(updatedUser);
		} catch (error) {
			this.errorLogger.logError(`Error updating user: ${String(error)}`);
			this.errorHandler.handleError({ error });
			return null;
		}
	}
	async sendConfirmationEmail(user) {
		try {
			const jwtSecret = this.vault.retrieveSecret(
				'JWT_SECRET',
				secret => secret
			);
			if (typeof jwtSecret !== 'string') {
				throw new this.errorHandler.ErrorClasses.ServiceUnavailableError(
					10,
					'Invalid JWT secret',
					{ exposeToClient: false }
				);
			}
			const jwt = await this.loadJwt();
			const confirmationToken = jwt.sign({ id: user.id }, jwtSecret, {
				expiresIn: '1d'
			});
			const baseUrl = this.envConfig.getEnvVariable('baseUrl');
			const port = this.envConfig.getEnvVariable('serverPort');
			const confirmationUrl = `${baseUrl}${port}/api/users/confirm/${confirmationToken}`;
			const mailOptions = {
				from: this.envConfig.getEnvVariable('emailUser'),
				to: user.email,
				subject: 'Please Confirm Your Account',
				html: `
					<p>Hi ${user.username},</p>
					<p>Please confirm your account by clicking the following link:</p>
					<a href="${confirmationUrl}">Confirm Account</a>
				`
			};
			const transporter = await this.mailer.getTransporter();
			await transporter.sendMail(mailOptions);
			this.logger.info(`Confirmation email sent to ${user.email}`);
		} catch (error) {
			this.logger.logError(
				`Error sending confirmation email to ${user.email}`
			);
			this.errorHandler.handleError({
				error,
				details: { userId: user.id }
			});
			throw error;
		}
	}
	async deleteUser(userId) {
		try {
			const user = await this.userModel.findOne({
				where: { id: userId }
			});
			if (!user) {
				this.logger.warn(`User with id ${userId} not found`);
				return false;
			}
			await user.destroy();
			this.logger.info(`User with id ${userId} deleted successfully`);
			return true;
		} catch (error) {
			this.errorLogger.logError(
				`Error deleting user with id ${userId}\n${String(error)}`
			);
			this.errorHandler.handleError({
				error,
				details: { userId }
			});
			return false;
		}
	}
	async shutdown() {
		try {
			this.logger.info('Shutting down UserController...');
			UserController.instance = null;
			this.logger.info('UserController shutdown completed.');
		} catch (error) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Error during UserController shutdown: ${error instanceof Error ? error.message : error}`
				);
			this.errorLogger.logError(utilityError.message);
			this.errorHandler.handleError({ error: utilityError });
		}
	}
	async loadAxios() {
		return (await import('axios')).default;
	}
	async loadJwt() {
		return (await import('jsonwebtoken')).default;
	}
	async loadUuidv4() {
		const { v4: uuidv4 } = await import('uuid');
		return uuidv4();
	}
	async loadZxcvbn() {
		return (await import('zxcvbn')).default;
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXNlckNvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29udHJvbGxlcnMvVXNlckNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3RDLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBaUJ4RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxrREFBa0QsQ0FBQztBQUN0RixPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSwwREFBMEQsQ0FBQztBQUN0RyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxvREFBb0QsQ0FBQztBQUMxRixPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSx1REFBdUQsQ0FBQztBQUNoRyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxtREFBbUQsQ0FBQztBQUN4RixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sK0NBQStDLENBQUM7QUFFaEYsTUFBTSxPQUFPLGNBQWM7SUFDbEIsTUFBTSxDQUFDLFFBQVEsR0FBMEIsSUFBSSxDQUFDO0lBQzlDLGVBQWUsQ0FBMkI7SUFDMUMsTUFBTSxDQUE0QjtJQUNsQyxXQUFXLENBQThCO0lBQ3pDLFlBQVksQ0FBK0I7SUFDM0MsU0FBUyxDQUE0QjtJQUNyQyxLQUFLLENBQXdCO0lBQzdCLE1BQU0sQ0FBeUI7SUFDL0IsU0FBUyxDQUFjO0lBRS9CLFlBQ0MsZUFBeUMsRUFDekMsTUFBaUMsRUFDakMsV0FBd0MsRUFDeEMsWUFBMEMsRUFDMUMsU0FBb0MsRUFDcEMsT0FBOEIsRUFDOUIsTUFBOEIsRUFDOUIsWUFBeUIsSUFBSTtRQUU3QixJQUFJLENBQUMsZUFBZSxHQUFHLGVBQWUsQ0FBQztRQUN2QyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQztRQUMv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Q0YsQ0FBQztJQUVTLEtBQUssQ0FBQyxTQUFTO1FBQ3hCLE9BQU8sQ0FBQyxNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztJQUN4QyxDQUFDO0lBRU8sS0FBSyxDQUFDLE9BQU87UUFDcEIsT0FBTyxDQUFDLE1BQU0sTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO0lBQy9DLENBQUM7SUFFTyxLQUFLLENBQUMsVUFBVTtRQUN2QixNQUFNLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxHQUFHLE1BQU0sTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzVDLE9BQU8sTUFBTSxFQUFFLENBQUM7SUFDakIsQ0FBQztJQUVPLEtBQUssQ0FBQyxVQUFVO1FBQ3ZCLE9BQU8sQ0FBQyxNQUFNLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztJQUN6QyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVXNlciB9IGZyb20gJy4uL21vZGVscy9Vc2VyJztcbmltcG9ydCB7IHZhbGlkYXRlRGVwZW5kZW5jaWVzIH0gZnJvbSAnLi4vdXRpbHMvaGVscGVycyc7XG5pbXBvcnQge1xuXHRBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFbnZDb25maWdTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdE1haWxlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFBhc3N3b3JkU2VydmljZUludGVyZmFjZSxcblx0VXNlckNvbnRyb2xsZXJEZXBzLFxuXHRVc2VyQ29udHJvbGxlckludGVyZmFjZSxcblx0VmF1bHRTZXJ2aWNlSW50ZXJmYWNlXG59IGZyb20gJy4uL2luZGV4L2ludGVyZmFjZXMvbWFpbic7XG5pbXBvcnQge1xuXHRVc2VyQXR0cmlidXRlc0ludGVyZmFjZSxcblx0VXNlckluc3RhbmNlSW50ZXJmYWNlXG59IGZyb20gJy4uL2luZGV4L2ludGVyZmFjZXMvbW9kZWxzJztcbmltcG9ydCB7IEluZmVyQXR0cmlidXRlcywgV2hlcmVPcHRpb25zIH0gZnJvbSAnc2VxdWVsaXplL3R5cGVzJztcbmltcG9ydCB7IEF1dGhTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4uL2luZGV4L2ZhY3Rvcnkvc3ViZmFjdG9yaWVzL0F1dGhTZXJ2aWNlRmFjdG9yeSc7XG5pbXBvcnQgeyBFcnJvckhhbmRsZXJTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4uL2luZGV4L2ZhY3Rvcnkvc3ViZmFjdG9yaWVzL0Vycm9ySGFuZGxlclNlcnZpY2VGYWN0b3J5JztcbmltcG9ydCB7IExvZ2dlclNlcnZpY2VGYWN0b3J5IH0gZnJvbSAnLi4vaW5kZXgvZmFjdG9yeS9zdWJmYWN0b3JpZXMvTG9nZ2VyU2VydmljZUZhY3RvcnknO1xuaW1wb3J0IHsgRW52Q29uZmlnU2VydmljZUZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5L3N1YmZhY3Rvcmllcy9FbnZDb25maWdTZXJ2aWNlRmFjdG9yeSc7XG5pbXBvcnQgeyBWYXVsdFNlcnZpY2VGYWN0b3J5IH0gZnJvbSAnLi4vaW5kZXgvZmFjdG9yeS9zdWJmYWN0b3JpZXMvVmF1bHRTZXJ2aWNlRmFjdG9yeSc7XG5pbXBvcnQgeyBQcmVIVFRQU0ZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5L3N1YmZhY3Rvcmllcy9QcmVIVFRQU0ZhY3RvcnknO1xuXG5leHBvcnQgY2xhc3MgVXNlckNvbnRyb2xsZXIgaW1wbGVtZW50cyBVc2VyQ29udHJvbGxlckludGVyZmFjZSB7XG5cdHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBVc2VyQ29udHJvbGxlciB8IG51bGwgPSBudWxsO1xuXHRwcml2YXRlIHBhc3N3b3JkU2VydmljZTogUGFzc3dvcmRTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIGxvZ2dlcjogQXBwTG9nZ2VyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBlcnJvckxvZ2dlcjogRXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIGVycm9ySGFuZGxlcjogRXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBlbnZDb25maWc6IEVudkNvbmZpZ1NlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgdmF1bHQ6IFZhdWx0U2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBtYWlsZXI6IE1haWxlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgdXNlck1vZGVsOiB0eXBlb2YgVXNlcjtcblxuXHRwcml2YXRlIGNvbnN0cnVjdG9yKFxuXHRcdHBhc3N3b3JkU2VydmljZTogUGFzc3dvcmRTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGxvZ2dlcjogQXBwTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0XHRlcnJvckxvZ2dlcjogRXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGVycm9ySGFuZGxlcjogRXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZSxcblx0XHRlbnZDb25maWc6IEVudkNvbmZpZ1NlcnZpY2VJbnRlcmZhY2UsXG5cdFx0c2VjcmV0czogVmF1bHRTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdG1haWxlcjogTWFpbGVyU2VydmljZUludGVyZmFjZSxcblx0XHR1c2VyTW9kZWw6IHR5cGVvZiBVc2VyID0gVXNlclxuXHQpIHtcblx0XHR0aGlzLnBhc3N3b3JkU2VydmljZSA9IHBhc3N3b3JkU2VydmljZTtcblx0XHR0aGlzLmxvZ2dlciA9IGxvZ2dlcjtcblx0XHR0aGlzLmVycm9yTG9nZ2VyID0gZXJyb3JMb2dnZXI7XG5cdFx0dGhpcy5lcnJvckhhbmRsZXIgPSBlcnJvckhhbmRsZXI7XG5cdFx0dGhpcy5lbnZDb25maWcgPSBlbnZDb25maWc7XG5cdFx0dGhpcy52YXVsdCA9IHNlY3JldHM7XG5cdFx0dGhpcy5tYWlsZXIgPSBtYWlsZXI7XG5cdFx0dGhpcy51c2VyTW9kZWwgPSB1c2VyTW9kZWw7XG5cblx0XHR2YWxpZGF0ZURlcGVuZGVuY2llcyhcblx0XHRcdFt7IG5hbWU6ICd1c2VyTW9kZWwnLCBpbnN0YW5jZTogdGhpcy51c2VyTW9kZWwgfV0sXG5cdFx0XHR0aGlzLmxvZ2dlclxuXHRcdCk7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGFzeW5jIGdldEluc3RhbmNlKCk6IFByb21pc2U8VXNlckNvbnRyb2xsZXI+IHtcblx0XHRpZiAoIVVzZXJDb250cm9sbGVyLmluc3RhbmNlKSB7XG5cdFx0XHRjb25zdCBwYXNzd29yZFNlcnZpY2UgPVxuXHRcdFx0XHRhd2FpdCBBdXRoU2VydmljZUZhY3RvcnkuZ2V0UGFzc3dvcmRTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBsb2dnZXIgPSBhd2FpdCBMb2dnZXJTZXJ2aWNlRmFjdG9yeS5nZXRMb2dnZXJTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBlcnJvckxvZ2dlciA9XG5cdFx0XHRcdGF3YWl0IExvZ2dlclNlcnZpY2VGYWN0b3J5LmdldEVycm9yTG9nZ2VyU2VydmljZSgpO1xuXHRcdFx0Y29uc3QgZXJyb3JIYW5kbGVyID1cblx0XHRcdFx0YXdhaXQgRXJyb3JIYW5kbGVyU2VydmljZUZhY3RvcnkuZ2V0RXJyb3JIYW5kbGVyU2VydmljZSgpO1xuXHRcdFx0Y29uc3QgZW52Q29uZmlnID1cblx0XHRcdFx0YXdhaXQgRW52Q29uZmlnU2VydmljZUZhY3RvcnkuZ2V0RW52Q29uZmlnU2VydmljZSgpO1xuXHRcdFx0Y29uc3Qgc2VjcmV0cyA9IGF3YWl0IFZhdWx0U2VydmljZUZhY3RvcnkuZ2V0VmF1bHRTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBtYWlsZXIgPSBhd2FpdCBQcmVIVFRQU0ZhY3RvcnkuZ2V0TWFpbGVyU2VydmljZSgpO1xuXG5cdFx0XHRVc2VyQ29udHJvbGxlci5pbnN0YW5jZSA9IG5ldyBVc2VyQ29udHJvbGxlcihcblx0XHRcdFx0cGFzc3dvcmRTZXJ2aWNlLFxuXHRcdFx0XHRsb2dnZXIsXG5cdFx0XHRcdGVycm9yTG9nZ2VyLFxuXHRcdFx0XHRlcnJvckhhbmRsZXIsXG5cdFx0XHRcdGVudkNvbmZpZyxcblx0XHRcdFx0c2VjcmV0cyxcblx0XHRcdFx0bWFpbGVyXG5cdFx0XHQpO1xuXHRcdH1cblx0XHRyZXR1cm4gVXNlckNvbnRyb2xsZXIuaW5zdGFuY2U7XG5cdH1cblxuXHRwcml2YXRlIG1hcFRvVXNlckluc3RhbmNlKHVzZXI6IFVzZXIpOiBVc2VySW5zdGFuY2VJbnRlcmZhY2Uge1xuXHRcdHJldHVybiB7XG5cdFx0XHRpZDogdXNlci5pZCxcblx0XHRcdHVzZXJJZDogdXNlci51c2VySWQgfHwgdW5kZWZpbmVkLFxuXHRcdFx0dXNlcm5hbWU6IHVzZXIudXNlcm5hbWUsXG5cdFx0XHRwYXNzd29yZDogdXNlci5wYXNzd29yZCxcblx0XHRcdGVtYWlsOiB1c2VyLmVtYWlsLFxuXHRcdFx0aXNBY2NvdW50VmVyaWZpZWQ6IHVzZXIuaXNWZXJpZmllZCxcblx0XHRcdHJlc2V0UGFzc3dvcmRUb2tlbjogdXNlci5yZXNldFBhc3N3b3JkVG9rZW4sXG5cdFx0XHRyZXNldFBhc3N3b3JkRXhwaXJlczogdXNlci5yZXNldFBhc3N3b3JkRXhwaXJlcyxcblx0XHRcdGlzTUZBRW5hYmxlZDogdXNlci5pc01GQUVuYWJsZWQsXG5cdFx0XHR0b3RwU2VjcmV0OiB1c2VyLnRvdHBTZWNyZXQsXG5cdFx0XHRlbWFpbE1GQVRva2VuOiB1c2VyLmVtYWlsTUZBVG9rZW4sXG5cdFx0XHRlbWFpbE1GQVRva2VuRXhwaXJlczogdXNlci5lbWFpbE1GQVRva2VuRXhwaXJlcyxcblx0XHRcdGNyZWF0aW9uRGF0ZTogdXNlci5jcmVhdGlvbkRhdGUsXG5cdFx0XHRjb21wYXJlUGFzc3dvcmQ6IGFzeW5jIChcblx0XHRcdFx0cGFzc3dvcmQ6IHN0cmluZyxcblx0XHRcdFx0YXJnb24yOiB0eXBlb2YgaW1wb3J0KCdhcmdvbjInKVxuXHRcdFx0KTogUHJvbWlzZTxib29sZWFuPiA9PiB7XG5cdFx0XHRcdHJldHVybiBhd2FpdCBhcmdvbjIudmVyaWZ5KFxuXHRcdFx0XHRcdHVzZXIucGFzc3dvcmQsXG5cdFx0XHRcdFx0cGFzc3dvcmQgKyBwcm9jZXNzLmVudi5QRVBQRVJcblx0XHRcdFx0KTtcblx0XHRcdH0sXG5cdFx0XHRzYXZlOiBhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XG5cdFx0XHRcdGF3YWl0IHVzZXIuc2F2ZSgpO1xuXHRcdFx0fVxuXHRcdH07XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgZmluZE9uZShcblx0XHRjcml0ZXJpYTogV2hlcmVPcHRpb25zPEluZmVyQXR0cmlidXRlczxVc2VyPj5cblx0KTogUHJvbWlzZTxVc2VySW5zdGFuY2VJbnRlcmZhY2UgfCBudWxsPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbC5maW5kT25lKHsgd2hlcmU6IGNyaXRlcmlhIH0pO1xuXHRcdFx0aWYgKCF1c2VyKSB7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmRlYnVnKCdVc2VyIG5vdCBmb3VuZCB3aXRoIHByb3ZpZGVkIGNyaXRlcmlhJyk7XG5cblx0XHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiB0aGlzLm1hcFRvVXNlckluc3RhbmNlKHVzZXIpO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7IGVycm9yLCBhY3Rpb246ICdmaW5kT25lJyB9KTtcblx0XHRcdHJldHVybiBudWxsO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBmaW5kVXNlckJ5SWQoXG5cdFx0dXNlcklkOiBzdHJpbmdcblx0KTogUHJvbWlzZTxVc2VySW5zdGFuY2VJbnRlcmZhY2UgfCBudWxsPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbC5maW5kT25lKHtcblx0XHRcdFx0d2hlcmU6IHsgaWQ6IHVzZXJJZCB9XG5cdFx0XHR9KTtcblxuXHRcdFx0aWYgKCF1c2VyKSB7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLndhcm4oYFVzZXIgd2l0aCBJRCAke3VzZXJJZH0gbm90IGZvdW5kYCk7XG5cdFx0XHRcdHJldHVybiBudWxsO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gdGhpcy5tYXBUb1VzZXJJbnN0YW5jZSh1c2VyKTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5sb2dnZXIuZXJyb3IoYEVycm9yIGZpbmRpbmcgdXNlciBieSBJRCAke3VzZXJJZH06ICR7ZXJyb3J9YCk7XG5cdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7IGVycm9yLCBhY3Rpb246ICdmaW5kVXNlckJ5SWQnIH0pO1xuXHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIGZpbmRVc2VyQnlFbWFpbChcblx0XHRlbWFpbDogc3RyaW5nXG5cdCk6IFByb21pc2U8VXNlckluc3RhbmNlSW50ZXJmYWNlIHwgbnVsbD4ge1xuXHRcdGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbC5maW5kT25lKHsgd2hlcmU6IHsgZW1haWwgfSB9KTtcblx0XHRpZiAoIXVzZXIpIHtcblx0XHRcdHJldHVybiBudWxsO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLm1hcFRvVXNlckluc3RhbmNlKHVzZXIpO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGNyZWF0ZVVzZXIoXG5cdFx0dXNlckRldGFpbHM6IE9taXQ8XG5cdFx0XHRVc2VyQXR0cmlidXRlc0ludGVyZmFjZSxcblx0XHRcdCdpZCcgfCAnY3JlYXRpb25EYXRlJyB8ICd1c2VySWQnXG5cdFx0PlxuXHQpOiBQcm9taXNlPFVzZXJJbnN0YW5jZUludGVyZmFjZSB8IG51bGw+IHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgaXNQYXNzd29yZFN0cm9uZyA9IGF3YWl0IHRoaXMuY2hlY2tQYXNzd29yZFN0cmVuZ3RoKFxuXHRcdFx0XHR1c2VyRGV0YWlscy5wYXNzd29yZFxuXHRcdFx0KTtcblxuXHRcdFx0aWYgKCFpc1Bhc3N3b3JkU3Ryb25nKSB7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLndhcm4oJ1Bhc3N3b3JkIHN0cmVuZ3RoIHZhbGlkYXRpb24gZmFpbGVkJyk7XG5cdFx0XHRcdHRocm93IG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuUGFzc3dvcmRWYWxpZGF0aW9uRXJyb3IoXG5cdFx0XHRcdFx0J1Bhc3N3b3JkIGRvZXMgbm90IG1lZXQgc3RyZW5ndGggcmVxdWlyZW1lbnRzJyxcblx0XHRcdFx0XHR7IGV4cG9zZVRvQ2xpZW50OiB0cnVlIH1cblx0XHRcdFx0KTtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgcGVwcGVyID0gdGhpcy52YXVsdC5yZXRyaWV2ZVNlY3JldChcblx0XHRcdFx0J1BFUFBFUicsXG5cdFx0XHRcdHNlY3JldCA9PiBzZWNyZXRcblx0XHRcdCk7XG5cblx0XHRcdGlmICghcGVwcGVyIHx8IHR5cGVvZiBwZXBwZXIgIT09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdHRocm93IG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuU2VydmljZVVuYXZhaWxhYmxlRXJyb3IoXG5cdFx0XHRcdFx0MTAsXG5cdFx0XHRcdFx0J0ludmFsaWQgcGVwcGVyJyxcblx0XHRcdFx0XHR7IGV4cG9zZVRvQ2xpZW50OiBmYWxzZSB9XG5cdFx0XHRcdCk7XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IGhhc2hlZFBhc3N3b3JkID0gYXdhaXQgdGhpcy5wYXNzd29yZFNlcnZpY2UuaGFzaFBhc3N3b3JkKFxuXHRcdFx0XHR1c2VyRGV0YWlscy5wYXNzd29yZCxcblx0XHRcdFx0cGVwcGVyXG5cdFx0XHQpO1xuXHRcdFx0Y29uc3QgdXNlclV1aWQgPSBhd2FpdCB0aGlzLmxvYWRVdWlkdjQoKTtcblx0XHRcdGNvbnN0IG5ld1VzZXIgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbC5jcmVhdGUoe1xuXHRcdFx0XHRpZDogdXNlclV1aWQsXG5cdFx0XHRcdC4uLnVzZXJEZXRhaWxzLFxuXHRcdFx0XHRwYXNzd29yZDogaGFzaGVkUGFzc3dvcmQsXG5cdFx0XHRcdGlzVmVyaWZpZWQ6IGZhbHNlLFxuXHRcdFx0XHRyZXNldFBhc3N3b3JkVG9rZW46IG51bGwsXG5cdFx0XHRcdHJlc2V0UGFzc3dvcmRFeHBpcmVzOiBudWxsLFxuXHRcdFx0XHRjcmVhdGlvbkRhdGU6IG5ldyBEYXRlKClcblx0XHRcdH0pO1xuXG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKGBVc2VyICR7bmV3VXNlci51c2VybmFtZX0gY3JlYXRlZCBzdWNjZXNzZnVsbHlgKTtcblx0XHRcdGF3YWl0IHRoaXMuc2VuZENvbmZpcm1hdGlvbkVtYWlsKG5ld1VzZXIpO1xuXG5cdFx0XHRyZXR1cm4gdGhpcy5tYXBUb1VzZXJJbnN0YW5jZShuZXdVc2VyKTtcblx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdHRoaXMubG9nZ2VyLmVycm9yKGBFcnJvciBjcmVhdGluZyB1c2VyOiAke1N0cmluZyhlcnIpfWApO1xuXHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3Ioe1xuXHRcdFx0XHRlcnJvcjogZXJyIHx8ICdVc2VyIGNyZWF0aW9uIGZhaWxlZCdcblx0XHRcdH0pO1xuXHRcdFx0dGhyb3cgZXJyO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgY2hlY2tQYXNzd29yZFN0cmVuZ3RoKHBhc3N3b3JkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcblx0XHRjb25zdCB6eGN2Ym4gPSBhd2FpdCB0aGlzLmxvYWRaeGN2Ym4oKTtcblx0XHRjb25zdCB7IHNjb3JlIH0gPSB6eGN2Ym4ocGFzc3dvcmQpO1xuXG5cdFx0aWYgKHNjb3JlIDwgMykge1xuXHRcdFx0dGhpcy5sb2dnZXIud2FybignUGFzc3dvcmQgc3RyZW5ndGggdG9vIHdlYWsnKTtcblx0XHRcdHJldHVybiBmYWxzZTtcblx0XHR9XG5cblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgYXhpb3MgPSBhd2FpdCB0aGlzLmxvYWRBeGlvcygpO1xuXHRcdFx0Y29uc3QgZmlyc3RGaXZlQ2hhcnMgPSBwYXNzd29yZC5zdWJzdHJpbmcoMCwgNSk7XG5cdFx0XHRjb25zdCByZW1haW5pbmdDaGFycyA9IHBhc3N3b3JkLnN1YnN0cmluZyg1KS50b1VwcGVyQ2FzZSgpO1xuXG5cdFx0XHRjb25zdCBwd25lZFJlc3BvbnNlID0gYXdhaXQgYXhpb3MuZ2V0PHN0cmluZz4oXG5cdFx0XHRcdGBodHRwczovL2FwaS5wd25lZHBhc3N3b3Jkcy5jb20vcmFuZ2UvJHtmaXJzdEZpdmVDaGFyc31gXG5cdFx0XHQpO1xuXG5cdFx0XHRjb25zdCBwd25lZExpc3QgPSBwd25lZFJlc3BvbnNlLmRhdGFcblx0XHRcdFx0LnNwbGl0KCdcXG4nKVxuXHRcdFx0XHQubWFwKChsaW5lOiBzdHJpbmcpID0+IGxpbmUuc3BsaXQoJzonKVswXSk7XG5cblx0XHRcdGlmIChwd25lZExpc3QuaW5jbHVkZXMocmVtYWluaW5nQ2hhcnMpKSB7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLndhcm4oJ1Bhc3N3b3JkIGZvdW5kIGluIGJyZWFjaCcpO1xuXHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHR9XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMubG9nZ2VyLmVycm9yKFxuXHRcdFx0XHRgRXJyb3IgY2hlY2tpbmcgcGFzc3dvcmQgYnJlYWNoIHN0YXR1czogJHtTdHJpbmcoZXJyb3IpfWBcblx0XHRcdCk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRydWU7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgdmVyaWZ5VXNlckFjY291bnQodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgdXNlciA9IGF3YWl0IHRoaXMudXNlck1vZGVsLmZpbmRPbmUoe1xuXHRcdFx0XHR3aGVyZTogeyBpZDogdXNlcklkIH1cblx0XHRcdH0pO1xuXG5cdFx0XHRpZiAoIXVzZXIpIHtcblx0XHRcdFx0dGhpcy5sb2dnZXIud2FybihgVXNlciB3aXRoIElEICR7dXNlcklkfSBub3QgZm91bmRgKTtcblx0XHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdFx0fVxuXG5cdFx0XHR1c2VyLmlzVmVyaWZpZWQgPSB0cnVlO1xuXHRcdFx0YXdhaXQgdXNlci5zYXZlKCk7XG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKGBVc2VyICR7dXNlci51c2VybmFtZX0gdmVyaWZpZWQgc3VjY2Vzc2Z1bGx5YCk7XG5cdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3Ioe1xuXHRcdFx0XHRlcnJvcixcblx0XHRcdFx0YWN0aW9uOiAndmVyaWZ5VXNlckFjY291bnQnLFxuXHRcdFx0XHRkZXRhaWxzOiB7IHVzZXJJZCB9XG5cdFx0XHR9KTtcblxuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgcmVtb3ZlVW5kZWZpbmVkRmllbGRzPFQ+KG9iajogUGFydGlhbDxUPik6IFBhcnRpYWw8VD4ge1xuXHRcdHJldHVybiBPYmplY3QuZnJvbUVudHJpZXMoXG5cdFx0XHRPYmplY3QuZW50cmllcyhvYmopLmZpbHRlcigoWywgdl0pID0+IHYgIT09IHVuZGVmaW5lZClcblx0XHQpIGFzIFBhcnRpYWw8VD47XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgdXBkYXRlVXNlcihcblx0XHR1c2VyOiBVc2VySW5zdGFuY2VJbnRlcmZhY2UsXG5cdFx0dXBkYXRlZERldGFpbHM6IFBhcnRpYWw8VXNlckluc3RhbmNlSW50ZXJmYWNlPlxuXHQpOiBQcm9taXNlPFVzZXJJbnN0YW5jZUludGVyZmFjZSB8IG51bGw+IHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgZnVsbFVzZXIgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbC5maW5kT25lKHtcblx0XHRcdFx0d2hlcmU6IHsgaWQ6IHVzZXIuaWQgfVxuXHRcdFx0fSk7XG5cblx0XHRcdGlmICghZnVsbFVzZXIpIHtcblx0XHRcdFx0dGhpcy5sb2dnZXIud2FybihgVXNlciB3aXRoIGlkICR7dXNlci5pZH0gbm90IGZvdW5kYCk7XG5cdFx0XHRcdHJldHVybiBudWxsO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCBwZXBwZXIgPSB0aGlzLnZhdWx0LnJldHJpZXZlU2VjcmV0KFxuXHRcdFx0XHQnUEVQUEVSJyxcblx0XHRcdFx0c2VjcmV0ID0+IHNlY3JldFxuXHRcdFx0KTtcblxuXHRcdFx0aWYgKCFwZXBwZXIgfHwgdHlwZW9mIHBlcHBlciAhPT0gJ3N0cmluZycpIHtcblx0XHRcdFx0dGhyb3cgbmV3IHRoaXMuZXJyb3JIYW5kbGVyLkVycm9yQ2xhc3Nlcy5TZXJ2aWNlVW5hdmFpbGFibGVFcnJvcihcblx0XHRcdFx0XHQxMCxcblx0XHRcdFx0XHQnSW52YWxpZCBwZXBwZXInLFxuXHRcdFx0XHRcdHsgZXhwb3NlVG9DbGllbnQ6IGZhbHNlIH1cblx0XHRcdFx0KTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKHVwZGF0ZWREZXRhaWxzLnBhc3N3b3JkKSB7XG5cdFx0XHRcdGNvbnN0IGhhc2hlZFBhc3N3b3JkID0gYXdhaXQgdGhpcy5wYXNzd29yZFNlcnZpY2UuaGFzaFBhc3N3b3JkKFxuXHRcdFx0XHRcdHVwZGF0ZWREZXRhaWxzLnBhc3N3b3JkLFxuXHRcdFx0XHRcdHBlcHBlclxuXHRcdFx0XHQpO1xuXHRcdFx0XHR1cGRhdGVkRGV0YWlscy5wYXNzd29yZCA9IGhhc2hlZFBhc3N3b3JkO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCBjbGVhblVwZGF0ZWREZXRhaWxzID1cblx0XHRcdFx0dGhpcy5yZW1vdmVVbmRlZmluZWRGaWVsZHModXBkYXRlZERldGFpbHMpO1xuXHRcdFx0Y29uc3QgdXBkYXRlRGF0YTogUGFydGlhbDxJbmZlckF0dHJpYnV0ZXM8VXNlcj4+ID1cblx0XHRcdFx0Y2xlYW5VcGRhdGVkRGV0YWlscyBhcyBQYXJ0aWFsPEluZmVyQXR0cmlidXRlczxVc2VyPj47XG5cdFx0XHRjb25zdCB1cGRhdGVkVXNlciA9IGF3YWl0IGZ1bGxVc2VyLnVwZGF0ZSh1cGRhdGVEYXRhKTtcblxuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0YFVzZXIgJHt1cGRhdGVkVXNlci51c2VybmFtZX0gdXBkYXRlZCBzdWNjZXNzZnVsbHlgXG5cdFx0XHQpO1xuXG5cdFx0XHRyZXR1cm4gdGhpcy5tYXBUb1VzZXJJbnN0YW5jZSh1cGRhdGVkVXNlcik7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nRXJyb3IoYEVycm9yIHVwZGF0aW5nIHVzZXI6ICR7U3RyaW5nKGVycm9yKX1gKTtcblx0XHRcdHRoaXMuZXJyb3JIYW5kbGVyLmhhbmRsZUVycm9yKHsgZXJyb3IgfSk7XG5cdFx0XHRyZXR1cm4gbnVsbDtcblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIHNlbmRDb25maXJtYXRpb25FbWFpbCh1c2VyOiBVc2VyKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IGp3dFNlY3JldCA9IHRoaXMudmF1bHQucmV0cmlldmVTZWNyZXQoXG5cdFx0XHRcdCdKV1RfU0VDUkVUJyxcblx0XHRcdFx0c2VjcmV0ID0+IHNlY3JldFxuXHRcdFx0KTtcblxuXHRcdFx0aWYgKHR5cGVvZiBqd3RTZWNyZXQgIT09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdHRocm93IG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuU2VydmljZVVuYXZhaWxhYmxlRXJyb3IoXG5cdFx0XHRcdFx0MTAsXG5cdFx0XHRcdFx0J0ludmFsaWQgSldUIHNlY3JldCcsXG5cdFx0XHRcdFx0eyBleHBvc2VUb0NsaWVudDogZmFsc2UgfVxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCBqd3QgPSBhd2FpdCB0aGlzLmxvYWRKd3QoKTtcblx0XHRcdGNvbnN0IGNvbmZpcm1hdGlvblRva2VuID0gand0LnNpZ24oeyBpZDogdXNlci5pZCB9LCBqd3RTZWNyZXQsIHtcblx0XHRcdFx0ZXhwaXJlc0luOiAnMWQnXG5cdFx0XHR9KTtcblxuXHRcdFx0Y29uc3QgYmFzZVVybCA9IHRoaXMuZW52Q29uZmlnLmdldEVudlZhcmlhYmxlKCdiYXNlVXJsJyk7XG5cdFx0XHRjb25zdCBwb3J0ID0gdGhpcy5lbnZDb25maWcuZ2V0RW52VmFyaWFibGUoJ3NlcnZlclBvcnQnKTtcblx0XHRcdGNvbnN0IGNvbmZpcm1hdGlvblVybCA9IGAke2Jhc2VVcmx9JHtwb3J0fS9hcGkvdXNlcnMvY29uZmlybS8ke2NvbmZpcm1hdGlvblRva2VufWA7XG5cblx0XHRcdGNvbnN0IG1haWxPcHRpb25zID0ge1xuXHRcdFx0XHRmcm9tOiB0aGlzLmVudkNvbmZpZy5nZXRFbnZWYXJpYWJsZSgnZW1haWxVc2VyJyksXG5cdFx0XHRcdHRvOiB1c2VyLmVtYWlsLFxuXHRcdFx0XHRzdWJqZWN0OiAnUGxlYXNlIENvbmZpcm0gWW91ciBBY2NvdW50Jyxcblx0XHRcdFx0aHRtbDogYFxuXHRcdFx0XHRcdDxwPkhpICR7dXNlci51c2VybmFtZX0sPC9wPlxuXHRcdFx0XHRcdDxwPlBsZWFzZSBjb25maXJtIHlvdXIgYWNjb3VudCBieSBjbGlja2luZyB0aGUgZm9sbG93aW5nIGxpbms6PC9wPlxuXHRcdFx0XHRcdDxhIGhyZWY9XCIke2NvbmZpcm1hdGlvblVybH1cIj5Db25maXJtIEFjY291bnQ8L2E+XG5cdFx0XHRcdGBcblx0XHRcdH07XG5cblx0XHRcdGNvbnN0IHRyYW5zcG9ydGVyID0gYXdhaXQgdGhpcy5tYWlsZXIuZ2V0VHJhbnNwb3J0ZXIoKTtcblx0XHRcdGF3YWl0IHRyYW5zcG9ydGVyLnNlbmRNYWlsKG1haWxPcHRpb25zKTtcblxuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhgQ29uZmlybWF0aW9uIGVtYWlsIHNlbnQgdG8gJHt1c2VyLmVtYWlsfWApO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5sb2dFcnJvcihcblx0XHRcdFx0YEVycm9yIHNlbmRpbmcgY29uZmlybWF0aW9uIGVtYWlsIHRvICR7dXNlci5lbWFpbH1gXG5cdFx0XHQpO1xuXHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3Ioe1xuXHRcdFx0XHRlcnJvcixcblx0XHRcdFx0ZGV0YWlsczogeyB1c2VySWQ6IHVzZXIuaWQgfVxuXHRcdFx0fSk7XG5cdFx0XHR0aHJvdyBlcnJvcjtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgZGVsZXRlVXNlcih1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCB1c2VyID0gYXdhaXQgdGhpcy51c2VyTW9kZWwuZmluZE9uZSh7XG5cdFx0XHRcdHdoZXJlOiB7IGlkOiB1c2VySWQgfVxuXHRcdFx0fSk7XG5cblx0XHRcdGlmICghdXNlcikge1xuXHRcdFx0XHR0aGlzLmxvZ2dlci53YXJuKGBVc2VyIHdpdGggaWQgJHt1c2VySWR9IG5vdCBmb3VuZGApO1xuXHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHR9XG5cblx0XHRcdGF3YWl0IHVzZXIuZGVzdHJveSgpO1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhgVXNlciB3aXRoIGlkICR7dXNlcklkfSBkZWxldGVkIHN1Y2Nlc3NmdWxseWApO1xuXHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nRXJyb3IoXG5cdFx0XHRcdGBFcnJvciBkZWxldGluZyB1c2VyIHdpdGggaWQgJHt1c2VySWR9XFxuJHtTdHJpbmcoZXJyb3IpfWBcblx0XHRcdCk7XG5cdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7XG5cdFx0XHRcdGVycm9yLFxuXHRcdFx0XHRkZXRhaWxzOiB7IHVzZXJJZCB9XG5cdFx0XHR9KTtcblx0XHRcdHJldHVybiBmYWxzZTtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgc2h1dGRvd24oKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ1NodXR0aW5nIGRvd24gVXNlckNvbnRyb2xsZXIuLi4nKTtcblxuXHRcdFx0VXNlckNvbnRyb2xsZXIuaW5zdGFuY2UgPSBudWxsO1xuXG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdVc2VyQ29udHJvbGxlciBzaHV0ZG93biBjb21wbGV0ZWQuJyk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdGNvbnN0IHV0aWxpdHlFcnJvciA9XG5cdFx0XHRcdG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuVXRpbGl0eUVycm9yUmVjb3ZlcmFibGUoXG5cdFx0XHRcdFx0YEVycm9yIGR1cmluZyBVc2VyQ29udHJvbGxlciBzaHV0ZG93bjogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yfWBcblx0XHRcdFx0KTtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nRXJyb3IodXRpbGl0eUVycm9yLm1lc3NhZ2UpO1xuXHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3IoeyBlcnJvcjogdXRpbGl0eUVycm9yIH0pO1xuXHRcdH1cblx0fVxuXG5cdHByb3RlY3RlZCBhc3luYyBsb2FkQXhpb3MoKTogUHJvbWlzZTxVc2VyQ29udHJvbGxlckRlcHNbJ2F4aW9zJ10+IHtcblx0XHRyZXR1cm4gKGF3YWl0IGltcG9ydCgnYXhpb3MnKSkuZGVmYXVsdDtcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgbG9hZEp3dCgpOiBQcm9taXNlPFVzZXJDb250cm9sbGVyRGVwc1snand0J10+IHtcblx0XHRyZXR1cm4gKGF3YWl0IGltcG9ydCgnanNvbndlYnRva2VuJykpLmRlZmF1bHQ7XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIGxvYWRVdWlkdjQoKTogUHJvbWlzZTxzdHJpbmc+IHtcblx0XHRjb25zdCB7IHY0OiB1dWlkdjQgfSA9IGF3YWl0IGltcG9ydCgndXVpZCcpO1xuXHRcdHJldHVybiB1dWlkdjQoKTtcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgbG9hZFp4Y3ZibigpOiBQcm9taXNlPFVzZXJDb250cm9sbGVyRGVwc1snenhjdmJuJ10+IHtcblx0XHRyZXR1cm4gKGF3YWl0IGltcG9ydCgnenhjdmJuJykpLmRlZmF1bHQ7XG5cdH1cbn1cbiJdfQ==
