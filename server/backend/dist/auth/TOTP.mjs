import speakeasy from 'speakeasy';
import QRCode from 'qrcode';
import { serviceTTLConfig } from '../config/cache.mjs';
import { LoggerServiceFactory } from '../index/factory/subfactories/LoggerServiceFactory.mjs';
import { ErrorHandlerServiceFactory } from '../index/factory/subfactories/ErrorHandlerServiceFactory.mjs';
import { CacheLayerServiceFactory } from '../index/factory/subfactories/CacheLayerServiceFactory.mjs';
export class TOTPService {
	static instance = null;
	logger;
	errorLogger;
	errorHandler;
	cacheService;
	ttl;
	constructor(logger, errorLogger, errorHandler, cacheService) {
		this.logger = logger;
		this.errorLogger = errorLogger;
		this.errorHandler = errorHandler;
		this.cacheService = cacheService;
		this.ttl = serviceTTLConfig.TOTPService || serviceTTLConfig.default;
	}
	static async getInstance() {
		if (!TOTPService.instance) {
			const logger = await LoggerServiceFactory.getLoggerService();
			const errorLogger =
				await LoggerServiceFactory.getErrorLoggerService();
			const errorHandler =
				await ErrorHandlerServiceFactory.getErrorHandlerService();
			const cacheService =
				await CacheLayerServiceFactory.getCacheService();
			TOTPService.instance = new TOTPService(
				logger,
				errorLogger,
				errorHandler,
				cacheService
			);
		}
		return TOTPService.instance;
	}
	generateTOTPSecret(length = 20) {
		try {
			this.logger.debug('Generating TOTP secret.');
			const totpSecret = speakeasy.generateSecret({ length });
			this.logger.debug('TOTP secret generated successfully.');
			return {
				ascii: totpSecret.ascii || '',
				hex: totpSecret.hex || '',
				base32: totpSecret.base32 || '',
				otpauth_url: totpSecret.otpauth_url || ''
			};
		} catch (utilError) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Failed to generate TOTP secret: ${utilError instanceof Error ? utilError.message : utilError}`,
					{ exposeToClient: false }
				);
			this.errorLogger.logWarn(utilityError.message);
			this.errorHandler.handleError({ error: utilityError });
			return {
				ascii: '',
				hex: '',
				base32: '',
				otpauth_url: ''
			};
		}
	}
	async generateTOTPToken(secret) {
		try {
			const cacheKey = `totpToken:${secret}`;
			const cachedToken = await this.cacheService.get(cacheKey, 'auth');
			if (cachedToken) {
				this.logger.debug('Returning cached TOTP token.');
				return cachedToken;
			}
			this.logger.debug('Generating new TOTP token.');
			const totpToken = speakeasy.totp({
				secret,
				encoding: 'base32'
			});
			await this.cacheService.set(cacheKey, totpToken, 'auth', this.ttl);
			this.logger.debug('TOTP token generated and cached successfully.');
			return totpToken;
		} catch (utilError) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Failed to generate TOTP token: ${utilError instanceof Error ? utilError.message : utilError}`,
					{ exposeToClient: false }
				);
			this.errorLogger.logWarn(utilityError.message);
			this.errorHandler.handleError({ error: utilityError });
			return '';
		}
	}
	verifyTOTPToken(secret, token, window = 1) {
		try {
			this.logger.debug('Verifying TOTP token.');
			const isTOTPTokenValid = speakeasy.totp.verify({
				secret,
				encoding: 'base32',
				token,
				window
			});
			this.logger.debug(
				`TOTP token verification ${isTOTPTokenValid ? 'succeeded' : 'failed'}.`
			);
			return isTOTPTokenValid;
		} catch (utilError) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Failed to verify TOTP token: ${utilError instanceof Error ? utilError.message : utilError}`,
					{ exposeToClient: false }
				);
			this.errorLogger.logWarn(utilityError.message);
			this.errorHandler.handleError({ error: utilityError });
			return false;
		}
	}
	async generateQRCode(otpauth_url) {
		try {
			this.logger.debug(
				`Generating QR code for TOTP with URL: ${otpauth_url}`
			);
			const qrCode = await QRCode.toDataURL(otpauth_url);
			this.logger.debug('QR code generated successfully.');
			return qrCode;
		} catch (utilError) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Failed to generate QR code for URL ${otpauth_url}: ${utilError instanceof Error ? utilError.message : utilError}`,
					{ exposeToClient: false }
				);
			this.errorLogger.logWarn(utilityError.message);
			this.errorHandler.handleError({ error: utilityError });
			return '';
		}
	}
	async shutdown() {
		try {
			this.logger.info('Shutting down TOTPService...');
			this.logger.info('Clearing TOTPService cache...');
			await this.cacheService.clearNamespace('TOTPService');
			this.logger.info('TOTPService cache cleared successfully.');
			TOTPService.instance = null;
			this.logger.info('TOTPService shutdown completed successfully.');
		} catch (error) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Error during TOTPService shutdown: ${error instanceof Error ? error.message : error}`
				);
			this.errorLogger.logError(utilityError.message);
			this.errorHandler.handleError({ error: utilityError });
		}
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVE9UUC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hdXRoL1RPVFAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBUUEsT0FBTyxTQUFTLE1BQU0sV0FBVyxDQUFDO0FBQ2xDLE9BQU8sTUFBTSxNQUFNLFFBQVEsQ0FBQztBQUM1QixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxvREFBb0QsQ0FBQztBQUMxRixPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSwwREFBMEQsQ0FBQztBQUN0RyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSx3REFBd0QsQ0FBQztBQUVsRyxNQUFNLE9BQU8sV0FBVztJQUNmLE1BQU0sQ0FBQyxRQUFRLEdBQXVCLElBQUksQ0FBQztJQUMzQyxNQUFNLENBQTRCO0lBQ2xDLFdBQVcsQ0FBOEI7SUFDekMsWUFBWSxDQUErQjtJQUMzQyxZQUFZLENBQXdCO0lBRXBDLEdBQUcsQ0FBUztJQUVwQixZQUNDLE1BQWlDLEVBQ2pDLFdBQXdDLEVBQ3hDLFlBQTBDLEVBQzFDLFlBQW1DO1FBRW5DLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQy9CLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxHQUFHLEdBQUcsZ0JBQWdCLENBQUMsV0FBVyxJQUFJLGdCQUFnQixDQUFDLE9BQU8sQ0FBQztJQUNyRSxDQUFDO0lBRU0sTUFBTSxDQUFDLEtBQUssQ0FBQyxXQUFXO1FBQzlCLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDM0IsTUFBTSxNQUFNLEdBQUcsTUFBTSxvQkFBb0IsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQzdELE1B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SyxDQUFDLFFBQVE7UUFDcEIsSUFBSSxDQUFDO1lBQ0osSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsOEJBQThCLENBQUMsQ0FBQztZQUVqRCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO1lBQ2xELE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDdEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMseUNBQXlDLENBQUMsQ0FBQztZQUU1RCxXQUFXLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztZQUU1QixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyw4Q0FBOEMsQ0FBQyxDQUFDO1FBQ2xFLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2hCLE1BQU0sWUFBWSxHQUNqQixJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLHVCQUF1QixDQUN6RCxzQ0FBc0MsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQ3RGLENBQUM7WUFDSCxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDaEQsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQztRQUN4RCxDQUFDO0lBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG5cdEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdENhY2hlU2VydmljZUludGVyZmFjZSxcblx0RXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZSxcblx0RXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRUT1RQU2VjcmV0SW50ZXJmYWNlLFxuXHRUT1RQU2VydmljZUludGVyZmFjZVxufSBmcm9tICcuLi9pbmRleC9pbnRlcmZhY2VzL21haW4nO1xuaW1wb3J0IHNwZWFrZWFzeSBmcm9tICdzcGVha2Vhc3knO1xuaW1wb3J0IFFSQ29kZSBmcm9tICdxcmNvZGUnO1xuaW1wb3J0IHsgc2VydmljZVRUTENvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy9jYWNoZSc7XG5pbXBvcnQgeyBMb2dnZXJTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4uL2luZGV4L2ZhY3Rvcnkvc3ViZmFjdG9yaWVzL0xvZ2dlclNlcnZpY2VGYWN0b3J5JztcbmltcG9ydCB7IEVycm9ySGFuZGxlclNlcnZpY2VGYWN0b3J5IH0gZnJvbSAnLi4vaW5kZXgvZmFjdG9yeS9zdWJmYWN0b3JpZXMvRXJyb3JIYW5kbGVyU2VydmljZUZhY3RvcnknO1xuaW1wb3J0IHsgQ2FjaGVMYXllclNlcnZpY2VGYWN0b3J5IH0gZnJvbSAnLi4vaW5kZXgvZmFjdG9yeS9zdWJmYWN0b3JpZXMvQ2FjaGVMYXllclNlcnZpY2VGYWN0b3J5JztcblxuZXhwb3J0IGNsYXNzIFRPVFBTZXJ2aWNlIGltcGxlbWVudHMgVE9UUFNlcnZpY2VJbnRlcmZhY2Uge1xuXHRwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTogVE9UUFNlcnZpY2UgfCBudWxsID0gbnVsbDtcblx0cHJpdmF0ZSBsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBlcnJvckhhbmRsZXI6IEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgY2FjaGVTZXJ2aWNlOiBDYWNoZVNlcnZpY2VJbnRlcmZhY2U7XG5cblx0cHJpdmF0ZSB0dGw6IG51bWJlcjtcblxuXHRwcml2YXRlIGNvbnN0cnVjdG9yKFxuXHRcdGxvZ2dlcjogQXBwTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0XHRlcnJvckxvZ2dlcjogRXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGVycm9ySGFuZGxlcjogRXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZSxcblx0XHRjYWNoZVNlcnZpY2U6IENhY2hlU2VydmljZUludGVyZmFjZVxuXHQpIHtcblx0XHR0aGlzLmxvZ2dlciA9IGxvZ2dlcjtcblx0XHR0aGlzLmVycm9yTG9nZ2VyID0gZXJyb3JMb2dnZXI7XG5cdFx0dGhpcy5lcnJvckhhbmRsZXIgPSBlcnJvckhhbmRsZXI7XG5cdFx0dGhpcy5jYWNoZVNlcnZpY2UgPSBjYWNoZVNlcnZpY2U7XG5cdFx0dGhpcy50dGwgPSBzZXJ2aWNlVFRMQ29uZmlnLlRPVFBTZXJ2aWNlIHx8IHNlcnZpY2VUVExDb25maWcuZGVmYXVsdDtcblx0fVxuXG5cdHB1YmxpYyBzdGF0aWMgYXN5bmMgZ2V0SW5zdGFuY2UoKTogUHJvbWlzZTxUT1RQU2VydmljZT4ge1xuXHRcdGlmICghVE9UUFNlcnZpY2UuaW5zdGFuY2UpIHtcblx0XHRcdGNvbnN0IGxvZ2dlciA9IGF3YWl0IExvZ2dlclNlcnZpY2VGYWN0b3J5LmdldExvZ2dlclNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGVycm9yTG9nZ2VyID1cblx0XHRcdFx0YXdhaXQgTG9nZ2VyU2VydmljZUZhY3RvcnkuZ2V0RXJyb3JMb2dnZXJTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBlcnJvckhhbmRsZXIgPVxuXHRcdFx0XHRhd2FpdCBFcnJvckhhbmRsZXJTZXJ2aWNlRmFjdG9yeS5nZXRFcnJvckhhbmRsZXJTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBjYWNoZVNlcnZpY2UgPVxuXHRcdFx0XHRhd2FpdCBDYWNoZUxheWVyU2VydmljZUZhY3RvcnkuZ2V0Q2FjaGVTZXJ2aWNlKCk7XG5cblx0XHRcdFRPVFBTZXJ2aWNlLmluc3RhbmNlID0gbmV3IFRPVFBTZXJ2aWNlKFxuXHRcdFx0XHRsb2dnZXIsXG5cdFx0XHRcdGVycm9yTG9nZ2VyLFxuXHRcdFx0XHRlcnJvckhhbmRsZXIsXG5cdFx0XHRcdGNhY2hlU2VydmljZVxuXHRcdFx0KTtcblx0XHR9XG5cblx0XHRyZXR1cm4gVE9UUFNlcnZpY2UuaW5zdGFuY2U7XG5cdH1cblxuXHRwdWJsaWMgZ2VuZXJhdGVUT1RQU2VjcmV0KGxlbmd0aCA9IDIwKTogVE9UUFNlY3JldEludGVyZmFjZSB7XG5cdFx0dHJ5IHtcblx0XHRcdHRoaXMubG9nZ2VyLmRlYnVnKCdHZW5lcmF0aW5nIFRPVFAgc2VjcmV0LicpO1xuXHRcdFx0Y29uc3QgdG90cFNlY3JldCA9IHNwZWFrZWFzeS5nZW5lcmF0ZVNlY3JldCh7IGxlbmd0aCB9KTtcblx0XHRcdHRoaXMubG9nZ2VyLmRlYnVnKCdUT1RQIHNlY3JldCBnZW5lcmF0ZWQgc3VjY2Vzc2Z1bGx5LicpO1xuXG5cdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRhc2NpaTogdG90cFNlY3JldC5hc2NpaSB8fCAnJyxcblx0XHRcdFx0aGV4OiB0b3RwU2VjcmV0LmhleCB8fCAnJyxcblx0XHRcdFx0YmFzZTMyOiB0b3RwU2VjcmV0LmJhc2UzMiB8fCAnJyxcblx0XHRcdFx0b3RwYXV0aF91cmw6IHRvdHBTZWNyZXQub3RwYXV0aF91cmwgfHwgJydcblx0XHRcdH07XG5cdFx0fSBjYXRjaCAodXRpbEVycm9yKSB7XG5cdFx0XHRjb25zdCB1dGlsaXR5RXJyb3IgPVxuXHRcdFx0XHRuZXcgdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JDbGFzc2VzLlV0aWxpdHlFcnJvclJlY292ZXJhYmxlKFxuXHRcdFx0XHRcdGBGYWlsZWQgdG8gZ2VuZXJhdGUgVE9UUCBzZWNyZXQ6ICR7dXRpbEVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyB1dGlsRXJyb3IubWVzc2FnZSA6IHV0aWxFcnJvcn1gLFxuXHRcdFx0XHRcdHsgZXhwb3NlVG9DbGllbnQ6IGZhbHNlIH1cblx0XHRcdFx0KTtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nV2Fybih1dGlsaXR5RXJyb3IubWVzc2FnZSk7XG5cdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7IGVycm9yOiB1dGlsaXR5RXJyb3IgfSk7XG5cdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRhc2NpaTogJycsXG5cdFx0XHRcdGhleDogJycsXG5cdFx0XHRcdGJhc2UzMjogJycsXG5cdFx0XHRcdG90cGF1dGhfdXJsOiAnJ1xuXHRcdFx0fTtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgZ2VuZXJhdGVUT1RQVG9rZW4oc2VjcmV0OiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCBjYWNoZUtleSA9IGB0b3RwVG9rZW46JHtzZWNyZXR9YDtcblx0XHRcdGNvbnN0IGNhY2hlZFRva2VuID0gYXdhaXQgdGhpcy5jYWNoZVNlcnZpY2UuZ2V0PHN0cmluZz4oXG5cdFx0XHRcdGNhY2hlS2V5LFxuXHRcdFx0XHQnYXV0aCdcblx0XHRcdCk7XG5cblx0XHRcdGlmIChjYWNoZWRUb2tlbikge1xuXHRcdFx0XHR0aGlzLmxvZ2dlci5kZWJ1ZygnUmV0dXJuaW5nIGNhY2hlZCBUT1RQIHRva2VuLicpO1xuXHRcdFx0XHRyZXR1cm4gY2FjaGVkVG9rZW47XG5cdFx0XHR9XG5cblx0XHRcdHRoaXMubG9nZ2VyLmRlYnVnKCdHZW5lcmF0aW5nIG5ldyBUT1RQIHRva2VuLicpO1xuXHRcdFx0Y29uc3QgdG90cFRva2VuID0gc3BlYWtlYXN5LnRvdHAoe1xuXHRcdFx0XHRzZWNyZXQsXG5cdFx0XHRcdGVuY29kaW5nOiAnYmFzZTMyJ1xuXHRcdFx0fSk7XG5cblx0XHRcdGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLnNldChjYWNoZUtleSwgdG90cFRva2VuLCAnYXV0aCcsIHRoaXMudHRsKTtcblxuXHRcdFx0dGhpcy5sb2dnZXIuZGVidWcoJ1RPVFAgdG9rZW4gZ2VuZXJhdGVkIGFuZCBjYWNoZWQgc3VjY2Vzc2Z1bGx5LicpO1xuXHRcdFx0cmV0dXJuIHRvdHBUb2tlbjtcblx0XHR9IGNhdGNoICh1dGlsRXJyb3IpIHtcblx0XHRcdGNvbnN0IHV0aWxpdHlFcnJvciA9XG5cdFx0XHRcdG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuVXRpbGl0eUVycm9yUmVjb3ZlcmFibGUoXG5cdFx0XHRcdFx0YEZhaWxlZCB0byBnZW5lcmF0ZSBUT1RQIHRva2VuOiAke3V0aWxFcnJvciBpbnN0YW5jZW9mIEVycm9yID8gdXRpbEVycm9yLm1lc3NhZ2UgOiB1dGlsRXJyb3J9YCxcblx0XHRcdFx0XHR7IGV4cG9zZVRvQ2xpZW50OiBmYWxzZSB9XG5cdFx0XHRcdCk7XG5cdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ1dhcm4odXRpbGl0eUVycm9yLm1lc3NhZ2UpO1xuXHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3IoeyBlcnJvcjogdXRpbGl0eUVycm9yIH0pO1xuXG5cdFx0XHRyZXR1cm4gJyc7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIHZlcmlmeVRPVFBUb2tlbihzZWNyZXQ6IHN0cmluZywgdG9rZW46IHN0cmluZywgd2luZG93ID0gMSk6IGJvb2xlYW4ge1xuXHRcdHRyeSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5kZWJ1ZygnVmVyaWZ5aW5nIFRPVFAgdG9rZW4uJyk7XG5cdFx0XHRjb25zdCBpc1RPVFBUb2tlblZhbGlkID0gc3BlYWtlYXN5LnRvdHAudmVyaWZ5KHtcblx0XHRcdFx0c2VjcmV0LFxuXHRcdFx0XHRlbmNvZGluZzogJ2Jhc2UzMicsXG5cdFx0XHRcdHRva2VuLFxuXHRcdFx0XHR3aW5kb3dcblx0XHRcdH0pO1xuXHRcdFx0dGhpcy5sb2dnZXIuZGVidWcoXG5cdFx0XHRcdGBUT1RQIHRva2VuIHZlcmlmaWNhdGlvbiAke2lzVE9UUFRva2VuVmFsaWQgPyAnc3VjY2VlZGVkJyA6ICdmYWlsZWQnfS5gXG5cdFx0XHQpO1xuXHRcdFx0cmV0dXJuIGlzVE9UUFRva2VuVmFsaWQ7XG5cdFx0fSBjYXRjaCAodXRpbEVycm9yKSB7XG5cdFx0XHRjb25zdCB1dGlsaXR5RXJyb3IgPVxuXHRcdFx0XHRuZXcgdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JDbGFzc2VzLlV0aWxpdHlFcnJvclJlY292ZXJhYmxlKFxuXHRcdFx0XHRcdGBGYWlsZWQgdG8gdmVyaWZ5IFRPVFAgdG9rZW46ICR7dXRpbEVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyB1dGlsRXJyb3IubWVzc2FnZSA6IHV0aWxFcnJvcn1gLFxuXHRcdFx0XHRcdHsgZXhwb3NlVG9DbGllbnQ6IGZhbHNlIH1cblx0XHRcdFx0KTtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nV2Fybih1dGlsaXR5RXJyb3IubWVzc2FnZSk7XG5cdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7IGVycm9yOiB1dGlsaXR5RXJyb3IgfSk7XG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIGdlbmVyYXRlUVJDb2RlKG90cGF1dGhfdXJsOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuXHRcdHRyeSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5kZWJ1Zyhcblx0XHRcdFx0YEdlbmVyYXRpbmcgUVIgY29kZSBmb3IgVE9UUCB3aXRoIFVSTDogJHtvdHBhdXRoX3VybH1gXG5cdFx0XHQpO1xuXHRcdFx0Y29uc3QgcXJDb2RlID0gYXdhaXQgUVJDb2RlLnRvRGF0YVVSTChvdHBhdXRoX3VybCk7XG5cdFx0XHR0aGlzLmxvZ2dlci5kZWJ1ZygnUVIgY29kZSBnZW5lcmF0ZWQgc3VjY2Vzc2Z1bGx5LicpO1xuXHRcdFx0cmV0dXJuIHFyQ29kZTtcblx0XHR9IGNhdGNoICh1dGlsRXJyb3IpIHtcblx0XHRcdGNvbnN0IHV0aWxpdHlFcnJvciA9XG5cdFx0XHRcdG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuVXRpbGl0eUVycm9yUmVjb3ZlcmFibGUoXG5cdFx0XHRcdFx0YEZhaWxlZCB0byBnZW5lcmF0ZSBRUiBjb2RlIGZvciBVUkwgJHtvdHBhdXRoX3VybH06ICR7dXRpbEVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyB1dGlsRXJyb3IubWVzc2FnZSA6IHV0aWxFcnJvcn1gLFxuXHRcdFx0XHRcdHsgZXhwb3NlVG9DbGllbnQ6IGZhbHNlIH1cblx0XHRcdFx0KTtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nV2Fybih1dGlsaXR5RXJyb3IubWVzc2FnZSk7XG5cdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7IGVycm9yOiB1dGlsaXR5RXJyb3IgfSk7XG5cdFx0XHRyZXR1cm4gJyc7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIHNodXRkb3duKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdHRyeSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdTaHV0dGluZyBkb3duIFRPVFBTZXJ2aWNlLi4uJyk7XG5cblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ0NsZWFyaW5nIFRPVFBTZXJ2aWNlIGNhY2hlLi4uJyk7XG5cdFx0XHRhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5jbGVhck5hbWVzcGFjZSgnVE9UUFNlcnZpY2UnKTtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ1RPVFBTZXJ2aWNlIGNhY2hlIGNsZWFyZWQgc3VjY2Vzc2Z1bGx5LicpO1xuXG5cdFx0XHRUT1RQU2VydmljZS5pbnN0YW5jZSA9IG51bGw7XG5cblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ1RPVFBTZXJ2aWNlIHNodXRkb3duIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkuJyk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdGNvbnN0IHV0aWxpdHlFcnJvciA9XG5cdFx0XHRcdG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuVXRpbGl0eUVycm9yUmVjb3ZlcmFibGUoXG5cdFx0XHRcdFx0YEVycm9yIGR1cmluZyBUT1RQU2VydmljZSBzaHV0ZG93bjogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yfWBcblx0XHRcdFx0KTtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nRXJyb3IodXRpbGl0eUVycm9yLm1lc3NhZ2UpO1xuXHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3IoeyBlcnJvcjogdXRpbGl0eUVycm9yIH0pO1xuXHRcdH1cblx0fVxufVxuIl19
