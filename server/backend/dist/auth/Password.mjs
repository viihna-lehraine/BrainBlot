import { hashConfig } from '../config/security.mjs';
import { validateDependencies } from '../utils/helpers.mjs';
import { LoggerServiceFactory } from '../index/factory/subfactories/LoggerServiceFactory.mjs';
import { ErrorHandlerServiceFactory } from '../index/factory/subfactories/ErrorHandlerServiceFactory.mjs';
import { VaultServiceFactory } from '../index/factory/subfactories/VaultServiceFactory.mjs';
export class PasswordService {
	static instance = null;
	logger;
	errorLogger;
	errorHandler;
	vault;
	constructor(logger, errorLogger, errorHandler, secrets) {
		this.logger = logger;
		this.errorLogger = errorLogger;
		this.errorHandler = errorHandler;
		this.vault = secrets;
	}
	static async getInstance() {
		if (!PasswordService.instance) {
			const logger = await LoggerServiceFactory.getLoggerService();
			const errorLogger =
				await LoggerServiceFactory.getErrorLoggerService();
			const errorHandler =
				await ErrorHandlerServiceFactory.getErrorHandlerService();
			const vault = await VaultServiceFactory.getVaultService();
			PasswordService.instance = new PasswordService(
				logger,
				errorLogger,
				errorHandler,
				vault
			);
		}
		return PasswordService.instance;
	}
	async hashPassword(password) {
		try {
			validateDependencies(
				[{ name: 'password', instance: password }],
				this.logger || console
			);
			const pepper = this.vault.retrieveSecret(
				'PEPPER',
				secret => secret
			);
			if (!pepper || typeof pepper !== 'string') {
				const hashConfigError =
					new this.errorHandler.ErrorClasses.ConfigurationError(
						`Unable to retrieve pepper from secrets. Password cannot be hashed.`,
						{ exposeToClient: false }
					);
				this.errorLogger.logError(hashConfigError.message);
				this.errorHandler.handleError({ error: hashConfigError });
				this.logger.error('Failed to retrieve pepper from secrets');
				throw hashConfigError;
			}
			return await (
				await import('argon2')
			).hash(password + pepper, hashConfig);
		} catch (hashUtilError) {
			const hashUtilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`${hashUtilError instanceof Error ? hashUtilError.message : hashUtilError}`
				);
			this.errorLogger.logError(hashUtilityError.message);
			this.errorHandler.handleError({ error: hashUtilityError });
			return '';
		} finally {
			this.logger.debug('Password hashed successfully');
		}
	}
	async comparePassword(storedPassword, providedPassword) {
		try {
			const pepper = this.vault.retrieveSecret(
				'PEPPER',
				secret => secret
			);
			if (!pepper || typeof pepper !== 'string') {
				this.logger.error(
					'Failed to retrieve pepper from secrets for password comparison'
				);
				throw new Error('Internal server error');
			}
			return await (
				await import('argon2')
			).verify(storedPassword, providedPassword + pepper);
		} catch (compareError) {
			this.errorHandler.handleError({
				error: compareError,
				action: 'comparePassword'
			});
			return false;
		}
	}
	async shutdown() {
		try {
			this.logger.info('Shutting down PasswordService...');
			PasswordService.instance = null;
			this.logger.info('PasswordService shutdown completed successfully');
		} catch (error) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Error during PasswordService shutdown: ${error instanceof Error ? error.message : error}`
				);
			this.errorLogger.logError(utilityError.message);
			this.errorHandler.handleError({ error: utilityError });
		}
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGFzc3dvcmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYXV0aC9QYXNzd29yZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFPQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDaEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDeEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sb0RBQW9ELENBQUM7QUFDMUYsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sMERBQTBELENBQUM7QUFDdEcsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbURBQW1ELENBQUM7QUFFeEYsTUFBTSxPQUFPLGVBQWU7SUFDbkIsTUFBTSxDQUFDLFFBQVEsR0FBMkIsSUFBSSxDQUFDO0lBQy9DLE1BQU0sQ0FBNEI7SUFDbEMsV0FBVyxDQUE4QjtJQUN6QyxZQUFZLENBQStCO0lBQzNDLEtBQUssQ0FBd0I7SUFFckMsWUFDQyxNQUFpQyxFQUNqQyxXQUF3QyxFQUN4QyxZQUEwQyxFQUMxQyxPQUE4QjtRQUU5QixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQztRQUMvQixJQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztRQUNqQyxJQUFJLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQztJQUN0QixDQUFDO0lBRU0sTUFBTSxDQUFDLEtBQUssQ0FBQyxXQUFXO1FBQzlCLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDL0IsTUFBTSxNQUFNLEdBQUcsTUFBTSxvQkFBb0IsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQzdELE1BQU0sV0FBVyxHQUNoQixNQUFNLG9CQUFvQixDQUFDLHFCQUFxQixFQUFFLENBQUM7WUFDcEQsTUFBTSxZQUFZLEdBQ2pCLE1BQU0sMEJBQTBCLENBQUMsc0JBQXNCLEVB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QWdCLEdBQUcsTUFBTSxDQUFDLENBQUM7UUFDckQsQ0FBQztRQUFDLE9BQU8sWUFBWSxFQUFFLENBQUM7WUFDdkIsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUM7Z0JBQzdCLEtBQUssRUFBRSxZQUFZO2dCQUNuQixNQUFNLEVBQUUsaUJBQWlCO2FBQ3pCLENBQUMsQ0FBQztZQUNILE9BQU8sS0FBSyxDQUFDO1FBQ2QsQ0FBQztJQUNGLENBQUM7SUFFTSxLQUFLLENBQUMsUUFBUTtRQUNwQixJQUFJLENBQUM7WUFDSixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO1lBRXJELGVBQWUsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1lBRWhDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGlEQUFpRCxDQUFDLENBQUM7UUFDckUsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDaEIsTUFBTSxZQUFZLEdBQ2pCLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsdUJBQXVCLENBQ3pELDBDQUEwQyxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FDMUYsQ0FBQztZQUNILElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNoRCxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO1FBQ3hELENBQUM7SUFDRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcblx0QXBwTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0RXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZSxcblx0RXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRQYXNzd29yZFNlcnZpY2VJbnRlcmZhY2UsXG5cdFZhdWx0U2VydmljZUludGVyZmFjZVxufSBmcm9tICcuLi9pbmRleC9pbnRlcmZhY2VzL21haW4nO1xuaW1wb3J0IHsgaGFzaENvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy9zZWN1cml0eSc7XG5pbXBvcnQgeyB2YWxpZGF0ZURlcGVuZGVuY2llcyB9IGZyb20gJy4uL3V0aWxzL2hlbHBlcnMnO1xuaW1wb3J0IHsgTG9nZ2VyU2VydmljZUZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5L3N1YmZhY3Rvcmllcy9Mb2dnZXJTZXJ2aWNlRmFjdG9yeSc7XG5pbXBvcnQgeyBFcnJvckhhbmRsZXJTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4uL2luZGV4L2ZhY3Rvcnkvc3ViZmFjdG9yaWVzL0Vycm9ySGFuZGxlclNlcnZpY2VGYWN0b3J5JztcbmltcG9ydCB7IFZhdWx0U2VydmljZUZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5L3N1YmZhY3Rvcmllcy9WYXVsdFNlcnZpY2VGYWN0b3J5JztcblxuZXhwb3J0IGNsYXNzIFBhc3N3b3JkU2VydmljZSBpbXBsZW1lbnRzIFBhc3N3b3JkU2VydmljZUludGVyZmFjZSB7XG5cdHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBQYXNzd29yZFNlcnZpY2UgfCBudWxsID0gbnVsbDtcblx0cHJpdmF0ZSBsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBlcnJvckhhbmRsZXI6IEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgdmF1bHQ6IFZhdWx0U2VydmljZUludGVyZmFjZTtcblxuXHRwcml2YXRlIGNvbnN0cnVjdG9yKFxuXHRcdGxvZ2dlcjogQXBwTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0XHRlcnJvckxvZ2dlcjogRXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGVycm9ySGFuZGxlcjogRXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZSxcblx0XHRzZWNyZXRzOiBWYXVsdFNlcnZpY2VJbnRlcmZhY2Vcblx0KSB7XG5cdFx0dGhpcy5sb2dnZXIgPSBsb2dnZXI7XG5cdFx0dGhpcy5lcnJvckxvZ2dlciA9IGVycm9yTG9nZ2VyO1xuXHRcdHRoaXMuZXJyb3JIYW5kbGVyID0gZXJyb3JIYW5kbGVyO1xuXHRcdHRoaXMudmF1bHQgPSBzZWNyZXRzO1xuXHR9XG5cblx0cHVibGljIHN0YXRpYyBhc3luYyBnZXRJbnN0YW5jZSgpOiBQcm9taXNlPFBhc3N3b3JkU2VydmljZT4ge1xuXHRcdGlmICghUGFzc3dvcmRTZXJ2aWNlLmluc3RhbmNlKSB7XG5cdFx0XHRjb25zdCBsb2dnZXIgPSBhd2FpdCBMb2dnZXJTZXJ2aWNlRmFjdG9yeS5nZXRMb2dnZXJTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBlcnJvckxvZ2dlciA9XG5cdFx0XHRcdGF3YWl0IExvZ2dlclNlcnZpY2VGYWN0b3J5LmdldEVycm9yTG9nZ2VyU2VydmljZSgpO1xuXHRcdFx0Y29uc3QgZXJyb3JIYW5kbGVyID1cblx0XHRcdFx0YXdhaXQgRXJyb3JIYW5kbGVyU2VydmljZUZhY3RvcnkuZ2V0RXJyb3JIYW5kbGVyU2VydmljZSgpO1xuXHRcdFx0Y29uc3QgdmF1bHQgPSBhd2FpdCBWYXVsdFNlcnZpY2VGYWN0b3J5LmdldFZhdWx0U2VydmljZSgpO1xuXG5cdFx0XHRQYXNzd29yZFNlcnZpY2UuaW5zdGFuY2UgPSBuZXcgUGFzc3dvcmRTZXJ2aWNlKFxuXHRcdFx0XHRsb2dnZXIsXG5cdFx0XHRcdGVycm9yTG9nZ2VyLFxuXHRcdFx0XHRlcnJvckhhbmRsZXIsXG5cdFx0XHRcdHZhdWx0XG5cdFx0XHQpO1xuXHRcdH1cblxuXHRcdHJldHVybiBQYXNzd29yZFNlcnZpY2UuaW5zdGFuY2U7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgaGFzaFBhc3N3b3JkKHBhc3N3b3JkOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuXHRcdHRyeSB7XG5cdFx0XHR2YWxpZGF0ZURlcGVuZGVuY2llcyhcblx0XHRcdFx0W3sgbmFtZTogJ3Bhc3N3b3JkJywgaW5zdGFuY2U6IHBhc3N3b3JkIH1dLFxuXHRcdFx0XHR0aGlzLmxvZ2dlciB8fCBjb25zb2xlXG5cdFx0XHQpO1xuXG5cdFx0XHRjb25zdCBwZXBwZXIgPSB0aGlzLnZhdWx0LnJldHJpZXZlU2VjcmV0KFxuXHRcdFx0XHQnUEVQUEVSJyxcblx0XHRcdFx0c2VjcmV0ID0+IHNlY3JldFxuXHRcdFx0KTtcblx0XHRcdGlmICghcGVwcGVyIHx8IHR5cGVvZiBwZXBwZXIgIT09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdGNvbnN0IGhhc2hDb25maWdFcnJvciA9XG5cdFx0XHRcdFx0bmV3IHRoaXMuZXJyb3JIYW5kbGVyLkVycm9yQ2xhc3Nlcy5Db25maWd1cmF0aW9uRXJyb3IoXG5cdFx0XHRcdFx0XHRgVW5hYmxlIHRvIHJldHJpZXZlIHBlcHBlciBmcm9tIHNlY3JldHMuIFBhc3N3b3JkIGNhbm5vdCBiZSBoYXNoZWQuYCxcblx0XHRcdFx0XHRcdHsgZXhwb3NlVG9DbGllbnQ6IGZhbHNlIH1cblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKGhhc2hDb25maWdFcnJvci5tZXNzYWdlKTtcblx0XHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3IoeyBlcnJvcjogaGFzaENvbmZpZ0Vycm9yIH0pO1xuXHRcdFx0XHR0aGlzLmxvZ2dlci5lcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIHBlcHBlciBmcm9tIHNlY3JldHMnKTtcblx0XHRcdFx0dGhyb3cgaGFzaENvbmZpZ0Vycm9yO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gYXdhaXQgKFxuXHRcdFx0XHRhd2FpdCBpbXBvcnQoJ2FyZ29uMicpXG5cdFx0XHQpLmhhc2gocGFzc3dvcmQgKyBwZXBwZXIsIGhhc2hDb25maWcpO1xuXHRcdH0gY2F0Y2ggKGhhc2hVdGlsRXJyb3IpIHtcblx0XHRcdGNvbnN0IGhhc2hVdGlsaXR5RXJyb3IgPVxuXHRcdFx0XHRuZXcgdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JDbGFzc2VzLlV0aWxpdHlFcnJvclJlY292ZXJhYmxlKFxuXHRcdFx0XHRcdGAke2hhc2hVdGlsRXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGhhc2hVdGlsRXJyb3IubWVzc2FnZSA6IGhhc2hVdGlsRXJyb3J9YFxuXHRcdFx0XHQpO1xuXHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcihoYXNoVXRpbGl0eUVycm9yLm1lc3NhZ2UpO1xuXHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3IoeyBlcnJvcjogaGFzaFV0aWxpdHlFcnJvciB9KTtcblx0XHRcdHJldHVybiAnJztcblx0XHR9IGZpbmFsbHkge1xuXHRcdFx0dGhpcy5sb2dnZXIuZGVidWcoJ1Bhc3N3b3JkIGhhc2hlZCBzdWNjZXNzZnVsbHknKTtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgY29tcGFyZVBhc3N3b3JkKFxuXHRcdHN0b3JlZFBhc3N3b3JkOiBzdHJpbmcsXG5cdFx0cHJvdmlkZWRQYXNzd29yZDogc3RyaW5nXG5cdCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCBwZXBwZXIgPSB0aGlzLnZhdWx0LnJldHJpZXZlU2VjcmV0KFxuXHRcdFx0XHQnUEVQUEVSJyxcblx0XHRcdFx0c2VjcmV0ID0+IHNlY3JldFxuXHRcdFx0KTtcblx0XHRcdGlmICghcGVwcGVyIHx8IHR5cGVvZiBwZXBwZXIgIT09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmVycm9yKFxuXHRcdFx0XHRcdCdGYWlsZWQgdG8gcmV0cmlldmUgcGVwcGVyIGZyb20gc2VjcmV0cyBmb3IgcGFzc3dvcmQgY29tcGFyaXNvbidcblx0XHRcdFx0KTtcblx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKCdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InKTtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIGF3YWl0IChcblx0XHRcdFx0YXdhaXQgaW1wb3J0KCdhcmdvbjInKVxuXHRcdFx0KS52ZXJpZnkoc3RvcmVkUGFzc3dvcmQsIHByb3ZpZGVkUGFzc3dvcmQgKyBwZXBwZXIpO1xuXHRcdH0gY2F0Y2ggKGNvbXBhcmVFcnJvcikge1xuXHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3Ioe1xuXHRcdFx0XHRlcnJvcjogY29tcGFyZUVycm9yLFxuXHRcdFx0XHRhY3Rpb246ICdjb21wYXJlUGFzc3dvcmQnXG5cdFx0XHR9KTtcblx0XHRcdHJldHVybiBmYWxzZTtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgc2h1dGRvd24oKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ1NodXR0aW5nIGRvd24gUGFzc3dvcmRTZXJ2aWNlLi4uJyk7XG5cblx0XHRcdFBhc3N3b3JkU2VydmljZS5pbnN0YW5jZSA9IG51bGw7XG5cblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ1Bhc3N3b3JkU2VydmljZSBzaHV0ZG93biBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5Jyk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdGNvbnN0IHV0aWxpdHlFcnJvciA9XG5cdFx0XHRcdG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuVXRpbGl0eUVycm9yUmVjb3ZlcmFibGUoXG5cdFx0XHRcdFx0YEVycm9yIGR1cmluZyBQYXNzd29yZFNlcnZpY2Ugc2h1dGRvd246ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcn1gXG5cdFx0XHRcdCk7XG5cdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKHV0aWxpdHlFcnJvci5tZXNzYWdlKTtcblx0XHRcdHRoaXMuZXJyb3JIYW5kbGVyLmhhbmRsZUVycm9yKHsgZXJyb3I6IHV0aWxpdHlFcnJvciB9KTtcblx0XHR9XG5cdH1cbn1cbiJdfQ==
