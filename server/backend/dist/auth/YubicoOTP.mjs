import { serviceTTLConfig } from '../config/cache.mjs';
import { LoggerServiceFactory } from '../index/factory/subfactories/LoggerServiceFactory.mjs';
import { ErrorHandlerServiceFactory } from '../index/factory/subfactories/ErrorHandlerServiceFactory.mjs';
import { CacheLayerServiceFactory } from '../index/factory/subfactories/CacheLayerServiceFactory.mjs';
import { EnvConfigServiceFactory } from '../index/factory/subfactories/EnvConfigServiceFactory.mjs';
import { VaultServiceFactory } from '../index/factory/subfactories/VaultServiceFactory.mjs';
export class YubicoOTPService {
	static instance = null;
	logger;
	errorLogger;
	errorHandler;
	envConfig;
	vault;
	cacheService;
	yubClient;
	ttl;
	yub;
	constructor(
		logger,
		errorLogger,
		errorHandler,
		envConfig,
		vault,
		cacheService
	) {
		this.logger = logger;
		this.errorLogger = errorLogger;
		this.errorHandler = errorHandler;
		this.envConfig = envConfig;
		this.vault = vault;
		this.cacheService = cacheService;
		this.ttl =
			serviceTTLConfig.YubicoOtpService || serviceTTLConfig.default;
		this.yub = this.initializeYubClient();
	}
	static async getInstance() {
		if (!YubicoOTPService.instance) {
			const logger = await LoggerServiceFactory.getLoggerService();
			const errorLogger =
				await LoggerServiceFactory.getErrorLoggerService();
			const errorHandler =
				await ErrorHandlerServiceFactory.getErrorHandlerService();
			const envConfig =
				await EnvConfigServiceFactory.getEnvConfigService();
			const vault = await VaultServiceFactory.getVaultService();
			const cacheService =
				await CacheLayerServiceFactory.getCacheService();
			YubicoOTPService.instance = new YubicoOTPService(
				logger,
				errorLogger,
				errorHandler,
				envConfig,
				vault,
				cacheService
			);
		}
		return YubicoOTPService.instance;
	}
	initializeYubClient() {
		return {
			init: (clientId, secretKey) => {
				console.debug(
					`Initializing Yubico OTP with ${clientId} and ${secretKey}`
				);
				return {
					verify: (otp, callback) => {
						if (otp === 'test-otp') {
							const response = {
								status: 'OK'
							};
							callback(null, response);
						} else {
							const response = {
								status: 'FAIL'
							};
							callback(new Error('Invalid OTP'), response);
						}
					}
				};
			}
		};
	}
	init(clientId, secretKey) {
		return this.yub.init(clientId, secretKey);
	}
	async initializeYubicoOTP() {
		const cacheKey = 'yubicoClient';
		const cachedClient = await this.cacheService.get(cacheKey, 'auth');
		if (
			cachedClient &&
			typeof cachedClient === 'object' &&
			'verify' in cachedClient
		) {
			this.logger.debug('Loaded Yubico Client from cache.');
			this.yubClient = cachedClient;
			return;
		}
		try {
			this.logger.info('Initializing Yubico OTP Utility.');
			const yubiSecrets = await this.vault.retrieveSecrets(
				['YUBICO_CLIENT_ID', 'YUBICO_SECRET_KEY'],
				secrets => secrets
			);
			if (
				yubiSecrets &&
				typeof yubiSecrets === 'object' &&
				!Array.isArray(yubiSecrets)
			) {
				const yubicoClientId =
					yubiSecrets['YUBICO_CLIENT_ID']?.toString() || '';
				const yubicoSecretKey =
					yubiSecrets['YUBICO_SECRET_KEY']?.toString() || '';
				if (!yubicoClientId || !yubicoSecretKey) {
					throw new Error(
						'Yubico Client ID or Secret Key is missing'
					);
				}
				const initializedClient = this.yub.init(
					yubicoClientId,
					yubicoSecretKey
				);
				if (initializedClient && 'verify' in initializedClient) {
					this.yubClient = initializedClient;
					await this.cacheService.set(
						cacheKey,
						this.yubClient,
						'auth',
						this.ttl
					);
					this.logger.info(
						'Yubico OTP Utility successfully initialized.'
					);
				}
			} else {
				throw new Error('Failed to retrieve Yubico secrets');
			}
		} catch (utilError) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Failed to initialize Yubico OTP Utility: ${
						utilError instanceof Error
							? utilError.message
							: utilError
					}`,
					{ exposeToClient: false }
				);
			this.errorLogger.logError(utilityError.message);
			this.errorHandler.handleError({ error: utilityError });
		}
	}
	async validateYubicoOTP(otp) {
		const cacheKey = `yubicoOtp:${otp}`;
		const cachedResult = await this.cacheService.get(cacheKey, 'auth');
		if (cachedResult !== null) {
			this.logger.debug('Loaded OTP validation result from cache.');
			return cachedResult;
		}
		try {
			if (!this.yubClient) {
				await this.initializeYubicoOTP();
			}
			return new Promise((resolve, reject) => {
				this.yubClient.verify(otp, (utilError, data) => {
					if (utilError) {
						const innerUtilError =
							new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
								`Failed to validate Yubico OTP: ${
									utilError instanceof Error
										? utilError.message
										: String(utilError)
								}`,
								{ exposeToClient: false }
							);
						this.errorLogger.logWarn(innerUtilError.message);
						this.errorHandler.handleError({
							error: innerUtilError
						});
						return reject(innerUtilError);
					}
					const isValid = data && data.status === 'OK';
					this.logger.debug(
						`Yubico OTP validation ${isValid ? 'successful' : 'failed'}.`
					);
					this.cacheService.set(cacheKey, isValid, 'auth', this.ttl);
					resolve(isValid);
				});
			});
		} catch (utilError) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Failed to validate Yubico OTP: ${
						utilError instanceof Error
							? utilError.message
							: utilError
					}`,
					{ exposeToClient: false }
				);
			this.errorLogger.logWarn(utilityError.message);
			this.errorHandler.handleError({ error: utilityError });
			return false;
		}
	}
	async generateYubicoOTPOptions() {
		try {
			this.logger.info('Generating Yubico OTP options.');
			const apiUrl = this.envConfig.getEnvVariable('yubicoApiUrl');
			const yubiSecrets = await this.vault.retrieveSecrets(
				['YUBICO_CLIENT_ID', 'YUBICO_SECRET_KEY'],
				secrets => secrets
			);
			if (
				yubiSecrets &&
				typeof yubiSecrets === 'object' &&
				!Array.isArray(yubiSecrets)
			) {
				const yubicoClientId =
					yubiSecrets['YUBICO_CLIENT_ID']?.toString() || '';
				const yubicoSecretKey =
					yubiSecrets['YUBICO_SECRET_KEY']?.toString() || '';
				if (!yubicoClientId || !yubicoSecretKey) {
					throw new Error(
						'Failed to retrieve or decrypt Yubico client ID or secret key'
					);
				}
				return {
					clientId: parseInt(yubicoClientId, 10),
					apiKey: yubicoSecretKey,
					apiUrl
				};
			} else {
				throw new Error('Failed to retrieve Yubico secrets');
			}
		} catch (utiLError) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Failed to generate Yubico OTP options: ${
						utiLError instanceof Error
							? utiLError.message
							: utiLError
					}; Returning object with placeholder values.`,
					{ exposeToClient: false }
				);
			this.errorLogger.logWarn(utilityError.message);
			this.errorHandler.handleCriticalError({ error: utilityError });
			return {
				clientId: 0,
				apiKey: '',
				apiUrl: ''
			};
		}
	}
	async shutdown() {
		try {
			this.logger.info('Shutting down YubicoOTPService...');
			this.logger.info('Clearing YubicoOTPService cache...');
			await this.cacheService.clearNamespace('YubicoOTPService');
			this.logger.info('YubicoOTPService cache cleared successfully.');
			this.yubClient = undefined;
			YubicoOTPService.instance = null;
			this.logger.info(
				'YubicoOTPService shutdown completed successfully.'
			);
		} catch (error) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Error during YubicoOTPService shutdown: ${error instanceof Error ? error.message : error}`
				);
			this.errorLogger.logError(utilityError.message);
			this.errorHandler.handleError({ error: utilityError });
		}
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiWXViaWNvT1RQLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2F1dGgvWXViaWNvT1RQLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQVlBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLG9EQUFvRCxDQUFDO0FBQzFGLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLDBEQUEwRCxDQUFDO0FBQ3RHLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLHdEQUF3RCxDQUFDO0FBQ2xHLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLHVEQUF1RCxDQUFDO0FBQ2hHLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLG1EQUFtRCxDQUFDO0FBRXhGLE9BQU8sMkJBQTJCLENBQUM7QUFFbkMsTUFBTSxPQUFPLGdCQUFnQjtJQUNwQixNQUFNLENBQUMsUUFBUSxHQUE0QixJQUFJLENBQUM7SUFDaEQsTUFBTSxDQUE0QjtJQUNsQyxXQUFXLENBQThCO0lBQ3pDLFlBQVksQ0FBK0I7SUFDM0MsU0FBUyxDQUE0QjtJQUNyQyxLQUFLLENBQXdCO0lBQzdCLFlBQVksQ0FBd0I7SUFDcEMsU0FBUyxDQUFpQztJQUUxQyxHQUFHLENBQVM7SUFDWixHQUFHLENBQTRCO0lBRXZDLFlBQ0MsTUFBaUMsRUFDakMsV0FBd0MsRUFDeEMsWUFBMEMsRUFDMUMsU0FBb0MsRUFDcEMsS0FBNEIsRUFDNUIsWUFBbUM7UUFFbkMsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7UUFDL0IsSUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUM7UUFDakMsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDM0IsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLFlBQVksR0FB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QUksQ0FDZixtREFBbUQsQ0FDbkQsQ0FBQztRQUNILENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2hCLE1BQU0sWUFBWSxHQUNqQixJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLHVCQUF1QixDQUN6RCwyQ0FBMkMsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQzNGLENBQUM7WUFDSCxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDaEQsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQztRQUN4RCxDQUFDO0lBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG5cdEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdENhY2hlU2VydmljZUludGVyZmFjZSxcblx0RW52Q29uZmlnU2VydmljZUludGVyZmFjZSxcblx0RXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZSxcblx0RXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRWYXVsdFNlcnZpY2VJbnRlcmZhY2UsXG5cdFl1YkNsaWVudEludGVyZmFjZSxcblx0WXViaWNvT1RQT3B0aW9uc0ludGVyZmFjZSxcblx0WXViaWNvT1RQU2VydmljZUludGVyZmFjZSxcblx0WXViUmVzcG9uc2VJbnRlcmZhY2Vcbn0gZnJvbSAnLi4vaW5kZXgvaW50ZXJmYWNlcy9tYWluJztcbmltcG9ydCB7IHNlcnZpY2VUVExDb25maWcgfSBmcm9tICcuLi9jb25maWcvY2FjaGUnO1xuaW1wb3J0IHsgTG9nZ2VyU2VydmljZUZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5L3N1YmZhY3Rvcmllcy9Mb2dnZXJTZXJ2aWNlRmFjdG9yeSc7XG5pbXBvcnQgeyBFcnJvckhhbmRsZXJTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4uL2luZGV4L2ZhY3Rvcnkvc3ViZmFjdG9yaWVzL0Vycm9ySGFuZGxlclNlcnZpY2VGYWN0b3J5JztcbmltcG9ydCB7IENhY2hlTGF5ZXJTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4uL2luZGV4L2ZhY3Rvcnkvc3ViZmFjdG9yaWVzL0NhY2hlTGF5ZXJTZXJ2aWNlRmFjdG9yeSc7XG5pbXBvcnQgeyBFbnZDb25maWdTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4uL2luZGV4L2ZhY3Rvcnkvc3ViZmFjdG9yaWVzL0VudkNvbmZpZ1NlcnZpY2VGYWN0b3J5JztcbmltcG9ydCB7IFZhdWx0U2VydmljZUZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5L3N1YmZhY3Rvcmllcy9WYXVsdFNlcnZpY2VGYWN0b3J5JztcblxuaW1wb3J0ICcuLi8uLi90eXBlcy9jdXN0b20veXViLmpzJztcblxuZXhwb3J0IGNsYXNzIFl1Ymljb09UUFNlcnZpY2UgaW1wbGVtZW50cyBZdWJpY29PVFBTZXJ2aWNlSW50ZXJmYWNlIHtcblx0cHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IFl1Ymljb09UUFNlcnZpY2UgfCBudWxsID0gbnVsbDtcblx0cHJpdmF0ZSBsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBlcnJvckhhbmRsZXI6IEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZW52Q29uZmlnOiBFbnZDb25maWdTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIHZhdWx0OiBWYXVsdFNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgY2FjaGVTZXJ2aWNlOiBDYWNoZVNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgeXViQ2xpZW50OiBZdWJDbGllbnRJbnRlcmZhY2UgfCB1bmRlZmluZWQ7XG5cblx0cHJpdmF0ZSB0dGw6IG51bWJlcjtcblx0cHJpdmF0ZSB5dWI6IFl1Ymljb09UUFNlcnZpY2VJbnRlcmZhY2U7XG5cblx0cHJpdmF0ZSBjb25zdHJ1Y3Rvcihcblx0XHRsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0ZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0XHRlcnJvckhhbmRsZXI6IEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0ZW52Q29uZmlnOiBFbnZDb25maWdTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdHZhdWx0OiBWYXVsdFNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0Y2FjaGVTZXJ2aWNlOiBDYWNoZVNlcnZpY2VJbnRlcmZhY2Vcblx0KSB7XG5cdFx0dGhpcy5sb2dnZXIgPSBsb2dnZXI7XG5cdFx0dGhpcy5lcnJvckxvZ2dlciA9IGVycm9yTG9nZ2VyO1xuXHRcdHRoaXMuZXJyb3JIYW5kbGVyID0gZXJyb3JIYW5kbGVyO1xuXHRcdHRoaXMuZW52Q29uZmlnID0gZW52Q29uZmlnO1xuXHRcdHRoaXMudmF1bHQgPSB2YXVsdDtcblx0XHR0aGlzLmNhY2hlU2VydmljZSA9IGNhY2hlU2VydmljZTtcblx0XHR0aGlzLnR0bCA9XG5cdFx0XHRzZXJ2aWNlVFRMQ29uZmlnLll1Ymljb090cFNlcnZpY2UgfHwgc2VydmljZVRUTENvbmZpZy5kZWZhdWx0O1xuXHRcdHRoaXMueXViID0gdGhpcy5pbml0aWFsaXplWXViQ2xpZW50KCk7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGFzeW5jIGdldEluc3RhbmNlKCk6IFByb21pc2U8WXViaWNvT1RQU2VydmljZT4ge1xuXHRcdGlmICghWXViaWNvT1RQU2VydmljZS5pbnN0YW5jZSkge1xuXHRcdFx0Y29uc3QgbG9nZ2VyID0gYXdhaXQgTG9nZ2VyU2VydmljZUZhY3RvcnkuZ2V0TG9nZ2VyU2VydmljZSgpO1xuXHRcdFx0Y29uc3QgZXJyb3JMb2dnZXIgPVxuXHRcdFx0XHRhd2FpdCBMb2dnZXJTZXJ2aWNlRmFjdG9yeS5nZXRFcnJvckxvZ2dlclNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGVycm9ySGFuZGxlciA9XG5cdFx0XHRcdGF3YWl0IEVycm9ySGFuZGxlclNlcnZpY2VGYWN0b3J5LmdldEVycm9ySGFuZGxlclNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGVudkNvbmZpZyA9XG5cdFx0XHRcdGF3YWl0IEVudkNvbmZpZ1NlcnZpY2VGYWN0b3J5LmdldEVudkNvbmZpZ1NlcnZpY2UoKTtcblx0XHRcdGNvbnN0IHZhdWx0ID0gYXdhaXQgVmF1bHRTZXJ2aWNlRmFjdG9yeS5nZXRWYXVsdFNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGNhY2hlU2VydmljZSA9XG5cdFx0XHRcdGF3YWl0IENhY2hlTGF5ZXJTZXJ2aWNlRmFjdG9yeS5nZXRDYWNoZVNlcnZpY2UoKTtcblxuXHRcdFx0WXViaWNvT1RQU2VydmljZS5pbnN0YW5jZSA9IG5ldyBZdWJpY29PVFBTZXJ2aWNlKFxuXHRcdFx0XHRsb2dnZXIsXG5cdFx0XHRcdGVycm9yTG9nZ2VyLFxuXHRcdFx0XHRlcnJvckhhbmRsZXIsXG5cdFx0XHRcdGVudkNvbmZpZyxcblx0XHRcdFx0dmF1bHQsXG5cdFx0XHRcdGNhY2hlU2VydmljZVxuXHRcdFx0KTtcblx0XHR9XG5cdFx0cmV0dXJuIFl1Ymljb09UUFNlcnZpY2UuaW5zdGFuY2U7XG5cdH1cblxuXHRwcml2YXRlIGluaXRpYWxpemVZdWJDbGllbnQoKTogWXViaWNvT1RQU2VydmljZUludGVyZmFjZSB7XG5cdFx0cmV0dXJuIHtcblx0XHRcdGluaXQ6IChjbGllbnRJZDogc3RyaW5nLCBzZWNyZXRLZXk6IHN0cmluZyk6IFl1YkNsaWVudEludGVyZmFjZSA9PiB7XG5cdFx0XHRcdGNvbnNvbGUuZGVidWcoXG5cdFx0XHRcdFx0YEluaXRpYWxpemluZyBZdWJpY28gT1RQIHdpdGggJHtjbGllbnRJZH0gYW5kICR7c2VjcmV0S2V5fWBcblx0XHRcdFx0KTtcblx0XHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0XHR2ZXJpZnk6IChcblx0XHRcdFx0XHRcdG90cDogc3RyaW5nLFxuXHRcdFx0XHRcdFx0Y2FsbGJhY2s6IChcblx0XHRcdFx0XHRcdFx0ZXJyOiBFcnJvciB8IG51bGwsXG5cdFx0XHRcdFx0XHRcdGRhdGE6IFl1YlJlc3BvbnNlSW50ZXJmYWNlXG5cdFx0XHRcdFx0XHQpID0+IHZvaWRcblx0XHRcdFx0XHQpID0+IHtcblx0XHRcdFx0XHRcdGlmIChvdHAgPT09ICd0ZXN0LW90cCcpIHtcblx0XHRcdFx0XHRcdFx0Y29uc3QgcmVzcG9uc2U6IFl1YlJlc3BvbnNlSW50ZXJmYWNlID0ge1xuXHRcdFx0XHRcdFx0XHRcdHN0YXR1czogJ09LJ1xuXHRcdFx0XHRcdFx0XHR9O1xuXHRcdFx0XHRcdFx0XHRjYWxsYmFjayhudWxsLCByZXNwb25zZSk7XG5cdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRjb25zdCByZXNwb25zZTogWXViUmVzcG9uc2VJbnRlcmZhY2UgPSB7XG5cdFx0XHRcdFx0XHRcdFx0c3RhdHVzOiAnRkFJTCdcblx0XHRcdFx0XHRcdFx0fTtcblx0XHRcdFx0XHRcdFx0Y2FsbGJhY2sobmV3IEVycm9yKCdJbnZhbGlkIE9UUCcpLCByZXNwb25zZSk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9IGFzIFl1YkNsaWVudEludGVyZmFjZTtcblx0XHRcdH1cblx0XHR9IGFzIFl1Ymljb09UUFNlcnZpY2VJbnRlcmZhY2U7XG5cdH1cblxuXHRwdWJsaWMgaW5pdChjbGllbnRJZDogc3RyaW5nLCBzZWNyZXRLZXk6IHN0cmluZyk6IFl1YkNsaWVudEludGVyZmFjZSB7XG5cdFx0cmV0dXJuIHRoaXMueXViLmluaXQoY2xpZW50SWQsIHNlY3JldEtleSkgYXMgWXViQ2xpZW50SW50ZXJmYWNlO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGluaXRpYWxpemVZdWJpY29PVFAoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgY2FjaGVLZXkgPSAneXViaWNvQ2xpZW50Jztcblx0XHRjb25zdCBjYWNoZWRDbGllbnQgPSBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5nZXQoY2FjaGVLZXksICdhdXRoJyk7XG5cblx0XHRpZiAoXG5cdFx0XHRjYWNoZWRDbGllbnQgJiZcblx0XHRcdHR5cGVvZiBjYWNoZWRDbGllbnQgPT09ICdvYmplY3QnICYmXG5cdFx0XHQndmVyaWZ5JyBpbiBjYWNoZWRDbGllbnRcblx0XHQpIHtcblx0XHRcdHRoaXMubG9nZ2VyLmRlYnVnKCdMb2FkZWQgWXViaWNvIENsaWVudCBmcm9tIGNhY2hlLicpO1xuXHRcdFx0dGhpcy55dWJDbGllbnQgPSBjYWNoZWRDbGllbnQgYXMgWXViQ2xpZW50SW50ZXJmYWNlO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdHRyeSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdJbml0aWFsaXppbmcgWXViaWNvIE9UUCBVdGlsaXR5LicpO1xuXG5cdFx0XHRjb25zdCB5dWJpU2VjcmV0cyA9IGF3YWl0IHRoaXMudmF1bHQucmV0cmlldmVTZWNyZXRzKFxuXHRcdFx0XHRbJ1lVQklDT19DTElFTlRfSUQnLCAnWVVCSUNPX1NFQ1JFVF9LRVknXSxcblx0XHRcdFx0c2VjcmV0cyA9PiBzZWNyZXRzXG5cdFx0XHQpO1xuXG5cdFx0XHRpZiAoXG5cdFx0XHRcdHl1YmlTZWNyZXRzICYmXG5cdFx0XHRcdHR5cGVvZiB5dWJpU2VjcmV0cyA9PT0gJ29iamVjdCcgJiZcblx0XHRcdFx0IUFycmF5LmlzQXJyYXkoeXViaVNlY3JldHMpXG5cdFx0XHQpIHtcblx0XHRcdFx0Y29uc3QgeXViaWNvQ2xpZW50SWQgPVxuXHRcdFx0XHRcdHl1YmlTZWNyZXRzWydZVUJJQ09fQ0xJRU5UX0lEJ10/LnRvU3RyaW5nKCkgfHwgJyc7XG5cdFx0XHRcdGNvbnN0IHl1Ymljb1NlY3JldEtleSA9XG5cdFx0XHRcdFx0eXViaVNlY3JldHNbJ1lVQklDT19TRUNSRVRfS0VZJ10/LnRvU3RyaW5nKCkgfHwgJyc7XG5cblx0XHRcdFx0aWYgKCF5dWJpY29DbGllbnRJZCB8fCAheXViaWNvU2VjcmV0S2V5KSB7XG5cdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKFxuXHRcdFx0XHRcdFx0J1l1YmljbyBDbGllbnQgSUQgb3IgU2VjcmV0IEtleSBpcyBtaXNzaW5nJ1xuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRjb25zdCBpbml0aWFsaXplZENsaWVudCA9IHRoaXMueXViLmluaXQoXG5cdFx0XHRcdFx0eXViaWNvQ2xpZW50SWQsXG5cdFx0XHRcdFx0eXViaWNvU2VjcmV0S2V5XG5cdFx0XHRcdCk7XG5cblx0XHRcdFx0aWYgKGluaXRpYWxpemVkQ2xpZW50ICYmICd2ZXJpZnknIGluIGluaXRpYWxpemVkQ2xpZW50KSB7XG5cdFx0XHRcdFx0dGhpcy55dWJDbGllbnQgPSBpbml0aWFsaXplZENsaWVudCBhcyBZdWJDbGllbnRJbnRlcmZhY2U7XG5cblx0XHRcdFx0XHRhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5zZXQoXG5cdFx0XHRcdFx0XHRjYWNoZUtleSxcblx0XHRcdFx0XHRcdHRoaXMueXViQ2xpZW50LFxuXHRcdFx0XHRcdFx0J2F1dGgnLFxuXHRcdFx0XHRcdFx0dGhpcy50dGxcblx0XHRcdFx0XHQpO1xuXG5cdFx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0XHRcdCdZdWJpY28gT1RQIFV0aWxpdHkgc3VjY2Vzc2Z1bGx5IGluaXRpYWxpemVkLidcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR9XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byByZXRyaWV2ZSBZdWJpY28gc2VjcmV0cycpO1xuXHRcdFx0fVxuXHRcdH0gY2F0Y2ggKHV0aWxFcnJvcikge1xuXHRcdFx0Y29uc3QgdXRpbGl0eUVycm9yID1cblx0XHRcdFx0bmV3IHRoaXMuZXJyb3JIYW5kbGVyLkVycm9yQ2xhc3Nlcy5VdGlsaXR5RXJyb3JSZWNvdmVyYWJsZShcblx0XHRcdFx0XHRgRmFpbGVkIHRvIGluaXRpYWxpemUgWXViaWNvIE9UUCBVdGlsaXR5OiAke1xuXHRcdFx0XHRcdFx0dXRpbEVycm9yIGluc3RhbmNlb2YgRXJyb3Jcblx0XHRcdFx0XHRcdFx0PyB1dGlsRXJyb3IubWVzc2FnZVxuXHRcdFx0XHRcdFx0XHQ6IHV0aWxFcnJvclxuXHRcdFx0XHRcdH1gLFxuXHRcdFx0XHRcdHsgZXhwb3NlVG9DbGllbnQ6IGZhbHNlIH1cblx0XHRcdFx0KTtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nRXJyb3IodXRpbGl0eUVycm9yLm1lc3NhZ2UpO1xuXHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3IoeyBlcnJvcjogdXRpbGl0eUVycm9yIH0pO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyB2YWxpZGF0ZVl1Ymljb09UUChvdHA6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuXHRcdGNvbnN0IGNhY2hlS2V5ID0gYHl1Ymljb090cDoke290cH1gO1xuXHRcdGNvbnN0IGNhY2hlZFJlc3VsdCA9IGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLmdldChjYWNoZUtleSwgJ2F1dGgnKTtcblx0XHRpZiAoY2FjaGVkUmVzdWx0ICE9PSBudWxsKSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5kZWJ1ZygnTG9hZGVkIE9UUCB2YWxpZGF0aW9uIHJlc3VsdCBmcm9tIGNhY2hlLicpO1xuXHRcdFx0cmV0dXJuIGNhY2hlZFJlc3VsdCBhcyBib29sZWFuO1xuXHRcdH1cblxuXHRcdHRyeSB7XG5cdFx0XHRpZiAoIXRoaXMueXViQ2xpZW50KSB7XG5cdFx0XHRcdGF3YWl0IHRoaXMuaW5pdGlhbGl6ZVl1Ymljb09UUCgpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0XHR0aGlzLnl1YkNsaWVudCEudmVyaWZ5KFxuXHRcdFx0XHRcdG90cCxcblx0XHRcdFx0XHQodXRpbEVycm9yOiBFcnJvciB8IG51bGwsIGRhdGE6IFl1YlJlc3BvbnNlSW50ZXJmYWNlKSA9PiB7XG5cdFx0XHRcdFx0XHRpZiAodXRpbEVycm9yKSB7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IGlubmVyVXRpbEVycm9yID1cblx0XHRcdFx0XHRcdFx0XHRuZXcgdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JDbGFzc2VzLlV0aWxpdHlFcnJvclJlY292ZXJhYmxlKFxuXHRcdFx0XHRcdFx0XHRcdFx0YEZhaWxlZCB0byB2YWxpZGF0ZSBZdWJpY28gT1RQOiAke1xuXHRcdFx0XHRcdFx0XHRcdFx0XHR1dGlsRXJyb3IgaW5zdGFuY2VvZiBFcnJvclxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdD8gdXRpbEVycm9yLm1lc3NhZ2Vcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHQ6IFN0cmluZyh1dGlsRXJyb3IpXG5cdFx0XHRcdFx0XHRcdFx0XHR9YCxcblx0XHRcdFx0XHRcdFx0XHRcdHsgZXhwb3NlVG9DbGllbnQ6IGZhbHNlIH1cblx0XHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ1dhcm4oaW5uZXJVdGlsRXJyb3IubWVzc2FnZSk7XG5cdFx0XHRcdFx0XHRcdHRoaXMuZXJyb3JIYW5kbGVyLmhhbmRsZUVycm9yKHtcblx0XHRcdFx0XHRcdFx0XHRlcnJvcjogaW5uZXJVdGlsRXJyb3Jcblx0XHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRcdHJldHVybiByZWplY3QoaW5uZXJVdGlsRXJyb3IpO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRjb25zdCBpc1ZhbGlkID0gZGF0YSAmJiBkYXRhLnN0YXR1cyA9PT0gJ09LJztcblx0XHRcdFx0XHRcdHRoaXMubG9nZ2VyLmRlYnVnKFxuXHRcdFx0XHRcdFx0XHRgWXViaWNvIE9UUCB2YWxpZGF0aW9uICR7XG5cdFx0XHRcdFx0XHRcdFx0aXNWYWxpZCA/ICdzdWNjZXNzZnVsJyA6ICdmYWlsZWQnXG5cdFx0XHRcdFx0XHRcdH0uYFxuXHRcdFx0XHRcdFx0KTtcblxuXHRcdFx0XHRcdFx0dGhpcy5jYWNoZVNlcnZpY2Uuc2V0KFxuXHRcdFx0XHRcdFx0XHRjYWNoZUtleSxcblx0XHRcdFx0XHRcdFx0aXNWYWxpZCxcblx0XHRcdFx0XHRcdFx0J2F1dGgnLFxuXHRcdFx0XHRcdFx0XHR0aGlzLnR0bFxuXHRcdFx0XHRcdFx0KTtcblxuXHRcdFx0XHRcdFx0cmVzb2x2ZShpc1ZhbGlkKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdCk7XG5cdFx0XHR9KTtcblx0XHR9IGNhdGNoICh1dGlsRXJyb3IpIHtcblx0XHRcdGNvbnN0IHV0aWxpdHlFcnJvciA9XG5cdFx0XHRcdG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuVXRpbGl0eUVycm9yUmVjb3ZlcmFibGUoXG5cdFx0XHRcdFx0YEZhaWxlZCB0byB2YWxpZGF0ZSBZdWJpY28gT1RQOiAke1xuXHRcdFx0XHRcdFx0dXRpbEVycm9yIGluc3RhbmNlb2YgRXJyb3Jcblx0XHRcdFx0XHRcdFx0PyB1dGlsRXJyb3IubWVzc2FnZVxuXHRcdFx0XHRcdFx0XHQ6IHV0aWxFcnJvclxuXHRcdFx0XHRcdH1gLFxuXHRcdFx0XHRcdHsgZXhwb3NlVG9DbGllbnQ6IGZhbHNlIH1cblx0XHRcdFx0KTtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nV2Fybih1dGlsaXR5RXJyb3IubWVzc2FnZSk7XG5cdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7IGVycm9yOiB1dGlsaXR5RXJyb3IgfSk7XG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIGdlbmVyYXRlWXViaWNvT1RQT3B0aW9ucygpOiBQcm9taXNlPFl1Ymljb09UUE9wdGlvbnNJbnRlcmZhY2U+IHtcblx0XHR0cnkge1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnR2VuZXJhdGluZyBZdWJpY28gT1RQIG9wdGlvbnMuJyk7XG5cblx0XHRcdGNvbnN0IGFwaVVybCA9IHRoaXMuZW52Q29uZmlnLmdldEVudlZhcmlhYmxlKFxuXHRcdFx0XHQneXViaWNvQXBpVXJsJ1xuXHRcdFx0KSBhcyBzdHJpbmc7XG5cblx0XHRcdGNvbnN0IHl1YmlTZWNyZXRzID0gYXdhaXQgdGhpcy52YXVsdC5yZXRyaWV2ZVNlY3JldHMoXG5cdFx0XHRcdFsnWVVCSUNPX0NMSUVOVF9JRCcsICdZVUJJQ09fU0VDUkVUX0tFWSddLFxuXHRcdFx0XHRzZWNyZXRzID0+IHNlY3JldHNcblx0XHRcdCk7XG5cblx0XHRcdGlmIChcblx0XHRcdFx0eXViaVNlY3JldHMgJiZcblx0XHRcdFx0dHlwZW9mIHl1YmlTZWNyZXRzID09PSAnb2JqZWN0JyAmJlxuXHRcdFx0XHQhQXJyYXkuaXNBcnJheSh5dWJpU2VjcmV0cylcblx0XHRcdCkge1xuXHRcdFx0XHRjb25zdCB5dWJpY29DbGllbnRJZCA9XG5cdFx0XHRcdFx0eXViaVNlY3JldHNbJ1lVQklDT19DTElFTlRfSUQnXT8udG9TdHJpbmcoKSB8fCAnJztcblx0XHRcdFx0Y29uc3QgeXViaWNvU2VjcmV0S2V5ID1cblx0XHRcdFx0XHR5dWJpU2VjcmV0c1snWVVCSUNPX1NFQ1JFVF9LRVknXT8udG9TdHJpbmcoKSB8fCAnJztcblxuXHRcdFx0XHRpZiAoIXl1Ymljb0NsaWVudElkIHx8ICF5dWJpY29TZWNyZXRLZXkpIHtcblx0XHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoXG5cdFx0XHRcdFx0XHQnRmFpbGVkIHRvIHJldHJpZXZlIG9yIGRlY3J5cHQgWXViaWNvIGNsaWVudCBJRCBvciBzZWNyZXQga2V5J1xuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRcdGNsaWVudElkOiBwYXJzZUludCh5dWJpY29DbGllbnRJZCwgMTApLFxuXHRcdFx0XHRcdGFwaUtleTogeXViaWNvU2VjcmV0S2V5LFxuXHRcdFx0XHRcdGFwaVVybFxuXHRcdFx0XHR9O1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gcmV0cmlldmUgWXViaWNvIHNlY3JldHMnKTtcblx0XHRcdH1cblx0XHR9IGNhdGNoICh1dGlMRXJyb3IpIHtcblx0XHRcdGNvbnN0IHV0aWxpdHlFcnJvciA9XG5cdFx0XHRcdG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuVXRpbGl0eUVycm9yUmVjb3ZlcmFibGUoXG5cdFx0XHRcdFx0YEZhaWxlZCB0byBnZW5lcmF0ZSBZdWJpY28gT1RQIG9wdGlvbnM6ICR7XG5cdFx0XHRcdFx0XHR1dGlMRXJyb3IgaW5zdGFuY2VvZiBFcnJvclxuXHRcdFx0XHRcdFx0XHQ/IHV0aUxFcnJvci5tZXNzYWdlXG5cdFx0XHRcdFx0XHRcdDogdXRpTEVycm9yXG5cdFx0XHRcdFx0fTsgUmV0dXJuaW5nIG9iamVjdCB3aXRoIHBsYWNlaG9sZGVyIHZhbHVlcy5gLFxuXHRcdFx0XHRcdHsgZXhwb3NlVG9DbGllbnQ6IGZhbHNlIH1cblx0XHRcdFx0KTtcblxuXHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dXYXJuKHV0aWxpdHlFcnJvci5tZXNzYWdlKTtcblx0XHRcdHRoaXMuZXJyb3JIYW5kbGVyLmhhbmRsZUNyaXRpY2FsRXJyb3IoeyBlcnJvcjogdXRpbGl0eUVycm9yIH0pO1xuXG5cdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRjbGllbnRJZDogMCxcblx0XHRcdFx0YXBpS2V5OiAnJyxcblx0XHRcdFx0YXBpVXJsOiAnJ1xuXHRcdFx0fTtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgc2h1dGRvd24oKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ1NodXR0aW5nIGRvd24gWXViaWNvT1RQU2VydmljZS4uLicpO1xuXG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdDbGVhcmluZyBZdWJpY29PVFBTZXJ2aWNlIGNhY2hlLi4uJyk7XG5cdFx0XHRhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5jbGVhck5hbWVzcGFjZSgnWXViaWNvT1RQU2VydmljZScpO1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnWXViaWNvT1RQU2VydmljZSBjYWNoZSBjbGVhcmVkIHN1Y2Nlc3NmdWxseS4nKTtcblxuXHRcdFx0dGhpcy55dWJDbGllbnQgPSB1bmRlZmluZWQ7XG5cdFx0XHRZdWJpY29PVFBTZXJ2aWNlLmluc3RhbmNlID0gbnVsbDtcblxuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0J1l1Ymljb09UUFNlcnZpY2Ugc2h1dGRvd24gY29tcGxldGVkIHN1Y2Nlc3NmdWxseS4nXG5cdFx0XHQpO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHRjb25zdCB1dGlsaXR5RXJyb3IgPVxuXHRcdFx0XHRuZXcgdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JDbGFzc2VzLlV0aWxpdHlFcnJvclJlY292ZXJhYmxlKFxuXHRcdFx0XHRcdGBFcnJvciBkdXJpbmcgWXViaWNvT1RQU2VydmljZSBzaHV0ZG93bjogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yfWBcblx0XHRcdFx0KTtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nRXJyb3IodXRpbGl0eUVycm9yLm1lc3NhZ2UpO1xuXHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3IoeyBlcnJvcjogdXRpbGl0eUVycm9yIH0pO1xuXHRcdH1cblx0fVxufVxuIl19
