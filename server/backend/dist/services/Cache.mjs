import { serviceTTLConfig } from '../config/cache.mjs';
import { withRetry } from '../utils/helpers.mjs';
import { LoggerServiceFactory } from '../index/factory/subfactories/LoggerServiceFactory.mjs';
import { ErrorHandlerServiceFactory } from '../index/factory/subfactories/ErrorHandlerServiceFactory.mjs';
export class CacheService {
	static instance = null;
	logger;
	errorLogger;
	errorHandler;
	memoryCache = new Map();
	memoryCacheLRU = new Map();
	serviceMetrics = {};
	constructor(logger, errorLogger, errorHandler) {
		this.logger = logger;
		this.errorLogger = errorLogger;
		this.errorHandler = errorHandler;
	}
	static async getInstance() {
		if (!CacheService.instance) {
			CacheService.instance = new CacheService(
				await LoggerServiceFactory.getLoggerService(),
				await LoggerServiceFactory.getErrorLoggerService(),
				await ErrorHandlerServiceFactory.getErrorHandlerService()
			);
		}
		return CacheService.instance;
	}
	getServiceTTL(service) {
		return serviceTTLConfig[service] || serviceTTLConfig['default'];
	}
	getNamespacedKey(service, key) {
		return `${service}:${key}`;
	}
	updateMetrics(service, type) {
		if (!this.serviceMetrics[service]) {
			this.serviceMetrics[service] = {
				cacheHits: 0,
				cacheMisses: 0,
				redisHits: 0
			};
		}
		if (type === 'hit') {
			this.serviceMetrics[service].cacheHits++;
		} else if (type === 'miss') {
			this.serviceMetrics[service].cacheMisses++;
		} else if (type === 'redisHit') {
			this.serviceMetrics[service].redisHits++;
		}
	}
	getCacheMetrics(service) {
		return (
			this.serviceMetrics[service] || {
				cacheHits: 0,
				cacheMisses: 0,
				redisHits: 0
			}
		);
	}
	getMemoryCache(service) {
		return this.memoryCache.get(service) || null;
	}
	async get(key, service) {
		const namespacedKey = this.getNamespacedKey(service, key);
		try {
			const serviceMemoryCache = this.memoryCache.get(service);
			if (serviceMemoryCache) {
				const memoryEntry = serviceMemoryCache.get(namespacedKey);
				if (memoryEntry) {
					if (
						memoryEntry.expiration &&
						Date.now() > memoryEntry.expiration
					) {
						serviceMemoryCache.delete(namespacedKey);
						this.logger.info(
							`Memory cache expired for key: ${namespacedKey}`
						);
					} else {
						this.memoryCacheLRU.set(namespacedKey, Date.now());
						this.updateMetrics(service, 'hit');
						this.logger.info(
							`Memory cache hit for key: ${namespacedKey}`
						);
						return memoryEntry.value;
					}
				}
			}
			this.updateMetrics(service, 'miss');
			this.logger.info(`Cache miss for key: ${namespacedKey}`);
			return null;
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_GET_ERROR',
				{ key, service },
				`Error fetching key ${namespacedKey} from cache for service ${service}`
			);
			return null;
		}
	}
	async set(key, value, service, expirationInSeconds) {
		const namespacedKey = this.getNamespacedKey(service, key);
		try {
			const expiration = expirationInSeconds
				? Date.now() + Number(expirationInSeconds) * 1000
				: Date.now() + this.getServiceTTL(service) * 1000;
			let serviceMemoryCache = this.memoryCache.get(service);
			if (!serviceMemoryCache) {
				serviceMemoryCache = new Map();
				this.memoryCache.set(service, serviceMemoryCache);
			}
			serviceMemoryCache.set(namespacedKey, { value, expiration });
			this.memoryCacheLRU.set(namespacedKey, Date.now());
			this.logger.info(
				`Key ${namespacedKey} set with TTL ${expirationInSeconds || this.getServiceTTL(service)} seconds in both memory and Redis cache`
			);
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_SET_ERROR',
				{ key, service, expirationInSeconds },
				`Error setting key ${namespacedKey} in cache for service ${service}`
			);
		}
	}
	async exists(key, service) {
		const namespacedKey = this.getNamespacedKey(service, key);
		try {
			const serviceMemoryCache = this.memoryCache.get(service);
			if (serviceMemoryCache?.has(namespacedKey)) {
				this.logger.info(
					`Key ${namespacedKey} exists in memory cache, checked by service ${service}`
				);
				this.updateMetrics(service, 'hit');
				return true;
			}
			this.logger.info(
				`Key ${namespacedKey} does not exist in memory, checked by service ${service}`
			);
			this.updateMetrics(service, 'miss');
			return false;
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_EXISTS_ERROR',
				{ key, service },
				`Error checking existence of key ${namespacedKey} for service ${service}`
			);
			return false;
		}
	}
	async del(key, service) {
		const namespacedKey = this.getNamespacedKey(service, key);
		try {
			const serviceMemoryCache = this.memoryCache.get(service);
			if (serviceMemoryCache) {
				serviceMemoryCache.delete(namespacedKey);
				this.logger.info(
					`Key ${namespacedKey} deleted from memory cache by service ${service}`
				);
			}
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_DELETE_ERROR',
				{ key, service },
				`Error deleting key ${namespacedKey} from cache for service ${service}`
			);
		}
	}
	async increment(key, service, expirationInSeconds) {
		const namespacedKey = this.getNamespacedKey(service, key);
		try {
			let serviceMemoryCache = this.memoryCache.get(service);
			let newValue = null;
			if (serviceMemoryCache) {
				const memoryEntry = serviceMemoryCache.get(namespacedKey);
				if (memoryEntry && typeof memoryEntry.value === 'number') {
					memoryEntry.value += 1;
					newValue = memoryEntry.value;
					this.logger.info(
						`Memory cache incremented for key: ${namespacedKey} by service: ${service}`
					);
				}
			}
			if (!serviceMemoryCache || typeof newValue !== 'number') {
				newValue = 1;
				if (!serviceMemoryCache) {
					serviceMemoryCache = new Map();
					this.memoryCache.set(service, serviceMemoryCache);
				}
				const expiration = expirationInSeconds
					? Date.now() + expirationInSeconds * 1000
					: Date.now() + this.getServiceTTL(service) * 1000;
				serviceMemoryCache.set(namespacedKey, {
					value: newValue,
					expiration
				});
				this.logger.info(
					`Initialized incremented value in memory cache for key: ${namespacedKey} by service: ${service}`
				);
			}
			return newValue;
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_INCREMENT_ERROR',
				{
					reason: `Cache increment failed for key ${key}`,
					key: key || 'unknown',
					expiration: expirationInSeconds || 'unknown',
					service: service || 'unknown'
				},
				`Error incrementing key ${namespacedKey} in cache for service ${service}`
			);
			return null;
		}
	}
	async flushCache(service) {
		try {
			const serviceMemoryCache = this.memoryCache.get(service);
			if (serviceMemoryCache) {
				serviceMemoryCache.clear();
				this.memoryCache.delete(service);
				this.logger.info(
					`Memory cache flushed for service: ${service}`
				);
			} else {
				this.logger.warn(
					`No memory cache found for service: ${service}`
				);
			}
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_FLUSH_ERROR',
				{
					reason: `Cache flush failed for service ${service}`,
					service: service || 'unknown'
				},
				`Error flushing cache for service ${service}`
			);
		}
	}
	cleanupExpiredEntries() {
		withRetry(
			() => {
				for (const [service, cache] of this.memoryCache.entries()) {
					for (const [key, { expiration }] of cache.entries()) {
						if (expiration && Date.now() > expiration) {
							cache.delete(key);
							this.logger.info(
								`Expired memory cache entry removed for key: ${key} from service: ${service}`
							);
						}
					}
				}
			},
			3,
			1000
		).catch(error => {
			this.logger.error(
				`Error cleaning up expired memory cache entries after retries: ${error}`
			);
		});
	}
	async clearNamespace(service) {
		try {
			const serviceMemoryCache = this.memoryCache.get(service);
			if (serviceMemoryCache) {
				serviceMemoryCache.clear();
				this.memoryCache.delete(service);
				this.logger.info(
					`Memory cache cleared for service: ${service}`
				);
			} else {
				this.logger.warn(
					`No memory cache found for service: ${service}`
				);
			}
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_CLEAR_NAMESPACE_ERROR',
				{ service },
				`Error clearing cache for service ${service}`
			);
		}
	}
	async closeConnection() {
		try {
			this.logger.info(
				'No connection to close for memory cache *(LAYER 2 NOT IMPLEMENTED'
			);
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_CLOSE_CONNECTION_ERROR',
				{
					reason: `Cache connection close failed`
				},
				`Error closing cache connection`
			);
		}
	}
	async shutdown() {
		try {
			this.logger.info('Clearing memory cache in Cache Service...');
			this.memoryCache.clear();
			this.memoryCacheLRU.clear();
			this.logger.info('Memory cache cleared successfully.');
			this.logger.info('Cache service shutdown completed.');
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_SHUTDOWN_ERROR',
				{},
				`Error shutting down Cache Service`
			);
		}
	}
	handleCacheError(error, errorHeader, errorDetails, customMessage) {
		const errorMessage = `${customMessage}: ${error}\n${error instanceof Error ? error.stack : ''}`;
		this.errorLogger.logError(errorMessage);
		const cacheError = new this.errorHandler.ErrorClasses.CacheServiceError(
			errorHeader,
			{
				details: errorDetails,
				exposeToClient: false
			}
		);
		this.errorHandler.handleError({
			error: cacheError
		});
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2FjaGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2VydmljZXMvQ2FjaGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBT0EsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDbkQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLG9EQUFvRCxDQUFDO0FBQzFGLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLDBEQUEwRCxDQUFDO0FBRXRHLE1BQU0sT0FBTyxZQUFZO0lBQ2hCLE1BQU0sQ0FBQyxRQUFRLEdBQXdCLElBQUksQ0FBQztJQUU1QyxNQUFNLENBQTRCO0lBQ2xDLFdBQVcsQ0FBOEI7SUFDekMsWUFBWSxDQUErQjtJQUUzQyxXQUFXLEdBQUcsSUFBSSxHQUFHLEVBRzFCLENBQUM7SUFDSSxjQUFjLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUM7SUFDM0MsY0FBYyxHQU1sQixFQUFFLENBQUM7SUFFUCxZQUNDLE1BQWlDLEVBQ2pDLFdBQXdDLEVBQ3hDLFlBQTBDO1FBRTFDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQy9CLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO0lBQ2xDLENBQUM7SUFFTSxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVc7UUFDOUIsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUM1QixZQUFZLENBQUMsUUFBUSxHQUFHLElBQUksWUFBWSxDQUN2QyxNQUFNLG9CQUFvQixDQUFDLGdCQUFnQixFQUFFLEVBQzdDLE1BQU0sb0JBQW9CLENBQUMscUJBQXFCLEVBQUUsRUFDbEQsTUFBTSwwQkFBMEIsQ0FBQyxzQkFBc0IsRUFBRSxDQUN6RCxDQUFDO1FBQ0gsQ0FBQztRQUVELE9BQU8s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QUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNoQixJQUFJLENBQUMsZ0JBQWdCLENBQ3BCLEtBQUssRUFDTCxzQkFBc0IsRUFDdEIsRUFBRSxFQUNGLG1DQUFtQyxDQUNuQyxDQUFDO1FBQ0gsQ0FBQztJQUNGLENBQUM7SUFFTyxnQkFBZ0IsQ0FDdkIsS0FBYyxFQUNkLFdBQW1CLEVBQ25CLFlBQW9CLEVBQ3BCLGFBQXFCO1FBRXJCLE1BQU0sWUFBWSxHQUFHLEdBQUcsYUFBYSxLQUFLLEtBQUssS0FBSyxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUNoRyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUV4QyxNQUFNLFVBQVUsR0FBRyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLGlCQUFpQixDQUN0RSxXQUFXLEVBQ1g7WUFDQyxPQUFPLEVBQUUsWUFBWTtZQUNyQixjQUFjLEVBQUUsS0FBSztTQUNyQixDQUNELENBQUM7UUFFRixJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQztZQUM3QixLQUFLLEVBQUUsVUFBVTtTQUNqQixDQUFDLENBQUM7SUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcblx0QXBwTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0Q2FjaGVNZXRyaWNzLFxuXHRDYWNoZVNlcnZpY2VJbnRlcmZhY2UsXG5cdEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2UsXG5cdEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZVxufSBmcm9tICcuLi9pbmRleC9pbnRlcmZhY2VzL21haW4nO1xuaW1wb3J0IHsgc2VydmljZVRUTENvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy9jYWNoZSc7XG5pbXBvcnQgeyB3aXRoUmV0cnkgfSBmcm9tICcuLi91dGlscy9oZWxwZXJzJztcbmltcG9ydCB7IExvZ2dlclNlcnZpY2VGYWN0b3J5IH0gZnJvbSAnLi4vaW5kZXgvZmFjdG9yeS9zdWJmYWN0b3JpZXMvTG9nZ2VyU2VydmljZUZhY3RvcnknO1xuaW1wb3J0IHsgRXJyb3JIYW5kbGVyU2VydmljZUZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5L3N1YmZhY3Rvcmllcy9FcnJvckhhbmRsZXJTZXJ2aWNlRmFjdG9yeSc7XG5cbmV4cG9ydCBjbGFzcyBDYWNoZVNlcnZpY2UgaW1wbGVtZW50cyBDYWNoZVNlcnZpY2VJbnRlcmZhY2Uge1xuXHRwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTogQ2FjaGVTZXJ2aWNlIHwgbnVsbCA9IG51bGw7XG5cblx0cHJpdmF0ZSBsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBlcnJvckhhbmRsZXI6IEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2U7XG5cblx0cHJpdmF0ZSBtZW1vcnlDYWNoZSA9IG5ldyBNYXA8XG5cdFx0c3RyaW5nLFxuXHRcdE1hcDxzdHJpbmcsIHsgdmFsdWU6IHVua25vd247IGV4cGlyYXRpb246IG51bWJlciB8IHVuZGVmaW5lZCB9PlxuXHQ+KCk7XG5cdHByaXZhdGUgbWVtb3J5Q2FjaGVMUlUgPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyPigpO1xuXHRwcml2YXRlIHNlcnZpY2VNZXRyaWNzOiB7XG5cdFx0W3NlcnZpY2U6IHN0cmluZ106IHtcblx0XHRcdGNhY2hlSGl0czogbnVtYmVyO1xuXHRcdFx0Y2FjaGVNaXNzZXM6IG51bWJlcjtcblx0XHRcdHJlZGlzSGl0czogbnVtYmVyO1xuXHRcdH07XG5cdH0gPSB7fTtcblxuXHRwcml2YXRlIGNvbnN0cnVjdG9yKFxuXHRcdGxvZ2dlcjogQXBwTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0XHRlcnJvckxvZ2dlcjogRXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGVycm9ySGFuZGxlcjogRXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZVxuXHQpIHtcblx0XHR0aGlzLmxvZ2dlciA9IGxvZ2dlcjtcblx0XHR0aGlzLmVycm9yTG9nZ2VyID0gZXJyb3JMb2dnZXI7XG5cdFx0dGhpcy5lcnJvckhhbmRsZXIgPSBlcnJvckhhbmRsZXI7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGFzeW5jIGdldEluc3RhbmNlKCk6IFByb21pc2U8Q2FjaGVTZXJ2aWNlPiB7XG5cdFx0aWYgKCFDYWNoZVNlcnZpY2UuaW5zdGFuY2UpIHtcblx0XHRcdENhY2hlU2VydmljZS5pbnN0YW5jZSA9IG5ldyBDYWNoZVNlcnZpY2UoXG5cdFx0XHRcdGF3YWl0IExvZ2dlclNlcnZpY2VGYWN0b3J5LmdldExvZ2dlclNlcnZpY2UoKSxcblx0XHRcdFx0YXdhaXQgTG9nZ2VyU2VydmljZUZhY3RvcnkuZ2V0RXJyb3JMb2dnZXJTZXJ2aWNlKCksXG5cdFx0XHRcdGF3YWl0IEVycm9ySGFuZGxlclNlcnZpY2VGYWN0b3J5LmdldEVycm9ySGFuZGxlclNlcnZpY2UoKVxuXHRcdFx0KTtcblx0XHR9XG5cblx0XHRyZXR1cm4gQ2FjaGVTZXJ2aWNlLmluc3RhbmNlO1xuXHR9XG5cblx0cHJpdmF0ZSBnZXRTZXJ2aWNlVFRMKHNlcnZpY2U6IHN0cmluZyk6IG51bWJlciB7XG5cdFx0cmV0dXJuIHNlcnZpY2VUVExDb25maWdbc2VydmljZV0gfHwgc2VydmljZVRUTENvbmZpZ1snZGVmYXVsdCddO1xuXHR9XG5cblx0cHJpdmF0ZSBnZXROYW1lc3BhY2VkS2V5KHNlcnZpY2U6IHN0cmluZywga2V5OiBzdHJpbmcpOiBzdHJpbmcge1xuXHRcdHJldHVybiBgJHtzZXJ2aWNlfToke2tleX1gO1xuXHR9XG5cblx0cHJpdmF0ZSB1cGRhdGVNZXRyaWNzKFxuXHRcdHNlcnZpY2U6IHN0cmluZyxcblx0XHR0eXBlOiAnaGl0JyB8ICdtaXNzJyB8ICdyZWRpc0hpdCdcblx0KTogdm9pZCB7XG5cdFx0aWYgKCF0aGlzLnNlcnZpY2VNZXRyaWNzW3NlcnZpY2VdKSB7XG5cdFx0XHR0aGlzLnNlcnZpY2VNZXRyaWNzW3NlcnZpY2VdID0ge1xuXHRcdFx0XHRjYWNoZUhpdHM6IDAsXG5cdFx0XHRcdGNhY2hlTWlzc2VzOiAwLFxuXHRcdFx0XHRyZWRpc0hpdHM6IDBcblx0XHRcdH07XG5cdFx0fVxuXG5cdFx0aWYgKHR5cGUgPT09ICdoaXQnKSB7XG5cdFx0XHR0aGlzLnNlcnZpY2VNZXRyaWNzW3NlcnZpY2VdLmNhY2hlSGl0cysrO1xuXHRcdH0gZWxzZSBpZiAodHlwZSA9PT0gJ21pc3MnKSB7XG5cdFx0XHR0aGlzLnNlcnZpY2VNZXRyaWNzW3NlcnZpY2VdLmNhY2hlTWlzc2VzKys7XG5cdFx0fSBlbHNlIGlmICh0eXBlID09PSAncmVkaXNIaXQnKSB7XG5cdFx0XHR0aGlzLnNlcnZpY2VNZXRyaWNzW3NlcnZpY2VdLnJlZGlzSGl0cysrO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBnZXRDYWNoZU1ldHJpY3Moc2VydmljZTogc3RyaW5nKTogQ2FjaGVNZXRyaWNzIHtcblx0XHRyZXR1cm4gKFxuXHRcdFx0dGhpcy5zZXJ2aWNlTWV0cmljc1tzZXJ2aWNlXSB8fCB7XG5cdFx0XHRcdGNhY2hlSGl0czogMCxcblx0XHRcdFx0Y2FjaGVNaXNzZXM6IDAsXG5cdFx0XHRcdHJlZGlzSGl0czogMFxuXHRcdFx0fVxuXHRcdCk7XG5cdH1cblxuXHRwdWJsaWMgZ2V0TWVtb3J5Q2FjaGUoXG5cdFx0c2VydmljZTogc3RyaW5nXG5cdCk6IE1hcDxzdHJpbmcsIHsgdmFsdWU6IHVua25vd247IGV4cGlyYXRpb246IG51bWJlciB8IHVuZGVmaW5lZCB9PiB8IG51bGwge1xuXHRcdHJldHVybiB0aGlzLm1lbW9yeUNhY2hlLmdldChzZXJ2aWNlKSB8fCBudWxsO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGdldDxUPihrZXk6IHN0cmluZywgc2VydmljZTogc3RyaW5nKTogUHJvbWlzZTxUIHwgbnVsbD4ge1xuXHRcdGNvbnN0IG5hbWVzcGFjZWRLZXkgPSB0aGlzLmdldE5hbWVzcGFjZWRLZXkoc2VydmljZSwga2V5KTtcblxuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCBzZXJ2aWNlTWVtb3J5Q2FjaGUgPSB0aGlzLm1lbW9yeUNhY2hlLmdldChzZXJ2aWNlKTtcblx0XHRcdGlmIChzZXJ2aWNlTWVtb3J5Q2FjaGUpIHtcblx0XHRcdFx0Y29uc3QgbWVtb3J5RW50cnkgPSBzZXJ2aWNlTWVtb3J5Q2FjaGUuZ2V0KG5hbWVzcGFjZWRLZXkpO1xuXHRcdFx0XHRpZiAobWVtb3J5RW50cnkpIHtcblx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRtZW1vcnlFbnRyeS5leHBpcmF0aW9uICYmXG5cdFx0XHRcdFx0XHREYXRlLm5vdygpID4gbWVtb3J5RW50cnkuZXhwaXJhdGlvblxuXHRcdFx0XHRcdCkge1xuXHRcdFx0XHRcdFx0c2VydmljZU1lbW9yeUNhY2hlLmRlbGV0ZShuYW1lc3BhY2VkS2V5KTtcblx0XHRcdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0XHRcdGBNZW1vcnkgY2FjaGUgZXhwaXJlZCBmb3Iga2V5OiAke25hbWVzcGFjZWRLZXl9YFxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0dGhpcy5tZW1vcnlDYWNoZUxSVS5zZXQobmFtZXNwYWNlZEtleSwgRGF0ZS5ub3coKSk7XG5cdFx0XHRcdFx0XHR0aGlzLnVwZGF0ZU1ldHJpY3Moc2VydmljZSwgJ2hpdCcpO1xuXHRcdFx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0XHRcdFx0YE1lbW9yeSBjYWNoZSBoaXQgZm9yIGtleTogJHtuYW1lc3BhY2VkS2V5fWBcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRyZXR1cm4gbWVtb3J5RW50cnkudmFsdWUgYXMgVDtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0dGhpcy51cGRhdGVNZXRyaWNzKHNlcnZpY2UsICdtaXNzJyk7XG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKGBDYWNoZSBtaXNzIGZvciBrZXk6ICR7bmFtZXNwYWNlZEtleX1gKTtcblxuXHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlQ2FjaGVFcnJvcihcblx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdCdDQUNIRV9HRVRfRVJST1InLFxuXHRcdFx0XHR7IGtleSwgc2VydmljZSB9LFxuXHRcdFx0XHRgRXJyb3IgZmV0Y2hpbmcga2V5ICR7bmFtZXNwYWNlZEtleX0gZnJvbSBjYWNoZSBmb3Igc2VydmljZSAke3NlcnZpY2V9YFxuXHRcdFx0KTtcblx0XHRcdHJldHVybiBudWxsO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBzZXQ8VD4oXG5cdFx0a2V5OiBzdHJpbmcsXG5cdFx0dmFsdWU6IFQsXG5cdFx0c2VydmljZTogc3RyaW5nLFxuXHRcdGV4cGlyYXRpb25JblNlY29uZHM/OiBzdHJpbmcgfCBudW1iZXJcblx0KTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgbmFtZXNwYWNlZEtleSA9IHRoaXMuZ2V0TmFtZXNwYWNlZEtleShzZXJ2aWNlLCBrZXkpO1xuXG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IGV4cGlyYXRpb24gPSBleHBpcmF0aW9uSW5TZWNvbmRzXG5cdFx0XHRcdD8gRGF0ZS5ub3coKSArIE51bWJlcihleHBpcmF0aW9uSW5TZWNvbmRzKSAqIDEwMDBcblx0XHRcdFx0OiBEYXRlLm5vdygpICsgdGhpcy5nZXRTZXJ2aWNlVFRMKHNlcnZpY2UpICogMTAwMDtcblxuXHRcdFx0bGV0IHNlcnZpY2VNZW1vcnlDYWNoZSA9IHRoaXMubWVtb3J5Q2FjaGUuZ2V0KHNlcnZpY2UpO1xuXG5cdFx0XHRpZiAoIXNlcnZpY2VNZW1vcnlDYWNoZSkge1xuXHRcdFx0XHRzZXJ2aWNlTWVtb3J5Q2FjaGUgPSBuZXcgTWFwKCk7XG5cdFx0XHRcdHRoaXMubWVtb3J5Q2FjaGUuc2V0KHNlcnZpY2UsIHNlcnZpY2VNZW1vcnlDYWNoZSk7XG5cdFx0XHR9XG5cblx0XHRcdHNlcnZpY2VNZW1vcnlDYWNoZS5zZXQobmFtZXNwYWNlZEtleSwgeyB2YWx1ZSwgZXhwaXJhdGlvbiB9KTtcblx0XHRcdHRoaXMubWVtb3J5Q2FjaGVMUlUuc2V0KG5hbWVzcGFjZWRLZXksIERhdGUubm93KCkpO1xuXG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKFxuXHRcdFx0XHRgS2V5ICR7bmFtZXNwYWNlZEtleX0gc2V0IHdpdGggVFRMICR7XG5cdFx0XHRcdFx0ZXhwaXJhdGlvbkluU2Vjb25kcyB8fCB0aGlzLmdldFNlcnZpY2VUVEwoc2VydmljZSlcblx0XHRcdFx0fSBzZWNvbmRzIGluIGJvdGggbWVtb3J5IGFuZCBSZWRpcyBjYWNoZWBcblx0XHRcdCk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlQ2FjaGVFcnJvcihcblx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdCdDQUNIRV9TRVRfRVJST1InLFxuXHRcdFx0XHR7IGtleSwgc2VydmljZSwgZXhwaXJhdGlvbkluU2Vjb25kcyB9LFxuXHRcdFx0XHRgRXJyb3Igc2V0dGluZyBrZXkgJHtuYW1lc3BhY2VkS2V5fSBpbiBjYWNoZSBmb3Igc2VydmljZSAke3NlcnZpY2V9YFxuXHRcdFx0KTtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgZXhpc3RzKGtleTogc3RyaW5nLCBzZXJ2aWNlOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcblx0XHRjb25zdCBuYW1lc3BhY2VkS2V5ID0gdGhpcy5nZXROYW1lc3BhY2VkS2V5KHNlcnZpY2UsIGtleSk7XG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IHNlcnZpY2VNZW1vcnlDYWNoZSA9IHRoaXMubWVtb3J5Q2FjaGUuZ2V0KHNlcnZpY2UpO1xuXHRcdFx0aWYgKHNlcnZpY2VNZW1vcnlDYWNoZT8uaGFzKG5hbWVzcGFjZWRLZXkpKSB7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0YEtleSAke25hbWVzcGFjZWRLZXl9IGV4aXN0cyBpbiBtZW1vcnkgY2FjaGUsIGNoZWNrZWQgYnkgc2VydmljZSAke3NlcnZpY2V9YFxuXHRcdFx0XHQpO1xuXHRcdFx0XHR0aGlzLnVwZGF0ZU1ldHJpY3Moc2VydmljZSwgJ2hpdCcpO1xuXHRcdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHRcdH1cblxuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0YEtleSAke25hbWVzcGFjZWRLZXl9IGRvZXMgbm90IGV4aXN0IGluIG1lbW9yeSwgY2hlY2tlZCBieSBzZXJ2aWNlICR7c2VydmljZX1gXG5cdFx0XHQpO1xuXHRcdFx0dGhpcy51cGRhdGVNZXRyaWNzKHNlcnZpY2UsICdtaXNzJyk7XG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlQ2FjaGVFcnJvcihcblx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdCdDQUNIRV9FWElTVFNfRVJST1InLFxuXHRcdFx0XHR7IGtleSwgc2VydmljZSB9LFxuXHRcdFx0XHRgRXJyb3IgY2hlY2tpbmcgZXhpc3RlbmNlIG9mIGtleSAke25hbWVzcGFjZWRLZXl9IGZvciBzZXJ2aWNlICR7c2VydmljZX1gXG5cdFx0XHQpO1xuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBkZWwoa2V5OiBzdHJpbmcsIHNlcnZpY2U6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGNvbnN0IG5hbWVzcGFjZWRLZXkgPSB0aGlzLmdldE5hbWVzcGFjZWRLZXkoc2VydmljZSwga2V5KTtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3Qgc2VydmljZU1lbW9yeUNhY2hlID0gdGhpcy5tZW1vcnlDYWNoZS5nZXQoc2VydmljZSk7XG5cdFx0XHRpZiAoc2VydmljZU1lbW9yeUNhY2hlKSB7XG5cdFx0XHRcdHNlcnZpY2VNZW1vcnlDYWNoZS5kZWxldGUobmFtZXNwYWNlZEtleSk7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0YEtleSAke25hbWVzcGFjZWRLZXl9IGRlbGV0ZWQgZnJvbSBtZW1vcnkgY2FjaGUgYnkgc2VydmljZSAke3NlcnZpY2V9YFxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmhhbmRsZUNhY2hlRXJyb3IoXG5cdFx0XHRcdGVycm9yLFxuXHRcdFx0XHQnQ0FDSEVfREVMRVRFX0VSUk9SJyxcblx0XHRcdFx0eyBrZXksIHNlcnZpY2UgfSxcblx0XHRcdFx0YEVycm9yIGRlbGV0aW5nIGtleSAke25hbWVzcGFjZWRLZXl9IGZyb20gY2FjaGUgZm9yIHNlcnZpY2UgJHtzZXJ2aWNlfWBcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIGluY3JlbWVudChcblx0XHRrZXk6IHN0cmluZyxcblx0XHRzZXJ2aWNlOiBzdHJpbmcsXG5cdFx0ZXhwaXJhdGlvbkluU2Vjb25kcz86IG51bWJlclxuXHQpOiBQcm9taXNlPG51bWJlciB8IG51bGw+IHtcblx0XHRjb25zdCBuYW1lc3BhY2VkS2V5ID0gdGhpcy5nZXROYW1lc3BhY2VkS2V5KHNlcnZpY2UsIGtleSk7XG5cblx0XHR0cnkge1xuXHRcdFx0bGV0IHNlcnZpY2VNZW1vcnlDYWNoZSA9IHRoaXMubWVtb3J5Q2FjaGUuZ2V0KHNlcnZpY2UpO1xuXHRcdFx0bGV0IG5ld1ZhbHVlOiBudW1iZXIgfCBudWxsID0gbnVsbDtcblxuXHRcdFx0aWYgKHNlcnZpY2VNZW1vcnlDYWNoZSkge1xuXHRcdFx0XHRjb25zdCBtZW1vcnlFbnRyeSA9IHNlcnZpY2VNZW1vcnlDYWNoZS5nZXQobmFtZXNwYWNlZEtleSk7XG5cdFx0XHRcdGlmIChtZW1vcnlFbnRyeSAmJiB0eXBlb2YgbWVtb3J5RW50cnkudmFsdWUgPT09ICdudW1iZXInKSB7XG5cdFx0XHRcdFx0bWVtb3J5RW50cnkudmFsdWUgKz0gMTtcblx0XHRcdFx0XHRuZXdWYWx1ZSA9IG1lbW9yeUVudHJ5LnZhbHVlO1xuXHRcdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0XHRgTWVtb3J5IGNhY2hlIGluY3JlbWVudGVkIGZvciBrZXk6ICR7bmFtZXNwYWNlZEtleX0gYnkgc2VydmljZTogJHtzZXJ2aWNlfWBcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdGlmICghc2VydmljZU1lbW9yeUNhY2hlIHx8IHR5cGVvZiBuZXdWYWx1ZSAhPT0gJ251bWJlcicpIHtcblx0XHRcdFx0bmV3VmFsdWUgPSAxO1xuXG5cdFx0XHRcdGlmICghc2VydmljZU1lbW9yeUNhY2hlKSB7XG5cdFx0XHRcdFx0c2VydmljZU1lbW9yeUNhY2hlID0gbmV3IE1hcCgpO1xuXHRcdFx0XHRcdHRoaXMubWVtb3J5Q2FjaGUuc2V0KHNlcnZpY2UsIHNlcnZpY2VNZW1vcnlDYWNoZSk7XG5cdFx0XHRcdH1cblx0XHRcdFx0Y29uc3QgZXhwaXJhdGlvbiA9IGV4cGlyYXRpb25JblNlY29uZHNcblx0XHRcdFx0XHQ/IERhdGUubm93KCkgKyBleHBpcmF0aW9uSW5TZWNvbmRzICogMTAwMFxuXHRcdFx0XHRcdDogRGF0ZS5ub3coKSArIHRoaXMuZ2V0U2VydmljZVRUTChzZXJ2aWNlKSAqIDEwMDA7XG5cblx0XHRcdFx0c2VydmljZU1lbW9yeUNhY2hlLnNldChuYW1lc3BhY2VkS2V5LCB7XG5cdFx0XHRcdFx0dmFsdWU6IG5ld1ZhbHVlLFxuXHRcdFx0XHRcdGV4cGlyYXRpb25cblx0XHRcdFx0fSk7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0YEluaXRpYWxpemVkIGluY3JlbWVudGVkIHZhbHVlIGluIG1lbW9yeSBjYWNoZSBmb3Iga2V5OiAke25hbWVzcGFjZWRLZXl9IGJ5IHNlcnZpY2U6ICR7c2VydmljZX1gXG5cdFx0XHRcdCk7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiBuZXdWYWx1ZTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5oYW5kbGVDYWNoZUVycm9yKFxuXHRcdFx0XHRlcnJvcixcblx0XHRcdFx0J0NBQ0hFX0lOQ1JFTUVOVF9FUlJPUicsXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRyZWFzb246IGBDYWNoZSBpbmNyZW1lbnQgZmFpbGVkIGZvciBrZXkgJHtrZXl9YCxcblx0XHRcdFx0XHRrZXk6IGtleSB8fCAndW5rbm93bicsXG5cdFx0XHRcdFx0ZXhwaXJhdGlvbjogZXhwaXJhdGlvbkluU2Vjb25kcyB8fCAndW5rbm93bicsXG5cdFx0XHRcdFx0c2VydmljZTogc2VydmljZSB8fCAndW5rbm93bidcblx0XHRcdFx0fSxcblx0XHRcdFx0YEVycm9yIGluY3JlbWVudGluZyBrZXkgJHtuYW1lc3BhY2VkS2V5fSBpbiBjYWNoZSBmb3Igc2VydmljZSAke3NlcnZpY2V9YFxuXHRcdFx0KTtcblx0XHRcdHJldHVybiBudWxsO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBmbHVzaENhY2hlKHNlcnZpY2U6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCBzZXJ2aWNlTWVtb3J5Q2FjaGUgPSB0aGlzLm1lbW9yeUNhY2hlLmdldChzZXJ2aWNlKTtcblx0XHRcdGlmIChzZXJ2aWNlTWVtb3J5Q2FjaGUpIHtcblx0XHRcdFx0c2VydmljZU1lbW9yeUNhY2hlLmNsZWFyKCk7XG5cdFx0XHRcdHRoaXMubWVtb3J5Q2FjaGUuZGVsZXRlKHNlcnZpY2UpO1xuXHRcdFx0XHR0aGlzLmxvZ2dlci5pbmZvKFxuXHRcdFx0XHRcdGBNZW1vcnkgY2FjaGUgZmx1c2hlZCBmb3Igc2VydmljZTogJHtzZXJ2aWNlfWBcblx0XHRcdFx0KTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLndhcm4oXG5cdFx0XHRcdFx0YE5vIG1lbW9yeSBjYWNoZSBmb3VuZCBmb3Igc2VydmljZTogJHtzZXJ2aWNlfWBcblx0XHRcdFx0KTtcblx0XHRcdH1cblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5oYW5kbGVDYWNoZUVycm9yKFxuXHRcdFx0XHRlcnJvcixcblx0XHRcdFx0J0NBQ0hFX0ZMVVNIX0VSUk9SJyxcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHJlYXNvbjogYENhY2hlIGZsdXNoIGZhaWxlZCBmb3Igc2VydmljZSAke3NlcnZpY2V9YCxcblx0XHRcdFx0XHRzZXJ2aWNlOiBzZXJ2aWNlIHx8ICd1bmtub3duJ1xuXHRcdFx0XHR9LFxuXHRcdFx0XHRgRXJyb3IgZmx1c2hpbmcgY2FjaGUgZm9yIHNlcnZpY2UgJHtzZXJ2aWNlfWBcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGNsZWFudXBFeHBpcmVkRW50cmllcygpOiB2b2lkIHtcblx0XHR3aXRoUmV0cnkoXG5cdFx0XHQoKSA9PiB7XG5cdFx0XHRcdGZvciAoY29uc3QgW3NlcnZpY2UsIGNhY2hlXSBvZiB0aGlzLm1lbW9yeUNhY2hlLmVudHJpZXMoKSkge1xuXHRcdFx0XHRcdGZvciAoY29uc3QgW2tleSwgeyBleHBpcmF0aW9uIH1dIG9mIGNhY2hlLmVudHJpZXMoKSkge1xuXHRcdFx0XHRcdFx0aWYgKGV4cGlyYXRpb24gJiYgRGF0ZS5ub3coKSA+IGV4cGlyYXRpb24pIHtcblx0XHRcdFx0XHRcdFx0Y2FjaGUuZGVsZXRlKGtleSk7XG5cdFx0XHRcdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0XHRcdFx0YEV4cGlyZWQgbWVtb3J5IGNhY2hlIGVudHJ5IHJlbW92ZWQgZm9yIGtleTogJHtrZXl9IGZyb20gc2VydmljZTogJHtzZXJ2aWNlfWBcblx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH0sXG5cdFx0XHQzLFxuXHRcdFx0MTAwMFxuXHRcdCkuY2F0Y2goZXJyb3IgPT4ge1xuXHRcdFx0dGhpcy5sb2dnZXIuZXJyb3IoXG5cdFx0XHRcdGBFcnJvciBjbGVhbmluZyB1cCBleHBpcmVkIG1lbW9yeSBjYWNoZSBlbnRyaWVzIGFmdGVyIHJldHJpZXM6ICR7ZXJyb3J9YFxuXHRcdFx0KTtcblx0XHR9KTtcblx0fVxuXG5cdHB1YmxpYyBhc3luYyBjbGVhck5hbWVzcGFjZShzZXJ2aWNlOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3Qgc2VydmljZU1lbW9yeUNhY2hlID0gdGhpcy5tZW1vcnlDYWNoZS5nZXQoc2VydmljZSk7XG5cblx0XHRcdGlmIChzZXJ2aWNlTWVtb3J5Q2FjaGUpIHtcblx0XHRcdFx0c2VydmljZU1lbW9yeUNhY2hlLmNsZWFyKCk7XG5cdFx0XHRcdHRoaXMubWVtb3J5Q2FjaGUuZGVsZXRlKHNlcnZpY2UpO1xuXHRcdFx0XHR0aGlzLmxvZ2dlci5pbmZvKFxuXHRcdFx0XHRcdGBNZW1vcnkgY2FjaGUgY2xlYXJlZCBmb3Igc2VydmljZTogJHtzZXJ2aWNlfWBcblx0XHRcdFx0KTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLndhcm4oXG5cdFx0XHRcdFx0YE5vIG1lbW9yeSBjYWNoZSBmb3VuZCBmb3Igc2VydmljZTogJHtzZXJ2aWNlfWBcblx0XHRcdFx0KTtcblx0XHRcdH1cblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5oYW5kbGVDYWNoZUVycm9yKFxuXHRcdFx0XHRlcnJvcixcblx0XHRcdFx0J0NBQ0hFX0NMRUFSX05BTUVTUEFDRV9FUlJPUicsXG5cdFx0XHRcdHsgc2VydmljZSB9LFxuXHRcdFx0XHRgRXJyb3IgY2xlYXJpbmcgY2FjaGUgZm9yIHNlcnZpY2UgJHtzZXJ2aWNlfWBcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIGNsb3NlQ29ubmVjdGlvbigpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHR0cnkge1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0J05vIGNvbm5lY3Rpb24gdG8gY2xvc2UgZm9yIG1lbW9yeSBjYWNoZSAqKExBWUVSIDIgTk9UIElNUExFTUVOVEVEJ1xuXHRcdFx0KTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5oYW5kbGVDYWNoZUVycm9yKFxuXHRcdFx0XHRlcnJvcixcblx0XHRcdFx0J0NBQ0hFX0NMT1NFX0NPTk5FQ1RJT05fRVJST1InLFxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmVhc29uOiBgQ2FjaGUgY29ubmVjdGlvbiBjbG9zZSBmYWlsZWRgXG5cdFx0XHRcdH0sXG5cdFx0XHRcdGBFcnJvciBjbG9zaW5nIGNhY2hlIGNvbm5lY3Rpb25gXG5cdFx0XHQpO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBzaHV0ZG93bigpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHR0cnkge1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnQ2xlYXJpbmcgbWVtb3J5IGNhY2hlIGluIENhY2hlIFNlcnZpY2UuLi4nKTtcblxuXHRcdFx0dGhpcy5tZW1vcnlDYWNoZS5jbGVhcigpO1xuXHRcdFx0dGhpcy5tZW1vcnlDYWNoZUxSVS5jbGVhcigpO1xuXG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdNZW1vcnkgY2FjaGUgY2xlYXJlZCBzdWNjZXNzZnVsbHkuJyk7XG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdDYWNoZSBzZXJ2aWNlIHNodXRkb3duIGNvbXBsZXRlZC4nKTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5oYW5kbGVDYWNoZUVycm9yKFxuXHRcdFx0XHRlcnJvcixcblx0XHRcdFx0J0NBQ0hFX1NIVVRET1dOX0VSUk9SJyxcblx0XHRcdFx0e30sXG5cdFx0XHRcdGBFcnJvciBzaHV0dGluZyBkb3duIENhY2hlIFNlcnZpY2VgXG5cdFx0XHQpO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgaGFuZGxlQ2FjaGVFcnJvcihcblx0XHRlcnJvcjogdW5rbm93bixcblx0XHRlcnJvckhlYWRlcjogc3RyaW5nLFxuXHRcdGVycm9yRGV0YWlsczogb2JqZWN0LFxuXHRcdGN1c3RvbU1lc3NhZ2U6IHN0cmluZ1xuXHQpOiB2b2lkIHtcblx0XHRjb25zdCBlcnJvck1lc3NhZ2UgPSBgJHtjdXN0b21NZXNzYWdlfTogJHtlcnJvcn1cXG4ke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5zdGFjayA6ICcnfWA7XG5cdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcihlcnJvck1lc3NhZ2UpO1xuXG5cdFx0Y29uc3QgY2FjaGVFcnJvciA9IG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuQ2FjaGVTZXJ2aWNlRXJyb3IoXG5cdFx0XHRlcnJvckhlYWRlcixcblx0XHRcdHtcblx0XHRcdFx0ZGV0YWlsczogZXJyb3JEZXRhaWxzLFxuXHRcdFx0XHRleHBvc2VUb0NsaWVudDogZmFsc2Vcblx0XHRcdH1cblx0XHQpO1xuXG5cdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3Ioe1xuXHRcdFx0ZXJyb3I6IGNhY2hlRXJyb3Jcblx0XHR9KTtcblx0fVxufVxuIl19
