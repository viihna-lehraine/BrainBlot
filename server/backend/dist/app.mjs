import process from 'process';
import { login } from './admin.mjs';
import { ServiceFactory } from './index/factory/ServiceFactory.mjs';
import { VaultService } from './services/Vault.mjs';
let logger;
async function start() {
	try {
		return login()
			.then(async ({ encryptionKey, gpgPassphrase, adminId }) => {
				if (!encryptionKey || !gpgPassphrase || !adminId) {
					throw new Error(
						'Keys or Admin ID not found. Shutting down...'
					);
				}
				const logger = await ServiceFactory.getLoggerService();
				const errorLogger =
					await ServiceFactory.getErrorLoggerService();
				logger.setAdminId(adminId);
				const errorHandler =
					await ServiceFactory.getErrorHandlerService();
				logger.setErrorHandler(errorHandler);
				const envConfig = await ServiceFactory.getEnvConfigService();
				const vault = await VaultService.initialize(
					encryptionKey,
					gpgPassphrase
				);
				setInterval(
					() => vault.clearExpiredSecretsFromMemory(),
					envConfig.getEnvVariable('clearExpiredSecretsInterval')
				);
				setInterval(
					() => vault.batchClearSecrets(),
					envConfig.getEnvVariable('batchReEncryptSecretsInterval')
				);
				logger.info(
					'Secrets store initialized. READY TO ROCK AND ROLL!!!'
				);
				return { envConfig, errorLogger, errorHandler, logger, vault };
			})
			.then(async () => {
				const middlewareStatusService =
					await ServiceFactory.getMiddlewareStatusService();
				return middlewareStatusService;
			})
			.then(async () => {
				const rootMiddleware =
					await ServiceFactory.getRootMiddlewareService();
				rootMiddleware.initialize();
				return rootMiddleware;
			})
			.then(async () => {
				const databaseController =
					await ServiceFactory.getDatabaseController();
				databaseController.initialize();
				return databaseController;
			})
			.then(async () => {
				const cacheService = await ServiceFactory.getCacheService();
				return cacheService;
			})
			.then(async () => {
				const gatekeeper = await ServiceFactory.getGatekeeperService();
				return gatekeeper.initialize();
			})
			.then(async () => {
				const accessControl =
					await ServiceFactory.getAccessControlMiddlewareService();
				return accessControl;
			})
			.then(async () => {
				const baseRouter = await ServiceFactory.getBaseRouter();
				return baseRouter;
			})
			.then(async () => {
				const userController = await ServiceFactory.getUserController();
				return userController;
			})
			.then(async () => {
				const authController = await ServiceFactory.getAuthController();
				return authController;
			})
			.then(async () => {
				const [
					backupCodeService,
					emailMFAService,
					fido2Service,
					jwtService,
					passwordService,
					totpService,
					yubicoOTPService
				] = await Promise.all([
					ServiceFactory.getBackupCodeService(),
					ServiceFactory.getEmailMFAService(),
					ServiceFactory.getFIDO2Service(),
					ServiceFactory.getJWTService(),
					ServiceFactory.getPasswordService(),
					ServiceFactory.getTOTPService(),
					ServiceFactory.getYubicoOTPService()
				]);
				return {
					backupCodeService,
					emailMFAService,
					fido2Service,
					jwtService,
					passwordService,
					totpService,
					yubicoOTPService
				};
			})
			.then(async () => {
				await ServiceFactory.getPassportService();
			})
			.then(async () => {
				const [
					csrfMiddleware,
					helmetMiddleware,
					jwtAuthMiddleware,
					passportAuthMiddleware
				] = await Promise.all([
					ServiceFactory.getCSRFMiddlewareService(),
					ServiceFactory.getHelmetMiddlewareService(),
					ServiceFactory.getJWTAuthMiddlewareService(),
					ServiceFactory.getPassportAuthMiddlewareService()
				]);
				return {
					csrfMiddleware,
					helmetMiddleware,
					jwtAuthMiddleware,
					passportAuthMiddleware
				};
			})
			.then(async () => {
				const [mailerService, multerUploadService] = await Promise.all([
					ServiceFactory.getMailerService(),
					ServiceFactory.getMulterUploadService()
				]);
				return {
					mailerService,
					multerUploadService
				};
			})
			.then(async () => {
				const httpsServer = await ServiceFactory.getHTTPSServer();
				return httpsServer.startServer();
			})
			.then(async () => {
				const resourceManager =
					await ServiceFactory.getResourceManager();
				return resourceManager;
			})
			.then(async () => {
				const healthCheckService =
					await ServiceFactory.getHealthCheckService();
				return healthCheckService;
			})
			.then(async () => {
				logger.info('All services initialized successfully.');
			})
			.catch(error => {
				const fallbackLogger = logger;
				if (!fallbackLogger) {
					console.error(
						`Critical error occurred during startup\n${error instanceof Error ? error.message : String(error)}`
					);
					process.exit(1);
				} else {
					fallbackLogger.error(
						`Critical error occurred during startup\n${error instanceof Error ? error.message : String(error)}`
					);
					process.exit(1);
				}
			});
	} catch (error) {
		const fallbackLogger = await ServiceFactory.getLoggerService();
		if (!fallbackLogger) {
			console.error(
				`Critical error occurred during startup\n${error instanceof Error ? error.message : String(error)}`
			);
			process.exit(1);
		} else {
			fallbackLogger.logError(
				`Critical error occurred during startup\n${error instanceof Error ? error.message : String(error)}`
			);
			process.exit(1);
		}
	}
}
await start();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2FwcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLE9BQU8sTUFBTSxTQUFTLENBQUM7QUFDOUIsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNoQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDaEUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBR2hELElBQUksTUFBaUMsQ0FBQztBQUV0QyxLQUFLLFVBQVUsS0FBSztJQUNuQixJQUFJLENBQUM7UUFDSixPQUFPLEtBQUssRUFBRTthQUNaLElBQUksQ0FBQyxLQUFLLEVBQUUsRUFBRSxhQUFhLEVBQUUsYUFBYSxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUU7WUFDekQsSUFBSSxDQUFDLGFBQWEsSUFBSSxDQUFDLGFBQWEsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNsRCxNQUFNLElBQUksS0FBSyxDQUNkLDhDQUE4QyxDQUM5QyxDQUFDO1lBQ0gsQ0FBQztZQUVELE1BQU0sTUFBTSxHQUFHLE1BQU0sY0FBYyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDdkQsTUFBTSxXQUFXLEdBQ2hCLE1BQU0sY0FBYyxDQUFDLHFCQUFxQixFQUFFLENBQUM7WUFFOUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUUzQixNQUFNLFlBQVksR0FDakIsTUFBTSxjQUFjLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztZQUUvQyxNQUFNLENBQUMsZUFBZSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBRXJDLE1BQU0sU0FBUyxHQUFHLE1BQU0sY0FBYyxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFFN0QsTUFBTSxLQUFLLEdBQUcsTUFBTSxZQUFZLENBQUMsVUFBVSxDQUMxQyxhQUFhLEVBQ2IsYUFBYSxDQUNiLENBQUM7WUFFRixXQUFXLENBQ1Ys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LEtBQUssRUFBRSxDQUFDO1FBQ2hCLE1BQU0sY0FBYyxHQUFHLE1BQU0sY0FBYyxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDL0QsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3JCLE9BQU8sQ0FBQyxLQUFLLENBQ1osMkNBQTJDLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUNuRyxDQUFDO1lBQ0YsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqQixDQUFDO2FBQU0sQ0FBQztZQUNQLGNBQWMsQ0FBQyxRQUFRLENBQ3RCLDJDQUEyQyxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FDbkcsQ0FBQztZQUNGLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDakIsQ0FBQztJQUNGLENBQUM7QUFDRixDQUFDO0FBRUQsTUFBTSxLQUFLLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwcm9jZXNzIGZyb20gJ3Byb2Nlc3MnO1xuaW1wb3J0IHsgbG9naW4gfSBmcm9tICcuL2FkbWluJztcbmltcG9ydCB7IFNlcnZpY2VGYWN0b3J5IH0gZnJvbSAnLi9pbmRleC9mYWN0b3J5L1NlcnZpY2VGYWN0b3J5JztcbmltcG9ydCB7IFZhdWx0U2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvVmF1bHQnO1xuaW1wb3J0IHsgQXBwTG9nZ2VyU2VydmljZUludGVyZmFjZSB9IGZyb20gJy4vaW5kZXgvaW50ZXJmYWNlcy9tYWluJztcblxubGV0IGxvZ2dlcjogQXBwTG9nZ2VyU2VydmljZUludGVyZmFjZTtcblxuYXN5bmMgZnVuY3Rpb24gc3RhcnQoKTogUHJvbWlzZTx2b2lkPiB7XG5cdHRyeSB7XG5cdFx0cmV0dXJuIGxvZ2luKClcblx0XHRcdC50aGVuKGFzeW5jICh7IGVuY3J5cHRpb25LZXksIGdwZ1Bhc3NwaHJhc2UsIGFkbWluSWQgfSkgPT4ge1xuXHRcdFx0XHRpZiAoIWVuY3J5cHRpb25LZXkgfHwgIWdwZ1Bhc3NwaHJhc2UgfHwgIWFkbWluSWQpIHtcblx0XHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoXG5cdFx0XHRcdFx0XHQnS2V5cyBvciBBZG1pbiBJRCBub3QgZm91bmQuIFNodXR0aW5nIGRvd24uLi4nXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGNvbnN0IGxvZ2dlciA9IGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldExvZ2dlclNlcnZpY2UoKTtcblx0XHRcdFx0Y29uc3QgZXJyb3JMb2dnZXIgPVxuXHRcdFx0XHRcdGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldEVycm9yTG9nZ2VyU2VydmljZSgpO1xuXG5cdFx0XHRcdGxvZ2dlci5zZXRBZG1pbklkKGFkbWluSWQpO1xuXG5cdFx0XHRcdGNvbnN0IGVycm9ySGFuZGxlciA9XG5cdFx0XHRcdFx0YXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0RXJyb3JIYW5kbGVyU2VydmljZSgpO1xuXG5cdFx0XHRcdGxvZ2dlci5zZXRFcnJvckhhbmRsZXIoZXJyb3JIYW5kbGVyKTtcblxuXHRcdFx0XHRjb25zdCBlbnZDb25maWcgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRFbnZDb25maWdTZXJ2aWNlKCk7XG5cblx0XHRcdFx0Y29uc3QgdmF1bHQgPSBhd2FpdCBWYXVsdFNlcnZpY2UuaW5pdGlhbGl6ZShcblx0XHRcdFx0XHRlbmNyeXB0aW9uS2V5LFxuXHRcdFx0XHRcdGdwZ1Bhc3NwaHJhc2Vcblx0XHRcdFx0KTtcblxuXHRcdFx0XHRzZXRJbnRlcnZhbChcblx0XHRcdFx0XHQoKSA9PiB2YXVsdC5jbGVhckV4cGlyZWRTZWNyZXRzRnJvbU1lbW9yeSgpLFxuXHRcdFx0XHRcdGVudkNvbmZpZy5nZXRFbnZWYXJpYWJsZSgnY2xlYXJFeHBpcmVkU2VjcmV0c0ludGVydmFsJylcblx0XHRcdFx0KTtcblx0XHRcdFx0c2V0SW50ZXJ2YWwoXG5cdFx0XHRcdFx0KCkgPT4gdmF1bHQuYmF0Y2hDbGVhclNlY3JldHMoKSxcblx0XHRcdFx0XHRlbnZDb25maWcuZ2V0RW52VmFyaWFibGUoJ2JhdGNoUmVFbmNyeXB0U2VjcmV0c0ludGVydmFsJylcblx0XHRcdFx0KTtcblxuXHRcdFx0XHRsb2dnZXIuaW5mbyhcblx0XHRcdFx0XHQnU2VjcmV0cyBzdG9yZSBpbml0aWFsaXplZC4gUkVBRFkgVE8gUk9DSyBBTkQgUk9MTCEhISdcblx0XHRcdFx0KTtcblx0XHRcdFx0cmV0dXJuIHsgZW52Q29uZmlnLCBlcnJvckxvZ2dlciwgZXJyb3JIYW5kbGVyLCBsb2dnZXIsIHZhdWx0IH07XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oYXN5bmMgKCkgPT4ge1xuXHRcdFx0XHRjb25zdCBtaWRkbGV3YXJlU3RhdHVzU2VydmljZSA9XG5cdFx0XHRcdFx0YXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0TWlkZGxld2FyZVN0YXR1c1NlcnZpY2UoKTtcblx0XHRcdFx0cmV0dXJuIG1pZGRsZXdhcmVTdGF0dXNTZXJ2aWNlO1xuXHRcdFx0fSlcblx0XHRcdC50aGVuKGFzeW5jICgpID0+IHtcblx0XHRcdFx0Y29uc3Qgcm9vdE1pZGRsZXdhcmUgPVxuXHRcdFx0XHRcdGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldFJvb3RNaWRkbGV3YXJlU2VydmljZSgpO1xuXHRcdFx0XHRyb290TWlkZGxld2FyZS5pbml0aWFsaXplKCk7XG5cdFx0XHRcdHJldHVybiByb290TWlkZGxld2FyZTtcblx0XHRcdH0pXG5cdFx0XHQudGhlbihhc3luYyAoKSA9PiB7XG5cdFx0XHRcdGNvbnN0IGRhdGFiYXNlQ29udHJvbGxlciA9XG5cdFx0XHRcdFx0YXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0RGF0YWJhc2VDb250cm9sbGVyKCk7XG5cdFx0XHRcdGRhdGFiYXNlQ29udHJvbGxlci5pbml0aWFsaXplKCk7XG5cdFx0XHRcdHJldHVybiBkYXRhYmFzZUNvbnRyb2xsZXI7XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oYXN5bmMgKCkgPT4ge1xuXHRcdFx0XHRjb25zdCBjYWNoZVNlcnZpY2UgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRDYWNoZVNlcnZpY2UoKTtcblx0XHRcdFx0cmV0dXJuIGNhY2hlU2VydmljZTtcblx0XHRcdH0pXG5cdFx0XHQudGhlbihhc3luYyAoKSA9PiB7XG5cdFx0XHRcdGNvbnN0IGdhdGVrZWVwZXIgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRHYXRla2VlcGVyU2VydmljZSgpO1xuXHRcdFx0XHRyZXR1cm4gZ2F0ZWtlZXBlci5pbml0aWFsaXplKCk7XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oYXN5bmMgKCkgPT4ge1xuXHRcdFx0XHRjb25zdCBhY2Nlc3NDb250cm9sID1cblx0XHRcdFx0XHRhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRBY2Nlc3NDb250cm9sTWlkZGxld2FyZVNlcnZpY2UoKTtcblx0XHRcdFx0cmV0dXJuIGFjY2Vzc0NvbnRyb2w7XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oYXN5bmMgKCkgPT4ge1xuXHRcdFx0XHRjb25zdCBiYXNlUm91dGVyID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0QmFzZVJvdXRlcigpO1xuXHRcdFx0XHRyZXR1cm4gYmFzZVJvdXRlcjtcblx0XHRcdH0pXG5cdFx0XHQudGhlbihhc3luYyAoKSA9PiB7XG5cdFx0XHRcdGNvbnN0IHVzZXJDb250cm9sbGVyID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0VXNlckNvbnRyb2xsZXIoKTtcblx0XHRcdFx0cmV0dXJuIHVzZXJDb250cm9sbGVyO1xuXHRcdFx0fSlcblx0XHRcdC50aGVuKGFzeW5jICgpID0+IHtcblx0XHRcdFx0Y29uc3QgYXV0aENvbnRyb2xsZXIgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRBdXRoQ29udHJvbGxlcigpO1xuXHRcdFx0XHRyZXR1cm4gYXV0aENvbnRyb2xsZXI7XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oYXN5bmMgKCkgPT4ge1xuXHRcdFx0XHRjb25zdCBbXG5cdFx0XHRcdFx0YmFja3VwQ29kZVNlcnZpY2UsXG5cdFx0XHRcdFx0ZW1haWxNRkFTZXJ2aWNlLFxuXHRcdFx0XHRcdGZpZG8yU2VydmljZSxcblx0XHRcdFx0XHRqd3RTZXJ2aWNlLFxuXHRcdFx0XHRcdHBhc3N3b3JkU2VydmljZSxcblx0XHRcdFx0XHR0b3RwU2VydmljZSxcblx0XHRcdFx0XHR5dWJpY29PVFBTZXJ2aWNlXG5cdFx0XHRcdF0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG5cdFx0XHRcdFx0U2VydmljZUZhY3RvcnkuZ2V0QmFja3VwQ29kZVNlcnZpY2UoKSxcblx0XHRcdFx0XHRTZXJ2aWNlRmFjdG9yeS5nZXRFbWFpbE1GQVNlcnZpY2UoKSxcblx0XHRcdFx0XHRTZXJ2aWNlRmFjdG9yeS5nZXRGSURPMlNlcnZpY2UoKSxcblx0XHRcdFx0XHRTZXJ2aWNlRmFjdG9yeS5nZXRKV1RTZXJ2aWNlKCksXG5cdFx0XHRcdFx0U2VydmljZUZhY3RvcnkuZ2V0UGFzc3dvcmRTZXJ2aWNlKCksXG5cdFx0XHRcdFx0U2VydmljZUZhY3RvcnkuZ2V0VE9UUFNlcnZpY2UoKSxcblx0XHRcdFx0XHRTZXJ2aWNlRmFjdG9yeS5nZXRZdWJpY29PVFBTZXJ2aWNlKClcblx0XHRcdFx0XSk7XG5cdFx0XHRcdHJldHVybiB7XG5cdFx0XHRcdFx0YmFja3VwQ29kZVNlcnZpY2UsXG5cdFx0XHRcdFx0ZW1haWxNRkFTZXJ2aWNlLFxuXHRcdFx0XHRcdGZpZG8yU2VydmljZSxcblx0XHRcdFx0XHRqd3RTZXJ2aWNlLFxuXHRcdFx0XHRcdHBhc3N3b3JkU2VydmljZSxcblx0XHRcdFx0XHR0b3RwU2VydmljZSxcblx0XHRcdFx0XHR5dWJpY29PVFBTZXJ2aWNlXG5cdFx0XHRcdH07XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oYXN5bmMgKCkgPT4ge1xuXHRcdFx0XHRhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRQYXNzcG9ydFNlcnZpY2UoKTtcblx0XHRcdH0pXG5cdFx0XHQudGhlbihhc3luYyAoKSA9PiB7XG5cdFx0XHRcdGNvbnN0IFtcblx0XHRcdFx0XHRjc3JmTWlkZGxld2FyZSxcblx0XHRcdFx0XHRoZWxtZXRNaWRkbGV3YXJlLFxuXHRcdFx0XHRcdGp3dEF1dGhNaWRkbGV3YXJlLFxuXHRcdFx0XHRcdHBhc3Nwb3J0QXV0aE1pZGRsZXdhcmVcblx0XHRcdFx0XSA9IGF3YWl0IFByb21pc2UuYWxsKFtcblx0XHRcdFx0XHRTZXJ2aWNlRmFjdG9yeS5nZXRDU1JGTWlkZGxld2FyZVNlcnZpY2UoKSxcblx0XHRcdFx0XHRTZXJ2aWNlRmFjdG9yeS5nZXRIZWxtZXRNaWRkbGV3YXJlU2VydmljZSgpLFxuXHRcdFx0XHRcdFNlcnZpY2VGYWN0b3J5LmdldEpXVEF1dGhNaWRkbGV3YXJlU2VydmljZSgpLFxuXHRcdFx0XHRcdFNlcnZpY2VGYWN0b3J5LmdldFBhc3Nwb3J0QXV0aE1pZGRsZXdhcmVTZXJ2aWNlKClcblx0XHRcdFx0XSk7XG5cdFx0XHRcdHJldHVybiB7XG5cdFx0XHRcdFx0Y3NyZk1pZGRsZXdhcmUsXG5cdFx0XHRcdFx0aGVsbWV0TWlkZGxld2FyZSxcblx0XHRcdFx0XHRqd3RBdXRoTWlkZGxld2FyZSxcblx0XHRcdFx0XHRwYXNzcG9ydEF1dGhNaWRkbGV3YXJlXG5cdFx0XHRcdH07XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oYXN5bmMgKCkgPT4ge1xuXHRcdFx0XHRjb25zdCBbbWFpbGVyU2VydmljZSwgbXVsdGVyVXBsb2FkU2VydmljZV0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG5cdFx0XHRcdFx0U2VydmljZUZhY3RvcnkuZ2V0TWFpbGVyU2VydmljZSgpLFxuXHRcdFx0XHRcdFNlcnZpY2VGYWN0b3J5LmdldE11bHRlclVwbG9hZFNlcnZpY2UoKVxuXHRcdFx0XHRdKTtcblx0XHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0XHRtYWlsZXJTZXJ2aWNlLFxuXHRcdFx0XHRcdG11bHRlclVwbG9hZFNlcnZpY2Vcblx0XHRcdFx0fTtcblx0XHRcdH0pXG5cdFx0XHQudGhlbihhc3luYyAoKSA9PiB7XG5cdFx0XHRcdGNvbnN0IGh0dHBzU2VydmVyID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0SFRUUFNTZXJ2ZXIoKTtcblx0XHRcdFx0cmV0dXJuIGh0dHBzU2VydmVyLnN0YXJ0U2VydmVyKCk7XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oYXN5bmMgKCkgPT4ge1xuXHRcdFx0XHRjb25zdCByZXNvdXJjZU1hbmFnZXIgPVxuXHRcdFx0XHRcdGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldFJlc291cmNlTWFuYWdlcigpO1xuXHRcdFx0XHRyZXR1cm4gcmVzb3VyY2VNYW5hZ2VyO1xuXHRcdFx0fSlcblx0XHRcdC50aGVuKGFzeW5jICgpID0+IHtcblx0XHRcdFx0Y29uc3QgaGVhbHRoQ2hlY2tTZXJ2aWNlID1cblx0XHRcdFx0XHRhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRIZWFsdGhDaGVja1NlcnZpY2UoKTtcblx0XHRcdFx0cmV0dXJuIGhlYWx0aENoZWNrU2VydmljZTtcblx0XHRcdH0pXG5cdFx0XHQudGhlbihhc3luYyAoKSA9PiB7XG5cdFx0XHRcdGxvZ2dlci5pbmZvKCdBbGwgc2VydmljZXMgaW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5LicpO1xuXHRcdFx0fSlcblx0XHRcdC5jYXRjaChlcnJvciA9PiB7XG5cdFx0XHRcdGNvbnN0IGZhbGxiYWNrTG9nZ2VyID0gbG9nZ2VyO1xuXHRcdFx0XHRpZiAoIWZhbGxiYWNrTG9nZ2VyKSB7XG5cdFx0XHRcdFx0Y29uc29sZS5lcnJvcihcblx0XHRcdFx0XHRcdGBDcml0aWNhbCBlcnJvciBvY2N1cnJlZCBkdXJpbmcgc3RhcnR1cFxcbiR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWBcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdHByb2Nlc3MuZXhpdCgxKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRmYWxsYmFja0xvZ2dlci5lcnJvcihcblx0XHRcdFx0XHRcdGBDcml0aWNhbCBlcnJvciBvY2N1cnJlZCBkdXJpbmcgc3RhcnR1cFxcbiR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWBcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdHByb2Nlc3MuZXhpdCgxKTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0Y29uc3QgZmFsbGJhY2tMb2dnZXIgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRMb2dnZXJTZXJ2aWNlKCk7XG5cdFx0aWYgKCFmYWxsYmFja0xvZ2dlcikge1xuXHRcdFx0Y29uc29sZS5lcnJvcihcblx0XHRcdFx0YENyaXRpY2FsIGVycm9yIG9jY3VycmVkIGR1cmluZyBzdGFydHVwXFxuJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YFxuXHRcdFx0KTtcblx0XHRcdHByb2Nlc3MuZXhpdCgxKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0ZmFsbGJhY2tMb2dnZXIubG9nRXJyb3IoXG5cdFx0XHRcdGBDcml0aWNhbCBlcnJvciBvY2N1cnJlZCBkdXJpbmcgc3RhcnR1cFxcbiR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWBcblx0XHRcdCk7XG5cdFx0XHRwcm9jZXNzLmV4aXQoMSk7XG5cdFx0fVxuXHR9XG59XG5cbmF3YWl0IHN0YXJ0KCk7XG4iXX0=
