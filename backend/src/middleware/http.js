import { __awaiter } from 'tslib';
import express from 'express';
import { constants } from 'crypto';
import fs from 'fs';
import http2 from 'http2';
import createHttp2ExpressBridge from 'http2-express-bridge';
import https from 'https';
import featureFlags from '../config/featureFlags.js';
import setupLogger from './logger.js';
export function setupHttp(app) {
	// Create HTTP/2 compatible Express app
	const http2App = createHttp2ExpressBridge(express);
	// Use the existing Express app as middleware for the HTTP/2 compatible app
	http2App.use(app);
	function startHttp1Server() {
		return __awaiter(this, void 0, void 0, function* () {
			let logger = yield setupLogger();
			let keyPath = process.env.SERVER_SSL_KEY_PATH;
			let certPath = process.env.SERVER_SSL_CERT_PATH;
			let options = {
				key: fs.readFileSync(keyPath),
				cert: fs.readFileSync(certPath),
				allowHTTP1: true,
				secureOptions:
					constants.SSL_OP_NO_TLSv1 | constants.SSL_OP_NO_TLSv1_1,
				ciphers: [
					'ECDHE-ECDSA-AES256-GCM-SHA384',
					'ECDHE-RSA-AES256-GCM-SHA384',
					'ECDHE-ECDSA-CHACHA20-POLY1305',
					'ECDHE-RSA-CHACHA20-POLY1305',
					'ECDHE-ECDSA-AES128-GCM-SHA256',
					'ECDHE-RSA-AES128-GCM-SHA256',
					'ECDHE-ECDSA-AES256-SHA384',
					'ECDHE-RSA-AES256-SHA384',
					'ECDHE-ECDSA-AES128-SHA256',
					'ECDHE-RSA-AES128-SHA256'
				].join(':'),
				honorCipherOrder: true
			};
			https
				.createServer(options, app)
				.listen(process.env.SERVER_PORT, () => {
					logger.info(
						`Server running on port ${process.env.SERVER_PORT}`
					);
				});
		});
	}
	function startHttp2Server() {
		return __awaiter(this, void 0, void 0, function* () {
			let logger = yield setupLogger();
			let keyPath = process.env.SERVER_SSL_KEY_PATH;
			let certPath = process.env.SERVER_SSL_CERT_PATH;
			let options = {
				key: fs.readFileSync(keyPath),
				cert: fs.readFileSync(certPath),
				allowHTTP1: true,
				secureOptions:
					constants.SSL_OP_NO_TLSv1 | constants.SSL_OP_NO_TLSv1_1,
				ciphers: [
					'ECDHE-ECDSA-AES256-GCM-SHA384',
					'ECDHE-RSA-AES256-GCM-SHA384',
					'ECDHE-ECDSA-CHACHA20-POLY1305',
					'ECDHE-RSA-CHACHA20-POLY1305',
					'ECDHE-ECDSA-AES128-GCM-SHA256',
					'ECDHE-RSA-AES128-GCM-SHA256',
					'ECDHE-ECDSA-AES256-SHA384',
					'ECDHE-RSA-AES256-SHA384',
					'ECDHE-ECDSA-AES128-SHA256',
					'ECDHE-RSA-AES128-SHA256'
				].join(':'),
				honorCipherOrder: true
			};
			http2
				.createSecureServer(options, app)
				.listen(process.env.SERVER_PORT, () => {
					logger.info(
						`Server running on port ${process.env.SERVER_PORT}`
					);
				});
		});
	}
	function startServer() {
		return __awaiter(this, void 0, void 0, function* () {
			// Ensure this function is exported
			let logger = yield setupLogger();
			if (featureFlags.http2Flag && !featureFlags.http1Flag) {
				logger.info('Starting server with HTTP/2');
				yield startHttp2Server();
			} else if (featureFlags.http1Flag && !featureFlags.http2Flag) {
				logger.info('Starting server with HTTP/1.1');
				yield startHttp1Server();
			} else {
				logger.error(
					'HTTP1 / HTTP2 flags not correctly set. Please check backend .env file'
				);
				throw new Error(
					'HTTP1 / HTTP2 flags not correctly set. Please check backend .env file'
				);
			}
		});
	}
	return { startServer };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3RzL21pZGRsZXdhcmUvaHR0cC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxPQUF3QixNQUFNLFNBQVMsQ0FBQztBQUMvQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQ25DLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQztBQUNwQixPQUFPLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDMUIsT0FBTyx3QkFBd0IsTUFBTSxzQkFBc0IsQ0FBQztBQUM1RCxPQUFPLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDMUIsT0FBTyxZQUFZLE1BQU0sd0JBQXdCLENBQUM7QUFDbEQsT0FBTyxXQUFXLE1BQU0sVUFBVSxDQUFDO0FBRW5DLE1BQU0sVUFBVSxTQUFTLENBQUMsR0FBZ0I7SUFDekMsdUNBQXVDO0lBQ3ZDLE1BQU0sUUFBUSxHQUFHLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRW5ELDJFQUEyRTtJQUMzRSxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRWxCLFNBQWUsZ0JBQWdCOztZQUM5QixJQUFJLE1BQU0sR0FBRyxNQUFNLFdBQVcsRUFBRSxDQUFDO1lBQ2pDLElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW9CLENBQUM7WUFDL0MsSUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBcUIsQ0FBQztZQUVqRCxJQUFJLE9BQU8sR0FBRztnQkFDYixHQUFHLEVBQUUsRUFBRSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUM7Z0JBQzdCLElBQUksRUFBRSxFQUFFLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQztnQkFDL0IsVUFBVSxFQUFFLElBQUk7Z0JBQ2hCLGFBQWEsRUFDWixTQUFTLENBQUMsZUFBZSxHQUFHLFNBQVMsQ0FBQyxpQkFBaUI7Z0JBQ3hELE9BQU8sRUFBRTtvQkFD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b3J0IHsgY29uc3RhbnRzIH0gZnJvbSAnY3J5cHRvJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgaHR0cDIgZnJvbSAnaHR0cDInO1xuaW1wb3J0IGNyZWF0ZUh0dHAyRXhwcmVzc0JyaWRnZSBmcm9tICdodHRwMi1leHByZXNzLWJyaWRnZSc7XG5pbXBvcnQgaHR0cHMgZnJvbSAnaHR0cHMnO1xuaW1wb3J0IGZlYXR1cmVGbGFncyBmcm9tICcuLi9jb25maWcvZmVhdHVyZUZsYWdzJztcbmltcG9ydCBzZXR1cExvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXR1cEh0dHAoYXBwOiBBcHBsaWNhdGlvbikge1xuXHQvLyBDcmVhdGUgSFRUUC8yIGNvbXBhdGlibGUgRXhwcmVzcyBhcHBcblx0Y29uc3QgaHR0cDJBcHAgPSBjcmVhdGVIdHRwMkV4cHJlc3NCcmlkZ2UoZXhwcmVzcyk7XG5cblx0Ly8gVXNlIHRoZSBleGlzdGluZyBFeHByZXNzIGFwcCBhcyBtaWRkbGV3YXJlIGZvciB0aGUgSFRUUC8yIGNvbXBhdGlibGUgYXBwXG5cdGh0dHAyQXBwLnVzZShhcHApO1xuXG5cdGFzeW5jIGZ1bmN0aW9uIHN0YXJ0SHR0cDFTZXJ2ZXIoKSB7XG5cdFx0bGV0IGxvZ2dlciA9IGF3YWl0IHNldHVwTG9nZ2VyKCk7XG5cdFx0bGV0IGtleVBhdGggPSBwcm9jZXNzLmVudi5TRVJWRVJfU1NMX0tFWV9QQVRIITtcblx0XHRsZXQgY2VydFBhdGggPSBwcm9jZXNzLmVudi5TRVJWRVJfU1NMX0NFUlRfUEFUSCE7XG5cblx0XHRsZXQgb3B0aW9ucyA9IHtcblx0XHRcdGtleTogZnMucmVhZEZpbGVTeW5jKGtleVBhdGgpLFxuXHRcdFx0Y2VydDogZnMucmVhZEZpbGVTeW5jKGNlcnRQYXRoKSxcblx0XHRcdGFsbG93SFRUUDE6IHRydWUsXG5cdFx0XHRzZWN1cmVPcHRpb25zOlxuXHRcdFx0XHRjb25zdGFudHMuU1NMX09QX05PX1RMU3YxIHwgY29uc3RhbnRzLlNTTF9PUF9OT19UTFN2MV8xLFxuXHRcdFx0Y2lwaGVyczogW1xuXHRcdFx0XHQnRUNESEUtRUNEU0EtQUVTMjU2LUdDTS1TSEEzODQnLFxuXHRcdFx0XHQnRUNESEUtUlNBLUFFUzI1Ni1HQ00tU0hBMzg0Jyxcblx0XHRcdFx0J0VDREhFLUVDRFNBLUNIQUNIQTIwLVBPTFkxMzA1Jyxcblx0XHRcdFx0J0VDREhFLVJTQS1DSEFDSEEyMC1QT0xZMTMwNScsXG5cdFx0XHRcdCdFQ0RIRS1FQ0RTQS1BRVMxMjgtR0NNLVNIQTI1NicsXG5cdFx0XHRcdCdFQ0RIRS1SU0EtQUVTMTI4LUdDTS1TSEEyNTYnLFxuXHRcdFx0XHQnRUNESEUtRUNEU0EtQUVTMjU2LVNIQTM4NCcsXG5cdFx0XHRcdCdFQ0RIRS1SU0EtQUVTMjU2LVNIQTM4NCcsXG5cdFx0XHRcdCdFQ0RIRS1FQ0RTQS1BRVMxMjgtU0hBMjU2Jyxcblx0XHRcdFx0J0VDREhFLVJTQS1BRVMxMjgtU0hBMjU2J1xuXHRcdFx0XS5qb2luKCc6JyksXG5cdFx0XHRob25vckNpcGhlck9yZGVyOiB0cnVlXG5cdFx0fTtcblxuXHRcdGh0dHBzLmNyZWF0ZVNlcnZlcihvcHRpb25zLCBhcHApLmxpc3Rlbihwcm9jZXNzLmVudi5TRVJWRVJfUE9SVCwgKCkgPT4ge1xuXHRcdFx0bG9nZ2VyLmluZm8oYFNlcnZlciBydW5uaW5nIG9uIHBvcnQgJHtwcm9jZXNzLmVudi5TRVJWRVJfUE9SVH1gKTtcblx0XHR9KTtcblx0fVxuXG5cdGFzeW5jIGZ1bmN0aW9uIHN0YXJ0SHR0cDJTZXJ2ZXIoKSB7XG5cdFx0bGV0IGxvZ2dlciA9IGF3YWl0IHNldHVwTG9nZ2VyKCk7XG5cdFx0bGV0IGtleVBhdGggPSBwcm9jZXNzLmVudi5TRVJWRVJfU1NMX0tFWV9QQVRIITtcblx0XHRsZXQgY2VydFBhdGggPSBwcm9jZXNzLmVudi5TRVJWRVJfU1NMX0NFUlRfUEFUSCE7XG5cblx0XHRsZXQgb3B0aW9ucyA9IHtcblx0XHRcdGtleTogZnMucmVhZEZpbGVTeW5jKGtleVBhdGgpLFxuXHRcdFx0Y2VydDogZnMucmVhZEZpbGVTeW5jKGNlcnRQYXRoKSxcblx0XHRcdGFsbG93SFRUUDE6IHRydWUsXG5cdFx0XHRzZWN1cmVPcHRpb25zOlxuXHRcdFx0XHRjb25zdGFudHMuU1NMX09QX05PX1RMU3YxIHwgY29uc3RhbnRzLlNTTF9PUF9OT19UTFN2MV8xLFxuXHRcdFx0Y2lwaGVyczogW1xuXHRcdFx0XHQnRUNESEUtRUNEU0EtQUVTMjU2LUdDTS1TSEEzODQnLFxuXHRcdFx0XHQnRUNESEUtUlNBLUFFUzI1Ni1HQ00tU0hBMzg0Jyxcblx0XHRcdFx0J0VDREhFLUVDRFNBLUNIQUNIQTIwLVBPTFkxMzA1Jyxcblx0XHRcdFx0J0VDREhFLVJTQS1DSEFDSEEyMC1QT0xZMTMwNScsXG5cdFx0XHRcdCdFQ0RIRS1FQ0RTQS1BRVMxMjgtR0NNLVNIQTI1NicsXG5cdFx0XHRcdCdFQ0RIRS1SU0EtQUVTMTI4LUdDTS1TSEEyNTYnLFxuXHRcdFx0XHQnRUNESEUtRUNEU0EtQUVTMjU2LVNIQTM4NCcsXG5cdFx0XHRcdCdFQ0RIRS1SU0EtQUVTMjU2LVNIQTM4NCcsXG5cdFx0XHRcdCdFQ0RIRS1FQ0RTQS1BRVMxMjgtU0hBMjU2Jyxcblx0XHRcdFx0J0VDREhFLVJTQS1BRVMxMjgtU0hBMjU2J1xuXHRcdFx0XS5qb2luKCc6JyksXG5cdFx0XHRob25vckNpcGhlck9yZGVyOiB0cnVlXG5cdFx0fTtcblxuXHRcdGh0dHAyXG5cdFx0XHQuY3JlYXRlU2VjdXJlU2VydmVyKG9wdGlvbnMsIGFwcClcblx0XHRcdC5saXN0ZW4ocHJvY2Vzcy5lbnYuU0VSVkVSX1BPUlQsICgpID0+IHtcblx0XHRcdFx0bG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0YFNlcnZlciBydW5uaW5nIG9uIHBvcnQgJHtwcm9jZXNzLmVudi5TRVJWRVJfUE9SVH1gXG5cdFx0XHRcdCk7XG5cdFx0XHR9KTtcblx0fVxuXG5cdGFzeW5jIGZ1bmN0aW9uIHN0YXJ0U2VydmVyKCkge1xuXHRcdC8vIEVuc3VyZSB0aGlzIGZ1bmN0aW9uIGlzIGV4cG9ydGVkXG5cdFx0bGV0IGxvZ2dlciA9IGF3YWl0IHNldHVwTG9nZ2VyKCk7XG5cblx0XHRpZiAoZmVhdHVyZUZsYWdzLmh0dHAyRmxhZyAmJiAhZmVhdHVyZUZsYWdzLmh0dHAxRmxhZykge1xuXHRcdFx0bG9nZ2VyLmluZm8oJ1N0YXJ0aW5nIHNlcnZlciB3aXRoIEhUVFAvMicpO1xuXHRcdFx0YXdhaXQgc3RhcnRIdHRwMlNlcnZlcigpO1xuXHRcdH0gZWxzZSBpZiAoZmVhdHVyZUZsYWdzLmh0dHAxRmxhZyAmJiAhZmVhdHVyZUZsYWdzLmh0dHAyRmxhZykge1xuXHRcdFx0bG9nZ2VyLmluZm8oJ1N0YXJ0aW5nIHNlcnZlciB3aXRoIEhUVFAvMS4xJyk7XG5cdFx0XHRhd2FpdCBzdGFydEh0dHAxU2VydmVyKCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGxvZ2dlci5lcnJvcihcblx0XHRcdFx0J0hUVFAxIC8gSFRUUDIgZmxhZ3Mgbm90IGNvcnJlY3RseSBzZXQuIFBsZWFzZSBjaGVjayBiYWNrZW5kIC5lbnYgZmlsZSdcblx0XHRcdCk7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoXG5cdFx0XHRcdCdIVFRQMSAvIEhUVFAyIGZsYWdzIG5vdCBjb3JyZWN0bHkgc2V0LiBQbGVhc2UgY2hlY2sgYmFja2VuZCAuZW52IGZpbGUnXG5cdFx0XHQpO1xuXHRcdH1cblx0fVxuXG5cdHJldHVybiB7IHN0YXJ0U2VydmVyIH07XG59XG4iXX0=
