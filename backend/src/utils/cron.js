import { __awaiter } from 'tslib';
import cron from 'node-cron';
import fs from 'fs';
import path from 'path';
import compressing from 'compressing';
import { exec } from 'child_process';
import { __dirname } from '../index.js';
import setupLogger from '../middleware/logger.js';
let compressAndExportLogs = (sourceDir, exportDir, logFileName) =>
	__awaiter(void 0, void 0, void 0, function* () {
		let logger = yield setupLogger();
		let timestamp = new Date().toISOString().replace(/:/g, '-');
		let outputFileName = `${logFileName.replace('.log', '')}-${timestamp}.gz`;
		let outputFilePath = path.join(exportDir, outputFileName);
		let sourceFilePath = path.join(sourceDir, logFileName);
		try {
			yield compressing.gzip.compressFile(sourceFilePath, outputFilePath);
			logger.info(`${logFileName} successfully compressed`);
			return outputFilePath;
		} catch (err) {
			let error = err;
			logger.error(`Unable to compress ${logFileName}: ${error.message}`);
			throw new Error(`Error compessing log files: ${error.message}`);
		}
	});
const runCommandAndLog = (command, logFilePath) => {
	return new Promise((resolve, reject) => {
		let logStream = fs.createWriteStream(logFilePath, { flags: 'a' });
		let process = exec(
			command,
			{ maxBuffer: 1024 * 500 },
			(error, stdout, stderr) => {
				if (error) {
					logStream.write(`ERROR: ${error.message}\n`);
					return reject(error);
				}
				if (stderr) {
					logStream.write(`STDERR: ${stderr}\n`);
				}
				logStream.write(stdout);
				logStream.end();
				resolve();
			}
		);
		process.stdout.pipe(logStream);
		process.stderr.pipe(logStream);
	});
};
const exportLogs = () =>
	__awaiter(void 0, void 0, void 0, function* () {
		let logger = yield setupLogger();
		let serverLogDir = path.join(__dirname, process.env.SERVER_LOG_PATH);
		let npmLogDir = path.join(__dirname, process.env.SERVER_NPM_LOG_PATH);
		let exportDir = path.join(
			__dirname,
			process.env.BACKEND_LOGGER_EXPORT_PATH
		);
		// Ensure the export directory exists
		if (!fs.existsSync(exportDir)) {
			fs.mkdirSync(exportDir, { recursive: true });
		}
		try {
			// compress and export server logs
			let serverLogFiles = fs
				.readdirSync(serverLogDir)
				.filter((file) => file.endsWith('.log'));
			for (let logFile of serverLogFiles) {
				yield compressAndExportLogs(serverLogDir, exportDir, logFile);
			}
			// Compress and export npm logs
			let npmLogFiles = fs
				.readdirSync(npmLogDir)
				.filter((file) => file.endsWith('.logs'));
			for (let logFile of npmLogFiles) {
				yield compressAndExportLogs(npmLogDir, exportDir, logFile);
			}
			logger.info(
				'Logs have been successfully compresseed and exported.'
			);
		} catch (err) {
			let error = err;
			logger.error(`Error exporting logs: ${error.message}`);
		}
	});
// Perform hourly npm audit and update
const performNpmTasks = () =>
	__awaiter(void 0, void 0, void 0, function* () {
		let logger = yield setupLogger();
		let npmLogDir = path.join(__dirname, process.env.SERVER_NPM_LOG_PATH);
		let timestamp = new Date().toISOString().replace(/:/g, '-');
		let logFilePath = path.join(
			npmLogDir,
			`npm-audit-update-${timestamp}.log`
		);
		try {
			logger.info('Starting npm audit...');
			yield runCommandAndLog('npm audit --verbose', logFilePath);
			logger.info('npm audit completed successfully.');
			logger.info('Starting npm update...');
			yield runCommandAndLog('npm update --verbose', logFilePath);
			logger.info('npm update completed successfully.');
		} catch (err) {
			let error = err;
			logger.error(`Error during npm tasks: ${error.message}`);
		}
	});
// Determine the cron schedule based on LOGGER environment
const scheduleLogJobs = () =>
	__awaiter(void 0, void 0, void 0, function* () {
		let logger = yield setupLogger();
		let schedule = '';
		switch (process.env.LOGGER) {
			case '0':
				break;
			case '1':
				schedule = '*/2 * * * *';
				exportLogs();
				break;
			case '2':
				schedule = '0 */2 * * *';
				break;
			case '3':
				schedule = '0 */6 * * *';
				break;
			case '4':
				schedule = '0 */12 * * *';
				break;
			case '5':
				schedule = '0 0 * * *';
				break;
			case '6':
				schedule = '0 0 */2 * *';
				break;
			case '7':
				schedule = '0 0 * * 0';
				break;
			default:
				schedule = '0 0 * * *';
				logger.warn(
					'LOGGER variable not set. Defaulting to nightly log export'
				);
		}
		cron.schedule(schedule, exportLogs);
		cron.schedule('0 * * * *', performNpmTasks);
	});
scheduleLogJobs();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3RzL3V0aWxzL2Nyb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sSUFBSSxNQUFNLFdBQVcsQ0FBQztBQUM3QixPQUFPLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDcEIsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQ3hCLE9BQU8sV0FBVyxNQUFNLGFBQWEsQ0FBQztBQUN0QyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDckMsT0FBTyxXQUFXLE1BQU0sc0JBQXNCLENBQUM7QUFFL0MsSUFBSSxxQkFBcUIsR0FBRyxDQUMzQixTQUFpQixFQUNqQixTQUFpQixFQUNqQixXQUFtQixFQUNsQixFQUFFO0lBQ0gsSUFBSSxNQUFNLEdBQUcsTUFBTSxXQUFXLEVBQUUsQ0FBQztJQUNqQyxJQUFJLFNBQVMsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDNUQsSUFBSSxjQUFjLEdBQUcsR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsSUFBSSxTQUFTLEtBQUssQ0FBQztJQUMxRSxJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxjQUFjLENBQUMsQ0FBQztJQUMxRCxJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUV2RCxJQUFJLENBQUM7UUFDSixNQUFNLFdBQVcsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLGNBQWMsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUNwRSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsV0FBVywwQkFBMEIsQ0FBQyxDQUFDO1FB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Q3ZCLE1BQU07UUFDUDtZQUNDLFFBQVEsR0FBRyxXQUFXLENBQUM7WUFDdkIsTUFBTSxDQUFDLElBQUksQ0FDViwyREFBMkQsQ0FDM0QsQ0FBQztJQUNKLENBQUM7SUFFRCxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztJQUNwQyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxlQUFlLENBQUMsQ0FBQztBQUM3QyxDQUFDLENBQUEsQ0FBQztBQUVGLGVBQWUsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNyb24gZnJvbSAnbm9kZS1jcm9uJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBjb21wcmVzc2luZyBmcm9tICdjb21wcmVzc2luZyc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgeyBfX2Rpcm5hbWUgfSBmcm9tICcuLi9pbmRleCc7XG5pbXBvcnQgc2V0dXBMb2dnZXIgZnJvbSAnLi4vbWlkZGxld2FyZS9sb2dnZXInO1xuXG5sZXQgY29tcHJlc3NBbmRFeHBvcnRMb2dzID0gYXN5bmMgKFxuXHRzb3VyY2VEaXI6IHN0cmluZyxcblx0ZXhwb3J0RGlyOiBzdHJpbmcsXG5cdGxvZ0ZpbGVOYW1lOiBzdHJpbmdcbikgPT4ge1xuXHRsZXQgbG9nZ2VyID0gYXdhaXQgc2V0dXBMb2dnZXIoKTtcblx0bGV0IHRpbWVzdGFtcCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5yZXBsYWNlKC86L2csICctJyk7XG5cdGxldCBvdXRwdXRGaWxlTmFtZSA9IGAke2xvZ0ZpbGVOYW1lLnJlcGxhY2UoJy5sb2cnLCAnJyl9LSR7dGltZXN0YW1wfS5nemA7XG5cdGxldCBvdXRwdXRGaWxlUGF0aCA9IHBhdGguam9pbihleHBvcnREaXIsIG91dHB1dEZpbGVOYW1lKTtcblx0bGV0IHNvdXJjZUZpbGVQYXRoID0gcGF0aC5qb2luKHNvdXJjZURpciwgbG9nRmlsZU5hbWUpO1xuXG5cdHRyeSB7XG5cdFx0YXdhaXQgY29tcHJlc3NpbmcuZ3ppcC5jb21wcmVzc0ZpbGUoc291cmNlRmlsZVBhdGgsIG91dHB1dEZpbGVQYXRoKTtcblx0XHRsb2dnZXIuaW5mbyhgJHtsb2dGaWxlTmFtZX0gc3VjY2Vzc2Z1bGx5IGNvbXByZXNzZWRgKTtcblx0XHRyZXR1cm4gb3V0cHV0RmlsZVBhdGg7XG5cdH0gY2F0Y2ggKGVycikge1xuXHRcdGxldCBlcnJvciA9IGVyciBhcyBFcnJvcjtcblx0XHRsb2dnZXIuZXJyb3IoYFVuYWJsZSB0byBjb21wcmVzcyAke2xvZ0ZpbGVOYW1lfTogJHtlcnJvci5tZXNzYWdlfWApO1xuXHRcdHRocm93IG5ldyBFcnJvcihgRXJyb3IgY29tcGVzc2luZyBsb2cgZmlsZXM6ICR7ZXJyb3IubWVzc2FnZX1gKTtcblx0fVxufTtcblxuY29uc3QgcnVuQ29tbWFuZEFuZExvZyA9IChcblx0Y29tbWFuZDogc3RyaW5nLFxuXHRsb2dGaWxlUGF0aDogc3RyaW5nXG4pOiBQcm9taXNlPHZvaWQ+ID0+IHtcblx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRsZXQgbG9nU3RyZWFtID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0obG9nRmlsZVBhdGgsIHsgZmxhZ3M6ICdhJyB9KTtcblx0XHRsZXQgcHJvY2VzcyA9IGV4ZWMoXG5cdFx0XHRjb21tYW5kLFxuXHRcdFx0eyBtYXhCdWZmZXI6IDEwMjQgKiA1MDAgfSxcblx0XHRcdChlcnJvciwgc3Rkb3V0LCBzdGRlcnIpID0+IHtcblx0XHRcdFx0aWYgKGVycm9yKSB7XG5cdFx0XHRcdFx0bG9nU3RyZWFtLndyaXRlKGBFUlJPUjogJHtlcnJvci5tZXNzYWdlfVxcbmApO1xuXHRcdFx0XHRcdHJldHVybiByZWplY3QoZXJyb3IpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGlmIChzdGRlcnIpIHtcblx0XHRcdFx0XHRsb2dTdHJlYW0ud3JpdGUoYFNUREVSUjogJHtzdGRlcnJ9XFxuYCk7XG5cdFx0XHRcdH1cblx0XHRcdFx0bG9nU3RyZWFtLndyaXRlKHN0ZG91dCk7XG5cdFx0XHRcdGxvZ1N0cmVhbS5lbmQoKTtcblx0XHRcdFx0cmVzb2x2ZSgpO1xuXHRcdFx0fVxuXHRcdCk7XG5cblx0XHRwcm9jZXNzLnN0ZG91dCEucGlwZShsb2dTdHJlYW0pO1xuXHRcdHByb2Nlc3Muc3RkZXJyIS5waXBlKGxvZ1N0cmVhbSk7XG5cdH0pO1xufTtcblxuY29uc3QgZXhwb3J0TG9ncyA9IGFzeW5jICgpID0+IHtcblx0bGV0IGxvZ2dlciA9IGF3YWl0IHNldHVwTG9nZ2VyKCk7XG5cdGxldCBzZXJ2ZXJMb2dEaXIgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCBwcm9jZXNzLmVudi5TRVJWRVJfTE9HX1BBVEghKTtcblx0bGV0IG5wbUxvZ0RpciA9IHBhdGguam9pbihfX2Rpcm5hbWUsIHByb2Nlc3MuZW52LlNFUlZFUl9OUE1fTE9HX1BBVEghKTtcblx0bGV0IGV4cG9ydERpciA9IHBhdGguam9pbihcblx0XHRfX2Rpcm5hbWUsXG5cdFx0cHJvY2Vzcy5lbnYuQkFDS0VORF9MT0dHRVJfRVhQT1JUX1BBVEghXG5cdCk7XG5cblx0Ly8gRW5zdXJlIHRoZSBleHBvcnQgZGlyZWN0b3J5IGV4aXN0c1xuXHRpZiAoIWZzLmV4aXN0c1N5bmMoZXhwb3J0RGlyKSkge1xuXHRcdGZzLm1rZGlyU3luYyhleHBvcnREaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuXHR9XG5cblx0dHJ5IHtcblx0XHQvLyBjb21wcmVzcyBhbmQgZXhwb3J0IHNlcnZlciBsb2dzXG5cdFx0bGV0IHNlcnZlckxvZ0ZpbGVzID0gZnNcblx0XHRcdC5yZWFkZGlyU3luYyhzZXJ2ZXJMb2dEaXIpXG5cdFx0XHQuZmlsdGVyKChmaWxlKSA9PiBmaWxlLmVuZHNXaXRoKCcubG9nJykpO1xuXHRcdGZvciAobGV0IGxvZ0ZpbGUgb2Ygc2VydmVyTG9nRmlsZXMpIHtcblx0XHRcdGF3YWl0IGNvbXByZXNzQW5kRXhwb3J0TG9ncyhzZXJ2ZXJMb2dEaXIsIGV4cG9ydERpciwgbG9nRmlsZSk7XG5cdFx0fVxuXG5cdFx0Ly8gQ29tcHJlc3MgYW5kIGV4cG9ydCBucG0gbG9nc1xuXHRcdGxldCBucG1Mb2dGaWxlcyA9IGZzXG5cdFx0XHQucmVhZGRpclN5bmMobnBtTG9nRGlyKVxuXHRcdFx0LmZpbHRlcigoZmlsZSkgPT4gZmlsZS5lbmRzV2l0aCgnLmxvZ3MnKSk7XG5cdFx0Zm9yIChsZXQgbG9nRmlsZSBvZiBucG1Mb2dGaWxlcykge1xuXHRcdFx0YXdhaXQgY29tcHJlc3NBbmRFeHBvcnRMb2dzKG5wbUxvZ0RpciwgZXhwb3J0RGlyLCBsb2dGaWxlKTtcblx0XHR9XG5cblx0XHRsb2dnZXIuaW5mbygnTG9ncyBoYXZlIGJlZW4gc3VjY2Vzc2Z1bGx5IGNvbXByZXNzZWVkIGFuZCBleHBvcnRlZC4nKTtcblx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0bGV0IGVycm9yID0gZXJyIGFzIEVycm9yO1xuXHRcdGxvZ2dlci5lcnJvcihgRXJyb3IgZXhwb3J0aW5nIGxvZ3M6ICR7ZXJyb3IubWVzc2FnZX1gKTtcblx0fVxufTtcblxuLy8gUGVyZm9ybSBob3VybHkgbnBtIGF1ZGl0IGFuZCB1cGRhdGVcbmNvbnN0IHBlcmZvcm1OcG1UYXNrcyA9IGFzeW5jICgpID0+IHtcblx0bGV0IGxvZ2dlciA9IGF3YWl0IHNldHVwTG9nZ2VyKCk7XG5cdGxldCBucG1Mb2dEaXIgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCBwcm9jZXNzLmVudi5TRVJWRVJfTlBNX0xPR19QQVRIISk7XG5cdGxldCB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkucmVwbGFjZSgvOi9nLCAnLScpO1xuXHRsZXQgbG9nRmlsZVBhdGggPSBwYXRoLmpvaW4obnBtTG9nRGlyLCBgbnBtLWF1ZGl0LXVwZGF0ZS0ke3RpbWVzdGFtcH0ubG9nYCk7XG5cblx0dHJ5IHtcblx0XHRsb2dnZXIuaW5mbygnU3RhcnRpbmcgbnBtIGF1ZGl0Li4uJyk7XG5cdFx0YXdhaXQgcnVuQ29tbWFuZEFuZExvZygnbnBtIGF1ZGl0IC0tdmVyYm9zZScsIGxvZ0ZpbGVQYXRoKTtcblx0XHRsb2dnZXIuaW5mbygnbnBtIGF1ZGl0IGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkuJyk7XG5cblx0XHRsb2dnZXIuaW5mbygnU3RhcnRpbmcgbnBtIHVwZGF0ZS4uLicpO1xuXHRcdGF3YWl0IHJ1bkNvbW1hbmRBbmRMb2coJ25wbSB1cGRhdGUgLS12ZXJib3NlJywgbG9nRmlsZVBhdGgpO1xuXHRcdGxvZ2dlci5pbmZvKCducG0gdXBkYXRlIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkuJyk7XG5cdH0gY2F0Y2ggKGVycikge1xuXHRcdGxldCBlcnJvciA9IGVyciBhcyBFcnJvcjtcblx0XHRsb2dnZXIuZXJyb3IoYEVycm9yIGR1cmluZyBucG0gdGFza3M6ICR7ZXJyb3IubWVzc2FnZX1gKTtcblx0fVxufTtcblxuLy8gRGV0ZXJtaW5lIHRoZSBjcm9uIHNjaGVkdWxlIGJhc2VkIG9uIExPR0dFUiBlbnZpcm9ubWVudFxuY29uc3Qgc2NoZWR1bGVMb2dKb2JzID0gYXN5bmMgKCkgPT4ge1xuXHRsZXQgbG9nZ2VyID0gYXdhaXQgc2V0dXBMb2dnZXIoKTtcblxuXHRsZXQgc2NoZWR1bGUgPSAnJztcblxuXHRzd2l0Y2ggKHByb2Nlc3MuZW52LkxPR0dFUikge1xuXHRcdGNhc2UgJzAnOlxuXHRcdFx0YnJlYWs7XG5cdFx0Y2FzZSAnMSc6XG5cdFx0XHRzY2hlZHVsZSA9ICcqLzIgKiAqICogKic7XG5cdFx0XHRleHBvcnRMb2dzKCk7XG5cdFx0XHRicmVhaztcblx0XHRjYXNlICcyJzpcblx0XHRcdHNjaGVkdWxlID0gJzAgKi8yICogKiAqJztcblx0XHRcdGJyZWFrO1xuXHRcdGNhc2UgJzMnOlxuXHRcdFx0c2NoZWR1bGUgPSAnMCAqLzYgKiAqIConO1xuXHRcdFx0YnJlYWs7XG5cdFx0Y2FzZSAnNCc6XG5cdFx0XHRzY2hlZHVsZSA9ICcwICovMTIgKiAqIConO1xuXHRcdFx0YnJlYWs7XG5cdFx0Y2FzZSAnNSc6XG5cdFx0XHRzY2hlZHVsZSA9ICcwIDAgKiAqIConO1xuXHRcdFx0YnJlYWs7XG5cdFx0Y2FzZSAnNic6XG5cdFx0XHRzY2hlZHVsZSA9ICcwIDAgKi8yICogKic7XG5cdFx0XHRicmVhaztcblx0XHRjYXNlICc3Jzpcblx0XHRcdHNjaGVkdWxlID0gJzAgMCAqICogMCc7XG5cdFx0XHRicmVhaztcblx0XHRkZWZhdWx0OlxuXHRcdFx0c2NoZWR1bGUgPSAnMCAwICogKiAqJztcblx0XHRcdGxvZ2dlci53YXJuKFxuXHRcdFx0XHQnTE9HR0VSIHZhcmlhYmxlIG5vdCBzZXQuIERlZmF1bHRpbmcgdG8gbmlnaHRseSBsb2cgZXhwb3J0J1xuXHRcdFx0KTtcblx0fVxuXG5cdGNyb24uc2NoZWR1bGUoc2NoZWR1bGUsIGV4cG9ydExvZ3MpO1xuXHRjcm9uLnNjaGVkdWxlKCcwICogKiAqIConLCBwZXJmb3JtTnBtVGFza3MpO1xufTtcblxuc2NoZWR1bGVMb2dKb2JzKCk7XG4iXX0=
