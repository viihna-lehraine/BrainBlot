import { __awaiter } from 'tslib';
import { Fido2Lib } from 'fido2-lib';
import getSecrets from '../../config/secrets.js';
let fido2;
(() =>
	__awaiter(void 0, void 0, void 0, function* () {
		let secrets = yield getSecrets();
		if (!secrets) {
			throw new Error('Secrets could not be loaded');
		}
		fido2 = new Fido2Lib({
			timeout: 60000,
			rpId: secrets.RP_ID,
			rpName: secrets.RP_NAME,
			challengeSize: secrets.FIDO_CHALLENGE_SIZE,
			attestation: 'indirect', // values: 'none', 'indirect', 'direct', 'enterprise'
			cryptoParams: secrets.FIDO_CRYPTO_PARAMETERS,
			authenticatorRequireResidentKey:
				secrets.FIDO_AUTHENTICATOR_REQUIRE_RESIDENT_KEY,
			authenticatorUserVerification:
				secrets.FIDO_AUTHENTICATOR_USER_VERIFICATION
		});
	}))();
function generateU2fRegistrationOptions(user) {
	return __awaiter(this, void 0, void 0, function* () {
		let passkeyRegistrationOptions = yield fido2.attestationOptions();
		let u2fRegistrationOptions = Object.assign(
			Object.assign({}, passkeyRegistrationOptions),
			{
				user: {
					id: Buffer.from(user.id, 'utf8'), // UID from db (base64 encoded)
					name: user.email,
					displayName: user.username
				},
				pubKeyCredParams: [{ type: 'public-key', alg: -7 }],
				timeout: 60000,
				attestation: 'direct',
				authenticatorSelection: {
					authenticatorAttachment: 'platform',
					requireResidentKey: true, // Correct property name
					userVerification: 'required'
				}
			}
		);
		return u2fRegistrationOptions;
	});
}
function verifyU2fRegistration(attestation, expectedChallenge) {
	return __awaiter(this, void 0, void 0, function* () {
		let secrets = yield getSecrets();
		if (!secrets) {
			throw new Error('Secrets could not be loaded');
		}
		let u2fAttestationExpectations = {
			challenge: expectedChallenge,
			origin: secrets.RP_ORIGIN,
			factor: 'either',
			rpId: secrets.RP_ID
		};
		return yield fido2.attestationResult(
			attestation,
			u2fAttestationExpectations
		);
	});
}
function generateU2fAuthenticationOptions(user) {
	return __awaiter(this, void 0, void 0, function* () {
		let userCredentials = user.credential.map((credential) => ({
			type: 'public-key', // Explicit type
			id: Buffer.from(credential.credentialId, 'base64')
		}));
		let assertionOptions = yield fido2.assertionOptions();
		let u2fAuthenticationOptions = Object.assign(
			Object.assign({}, assertionOptions),
			{
				allowCredentials: userCredentials,
				userVerification: 'preferred',
				timeout: 60000
			}
		);
		return u2fAuthenticationOptions;
	});
}
function verifyU2fAuthentication(
	assertion,
	expectedChallenge,
	publicKey,
	previousCounter,
	id
) {
	return __awaiter(this, void 0, void 0, function* () {
		let secrets = yield getSecrets();
		if (!secrets) {
			throw new Error('Secrets could not be loaded');
		}
		let assertionExpectations = {
			challenge: expectedChallenge,
			origin: secrets.RP_ORIGIN,
			factor: 'either',
			publicKey: publicKey,
			prevCounter: previousCounter,
			userHandle: id
		};
		return yield fido2.assertionResult(assertion, assertionExpectations);
	});
}
export {
	generateU2fAuthenticationOptions,
	generateU2fRegistrationOptions,
	verifyU2fAuthentication,
	verifyU2fRegistration
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlkbzJVdGlsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vdHMvdXRpbHMvYXV0aC9maWRvMlV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFLTixRQUFRLEVBR1IsTUFBTSxXQUFXLENBQUM7QUFDbkIsT0FBTyxVQUFVLE1BQU0seUJBQXlCLENBQUM7QUFFakQsSUFBSSxLQUFlLENBQUM7QUEyQnBCLENBQUMsR0FBUyxFQUFFO0lBQ1gsSUFBSSxPQUFPLEdBQVksTUFBTSxVQUFVLEVBQUUsQ0FBQztJQUUxQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDZCxNQUFNLElBQUksS0FBSyxDQUFDLDZCQUE2QixDQUFDLENBQUM7SUFDaEQsQ0FBQztJQUNELEtBQUssR0FBRyxJQUFJLFFBQVEsQ0FBQztRQUNwQixPQUFPLEVBQUUsS0FBSztRQUNkLElBQUksRUFBRSxPQUFPLENBQUMsS0FBSztRQUNuQixNQUFNLEVBQUUsT0FBTyxDQUFDLE9BQU87UUFDdkIsYUFBYSxFQUFFLE9BQU8sQ0FBQyxtQkFBbUI7UUFDMUMsV0FBVyxFQUFFLFVBQVUsRUFBRSxxREFBcUQ7UUFDOUUsWUFBWSxFQUFFLE9BQU8sQ0FBQyxzQkFBc0I7UUFDNUMsK0JBQStCLEVBQzlCLE9BQU8sQ0FBQyx1Q0FBdUM7UUFDaEQsNkJBQTZCLEVBQzVCLE9BQU8sQ0FBQyxvQ0FBb0M7S0FDN0MsQ0FBQyxDQUFDO0FBQ0osQ0FBQyxDQUFBLENBQUMsRUFBRSxDQUFDO0FBRUwsU0FBZSw4QkFBOEIsQ0FDNUMsSUFBVTs7UUFFVixJQUFJLDBCQUEwQixHQUFHLE1BQU0sS0FBSyxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFFbEUsSUFBSSxzQkFBc0IsbUNBQ3RCLDBCQUEwQixLQUM3QixJQUFJLEVBQUU7Z0JBQ0wsRUFBRSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsRUFBRSwrQkFBK0I7Z0JBQ2pFLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSztnQkFDaEIsV0FBVyxFQUFFLElBQUksQ0FBQyxRQUFRO2FBQzFCLEVBQ0QsZ0JBQWdCLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFDbkQsT0FBTyxFQUFFLEtBQUssRUFDZCxXQUFXLEVBQUUsUUFBUSxFQUNyQixzQkFBc0IsRUFBRTtnQkFDdkIsdUJBQXVCLEVBQUUsVUFBVTtnQkFDbkMsa0JBQWtCLEVBQUUsSUFBSSxFQUFFLHdCQUF3QjtnQkFDbEQsZ0JBQWdCLEVBQUUsVUFBVTthQUM1QixHQUNELENBQUM7UUFDRixPQUFPLHNCQUFzQixDQUFDO0lBQy9CLENBQUM7Q0FBQTtBQUVELFNBQWUscUJBQXFCLENBQ25DLFdBQThCLEVBQzlCLGlCQUF5Qjs7UUFFekIsSUFBSSxPQUFPLEdBQVksTUFBTSxVQUFVLEVBQUUsQ0FBQztRQUUxQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDZCxNQUFNLElBQUksS0FBSyxDQUFDLDZCQUE2QixDQUFDLENBQUM7UUFDaEQsQ0FBQztRQUVELElBQUksMEJBQTBCLEdBQThCO1lBQzNELFNBQVMsRUFBRSxpQkFBaUI7WUFDNUIsTUFBTSxFQUFFLE9BQU8sQ0FBQyxTQUFTO1lBQ3pCLE1BQU0sRUFBRSxRQUFrQjtZQUMxQixJQUFJLEVBQUUsT0FBTyxDQUFDLEtBQUs7U0FDbkIsQ0FBQztRQUVGLE9BQU8sTUFBTSxLQUFLLENBQUMsaUJBQWlCLENBQ25DLFdBQVcsRUFDWCwwQkFBMEIsQ0FDMUIsQ0FBQztJQUNILENBQUM7Q0FBQTtBQUVELFNBQWUsZ0NBQWdDLENBQzlDLElBQVU7O1FBRVYsSUFBSSxlQUFlLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDMUQsSUFBSSxFQUFFLFlBQXFCLEVBQUUsZ0JBQWdCO1lBQzdDLEVBQUUsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLEVBQUUsUUFBUSxDQUFDO1NBQ2xELENBQUMsQ0FBQyxDQUFDO1FBRUosSUFBSSxnQkFBZ0IsR0FBRyxNQUFNLEtBQUssQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBRXRELElBQUksd0JBQXdCLG1DQUN4QixnQkFBZ0IsS0FDbkIsZ0JBQWdCLEVBQUUsZUFBZSxFQUNqQyxnQkFBZ0IsRUFBRSxXQUFXLEVBQzdCLE9BQU8sRUFBRSxLQUFLLEdBQ2QsQ0FBQztRQUVGLE9BQU8sd0JBQXdCLENBQUM7SUFDakMsQ0FBQztDQUFBO0FBRUQsU0FBZSx1QkFBdUIsQ0FDckMsU0FBMEIsRUFDMUIsaUJBQXlCLEVBQ3pCLFNBQWlCLEVBQ2pCLGVBQXVCLEVBQ3ZCLEVBQVU7O1FBRVYsSUFBSSxPQUFPLEdBQVksTUFBTSxVQUFVLEVBQUUsQ0FBQztRQUUxQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDZCxNQUFNLElBQUksS0FBSyxDQUFDLDZCQUE2QixDQUFDLENBQUM7UUFDaEQsQ0FBQztRQUNELElBQUkscUJBQXFCLEdBQTRCO1lBQ3BELFNBQVMsRUFBRSxpQkFBaUI7WUFDNUIsTUFBTSxFQUFFLE9BQU8sQ0FBQyxTQUFTO1lBQ3pCLE1BQU0sRUFBRSxRQUFrQjtZQUMxQixTQUFTLEVBQUUsU0FBUztZQUNwQixXQUFXLEVBQUUsZUFBZTtZQUM1QixVQUFVLEVBQUUsRUFBRTtTQUNkLENBQUM7UUFFRixPQUFPLE1BQU0sS0FBSyxDQUFDLGVBQWUsQ0FBQyxTQUFTLEVBQUUscUJBQXFCLENBQUMsQ0FBQztJQUN0RSxDQUFDO0NBQUE7QUFFRCxPQUFPLEVBQ04sZ0NBQWdDLEVBQ2hDLDhCQUE4QixFQUM5Qix1QkFBdUIsRUFDdkIscUJBQXFCLEVBQ3JCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuXHRBc3NlcnRpb25SZXN1bHQsXG5cdEF0dGVzdGF0aW9uUmVzdWx0LFxuXHRFeHBlY3RlZEFzc2VydGlvblJlc3VsdCxcblx0RXhwZWN0ZWRBdHRlc3RhdGlvblJlc3VsdCxcblx0RmlkbzJMaWIsXG5cdFB1YmxpY0tleUNyZWRlbnRpYWxDcmVhdGlvbk9wdGlvbnMsXG5cdFB1YmxpY0tleUNyZWRlbnRpYWxSZXF1ZXN0T3B0aW9uc1xufSBmcm9tICdmaWRvMi1saWInO1xuaW1wb3J0IGdldFNlY3JldHMgZnJvbSAnLi4vLi4vY29uZmlnL3NlY3JldHMuanMnO1xuXG5sZXQgZmlkbzI6IEZpZG8yTGliO1xuXG5pbnRlcmZhY2UgVXNlciB7XG5cdGlkOiBzdHJpbmc7XG5cdGVtYWlsOiBzdHJpbmc7XG5cdHVzZXJuYW1lOiBzdHJpbmc7XG5cdGNyZWRlbnRpYWw6IHtcblx0XHRjcmVkZW50aWFsSWQ6IHN0cmluZztcblx0fVtdO1xufVxuXG5pbnRlcmZhY2UgU2VjcmV0cyB7XG5cdFJQX0lEOiBzdHJpbmc7XG5cdFJQX05BTUU6IHN0cmluZztcblx0UlBfSUNPTjogc3RyaW5nO1xuXHRSUF9PUklHSU46IHN0cmluZztcblx0RklET19DSEFMTEVOR0VfU0laRTogbnVtYmVyO1xuXHRGSURPX0NSWVBUT19QQVJBTUVURVJTOiBudW1iZXJbXTtcblx0RklET19BVVRIRU5USUNBVE9SX1JFUVVJUkVfUkVTSURFTlRfS0VZOiBib29sZWFuO1xuXHRGSURPX0FVVEhFTlRJQ0FUT1JfVVNFUl9WRVJJRklDQVRJT046XG5cdFx0fCAncmVxdWlyZWQnXG5cdFx0fCAncHJlZmVycmVkJ1xuXHRcdHwgJ2Rpc2NvdXJhZ2VkJztcbn1cblxudHlwZSBGYWN0b3IgPSAnZmlyc3QnIHwgJ3NlY29uZCcgfCAnZWl0aGVyJztcblxuKGFzeW5jICgpID0+IHtcblx0bGV0IHNlY3JldHM6IFNlY3JldHMgPSBhd2FpdCBnZXRTZWNyZXRzKCk7XG5cblx0aWYgKCFzZWNyZXRzKSB7XG5cdFx0dGhyb3cgbmV3IEVycm9yKCdTZWNyZXRzIGNvdWxkIG5vdCBiZSBsb2FkZWQnKTtcblx0fVxuXHRmaWRvMiA9IG5ldyBGaWRvMkxpYih7XG5cdFx0dGltZW91dDogNjAwMDAsXG5cdFx0cnBJZDogc2VjcmV0cy5SUF9JRCxcblx0XHRycE5hbWU6IHNlY3JldHMuUlBfTkFNRSxcblx0XHRjaGFsbGVuZ2VTaXplOiBzZWNyZXRzLkZJRE9fQ0hBTExFTkdFX1NJWkUsXG5cdFx0YXR0ZXN0YXRpb246ICdpbmRpcmVjdCcsIC8vIHZhbHVlczogJ25vbmUnLCAnaW5kaXJlY3QnLCAnZGlyZWN0JywgJ2VudGVycHJpc2UnXG5cdFx0Y3J5cHRvUGFyYW1zOiBzZWNyZXRzLkZJRE9fQ1JZUFRPX1BBUkFNRVRFUlMsXG5cdFx0YXV0aGVudGljYXRvclJlcXVpcmVSZXNpZGVudEtleTpcblx0XHRcdHNlY3JldHMuRklET19BVVRIRU5USUNBVE9SX1JFUVVJUkVfUkVTSURFTlRfS0VZLFxuXHRcdGF1dGhlbnRpY2F0b3JVc2VyVmVyaWZpY2F0aW9uOlxuXHRcdFx0c2VjcmV0cy5GSURPX0FVVEhFTlRJQ0FUT1JfVVNFUl9WRVJJRklDQVRJT05cblx0fSk7XG59KSgpO1xuXG5hc3luYyBmdW5jdGlvbiBnZW5lcmF0ZVUyZlJlZ2lzdHJhdGlvbk9wdGlvbnMoXG5cdHVzZXI6IFVzZXJcbik6IFByb21pc2U8UHVibGljS2V5Q3JlZGVudGlhbENyZWF0aW9uT3B0aW9ucz4ge1xuXHRsZXQgcGFzc2tleVJlZ2lzdHJhdGlvbk9wdGlvbnMgPSBhd2FpdCBmaWRvMi5hdHRlc3RhdGlvbk9wdGlvbnMoKTtcblxuXHRsZXQgdTJmUmVnaXN0cmF0aW9uT3B0aW9uczogUHVibGljS2V5Q3JlZGVudGlhbENyZWF0aW9uT3B0aW9ucyA9IHtcblx0XHQuLi5wYXNza2V5UmVnaXN0cmF0aW9uT3B0aW9ucyxcblx0XHR1c2VyOiB7XG5cdFx0XHRpZDogQnVmZmVyLmZyb20odXNlci5pZCwgJ3V0ZjgnKSwgLy8gVUlEIGZyb20gZGIgKGJhc2U2NCBlbmNvZGVkKVxuXHRcdFx0bmFtZTogdXNlci5lbWFpbCxcblx0XHRcdGRpc3BsYXlOYW1lOiB1c2VyLnVzZXJuYW1lXG5cdFx0fSxcblx0XHRwdWJLZXlDcmVkUGFyYW1zOiBbeyB0eXBlOiAncHVibGljLWtleScsIGFsZzogLTcgfV0sXG5cdFx0dGltZW91dDogNjAwMDAsXG5cdFx0YXR0ZXN0YXRpb246ICdkaXJlY3QnLFxuXHRcdGF1dGhlbnRpY2F0b3JTZWxlY3Rpb246IHtcblx0XHRcdGF1dGhlbnRpY2F0b3JBdHRhY2htZW50OiAncGxhdGZvcm0nLFxuXHRcdFx0cmVxdWlyZVJlc2lkZW50S2V5OiB0cnVlLCAvLyBDb3JyZWN0IHByb3BlcnR5IG5hbWVcblx0XHRcdHVzZXJWZXJpZmljYXRpb246ICdyZXF1aXJlZCdcblx0XHR9XG5cdH07XG5cdHJldHVybiB1MmZSZWdpc3RyYXRpb25PcHRpb25zO1xufVxuXG5hc3luYyBmdW5jdGlvbiB2ZXJpZnlVMmZSZWdpc3RyYXRpb24oXG5cdGF0dGVzdGF0aW9uOiBBdHRlc3RhdGlvblJlc3VsdCxcblx0ZXhwZWN0ZWRDaGFsbGVuZ2U6IHN0cmluZ1xuKSB7XG5cdGxldCBzZWNyZXRzOiBTZWNyZXRzID0gYXdhaXQgZ2V0U2VjcmV0cygpO1xuXG5cdGlmICghc2VjcmV0cykge1xuXHRcdHRocm93IG5ldyBFcnJvcignU2VjcmV0cyBjb3VsZCBub3QgYmUgbG9hZGVkJyk7XG5cdH1cblxuXHRsZXQgdTJmQXR0ZXN0YXRpb25FeHBlY3RhdGlvbnM6IEV4cGVjdGVkQXR0ZXN0YXRpb25SZXN1bHQgPSB7XG5cdFx0Y2hhbGxlbmdlOiBleHBlY3RlZENoYWxsZW5nZSxcblx0XHRvcmlnaW46IHNlY3JldHMuUlBfT1JJR0lOLFxuXHRcdGZhY3RvcjogJ2VpdGhlcicgYXMgRmFjdG9yLFxuXHRcdHJwSWQ6IHNlY3JldHMuUlBfSURcblx0fTtcblxuXHRyZXR1cm4gYXdhaXQgZmlkbzIuYXR0ZXN0YXRpb25SZXN1bHQoXG5cdFx0YXR0ZXN0YXRpb24sXG5cdFx0dTJmQXR0ZXN0YXRpb25FeHBlY3RhdGlvbnNcblx0KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVVMmZBdXRoZW50aWNhdGlvbk9wdGlvbnMoXG5cdHVzZXI6IFVzZXJcbik6IFByb21pc2U8UHVibGljS2V5Q3JlZGVudGlhbFJlcXVlc3RPcHRpb25zPiB7XG5cdGxldCB1c2VyQ3JlZGVudGlhbHMgPSB1c2VyLmNyZWRlbnRpYWwubWFwKChjcmVkZW50aWFsKSA9PiAoe1xuXHRcdHR5cGU6ICdwdWJsaWMta2V5JyBhcyBjb25zdCwgLy8gRXhwbGljaXQgdHlwZVxuXHRcdGlkOiBCdWZmZXIuZnJvbShjcmVkZW50aWFsLmNyZWRlbnRpYWxJZCwgJ2Jhc2U2NCcpXG5cdH0pKTtcblxuXHRsZXQgYXNzZXJ0aW9uT3B0aW9ucyA9IGF3YWl0IGZpZG8yLmFzc2VydGlvbk9wdGlvbnMoKTtcblxuXHRsZXQgdTJmQXV0aGVudGljYXRpb25PcHRpb25zOiBQdWJsaWNLZXlDcmVkZW50aWFsUmVxdWVzdE9wdGlvbnMgPSB7XG5cdFx0Li4uYXNzZXJ0aW9uT3B0aW9ucyxcblx0XHRhbGxvd0NyZWRlbnRpYWxzOiB1c2VyQ3JlZGVudGlhbHMsXG5cdFx0dXNlclZlcmlmaWNhdGlvbjogJ3ByZWZlcnJlZCcsXG5cdFx0dGltZW91dDogNjAwMDBcblx0fTtcblxuXHRyZXR1cm4gdTJmQXV0aGVudGljYXRpb25PcHRpb25zO1xufVxuXG5hc3luYyBmdW5jdGlvbiB2ZXJpZnlVMmZBdXRoZW50aWNhdGlvbihcblx0YXNzZXJ0aW9uOiBBc3NlcnRpb25SZXN1bHQsXG5cdGV4cGVjdGVkQ2hhbGxlbmdlOiBzdHJpbmcsXG5cdHB1YmxpY0tleTogc3RyaW5nLFxuXHRwcmV2aW91c0NvdW50ZXI6IG51bWJlcixcblx0aWQ6IHN0cmluZ1xuKSB7XG5cdGxldCBzZWNyZXRzOiBTZWNyZXRzID0gYXdhaXQgZ2V0U2VjcmV0cygpO1xuXG5cdGlmICghc2VjcmV0cykge1xuXHRcdHRocm93IG5ldyBFcnJvcignU2VjcmV0cyBjb3VsZCBub3QgYmUgbG9hZGVkJyk7XG5cdH1cblx0bGV0IGFzc2VydGlvbkV4cGVjdGF0aW9uczogRXhwZWN0ZWRBc3NlcnRpb25SZXN1bHQgPSB7XG5cdFx0Y2hhbGxlbmdlOiBleHBlY3RlZENoYWxsZW5nZSxcblx0XHRvcmlnaW46IHNlY3JldHMuUlBfT1JJR0lOLFxuXHRcdGZhY3RvcjogJ2VpdGhlcicgYXMgRmFjdG9yLFxuXHRcdHB1YmxpY0tleTogcHVibGljS2V5LFxuXHRcdHByZXZDb3VudGVyOiBwcmV2aW91c0NvdW50ZXIsXG5cdFx0dXNlckhhbmRsZTogaWRcblx0fTtcblxuXHRyZXR1cm4gYXdhaXQgZmlkbzIuYXNzZXJ0aW9uUmVzdWx0KGFzc2VydGlvbiwgYXNzZXJ0aW9uRXhwZWN0YXRpb25zKTtcbn1cblxuZXhwb3J0IHtcblx0Z2VuZXJhdGVVMmZBdXRoZW50aWNhdGlvbk9wdGlvbnMsXG5cdGdlbmVyYXRlVTJmUmVnaXN0cmF0aW9uT3B0aW9ucyxcblx0dmVyaWZ5VTJmQXV0aGVudGljYXRpb24sXG5cdHZlcmlmeVUyZlJlZ2lzdHJhdGlvblxufTtcbiJdfQ==
