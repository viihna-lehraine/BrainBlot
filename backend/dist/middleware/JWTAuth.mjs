import { ServiceFactory } from '../index/factory.mjs';
import { HandleErrorStaticParameters } from '../index/parameters.mjs';
import fs from 'fs';
import jwt from 'jsonwebtoken';
import lockfile from 'proper-lockfile';
export class JWTAuthMiddlewareService {
	static instance = null;
	logger;
	errorLogger;
	errorHandler;
	gatekeeperService;
	cacheService;
	redisService;
	expiredTokens = new Set();
	revokedTokens = new Set();
	expiryListFilePath;
	revocationListFilePath;
	expiryListCacheKey = 'tokenExpirationList';
	revocationListCacheKey = 'tokenRevocationList';
	cacheDuration;
	cleanupExpiredTokensInterval = null;
	cleanupRevokedTokensInterval = null;
	constructor(
		logger,
		errorLogger,
		errorHandler,
		gatekeeperService,
		cacheService,
		redisService,
		envConfig
	) {
		this.logger = logger;
		this.errorLogger = errorLogger;
		this.errorHandler = errorHandler;
		this.gatekeeperService = gatekeeperService;
		this.cacheService = cacheService;
		this.redisService = redisService;
		this.expiryListFilePath = envConfig.getEnvVariable(
			'tokenExpiryListPath'
		);
		this.revocationListFilePath = envConfig.getEnvVariable(
			'tokenRevokedListPath'
		);
		this.cacheDuration =
			envConfig.getEnvVariable('tokenCacheDuration') || 3600;
		this.loadExpiredTokens();
		this.loadRevokedTokens();
		this.cleanupExpiredTokensInterval = setInterval(
			() => this.cleanupExpiredTokens(),
			60 * 1000
		);
		this.cleanupRevokedTokensInterval = setInterval(
			() => this.cleanupRevokedTokens(),
			60 * 1000
		);
	}
	static async getInstance() {
		if (!JWTAuthMiddlewareService.instance) {
			const logger = await ServiceFactory.getLoggerService();
			const errorLogger = await ServiceFactory.getErrorLoggerService();
			const errorHandler = await ServiceFactory.getErrorHandlerService();
			const gatekeeperService =
				await ServiceFactory.getGatekeeperService();
			const cacheService = await ServiceFactory.getCacheService();
			const redisService = await ServiceFactory.getRedisService();
			const envConfig = await ServiceFactory.getEnvConfigService();
			JWTAuthMiddlewareService.instance = new JWTAuthMiddlewareService(
				logger,
				errorLogger,
				errorHandler,
				gatekeeperService,
				cacheService,
				redisService,
				envConfig
			);
		}
		return JWTAuthMiddlewareService.instance;
	}
	initializeJWTAuthMiddleware() {
		return async (req, res, next) => {
			try {
				const ip = req.ip;
				if (!ip) {
					this.logger.warn('No IP address found in request');
					return res.status(403).json({ error: 'Access denied' });
				}
				if (await this.gatekeeperService.isTemporarilyBlacklisted(ip)) {
					this.logger.warn(`IP ${ip} is temporarily blacklisted.`);
					return res
						.status(403)
						.json({ error: 'Access temporarily denied' });
				}
				if (await this.gatekeeperService.isBlacklisted(ip)) {
					this.logger.warn(`IP ${ip} is blacklisted.`);
					return res.status(403).json({ error: 'Access denied' });
				}
				const authHeader = req.headers.authorization;
				const token = authHeader?.split(' ')[1];
				if (!token) {
					this.errorLogger.logWarn(
						'No JWT token found in the authorization header'
					);
					return res.sendStatus(403);
				}
				if (await this.isTokenRevoked(token)) {
					this.logger.warn(`JWT token is revoked: ${token}`);
					return res.status(403).json({ error: 'Token revoked' });
				}
				if (await this.isTokenExpired(token)) {
					this.logger.warn(`JWT token has expired: ${token}`);
					return res.status(403).json({ error: 'Token expired' });
				}
				const jwtService = await ServiceFactory.getJWTService();
				const user = await jwtService.verifyJWT(token);
				if (!user) {
					this.logger.warn('Invalid JWT token');
					return res.status(403).json({ error: 'Invalid token' });
				}
				req.user = user;
				next();
			} catch (expressError) {
				const expressMiddlewareError =
					new this.errorHandler.ErrorClasses.ExpressError(
						`Error in JWTAuthMiddleware: ${expressError instanceof Error ? expressError.message : String(expressError)}`,
						{
							middleware: 'JWTAuthMiddleware',
							originalError: expressError
						}
					);
				this.errorLogger.logError(expressMiddlewareError.message);
				if (expressError instanceof Error) {
					this.errorHandler.expressErrorHandler()(
						expressError,
						req,
						res,
						next
					);
				} else {
					this.errorHandler.handleError({
						...HandleErrorStaticParameters,
						error: expressMiddlewareError
					});
				}
				res.sendStatus(500);
			}
		};
	}
	async isTokenExpired(token) {
		let isExpired = await this.cacheService.get(
			`expiredToken:${token}`,
			'bouncerService'
		);
		if (isExpired === null) {
			isExpired = !!(await this.redisService.get(
				`expiredToken:${token}`
			));
			if (isExpired) {
				await this.cacheService.set(
					`expiredToken:${token}`,
					true,
					'bouncerService',
					this.cacheDuration
				);
			}
		}
		return isExpired;
	}
	async isTokenRevoked(token) {
		const revokedTokens = await this.getCachedTokenList(
			this.revocationListCacheKey,
			this.loadRevokedTokens.bind(this)
		);
		return revokedTokens.has(token);
	}
	async expireToken(token, ttl) {
		const remainingTime = ttl - Math.floor(Date.now() / 1000);
		await this.redisService.set(`expiredToken:${token}`, true, ttl);
		await this.cacheService.set(
			`expiredToken:${token}`,
			true,
			'bouncerService',
			Math.min(this.cacheDuration, remainingTime)
		);
		this.expiredTokens.add(token);
		await this.saveExpiredTokens();
	}
	async revokeToken(token) {
		const revokedTokens = await this.loadRevokedTokens();
		revokedTokens.add(token);
		await this.saveRevokedTokens(revokedTokens);
		await this.cacheService.del(
			this.revocationListCacheKey,
			'bouncerService'
		);
	}
	async getCachedTokenList(cacheKey, fileLoader) {
		let tokenList = await this.cacheService.get(cacheKey, 'bouncerService');
		if (!tokenList) {
			const tokenSet = await fileLoader();
			tokenList = Array.from(tokenSet);
			await this.cacheService.set(
				cacheKey,
				tokenList,
				'bouncerService',
				this.cacheDuration
			);
		}
		return new Set(tokenList);
	}
	async loadRevokedTokens() {
		const revokedTokens = new Set();
		try {
			if (await fs.promises.stat(this.revocationListFilePath)) {
				const fileData = await fs.promises.readFile(
					this.revocationListFilePath,
					'utf8'
				);
				const tokenList = JSON.parse(fileData);
				tokenList.forEach(token => revokedTokens.add(token));
				this.logger.info('Token revocation list loaded successfully.');
			}
		} catch (error) {
			this.logger.error(`Error loading token revocation list: ${error}`);
		}
		return revokedTokens;
	}
	async loadExpiredTokens() {
		const expiredTokens = new Set();
		try {
			if (await fs.promises.stat(this.expiryListFilePath)) {
				const fileData = await fs.promises.readFile(
					this.expiryListFilePath,
					'utf8'
				);
				const tokenList = JSON.parse(fileData);
				tokenList.forEach(token => expiredTokens.add(token));
				this.logger.info('Expired token list loaded successfully.');
			}
		} catch (error) {
			this.logger.error(`Error loading expired token list: ${error}`);
		}
		return expiredTokens;
	}
	async saveExpiredTokens() {
		await this.withFileLock(this.expiryListFilePath, async () => {
			const tokenList = Array.from(this.expiredTokens);
			await fs.promises.writeFile(
				this.expiryListFilePath,
				JSON.stringify(tokenList)
			);
			this.logger.info('Expired token list saved successfully.');
			await this.cacheService.del(
				this.expiryListCacheKey,
				'bouncerService'
			);
		});
	}
	async saveRevokedTokens(tokens) {
		await this.withFileLock(this.revocationListFilePath, async () => {
			const tokenList = Array.from(tokens);
			await fs.promises.writeFile(
				this.revocationListFilePath,
				JSON.stringify(tokenList)
			);
			this.logger.info('Revoked token list saved successfully.');
		});
		await this.cacheService.del(
			this.revocationListCacheKey,
			'bouncerService'
		);
	}
	async cleanupExpiredTokens() {
		const now = Date.now();
		this.expiredTokens.forEach(token => {
			const tokenData = jwt.decode(token);
			if (
				tokenData &&
				typeof tokenData !== 'string' &&
				tokenData.exp &&
				tokenData.exp * 1000 < now
			) {
				this.expiredTokens.delete(token);
				this.logger.info(`Removed expired token: ${token}`);
			}
		});
		await this.saveExpiredTokens();
	}
	async cleanupRevokedTokens() {
		const envConfig = await ServiceFactory.getEnvConfigService();
		const revocationRetentionPeriod =
			envConfig.getEnvVariable('revokedTokenRetentionPeriod') ||
			30 * 24 * 60 * 60 * 1000; // 30 days in milliseconds
		const now = Date.now();
		let revokedTokenRemoved = false;
		this.revokedTokens.forEach(token => {
			const tokenData = jwt.decode(token);
			if (
				tokenData &&
				typeof tokenData !== 'string' &&
				tokenData.iat &&
				tokenData.iat * 1000 < now - revocationRetentionPeriod
			) {
				this.revokedTokens.delete(token);
				revokedTokenRemoved = true;
				this.logger.info(`Removed revoked token: ${token}`);
			}
		});
		if (revokedTokenRemoved) {
			await this.saveRevokedTokens(this.revokedTokens);
			this.logger.info('Revoked tokens cleanup completed and saved.');
		} else {
			this.logger.info('No revoked tokens required cleanup.');
		}
	}
	async withFileLock(filePath, operation) {
		let release = () => {};
		try {
			release = await lockfile.lock(filePath);
			await operation();
		} catch (error) {
			this.logger.error(
				`Error during file operation with lock: ${error}`
			);
		} finally {
			if (release) {
				release();
			}
		}
	}
	async shutdown() {
		try {
			if (this.cleanupExpiredTokensInterval) {
				clearInterval(this.cleanupExpiredTokensInterval);
			}
			if (this.cleanupRevokedTokensInterval) {
				clearInterval(this.cleanupRevokedTokensInterval);
			}
			await this.cacheService.del(
				this.expiryListCacheKey,
				'gatekeeperService'
			);
			await this.cacheService.del(
				this.revocationListCacheKey,
				'gatekeeperService'
			);
			JWTAuthMiddlewareService.instance = null;
			this.logger.info('JWTAuthMiddlewareService shutdown successfully.');
		} catch (error) {
			this.errorLogger.logError(
				`Error shutting down JWTAuthMiddlewareService: ${error instanceof Error ? error.message : error}`
			);
		}
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSldUQXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlL0pXVEF1dGgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBV2xELE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQztBQUNwQixPQUFPLEdBQUcsTUFBTSxjQUFjLENBQUM7QUFDL0IsT0FBTyxRQUFRLE1BQU0saUJBQWlCLENBQUM7QUFFdkMsTUFBTSxPQUFPLHdCQUF3QjtJQUc1QixNQUFNLENBQUMsUUFBUSxHQUFvQyxJQUFJLENBQUM7SUFFeEQsTUFBTSxDQUE0QjtJQUNsQyxXQUFXLENBQThCO0lBQ3pDLFlBQVksQ0FBK0I7SUFDM0MsaUJBQWlCLENBQTZCO0lBQzlDLFlBQVksQ0FBd0I7SUFDcEMsWUFBWSxDQUF3QjtJQUVwQyxhQUFhLEdBQWdCLElBQUksR0FBRyxFQUFFLENBQUM7SUFDdkMsYUFBYSxHQUFnQixJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ3ZDLGtCQUFrQixDQUFTO0lBQzNCLHNCQUFzQixDQUFTO0lBQy9CLGtCQUFrQixHQUFHLHFCQUFxQixDQUFDO0lBQzNDLHNCQUFzQixHQUFHLHFCQUFxQixDQUFDO0lBQy9DLGFBQWEsQ0FBUztJQUN0Qiw0QkFBNEIsR0FBMEIsSUFBSSxDQUFDO0lBQzNELDRCQUE0QixHQUEwQixJQUFJLENBQUM7SUFFbkUsWUFDQyxNQUFpQyxFQUNqQyxXQUF3QyxFQUN4QyxZQUEwQyxFQUMxQyxpQkFBNkMsRUFDN0MsWUFBbUMsRUFDbkMsWUFBbUMsRUFDbkMsU0FBb0M7UUFFcEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7UUFDL0IsSUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZ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Q0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDaEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQ3hCLGlEQUFpRCxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FDakcsQ0FBQztRQUNILENBQUM7SUFDRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmV4dEZ1bmN0aW9uLCBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgU2VydmljZUZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5JztcbmltcG9ydCB7XG5cdEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdENhY2hlU2VydmljZUludGVyZmFjZSxcblx0RW52Q29uZmlnU2VydmljZUludGVyZmFjZSxcblx0RXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZSxcblx0RXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRHYXRla2VlcGVyU2VydmljZUludGVyZmFjZSxcblx0SldUQXV0aE1pZGRsZXdhcmVTZXJ2aWNlSW50ZXJmYWNlLFxuXHRSZWRpc1NlcnZpY2VJbnRlcmZhY2Vcbn0gZnJvbSAnLi4vaW5kZXgvaW50ZXJmYWNlcy9zZXJ2aWNlcyc7XG5pbXBvcnQgeyBIYW5kbGVFcnJvclN0YXRpY1BhcmFtZXRlcnMgfSBmcm9tICcuLi9pbmRleC9wYXJhbWV0ZXJzJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgand0IGZyb20gJ2pzb253ZWJ0b2tlbic7XG5pbXBvcnQgbG9ja2ZpbGUgZnJvbSAncHJvcGVyLWxvY2tmaWxlJztcblxuZXhwb3J0IGNsYXNzIEpXVEF1dGhNaWRkbGV3YXJlU2VydmljZVxuXHRpbXBsZW1lbnRzIEpXVEF1dGhNaWRkbGV3YXJlU2VydmljZUludGVyZmFjZVxue1xuXHRwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTogSldUQXV0aE1pZGRsZXdhcmVTZXJ2aWNlIHwgbnVsbCA9IG51bGw7XG5cblx0cHJpdmF0ZSBsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBlcnJvckhhbmRsZXI6IEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZ2F0ZWtlZXBlclNlcnZpY2U6IEdhdGVrZWVwZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIGNhY2hlU2VydmljZTogQ2FjaGVTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIHJlZGlzU2VydmljZTogUmVkaXNTZXJ2aWNlSW50ZXJmYWNlO1xuXG5cdHByaXZhdGUgZXhwaXJlZFRva2VuczogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7XG5cdHByaXZhdGUgcmV2b2tlZFRva2VuczogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7XG5cdHByaXZhdGUgZXhwaXJ5TGlzdEZpbGVQYXRoOiBzdHJpbmc7XG5cdHByaXZhdGUgcmV2b2NhdGlvbkxpc3RGaWxlUGF0aDogc3RyaW5nO1xuXHRwcml2YXRlIGV4cGlyeUxpc3RDYWNoZUtleSA9ICd0b2tlbkV4cGlyYXRpb25MaXN0Jztcblx0cHJpdmF0ZSByZXZvY2F0aW9uTGlzdENhY2hlS2V5ID0gJ3Rva2VuUmV2b2NhdGlvbkxpc3QnO1xuXHRwcml2YXRlIGNhY2hlRHVyYXRpb246IG51bWJlcjtcblx0cHJpdmF0ZSBjbGVhbnVwRXhwaXJlZFRva2Vuc0ludGVydmFsOiBOb2RlSlMuVGltZW91dCB8IG51bGwgPSBudWxsO1xuXHRwcml2YXRlIGNsZWFudXBSZXZva2VkVG9rZW5zSW50ZXJ2YWw6IE5vZGVKUy5UaW1lb3V0IHwgbnVsbCA9IG51bGw7XG5cblx0cHJpdmF0ZSBjb25zdHJ1Y3Rvcihcblx0XHRsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0ZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0XHRlcnJvckhhbmRsZXI6IEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0Z2F0ZWtlZXBlclNlcnZpY2U6IEdhdGVrZWVwZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGNhY2hlU2VydmljZTogQ2FjaGVTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdHJlZGlzU2VydmljZTogUmVkaXNTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGVudkNvbmZpZzogRW52Q29uZmlnU2VydmljZUludGVyZmFjZVxuXHQpIHtcblx0XHR0aGlzLmxvZ2dlciA9IGxvZ2dlcjtcblx0XHR0aGlzLmVycm9yTG9nZ2VyID0gZXJyb3JMb2dnZXI7XG5cdFx0dGhpcy5lcnJvckhhbmRsZXIgPSBlcnJvckhhbmRsZXI7XG5cdFx0dGhpcy5nYXRla2VlcGVyU2VydmljZSA9IGdhdGVrZWVwZXJTZXJ2aWNlO1xuXHRcdHRoaXMuY2FjaGVTZXJ2aWNlID0gY2FjaGVTZXJ2aWNlO1xuXHRcdHRoaXMucmVkaXNTZXJ2aWNlID0gcmVkaXNTZXJ2aWNlO1xuXG5cdFx0dGhpcy5leHBpcnlMaXN0RmlsZVBhdGggPSBlbnZDb25maWcuZ2V0RW52VmFyaWFibGUoXG5cdFx0XHQndG9rZW5FeHBpcnlMaXN0UGF0aCdcblx0XHQpO1xuXHRcdHRoaXMucmV2b2NhdGlvbkxpc3RGaWxlUGF0aCA9IGVudkNvbmZpZy5nZXRFbnZWYXJpYWJsZShcblx0XHRcdCd0b2tlblJldm9rZWRMaXN0UGF0aCdcblx0XHQpO1xuXHRcdHRoaXMuY2FjaGVEdXJhdGlvbiA9XG5cdFx0XHRlbnZDb25maWcuZ2V0RW52VmFyaWFibGUoJ3Rva2VuQ2FjaGVEdXJhdGlvbicpIHx8IDM2MDA7XG5cblx0XHR0aGlzLmxvYWRFeHBpcmVkVG9rZW5zKCk7XG5cdFx0dGhpcy5sb2FkUmV2b2tlZFRva2VucygpO1xuXHRcdHRoaXMuY2xlYW51cEV4cGlyZWRUb2tlbnNJbnRlcnZhbCA9IHNldEludGVydmFsKFxuXHRcdFx0KCkgPT4gdGhpcy5jbGVhbnVwRXhwaXJlZFRva2VucygpLFxuXHRcdFx0NjAgKiAxMDAwXG5cdFx0KTtcblx0XHR0aGlzLmNsZWFudXBSZXZva2VkVG9rZW5zSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChcblx0XHRcdCgpID0+IHRoaXMuY2xlYW51cFJldm9rZWRUb2tlbnMoKSxcblx0XHRcdDYwICogMTAwMFxuXHRcdCk7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGFzeW5jIGdldEluc3RhbmNlKCk6IFByb21pc2U8SldUQXV0aE1pZGRsZXdhcmVTZXJ2aWNlPiB7XG5cdFx0aWYgKCFKV1RBdXRoTWlkZGxld2FyZVNlcnZpY2UuaW5zdGFuY2UpIHtcblx0XHRcdGNvbnN0IGxvZ2dlciA9IGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldExvZ2dlclNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGVycm9yTG9nZ2VyID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0RXJyb3JMb2dnZXJTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBlcnJvckhhbmRsZXIgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRFcnJvckhhbmRsZXJTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBnYXRla2VlcGVyU2VydmljZSA9XG5cdFx0XHRcdGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldEdhdGVrZWVwZXJTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBjYWNoZVNlcnZpY2UgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRDYWNoZVNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IHJlZGlzU2VydmljZSA9IGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldFJlZGlzU2VydmljZSgpO1xuXHRcdFx0Y29uc3QgZW52Q29uZmlnID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0RW52Q29uZmlnU2VydmljZSgpO1xuXG5cdFx0XHRKV1RBdXRoTWlkZGxld2FyZVNlcnZpY2UuaW5zdGFuY2UgPSBuZXcgSldUQXV0aE1pZGRsZXdhcmVTZXJ2aWNlKFxuXHRcdFx0XHRsb2dnZXIsXG5cdFx0XHRcdGVycm9yTG9nZ2VyLFxuXHRcdFx0XHRlcnJvckhhbmRsZXIsXG5cdFx0XHRcdGdhdGVrZWVwZXJTZXJ2aWNlLFxuXHRcdFx0XHRjYWNoZVNlcnZpY2UsXG5cdFx0XHRcdHJlZGlzU2VydmljZSxcblx0XHRcdFx0ZW52Q29uZmlnXG5cdFx0XHQpO1xuXHRcdH1cblxuXHRcdHJldHVybiBKV1RBdXRoTWlkZGxld2FyZVNlcnZpY2UuaW5zdGFuY2U7XG5cdH1cblxuXHRwdWJsaWMgaW5pdGlhbGl6ZUpXVEF1dGhNaWRkbGV3YXJlKCk6IChcblx0XHRyZXE6IFJlcXVlc3QsXG5cdFx0cmVzOiBSZXNwb25zZSxcblx0XHRuZXh0OiBOZXh0RnVuY3Rpb25cblx0KSA9PiBQcm9taXNlPHZvaWQgfCBSZXNwb25zZT4ge1xuXHRcdHJldHVybiBhc3luYyAoXG5cdFx0XHRyZXE6IFJlcXVlc3QsXG5cdFx0XHRyZXM6IFJlc3BvbnNlLFxuXHRcdFx0bmV4dDogTmV4dEZ1bmN0aW9uXG5cdFx0KTogUHJvbWlzZTx2b2lkIHwgUmVzcG9uc2U+ID0+IHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdGNvbnN0IGlwID0gcmVxLmlwO1xuXG5cdFx0XHRcdGlmICghaXApIHtcblx0XHRcdFx0XHR0aGlzLmxvZ2dlci53YXJuKCdObyBJUCBhZGRyZXNzIGZvdW5kIGluIHJlcXVlc3QnKTtcblx0XHRcdFx0XHRyZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ0FjY2VzcyBkZW5pZWQnIH0pO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0aWYgKGF3YWl0IHRoaXMuZ2F0ZWtlZXBlclNlcnZpY2UuaXNUZW1wb3JhcmlseUJsYWNrbGlzdGVkKGlwKSkge1xuXHRcdFx0XHRcdHRoaXMubG9nZ2VyLndhcm4oYElQICR7aXB9IGlzIHRlbXBvcmFyaWx5IGJsYWNrbGlzdGVkLmApO1xuXHRcdFx0XHRcdHJldHVybiByZXNcblx0XHRcdFx0XHRcdC5zdGF0dXMoNDAzKVxuXHRcdFx0XHRcdFx0Lmpzb24oeyBlcnJvcjogJ0FjY2VzcyB0ZW1wb3JhcmlseSBkZW5pZWQnIH0pO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0aWYgKGF3YWl0IHRoaXMuZ2F0ZWtlZXBlclNlcnZpY2UuaXNCbGFja2xpc3RlZChpcCkpIHtcblx0XHRcdFx0XHR0aGlzLmxvZ2dlci53YXJuKGBJUCAke2lwfSBpcyBibGFja2xpc3RlZC5gKTtcblx0XHRcdFx0XHRyZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ0FjY2VzcyBkZW5pZWQnIH0pO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0Y29uc3QgYXV0aEhlYWRlciA9IHJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb247XG5cdFx0XHRcdGNvbnN0IHRva2VuID0gYXV0aEhlYWRlcj8uc3BsaXQoJyAnKVsxXTtcblxuXHRcdFx0XHRpZiAoIXRva2VuKSB7XG5cdFx0XHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dXYXJuKFxuXHRcdFx0XHRcdFx0J05vIEpXVCB0b2tlbiBmb3VuZCBpbiB0aGUgYXV0aG9yaXphdGlvbiBoZWFkZXInXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRyZXR1cm4gcmVzLnNlbmRTdGF0dXMoNDAzKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGlmIChhd2FpdCB0aGlzLmlzVG9rZW5SZXZva2VkKHRva2VuKSkge1xuXHRcdFx0XHRcdHRoaXMubG9nZ2VyLndhcm4oYEpXVCB0b2tlbiBpcyByZXZva2VkOiAke3Rva2VufWApO1xuXHRcdFx0XHRcdHJldHVybiByZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnVG9rZW4gcmV2b2tlZCcgfSk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRpZiAoYXdhaXQgdGhpcy5pc1Rva2VuRXhwaXJlZCh0b2tlbikpIHtcblx0XHRcdFx0XHR0aGlzLmxvZ2dlci53YXJuKGBKV1QgdG9rZW4gaGFzIGV4cGlyZWQ6ICR7dG9rZW59YCk7XG5cdFx0XHRcdFx0cmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICdUb2tlbiBleHBpcmVkJyB9KTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGNvbnN0IGp3dFNlcnZpY2UgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRKV1RTZXJ2aWNlKCk7XG5cdFx0XHRcdGNvbnN0IHVzZXIgPSBhd2FpdCBqd3RTZXJ2aWNlLnZlcmlmeUpXVCh0b2tlbik7XG5cblx0XHRcdFx0aWYgKCF1c2VyKSB7XG5cdFx0XHRcdFx0dGhpcy5sb2dnZXIud2FybignSW52YWxpZCBKV1QgdG9rZW4nKTtcblx0XHRcdFx0XHRyZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgdG9rZW4nIH0pO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0cmVxLnVzZXIgPSB1c2VyO1xuXHRcdFx0XHRuZXh0KCk7XG5cdFx0XHR9IGNhdGNoIChleHByZXNzRXJyb3IpIHtcblx0XHRcdFx0Y29uc3QgZXhwcmVzc01pZGRsZXdhcmVFcnJvciA9XG5cdFx0XHRcdFx0bmV3IHRoaXMuZXJyb3JIYW5kbGVyLkVycm9yQ2xhc3Nlcy5FeHByZXNzRXJyb3IoXG5cdFx0XHRcdFx0XHRgRXJyb3IgaW4gSldUQXV0aE1pZGRsZXdhcmU6ICR7ZXhwcmVzc0Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBleHByZXNzRXJyb3IubWVzc2FnZSA6IFN0cmluZyhleHByZXNzRXJyb3IpfWAsXG5cdFx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRcdG1pZGRsZXdhcmU6ICdKV1RBdXRoTWlkZGxld2FyZScsXG5cdFx0XHRcdFx0XHRcdG9yaWdpbmFsRXJyb3I6IGV4cHJlc3NFcnJvclxuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nRXJyb3IoZXhwcmVzc01pZGRsZXdhcmVFcnJvci5tZXNzYWdlKTtcblxuXHRcdFx0XHRpZiAoZXhwcmVzc0Vycm9yIGluc3RhbmNlb2YgRXJyb3IpIHtcblx0XHRcdFx0XHR0aGlzLmVycm9ySGFuZGxlci5leHByZXNzRXJyb3JIYW5kbGVyKCkoXG5cdFx0XHRcdFx0XHRleHByZXNzRXJyb3IsXG5cdFx0XHRcdFx0XHRyZXEsXG5cdFx0XHRcdFx0XHRyZXMsXG5cdFx0XHRcdFx0XHRuZXh0XG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7XG5cdFx0XHRcdFx0XHQuLi5IYW5kbGVFcnJvclN0YXRpY1BhcmFtZXRlcnMsXG5cdFx0XHRcdFx0XHRlcnJvcjogZXhwcmVzc01pZGRsZXdhcmVFcnJvclxuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9XG5cdFx0XHRcdHJlcy5zZW5kU3RhdHVzKDUwMCk7XG5cdFx0XHR9XG5cdFx0fTtcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgaXNUb2tlbkV4cGlyZWQodG9rZW46IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuXHRcdGxldCBpc0V4cGlyZWQgPSBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5nZXQ8Ym9vbGVhbj4oXG5cdFx0XHRgZXhwaXJlZFRva2VuOiR7dG9rZW59YCxcblx0XHRcdCdib3VuY2VyU2VydmljZSdcblx0XHQpO1xuXG5cdFx0aWYgKGlzRXhwaXJlZCA9PT0gbnVsbCkge1xuXHRcdFx0aXNFeHBpcmVkID0gISEoYXdhaXQgdGhpcy5yZWRpc1NlcnZpY2UuZ2V0KFxuXHRcdFx0XHRgZXhwaXJlZFRva2VuOiR7dG9rZW59YFxuXHRcdFx0KSk7XG5cblx0XHRcdGlmIChpc0V4cGlyZWQpIHtcblx0XHRcdFx0YXdhaXQgdGhpcy5jYWNoZVNlcnZpY2Uuc2V0KFxuXHRcdFx0XHRcdGBleHBpcmVkVG9rZW46JHt0b2tlbn1gLFxuXHRcdFx0XHRcdHRydWUsXG5cdFx0XHRcdFx0J2JvdW5jZXJTZXJ2aWNlJyxcblx0XHRcdFx0XHR0aGlzLmNhY2hlRHVyYXRpb25cblx0XHRcdFx0KTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gaXNFeHBpcmVkO1xuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBpc1Rva2VuUmV2b2tlZCh0b2tlbjogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG5cdFx0Y29uc3QgcmV2b2tlZFRva2VucyA9IGF3YWl0IHRoaXMuZ2V0Q2FjaGVkVG9rZW5MaXN0KFxuXHRcdFx0dGhpcy5yZXZvY2F0aW9uTGlzdENhY2hlS2V5LFxuXHRcdFx0dGhpcy5sb2FkUmV2b2tlZFRva2Vucy5iaW5kKHRoaXMpXG5cdFx0KTtcblxuXHRcdHJldHVybiByZXZva2VkVG9rZW5zLmhhcyh0b2tlbik7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgZXhwaXJlVG9rZW4odG9rZW46IHN0cmluZywgdHRsOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRjb25zdCByZW1haW5pbmdUaW1lID0gdHRsIC0gTWF0aC5mbG9vcihEYXRlLm5vdygpIC8gMTAwMCk7XG5cblx0XHRhd2FpdCB0aGlzLnJlZGlzU2VydmljZS5zZXQoYGV4cGlyZWRUb2tlbjoke3Rva2VufWAsIHRydWUsIHR0bCk7XG5cblx0XHRhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5zZXQoXG5cdFx0XHRgZXhwaXJlZFRva2VuOiR7dG9rZW59YCxcblx0XHRcdHRydWUsXG5cdFx0XHQnYm91bmNlclNlcnZpY2UnLFxuXHRcdFx0TWF0aC5taW4odGhpcy5jYWNoZUR1cmF0aW9uLCByZW1haW5pbmdUaW1lKVxuXHRcdCk7XG5cblx0XHR0aGlzLmV4cGlyZWRUb2tlbnMuYWRkKHRva2VuKTtcblx0XHRhd2FpdCB0aGlzLnNhdmVFeHBpcmVkVG9rZW5zKCk7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgcmV2b2tlVG9rZW4odG9rZW46IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGNvbnN0IHJldm9rZWRUb2tlbnMgPSBhd2FpdCB0aGlzLmxvYWRSZXZva2VkVG9rZW5zKCk7XG5cblx0XHRyZXZva2VkVG9rZW5zLmFkZCh0b2tlbik7XG5cblx0XHRhd2FpdCB0aGlzLnNhdmVSZXZva2VkVG9rZW5zKHJldm9rZWRUb2tlbnMpO1xuXHRcdGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLmRlbChcblx0XHRcdHRoaXMucmV2b2NhdGlvbkxpc3RDYWNoZUtleSxcblx0XHRcdCdib3VuY2VyU2VydmljZSdcblx0XHQpO1xuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBnZXRDYWNoZWRUb2tlbkxpc3QoXG5cdFx0Y2FjaGVLZXk6IHN0cmluZyxcblx0XHRmaWxlTG9hZGVyOiAoKSA9PiBQcm9taXNlPFNldDxzdHJpbmc+PlxuXHQpOiBQcm9taXNlPFNldDxzdHJpbmc+PiB7XG5cdFx0bGV0IHRva2VuTGlzdCA9IGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLmdldDxzdHJpbmdbXT4oXG5cdFx0XHRjYWNoZUtleSxcblx0XHRcdCdib3VuY2VyU2VydmljZSdcblx0XHQpO1xuXG5cdFx0aWYgKCF0b2tlbkxpc3QpIHtcblx0XHRcdGNvbnN0IHRva2VuU2V0ID0gYXdhaXQgZmlsZUxvYWRlcigpO1xuXHRcdFx0dG9rZW5MaXN0ID0gQXJyYXkuZnJvbSh0b2tlblNldCk7XG5cblx0XHRcdGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLnNldChcblx0XHRcdFx0Y2FjaGVLZXksXG5cdFx0XHRcdHRva2VuTGlzdCxcblx0XHRcdFx0J2JvdW5jZXJTZXJ2aWNlJyxcblx0XHRcdFx0dGhpcy5jYWNoZUR1cmF0aW9uXG5cdFx0XHQpO1xuXHRcdH1cblxuXHRcdHJldHVybiBuZXcgU2V0KHRva2VuTGlzdCk7XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIGxvYWRSZXZva2VkVG9rZW5zKCk6IFByb21pc2U8U2V0PHN0cmluZz4+IHtcblx0XHRjb25zdCByZXZva2VkVG9rZW5zID0gbmV3IFNldDxzdHJpbmc+KCk7XG5cdFx0dHJ5IHtcblx0XHRcdGlmIChhd2FpdCBmcy5wcm9taXNlcy5zdGF0KHRoaXMucmV2b2NhdGlvbkxpc3RGaWxlUGF0aCkpIHtcblx0XHRcdFx0Y29uc3QgZmlsZURhdGEgPSBhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZShcblx0XHRcdFx0XHR0aGlzLnJldm9jYXRpb25MaXN0RmlsZVBhdGgsXG5cdFx0XHRcdFx0J3V0ZjgnXG5cdFx0XHRcdCk7XG5cdFx0XHRcdGNvbnN0IHRva2VuTGlzdDogc3RyaW5nW10gPSBKU09OLnBhcnNlKGZpbGVEYXRhKTtcblx0XHRcdFx0dG9rZW5MaXN0LmZvckVhY2godG9rZW4gPT4gcmV2b2tlZFRva2Vucy5hZGQodG9rZW4pKTtcblx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnVG9rZW4gcmV2b2NhdGlvbiBsaXN0IGxvYWRlZCBzdWNjZXNzZnVsbHkuJyk7XG5cdFx0XHR9XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMubG9nZ2VyLmVycm9yKGBFcnJvciBsb2FkaW5nIHRva2VuIHJldm9jYXRpb24gbGlzdDogJHtlcnJvcn1gKTtcblx0XHR9XG5cdFx0cmV0dXJuIHJldm9rZWRUb2tlbnM7XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIGxvYWRFeHBpcmVkVG9rZW5zKCk6IFByb21pc2U8U2V0PHN0cmluZz4+IHtcblx0XHRjb25zdCBleHBpcmVkVG9rZW5zID0gbmV3IFNldDxzdHJpbmc+KCk7XG5cdFx0dHJ5IHtcblx0XHRcdGlmIChhd2FpdCBmcy5wcm9taXNlcy5zdGF0KHRoaXMuZXhwaXJ5TGlzdEZpbGVQYXRoKSkge1xuXHRcdFx0XHRjb25zdCBmaWxlRGF0YSA9IGF3YWl0IGZzLnByb21pc2VzLnJlYWRGaWxlKFxuXHRcdFx0XHRcdHRoaXMuZXhwaXJ5TGlzdEZpbGVQYXRoLFxuXHRcdFx0XHRcdCd1dGY4J1xuXHRcdFx0XHQpO1xuXHRcdFx0XHRjb25zdCB0b2tlbkxpc3Q6IHN0cmluZ1tdID0gSlNPTi5wYXJzZShmaWxlRGF0YSk7XG5cdFx0XHRcdHRva2VuTGlzdC5mb3JFYWNoKHRva2VuID0+IGV4cGlyZWRUb2tlbnMuYWRkKHRva2VuKSk7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ0V4cGlyZWQgdG9rZW4gbGlzdCBsb2FkZWQgc3VjY2Vzc2Z1bGx5LicpO1xuXHRcdFx0fVxuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5lcnJvcihgRXJyb3IgbG9hZGluZyBleHBpcmVkIHRva2VuIGxpc3Q6ICR7ZXJyb3J9YCk7XG5cdFx0fVxuXHRcdHJldHVybiBleHBpcmVkVG9rZW5zO1xuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBzYXZlRXhwaXJlZFRva2VucygpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRhd2FpdCB0aGlzLndpdGhGaWxlTG9jayh0aGlzLmV4cGlyeUxpc3RGaWxlUGF0aCwgYXN5bmMgKCkgPT4ge1xuXHRcdFx0Y29uc3QgdG9rZW5MaXN0ID0gQXJyYXkuZnJvbSh0aGlzLmV4cGlyZWRUb2tlbnMpO1xuXG5cdFx0XHRhd2FpdCBmcy5wcm9taXNlcy53cml0ZUZpbGUoXG5cdFx0XHRcdHRoaXMuZXhwaXJ5TGlzdEZpbGVQYXRoLFxuXHRcdFx0XHRKU09OLnN0cmluZ2lmeSh0b2tlbkxpc3QpXG5cdFx0XHQpO1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnRXhwaXJlZCB0b2tlbiBsaXN0IHNhdmVkIHN1Y2Nlc3NmdWxseS4nKTtcblxuXHRcdFx0YXdhaXQgdGhpcy5jYWNoZVNlcnZpY2UuZGVsKFxuXHRcdFx0XHR0aGlzLmV4cGlyeUxpc3RDYWNoZUtleSxcblx0XHRcdFx0J2JvdW5jZXJTZXJ2aWNlJ1xuXHRcdFx0KTtcblx0XHR9KTtcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgc2F2ZVJldm9rZWRUb2tlbnModG9rZW5zOiBTZXQ8c3RyaW5nPik6IFByb21pc2U8dm9pZD4ge1xuXHRcdGF3YWl0IHRoaXMud2l0aEZpbGVMb2NrKHRoaXMucmV2b2NhdGlvbkxpc3RGaWxlUGF0aCwgYXN5bmMgKCkgPT4ge1xuXHRcdFx0Y29uc3QgdG9rZW5MaXN0ID0gQXJyYXkuZnJvbSh0b2tlbnMpO1xuXHRcdFx0YXdhaXQgZnMucHJvbWlzZXMud3JpdGVGaWxlKFxuXHRcdFx0XHR0aGlzLnJldm9jYXRpb25MaXN0RmlsZVBhdGgsXG5cdFx0XHRcdEpTT04uc3RyaW5naWZ5KHRva2VuTGlzdClcblx0XHRcdCk7XG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdSZXZva2VkIHRva2VuIGxpc3Qgc2F2ZWQgc3VjY2Vzc2Z1bGx5LicpO1xuXHRcdH0pO1xuXG5cdFx0YXdhaXQgdGhpcy5jYWNoZVNlcnZpY2UuZGVsKFxuXHRcdFx0dGhpcy5yZXZvY2F0aW9uTGlzdENhY2hlS2V5LFxuXHRcdFx0J2JvdW5jZXJTZXJ2aWNlJ1xuXHRcdCk7XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIGNsZWFudXBFeHBpcmVkVG9rZW5zKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG5cdFx0dGhpcy5leHBpcmVkVG9rZW5zLmZvckVhY2godG9rZW4gPT4ge1xuXHRcdFx0Y29uc3QgdG9rZW5EYXRhID0gand0LmRlY29kZSh0b2tlbik7XG5cblx0XHRcdGlmIChcblx0XHRcdFx0dG9rZW5EYXRhICYmXG5cdFx0XHRcdHR5cGVvZiB0b2tlbkRhdGEgIT09ICdzdHJpbmcnICYmXG5cdFx0XHRcdHRva2VuRGF0YS5leHAgJiZcblx0XHRcdFx0dG9rZW5EYXRhLmV4cCAqIDEwMDAgPCBub3dcblx0XHRcdCkge1xuXHRcdFx0XHR0aGlzLmV4cGlyZWRUb2tlbnMuZGVsZXRlKHRva2VuKTtcblx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhgUmVtb3ZlZCBleHBpcmVkIHRva2VuOiAke3Rva2VufWApO1xuXHRcdFx0fVxuXHRcdH0pO1xuXG5cdFx0YXdhaXQgdGhpcy5zYXZlRXhwaXJlZFRva2VucygpO1xuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBjbGVhbnVwUmV2b2tlZFRva2VucygpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRjb25zdCBlbnZDb25maWcgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRFbnZDb25maWdTZXJ2aWNlKCk7XG5cdFx0Y29uc3QgcmV2b2NhdGlvblJldGVudGlvblBlcmlvZCA9XG5cdFx0XHRlbnZDb25maWcuZ2V0RW52VmFyaWFibGUoJ3Jldm9rZWRUb2tlblJldGVudGlvblBlcmlvZCcpIHx8XG5cdFx0XHQzMCAqIDI0ICogNjAgKiA2MCAqIDEwMDA7IC8vIDMwIGRheXMgaW4gbWlsbGlzZWNvbmRzXG5cdFx0Y29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcblx0XHRsZXQgcmV2b2tlZFRva2VuUmVtb3ZlZCA9IGZhbHNlO1xuXG5cdFx0dGhpcy5yZXZva2VkVG9rZW5zLmZvckVhY2godG9rZW4gPT4ge1xuXHRcdFx0Y29uc3QgdG9rZW5EYXRhID0gand0LmRlY29kZSh0b2tlbik7XG5cblx0XHRcdGlmIChcblx0XHRcdFx0dG9rZW5EYXRhICYmXG5cdFx0XHRcdHR5cGVvZiB0b2tlbkRhdGEgIT09ICdzdHJpbmcnICYmXG5cdFx0XHRcdHRva2VuRGF0YS5pYXQgJiZcblx0XHRcdFx0dG9rZW5EYXRhLmlhdCAqIDEwMDAgPCBub3cgLSByZXZvY2F0aW9uUmV0ZW50aW9uUGVyaW9kXG5cdFx0XHQpIHtcblx0XHRcdFx0dGhpcy5yZXZva2VkVG9rZW5zLmRlbGV0ZSh0b2tlbik7XG5cdFx0XHRcdHJldm9rZWRUb2tlblJlbW92ZWQgPSB0cnVlO1xuXHRcdFx0XHR0aGlzLmxvZ2dlci5pbmZvKGBSZW1vdmVkIHJldm9rZWQgdG9rZW46ICR7dG9rZW59YCk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cblx0XHRpZiAocmV2b2tlZFRva2VuUmVtb3ZlZCkge1xuXHRcdFx0YXdhaXQgdGhpcy5zYXZlUmV2b2tlZFRva2Vucyh0aGlzLnJldm9rZWRUb2tlbnMpO1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnUmV2b2tlZCB0b2tlbnMgY2xlYW51cCBjb21wbGV0ZWQgYW5kIHNhdmVkLicpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdObyByZXZva2VkIHRva2VucyByZXF1aXJlZCBjbGVhbnVwLicpO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgd2l0aEZpbGVMb2NrKFxuXHRcdGZpbGVQYXRoOiBzdHJpbmcsXG5cdFx0b3BlcmF0aW9uOiAoKSA9PiBQcm9taXNlPHZvaWQ+XG5cdCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGxldCByZWxlYXNlOiAoKSA9PiB2b2lkID0gKCkgPT4ge307XG5cdFx0dHJ5IHtcblx0XHRcdHJlbGVhc2UgPSBhd2FpdCBsb2NrZmlsZS5sb2NrKGZpbGVQYXRoKTtcblx0XHRcdGF3YWl0IG9wZXJhdGlvbigpO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5lcnJvcihcblx0XHRcdFx0YEVycm9yIGR1cmluZyBmaWxlIG9wZXJhdGlvbiB3aXRoIGxvY2s6ICR7ZXJyb3J9YFxuXHRcdFx0KTtcblx0XHR9IGZpbmFsbHkge1xuXHRcdFx0aWYgKHJlbGVhc2UpIHtcblx0XHRcdFx0cmVsZWFzZSgpO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBzaHV0ZG93bigpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHR0cnkge1xuXHRcdFx0aWYgKHRoaXMuY2xlYW51cEV4cGlyZWRUb2tlbnNJbnRlcnZhbCkge1xuXHRcdFx0XHRjbGVhckludGVydmFsKHRoaXMuY2xlYW51cEV4cGlyZWRUb2tlbnNJbnRlcnZhbCk7XG5cdFx0XHR9XG5cdFx0XHRpZiAodGhpcy5jbGVhbnVwUmV2b2tlZFRva2Vuc0ludGVydmFsKSB7XG5cdFx0XHRcdGNsZWFySW50ZXJ2YWwodGhpcy5jbGVhbnVwUmV2b2tlZFRva2Vuc0ludGVydmFsKTtcblx0XHRcdH1cblxuXHRcdFx0YXdhaXQgdGhpcy5jYWNoZVNlcnZpY2UuZGVsKFxuXHRcdFx0XHR0aGlzLmV4cGlyeUxpc3RDYWNoZUtleSxcblx0XHRcdFx0J2dhdGVrZWVwZXJTZXJ2aWNlJ1xuXHRcdFx0KTtcblx0XHRcdGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLmRlbChcblx0XHRcdFx0dGhpcy5yZXZvY2F0aW9uTGlzdENhY2hlS2V5LFxuXHRcdFx0XHQnZ2F0ZWtlZXBlclNlcnZpY2UnXG5cdFx0XHQpO1xuXG5cdFx0XHRKV1RBdXRoTWlkZGxld2FyZVNlcnZpY2UuaW5zdGFuY2UgPSBudWxsO1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnSldUQXV0aE1pZGRsZXdhcmVTZXJ2aWNlIHNodXRkb3duIHN1Y2Nlc3NmdWxseS4nKTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcihcblx0XHRcdFx0YEVycm9yIHNodXR0aW5nIGRvd24gSldUQXV0aE1pZGRsZXdhcmVTZXJ2aWNlOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogZXJyb3J9YFxuXHRcdFx0KTtcblx0XHR9XG5cdH1cbn1cbiJdfQ==
