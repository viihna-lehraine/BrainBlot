import { inRange } from 'range_check';
import path from 'path';
let blacklist = [];
export function createIpBlacklist({
	logger,
	featureFlags,
	__dirname,
	fsModule
}) {
	const IP_BLACKLIST_ENABLED = featureFlags.enableIpBlacklistFlag;
	const loadBlacklist = async () => {
		const filePath = path.join(__dirname, '../../data/blacklist.json');
		try {
			if (fsModule.existsSync(filePath)) {
				const data = fsModule.readFileSync(filePath, 'utf8');
				blacklist = JSON.parse(data);
			}
		} catch (err) {
			logger.error(`Error loading blacklist: ${err}`);
		}
	};
	const saveBlacklist = async () => {
		if (IP_BLACKLIST_ENABLED) {
			const filePath = path.join(__dirname, '../../data/blacklist.json');
			try {
				fsModule.writeFileSync(filePath, JSON.stringify(blacklist));
			} catch (err) {
				logger.error(`Error saving blacklist: ${err}`);
			}
		}
	};
	const initializeBlacklist = async () => {
		if (IP_BLACKLIST_ENABLED) {
			logger.info(
				'IP blacklist middleware is enabled. Initializing blacklist'
			);
			try {
				await loadBlacklist();
				logger.info(
					'Blacklist and range_check module loaded successfully'
				);
			} catch (err) {
				logger.error(`Error during blacklist initialization: ${err}`);
				throw err;
			}
		} else {
			logger.info('IP blacklist middleware is disabled');
		}
	};
	const addToBlacklist = async ip => {
		if (IP_BLACKLIST_ENABLED) {
			logger.info('IP Blacklist is enabled. Adding IP to blacklist');
			if (!blacklist.includes(ip)) {
				blacklist.push(ip);
				await saveBlacklist();
			} else {
				logger.info('IP already in blacklist');
			}
		} else {
			logger.info('IP Blacklist is disabled');
		}
	};
	const ipBlacklistMiddleware = (req, res, next) => {
		if (IP_BLACKLIST_ENABLED) {
			logger.info('IP Blacklist middleware enabled');
			const clientIp = req.ip;
			if (!clientIp) {
				logger.error('Client IP not found');
				res.status(500).json({ error: 'Bad request' });
				return;
			}
			if (blacklist.some(range => inRange(clientIp, range))) {
				logger.warn(`Blocked request from blacklisted IP: ${clientIp}`);
				res.status(403).json({ error: 'Access denied' });
				return;
			}
		} else {
			logger.info('IP Blacklist middleware disabled');
		}
		next();
	};
	const removeFromBlacklist = ip => {
		if (IP_BLACKLIST_ENABLED) {
			blacklist = blacklist.filter(range => range !== ip);
			saveBlacklist();
		}
	};
	return {
		initializeBlacklist,
		loadBlacklist,
		addToBlacklist,
		ipBlacklistMiddleware,
		removeFromBlacklist
	};
}
export const initializeIpBlacklist = createIpBlacklist;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXBCbGFja2xpc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbWlkZGxld2FyZS9pcEJsYWNrbGlzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBR3RDLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQXVCeEIsSUFBSSxTQUFTLEdBQWEsRUFBRSxDQUFDO0FBRTdCLE1BQU0sVUFBVSxpQkFBaUIsQ0FBQyxFQUNqQyxNQUFNLEVBQ04sWUFBWSxFQUNaLFNBQVMsRUFDVCxRQUFRLEVBQ2lCO0lBQ3pCLE1BQU0sb0JBQW9CLEdBQUcsWUFBWSxDQUFDLHFCQUFxQixDQUFDO0lBRWhFLE1BQU0sYUFBYSxHQUFHLEtBQUssSUFBbUIsRUFBRTtRQUMvQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSwyQkFBMkIsQ0FBQyxDQUFDO1FBQ25FLElBQUksQ0FBQztZQUNKLElBQUksUUFBUSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO2dCQUNuQyxNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztnQkFDckQsU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDOUIsQ0FBQztRQUNGLENBQUM7UUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1lBQ2QsTUFBTSxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUNqRCxDQUFDO0lBQ0YsQ0FBQyxDQUFDO0lBRUYsTUFBTSxhQUFhLEdBQUcsS0FBSyxJQUFtQixFQUFFO1FBQy9DLElBQUksb0JBQW9CLEVBQUUsQ0FBQztZQUMxQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSwyQkFBMkIsQ0FBQyxDQUFDO1lBQ25FLElBQUksQ0FBQztnQkFDSixRQUFRLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDN0QsQ0FBQztZQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7Z0JBQ2QsTUFBTSxDQUFDLEtBQUssQ0FBQywyQkFBMkIsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUNoRCxDQUFDO1FBQ0YsQ0FBQztJQUNGLENBQUMsQ0FBQztJQUVGLE1BQU0sbUJBQW1CLEdBQUcsS0FBSyxJQUFtQixFQUFFO1FBQ3JELElBQUksb0JBQW9CLEVBQUUsQ0FBQztZQUMxQixNQUFNLENBQUMsSUFBSSxDQUNWLDREQUE0RCxDQUM1RCxDQUFDO1lBQ0YsSUFBSSxDQUFDO2dCQUNKLE1BQU0sYUFBYSxFQUFFLENBQUM7Z0JBQ3RCLE1BQU0sQ0FBQyxJQUFJLENBQ1Ysc0RBQXNELENBQ3RELENBQUM7WUFDSCxDQUFDO1lBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztnQkFDZCxNQUFNLENBQUMsS0FBSyxDQUFDLDBDQUEwQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO2dCQUM5RCxNQUFNLEdBQUcsQ0FBQztZQUNYLENBQUM7UUFDRixDQUFDO2FBQU0sQ0FBQztZQUNQLE1BQU0sQ0FBQyxJQUFJLENBQUMscUNBQXFDLENBQUMsQ0FBQztRQUNwRCxDQUFDO0lBQ0YsQ0FBQyxDQUFDO0lBRUYsTUFBTSxjQUFjLEdBQUcsS0FBSyxFQUFFLEVBQVUsRUFBaUIsRUFBRTtRQUMxRCxJQUFJLG9CQUFvQixFQUFFLENBQUM7WUFDMUIsTUFBTSxDQUFDLElBQUksQ0FBQyxpREFBaUQsQ0FBQyxDQUFDO1lBQy9ELElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUM7Z0JBQzdCLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ25CLE1BQU0sYUFBYSxFQUFFLENBQUM7WUFDdkIsQ0FBQztpQkFBTSxDQUFDO2dCQUNQLE1BQU0sQ0FBQyxJQUFJLENBQUMseUJBQXlCLENBQUMsQ0FBQztZQUN4QyxDQUFDO1FBQ0YsQ0FBQzthQUFNLENBQUM7WUFDUCxNQUFNLENBQUMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLENBQUM7UUFDekMsQ0FBQztJQUNGLENBQUMsQ0FBQztJQUVGLE1BQU0scUJBQXFCLEdBQUcsQ0FDN0IsR0FBWSxFQUNaLEdBQWEsRUFDYixJQUFrQixFQUNYLEVBQUU7UUFDVCxJQUFJLG9CQUFvQixFQUFFLENBQUM7WUFDMUIsTUFBTSxDQUFDLElBQUksQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFFeEIsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUNmLE1BQU0sQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsQ0FBQztnQkFDcEMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQztnQkFDL0MsT0FBTztZQUNSLENBQUM7WUFFRCxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQztnQkFDdkQsTUFBTSxDQUFDLElBQUksQ0FBQyx3Q0FBd0MsUUFBUSxFQUFFLENBQUMsQ0FBQztnQkFDaEUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsZUFBZSxFQUFFLENBQUMsQ0FBQztnQkFDakQsT0FBTztZQUNSLENBQUM7UUFDRixDQUFDO2FBQU0sQ0FBQztZQUNQLE1BQU0sQ0FBQyxJQUFJLENBQUMsa0NBQWtDLENBQUMsQ0FBQztRQUNqRCxDQUFDO1FBRUQsSUFBSSxFQUFFLENBQUM7SUFDUixDQUFDLENBQUM7SUFFRixNQUFNLG1CQUFtQixHQUFHLENBQUMsRUFBVSxFQUFRLEVBQUU7UUFDaEQsSUFBSSxvQkFBb0IsRUFBRSxDQUFDO1lBQzFCLFNBQVMsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ3BELGFBQWEsRUFBRSxDQUFDO1FBQ2pCLENBQUM7SUFDRixDQUFDLENBQUM7SUFFRixPQUFPO1FBQ04sbUJBQW1CO1FBQ25CLGFBQWE7UUFDYixjQUFjO1FBQ2QscUJBQXFCO1FBQ3JCLG1CQUFtQjtLQUNuQixDQUFDO0FBQ0gsQ0FBQztBQUVELE1BQU0sQ0FBQyxNQUFNLHFCQUFxQixHQUFHLGlCQUFpQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5SYW5nZSB9IGZyb20gJ3JhbmdlX2NoZWNrJztcbmltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuaW50ZXJmYWNlIElwQmxhY2tsaXN0RGVwZW5kZW5jaWVzIHtcblx0bG9nZ2VyOiBSZXR1cm5UeXBlPHR5cGVvZiBpbXBvcnQoJy4uL2NvbmZpZy9sb2dnZXInKS5kZWZhdWx0Pjtcblx0ZmVhdHVyZUZsYWdzOiBSZXR1cm5UeXBlPFxuXHRcdHR5cGVvZiBpbXBvcnQoJy4uL2NvbmZpZy9mZWF0dXJlRmxhZ3MnKS5nZXRGZWF0dXJlRmxhZ3Ncblx0Pjtcblx0X19kaXJuYW1lOiBzdHJpbmc7XG5cdGZzTW9kdWxlOiB0eXBlb2YgZnM7XG59XG5cbmludGVyZmFjZSBJcEJsYWNrbGlzdCB7XG5cdGluaXRpYWxpemVCbGFja2xpc3Q6ICgpID0+IFByb21pc2U8dm9pZD47XG5cdGxvYWRCbGFja2xpc3Q6ICgpID0+IFByb21pc2U8dm9pZD47XG5cdGFkZFRvQmxhY2tsaXN0OiAoaXA6IHN0cmluZykgPT4gUHJvbWlzZTx2b2lkPjtcblx0aXBCbGFja2xpc3RNaWRkbGV3YXJlOiAoXG5cdFx0cmVxOiBSZXF1ZXN0LFxuXHRcdHJlczogUmVzcG9uc2UsXG5cdFx0bmV4dDogTmV4dEZ1bmN0aW9uXG5cdCkgPT4gdm9pZDtcblx0cmVtb3ZlRnJvbUJsYWNrbGlzdDogKGlwOiBzdHJpbmcpID0+IHZvaWQ7XG59XG5cbmxldCBibGFja2xpc3Q6IHN0cmluZ1tdID0gW107XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVJcEJsYWNrbGlzdCh7XG5cdGxvZ2dlcixcblx0ZmVhdHVyZUZsYWdzLFxuXHRfX2Rpcm5hbWUsXG5cdGZzTW9kdWxlXG59OiBJcEJsYWNrbGlzdERlcGVuZGVuY2llcyk6IElwQmxhY2tsaXN0IHtcblx0Y29uc3QgSVBfQkxBQ0tMSVNUX0VOQUJMRUQgPSBmZWF0dXJlRmxhZ3MuZW5hYmxlSXBCbGFja2xpc3RGbGFnO1xuXG5cdGNvbnN0IGxvYWRCbGFja2xpc3QgPSBhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XG5cdFx0Y29uc3QgZmlsZVBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vZGF0YS9ibGFja2xpc3QuanNvbicpO1xuXHRcdHRyeSB7XG5cdFx0XHRpZiAoZnNNb2R1bGUuZXhpc3RzU3luYyhmaWxlUGF0aCkpIHtcblx0XHRcdFx0Y29uc3QgZGF0YSA9IGZzTW9kdWxlLnJlYWRGaWxlU3luYyhmaWxlUGF0aCwgJ3V0ZjgnKTtcblx0XHRcdFx0YmxhY2tsaXN0ID0gSlNPTi5wYXJzZShkYXRhKTtcblx0XHRcdH1cblx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdGxvZ2dlci5lcnJvcihgRXJyb3IgbG9hZGluZyBibGFja2xpc3Q6ICR7ZXJyfWApO1xuXHRcdH1cblx0fTtcblxuXHRjb25zdCBzYXZlQmxhY2tsaXN0ID0gYXN5bmMgKCk6IFByb21pc2U8dm9pZD4gPT4ge1xuXHRcdGlmIChJUF9CTEFDS0xJU1RfRU5BQkxFRCkge1xuXHRcdFx0Y29uc3QgZmlsZVBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vZGF0YS9ibGFja2xpc3QuanNvbicpO1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0ZnNNb2R1bGUud3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgSlNPTi5zdHJpbmdpZnkoYmxhY2tsaXN0KSk7XG5cdFx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdFx0bG9nZ2VyLmVycm9yKGBFcnJvciBzYXZpbmcgYmxhY2tsaXN0OiAke2Vycn1gKTtcblx0XHRcdH1cblx0XHR9XG5cdH07XG5cblx0Y29uc3QgaW5pdGlhbGl6ZUJsYWNrbGlzdCA9IGFzeW5jICgpOiBQcm9taXNlPHZvaWQ+ID0+IHtcblx0XHRpZiAoSVBfQkxBQ0tMSVNUX0VOQUJMRUQpIHtcblx0XHRcdGxvZ2dlci5pbmZvKFxuXHRcdFx0XHQnSVAgYmxhY2tsaXN0IG1pZGRsZXdhcmUgaXMgZW5hYmxlZC4gSW5pdGlhbGl6aW5nIGJsYWNrbGlzdCdcblx0XHRcdCk7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRhd2FpdCBsb2FkQmxhY2tsaXN0KCk7XG5cdFx0XHRcdGxvZ2dlci5pbmZvKFxuXHRcdFx0XHRcdCdCbGFja2xpc3QgYW5kIHJhbmdlX2NoZWNrIG1vZHVsZSBsb2FkZWQgc3VjY2Vzc2Z1bGx5J1xuXHRcdFx0XHQpO1xuXHRcdFx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0XHRcdGxvZ2dlci5lcnJvcihgRXJyb3IgZHVyaW5nIGJsYWNrbGlzdCBpbml0aWFsaXphdGlvbjogJHtlcnJ9YCk7XG5cdFx0XHRcdHRocm93IGVycjtcblx0XHRcdH1cblx0XHR9IGVsc2Uge1xuXHRcdFx0bG9nZ2VyLmluZm8oJ0lQIGJsYWNrbGlzdCBtaWRkbGV3YXJlIGlzIGRpc2FibGVkJyk7XG5cdFx0fVxuXHR9O1xuXG5cdGNvbnN0IGFkZFRvQmxhY2tsaXN0ID0gYXN5bmMgKGlwOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+ID0+IHtcblx0XHRpZiAoSVBfQkxBQ0tMSVNUX0VOQUJMRUQpIHtcblx0XHRcdGxvZ2dlci5pbmZvKCdJUCBCbGFja2xpc3QgaXMgZW5hYmxlZC4gQWRkaW5nIElQIHRvIGJsYWNrbGlzdCcpO1xuXHRcdFx0aWYgKCFibGFja2xpc3QuaW5jbHVkZXMoaXApKSB7XG5cdFx0XHRcdGJsYWNrbGlzdC5wdXNoKGlwKTtcblx0XHRcdFx0YXdhaXQgc2F2ZUJsYWNrbGlzdCgpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0bG9nZ2VyLmluZm8oJ0lQIGFscmVhZHkgaW4gYmxhY2tsaXN0Jyk7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIHtcblx0XHRcdGxvZ2dlci5pbmZvKCdJUCBCbGFja2xpc3QgaXMgZGlzYWJsZWQnKTtcblx0XHR9XG5cdH07XG5cblx0Y29uc3QgaXBCbGFja2xpc3RNaWRkbGV3YXJlID0gKFxuXHRcdHJlcTogUmVxdWVzdCxcblx0XHRyZXM6IFJlc3BvbnNlLFxuXHRcdG5leHQ6IE5leHRGdW5jdGlvblxuXHQpOiB2b2lkID0+IHtcblx0XHRpZiAoSVBfQkxBQ0tMSVNUX0VOQUJMRUQpIHtcblx0XHRcdGxvZ2dlci5pbmZvKCdJUCBCbGFja2xpc3QgbWlkZGxld2FyZSBlbmFibGVkJyk7XG5cdFx0XHRjb25zdCBjbGllbnRJcCA9IHJlcS5pcDtcblxuXHRcdFx0aWYgKCFjbGllbnRJcCkge1xuXHRcdFx0XHRsb2dnZXIuZXJyb3IoJ0NsaWVudCBJUCBub3QgZm91bmQnKTtcblx0XHRcdFx0cmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0JhZCByZXF1ZXN0JyB9KTtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoYmxhY2tsaXN0LnNvbWUocmFuZ2UgPT4gaW5SYW5nZShjbGllbnRJcCwgcmFuZ2UpKSkge1xuXHRcdFx0XHRsb2dnZXIud2FybihgQmxvY2tlZCByZXF1ZXN0IGZyb20gYmxhY2tsaXN0ZWQgSVA6ICR7Y2xpZW50SXB9YCk7XG5cdFx0XHRcdHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICdBY2Nlc3MgZGVuaWVkJyB9KTtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXHRcdH0gZWxzZSB7XG5cdFx0XHRsb2dnZXIuaW5mbygnSVAgQmxhY2tsaXN0IG1pZGRsZXdhcmUgZGlzYWJsZWQnKTtcblx0XHR9XG5cblx0XHRuZXh0KCk7XG5cdH07XG5cblx0Y29uc3QgcmVtb3ZlRnJvbUJsYWNrbGlzdCA9IChpcDogc3RyaW5nKTogdm9pZCA9PiB7XG5cdFx0aWYgKElQX0JMQUNLTElTVF9FTkFCTEVEKSB7XG5cdFx0XHRibGFja2xpc3QgPSBibGFja2xpc3QuZmlsdGVyKHJhbmdlID0+IHJhbmdlICE9PSBpcCk7XG5cdFx0XHRzYXZlQmxhY2tsaXN0KCk7XG5cdFx0fVxuXHR9O1xuXG5cdHJldHVybiB7XG5cdFx0aW5pdGlhbGl6ZUJsYWNrbGlzdCxcblx0XHRsb2FkQmxhY2tsaXN0LFxuXHRcdGFkZFRvQmxhY2tsaXN0LFxuXHRcdGlwQmxhY2tsaXN0TWlkZGxld2FyZSxcblx0XHRyZW1vdmVGcm9tQmxhY2tsaXN0XG5cdH07XG59XG5cbmV4cG9ydCBjb25zdCBpbml0aWFsaXplSXBCbGFja2xpc3QgPSBjcmVhdGVJcEJsYWNrbGlzdDtcbiJdfQ==
