import { inRange } from 'range_check';
import fs from 'fs';
import path from 'path';
import { __dirname } from '../config/loadEnv.mjs';
import setupLogger from '../config/logger.mjs';
import { getFeatureFlags } from '../config/featureFlags.mjs';
let blacklist = [];
const logger = setupLogger();
const featureFlags = getFeatureFlags();
const IP_BLACKLIST_ENABLED = featureFlags.enableIpBlacklistFlag;
// Initialize rangeCheck and load the blacklist
const initializeBlacklist = async () => {
	if (IP_BLACKLIST_ENABLED) {
		logger.info('Ip Blacklist is enabled. Initializing blacklist');
		try {
			await loadBlacklist();
			logger.info(
				'Blacklist and range_check module loaded successfully.'
			);
		} catch (err) {
			logger.error('Error during blacklist initialization: ', err);
			throw err;
		}
	} else {
		logger.info('Ip Blacklist is disabled');
	}
};
// Load the blacklist from file
export const loadBlacklist = async () => {
	const filePath = path.join(__dirname, '../../data/blacklist.json');
	try {
		if (fs.existsSync(filePath)) {
			const data = fs.readFileSync(filePath, 'utf8');
			blacklist = JSON.parse(data);
		}
	} catch (err) {
		logger.error('Error loading blacklist: ', err);
		blacklist = []; // default to empty array in case of failure
	}
};
// Add an IP or range to the blacklist
export const addToBlacklist = ip => {
	if (IP_BLACKLIST_ENABLED) {
		logger.info('IP Blacklist is enabled. Adding IP to blacklist');
		if (!blacklist.includes(ip)) {
			blacklist.push(ip);
			saveBlacklist();
		} else {
			logger.info('IP already in blacklist');
		}
	} else {
		logger.info('IP Blacklist is disabled');
	}
};
// Save the blacklist
const saveBlacklist = async () => {
	if (IP_BLACKLIST_ENABLED) {
		const filePath = path.join(__dirname, '../../data/blacklist.json');
		try {
			fs.writeFileSync(filePath, JSON.stringify(blacklist, undefined, 2));
		} catch (err) {
			console.error('Error saving blacklist: ', err);
		}
	}
};
// Middleware to check if the requester's IP is blacklisted
export const ipBlacklistMiddleware = (req, res, next) => {
	if (IP_BLACKLIST_ENABLED) {
		logger.info('IP Blacklist middleware enabled');
		const clientIp = req.ip;
		if (!clientIp) {
			console.error('Client IP undefined');
			res.status(500).json({ error: 'Bad request' });
			return;
		}
		if (blacklist.some(range => inRange(clientIp, range))) {
			console.log(`Blocked request from blacklisted IP: ${clientIp}`);
			res.status(403).json({ error: 'Access denied' });
			return;
		}
	} else {
		logger.info('IP Blacklist middleware disabled');
	}
	next();
};
// Remove an IP or range from the blacklist
export const removeFromBlacklist = ip => {
	if (IP_BLACKLIST_ENABLED) {
		blacklist = blacklist.filter(range => range != ip);
		saveBlacklist();
	}
};
export const initializeIpBlacklist = initializeBlacklist;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXBCbGFja2xpc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbWlkZGxld2FyZS9pcEJsYWNrbGlzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBR3RDLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQztBQUNwQixPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzlDLE9BQU8sV0FBVyxNQUFNLGtCQUFrQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUV6RCxJQUFJLFNBQVMsR0FBYSxFQUFFLENBQUM7QUFDN0IsTUFBTSxNQUFNLEdBQVcsV0FBVyxFQUFFLENBQUM7QUFDckMsTUFBTSxZQUFZLEdBQUcsZUFBZSxFQUFFLENBQUM7QUFDdkMsTUFBTSxvQkFBb0IsR0FBRyxZQUFZLENBQUMscUJBQXFCLENBQUM7QUFFaEUsK0NBQStDO0FBQy9DLE1BQU0sbUJBQW1CLEdBQUcsS0FBSyxJQUFtQixFQUFFO0lBQ3JELElBQUksb0JBQW9CLEVBQUUsQ0FBQztRQUMxQixNQUFNLENBQUMsSUFBSSxDQUFDLGlEQUFpRCxDQUFDLENBQUM7UUFDL0QsSUFBSSxDQUFDO1lBQ0osTUFBTSxhQUFhLEVBQUUsQ0FBQztZQUN0QixNQUFNLENBQUMsSUFBSSxDQUNWLHVEQUF1RCxDQUN2RCxDQUFDO1FBQ0gsQ0FBQztRQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7WUFDZCxNQUFNLENBQUMsS0FBSyxDQUFDLHlDQUF5QyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQzdELE1BQU0sR0FBRyxDQUFDO1FBQ1gsQ0FBQztJQUNGLENBQUM7U0FBTSxDQUFDO1FBQ1AsTUFBTSxDQUFDLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0lBQ3pDLENBQUM7QUFDRixD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O1lBQ2hFLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLGVBQWUsRUFBRSxDQUFDLENBQUM7WUFDakQsT0FBTztRQUNSLENBQUM7SUFDRixDQUFDO1NBQU0sQ0FBQztRQUNQLE1BQU0sQ0FBQyxJQUFJLENBQUMsa0NBQWtDLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBRUQsSUFBSSxFQUFFLENBQUM7QUFDUixDQUFDLENBQUM7QUFFRiwyQ0FBMkM7QUFDM0MsTUFBTSxDQUFDLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxFQUFVLEVBQVEsRUFBRTtJQUN2RCxJQUFJLG9CQUFvQixFQUFFLENBQUM7UUFDMUIsU0FBUyxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDLENBQUM7UUFDbkQsYUFBYSxFQUFFLENBQUM7SUFDakIsQ0FBQztBQUNGLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxNQUFNLHFCQUFxQixHQUFHLG1CQUFtQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5SYW5nZSB9IGZyb20gJ3JhbmdlX2NoZWNrJztcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJ3dpbnN0b24nO1xuaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgX19kaXJuYW1lIH0gZnJvbSAnLi4vY29uZmlnL2xvYWRFbnYnO1xuaW1wb3J0IHNldHVwTG9nZ2VyIGZyb20gJy4uL2NvbmZpZy9sb2dnZXInO1xuaW1wb3J0IHsgZ2V0RmVhdHVyZUZsYWdzIH0gZnJvbSAnLi4vY29uZmlnL2ZlYXR1cmVGbGFncyc7XG5cbmxldCBibGFja2xpc3Q6IHN0cmluZ1tdID0gW107XG5jb25zdCBsb2dnZXI6IExvZ2dlciA9IHNldHVwTG9nZ2VyKCk7XG5jb25zdCBmZWF0dXJlRmxhZ3MgPSBnZXRGZWF0dXJlRmxhZ3MoKTtcbmNvbnN0IElQX0JMQUNLTElTVF9FTkFCTEVEID0gZmVhdHVyZUZsYWdzLmVuYWJsZUlwQmxhY2tsaXN0RmxhZztcblxuLy8gSW5pdGlhbGl6ZSByYW5nZUNoZWNrIGFuZCBsb2FkIHRoZSBibGFja2xpc3RcbmNvbnN0IGluaXRpYWxpemVCbGFja2xpc3QgPSBhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XG5cdGlmIChJUF9CTEFDS0xJU1RfRU5BQkxFRCkge1xuXHRcdGxvZ2dlci5pbmZvKCdJcCBCbGFja2xpc3QgaXMgZW5hYmxlZC4gSW5pdGlhbGl6aW5nIGJsYWNrbGlzdCcpO1xuXHRcdHRyeSB7XG5cdFx0XHRhd2FpdCBsb2FkQmxhY2tsaXN0KCk7XG5cdFx0XHRsb2dnZXIuaW5mbyhcblx0XHRcdFx0J0JsYWNrbGlzdCBhbmQgcmFuZ2VfY2hlY2sgbW9kdWxlIGxvYWRlZCBzdWNjZXNzZnVsbHkuJ1xuXHRcdFx0KTtcblx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdGxvZ2dlci5lcnJvcignRXJyb3IgZHVyaW5nIGJsYWNrbGlzdCBpbml0aWFsaXphdGlvbjogJywgZXJyKTtcblx0XHRcdHRocm93IGVycjtcblx0XHR9XG5cdH0gZWxzZSB7XG5cdFx0bG9nZ2VyLmluZm8oJ0lwIEJsYWNrbGlzdCBpcyBkaXNhYmxlZCcpO1xuXHR9XG59O1xuXG4vLyBMb2FkIHRoZSBibGFja2xpc3QgZnJvbSBmaWxlXG5leHBvcnQgY29uc3QgbG9hZEJsYWNrbGlzdCA9IGFzeW5jICgpOiBQcm9taXNlPHZvaWQ+ID0+IHtcblx0Y29uc3QgZmlsZVBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vZGF0YS9ibGFja2xpc3QuanNvbicpO1xuXHR0cnkge1xuXHRcdGlmIChmcy5leGlzdHNTeW5jKGZpbGVQYXRoKSkge1xuXHRcdFx0Y29uc3QgZGF0YSA9IGZzLnJlYWRGaWxlU3luYyhmaWxlUGF0aCwgJ3V0ZjgnKTtcblx0XHRcdGJsYWNrbGlzdCA9IEpTT04ucGFyc2UoZGF0YSk7XG5cdFx0fVxuXHR9IGNhdGNoIChlcnIpIHtcblx0XHRsb2dnZXIuZXJyb3IoJ0Vycm9yIGxvYWRpbmcgYmxhY2tsaXN0OiAnLCBlcnIpO1xuXHRcdGJsYWNrbGlzdCA9IFtdOyAvLyBkZWZhdWx0IHRvIGVtcHR5IGFycmF5IGluIGNhc2Ugb2YgZmFpbHVyZVxuXHR9XG59O1xuXG4vLyBBZGQgYW4gSVAgb3IgcmFuZ2UgdG8gdGhlIGJsYWNrbGlzdFxuZXhwb3J0IGNvbnN0IGFkZFRvQmxhY2tsaXN0ID0gKGlwOiBzdHJpbmcpOiB2b2lkID0+IHtcblx0aWYgKElQX0JMQUNLTElTVF9FTkFCTEVEKSB7XG5cdFx0bG9nZ2VyLmluZm8oJ0lQIEJsYWNrbGlzdCBpcyBlbmFibGVkLiBBZGRpbmcgSVAgdG8gYmxhY2tsaXN0Jyk7XG5cdFx0aWYgKCFibGFja2xpc3QuaW5jbHVkZXMoaXApKSB7XG5cdFx0XHRibGFja2xpc3QucHVzaChpcCk7XG5cdFx0XHRzYXZlQmxhY2tsaXN0KCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGxvZ2dlci5pbmZvKCdJUCBhbHJlYWR5IGluIGJsYWNrbGlzdCcpO1xuXHRcdH1cblx0fSBlbHNlIHtcblx0XHRsb2dnZXIuaW5mbygnSVAgQmxhY2tsaXN0IGlzIGRpc2FibGVkJyk7XG5cdH1cbn07XG5cbi8vIFNhdmUgdGhlIGJsYWNrbGlzdFxuY29uc3Qgc2F2ZUJsYWNrbGlzdCA9IGFzeW5jICgpOiBQcm9taXNlPHZvaWQ+ID0+IHtcblx0aWYgKElQX0JMQUNLTElTVF9FTkFCTEVEKSB7XG5cdFx0Y29uc3QgZmlsZVBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vZGF0YS9ibGFja2xpc3QuanNvbicpO1xuXHRcdHRyeSB7XG5cdFx0XHRmcy53cml0ZUZpbGVTeW5jKGZpbGVQYXRoLCBKU09OLnN0cmluZ2lmeShibGFja2xpc3QsIHVuZGVmaW5lZCwgMikpO1xuXHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0Y29uc29sZS5lcnJvcignRXJyb3Igc2F2aW5nIGJsYWNrbGlzdDogJywgZXJyKTtcblx0XHR9XG5cdH1cbn07XG5cbi8vIE1pZGRsZXdhcmUgdG8gY2hlY2sgaWYgdGhlIHJlcXVlc3RlcidzIElQIGlzIGJsYWNrbGlzdGVkXG5leHBvcnQgY29uc3QgaXBCbGFja2xpc3RNaWRkbGV3YXJlID0gKFxuXHRyZXE6IFJlcXVlc3QsXG5cdHJlczogUmVzcG9uc2UsXG5cdG5leHQ6IE5leHRGdW5jdGlvblxuKTogdm9pZCA9PiB7XG5cdGlmIChJUF9CTEFDS0xJU1RfRU5BQkxFRCkge1xuXHRcdGxvZ2dlci5pbmZvKCdJUCBCbGFja2xpc3QgbWlkZGxld2FyZSBlbmFibGVkJyk7XG5cdFx0Y29uc3QgY2xpZW50SXAgPSByZXEuaXA7XG5cblx0XHRpZiAoIWNsaWVudElwKSB7XG5cdFx0XHRjb25zb2xlLmVycm9yKCdDbGllbnQgSVAgdW5kZWZpbmVkJyk7XG5cdFx0XHRyZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnQmFkIHJlcXVlc3QnIH0pO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGlmIChibGFja2xpc3Quc29tZShyYW5nZSA9PiBpblJhbmdlKGNsaWVudElwLCByYW5nZSkpKSB7XG5cdFx0XHRjb25zb2xlLmxvZyhgQmxvY2tlZCByZXF1ZXN0IGZyb20gYmxhY2tsaXN0ZWQgSVA6ICR7Y2xpZW50SXB9YCk7XG5cdFx0XHRyZXMuc3RhdHVzKDQwMykuanNvbih7IGVycm9yOiAnQWNjZXNzIGRlbmllZCcgfSk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXHR9IGVsc2Uge1xuXHRcdGxvZ2dlci5pbmZvKCdJUCBCbGFja2xpc3QgbWlkZGxld2FyZSBkaXNhYmxlZCcpO1xuXHR9XG5cblx0bmV4dCgpO1xufTtcblxuLy8gUmVtb3ZlIGFuIElQIG9yIHJhbmdlIGZyb20gdGhlIGJsYWNrbGlzdFxuZXhwb3J0IGNvbnN0IHJlbW92ZUZyb21CbGFja2xpc3QgPSAoaXA6IHN0cmluZyk6IHZvaWQgPT4ge1xuXHRpZiAoSVBfQkxBQ0tMSVNUX0VOQUJMRUQpIHtcblx0XHRibGFja2xpc3QgPSBibGFja2xpc3QuZmlsdGVyKHJhbmdlID0+IHJhbmdlICE9IGlwKTtcblx0XHRzYXZlQmxhY2tsaXN0KCk7XG5cdH1cbn07XG5cbmV4cG9ydCBjb25zdCBpbml0aWFsaXplSXBCbGFja2xpc3QgPSBpbml0aWFsaXplQmxhY2tsaXN0O1xuIl19
