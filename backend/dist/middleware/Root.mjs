import cookieParser from 'cookie-parser';
import cors from 'cors';
import express from 'express';
import morgan from 'morgan';
import rawBody from 'raw-body';
import responseTime from 'response-time';
import { XMLParser } from 'fast-xml-parser';
import { ServiceFactory } from '../index/factory.mjs';
import { withRetry } from '../utils/helpers.mjs';
import {
	blankRequest,
	blankResponse,
	blankNextFunction
} from '../config/express.mjs';
export class RootMiddlewareService {
	static instance = null;
	logger;
	errorLogger;
	errorHandler;
	middlewareStatusService;
	totalResponseTime = 0;
	requestCount = 0;
	errorCount = 0;
	openConnections = 0;
	requestsPerSecond = 0;
	requestStatsInterval = null;
	constructor(logger, errorLogger, errorHandler, middlewareStatusService) {
		this.logger = logger;
		this.errorLogger = errorLogger;
		this.errorHandler = errorHandler;
		this.middlewareStatusService = middlewareStatusService;
	}
	static async getInstance() {
		if (!RootMiddlewareService.instance) {
			const logger = await ServiceFactory.getLoggerService();
			const errorLogger = await ServiceFactory.getErrorLoggerService();
			const errorHandler = await ServiceFactory.getErrorHandlerService();
			const middlewareStatusService =
				await ServiceFactory.getMiddlewareStatusService();
			RootMiddlewareService.instance = new RootMiddlewareService(
				logger,
				errorLogger,
				errorHandler,
				middlewareStatusService
			);
		}
		return RootMiddlewareService.instance;
	}
	async initialize() {
		try {
			const app = express();
			await this.applyMiddlewares(app);
			this.calculateRequestsPerSecond();
		} catch (error) {
			const initializationError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Error during RootMiddlewareService initialization: ${error instanceof Error ? error.message : 'Unknown error'}`
				);
			this.errorLogger.logError(initializationError.message);
			this.errorHandler.handleError({ error: initializationError });
		}
	}
	trackResponseTime(req, res, next) {
		const startHrTime = process.hrtime();
		this.openConnections += 1;
		res.on('finish', () => {
			const diff = process.hrtime(startHrTime);
			const duration = diff[0] * 1e3 + diff[1] / 1e6;
			this.totalResponseTime += duration;
			this.requestCount += 1;
			this.openConnections -= 1;
			const averageResponseTime =
				this.totalResponseTime / this.requestCount;
			if (res.statusCode >= 400) {
				this.errorCount += 1;
			}
			this.logMetrics(averageResponseTime);
		});
		next();
	}
	calculateRequestsPerSecond() {
		setInterval(() => {
			this.requestsPerSecond = this.requestCount / process.uptime();
		}, 1000);
	}
	getAverageResponseTime() {
		const averageResponseTime =
			this.totalResponseTime / (this.requestCount || 1);
		return averageResponseTime;
	}
	logMetrics(averageResponseTime) {
		this.logger.info(
			`Average Response Time: ${averageResponseTime.toFixed(2)} ms`
		);
		this.logger.info(`Total Requests: ${this.requestCount}`);
		this.logger.info(`Requests Per Second: ${this.requestsPerSecond}`);
		this.logger.info(`Open Connections: ${this.openConnections}`);
		this.logger.info(`Error Count: ${this.errorCount}`);
	}
	xmlParserMiddleware(req, res, next) {
		const contentType = req.headers['content-type'];
		if (contentType === 'application/xml') {
			rawBody(req, { encoding: 'utf-8' })
				.then(xmlData => {
					try {
						req.parsedXmlBody = new XMLParser().parse(xmlData);
						next();
					} catch (err) {
						res.status(400).send('Invalid XML format');
						next(err);
					}
				})
				.catch(err => {
					res.status(500).send('Error reading XML body');
					next(err);
				});
		} else {
			next();
		}
	}
	async applyMiddlewares(app) {
		const stream = {
			write: message => this.logger.info(message.trim())
		};
		const setMiddlewareStatus = (name, status, error) => {
			this.middlewareStatusService.setStatus(name, status);
			if (status === 'off') {
				this.errorLogger.logError(
					`Middleware "${name}" has failed: ${error}`
				);
			}
		};
		const addMiddleware = async (name, middlewareFn) => {
			try {
				await withRetry(
					async () => {
						if (this.middlewareStatusService.isMiddlewareOn(name)) {
							middlewareFn();
							setMiddlewareStatus(name, 'on');
						}
					},
					5,
					2000
				);
			} catch (err) {
				setMiddlewareStatus(name, 'off', err);
				const middlewareError =
					new this.errorHandler.ErrorClasses.RootMiddlewareError(
						`Error occurred while applying middleware: ${name}`,
						{ exposeToClient: false }
					);
				this.errorHandler.expressErrorHandler()(
					middlewareError,
					blankRequest,
					blankResponse,
					blankNextFunction
				);
			}
		};
		try {
			await addMiddleware('express.text', () => app.use(express.text()));
			await addMiddleware('express.json', () => app.use(express.json()));
			await addMiddleware('express.urlencoded', () =>
				app.use(express.urlencoded({ extended: true }))
			);
			await addMiddleware('cookieParser', () => app.use(cookieParser()));
			await addMiddleware('xmlParserMiddleware', () =>
				app.use(this.xmlParserMiddleware)
			);
			await addMiddleware('morganLogger', () =>
				app.use(morgan('combined', { stream }))
			);
			await addMiddleware('cors', () => app.use(cors()));
			await addMiddleware('responseTime', () => app.use(responseTime()));
			await addMiddleware('trackResponseTime', () =>
				app.use(this.trackResponseTime.bind(this))
			);
			await addMiddleware('etag (strong)', () =>
				app.set('etag', 'strong')
			);
			await addMiddleware('trustProxy', () =>
				app.set('trust proxy', true)
			);
		} catch (err) {
			this.errorLogger.logError(
				`Error applying root level middleware\n${err instanceof Error ? err.message : String(err)}`
			);
			const rootMiddlewareError =
				new this.errorHandler.ErrorClasses.RootMiddlewareError(
					`Error occurred while applying root level middleware`,
					{ exposeToClient: false }
				);
			this.errorHandler.expressErrorHandler()(
				rootMiddlewareError,
				{},
				{},
				() => {}
			);
		}
	}
	async shutdown() {
		try {
			this.logger.info('Shutting down RootMiddlewareService...');
			if (this.requestStatsInterval) {
				clearInterval(this.requestStatsInterval);
				this.logger.info('Cleared requests per second interval.');
			}
			this.totalResponseTime = 0;
			this.requestCount = 0;
			this.errorCount = 0;
			this.openConnections = 0;
			this.requestsPerSecond = 0;
			RootMiddlewareService.instance = null;
			this.logger.info('RootMiddlewareService shutdown completed.');
		} catch (error) {
			const shutdownError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Error during RootMiddlewareService shutdown: ${error instanceof Error ? error.message : 'Unknown error'}`
				);
			this.errorLogger.logError(shutdownError.message);
			this.errorHandler.handleError({ error: shutdownError });
		}
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUm9vdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlL1Jvb3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxZQUFZLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUN4QixPQUFPLE9BQTRDLE1BQU0sU0FBUyxDQUFDO0FBRW5FLE9BQU8sTUFBeUIsTUFBTSxRQUFRLENBQUM7QUFDL0MsT0FBTyxPQUFPLE1BQU0sVUFBVSxDQUFDO0FBQy9CLE9BQU8sWUFBWSxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDNUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUM3QyxPQUFPLEVBQ04sWUFBWSxFQUNaLGFBQWEsRUFDYixpQkFBaUIsRUFDakIsTUFBTSxtQkFBbUIsQ0FBQztBQVUzQixNQUFNLE9BQU8scUJBQXFCO0lBQ3pCLE1BQU0sQ0FBQyxRQUFRLEdBQWlDLElBQUksQ0FBQztJQUVyRCxNQUFNLENBQTRCO0lBQ2xDLFdBQVcsQ0FBOEI7SUFDekMsWUFBWSxDQUErQjtJQUMzQyx1QkFBdUIsQ0FBbUM7SUFFMUQsaUJBQWlCLEdBQUcsQ0FBQyxDQUFDO0lBQ3RCLFlBQVksR0FBRyxDQUFDLENBQUM7SUFDakIsVUFBVSxHQUFHLENBQUMsQ0FBQztJQUNmLGVBQWUsR0FBRyxDQUFDLENBQUM7SUFDcEIsaUJBQWlCLEdBQUcsQ0FBQyxDQUFDO0lBQ3RCLG9CQUFvQixHQUEwQixJQUFJLENBQUM7SUFFM0QsWUFDQyxNQUFpQyxFQUNqQyxXQUF3QyxFQUN4QyxZQUEwQyxFQUMxQyx1QkFBeUQ7UUFFekQsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLFdBQVcsR0FB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QUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2hCLE1BQU0sYUFBYSxHQUNsQixJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLHVCQUF1QixDQUN6RCxnREFBZ0QsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsZUFBZSxFQUFFLENBQzFHLENBQUM7WUFDSCxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDakQsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsRUFBRSxLQUFLLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQztRQUN6RCxDQUFDO0lBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjb29raWVQYXJzZXIgZnJvbSAnY29va2llLXBhcnNlcic7XG5pbXBvcnQgY29ycyBmcm9tICdjb3JzJztcbmltcG9ydCBleHByZXNzLCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IEluY29taW5nTWVzc2FnZSB9IGZyb20gJ2h0dHAnO1xuaW1wb3J0IG1vcmdhbiwgeyBTdHJlYW1PcHRpb25zIH0gZnJvbSAnbW9yZ2FuJztcbmltcG9ydCByYXdCb2R5IGZyb20gJ3Jhdy1ib2R5JztcbmltcG9ydCByZXNwb25zZVRpbWUgZnJvbSAncmVzcG9uc2UtdGltZSc7XG5pbXBvcnQgeyBYTUxQYXJzZXIgfSBmcm9tICdmYXN0LXhtbC1wYXJzZXInO1xuaW1wb3J0IHsgU2VydmljZUZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5JztcbmltcG9ydCB7IHdpdGhSZXRyeSB9IGZyb20gJy4uL3V0aWxzL2hlbHBlcnMnO1xuaW1wb3J0IHtcblx0YmxhbmtSZXF1ZXN0LFxuXHRibGFua1Jlc3BvbnNlLFxuXHRibGFua05leHRGdW5jdGlvblxufSBmcm9tICcuLi9jb25maWcvZXhwcmVzcyc7XG5pbXBvcnQge1xuXHRBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2UsXG5cdE1pZGRsZXdhcmVTdGF0dXNTZXJ2aWNlSW50ZXJmYWNlLFxuXHRSb290TWlkZGxld2FyZVNlcnZpY2VJbnRlcmZhY2Vcbn0gZnJvbSAnLi4vaW5kZXgvaW50ZXJmYWNlcy9zZXJ2aWNlcyc7XG5pbXBvcnQgeyBYTUxQYXJzZWRSZXF1ZXN0IH0gZnJvbSAnLi4vaW5kZXgvaW50ZXJmYWNlcy9zZXJ2aWNlQ29tcG9uZW50cyc7XG5cbmV4cG9ydCBjbGFzcyBSb290TWlkZGxld2FyZVNlcnZpY2UgaW1wbGVtZW50cyBSb290TWlkZGxld2FyZVNlcnZpY2VJbnRlcmZhY2Uge1xuXHRwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTogUm9vdE1pZGRsZXdhcmVTZXJ2aWNlIHwgbnVsbCA9IG51bGw7XG5cblx0cHJpdmF0ZSBsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBlcnJvckhhbmRsZXI6IEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgbWlkZGxld2FyZVN0YXR1c1NlcnZpY2U6IE1pZGRsZXdhcmVTdGF0dXNTZXJ2aWNlSW50ZXJmYWNlO1xuXG5cdHByaXZhdGUgdG90YWxSZXNwb25zZVRpbWUgPSAwO1xuXHRwcml2YXRlIHJlcXVlc3RDb3VudCA9IDA7XG5cdHByaXZhdGUgZXJyb3JDb3VudCA9IDA7XG5cdHByaXZhdGUgb3BlbkNvbm5lY3Rpb25zID0gMDtcblx0cHJpdmF0ZSByZXF1ZXN0c1BlclNlY29uZCA9IDA7XG5cdHByaXZhdGUgcmVxdWVzdFN0YXRzSW50ZXJ2YWw6IE5vZGVKUy5UaW1lb3V0IHwgbnVsbCA9IG51bGw7XG5cblx0cHJpdmF0ZSBjb25zdHJ1Y3Rvcihcblx0XHRsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0ZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0XHRlcnJvckhhbmRsZXI6IEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0bWlkZGxld2FyZVN0YXR1c1NlcnZpY2U6IE1pZGRsZXdhcmVTdGF0dXNTZXJ2aWNlSW50ZXJmYWNlXG5cdCkge1xuXHRcdHRoaXMubG9nZ2VyID0gbG9nZ2VyO1xuXHRcdHRoaXMuZXJyb3JMb2dnZXIgPSBlcnJvckxvZ2dlcjtcblx0XHR0aGlzLmVycm9ySGFuZGxlciA9IGVycm9ySGFuZGxlcjtcblx0XHR0aGlzLm1pZGRsZXdhcmVTdGF0dXNTZXJ2aWNlID0gbWlkZGxld2FyZVN0YXR1c1NlcnZpY2U7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGFzeW5jIGdldEluc3RhbmNlKCk6IFByb21pc2U8Um9vdE1pZGRsZXdhcmVTZXJ2aWNlPiB7XG5cdFx0aWYgKCFSb290TWlkZGxld2FyZVNlcnZpY2UuaW5zdGFuY2UpIHtcblx0XHRcdGNvbnN0IGxvZ2dlciA9IGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldExvZ2dlclNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGVycm9yTG9nZ2VyID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0RXJyb3JMb2dnZXJTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBlcnJvckhhbmRsZXIgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRFcnJvckhhbmRsZXJTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBtaWRkbGV3YXJlU3RhdHVzU2VydmljZSA9XG5cdFx0XHRcdGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldE1pZGRsZXdhcmVTdGF0dXNTZXJ2aWNlKCk7XG5cdFx0XHRSb290TWlkZGxld2FyZVNlcnZpY2UuaW5zdGFuY2UgPSBuZXcgUm9vdE1pZGRsZXdhcmVTZXJ2aWNlKFxuXHRcdFx0XHRsb2dnZXIsXG5cdFx0XHRcdGVycm9yTG9nZ2VyLFxuXHRcdFx0XHRlcnJvckhhbmRsZXIsXG5cdFx0XHRcdG1pZGRsZXdhcmVTdGF0dXNTZXJ2aWNlXG5cdFx0XHQpO1xuXHRcdH1cblxuXHRcdHJldHVybiBSb290TWlkZGxld2FyZVNlcnZpY2UuaW5zdGFuY2U7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgaW5pdGlhbGl6ZSgpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgYXBwID0gZXhwcmVzcygpO1xuXHRcdFx0YXdhaXQgdGhpcy5hcHBseU1pZGRsZXdhcmVzKGFwcCk7XG5cdFx0XHR0aGlzLmNhbGN1bGF0ZVJlcXVlc3RzUGVyU2Vjb25kKCk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdGNvbnN0IGluaXRpYWxpemF0aW9uRXJyb3IgPVxuXHRcdFx0XHRuZXcgdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JDbGFzc2VzLlV0aWxpdHlFcnJvclJlY292ZXJhYmxlKFxuXHRcdFx0XHRcdGBFcnJvciBkdXJpbmcgUm9vdE1pZGRsZXdhcmVTZXJ2aWNlIGluaXRpYWxpemF0aW9uOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InfWBcblx0XHRcdFx0KTtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nRXJyb3IoaW5pdGlhbGl6YXRpb25FcnJvci5tZXNzYWdlKTtcblx0XHRcdHRoaXMuZXJyb3JIYW5kbGVyLmhhbmRsZUVycm9yKHsgZXJyb3I6IGluaXRpYWxpemF0aW9uRXJyb3IgfSk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIHRyYWNrUmVzcG9uc2VUaW1lKFxuXHRcdHJlcTogUmVxdWVzdCxcblx0XHRyZXM6IFJlc3BvbnNlLFxuXHRcdG5leHQ6IE5leHRGdW5jdGlvblxuXHQpOiB2b2lkIHtcblx0XHRjb25zdCBzdGFydEhyVGltZSA9IHByb2Nlc3MuaHJ0aW1lKCk7XG5cdFx0dGhpcy5vcGVuQ29ubmVjdGlvbnMgKz0gMTtcblxuXHRcdHJlcy5vbignZmluaXNoJywgKCkgPT4ge1xuXHRcdFx0Y29uc3QgZGlmZiA9IHByb2Nlc3MuaHJ0aW1lKHN0YXJ0SHJUaW1lKTtcblx0XHRcdGNvbnN0IGR1cmF0aW9uID0gZGlmZlswXSAqIDFlMyArIGRpZmZbMV0gLyAxZTY7XG5cblx0XHRcdHRoaXMudG90YWxSZXNwb25zZVRpbWUgKz0gZHVyYXRpb247XG5cdFx0XHR0aGlzLnJlcXVlc3RDb3VudCArPSAxO1xuXHRcdFx0dGhpcy5vcGVuQ29ubmVjdGlvbnMgLT0gMTtcblxuXHRcdFx0Y29uc3QgYXZlcmFnZVJlc3BvbnNlVGltZSA9XG5cdFx0XHRcdHRoaXMudG90YWxSZXNwb25zZVRpbWUgLyB0aGlzLnJlcXVlc3RDb3VudDtcblxuXHRcdFx0aWYgKHJlcy5zdGF0dXNDb2RlID49IDQwMCkge1xuXHRcdFx0XHR0aGlzLmVycm9yQ291bnQgKz0gMTtcblx0XHRcdH1cblxuXHRcdFx0dGhpcy5sb2dNZXRyaWNzKGF2ZXJhZ2VSZXNwb25zZVRpbWUpO1xuXHRcdH0pO1xuXG5cdFx0bmV4dCgpO1xuXHR9XG5cblx0cHVibGljIGNhbGN1bGF0ZVJlcXVlc3RzUGVyU2Vjb25kKCk6IHZvaWQge1xuXHRcdHNldEludGVydmFsKCgpID0+IHtcblx0XHRcdHRoaXMucmVxdWVzdHNQZXJTZWNvbmQgPSB0aGlzLnJlcXVlc3RDb3VudCAvIHByb2Nlc3MudXB0aW1lKCk7XG5cdFx0fSwgMTAwMCk7XG5cdH1cblxuXHRwdWJsaWMgZ2V0QXZlcmFnZVJlc3BvbnNlVGltZSgpOiBudW1iZXIge1xuXHRcdGNvbnN0IGF2ZXJhZ2VSZXNwb25zZVRpbWUgPVxuXHRcdFx0dGhpcy50b3RhbFJlc3BvbnNlVGltZSAvICh0aGlzLnJlcXVlc3RDb3VudCB8fCAxKTtcblx0XHRyZXR1cm4gYXZlcmFnZVJlc3BvbnNlVGltZTtcblx0fVxuXG5cdHByaXZhdGUgbG9nTWV0cmljcyhhdmVyYWdlUmVzcG9uc2VUaW1lOiBudW1iZXIpOiB2b2lkIHtcblx0XHR0aGlzLmxvZ2dlci5pbmZvKFxuXHRcdFx0YEF2ZXJhZ2UgUmVzcG9uc2UgVGltZTogJHthdmVyYWdlUmVzcG9uc2VUaW1lLnRvRml4ZWQoMil9IG1zYFxuXHRcdCk7XG5cdFx0dGhpcy5sb2dnZXIuaW5mbyhgVG90YWwgUmVxdWVzdHM6ICR7dGhpcy5yZXF1ZXN0Q291bnR9YCk7XG5cdFx0dGhpcy5sb2dnZXIuaW5mbyhgUmVxdWVzdHMgUGVyIFNlY29uZDogJHt0aGlzLnJlcXVlc3RzUGVyU2Vjb25kfWApO1xuXHRcdHRoaXMubG9nZ2VyLmluZm8oYE9wZW4gQ29ubmVjdGlvbnM6ICR7dGhpcy5vcGVuQ29ubmVjdGlvbnN9YCk7XG5cdFx0dGhpcy5sb2dnZXIuaW5mbyhgRXJyb3IgQ291bnQ6ICR7dGhpcy5lcnJvckNvdW50fWApO1xuXHR9XG5cblx0cHJpdmF0ZSB4bWxQYXJzZXJNaWRkbGV3YXJlKFxuXHRcdHJlcTogUmVxdWVzdCxcblx0XHRyZXM6IFJlc3BvbnNlLFxuXHRcdG5leHQ6IE5leHRGdW5jdGlvblxuXHQpOiB2b2lkIHtcblx0XHRjb25zdCBjb250ZW50VHlwZSA9IHJlcS5oZWFkZXJzWydjb250ZW50LXR5cGUnXSBhcyBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cblx0XHRpZiAoY29udGVudFR5cGUgPT09ICdhcHBsaWNhdGlvbi94bWwnKSB7XG5cdFx0XHRyYXdCb2R5KHJlcSBhcyB1bmtub3duIGFzIEluY29taW5nTWVzc2FnZSwgeyBlbmNvZGluZzogJ3V0Zi04JyB9KVxuXHRcdFx0XHQudGhlbigoeG1sRGF0YTogc3RyaW5nKSA9PiB7XG5cdFx0XHRcdFx0dHJ5IHtcblx0XHRcdFx0XHRcdChyZXEgYXMgWE1MUGFyc2VkUmVxdWVzdCkucGFyc2VkWG1sQm9keSA9XG5cdFx0XHRcdFx0XHRcdG5ldyBYTUxQYXJzZXIoKS5wYXJzZSh4bWxEYXRhKTtcblx0XHRcdFx0XHRcdG5leHQoKTtcblx0XHRcdFx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdFx0XHRcdHJlcy5zdGF0dXMoNDAwKS5zZW5kKCdJbnZhbGlkIFhNTCBmb3JtYXQnKTtcblx0XHRcdFx0XHRcdG5leHQoZXJyKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pXG5cdFx0XHRcdC5jYXRjaChlcnIgPT4ge1xuXHRcdFx0XHRcdHJlcy5zdGF0dXMoNTAwKS5zZW5kKCdFcnJvciByZWFkaW5nIFhNTCBib2R5Jyk7XG5cdFx0XHRcdFx0bmV4dChlcnIpO1xuXHRcdFx0XHR9KTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0bmV4dCgpO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBhcHBseU1pZGRsZXdhcmVzKGFwcDogZXhwcmVzcy5BcHBsaWNhdGlvbik6IFByb21pc2U8dm9pZD4ge1xuXHRcdGNvbnN0IHN0cmVhbTogU3RyZWFtT3B0aW9ucyA9IHtcblx0XHRcdHdyaXRlOiAobWVzc2FnZTogc3RyaW5nKSA9PiB0aGlzLmxvZ2dlci5pbmZvKG1lc3NhZ2UudHJpbSgpKVxuXHRcdH07XG5cblx0XHRjb25zdCBzZXRNaWRkbGV3YXJlU3RhdHVzID0gKFxuXHRcdFx0bmFtZTogc3RyaW5nLFxuXHRcdFx0c3RhdHVzOiAnb24nIHwgJ29mZicsXG5cdFx0XHRlcnJvcj86IHVua25vd25cblx0XHQpOiB2b2lkID0+IHtcblx0XHRcdHRoaXMubWlkZGxld2FyZVN0YXR1c1NlcnZpY2Uuc2V0U3RhdHVzKG5hbWUsIHN0YXR1cyk7XG5cdFx0XHRpZiAoc3RhdHVzID09PSAnb2ZmJykge1xuXHRcdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKFxuXHRcdFx0XHRcdGBNaWRkbGV3YXJlIFwiJHtuYW1lfVwiIGhhcyBmYWlsZWQ6ICR7ZXJyb3J9YFxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXHRcdH07XG5cblx0XHRjb25zdCBhZGRNaWRkbGV3YXJlID0gYXN5bmMgKFxuXHRcdFx0bmFtZTogc3RyaW5nLFxuXHRcdFx0bWlkZGxld2FyZUZuOiAoKSA9PiB2b2lkXG5cdFx0KTogUHJvbWlzZTx2b2lkPiA9PiB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRhd2FpdCB3aXRoUmV0cnkoXG5cdFx0XHRcdFx0YXN5bmMgKCkgPT4ge1xuXHRcdFx0XHRcdFx0aWYgKHRoaXMubWlkZGxld2FyZVN0YXR1c1NlcnZpY2UuaXNNaWRkbGV3YXJlT24obmFtZSkpIHtcblx0XHRcdFx0XHRcdFx0bWlkZGxld2FyZUZuKCk7XG5cdFx0XHRcdFx0XHRcdHNldE1pZGRsZXdhcmVTdGF0dXMobmFtZSwgJ29uJyk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0XHQ1LFxuXHRcdFx0XHRcdDIwMDBcblx0XHRcdFx0KTtcblx0XHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0XHRzZXRNaWRkbGV3YXJlU3RhdHVzKG5hbWUsICdvZmYnLCBlcnIpO1xuXHRcdFx0XHRjb25zdCBtaWRkbGV3YXJlRXJyb3IgPVxuXHRcdFx0XHRcdG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuUm9vdE1pZGRsZXdhcmVFcnJvcihcblx0XHRcdFx0XHRcdGBFcnJvciBvY2N1cnJlZCB3aGlsZSBhcHBseWluZyBtaWRkbGV3YXJlOiAke25hbWV9YCxcblx0XHRcdFx0XHRcdHsgZXhwb3NlVG9DbGllbnQ6IGZhbHNlIH1cblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR0aGlzLmVycm9ySGFuZGxlci5leHByZXNzRXJyb3JIYW5kbGVyKCkoXG5cdFx0XHRcdFx0bWlkZGxld2FyZUVycm9yLFxuXHRcdFx0XHRcdGJsYW5rUmVxdWVzdCxcblx0XHRcdFx0XHRibGFua1Jlc3BvbnNlLFxuXHRcdFx0XHRcdGJsYW5rTmV4dEZ1bmN0aW9uXG5cdFx0XHRcdCk7XG5cdFx0XHR9XG5cdFx0fTtcblxuXHRcdHRyeSB7XG5cdFx0XHRhd2FpdCBhZGRNaWRkbGV3YXJlKCdleHByZXNzLnRleHQnLCAoKSA9PiBhcHAudXNlKGV4cHJlc3MudGV4dCgpKSk7XG5cdFx0XHRhd2FpdCBhZGRNaWRkbGV3YXJlKCdleHByZXNzLmpzb24nLCAoKSA9PiBhcHAudXNlKGV4cHJlc3MuanNvbigpKSk7XG5cdFx0XHRhd2FpdCBhZGRNaWRkbGV3YXJlKCdleHByZXNzLnVybGVuY29kZWQnLCAoKSA9PlxuXHRcdFx0XHRhcHAudXNlKGV4cHJlc3MudXJsZW5jb2RlZCh7IGV4dGVuZGVkOiB0cnVlIH0pKVxuXHRcdFx0KTtcblx0XHRcdGF3YWl0IGFkZE1pZGRsZXdhcmUoJ2Nvb2tpZVBhcnNlcicsICgpID0+IGFwcC51c2UoY29va2llUGFyc2VyKCkpKTtcblx0XHRcdGF3YWl0IGFkZE1pZGRsZXdhcmUoJ3htbFBhcnNlck1pZGRsZXdhcmUnLCAoKSA9PlxuXHRcdFx0XHRhcHAudXNlKHRoaXMueG1sUGFyc2VyTWlkZGxld2FyZSlcblx0XHRcdCk7XG5cdFx0XHRhd2FpdCBhZGRNaWRkbGV3YXJlKCdtb3JnYW5Mb2dnZXInLCAoKSA9PlxuXHRcdFx0XHRhcHAudXNlKG1vcmdhbignY29tYmluZWQnLCB7IHN0cmVhbSB9KSlcblx0XHRcdCk7XG5cdFx0XHRhd2FpdCBhZGRNaWRkbGV3YXJlKCdjb3JzJywgKCkgPT4gYXBwLnVzZShjb3JzKCkpKTtcblx0XHRcdGF3YWl0IGFkZE1pZGRsZXdhcmUoJ3Jlc3BvbnNlVGltZScsICgpID0+IGFwcC51c2UocmVzcG9uc2VUaW1lKCkpKTtcblx0XHRcdGF3YWl0IGFkZE1pZGRsZXdhcmUoJ3RyYWNrUmVzcG9uc2VUaW1lJywgKCkgPT5cblx0XHRcdFx0YXBwLnVzZSh0aGlzLnRyYWNrUmVzcG9uc2VUaW1lLmJpbmQodGhpcykpXG5cdFx0XHQpO1xuXHRcdFx0YXdhaXQgYWRkTWlkZGxld2FyZSgnZXRhZyAoc3Ryb25nKScsICgpID0+XG5cdFx0XHRcdGFwcC5zZXQoJ2V0YWcnLCAnc3Ryb25nJylcblx0XHRcdCk7XG5cdFx0XHRhd2FpdCBhZGRNaWRkbGV3YXJlKCd0cnVzdFByb3h5JywgKCkgPT5cblx0XHRcdFx0YXBwLnNldCgndHJ1c3QgcHJveHknLCB0cnVlKVxuXHRcdFx0KTtcblx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nRXJyb3IoXG5cdFx0XHRcdGBFcnJvciBhcHBseWluZyByb290IGxldmVsIG1pZGRsZXdhcmVcXG4ke2VyciBpbnN0YW5jZW9mIEVycm9yID8gZXJyLm1lc3NhZ2UgOiBTdHJpbmcoZXJyKX1gXG5cdFx0XHQpO1xuXHRcdFx0Y29uc3Qgcm9vdE1pZGRsZXdhcmVFcnJvciA9XG5cdFx0XHRcdG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuUm9vdE1pZGRsZXdhcmVFcnJvcihcblx0XHRcdFx0XHRgRXJyb3Igb2NjdXJyZWQgd2hpbGUgYXBwbHlpbmcgcm9vdCBsZXZlbCBtaWRkbGV3YXJlYCxcblx0XHRcdFx0XHR7IGV4cG9zZVRvQ2xpZW50OiBmYWxzZSB9XG5cdFx0XHRcdCk7XG5cdFx0XHR0aGlzLmVycm9ySGFuZGxlci5leHByZXNzRXJyb3JIYW5kbGVyKCkoXG5cdFx0XHRcdHJvb3RNaWRkbGV3YXJlRXJyb3IsXG5cdFx0XHRcdHt9IGFzIGV4cHJlc3MuUmVxdWVzdCxcblx0XHRcdFx0e30gYXMgZXhwcmVzcy5SZXNwb25zZSxcblx0XHRcdFx0KCkgPT4ge31cblx0XHRcdCk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIHNodXRkb3duKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdHRyeSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdTaHV0dGluZyBkb3duIFJvb3RNaWRkbGV3YXJlU2VydmljZS4uLicpO1xuXG5cdFx0XHRpZiAodGhpcy5yZXF1ZXN0U3RhdHNJbnRlcnZhbCkge1xuXHRcdFx0XHRjbGVhckludGVydmFsKHRoaXMucmVxdWVzdFN0YXRzSW50ZXJ2YWwpO1xuXHRcdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdDbGVhcmVkIHJlcXVlc3RzIHBlciBzZWNvbmQgaW50ZXJ2YWwuJyk7XG5cdFx0XHR9XG5cblx0XHRcdHRoaXMudG90YWxSZXNwb25zZVRpbWUgPSAwO1xuXHRcdFx0dGhpcy5yZXF1ZXN0Q291bnQgPSAwO1xuXHRcdFx0dGhpcy5lcnJvckNvdW50ID0gMDtcblx0XHRcdHRoaXMub3BlbkNvbm5lY3Rpb25zID0gMDtcblx0XHRcdHRoaXMucmVxdWVzdHNQZXJTZWNvbmQgPSAwO1xuXG5cdFx0XHRSb290TWlkZGxld2FyZVNlcnZpY2UuaW5zdGFuY2UgPSBudWxsO1xuXG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdSb290TWlkZGxld2FyZVNlcnZpY2Ugc2h1dGRvd24gY29tcGxldGVkLicpO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHRjb25zdCBzaHV0ZG93bkVycm9yID1cblx0XHRcdFx0bmV3IHRoaXMuZXJyb3JIYW5kbGVyLkVycm9yQ2xhc3Nlcy5VdGlsaXR5RXJyb3JSZWNvdmVyYWJsZShcblx0XHRcdFx0XHRgRXJyb3IgZHVyaW5nIFJvb3RNaWRkbGV3YXJlU2VydmljZSBzaHV0ZG93bjogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ31gXG5cdFx0XHRcdCk7XG5cdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKHNodXRkb3duRXJyb3IubWVzc2FnZSk7XG5cdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7IGVycm9yOiBzaHV0ZG93bkVycm9yIH0pO1xuXHRcdH1cblx0fVxufVxuIl19
