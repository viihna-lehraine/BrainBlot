import { ServiceFactory } from '../index/factory.mjs';
export class PassportAuthMiddlewareService {
	static instance = null;
	logger;
	errorLogger;
	errorHandler;
	constructor(logger, errorLogger, errorHandler) {
		this.logger = logger;
		this.errorLogger = errorLogger;
		this.errorHandler = errorHandler;
	}
	static async getInstance() {
		if (!PassportAuthMiddlewareService.instance) {
			const logger = await ServiceFactory.getLoggerService();
			const errorLogger = await ServiceFactory.getErrorLoggerService();
			const errorHandler = await ServiceFactory.getErrorHandlerService();
			PassportAuthMiddlewareService.instance =
				new PassportAuthMiddlewareService(
					logger,
					errorLogger,
					errorHandler
				);
		}
		return PassportAuthMiddlewareService.instance;
	}
	initializePassportAuthMiddleware({
		passport,
		authenticateOptions,
		validateDependencies
	}) {
		validateDependencies(
			[
				{ name: 'passport', instance: passport },
				{ name: 'authenticateOptions', instance: authenticateOptions }
			],
			this.logger
		);
		return (req, res, next) => {
			try {
				passport.authenticate(
					'jwt',
					authenticateOptions,
					(err, user) => {
						if (err) {
							this.logger.error(
								`Passport authentication error: ${err.message}`
							);
							res.status(500).json({
								error: 'Internal Server Error'
							});
							return;
						}
						if (!user) {
							this.logger.warn('Unauthorized access attempt');
							res.status(401).json({ error: 'Unauthorized' });
							return;
						}
						req.user = user;
						return next();
					}
				)(req, res, next);
			} catch (expressError) {
				this.handleError(expressError, req, res, next);
			}
		};
	}
	async shutdown() {
		try {
			this.logger.info('Shutting down Passport middleware service...');
			PassportAuthMiddlewareService.instance = null;
			this.logger.info('Passport middleware service has been shut down.');
		} catch (error) {
			this.errorLogger.logError(
				`Error shutting down Passport middleware service: ${error instanceof Error ? error.message : error}`
			);
		}
	}
	handleError(expressError, req, res, next) {
		const middleware = 'PassportMiddlewareService';
		const expressMiddlewareError =
			new this.errorHandler.ErrorClasses.ExpressError(
				`Fatal error: Execution of ${middleware} failed\nShutting down...\n${
					expressError instanceof Error
						? expressError.message
						: 'Unknown error'
				}`,
				{
					utility: middleware,
					originalError: expressError
				}
			);
		this.errorLogger.logError(expressMiddlewareError.message);
		this.errorHandler.expressErrorHandler()(
			expressMiddlewareError,
			req,
			res,
			next
		);
		res.status(500).json({ error: 'Internal Server Error' });
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGFzc3BvcnRBdXRoLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL21pZGRsZXdhcmUvUGFzc3BvcnRBdXRoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQVFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUVsRCxNQUFNLE9BQU8sNkJBQTZCO0lBR2pDLE1BQU0sQ0FBQyxRQUFRLEdBQXlDLElBQUksQ0FBQztJQUM3RCxNQUFNLENBQTRCO0lBQ2xDLFdBQVcsQ0FBOEI7SUFDekMsWUFBWSxDQUErQjtJQUVuRCxZQUNDLE1BQWlDLEVBQ2pDLFdBQXdDLEVBQ3hDLFlBQTBDO1FBRTFDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQy9CLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO0lBQ2xDLENBQUM7SUFFTSxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVc7UUFDOUIsSUFBSSxDQUFDLDZCQUE2QixDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQzdDLE1BQU0sTUFBTSxHQUFHLE1BQU0sY0FBYyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDdkQsTUFBTSxXQUFXLEdBQUcsTUFBTSxjQUFjLENBQUMscUJBQXFCLEVBQUUsQ0FBQztZQUNqRSxNQUFNLFlBQVksR0FBRyxNQUFNLGNBQWMsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1lBRW5FLDZCQUE2QixDQUFDLFFBQVE7Z0JBQ3JDLElBQUksNkJBQTZCLENBQ2hDLE1BQU0sRUFDTixXQUFXLEVBQ1gsWUFBWSxDQUNaLENBQUM7UUFDSixDQUFDO1FBQ0QsT0FBTyw2QkFBNkIsQ0FBQyxRQUFRLENBQUM7SUFDL0MsQ0FBQztJQUVNLGdDQUFnQyxDQUFDLEVBQ3ZDLFFBQVEsRUFDUixtQkFBbUIsRUFDbkIsb0JBQW9CLEVBQ2U7UUFDbkMsb0JBQW9CLENBQ25CO1lBQ0MsRUFBRSxJQUFJ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RyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLHVCQUF1QixFQUFFLENBQUMsQ0FBQztJQUMxRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdCwgUmVxdWVzdEhhbmRsZXIsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7XG5cdEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2UsXG5cdEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0UGFzc3BvcnRBdXRoTWlkZGxld2FyZVNlcnZpY2VJbnRlcmZhY2Vcbn0gZnJvbSAnLi4vaW5kZXgvaW50ZXJmYWNlcy9zZXJ2aWNlcyc7XG5pbXBvcnQgeyBQYXNzcG9ydEF1dGhNaWRkbGV3YXJlU2VydmljZURlcHMgfSBmcm9tICcuLi9pbmRleC9pbnRlcmZhY2VzL3NlcnZpY2VEZXBzJztcbmltcG9ydCB7IFNlcnZpY2VGYWN0b3J5IH0gZnJvbSAnLi4vaW5kZXgvZmFjdG9yeSc7XG5cbmV4cG9ydCBjbGFzcyBQYXNzcG9ydEF1dGhNaWRkbGV3YXJlU2VydmljZVxuXHRpbXBsZW1lbnRzIFBhc3Nwb3J0QXV0aE1pZGRsZXdhcmVTZXJ2aWNlSW50ZXJmYWNlXG57XG5cdHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBQYXNzcG9ydEF1dGhNaWRkbGV3YXJlU2VydmljZSB8IG51bGwgPSBudWxsO1xuXHRwcml2YXRlIGxvZ2dlcjogQXBwTG9nZ2VyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBlcnJvckxvZ2dlcjogRXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIGVycm9ySGFuZGxlcjogRXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZTtcblxuXHRwcml2YXRlIGNvbnN0cnVjdG9yKFxuXHRcdGxvZ2dlcjogQXBwTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0XHRlcnJvckxvZ2dlcjogRXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGVycm9ySGFuZGxlcjogRXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZVxuXHQpIHtcblx0XHR0aGlzLmxvZ2dlciA9IGxvZ2dlcjtcblx0XHR0aGlzLmVycm9yTG9nZ2VyID0gZXJyb3JMb2dnZXI7XG5cdFx0dGhpcy5lcnJvckhhbmRsZXIgPSBlcnJvckhhbmRsZXI7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGFzeW5jIGdldEluc3RhbmNlKCk6IFByb21pc2U8UGFzc3BvcnRBdXRoTWlkZGxld2FyZVNlcnZpY2U+IHtcblx0XHRpZiAoIVBhc3Nwb3J0QXV0aE1pZGRsZXdhcmVTZXJ2aWNlLmluc3RhbmNlKSB7XG5cdFx0XHRjb25zdCBsb2dnZXIgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRMb2dnZXJTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBlcnJvckxvZ2dlciA9IGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldEVycm9yTG9nZ2VyU2VydmljZSgpO1xuXHRcdFx0Y29uc3QgZXJyb3JIYW5kbGVyID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0RXJyb3JIYW5kbGVyU2VydmljZSgpO1xuXG5cdFx0XHRQYXNzcG9ydEF1dGhNaWRkbGV3YXJlU2VydmljZS5pbnN0YW5jZSA9XG5cdFx0XHRcdG5ldyBQYXNzcG9ydEF1dGhNaWRkbGV3YXJlU2VydmljZShcblx0XHRcdFx0XHRsb2dnZXIsXG5cdFx0XHRcdFx0ZXJyb3JMb2dnZXIsXG5cdFx0XHRcdFx0ZXJyb3JIYW5kbGVyXG5cdFx0XHRcdCk7XG5cdFx0fVxuXHRcdHJldHVybiBQYXNzcG9ydEF1dGhNaWRkbGV3YXJlU2VydmljZS5pbnN0YW5jZTtcblx0fVxuXG5cdHB1YmxpYyBpbml0aWFsaXplUGFzc3BvcnRBdXRoTWlkZGxld2FyZSh7XG5cdFx0cGFzc3BvcnQsXG5cdFx0YXV0aGVudGljYXRlT3B0aW9ucyxcblx0XHR2YWxpZGF0ZURlcGVuZGVuY2llc1xuXHR9OiBQYXNzcG9ydEF1dGhNaWRkbGV3YXJlU2VydmljZURlcHMpOiBSZXF1ZXN0SGFuZGxlciB7XG5cdFx0dmFsaWRhdGVEZXBlbmRlbmNpZXMoXG5cdFx0XHRbXG5cdFx0XHRcdHsgbmFtZTogJ3Bhc3Nwb3J0JywgaW5zdGFuY2U6IHBhc3Nwb3J0IH0sXG5cdFx0XHRcdHsgbmFtZTogJ2F1dGhlbnRpY2F0ZU9wdGlvbnMnLCBpbnN0YW5jZTogYXV0aGVudGljYXRlT3B0aW9ucyB9XG5cdFx0XHRdLFxuXHRcdFx0dGhpcy5sb2dnZXJcblx0XHQpO1xuXG5cdFx0cmV0dXJuIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IHZvaWQgPT4ge1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0cGFzc3BvcnQuYXV0aGVudGljYXRlKFxuXHRcdFx0XHRcdCdqd3QnLFxuXHRcdFx0XHRcdGF1dGhlbnRpY2F0ZU9wdGlvbnMsXG5cdFx0XHRcdFx0KGVycjogRXJyb3IgfCBudWxsLCB1c2VyOiBFeHByZXNzLlVzZXIgfCBmYWxzZSkgPT4ge1xuXHRcdFx0XHRcdFx0aWYgKGVycikge1xuXHRcdFx0XHRcdFx0XHR0aGlzLmxvZ2dlci5lcnJvcihcblx0XHRcdFx0XHRcdFx0XHRgUGFzc3BvcnQgYXV0aGVudGljYXRpb24gZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YFxuXHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHRyZXMuc3RhdHVzKDUwMCkuanNvbih7XG5cdFx0XHRcdFx0XHRcdFx0ZXJyb3I6ICdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InXG5cdFx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdGlmICghdXNlcikge1xuXHRcdFx0XHRcdFx0XHR0aGlzLmxvZ2dlci53YXJuKCdVbmF1dGhvcml6ZWQgYWNjZXNzIGF0dGVtcHQnKTtcblx0XHRcdFx0XHRcdFx0cmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSk7XG5cdFx0XHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0cmVxLnVzZXIgPSB1c2VyO1xuXHRcdFx0XHRcdFx0cmV0dXJuIG5leHQoKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdCkocmVxLCByZXMsIG5leHQpO1xuXHRcdFx0fSBjYXRjaCAoZXhwcmVzc0Vycm9yKSB7XG5cdFx0XHRcdHRoaXMuaGFuZGxlRXJyb3IoZXhwcmVzc0Vycm9yLCByZXEsIHJlcywgbmV4dCk7XG5cdFx0XHR9XG5cdFx0fTtcblx0fVxuXG5cdHB1YmxpYyBhc3luYyBzaHV0ZG93bigpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHR0cnkge1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnU2h1dHRpbmcgZG93biBQYXNzcG9ydCBtaWRkbGV3YXJlIHNlcnZpY2UuLi4nKTtcblx0XHRcdFBhc3Nwb3J0QXV0aE1pZGRsZXdhcmVTZXJ2aWNlLmluc3RhbmNlID0gbnVsbDtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ1Bhc3Nwb3J0IG1pZGRsZXdhcmUgc2VydmljZSBoYXMgYmVlbiBzaHV0IGRvd24uJyk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nRXJyb3IoXG5cdFx0XHRcdGBFcnJvciBzaHV0dGluZyBkb3duIFBhc3Nwb3J0IG1pZGRsZXdhcmUgc2VydmljZTogJHtcblx0XHRcdFx0XHRlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yXG5cdFx0XHRcdH1gXG5cdFx0XHQpO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgaGFuZGxlRXJyb3IoXG5cdFx0ZXhwcmVzc0Vycm9yOiBFcnJvciB8IHVua25vd24sXG5cdFx0cmVxOiBSZXF1ZXN0LFxuXHRcdHJlczogUmVzcG9uc2UsXG5cdFx0bmV4dDogTmV4dEZ1bmN0aW9uXG5cdCk6IHZvaWQge1xuXHRcdGNvbnN0IG1pZGRsZXdhcmU6IHN0cmluZyA9ICdQYXNzcG9ydE1pZGRsZXdhcmVTZXJ2aWNlJztcblx0XHRjb25zdCBleHByZXNzTWlkZGxld2FyZUVycm9yID1cblx0XHRcdG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuRXhwcmVzc0Vycm9yKFxuXHRcdFx0XHRgRmF0YWwgZXJyb3I6IEV4ZWN1dGlvbiBvZiAke21pZGRsZXdhcmV9IGZhaWxlZFxcblNodXR0aW5nIGRvd24uLi5cXG4ke1xuXHRcdFx0XHRcdGV4cHJlc3NFcnJvciBpbnN0YW5jZW9mIEVycm9yXG5cdFx0XHRcdFx0XHQ/IGV4cHJlc3NFcnJvci5tZXNzYWdlXG5cdFx0XHRcdFx0XHQ6ICdVbmtub3duIGVycm9yJ1xuXHRcdFx0XHR9YCxcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHV0aWxpdHk6IG1pZGRsZXdhcmUsXG5cdFx0XHRcdFx0b3JpZ2luYWxFcnJvcjogZXhwcmVzc0Vycm9yXG5cdFx0XHRcdH1cblx0XHRcdCk7XG5cblx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKGV4cHJlc3NNaWRkbGV3YXJlRXJyb3IubWVzc2FnZSk7XG5cdFx0dGhpcy5lcnJvckhhbmRsZXIuZXhwcmVzc0Vycm9ySGFuZGxlcigpKFxuXHRcdFx0ZXhwcmVzc01pZGRsZXdhcmVFcnJvcixcblx0XHRcdHJlcSxcblx0XHRcdHJlcyxcblx0XHRcdG5leHRcblx0XHQpO1xuXHRcdHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6ICdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InIH0pO1xuXHR9XG59XG4iXX0=
