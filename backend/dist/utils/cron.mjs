import cron from 'node-cron';
export function createCronJobs({
	logger,
	compressing,
	exec,
	fs,
	path,
	processEnv,
	__dirname
}) {
	const compressAndExportLogs = async (sourceDir, exportDir, logFileName) => {
		const timestamp = new Date().toISOString().replace(/:/g, '-');
		const outputFileName = `${logFileName.replace('.log', '')}-${timestamp}.gz`;
		const outputFilePath = path.join(exportDir, outputFileName);
		const sourceFilePath = path.join(sourceDir, logFileName);
		try {
			await compressing.gzip.compressFile(sourceFilePath, outputFilePath);
			logger.info(`${logFileName} successfully compressed`);
			return outputFilePath;
		} catch (err) {
			const error = err;
			logger.error(`Unable to compress ${logFileName}: ${error.message}`);
			throw new Error(`Error compressing log files: ${error.message}`);
		}
	};
	const runCommandAndLog = (command, logFilePath) => {
		return new Promise((resolve, reject) => {
			const logStream = fs.createWriteStream(logFilePath, { flags: 'a' });
			const process = exec(
				command,
				{ maxBuffer: 1024 * 500 },
				(error, stdout, stderr) => {
					if (error) {
						logStream.write(`ERROR: ${error.message}\n`);
						return reject(error);
					}
					if (stderr) {
						logStream.write(`STDERR: ${stderr}\n`);
					}
					logStream.write(stdout);
					logStream.end();
					resolve();
				}
			);
			if (process.stdout) process.stdout.pipe(logStream);
			if (process.stderr) process.stderr.pipe(logStream);
		});
	};
	const exportLogs = async () => {
		const serverLogDir = path.join(__dirname, processEnv.SERVER_LOG_PATH);
		const npmLogDir = path.join(__dirname, processEnv.SERVER_NPM_LOG_PATH);
		const exportDir = path.join(
			__dirname,
			processEnv.BACKEND_LOGGER_EXPORT_PATH
		);
		// Ensure the export directory exists
		if (!fs.existsSync(exportDir)) {
			fs.mkdirSync(exportDir, { recursive: true });
		}
		try {
			// Compress and export server logs
			const serverLogFiles = fs
				.readdirSync(serverLogDir)
				.filter(file => file.endsWith('.log'));
			for (const logFile of serverLogFiles) {
				await compressAndExportLogs(serverLogDir, exportDir, logFile);
			}
			// Compress and export npm logs
			const npmLogFiles = fs
				.readdirSync(npmLogDir)
				.filter(file => file.endsWith('.logs'));
			for (const logFile of npmLogFiles) {
				await compressAndExportLogs(npmLogDir, exportDir, logFile);
			}
			logger.info('Logs have been successfully compressed and exported.');
		} catch (err) {
			const error = err;
			logger.error(`Error exporting logs: ${error.message}`);
		}
	};
	const performNpmTasks = async () => {
		const npmLogDir = path.join(__dirname, processEnv.SERVER_NPM_LOG_PATH);
		const timestamp = new Date().toISOString().replace(/:/g, '-');
		const logFilePath = path.join(
			npmLogDir,
			`npm-audit-update-${timestamp}.log`
		);
		try {
			logger.info('Starting npm audit...');
			await runCommandAndLog('npm audit --verbose', logFilePath);
			logger.info('npm audit completed successfully.');
			logger.info('Starting npm update...');
			await runCommandAndLog('npm update --verbose', logFilePath);
			logger.info('npm update completed successfully.');
		} catch (err) {
			const error = err;
			logger.error(`Error during npm tasks: ${error.message}`);
		}
	};
	const scheduleLogJobs = () => {
		let schedule = '';
		switch (processEnv.LOGGER) {
			case '0':
				break;
			case '1':
				schedule = '*/2 * * * *';
				exportLogs();
				break;
			case '2':
				schedule = '0 */2 * * *';
				break;
			case '3':
				schedule = '0 */6 * * *';
				break;
			case '4':
				schedule = '0 */12 * * *';
				break;
			case '5':
				schedule = '0 0 * * *';
				break;
			case '6':
				schedule = '0 0 */2 * *';
				break;
			case '7':
				schedule = '0 0 * * 0';
				break;
			default:
				schedule = '0 0 * * *';
				logger.warn(
					'LOGGER variable not set. Defaulting to nightly log export'
				);
		}
		if (schedule) {
			cron.schedule(schedule, exportLogs);
		}
		cron.schedule('0 * * * *', performNpmTasks);
	};
	scheduleLogJobs();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9jcm9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sSUFBSSxNQUFNLFdBQVcsQ0FBQztBQWlCN0IsTUFBTSxVQUFVLGNBQWMsQ0FBQyxFQUM5QixNQUFNLEVBQ04sV0FBVyxFQUNYLElBQUksRUFDSixFQUFFLEVBQ0YsSUFBSSxFQUNKLFVBQVUsRUFDVixTQUFTLEVBQ1M7SUFDbEIsTUFBTSxxQkFBcUIsR0FBRyxLQUFLLEVBQ2xDLFNBQWlCLEVBQ2pCLFNBQWlCLEVBQ2pCLFdBQW1CLEVBQ0QsRUFBRTtRQUNwQixNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDOUQsTUFBTSxjQUFjLEdBQUcsR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsSUFBSSxTQUFTLEtBQUssQ0FBQztRQUM1RSxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUM1RCxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUV6RCxJQUFJLENBQUM7WUFDSixNQUFNLFdBQVcsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLGNBQWMsRUFBRSxjQUFjLENBQUMsQ0FBQztZQUNwRSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsV0FBVywwQkFBMEIsQ0FBQyxDQUFDO1lBQ3RELE9BQU8sY0FBYyxDQUFDO1FBQ3ZCLENBQUM7UUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1lBQ2QsTUFBTSxLQUFLLEdBQUcsR0FBWSxDQUFDO1lBQzNCLE1BQU0sQ0FBQyxLQUFLLENBQUMsc0JBQXNCLFdBQVcsS0FBSyxLQUFLLENBQUMsT0FB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bkIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjcm9uIGZyb20gJ25vZGUtY3Jvbic7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgY29tcHJlc3NpbmcgZnJvbSAnY29tcHJlc3NpbmcnO1xuaW1wb3J0IHsgZXhlYywgRXhlY0V4Y2VwdGlvbiB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSAnd2luc3Rvbic7XG5cbmludGVyZmFjZSBDcm9uRGVwZW5kZW5jaWVzIHtcblx0bG9nZ2VyOiBMb2dnZXI7XG5cdGNvbXByZXNzaW5nOiB0eXBlb2YgY29tcHJlc3Npbmc7XG5cdGV4ZWM6IHR5cGVvZiBleGVjO1xuXHRmczogdHlwZW9mIGZzO1xuXHRwYXRoOiB0eXBlb2YgcGF0aDtcblx0cHJvY2Vzc0VudjogTm9kZUpTLlByb2Nlc3NFbnY7XG5cdF9fZGlybmFtZTogc3RyaW5nO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQ3JvbkpvYnMoe1xuXHRsb2dnZXIsXG5cdGNvbXByZXNzaW5nLFxuXHRleGVjLFxuXHRmcyxcblx0cGF0aCxcblx0cHJvY2Vzc0Vudixcblx0X19kaXJuYW1lXG59OiBDcm9uRGVwZW5kZW5jaWVzKTogdm9pZCB7XG5cdGNvbnN0IGNvbXByZXNzQW5kRXhwb3J0TG9ncyA9IGFzeW5jIChcblx0XHRzb3VyY2VEaXI6IHN0cmluZyxcblx0XHRleHBvcnREaXI6IHN0cmluZyxcblx0XHRsb2dGaWxlTmFtZTogc3RyaW5nXG5cdCk6IFByb21pc2U8c3RyaW5nPiA9PiB7XG5cdFx0Y29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnJlcGxhY2UoLzovZywgJy0nKTtcblx0XHRjb25zdCBvdXRwdXRGaWxlTmFtZSA9IGAke2xvZ0ZpbGVOYW1lLnJlcGxhY2UoJy5sb2cnLCAnJyl9LSR7dGltZXN0YW1wfS5nemA7XG5cdFx0Y29uc3Qgb3V0cHV0RmlsZVBhdGggPSBwYXRoLmpvaW4oZXhwb3J0RGlyLCBvdXRwdXRGaWxlTmFtZSk7XG5cdFx0Y29uc3Qgc291cmNlRmlsZVBhdGggPSBwYXRoLmpvaW4oc291cmNlRGlyLCBsb2dGaWxlTmFtZSk7XG5cblx0XHR0cnkge1xuXHRcdFx0YXdhaXQgY29tcHJlc3NpbmcuZ3ppcC5jb21wcmVzc0ZpbGUoc291cmNlRmlsZVBhdGgsIG91dHB1dEZpbGVQYXRoKTtcblx0XHRcdGxvZ2dlci5pbmZvKGAke2xvZ0ZpbGVOYW1lfSBzdWNjZXNzZnVsbHkgY29tcHJlc3NlZGApO1xuXHRcdFx0cmV0dXJuIG91dHB1dEZpbGVQYXRoO1xuXHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0Y29uc3QgZXJyb3IgPSBlcnIgYXMgRXJyb3I7XG5cdFx0XHRsb2dnZXIuZXJyb3IoYFVuYWJsZSB0byBjb21wcmVzcyAke2xvZ0ZpbGVOYW1lfTogJHtlcnJvci5tZXNzYWdlfWApO1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBFcnJvciBjb21wcmVzc2luZyBsb2cgZmlsZXM6ICR7ZXJyb3IubWVzc2FnZX1gKTtcblx0XHR9XG5cdH07XG5cblx0Y29uc3QgcnVuQ29tbWFuZEFuZExvZyA9IChcblx0XHRjb21tYW5kOiBzdHJpbmcsXG5cdFx0bG9nRmlsZVBhdGg6IHN0cmluZ1xuXHQpOiBQcm9taXNlPHZvaWQ+ID0+IHtcblx0XHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0Y29uc3QgbG9nU3RyZWFtID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0obG9nRmlsZVBhdGgsIHsgZmxhZ3M6ICdhJyB9KTtcblx0XHRcdGNvbnN0IHByb2Nlc3MgPSBleGVjKFxuXHRcdFx0XHRjb21tYW5kLFxuXHRcdFx0XHR7IG1heEJ1ZmZlcjogMTAyNCAqIDUwMCB9LFxuXHRcdFx0XHQoXG5cdFx0XHRcdFx0ZXJyb3I6IEV4ZWNFeGNlcHRpb24gfCBudWxsLFxuXHRcdFx0XHRcdHN0ZG91dDogc3RyaW5nLFxuXHRcdFx0XHRcdHN0ZGVycjogc3RyaW5nXG5cdFx0XHRcdCkgPT4ge1xuXHRcdFx0XHRcdGlmIChlcnJvcikge1xuXHRcdFx0XHRcdFx0bG9nU3RyZWFtLndyaXRlKGBFUlJPUjogJHtlcnJvci5tZXNzYWdlfVxcbmApO1xuXHRcdFx0XHRcdFx0cmV0dXJuIHJlamVjdChlcnJvcik7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGlmIChzdGRlcnIpIHtcblx0XHRcdFx0XHRcdGxvZ1N0cmVhbS53cml0ZShgU1RERVJSOiAke3N0ZGVycn1cXG5gKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0bG9nU3RyZWFtLndyaXRlKHN0ZG91dCk7XG5cdFx0XHRcdFx0bG9nU3RyZWFtLmVuZCgpO1xuXHRcdFx0XHRcdHJlc29sdmUoKTtcblx0XHRcdFx0fVxuXHRcdFx0KTtcblxuXHRcdFx0aWYgKHByb2Nlc3Muc3Rkb3V0KSBwcm9jZXNzLnN0ZG91dC5waXBlKGxvZ1N0cmVhbSk7XG5cdFx0XHRpZiAocHJvY2Vzcy5zdGRlcnIpIHByb2Nlc3Muc3RkZXJyLnBpcGUobG9nU3RyZWFtKTtcblx0XHR9KTtcblx0fTtcblxuXHRjb25zdCBleHBvcnRMb2dzID0gYXN5bmMgKCk6IFByb21pc2U8dm9pZD4gPT4ge1xuXHRcdGNvbnN0IHNlcnZlckxvZ0RpciA9IHBhdGguam9pbihfX2Rpcm5hbWUsIHByb2Nlc3NFbnYuU0VSVkVSX0xPR19QQVRIISk7XG5cdFx0Y29uc3QgbnBtTG9nRGlyID0gcGF0aC5qb2luKF9fZGlybmFtZSwgcHJvY2Vzc0Vudi5TRVJWRVJfTlBNX0xPR19QQVRIISk7XG5cdFx0Y29uc3QgZXhwb3J0RGlyID0gcGF0aC5qb2luKFxuXHRcdFx0X19kaXJuYW1lLFxuXHRcdFx0cHJvY2Vzc0Vudi5CQUNLRU5EX0xPR0dFUl9FWFBPUlRfUEFUSCFcblx0XHQpO1xuXG5cdFx0Ly8gRW5zdXJlIHRoZSBleHBvcnQgZGlyZWN0b3J5IGV4aXN0c1xuXHRcdGlmICghZnMuZXhpc3RzU3luYyhleHBvcnREaXIpKSB7XG5cdFx0XHRmcy5ta2RpclN5bmMoZXhwb3J0RGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcblx0XHR9XG5cblx0XHR0cnkge1xuXHRcdFx0Ly8gQ29tcHJlc3MgYW5kIGV4cG9ydCBzZXJ2ZXIgbG9nc1xuXHRcdFx0Y29uc3Qgc2VydmVyTG9nRmlsZXMgPSBmc1xuXHRcdFx0XHQucmVhZGRpclN5bmMoc2VydmVyTG9nRGlyKVxuXHRcdFx0XHQuZmlsdGVyKGZpbGUgPT4gZmlsZS5lbmRzV2l0aCgnLmxvZycpKTtcblx0XHRcdGZvciAoY29uc3QgbG9nRmlsZSBvZiBzZXJ2ZXJMb2dGaWxlcykge1xuXHRcdFx0XHRhd2FpdCBjb21wcmVzc0FuZEV4cG9ydExvZ3Moc2VydmVyTG9nRGlyLCBleHBvcnREaXIsIGxvZ0ZpbGUpO1xuXHRcdFx0fVxuXG5cdFx0XHQvLyBDb21wcmVzcyBhbmQgZXhwb3J0IG5wbSBsb2dzXG5cdFx0XHRjb25zdCBucG1Mb2dGaWxlcyA9IGZzXG5cdFx0XHRcdC5yZWFkZGlyU3luYyhucG1Mb2dEaXIpXG5cdFx0XHRcdC5maWx0ZXIoZmlsZSA9PiBmaWxlLmVuZHNXaXRoKCcubG9ncycpKTtcblx0XHRcdGZvciAoY29uc3QgbG9nRmlsZSBvZiBucG1Mb2dGaWxlcykge1xuXHRcdFx0XHRhd2FpdCBjb21wcmVzc0FuZEV4cG9ydExvZ3MobnBtTG9nRGlyLCBleHBvcnREaXIsIGxvZ0ZpbGUpO1xuXHRcdFx0fVxuXG5cdFx0XHRsb2dnZXIuaW5mbygnTG9ncyBoYXZlIGJlZW4gc3VjY2Vzc2Z1bGx5IGNvbXByZXNzZWQgYW5kIGV4cG9ydGVkLicpO1xuXHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0Y29uc3QgZXJyb3IgPSBlcnIgYXMgRXJyb3I7XG5cdFx0XHRsb2dnZXIuZXJyb3IoYEVycm9yIGV4cG9ydGluZyBsb2dzOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG5cdFx0fVxuXHR9O1xuXG5cdGNvbnN0IHBlcmZvcm1OcG1UYXNrcyA9IGFzeW5jICgpOiBQcm9taXNlPHZvaWQ+ID0+IHtcblx0XHRjb25zdCBucG1Mb2dEaXIgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCBwcm9jZXNzRW52LlNFUlZFUl9OUE1fTE9HX1BBVEghKTtcblx0XHRjb25zdCB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkucmVwbGFjZSgvOi9nLCAnLScpO1xuXHRcdGNvbnN0IGxvZ0ZpbGVQYXRoID0gcGF0aC5qb2luKFxuXHRcdFx0bnBtTG9nRGlyLFxuXHRcdFx0YG5wbS1hdWRpdC11cGRhdGUtJHt0aW1lc3RhbXB9LmxvZ2Bcblx0XHQpO1xuXG5cdFx0dHJ5IHtcblx0XHRcdGxvZ2dlci5pbmZvKCdTdGFydGluZyBucG0gYXVkaXQuLi4nKTtcblx0XHRcdGF3YWl0IHJ1bkNvbW1hbmRBbmRMb2coJ25wbSBhdWRpdCAtLXZlcmJvc2UnLCBsb2dGaWxlUGF0aCk7XG5cdFx0XHRsb2dnZXIuaW5mbygnbnBtIGF1ZGl0IGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkuJyk7XG5cblx0XHRcdGxvZ2dlci5pbmZvKCdTdGFydGluZyBucG0gdXBkYXRlLi4uJyk7XG5cdFx0XHRhd2FpdCBydW5Db21tYW5kQW5kTG9nKCducG0gdXBkYXRlIC0tdmVyYm9zZScsIGxvZ0ZpbGVQYXRoKTtcblx0XHRcdGxvZ2dlci5pbmZvKCducG0gdXBkYXRlIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkuJyk7XG5cdFx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0XHRjb25zdCBlcnJvciA9IGVyciBhcyBFcnJvcjtcblx0XHRcdGxvZ2dlci5lcnJvcihgRXJyb3IgZHVyaW5nIG5wbSB0YXNrczogJHtlcnJvci5tZXNzYWdlfWApO1xuXHRcdH1cblx0fTtcblxuXHRjb25zdCBzY2hlZHVsZUxvZ0pvYnMgPSAoKTogdm9pZCA9PiB7XG5cdFx0bGV0IHNjaGVkdWxlID0gJyc7XG5cblx0XHRzd2l0Y2ggKHByb2Nlc3NFbnYuTE9HR0VSKSB7XG5cdFx0XHRjYXNlICcwJzpcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlICcxJzpcblx0XHRcdFx0c2NoZWR1bGUgPSAnKi8yICogKiAqIConO1xuXHRcdFx0XHRleHBvcnRMb2dzKCk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSAnMic6XG5cdFx0XHRcdHNjaGVkdWxlID0gJzAgKi8yICogKiAqJztcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlICczJzpcblx0XHRcdFx0c2NoZWR1bGUgPSAnMCAqLzYgKiAqIConO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgJzQnOlxuXHRcdFx0XHRzY2hlZHVsZSA9ICcwICovMTIgKiAqIConO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgJzUnOlxuXHRcdFx0XHRzY2hlZHVsZSA9ICcwIDAgKiAqIConO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgJzYnOlxuXHRcdFx0XHRzY2hlZHVsZSA9ICcwIDAgKi8yICogKic7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSAnNyc6XG5cdFx0XHRcdHNjaGVkdWxlID0gJzAgMCAqICogMCc7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0c2NoZWR1bGUgPSAnMCAwICogKiAqJztcblx0XHRcdFx0bG9nZ2VyLndhcm4oXG5cdFx0XHRcdFx0J0xPR0dFUiB2YXJpYWJsZSBub3Qgc2V0LiBEZWZhdWx0aW5nIHRvIG5pZ2h0bHkgbG9nIGV4cG9ydCdcblx0XHRcdFx0KTtcblx0XHR9XG5cblx0XHRpZiAoc2NoZWR1bGUpIHtcblx0XHRcdGNyb24uc2NoZWR1bGUoc2NoZWR1bGUsIGV4cG9ydExvZ3MpO1xuXHRcdH1cblx0XHRjcm9uLnNjaGVkdWxlKCcwICogKiAqIConLCBwZXJmb3JtTnBtVGFza3MpO1xuXHR9O1xuXG5cdHNjaGVkdWxlTG9nSm9icygpO1xufVxuIl19
