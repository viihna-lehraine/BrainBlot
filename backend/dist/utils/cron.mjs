import cron from 'node-cron';
import { validateDependencies } from '../utils/validateDependencies.mjs';
import { processError } from '../utils/processError.mjs';
export function createCronJobs({
	logger,
	compressing,
	exec,
	fs,
	path,
	processEnv,
	__dirname
}) {
	try {
		// Validate dependencies
		validateDependencies(
			[
				{ name: 'logger', instance: logger },
				{ name: 'compressing', instance: compressing },
				{ name: 'exec', instance: exec },
				{ name: 'fs', instance: fs },
				{ name: 'path', instance: path },
				{ name: 'processEnv', instance: processEnv },
				{ name: '__dirname', instance: __dirname }
			],
			logger
		);
		if (
			!processEnv.SERVER_LOG_PATH ||
			!processEnv.SERVER_NPM_LOG_PATH ||
			!processEnv.BACKEND_LOGGER_EXPORT_PATH
		) {
			throw new Error(`Required environment variables are missing`);
		}
		const compressAndExportLogs = async (
			sourceDir,
			exportDir,
			logFileName
		) => {
			const timestamp = new Date().toISOString().replace(/:/g, '-');
			const outputFileName = `${logFileName.replace('.log', '')}-${timestamp}.gz`;
			const outputFilePath = path.join(exportDir, outputFileName);
			const sourceFilePath = path.join(sourceDir, logFileName);
			try {
				await compressing.gzip.compressFile(
					sourceFilePath,
					outputFilePath
				);
				logger.info(`${logFileName} successfully compressed`);
				return outputFilePath;
			} catch (error) {
				processError(error, logger);
				throw new Error(
					`Error compressing log files: ${error instanceof Error ? error.message : String(error)}`
				);
			}
		};
		const runCommandAndLog = (command, logFilePath) => {
			return new Promise((resolve, reject) => {
				const logStream = fs.createWriteStream(logFilePath, {
					flags: 'a'
				});
				const process = exec(
					command,
					{ maxBuffer: 1024 * 500 },
					(error, stdout, stderr) => {
						if (error) {
							logStream.write(`ERROR: ${error.message}\n`);
							return reject(error);
						}
						if (stderr) {
							logStream.write(`STDERR: ${stderr}\n`);
						}
						logStream.write(stdout);
						logStream.end();
						resolve();
					}
				);
				if (process.stdout) process.stdout.pipe(logStream);
				if (process.stderr) process.stderr.pipe(logStream);
			});
		};
		const exportLogs = async () => {
			const serverLogDir = path.join(
				__dirname,
				processEnv.SERVER_LOG_PATH
			);
			const npmLogDir = path.join(
				__dirname,
				processEnv.SERVER_NPM_LOG_PATH
			);
			const exportDir = path.join(
				__dirname,
				processEnv.BACKEND_LOGGER_EXPORT_PATH
			);
			if (!fs.existsSync(exportDir)) {
				try {
					fs.mkdirSync(exportDir, { recursive: true });
				} catch (error) {
					processError(error, logger);
					throw new Error(
						`Error creating export directory: ${
							error instanceof Error
								? error.message
								: String(error)
						}`
					);
				}
			}
			try {
				// compress and export server logs
				const serverLogFiles = fs
					.readdirSync(serverLogDir)
					.filter(file => file.endsWith('.log'));
				for (const logFile of serverLogFiles) {
					await compressAndExportLogs(
						serverLogDir,
						exportDir,
						logFile
					);
				}
				// compress and export npm logs
				const npmLogFiles = fs
					.readdirSync(npmLogDir)
					.filter(file => file.endsWith('.logs'));
				for (const logFile of npmLogFiles) {
					await compressAndExportLogs(npmLogDir, exportDir, logFile);
				}
				logger.info(
					'Logs have been successfully compressed and exported.'
				);
			} catch (error) {
				processError(error, logger);
				throw new Error(
					`Error exporting logs: ${error instanceof Error ? error.message : String(error)}`
				);
			}
		};
		const performNpmTasks = async () => {
			const npmLogDir = path.join(
				__dirname,
				processEnv.SERVER_NPM_LOG_PATH
			);
			const timestamp = new Date().toISOString().replace(/:/g, '-');
			const logFilePath = path.join(
				npmLogDir,
				`npm-audit-update-${timestamp}.log`
			);
			try {
				logger.info('Starting npm audit...');
				await runCommandAndLog('npm audit --verbose', logFilePath);
				logger.info('npm audit completed successfully.');
				logger.info('Starting npm update...');
				await runCommandAndLog('npm update --verbose', logFilePath);
				logger.info('npm update completed successfully.');
			} catch (error) {
				processError(error, logger);
			}
		};
		const scheduleLogJobs = () => {
			let schedule = '';
			switch (processEnv.LOGGER) {
				case '0':
					break;
				case '1':
					schedule = '*/2 * * * *';
					exportLogs();
					break;
				case '2':
					schedule = '0 */2 * * *';
					break;
				case '3':
					schedule = '0 */6 * * *';
					break;
				case '4':
					schedule = '0 */12 * * *';
					break;
				case '5':
					schedule = '0 0 * * *';
					break;
				case '6':
					schedule = '0 0 */2 * *';
					break;
				case '7':
					schedule = '0 0 * * 0';
					break;
				default:
					schedule = '0 0 * * *';
					logger.warn(
						'LOGGER variable not set. Defaulting to nightly log export'
					);
			}
			if (schedule) {
				cron.schedule(schedule, () => {
					exportLogs().catch(error => processError(error, logger));
				});
			}
			cron.schedule('0 * * * *', () => {
				performNpmTasks().catch(error => processError(error, logger));
			});
		};
		scheduleLogJobs();
	} catch (error) {
		processError(error, logger);
		throw new Error(
			`Failed to create cron jobs: ${error instanceof Error ? error.message : String(error)}`
		);
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9jcm9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sSUFBSSxNQUFNLFdBQVcsQ0FBQztBQU03QixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUNyRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFZckQsTUFBTSxVQUFVLGNBQWMsQ0FBQyxFQUM5QixNQUFNLEVBQ04sV0FBVyxFQUNYLElBQUksRUFDSixFQUFFLEVBQ0YsSUFBSSxFQUNKLFVBQVUsRUFDVixTQUFTLEVBQ1M7SUFDbEIsSUFBSSxDQUFDO1FBQ0osd0JBQXdCO1FBQ3hCLG9CQUFvQixDQUNuQjtZQUNDLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFO1lBQ3BDLEVBQUUsSUFBSSxFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFO1lBQzlDLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFO1lBQ2hDLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFO1lBQzVCLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFO1lBQ2hDLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFO1lBQzVDLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFO1NBQzFDLEVBQ0QsTUFBTSxDQUNOLENBQUM7UUFFRixJQUNDLENBQUMsVUFBVSxDQUFDLGVBQWU7WUFDM0IsQ0FBQyxVQUFVLENBQUMsbUJBQW1CO1lBQy9CLENBQUMsVUFBVSxDQUFDLDBCQUEwQixFQUNyQyxDQUFDO1lBQ0YsTUFBTSxJQUFJLEtBQUssQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDO1FBQy9E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LENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUMxRCxDQUFDLENBQUMsQ0FBQztZQUNKLENBQUM7WUFFRCxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxHQUFHLEVBQUU7Z0JBQy9CLGVBQWUsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUMvRCxDQUFDLENBQUMsQ0FBQztRQUNKLENBQUMsQ0FBQztRQUVGLGVBQWUsRUFBRSxDQUFDO0lBQ25CLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2hCLFlBQVksQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDNUIsTUFBTSxJQUFJLEtBQUssQ0FDZCwrQkFDQyxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUN0RCxFQUFFLENBQ0YsQ0FBQztJQUNILENBQUM7QUFDRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNyb24gZnJvbSAnbm9kZS1jcm9uJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBjb21wcmVzc2luZyBmcm9tICdjb21wcmVzc2luZyc7XG5pbXBvcnQgeyBleGVjLCBFeGVjRXhjZXB0aW9uIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICcuLi9jb25maWcvbG9nZ2VyJztcbmltcG9ydCB7IHZhbGlkYXRlRGVwZW5kZW5jaWVzIH0gZnJvbSAnLi4vdXRpbHMvdmFsaWRhdGVEZXBlbmRlbmNpZXMnO1xuaW1wb3J0IHsgcHJvY2Vzc0Vycm9yIH0gZnJvbSAnLi4vdXRpbHMvcHJvY2Vzc0Vycm9yJztcblxuaW50ZXJmYWNlIENyb25EZXBlbmRlbmNpZXMge1xuXHRsb2dnZXI6IExvZ2dlcjtcblx0Y29tcHJlc3Npbmc6IHR5cGVvZiBjb21wcmVzc2luZztcblx0ZXhlYzogdHlwZW9mIGV4ZWM7XG5cdGZzOiB0eXBlb2YgZnM7XG5cdHBhdGg6IHR5cGVvZiBwYXRoO1xuXHRwcm9jZXNzRW52OiBOb2RlSlMuUHJvY2Vzc0Vudjtcblx0X19kaXJuYW1lOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVDcm9uSm9icyh7XG5cdGxvZ2dlcixcblx0Y29tcHJlc3NpbmcsXG5cdGV4ZWMsXG5cdGZzLFxuXHRwYXRoLFxuXHRwcm9jZXNzRW52LFxuXHRfX2Rpcm5hbWVcbn06IENyb25EZXBlbmRlbmNpZXMpOiB2b2lkIHtcblx0dHJ5IHtcblx0XHQvLyBWYWxpZGF0ZSBkZXBlbmRlbmNpZXNcblx0XHR2YWxpZGF0ZURlcGVuZGVuY2llcyhcblx0XHRcdFtcblx0XHRcdFx0eyBuYW1lOiAnbG9nZ2VyJywgaW5zdGFuY2U6IGxvZ2dlciB9LFxuXHRcdFx0XHR7IG5hbWU6ICdjb21wcmVzc2luZycsIGluc3RhbmNlOiBjb21wcmVzc2luZyB9LFxuXHRcdFx0XHR7IG5hbWU6ICdleGVjJywgaW5zdGFuY2U6IGV4ZWMgfSxcblx0XHRcdFx0eyBuYW1lOiAnZnMnLCBpbnN0YW5jZTogZnMgfSxcblx0XHRcdFx0eyBuYW1lOiAncGF0aCcsIGluc3RhbmNlOiBwYXRoIH0sXG5cdFx0XHRcdHsgbmFtZTogJ3Byb2Nlc3NFbnYnLCBpbnN0YW5jZTogcHJvY2Vzc0VudiB9LFxuXHRcdFx0XHR7IG5hbWU6ICdfX2Rpcm5hbWUnLCBpbnN0YW5jZTogX19kaXJuYW1lIH1cblx0XHRcdF0sXG5cdFx0XHRsb2dnZXJcblx0XHQpO1xuXG5cdFx0aWYgKFxuXHRcdFx0IXByb2Nlc3NFbnYuU0VSVkVSX0xPR19QQVRIIHx8XG5cdFx0XHQhcHJvY2Vzc0Vudi5TRVJWRVJfTlBNX0xPR19QQVRIIHx8XG5cdFx0XHQhcHJvY2Vzc0Vudi5CQUNLRU5EX0xPR0dFUl9FWFBPUlRfUEFUSFxuXHRcdCkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBSZXF1aXJlZCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgYXJlIG1pc3NpbmdgKTtcblx0XHR9XG5cblx0XHRjb25zdCBjb21wcmVzc0FuZEV4cG9ydExvZ3MgPSBhc3luYyAoXG5cdFx0XHRzb3VyY2VEaXI6IHN0cmluZyxcblx0XHRcdGV4cG9ydERpcjogc3RyaW5nLFxuXHRcdFx0bG9nRmlsZU5hbWU6IHN0cmluZ1xuXHRcdCk6IFByb21pc2U8c3RyaW5nPiA9PiB7XG5cdFx0XHRjb25zdCB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkucmVwbGFjZSgvOi9nLCAnLScpO1xuXHRcdFx0Y29uc3Qgb3V0cHV0RmlsZU5hbWUgPSBgJHtsb2dGaWxlTmFtZS5yZXBsYWNlKCcubG9nJywgJycpfS0ke3RpbWVzdGFtcH0uZ3pgO1xuXHRcdFx0Y29uc3Qgb3V0cHV0RmlsZVBhdGggPSBwYXRoLmpvaW4oZXhwb3J0RGlyLCBvdXRwdXRGaWxlTmFtZSk7XG5cdFx0XHRjb25zdCBzb3VyY2VGaWxlUGF0aCA9IHBhdGguam9pbihzb3VyY2VEaXIsIGxvZ0ZpbGVOYW1lKTtcblxuXHRcdFx0dHJ5IHtcblx0XHRcdFx0YXdhaXQgY29tcHJlc3NpbmcuZ3ppcC5jb21wcmVzc0ZpbGUoXG5cdFx0XHRcdFx0c291cmNlRmlsZVBhdGgsXG5cdFx0XHRcdFx0b3V0cHV0RmlsZVBhdGhcblx0XHRcdFx0KTtcblx0XHRcdFx0bG9nZ2VyLmluZm8oYCR7bG9nRmlsZU5hbWV9IHN1Y2Nlc3NmdWxseSBjb21wcmVzc2VkYCk7XG5cdFx0XHRcdHJldHVybiBvdXRwdXRGaWxlUGF0aDtcblx0XHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHRcdHByb2Nlc3NFcnJvcihlcnJvciwgbG9nZ2VyKTtcblx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKFxuXHRcdFx0XHRcdGBFcnJvciBjb21wcmVzc2luZyBsb2cgZmlsZXM6ICR7XG5cdFx0XHRcdFx0XHRlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcilcblx0XHRcdFx0XHR9YFxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXHRcdH07XG5cblx0XHRjb25zdCBydW5Db21tYW5kQW5kTG9nID0gKFxuXHRcdFx0Y29tbWFuZDogc3RyaW5nLFxuXHRcdFx0bG9nRmlsZVBhdGg6IHN0cmluZ1xuXHRcdCk6IFByb21pc2U8dm9pZD4gPT4ge1xuXHRcdFx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdFx0Y29uc3QgbG9nU3RyZWFtID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0obG9nRmlsZVBhdGgsIHtcblx0XHRcdFx0XHRmbGFnczogJ2EnXG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRjb25zdCBwcm9jZXNzID0gZXhlYyhcblx0XHRcdFx0XHRjb21tYW5kLFxuXHRcdFx0XHRcdHsgbWF4QnVmZmVyOiAxMDI0ICogNTAwIH0sXG5cdFx0XHRcdFx0KFxuXHRcdFx0XHRcdFx0ZXJyb3I6IEV4ZWNFeGNlcHRpb24gfCBudWxsLFxuXHRcdFx0XHRcdFx0c3Rkb3V0OiBzdHJpbmcsXG5cdFx0XHRcdFx0XHRzdGRlcnI6IHN0cmluZ1xuXHRcdFx0XHRcdCkgPT4ge1xuXHRcdFx0XHRcdFx0aWYgKGVycm9yKSB7XG5cdFx0XHRcdFx0XHRcdGxvZ1N0cmVhbS53cml0ZShgRVJST1I6ICR7ZXJyb3IubWVzc2FnZX1cXG5gKTtcblx0XHRcdFx0XHRcdFx0cmV0dXJuIHJlamVjdChlcnJvcik7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRpZiAoc3RkZXJyKSB7XG5cdFx0XHRcdFx0XHRcdGxvZ1N0cmVhbS53cml0ZShgU1RERVJSOiAke3N0ZGVycn1cXG5gKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdGxvZ1N0cmVhbS53cml0ZShzdGRvdXQpO1xuXHRcdFx0XHRcdFx0bG9nU3RyZWFtLmVuZCgpO1xuXHRcdFx0XHRcdFx0cmVzb2x2ZSgpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0KTtcblxuXHRcdFx0XHRpZiAocHJvY2Vzcy5zdGRvdXQpIHByb2Nlc3Muc3Rkb3V0LnBpcGUobG9nU3RyZWFtKTtcblx0XHRcdFx0aWYgKHByb2Nlc3Muc3RkZXJyKSBwcm9jZXNzLnN0ZGVyci5waXBlKGxvZ1N0cmVhbSk7XG5cdFx0XHR9KTtcblx0XHR9O1xuXG5cdFx0Y29uc3QgZXhwb3J0TG9ncyA9IGFzeW5jICgpOiBQcm9taXNlPHZvaWQ+ID0+IHtcblx0XHRcdGNvbnN0IHNlcnZlckxvZ0RpciA9IHBhdGguam9pbihcblx0XHRcdFx0X19kaXJuYW1lLFxuXHRcdFx0XHRwcm9jZXNzRW52LlNFUlZFUl9MT0dfUEFUSCFcblx0XHRcdCk7XG5cdFx0XHRjb25zdCBucG1Mb2dEaXIgPSBwYXRoLmpvaW4oXG5cdFx0XHRcdF9fZGlybmFtZSxcblx0XHRcdFx0cHJvY2Vzc0Vudi5TRVJWRVJfTlBNX0xPR19QQVRIIVxuXHRcdFx0KTtcblx0XHRcdGNvbnN0IGV4cG9ydERpciA9IHBhdGguam9pbihcblx0XHRcdFx0X19kaXJuYW1lLFxuXHRcdFx0XHRwcm9jZXNzRW52LkJBQ0tFTkRfTE9HR0VSX0VYUE9SVF9QQVRIIVxuXHRcdFx0KTtcblxuXHRcdFx0aWYgKCFmcy5leGlzdHNTeW5jKGV4cG9ydERpcikpIHtcblx0XHRcdFx0dHJ5IHtcblx0XHRcdFx0XHRmcy5ta2RpclN5bmMoZXhwb3J0RGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcblx0XHRcdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdFx0XHRwcm9jZXNzRXJyb3IoZXJyb3IsIGxvZ2dlcik7XG5cdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKFxuXHRcdFx0XHRcdFx0YEVycm9yIGNyZWF0aW5nIGV4cG9ydCBkaXJlY3Rvcnk6ICR7XG5cdFx0XHRcdFx0XHRcdGVycm9yIGluc3RhbmNlb2YgRXJyb3Jcblx0XHRcdFx0XHRcdFx0XHQ/IGVycm9yLm1lc3NhZ2Vcblx0XHRcdFx0XHRcdFx0XHQ6IFN0cmluZyhlcnJvcilcblx0XHRcdFx0XHRcdH1gXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHR0cnkge1xuXHRcdFx0XHQvLyBjb21wcmVzcyBhbmQgZXhwb3J0IHNlcnZlciBsb2dzXG5cdFx0XHRcdGNvbnN0IHNlcnZlckxvZ0ZpbGVzID0gZnNcblx0XHRcdFx0XHQucmVhZGRpclN5bmMoc2VydmVyTG9nRGlyKVxuXHRcdFx0XHRcdC5maWx0ZXIoZmlsZSA9PiBmaWxlLmVuZHNXaXRoKCcubG9nJykpO1xuXHRcdFx0XHRmb3IgKGNvbnN0IGxvZ0ZpbGUgb2Ygc2VydmVyTG9nRmlsZXMpIHtcblx0XHRcdFx0XHRhd2FpdCBjb21wcmVzc0FuZEV4cG9ydExvZ3MoXG5cdFx0XHRcdFx0XHRzZXJ2ZXJMb2dEaXIsXG5cdFx0XHRcdFx0XHRleHBvcnREaXIsXG5cdFx0XHRcdFx0XHRsb2dGaWxlXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdC8vIGNvbXByZXNzIGFuZCBleHBvcnQgbnBtIGxvZ3Ncblx0XHRcdFx0Y29uc3QgbnBtTG9nRmlsZXMgPSBmc1xuXHRcdFx0XHRcdC5yZWFkZGlyU3luYyhucG1Mb2dEaXIpXG5cdFx0XHRcdFx0LmZpbHRlcihmaWxlID0+IGZpbGUuZW5kc1dpdGgoJy5sb2dzJykpO1xuXHRcdFx0XHRmb3IgKGNvbnN0IGxvZ0ZpbGUgb2YgbnBtTG9nRmlsZXMpIHtcblx0XHRcdFx0XHRhd2FpdCBjb21wcmVzc0FuZEV4cG9ydExvZ3MobnBtTG9nRGlyLCBleHBvcnREaXIsIGxvZ0ZpbGUpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0bG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0J0xvZ3MgaGF2ZSBiZWVuIHN1Y2Nlc3NmdWxseSBjb21wcmVzc2VkIGFuZCBleHBvcnRlZC4nXG5cdFx0XHRcdCk7XG5cdFx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0XHRwcm9jZXNzRXJyb3IoZXJyb3IsIGxvZ2dlcik7XG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcihcblx0XHRcdFx0XHRgRXJyb3IgZXhwb3J0aW5nIGxvZ3M6ICR7XG5cdFx0XHRcdFx0XHRlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcilcblx0XHRcdFx0XHR9YFxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXHRcdH07XG5cblx0XHRjb25zdCBwZXJmb3JtTnBtVGFza3MgPSBhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XG5cdFx0XHRjb25zdCBucG1Mb2dEaXIgPSBwYXRoLmpvaW4oXG5cdFx0XHRcdF9fZGlybmFtZSxcblx0XHRcdFx0cHJvY2Vzc0Vudi5TRVJWRVJfTlBNX0xPR19QQVRIIVxuXHRcdFx0KTtcblx0XHRcdGNvbnN0IHRpbWVzdGFtcCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5yZXBsYWNlKC86L2csICctJyk7XG5cdFx0XHRjb25zdCBsb2dGaWxlUGF0aCA9IHBhdGguam9pbihcblx0XHRcdFx0bnBtTG9nRGlyLFxuXHRcdFx0XHRgbnBtLWF1ZGl0LXVwZGF0ZS0ke3RpbWVzdGFtcH0ubG9nYFxuXHRcdFx0KTtcblxuXHRcdFx0dHJ5IHtcblx0XHRcdFx0bG9nZ2VyLmluZm8oJ1N0YXJ0aW5nIG5wbSBhdWRpdC4uLicpO1xuXHRcdFx0XHRhd2FpdCBydW5Db21tYW5kQW5kTG9nKCducG0gYXVkaXQgLS12ZXJib3NlJywgbG9nRmlsZVBhdGgpO1xuXHRcdFx0XHRsb2dnZXIuaW5mbygnbnBtIGF1ZGl0IGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkuJyk7XG5cblx0XHRcdFx0bG9nZ2VyLmluZm8oJ1N0YXJ0aW5nIG5wbSB1cGRhdGUuLi4nKTtcblx0XHRcdFx0YXdhaXQgcnVuQ29tbWFuZEFuZExvZygnbnBtIHVwZGF0ZSAtLXZlcmJvc2UnLCBsb2dGaWxlUGF0aCk7XG5cdFx0XHRcdGxvZ2dlci5pbmZvKCducG0gdXBkYXRlIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkuJyk7XG5cdFx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0XHRwcm9jZXNzRXJyb3IoZXJyb3IsIGxvZ2dlcik7XG5cdFx0XHR9XG5cdFx0fTtcblxuXHRcdGNvbnN0IHNjaGVkdWxlTG9nSm9icyA9ICgpOiB2b2lkID0+IHtcblx0XHRcdGxldCBzY2hlZHVsZSA9ICcnO1xuXG5cdFx0XHRzd2l0Y2ggKHByb2Nlc3NFbnYuTE9HR0VSKSB7XG5cdFx0XHRcdGNhc2UgJzAnOlxuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRjYXNlICcxJzpcblx0XHRcdFx0XHRzY2hlZHVsZSA9ICcqLzIgKiAqICogKic7XG5cdFx0XHRcdFx0ZXhwb3J0TG9ncygpO1xuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRjYXNlICcyJzpcblx0XHRcdFx0XHRzY2hlZHVsZSA9ICcwICovMiAqICogKic7XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdGNhc2UgJzMnOlxuXHRcdFx0XHRcdHNjaGVkdWxlID0gJzAgKi82ICogKiAqJztcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0Y2FzZSAnNCc6XG5cdFx0XHRcdFx0c2NoZWR1bGUgPSAnMCAqLzEyICogKiAqJztcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0Y2FzZSAnNSc6XG5cdFx0XHRcdFx0c2NoZWR1bGUgPSAnMCAwICogKiAqJztcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0Y2FzZSAnNic6XG5cdFx0XHRcdFx0c2NoZWR1bGUgPSAnMCAwICovMiAqIConO1xuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRjYXNlICc3Jzpcblx0XHRcdFx0XHRzY2hlZHVsZSA9ICcwIDAgKiAqIDAnO1xuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRcdHNjaGVkdWxlID0gJzAgMCAqICogKic7XG5cdFx0XHRcdFx0bG9nZ2VyLndhcm4oXG5cdFx0XHRcdFx0XHQnTE9HR0VSIHZhcmlhYmxlIG5vdCBzZXQuIERlZmF1bHRpbmcgdG8gbmlnaHRseSBsb2cgZXhwb3J0J1xuXHRcdFx0XHRcdCk7XG5cdFx0XHR9XG5cblx0XHRcdGlmIChzY2hlZHVsZSkge1xuXHRcdFx0XHRjcm9uLnNjaGVkdWxlKHNjaGVkdWxlLCAoKSA9PiB7XG5cdFx0XHRcdFx0ZXhwb3J0TG9ncygpLmNhdGNoKGVycm9yID0+IHByb2Nlc3NFcnJvcihlcnJvciwgbG9nZ2VyKSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXG5cdFx0XHRjcm9uLnNjaGVkdWxlKCcwICogKiAqIConLCAoKSA9PiB7XG5cdFx0XHRcdHBlcmZvcm1OcG1UYXNrcygpLmNhdGNoKGVycm9yID0+IHByb2Nlc3NFcnJvcihlcnJvciwgbG9nZ2VyKSk7XG5cdFx0XHR9KTtcblx0XHR9O1xuXG5cdFx0c2NoZWR1bGVMb2dKb2JzKCk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0cHJvY2Vzc0Vycm9yKGVycm9yLCBsb2dnZXIpO1xuXHRcdHRocm93IG5ldyBFcnJvcihcblx0XHRcdGBGYWlsZWQgdG8gY3JlYXRlIGNyb24gam9iczogJHtcblx0XHRcdFx0ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpXG5cdFx0XHR9YFxuXHRcdCk7XG5cdH1cbn1cbiJdfQ==
