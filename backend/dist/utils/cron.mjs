import cron from 'node-cron';
import fs from 'fs';
import path from 'path';
import compressing from 'compressing';
import { exec } from 'child_process';
import { fileURLToPath } from 'url';
import { dirname } from 'path';
import setupLogger from '../config/logger.mjs';
const logger = setupLogger();
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const compressAndExportLogs = async (sourceDir, exportDir, logFileName) => {
	const timestamp = new Date().toISOString().replace(/:/g, '-');
	const outputFileName = `${logFileName.replace('.log', '')}-${timestamp}.gz`;
	const outputFilePath = path.join(exportDir, outputFileName);
	const sourceFilePath = path.join(sourceDir, logFileName);
	try {
		await compressing.gzip.compressFile(sourceFilePath, outputFilePath);
		logger.info(`${logFileName} successfully compressed`);
		return outputFilePath;
	} catch (err) {
		const error = err;
		logger.error(`Unable to compress ${logFileName}: ${error.message}`);
		throw new Error(`Error compessing log files: ${error.message}`);
	}
};
const runCommandAndLog = (command, logFilePath) => {
	return new Promise((resolve, reject) => {
		const logStream = fs.createWriteStream(logFilePath, { flags: 'a' });
		const process = exec(
			command,
			{ maxBuffer: 1024 * 500 },
			(error, stdout, stderr) => {
				if (error) {
					logStream.write(`ERROR: ${error.message}\n`);
					return reject(error);
				}
				if (stderr) {
					logStream.write(`STDERR: ${stderr}\n`);
				}
				logStream.write(stdout);
				logStream.end();
				resolve();
			}
		);
		process.stdout.pipe(logStream);
		process.stderr.pipe(logStream);
	});
};
const exportLogs = async () => {
	const serverLogDir = path.join(__dirname, process.env.SERVER_LOG_PATH);
	const npmLogDir = path.join(__dirname, process.env.SERVER_NPM_LOG_PATH);
	const exportDir = path.join(
		__dirname,
		process.env.BACKEND_LOGGER_EXPORT_PATH
	);
	// Ensure the export directory exists
	if (!fs.existsSync(exportDir)) {
		fs.mkdirSync(exportDir, { recursive: true });
	}
	try {
		// compress and export server logs
		const serverLogFiles = fs
			.readdirSync(serverLogDir)
			.filter(file => file.endsWith('.log'));
		for (const logFile of serverLogFiles) {
			await compressAndExportLogs(serverLogDir, exportDir, logFile);
		}
		// Compress and export npm logs
		const npmLogFiles = fs
			.readdirSync(npmLogDir)
			.filter(file => file.endsWith('.logs'));
		for (const logFile of npmLogFiles) {
			await compressAndExportLogs(npmLogDir, exportDir, logFile);
		}
		logger.info('Logs have been successfully compresseed and exported.');
	} catch (err) {
		const error = err;
		logger.error(`Error exporting logs: ${error.message}`);
	}
};
// Perform hourly npm audit and update
const performNpmTasks = async () => {
	const npmLogDir = path.join(__dirname, process.env.SERVER_NPM_LOG_PATH);
	const timestamp = new Date().toISOString().replace(/:/g, '-');
	const logFilePath = path.join(
		npmLogDir,
		`npm-audit-update-${timestamp}.log`
	);
	try {
		logger.info('Starting npm audit...');
		await runCommandAndLog('npm audit --verbose', logFilePath);
		logger.info('npm audit completed successfully.');
		logger.info('Starting npm update...');
		await runCommandAndLog('npm update --verbose', logFilePath);
		logger.info('npm update completed successfully.');
	} catch (err) {
		const error = err;
		logger.error(`Error during npm tasks: ${error.message}`);
	}
};
// Determine the cron schedule based on LOGGER environment
const scheduleLogJobs = async () => {
	let schedule = '';
	switch (process.env.LOGGER) {
		case '0':
			break;
		case '1':
			schedule = '*/2 * * * *';
			exportLogs();
			break;
		case '2':
			schedule = '0 */2 * * *';
			break;
		case '3':
			schedule = '0 */6 * * *';
			break;
		case '4':
			schedule = '0 */12 * * *';
			break;
		case '5':
			schedule = '0 0 * * *';
			break;
		case '6':
			schedule = '0 0 */2 * *';
			break;
		case '7':
			schedule = '0 0 * * 0';
			break;
		default:
			schedule = '0 0 * * *';
			logger.warn(
				'LOGGER variable not set. Defaulting to nightly log export'
			);
	}
	cron.schedule(schedule, exportLogs);
	cron.schedule('0 * * * *', performNpmTasks);
};
scheduleLogJobs();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9jcm9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sSUFBSSxNQUFNLFdBQVcsQ0FBQztBQUM3QixPQUFPLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDcEIsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQ3hCLE9BQU8sV0FBVyxNQUFNLGFBQWEsQ0FBQztBQUN0QyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxLQUFLLENBQUM7QUFDcEMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLFdBQVcsTUFBTSxrQkFBa0IsQ0FBQztBQUUzQyxNQUFNLE1BQU0sR0FBRyxXQUFXLEVBQUUsQ0FBQztBQUM3QixNQUFNLFVBQVUsR0FBRyxhQUFhLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNsRCxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFFdEMsTUFBTSxxQkFBcUIsR0FBRyxLQUFLLEVBQ2xDLFNBQWlCLEVBQ2pCLFNBQWlCLEVBQ2pCLFdBQW1CLEVBQ0QsRUFBRTtJQUNwQixNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDOUQsTUFBTSxjQUFjLEdBQUcsR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsSUFBSSxTQUFTLEtBQUssQ0FBQztJQUM1RSxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxjQUFjLENBQUMsQ0FBQztJQUM1RCxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFB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UCxRQUFRLEdBQUcsV0FBVyxDQUFDO1lBQ3ZCLE1BQU07UUFDUDtZQUNDLFFBQVEsR0FBRyxXQUFXLENBQUM7WUFDdkIsTUFBTSxDQUFDLElBQUksQ0FDViwyREFBMkQsQ0FDM0QsQ0FBQztJQUNKLENBQUM7SUFFRCxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztJQUNwQyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxlQUFlLENBQUMsQ0FBQztBQUM3QyxDQUFDLENBQUM7QUFFRixlQUFlLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjcm9uIGZyb20gJ25vZGUtY3Jvbic7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgY29tcHJlc3NpbmcgZnJvbSAnY29tcHJlc3NpbmcnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IHsgZmlsZVVSTFRvUGF0aCB9IGZyb20gJ3VybCc7XG5pbXBvcnQgeyBkaXJuYW1lIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgc2V0dXBMb2dnZXIgZnJvbSAnLi4vY29uZmlnL2xvZ2dlcic7XG5cbmNvbnN0IGxvZ2dlciA9IHNldHVwTG9nZ2VyKCk7XG5jb25zdCBfX2ZpbGVuYW1lID0gZmlsZVVSTFRvUGF0aChpbXBvcnQubWV0YS51cmwpO1xuY29uc3QgX19kaXJuYW1lID0gZGlybmFtZShfX2ZpbGVuYW1lKTtcblxuY29uc3QgY29tcHJlc3NBbmRFeHBvcnRMb2dzID0gYXN5bmMgKFxuXHRzb3VyY2VEaXI6IHN0cmluZyxcblx0ZXhwb3J0RGlyOiBzdHJpbmcsXG5cdGxvZ0ZpbGVOYW1lOiBzdHJpbmdcbik6IFByb21pc2U8c3RyaW5nPiA9PiB7XG5cdGNvbnN0IHRpbWVzdGFtcCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5yZXBsYWNlKC86L2csICctJyk7XG5cdGNvbnN0IG91dHB1dEZpbGVOYW1lID0gYCR7bG9nRmlsZU5hbWUucmVwbGFjZSgnLmxvZycsICcnKX0tJHt0aW1lc3RhbXB9Lmd6YDtcblx0Y29uc3Qgb3V0cHV0RmlsZVBhdGggPSBwYXRoLmpvaW4oZXhwb3J0RGlyLCBvdXRwdXRGaWxlTmFtZSk7XG5cdGNvbnN0IHNvdXJjZUZpbGVQYXRoID0gcGF0aC5qb2luKHNvdXJjZURpciwgbG9nRmlsZU5hbWUpO1xuXG5cdHRyeSB7XG5cdFx0YXdhaXQgY29tcHJlc3NpbmcuZ3ppcC5jb21wcmVzc0ZpbGUoc291cmNlRmlsZVBhdGgsIG91dHB1dEZpbGVQYXRoKTtcblx0XHRsb2dnZXIuaW5mbyhgJHtsb2dGaWxlTmFtZX0gc3VjY2Vzc2Z1bGx5IGNvbXByZXNzZWRgKTtcblx0XHRyZXR1cm4gb3V0cHV0RmlsZVBhdGg7XG5cdH0gY2F0Y2ggKGVycikge1xuXHRcdGNvbnN0IGVycm9yID0gZXJyIGFzIEVycm9yO1xuXHRcdGxvZ2dlci5lcnJvcihgVW5hYmxlIHRvIGNvbXByZXNzICR7bG9nRmlsZU5hbWV9OiAke2Vycm9yLm1lc3NhZ2V9YCk7XG5cdFx0dGhyb3cgbmV3IEVycm9yKGBFcnJvciBjb21wZXNzaW5nIGxvZyBmaWxlczogJHtlcnJvci5tZXNzYWdlfWApO1xuXHR9XG59O1xuXG5jb25zdCBydW5Db21tYW5kQW5kTG9nID0gKFxuXHRjb21tYW5kOiBzdHJpbmcsXG5cdGxvZ0ZpbGVQYXRoOiBzdHJpbmdcbik6IFByb21pc2U8dm9pZD4gPT4ge1xuXHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdGNvbnN0IGxvZ1N0cmVhbSA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKGxvZ0ZpbGVQYXRoLCB7IGZsYWdzOiAnYScgfSk7XG5cdFx0Y29uc3QgcHJvY2VzcyA9IGV4ZWMoXG5cdFx0XHRjb21tYW5kLFxuXHRcdFx0eyBtYXhCdWZmZXI6IDEwMjQgKiA1MDAgfSxcblx0XHRcdChlcnJvciwgc3Rkb3V0LCBzdGRlcnIpID0+IHtcblx0XHRcdFx0aWYgKGVycm9yKSB7XG5cdFx0XHRcdFx0bG9nU3RyZWFtLndyaXRlKGBFUlJPUjogJHtlcnJvci5tZXNzYWdlfVxcbmApO1xuXHRcdFx0XHRcdHJldHVybiByZWplY3QoZXJyb3IpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGlmIChzdGRlcnIpIHtcblx0XHRcdFx0XHRsb2dTdHJlYW0ud3JpdGUoYFNUREVSUjogJHtzdGRlcnJ9XFxuYCk7XG5cdFx0XHRcdH1cblx0XHRcdFx0bG9nU3RyZWFtLndyaXRlKHN0ZG91dCk7XG5cdFx0XHRcdGxvZ1N0cmVhbS5lbmQoKTtcblx0XHRcdFx0cmVzb2x2ZSgpO1xuXHRcdFx0fVxuXHRcdCk7XG5cblx0XHRwcm9jZXNzLnN0ZG91dCEucGlwZShsb2dTdHJlYW0pO1xuXHRcdHByb2Nlc3Muc3RkZXJyIS5waXBlKGxvZ1N0cmVhbSk7XG5cdH0pO1xufTtcblxuY29uc3QgZXhwb3J0TG9ncyA9IGFzeW5jICgpOiBQcm9taXNlPHZvaWQ+ID0+IHtcblx0Y29uc3Qgc2VydmVyTG9nRGlyID0gcGF0aC5qb2luKF9fZGlybmFtZSwgcHJvY2Vzcy5lbnYuU0VSVkVSX0xPR19QQVRIISk7XG5cdGNvbnN0IG5wbUxvZ0RpciA9IHBhdGguam9pbihfX2Rpcm5hbWUsIHByb2Nlc3MuZW52LlNFUlZFUl9OUE1fTE9HX1BBVEghKTtcblx0Y29uc3QgZXhwb3J0RGlyID0gcGF0aC5qb2luKFxuXHRcdF9fZGlybmFtZSxcblx0XHRwcm9jZXNzLmVudi5CQUNLRU5EX0xPR0dFUl9FWFBPUlRfUEFUSCFcblx0KTtcblxuXHQvLyBFbnN1cmUgdGhlIGV4cG9ydCBkaXJlY3RvcnkgZXhpc3RzXG5cdGlmICghZnMuZXhpc3RzU3luYyhleHBvcnREaXIpKSB7XG5cdFx0ZnMubWtkaXJTeW5jKGV4cG9ydERpciwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG5cdH1cblxuXHR0cnkge1xuXHRcdC8vIGNvbXByZXNzIGFuZCBleHBvcnQgc2VydmVyIGxvZ3Ncblx0XHRjb25zdCBzZXJ2ZXJMb2dGaWxlcyA9IGZzXG5cdFx0XHQucmVhZGRpclN5bmMoc2VydmVyTG9nRGlyKVxuXHRcdFx0LmZpbHRlcihmaWxlID0+IGZpbGUuZW5kc1dpdGgoJy5sb2cnKSk7XG5cdFx0Zm9yIChjb25zdCBsb2dGaWxlIG9mIHNlcnZlckxvZ0ZpbGVzKSB7XG5cdFx0XHRhd2FpdCBjb21wcmVzc0FuZEV4cG9ydExvZ3Moc2VydmVyTG9nRGlyLCBleHBvcnREaXIsIGxvZ0ZpbGUpO1xuXHRcdH1cblxuXHRcdC8vIENvbXByZXNzIGFuZCBleHBvcnQgbnBtIGxvZ3Ncblx0XHRjb25zdCBucG1Mb2dGaWxlcyA9IGZzXG5cdFx0XHQucmVhZGRpclN5bmMobnBtTG9nRGlyKVxuXHRcdFx0LmZpbHRlcihmaWxlID0+IGZpbGUuZW5kc1dpdGgoJy5sb2dzJykpO1xuXHRcdGZvciAoY29uc3QgbG9nRmlsZSBvZiBucG1Mb2dGaWxlcykge1xuXHRcdFx0YXdhaXQgY29tcHJlc3NBbmRFeHBvcnRMb2dzKG5wbUxvZ0RpciwgZXhwb3J0RGlyLCBsb2dGaWxlKTtcblx0XHR9XG5cblx0XHRsb2dnZXIuaW5mbygnTG9ncyBoYXZlIGJlZW4gc3VjY2Vzc2Z1bGx5IGNvbXByZXNzZWVkIGFuZCBleHBvcnRlZC4nKTtcblx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0Y29uc3QgZXJyb3IgPSBlcnIgYXMgRXJyb3I7XG5cdFx0bG9nZ2VyLmVycm9yKGBFcnJvciBleHBvcnRpbmcgbG9nczogJHtlcnJvci5tZXNzYWdlfWApO1xuXHR9XG59O1xuXG4vLyBQZXJmb3JtIGhvdXJseSBucG0gYXVkaXQgYW5kIHVwZGF0ZVxuY29uc3QgcGVyZm9ybU5wbVRhc2tzID0gYXN5bmMgKCk6IFByb21pc2U8dm9pZD4gPT4ge1xuXHRjb25zdCBucG1Mb2dEaXIgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCBwcm9jZXNzLmVudi5TRVJWRVJfTlBNX0xPR19QQVRIISk7XG5cdGNvbnN0IHRpbWVzdGFtcCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5yZXBsYWNlKC86L2csICctJyk7XG5cdGNvbnN0IGxvZ0ZpbGVQYXRoID0gcGF0aC5qb2luKFxuXHRcdG5wbUxvZ0Rpcixcblx0XHRgbnBtLWF1ZGl0LXVwZGF0ZS0ke3RpbWVzdGFtcH0ubG9nYFxuXHQpO1xuXG5cdHRyeSB7XG5cdFx0bG9nZ2VyLmluZm8oJ1N0YXJ0aW5nIG5wbSBhdWRpdC4uLicpO1xuXHRcdGF3YWl0IHJ1bkNvbW1hbmRBbmRMb2coJ25wbSBhdWRpdCAtLXZlcmJvc2UnLCBsb2dGaWxlUGF0aCk7XG5cdFx0bG9nZ2VyLmluZm8oJ25wbSBhdWRpdCBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5LicpO1xuXG5cdFx0bG9nZ2VyLmluZm8oJ1N0YXJ0aW5nIG5wbSB1cGRhdGUuLi4nKTtcblx0XHRhd2FpdCBydW5Db21tYW5kQW5kTG9nKCducG0gdXBkYXRlIC0tdmVyYm9zZScsIGxvZ0ZpbGVQYXRoKTtcblx0XHRsb2dnZXIuaW5mbygnbnBtIHVwZGF0ZSBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5LicpO1xuXHR9IGNhdGNoIChlcnIpIHtcblx0XHRjb25zdCBlcnJvciA9IGVyciBhcyBFcnJvcjtcblx0XHRsb2dnZXIuZXJyb3IoYEVycm9yIGR1cmluZyBucG0gdGFza3M6ICR7ZXJyb3IubWVzc2FnZX1gKTtcblx0fVxufTtcblxuLy8gRGV0ZXJtaW5lIHRoZSBjcm9uIHNjaGVkdWxlIGJhc2VkIG9uIExPR0dFUiBlbnZpcm9ubWVudFxuY29uc3Qgc2NoZWR1bGVMb2dKb2JzID0gYXN5bmMgKCk6IFByb21pc2U8dm9pZD4gPT4ge1xuXHRsZXQgc2NoZWR1bGUgPSAnJztcblxuXHRzd2l0Y2ggKHByb2Nlc3MuZW52LkxPR0dFUikge1xuXHRcdGNhc2UgJzAnOlxuXHRcdFx0YnJlYWs7XG5cdFx0Y2FzZSAnMSc6XG5cdFx0XHRzY2hlZHVsZSA9ICcqLzIgKiAqICogKic7XG5cdFx0XHRleHBvcnRMb2dzKCk7XG5cdFx0XHRicmVhaztcblx0XHRjYXNlICcyJzpcblx0XHRcdHNjaGVkdWxlID0gJzAgKi8yICogKiAqJztcblx0XHRcdGJyZWFrO1xuXHRcdGNhc2UgJzMnOlxuXHRcdFx0c2NoZWR1bGUgPSAnMCAqLzYgKiAqIConO1xuXHRcdFx0YnJlYWs7XG5cdFx0Y2FzZSAnNCc6XG5cdFx0XHRzY2hlZHVsZSA9ICcwICovMTIgKiAqIConO1xuXHRcdFx0YnJlYWs7XG5cdFx0Y2FzZSAnNSc6XG5cdFx0XHRzY2hlZHVsZSA9ICcwIDAgKiAqIConO1xuXHRcdFx0YnJlYWs7XG5cdFx0Y2FzZSAnNic6XG5cdFx0XHRzY2hlZHVsZSA9ICcwIDAgKi8yICogKic7XG5cdFx0XHRicmVhaztcblx0XHRjYXNlICc3Jzpcblx0XHRcdHNjaGVkdWxlID0gJzAgMCAqICogMCc7XG5cdFx0XHRicmVhaztcblx0XHRkZWZhdWx0OlxuXHRcdFx0c2NoZWR1bGUgPSAnMCAwICogKiAqJztcblx0XHRcdGxvZ2dlci53YXJuKFxuXHRcdFx0XHQnTE9HR0VSIHZhcmlhYmxlIG5vdCBzZXQuIERlZmF1bHRpbmcgdG8gbmlnaHRseSBsb2cgZXhwb3J0J1xuXHRcdFx0KTtcblx0fVxuXG5cdGNyb24uc2NoZWR1bGUoc2NoZWR1bGUsIGV4cG9ydExvZ3MpO1xuXHRjcm9uLnNjaGVkdWxlKCcwICogKiAqIConLCBwZXJmb3JtTnBtVGFza3MpO1xufTtcblxuc2NoZWR1bGVMb2dKb2JzKCk7XG4iXX0=
