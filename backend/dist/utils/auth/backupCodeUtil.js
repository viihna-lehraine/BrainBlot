import bcrypt from 'bcrypt';
import crypto from 'crypto';
import setupLogger from '../../middleware/logger.js';
import UserMfaModelPromise from '../../models/UserMfa.js';
// Generate Backup Coedes
async function generateBackupCodes(id) {
	let backupCodes = [];
	for (let i = 0; i < 16; i++) {
		let code = crypto.randomBytes(4).toString('hex'); // 8-character hex code
		let hashedCode = await bcrypt.hash(code, 10);
		backupCodes.push({ code: hashedCode, used: false });
	}
	// store backupCodes in the database associated with the user's id
	await saveBackupCodesToDatabase(id, backupCodes);
	// return only the plain codes as strings
	return backupCodes.map((backupCode) => backupCode.code);
}
// Verify a Backup Code
async function verifyBackupCode(id, inputCode) {
	await UserMfaModelPromise; // await the UserMfa model when needed
	let storedCodes = await getBackupCodesFromDatabase(id);
	if (storedCodes) {
		for (let i = 0; i < storedCodes.length; i++) {
			let match = await bcrypt.compare(inputCode, storedCodes[i].code);
			if (match && !storedCodes[i].used) {
				storedCodes[i].used = true;
				await updateBackupCodesInDatabase(id, storedCodes); // mark the code as used
				return true; // successful verification
			}
		}
	} else {
		console.error('No backup codes found for user');
		return false; // no backup codes found
	}
	return false; // verification failed
}
// Save backup codes to the database
async function saveBackupCodesToDatabase(id, backupCodes) {
	let logger = await setupLogger();
	let UserfMfa = await UserMfaModelPromise; // await the UserMfa model when needed
	try {
		let user = await UserfMfa.findByPk(id); // find user by primary key
		if (!user) throw new Error('User not found');
		// map the codes element of backupCodes to an array of strings
		let backupCodesAsStrings = backupCodes.map((codeObj) => codeObj.code);
		// assign the array of strings to user.backupCodes
		user.backupCodes = backupCodesAsStrings;
		await user.save();
	} catch (err) {
		logger.error('Error saving backup codes to database: ', err);
		throw new Error('Failed to save backup codes to database');
	}
}
// Get backup codes from the database
async function getBackupCodesFromDatabase(id) {
	let logger = await setupLogger();
	let UserMfa = await UserMfaModelPromise; // await the User model when needed
	try {
		let user = await UserMfa.findByPk(id); // find user by primary key
		if (!user) throw new Error('User not found');
		// assume user.backupCodes is a string[] or null, convert it to BackuopCode[] or undefined
		let backupCodes = user.backupCodes;
		if (backupCodes === null) {
			return undefined; // *DEV-NOTE* probably need to configure this later
		}
		// convert string[] to BackupCode[]
		return backupCodes.map((code) => ({ code, used: false }));
	} catch (err) {
		logger.error('Error fetching backup codes from database: ', err);
		throw new Error('Failed to retrieve backup codes from database');
	}
}
// Update backup codes in the database
async function updateBackupCodesInDatabase(id, backupCodes) {
	let logger = await setupLogger();
	let UserMfa = await UserMfaModelPromise; // await the UserMfa model when needed
	try {
		let user = await UserMfa.findByPk(id); // find user by primary key
		if (!user) throw new Error('User not found');
		// map the codes element of backupCodes to an array of strings
		let backupCodesAsStrings = backupCodes.map((codeObj) => codeObj.code);
		// assign the array of strings to user.backupCodes
		user.backupCodes = backupCodesAsStrings;
		await user.save();
	} catch (err) {
		logger.error('Error updating backup codes in database: ', err);
		throw new Error('Failed to update backup codes in database');
	}
}
export {
	generateBackupCodes,
	getBackupCodesFromDatabase,
	saveBackupCodesToDatabase,
	verifyBackupCode
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja3VwQ29kZVV0aWwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvdXRpbHMvYXV0aC9iYWNrdXBDb2RlVXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLE1BQU0sTUFBTSxRQUFRLENBQUM7QUFDNUIsT0FBTyxNQUFNLE1BQU0sUUFBUSxDQUFDO0FBQzVCLE9BQU8sV0FBVyxNQUFNLHlCQUF5QixDQUFDO0FBQ2xELE9BQU8sbUJBQW1CLE1BQU0sc0JBQXNCLENBQUM7QUFPdkQseUJBQXlCO0FBQ3pCLEtBQUssVUFBVSxtQkFBbUIsQ0FBQyxFQUFVO0lBQzVDLElBQUksV0FBVyxHQUFpQixFQUFFLENBQUM7SUFDbkMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQzdCLElBQUksSUFBSSxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsdUJBQXVCO1FBQ3pFLElBQUksVUFBVSxHQUFHLE1BQU0sTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDN0MsV0FBVyxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVELGtFQUFrRTtJQUNsRSxNQUFNLHlCQUF5QixDQUFDLEVBQUUsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUVqRCx5Q0FBeUM7SUFDekMsT0FBTyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDekQsQ0FBQztBQUVELHVCQUF1QjtBQUN2QixLQUFLLFVBQVUsZ0JBQWdCLENBQzlCLEVBQVUsRUFDVixTQUFpQjtJQUVq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LHlCQUF5QixFQUN6QixnQkFBZ0IsRUFDaEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBiY3J5cHQgZnJvbSAnYmNyeXB0JztcbmltcG9ydCBjcnlwdG8gZnJvbSAnY3J5cHRvJztcbmltcG9ydCBzZXR1cExvZ2dlciBmcm9tICcuLi8uLi9taWRkbGV3YXJlL2xvZ2dlcic7XG5pbXBvcnQgVXNlck1mYU1vZGVsUHJvbWlzZSBmcm9tICcuLi8uLi9tb2RlbHMvVXNlck1mYSc7XG5cbmludGVyZmFjZSBCYWNrdXBDb2RlIHtcblx0Y29kZTogc3RyaW5nO1xuXHR1c2VkOiBib29sZWFuO1xufVxuXG4vLyBHZW5lcmF0ZSBCYWNrdXAgQ29lZGVzXG5hc3luYyBmdW5jdGlvbiBnZW5lcmF0ZUJhY2t1cENvZGVzKGlkOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG5cdGxldCBiYWNrdXBDb2RlczogQmFja3VwQ29kZVtdID0gW107XG5cdGZvciAobGV0IGkgPSAwOyBpIDwgMTY7IGkrKykge1xuXHRcdGxldCBjb2RlID0gY3J5cHRvLnJhbmRvbUJ5dGVzKDQpLnRvU3RyaW5nKCdoZXgnKTsgLy8gOC1jaGFyYWN0ZXIgaGV4IGNvZGVcblx0XHRsZXQgaGFzaGVkQ29kZSA9IGF3YWl0IGJjcnlwdC5oYXNoKGNvZGUsIDEwKTtcblx0XHRiYWNrdXBDb2Rlcy5wdXNoKHsgY29kZTogaGFzaGVkQ29kZSwgdXNlZDogZmFsc2UgfSk7XG5cdH1cblxuXHQvLyBzdG9yZSBiYWNrdXBDb2RlcyBpbiB0aGUgZGF0YWJhc2UgYXNzb2NpYXRlZCB3aXRoIHRoZSB1c2VyJ3MgaWRcblx0YXdhaXQgc2F2ZUJhY2t1cENvZGVzVG9EYXRhYmFzZShpZCwgYmFja3VwQ29kZXMpO1xuXG5cdC8vIHJldHVybiBvbmx5IHRoZSBwbGFpbiBjb2RlcyBhcyBzdHJpbmdzXG5cdHJldHVybiBiYWNrdXBDb2Rlcy5tYXAoKGJhY2t1cENvZGUpID0+IGJhY2t1cENvZGUuY29kZSk7XG59XG5cbi8vIFZlcmlmeSBhIEJhY2t1cCBDb2RlXG5hc3luYyBmdW5jdGlvbiB2ZXJpZnlCYWNrdXBDb2RlKFxuXHRpZDogc3RyaW5nLFxuXHRpbnB1dENvZGU6IHN0cmluZ1xuKTogUHJvbWlzZTxib29sZWFuPiB7XG5cdGF3YWl0IFVzZXJNZmFNb2RlbFByb21pc2U7IC8vIGF3YWl0IHRoZSBVc2VyTWZhIG1vZGVsIHdoZW4gbmVlZGVkXG5cdGxldCBzdG9yZWRDb2RlcyA9IGF3YWl0IGdldEJhY2t1cENvZGVzRnJvbURhdGFiYXNlKGlkKTtcblxuXHRpZiAoc3RvcmVkQ29kZXMpIHtcblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHN0b3JlZENvZGVzLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRsZXQgbWF0Y2ggPSBhd2FpdCBiY3J5cHQuY29tcGFyZShpbnB1dENvZGUsIHN0b3JlZENvZGVzW2ldLmNvZGUpO1xuXHRcdFx0aWYgKG1hdGNoICYmICFzdG9yZWRDb2Rlc1tpXS51c2VkKSB7XG5cdFx0XHRcdHN0b3JlZENvZGVzW2ldLnVzZWQgPSB0cnVlO1xuXHRcdFx0XHRhd2FpdCB1cGRhdGVCYWNrdXBDb2Rlc0luRGF0YWJhc2UoaWQsIHN0b3JlZENvZGVzKTsgLy8gbWFyayB0aGUgY29kZSBhcyB1c2VkXG5cdFx0XHRcdHJldHVybiB0cnVlOyAvLyBzdWNjZXNzZnVsIHZlcmlmaWNhdGlvblxuXHRcdFx0fVxuXHRcdH1cblx0fSBlbHNlIHtcblx0XHRjb25zb2xlLmVycm9yKCdObyBiYWNrdXAgY29kZXMgZm91bmQgZm9yIHVzZXInKTtcblx0XHRyZXR1cm4gZmFsc2U7IC8vIG5vIGJhY2t1cCBjb2RlcyBmb3VuZFxuXHR9XG5cblx0cmV0dXJuIGZhbHNlOyAvLyB2ZXJpZmljYXRpb24gZmFpbGVkXG59XG5cbi8vIFNhdmUgYmFja3VwIGNvZGVzIHRvIHRoZSBkYXRhYmFzZVxuYXN5bmMgZnVuY3Rpb24gc2F2ZUJhY2t1cENvZGVzVG9EYXRhYmFzZShcblx0aWQ6IHN0cmluZyxcblx0YmFja3VwQ29kZXM6IEJhY2t1cENvZGVbXVxuKTogUHJvbWlzZTx2b2lkPiB7XG5cdGxldCBsb2dnZXIgPSBhd2FpdCBzZXR1cExvZ2dlcigpO1xuXHRsZXQgVXNlcmZNZmEgPSBhd2FpdCBVc2VyTWZhTW9kZWxQcm9taXNlOyAvLyBhd2FpdCB0aGUgVXNlck1mYSBtb2RlbCB3aGVuIG5lZWRlZFxuXG5cdHRyeSB7XG5cdFx0bGV0IHVzZXIgPSBhd2FpdCBVc2VyZk1mYS5maW5kQnlQayhpZCk7IC8vIGZpbmQgdXNlciBieSBwcmltYXJ5IGtleVxuXHRcdGlmICghdXNlcikgdGhyb3cgbmV3IEVycm9yKCdVc2VyIG5vdCBmb3VuZCcpO1xuXG5cdFx0Ly8gbWFwIHRoZSBjb2RlcyBlbGVtZW50IG9mIGJhY2t1cENvZGVzIHRvIGFuIGFycmF5IG9mIHN0cmluZ3Ncblx0XHRsZXQgYmFja3VwQ29kZXNBc1N0cmluZ3MgPSBiYWNrdXBDb2Rlcy5tYXAoKGNvZGVPYmopID0+IGNvZGVPYmouY29kZSk7XG5cblx0XHQvLyBhc3NpZ24gdGhlIGFycmF5IG9mIHN0cmluZ3MgdG8gdXNlci5iYWNrdXBDb2Rlc1xuXHRcdHVzZXIuYmFja3VwQ29kZXMgPSBiYWNrdXBDb2Rlc0FzU3RyaW5ncztcblx0XHRhd2FpdCB1c2VyLnNhdmUoKTtcblx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0bG9nZ2VyLmVycm9yKCdFcnJvciBzYXZpbmcgYmFja3VwIGNvZGVzIHRvIGRhdGFiYXNlOiAnLCBlcnIpO1xuXHRcdHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHNhdmUgYmFja3VwIGNvZGVzIHRvIGRhdGFiYXNlJyk7XG5cdH1cbn1cblxuLy8gR2V0IGJhY2t1cCBjb2RlcyBmcm9tIHRoZSBkYXRhYmFzZVxuYXN5bmMgZnVuY3Rpb24gZ2V0QmFja3VwQ29kZXNGcm9tRGF0YWJhc2UoXG5cdGlkOiBzdHJpbmdcbik6IFByb21pc2U8QmFja3VwQ29kZVtdIHwgdW5kZWZpbmVkPiB7XG5cdGxldCBsb2dnZXIgPSBhd2FpdCBzZXR1cExvZ2dlcigpO1xuXHRsZXQgVXNlck1mYSA9IGF3YWl0IFVzZXJNZmFNb2RlbFByb21pc2U7IC8vIGF3YWl0IHRoZSBVc2VyIG1vZGVsIHdoZW4gbmVlZGVkXG5cblx0dHJ5IHtcblx0XHRsZXQgdXNlciA9IGF3YWl0IFVzZXJNZmEuZmluZEJ5UGsoaWQpOyAvLyBmaW5kIHVzZXIgYnkgcHJpbWFyeSBrZXlcblx0XHRpZiAoIXVzZXIpIHRocm93IG5ldyBFcnJvcignVXNlciBub3QgZm91bmQnKTtcblxuXHRcdC8vIGFzc3VtZSB1c2VyLmJhY2t1cENvZGVzIGlzIGEgc3RyaW5nW10gb3IgbnVsbCwgY29udmVydCBpdCB0byBCYWNrdW9wQ29kZVtdIG9yIHVuZGVmaW5lZFxuXHRcdGxldCBiYWNrdXBDb2RlcyA9IHVzZXIuYmFja3VwQ29kZXMgYXMgc3RyaW5nW10gfCBudWxsO1xuXG5cdFx0aWYgKGJhY2t1cENvZGVzID09PSBudWxsKSB7XG5cdFx0XHRyZXR1cm4gdW5kZWZpbmVkOyAvLyAqREVWLU5PVEUqIHByb2JhYmx5IG5lZWQgdG8gY29uZmlndXJlIHRoaXMgbGF0ZXJcblx0XHR9XG5cblx0XHQvLyBjb252ZXJ0IHN0cmluZ1tdIHRvIEJhY2t1cENvZGVbXVxuXHRcdHJldHVybiBiYWNrdXBDb2Rlcy5tYXAoKGNvZGUpID0+ICh7IGNvZGUsIHVzZWQ6IGZhbHNlIH0pIGFzIEJhY2t1cENvZGUpO1xuXHR9IGNhdGNoIChlcnIpIHtcblx0XHRsb2dnZXIuZXJyb3IoJ0Vycm9yIGZldGNoaW5nIGJhY2t1cCBjb2RlcyBmcm9tIGRhdGFiYXNlOiAnLCBlcnIpO1xuXHRcdHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIGJhY2t1cCBjb2RlcyBmcm9tIGRhdGFiYXNlJyk7XG5cdH1cbn1cblxuLy8gVXBkYXRlIGJhY2t1cCBjb2RlcyBpbiB0aGUgZGF0YWJhc2VcbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUJhY2t1cENvZGVzSW5EYXRhYmFzZShcblx0aWQ6IHN0cmluZyxcblx0YmFja3VwQ29kZXM6IEJhY2t1cENvZGVbXVxuKTogUHJvbWlzZTx2b2lkPiB7XG5cdGxldCBsb2dnZXIgPSBhd2FpdCBzZXR1cExvZ2dlcigpO1xuXHRsZXQgVXNlck1mYSA9IGF3YWl0IFVzZXJNZmFNb2RlbFByb21pc2U7IC8vIGF3YWl0IHRoZSBVc2VyTWZhIG1vZGVsIHdoZW4gbmVlZGVkXG5cblx0dHJ5IHtcblx0XHRsZXQgdXNlciA9IGF3YWl0IFVzZXJNZmEuZmluZEJ5UGsoaWQpOyAvLyBmaW5kIHVzZXIgYnkgcHJpbWFyeSBrZXlcblx0XHRpZiAoIXVzZXIpIHRocm93IG5ldyBFcnJvcignVXNlciBub3QgZm91bmQnKTtcblxuXHRcdC8vIG1hcCB0aGUgY29kZXMgZWxlbWVudCBvZiBiYWNrdXBDb2RlcyB0byBhbiBhcnJheSBvZiBzdHJpbmdzXG5cdFx0bGV0IGJhY2t1cENvZGVzQXNTdHJpbmdzID0gYmFja3VwQ29kZXMubWFwKChjb2RlT2JqKSA9PiBjb2RlT2JqLmNvZGUpO1xuXG5cdFx0Ly8gYXNzaWduIHRoZSBhcnJheSBvZiBzdHJpbmdzIHRvIHVzZXIuYmFja3VwQ29kZXNcblx0XHR1c2VyLmJhY2t1cENvZGVzID0gYmFja3VwQ29kZXNBc1N0cmluZ3M7XG5cdFx0YXdhaXQgdXNlci5zYXZlKCk7XG5cdH0gY2F0Y2ggKGVycikge1xuXHRcdGxvZ2dlci5lcnJvcignRXJyb3IgdXBkYXRpbmcgYmFja3VwIGNvZGVzIGluIGRhdGFiYXNlOiAnLCBlcnIpO1xuXHRcdHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHVwZGF0ZSBiYWNrdXAgY29kZXMgaW4gZGF0YWJhc2UnKTtcblx0fVxufVxuXG5leHBvcnQge1xuXHRnZW5lcmF0ZUJhY2t1cENvZGVzLFxuXHRnZXRCYWNrdXBDb2Rlc0Zyb21EYXRhYmFzZSxcblx0c2F2ZUJhY2t1cENvZGVzVG9EYXRhYmFzZSxcblx0dmVyaWZ5QmFja3VwQ29kZVxufTtcbiJdfQ==
