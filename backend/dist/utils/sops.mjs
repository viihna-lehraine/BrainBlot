/// *DEV-NOTE* refactor to use environmentVariables
import path from 'path';
async function getSecrets({ logger, execSync, getDirectoryPath }) {
	try {
		const secretsPath = path.join(
			getDirectoryPath(),
			'./config/secrets.json.gpg'
		);
		logger.info(`Resolved secrets path: ${secretsPath}`);
		const decryptedSecrets = execSync(
			`sops -d --output-type json ${secretsPath}`
		).toString();
		return JSON.parse(decryptedSecrets);
	} catch (err) {
		logger.info(`Error retrieving secrets from SOPS: ${err}`);
		throw err;
	}
}
async function decryptKey({ logger, execSync }, encryptedFilePath) {
	try {
		const decryptedKey = execSync(
			`sops -d --output-type string ${encryptedFilePath}`
		).toString('utf-8');
		return decryptedKey;
	} catch (err) {
		logger.error(`Error decrypting key: ${err}`);
		throw err;
	}
}
async function decryptDataFiles({ logger, execSync }) {
	try {
		const filePaths = [
			process.env.SERVER_DATA_FILE_PATH_1,
			process.env.SERVER_DATA_FILE_PATH_2,
			process.env.SERVER_DATA_FILE_PATH_3,
			process.env.SERVER_DATA_FILE_PATH_4
		];
		const decryptedFiles = {};
		for (const [index, filePath] of filePaths.entries()) {
			if (filePath) {
				decryptedFiles[`files${index + 1}`] = execSync(
					`sops -d --output-type json ${filePath}`
				).toString();
			} else {
				logger.warn(
					`SERVER_DATA_FILE_PATH_${index + 1} is not defined`
				);
			}
		}
		return decryptedFiles;
	} catch (err) {
		logger.error(
			`Error decrypting data files from backend data folder: ${err}`
		);
		throw err;
	}
}
async function getSSLKeys(dependencies) {
	const { logger, execSync, getDirectoryPath } = dependencies;
	try {
		const keyPath = path.join(
			getDirectoryPath(),
			'./keys/ssl/guestbook_key.pem.gpg'
		);
		const certPath = path.join(
			getDirectoryPath(),
			'./keys/ssl/guestbook_cert.pem.gpg'
		);
		const decryptedKey = await decryptKey({ logger, execSync }, keyPath);
		const decryptedCert = await decryptKey({ logger, execSync }, certPath);
		return {
			key: decryptedKey,
			cert: decryptedCert
		};
	} catch (err) {
		logger.error(
			`Error decrypting SSL keys from backend keys folder: ${err}`
		);
		throw err;
	}
}
export default { getSecrets, decryptKey, decryptDataFiles, getSSLKeys };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29wcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9zb3BzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLG1EQUFtRDtBQUduRCxPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUEyQ3hCLEtBQUssVUFBVSxVQUFVLENBQUMsRUFDekIsTUFBTSxFQUNOLFFBQVEsRUFDUixnQkFBZ0IsRUFDRTtJQUNsQixJQUFJLENBQUM7UUFDSixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUM1QixnQkFBZ0IsRUFBRSxFQUNsQiwyQkFBMkIsQ0FDM0IsQ0FBQztRQUNGLE1BQU0sQ0FBQyxJQUFJLENBQUMsMEJBQTBCLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDckQsTUFBTSxnQkFBZ0IsR0FBRyxRQUFRLENBQ2hDLDhCQUE4QixXQUFXLEVBQUUsQ0FDM0MsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNiLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2QsTUFBTSxDQUFDLElBQUksQ0FBQyx1Q0FBdUMsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUMxRCxNQUFNLEdBQUcsQ0FBQztJQUNYLENBQUM7QUFDRixDQUFDO0FBRUQsS0FBSyxVQUFVLFVBQVUsQ0FDeEIsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFpRCxFQUNuRSxpQkFBeUI7SUFFekIsSUFBSSxDQUFDO1FBQ0osTUFBTSxZQUFZLEdBQUcsUUFBUSxDQUM1QixnQ0FBZ0MsaUJBQWlCLEVBQUUsQ0FDbkQsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDcEIsT0FBTyxZQUFZLENBQUM7SUFDckIsQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDZCxNQUFNLENBQUMsS0FBSyxDQUFDLHlCQUF5QixHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQzdDLE1BQU0sR0FBRyxDQUFDO0lBQ1gsQ0FBQztBQUNGLENBQUM7QUFFRCxLQUFLLFVBQVUsZ0JBQWdCLENBQUMsRUFDL0IsTUFBTSxFQUNOLFFBQVEsRUFDdUM7SUFHL0MsSUFBSSxDQUFDO1FBQ0osTUFBTSxTQUFTLEdBQUc7WUFDakIsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUI7WUFDbkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUI7WUFDbkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUI7WUFDbkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUI7U0FDbkMsQ0FBQztRQUVGLE1BQU0sY0FBYyxHQUE4QixFQUFFLENBQUM7UUFFckQsS0FBSyxNQUFNLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxJQUFJLFNBQVMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDO1lBQ3JELElBQUksUUFBUSxFQUFFLENBQUM7Z0JBQ2QsY0FBYyxDQUFDLFFBQVEsS0FBSyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsUUFBUSxDQUM3Qyw4QkFBOEIsUUFBUSxFQUFFLENBQ3hDLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDZCxDQUFDO2lCQUFNLENBQUM7Z0JBQ1AsTUFBTSxDQUFDLElBQUksQ0FDVix5QkFBeUIsS0FBSyxHQUFHLENBQUMsaUJBQWlCLENBQ25ELENBQUM7WUFDSCxDQUFDO1FBQ0YsQ0FBQztRQUVELE9BQU8sY0FBYyxDQUFDO0lBQ3ZCLENBQUM7SUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2QsTUFBTSxDQUFDLEtBQUssQ0FDWCx5REFBeUQsR0FBRyxFQUFFLENBQzlELENBQUM7UUFDRixNQUFNLEdBQUcsQ0FBQztJQUNYLENBQUM7QUFDRixDQUFDO0FBRUQsS0FBSyxVQUFVLFVBQVUsQ0FDeEIsWUFBOEI7SUFFOUIsTUFBTSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxZQUFZLENBQUM7SUFDNUQsSUFBSSxDQUFDO1FBQ0osTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FDeEIsZ0JBQWdCLEVBQUUsRUFDbEIsa0NBQWtDLENBQ2xDLENBQUM7UUFDRixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUN6QixnQkFBZ0IsRUFBRSxFQUNsQixtQ0FBbUMsQ0FDbkMsQ0FBQztRQUNGLE1BQU0sWUFBWSxHQUFHLE1BQU0sVUFBVSxDQUFDLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3JFLE1BQU0sYUFBYSxHQUFHLE1BQU0sVUFBVSxDQUFDLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRXZFLE9BQU87WUFDTixHQUFHLEVBQUUsWUFBWTtZQUNqQixJQUFJLEVBQUUsYUFBYTtTQUNuQixDQUFDO0lBQ0gsQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDZCxNQUFNLENBQUMsS0FBSyxDQUNYLHVEQUF1RCxHQUFHLEVBQUUsQ0FDNUQsQ0FBQztRQUNGLE1BQU0sR0FBRyxDQUFDO0lBQ1gsQ0FBQztBQUNGLENBQUM7QUFFRCxlQUFlLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxVQUFVLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyAqREVWLU5PVEUqIHJlZmFjdG9yIHRvIHVzZSBlbnZpcm9ubWVudFZhcmlhYmxlc1xuXG5pbXBvcnQgeyBleGVjU3luYyB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5cbmludGVyZmFjZSBTb3BzRGVwZW5kZW5jaWVzIHtcblx0bG9nZ2VyOiBSZXR1cm5UeXBlPHR5cGVvZiBpbXBvcnQoJy4uL2NvbmZpZy9sb2dnZXInKS5kZWZhdWx0Pjtcblx0ZXhlY1N5bmM6IHR5cGVvZiBleGVjU3luYztcblx0Z2V0RGlyZWN0b3J5UGF0aDogKCkgPT4gc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgU2VjcmV0cyB7XG5cdFtrZXk6IHN0cmluZ106IHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfCBzdHJpbmdbXSB8IG51bWJlcltdIHwgYm9vbGVhbltdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNlY3JldHNNYXAgZXh0ZW5kcyBTZWNyZXRzIHtcblx0QVBQX1NTTF9LRVk6IHN0cmluZztcblx0QVBQX1NTTF9DRVJUOiBzdHJpbmc7XG5cdERCX1NTTF9LRVk6IHN0cmluZztcblx0REJfU1NMX0NFUlQ6IHN0cmluZztcblx0REJfTkFNRTogc3RyaW5nO1xuXHREQl9VU0VSOiBzdHJpbmc7XG5cdERCX1BBU1NXT1JEOiBzdHJpbmc7XG5cdERCX0hPU1Q6IHN0cmluZztcblx0REJfRElBTEVDVDogJ215c3FsJyB8ICdwb3N0Z3JlcycgfCAnc3FsaXRlJyB8ICdtYXJpYWRiJyB8ICdtc3NxbCc7XG5cdEVNQUlMXzJGQV9LRVk6IHN0cmluZztcblx0RU1BSUxfSE9TVDogc3RyaW5nO1xuXHRFTUFJTF9QT1JUOiBudW1iZXI7XG5cdEVNQUlMX1NFQ1VSRTogYm9vbGVhbjtcblx0RklET19BVVRIRU5USUNBVE9SX1JFUVVJUkVfUkVTSURFTlRfS0VZOiBib29sZWFuO1xuXHRGSURPX0FVVEhFTlRJQ0FUT1JfVVNFUl9WRVJJRklDQVRJT046XG5cdFx0fCAncmVxdWlyZWQnXG5cdFx0fCAncHJlZmVycmVkJ1xuXHRcdHwgJ2Rpc2NvdXJhZ2VkJztcblx0RklET19DSEFMTEVOR0VfU0laRTogbnVtYmVyO1xuXHRGSURPX0NSWVBUT19QQVJBTUVURVJTOiBudW1iZXJbXTtcblx0SldUX1NFQ1JFVDogc3RyaW5nO1xuXHRQRVBQRVI6IHN0cmluZztcblx0UlBfSUQ6IHN0cmluZztcblx0UlBfTkFNRTogc3RyaW5nO1xuXHRSUF9JQ09OOiBzdHJpbmc7XG5cdFNNVFBfVE9LRU46IHN0cmluZztcblx0WVVCSUNPX0NMSUVOVF9JRDogbnVtYmVyO1xuXHRZVUJJQ09fU0VDUkVUX0tFWTogc3RyaW5nO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRTZWNyZXRzKHtcblx0bG9nZ2VyLFxuXHRleGVjU3luYyxcblx0Z2V0RGlyZWN0b3J5UGF0aFxufTogU29wc0RlcGVuZGVuY2llcyk6IFByb21pc2U8U2VjcmV0c01hcD4ge1xuXHR0cnkge1xuXHRcdGNvbnN0IHNlY3JldHNQYXRoID0gcGF0aC5qb2luKFxuXHRcdFx0Z2V0RGlyZWN0b3J5UGF0aCgpLFxuXHRcdFx0Jy4vY29uZmlnL3NlY3JldHMuanNvbi5ncGcnXG5cdFx0KTtcblx0XHRsb2dnZXIuaW5mbyhgUmVzb2x2ZWQgc2VjcmV0cyBwYXRoOiAke3NlY3JldHNQYXRofWApO1xuXHRcdGNvbnN0IGRlY3J5cHRlZFNlY3JldHMgPSBleGVjU3luYyhcblx0XHRcdGBzb3BzIC1kIC0tb3V0cHV0LXR5cGUganNvbiAke3NlY3JldHNQYXRofWBcblx0XHQpLnRvU3RyaW5nKCk7XG5cdFx0cmV0dXJuIEpTT04ucGFyc2UoZGVjcnlwdGVkU2VjcmV0cyk7XG5cdH0gY2F0Y2ggKGVycikge1xuXHRcdGxvZ2dlci5pbmZvKGBFcnJvciByZXRyaWV2aW5nIHNlY3JldHMgZnJvbSBTT1BTOiAke2Vycn1gKTtcblx0XHR0aHJvdyBlcnI7XG5cdH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZGVjcnlwdEtleShcblx0eyBsb2dnZXIsIGV4ZWNTeW5jIH06IFBpY2s8U29wc0RlcGVuZGVuY2llcywgJ2xvZ2dlcicgfCAnZXhlY1N5bmMnPixcblx0ZW5jcnlwdGVkRmlsZVBhdGg6IHN0cmluZ1xuKTogUHJvbWlzZTxzdHJpbmc+IHtcblx0dHJ5IHtcblx0XHRjb25zdCBkZWNyeXB0ZWRLZXkgPSBleGVjU3luYyhcblx0XHRcdGBzb3BzIC1kIC0tb3V0cHV0LXR5cGUgc3RyaW5nICR7ZW5jcnlwdGVkRmlsZVBhdGh9YFxuXHRcdCkudG9TdHJpbmcoJ3V0Zi04Jyk7XG5cdFx0cmV0dXJuIGRlY3J5cHRlZEtleTtcblx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0bG9nZ2VyLmVycm9yKGBFcnJvciBkZWNyeXB0aW5nIGtleTogJHtlcnJ9YCk7XG5cdFx0dGhyb3cgZXJyO1xuXHR9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRlY3J5cHREYXRhRmlsZXMoe1xuXHRsb2dnZXIsXG5cdGV4ZWNTeW5jXG59OiBQaWNrPFNvcHNEZXBlbmRlbmNpZXMsICdsb2dnZXInIHwgJ2V4ZWNTeW5jJz4pOiBQcm9taXNlPHtcblx0W2tleTogc3RyaW5nXTogc3RyaW5nO1xufT4ge1xuXHR0cnkge1xuXHRcdGNvbnN0IGZpbGVQYXRocyA9IFtcblx0XHRcdHByb2Nlc3MuZW52LlNFUlZFUl9EQVRBX0ZJTEVfUEFUSF8xLFxuXHRcdFx0cHJvY2Vzcy5lbnYuU0VSVkVSX0RBVEFfRklMRV9QQVRIXzIsXG5cdFx0XHRwcm9jZXNzLmVudi5TRVJWRVJfREFUQV9GSUxFX1BBVEhfMyxcblx0XHRcdHByb2Nlc3MuZW52LlNFUlZFUl9EQVRBX0ZJTEVfUEFUSF80XG5cdFx0XTtcblxuXHRcdGNvbnN0IGRlY3J5cHRlZEZpbGVzOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9ID0ge307XG5cblx0XHRmb3IgKGNvbnN0IFtpbmRleCwgZmlsZVBhdGhdIG9mIGZpbGVQYXRocy5lbnRyaWVzKCkpIHtcblx0XHRcdGlmIChmaWxlUGF0aCkge1xuXHRcdFx0XHRkZWNyeXB0ZWRGaWxlc1tgZmlsZXMke2luZGV4ICsgMX1gXSA9IGV4ZWNTeW5jKFxuXHRcdFx0XHRcdGBzb3BzIC1kIC0tb3V0cHV0LXR5cGUganNvbiAke2ZpbGVQYXRofWBcblx0XHRcdFx0KS50b1N0cmluZygpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0bG9nZ2VyLndhcm4oXG5cdFx0XHRcdFx0YFNFUlZFUl9EQVRBX0ZJTEVfUEFUSF8ke2luZGV4ICsgMX0gaXMgbm90IGRlZmluZWRgXG5cdFx0XHRcdCk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGRlY3J5cHRlZEZpbGVzO1xuXHR9IGNhdGNoIChlcnIpIHtcblx0XHRsb2dnZXIuZXJyb3IoXG5cdFx0XHRgRXJyb3IgZGVjcnlwdGluZyBkYXRhIGZpbGVzIGZyb20gYmFja2VuZCBkYXRhIGZvbGRlcjogJHtlcnJ9YFxuXHRcdCk7XG5cdFx0dGhyb3cgZXJyO1xuXHR9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFNTTEtleXMoXG5cdGRlcGVuZGVuY2llczogU29wc0RlcGVuZGVuY2llc1xuKTogUHJvbWlzZTx7IGtleTogc3RyaW5nOyBjZXJ0OiBzdHJpbmcgfT4ge1xuXHRjb25zdCB7IGxvZ2dlciwgZXhlY1N5bmMsIGdldERpcmVjdG9yeVBhdGggfSA9IGRlcGVuZGVuY2llcztcblx0dHJ5IHtcblx0XHRjb25zdCBrZXlQYXRoID0gcGF0aC5qb2luKFxuXHRcdFx0Z2V0RGlyZWN0b3J5UGF0aCgpLFxuXHRcdFx0Jy4va2V5cy9zc2wvZ3Vlc3Rib29rX2tleS5wZW0uZ3BnJ1xuXHRcdCk7XG5cdFx0Y29uc3QgY2VydFBhdGggPSBwYXRoLmpvaW4oXG5cdFx0XHRnZXREaXJlY3RvcnlQYXRoKCksXG5cdFx0XHQnLi9rZXlzL3NzbC9ndWVzdGJvb2tfY2VydC5wZW0uZ3BnJ1xuXHRcdCk7XG5cdFx0Y29uc3QgZGVjcnlwdGVkS2V5ID0gYXdhaXQgZGVjcnlwdEtleSh7IGxvZ2dlciwgZXhlY1N5bmMgfSwga2V5UGF0aCk7XG5cdFx0Y29uc3QgZGVjcnlwdGVkQ2VydCA9IGF3YWl0IGRlY3J5cHRLZXkoeyBsb2dnZXIsIGV4ZWNTeW5jIH0sIGNlcnRQYXRoKTtcblxuXHRcdHJldHVybiB7XG5cdFx0XHRrZXk6IGRlY3J5cHRlZEtleSxcblx0XHRcdGNlcnQ6IGRlY3J5cHRlZENlcnRcblx0XHR9O1xuXHR9IGNhdGNoIChlcnIpIHtcblx0XHRsb2dnZXIuZXJyb3IoXG5cdFx0XHRgRXJyb3IgZGVjcnlwdGluZyBTU0wga2V5cyBmcm9tIGJhY2tlbmQga2V5cyBmb2xkZXI6ICR7ZXJyfWBcblx0XHQpO1xuXHRcdHRocm93IGVycjtcblx0fVxufVxuXG5leHBvcnQgZGVmYXVsdCB7IGdldFNlY3JldHMsIGRlY3J5cHRLZXksIGRlY3J5cHREYXRhRmlsZXMsIGdldFNTTEtleXMgfTtcbiJdfQ==
