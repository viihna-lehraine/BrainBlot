import path from 'path';
async function getSecrets({ logger, execSync, getDirectoryPath }) {
	try {
		const secretsPath = path.join(
			getDirectoryPath(),
			'./config/secrets.json.gpg'
		);
		logger.info(`Resolved secrets path: ${secretsPath}`);
		const decryptedSecrets = execSync(
			`sops -d --output-type json ${secretsPath}`
		).toString();
		return JSON.parse(decryptedSecrets);
	} catch (err) {
		logger.info(`Error retrieving secrets from SOPS: ${err}`);
		throw err;
	}
}
async function decryptKey({ logger, execSync }, encryptedFilePath) {
	try {
		const decryptedKey = execSync(
			`sops -d --output-type string ${encryptedFilePath}`
		).toString('utf-8');
		return decryptedKey;
	} catch (err) {
		logger.error(`Error decrypting key: ${err}`);
		throw err;
	}
}
async function decryptDataFiles({ logger, execSync }) {
	try {
		const filePaths = [
			process.env.SERVER_DATA_FILE_PATH_1,
			process.env.SERVER_DATA_FILE_PATH_2,
			process.env.SERVER_DATA_FILE_PATH_3,
			process.env.SERVER_DATA_FILE_PATH_4
		];
		const decryptedFiles = {};
		for (const [index, filePath] of filePaths.entries()) {
			if (filePath) {
				decryptedFiles[`files${index + 1}`] = execSync(
					`sops -d --output-type json ${filePath}`
				).toString();
			} else {
				logger.warn(
					`SERVER_DATA_FILE_PATH_${index + 1} is not defined`
				);
			}
		}
		return decryptedFiles;
	} catch (err) {
		logger.error(
			`Error decrypting data files from backend data folder: ${err}`
		);
		throw err;
	}
}
async function getSSLKeys(dependencies) {
	const { logger, execSync, getDirectoryPath } = dependencies;
	try {
		const keyPath = path.join(
			getDirectoryPath(),
			'./keys/ssl/guestbook_key.pem.gpg'
		);
		const certPath = path.join(
			getDirectoryPath(),
			'./keys/ssl/guestbook_cert.pem.gpg'
		);
		const decryptedKey = await decryptKey({ logger, execSync }, keyPath);
		const decryptedCert = await decryptKey({ logger, execSync }, certPath);
		return {
			key: decryptedKey,
			cert: decryptedCert
		};
	} catch (err) {
		logger.error(
			`Error decrypting SSL keys from backend keys folder: ${err}`
		);
		throw err;
	}
}
export default { getSecrets, decryptKey, decryptDataFiles, getSSLKeys };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29wcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9zb3BzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQTJDeEIsS0FBSyxVQUFVLFVBQVUsQ0FBQyxFQUN6QixNQUFNLEVBQ04sUUFBUSxFQUNSLGdCQUFnQixFQUNFO0lBQ2xCLElBQUksQ0FBQztRQUNKLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQzVCLGdCQUFnQixFQUFFLEVBQ2xCLDJCQUEyQixDQUMzQixDQUFDO1FBQ0YsTUFBTSxDQUFDLElBQUksQ0FBQywwQkFBMEIsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUNyRCxNQUFNLGdCQUFnQixHQUFHLFFBQVEsQ0FDaEMsOEJBQThCLFdBQVcsRUFBRSxDQUMzQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2IsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDckMsQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDZCxNQUFNLENBQUMsSUFBSSxDQUFDLHVDQUF1QyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQzFELE1BQU0sR0FBRyxDQUFDO0lBQ1gsQ0FBQztBQUNGLENBQUM7QUFFRCxLQUFLLFVBQVUsVUFBVSxDQUN4QixFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQWlELEVBQ25FLGlCQUF5QjtJQUV6QixJQUFJLENBQUM7UUFDSixNQUFNLFlBQVksR0FBRyxRQUFRLENBQzVCLGdDQUFnQyxpQkFBaUIsRUFBRSxDQUNuRCxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNwQixPQUFPLFlBQVksQ0FBQztJQUNyQixDQUFDO0lBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNkLE1BQU0sQ0FBQyxLQUFLLENBQUMseUJBQXlCLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFDN0MsTUFBTSxHQUFHLENBQUM7SUFDWCxDQUFDO0FBQ0YsQ0FBQztBQUVELEtBQUssVUFBVSxnQkFBZ0IsQ0FBQyxFQUMvQixNQUFNLEVBQ04sUUFBUSxFQUN1QztJQUcvQyxJQUFJLENBQUM7UUFDSixNQUFNLFNBQVMsR0FBRztZQUNqQixPQUFPLENBQUMsR0FBRyxDQUFDLHVCQUF1QjtZQUNuQyxPQUFPLENBQUMsR0FBRyxDQUFDLHVCQUF1QjtZQUNuQyxPQUFPLENBQUMsR0FBRyxDQUFDLHVCQUF1QjtZQUNuQyxPQUFPLENBQUMsR0FBRyxDQUFDLHVCQUF1QjtTQUNuQyxDQUFDO1FBRUYsTUFBTSxjQUFjLEdBQThCLEVBQUUsQ0FBQztRQUVyRCxLQUFLLE1BQU0sQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLElBQUksU0FBUyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUM7WUFDckQsSUFBSSxRQUFRLEVBQUUsQ0FBQztnQkFDZCxjQUFjLENBQUMsUUFBUSxLQUFLLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxRQUFRLENBQzdDLDhCQUE4QixRQUFRLEVBQUUsQ0FDeEMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNkLENBQUM7aUJBQU0sQ0FBQztnQkFDUCxNQUFNLENBQUMsSUFBSSxDQUNWLHlCQUF5QixLQUFLLEdBQUcsQ0FBQyxpQkFBaUIsQ0FDbkQsQ0FBQztZQUNILENBQUM7UUFDRixDQUFDO1FBRUQsT0FBTyxjQUFjLENBQUM7SUFDdkIsQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDZCxNQUFNLENBQUMsS0FBSyxDQUNYLHlEQUF5RCxHQUFHLEVBQUUsQ0FDOUQsQ0FBQztRQUNGLE1BQU0sR0FBRyxDQUFDO0lBQ1gsQ0FBQztBQUNGLENBQUM7QUFFRCxLQUFLLFVBQVUsVUFBVSxDQUN4QixZQUE4QjtJQUU5QixNQUFNLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxnQkFBZ0IsRUFBRSxHQUFHLFlBQVksQ0FBQztJQUM1RCxJQUFJLENBQUM7UUFDSixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUN4QixnQkFBZ0IsRUFBRSxFQUNsQixrQ0FBa0MsQ0FDbEMsQ0FBQztRQUNGLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQ3pCLGdCQUFnQixFQUFFLEVBQ2xCLG1DQUFtQyxDQUNuQyxDQUFDO1FBQ0YsTUFBTSxZQUFZLEdBQUcsTUFBTSxVQUFVLENBQUMsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDckUsTUFBTSxhQUFhLEdBQUcsTUFBTSxVQUFVLENBQUMsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFdkUsT0FBTztZQUNOLEdBQUcsRUFBRSxZQUFZO1lBQ2pCLElBQUksRUFBRSxhQUFhO1NBQ25CLENBQUM7SUFDSCxDQUFDO0lBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNkLE1BQU0sQ0FBQyxLQUFLLENBQ1gsdURBQXVELEdBQUcsRUFBRSxDQUM1RCxDQUFDO1FBQ0YsTUFBTSxHQUFHLENBQUM7SUFDWCxDQUFDO0FBQ0YsQ0FBQztBQUVELGVBQWUsRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLGdCQUFnQixFQUFFLFVBQVUsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXhlY1N5bmMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbnRlcmZhY2UgU29wc0RlcGVuZGVuY2llcyB7XG5cdGxvZ2dlcjogUmV0dXJuVHlwZTx0eXBlb2YgaW1wb3J0KCcuLi9jb25maWcvbG9nZ2VyJykuZGVmYXVsdD47XG5cdGV4ZWNTeW5jOiB0eXBlb2YgZXhlY1N5bmM7XG5cdGdldERpcmVjdG9yeVBhdGg6ICgpID0+IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIFNlY3JldHMge1xuXHRba2V5OiBzdHJpbmddOiBzdHJpbmcgfCBudW1iZXIgfCBib29sZWFuIHwgc3RyaW5nW10gfCBudW1iZXJbXSB8IGJvb2xlYW5bXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTZWNyZXRzTWFwIGV4dGVuZHMgU2VjcmV0cyB7XG5cdEFQUF9TU0xfS0VZOiBzdHJpbmc7XG5cdEFQUF9TU0xfQ0VSVDogc3RyaW5nO1xuXHREQl9TU0xfS0VZOiBzdHJpbmc7XG5cdERCX1NTTF9DRVJUOiBzdHJpbmc7XG5cdERCX05BTUU6IHN0cmluZztcblx0REJfVVNFUjogc3RyaW5nO1xuXHREQl9QQVNTV09SRDogc3RyaW5nO1xuXHREQl9IT1NUOiBzdHJpbmc7XG5cdERCX0RJQUxFQ1Q6ICdteXNxbCcgfCAncG9zdGdyZXMnIHwgJ3NxbGl0ZScgfCAnbWFyaWFkYicgfCAnbXNzcWwnO1xuXHRFTUFJTF8yRkFfS0VZOiBzdHJpbmc7XG5cdEVNQUlMX0hPU1Q6IHN0cmluZztcblx0RU1BSUxfUE9SVDogbnVtYmVyO1xuXHRFTUFJTF9TRUNVUkU6IGJvb2xlYW47XG5cdEZJRE9fQVVUSEVOVElDQVRPUl9SRVFVSVJFX1JFU0lERU5UX0tFWTogYm9vbGVhbjtcblx0RklET19BVVRIRU5USUNBVE9SX1VTRVJfVkVSSUZJQ0FUSU9OOlxuXHRcdHwgJ3JlcXVpcmVkJ1xuXHRcdHwgJ3ByZWZlcnJlZCdcblx0XHR8ICdkaXNjb3VyYWdlZCc7XG5cdEZJRE9fQ0hBTExFTkdFX1NJWkU6IG51bWJlcjtcblx0RklET19DUllQVE9fUEFSQU1FVEVSUzogbnVtYmVyW107XG5cdEpXVF9TRUNSRVQ6IHN0cmluZztcblx0UEVQUEVSOiBzdHJpbmc7XG5cdFJQX0lEOiBzdHJpbmc7XG5cdFJQX05BTUU6IHN0cmluZztcblx0UlBfSUNPTjogc3RyaW5nO1xuXHRTTVRQX1RPS0VOOiBzdHJpbmc7XG5cdFlVQklDT19DTElFTlRfSUQ6IG51bWJlcjtcblx0WVVCSUNPX1NFQ1JFVF9LRVk6IHN0cmluZztcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0U2VjcmV0cyh7XG5cdGxvZ2dlcixcblx0ZXhlY1N5bmMsXG5cdGdldERpcmVjdG9yeVBhdGhcbn06IFNvcHNEZXBlbmRlbmNpZXMpOiBQcm9taXNlPFNlY3JldHNNYXA+IHtcblx0dHJ5IHtcblx0XHRjb25zdCBzZWNyZXRzUGF0aCA9IHBhdGguam9pbihcblx0XHRcdGdldERpcmVjdG9yeVBhdGgoKSxcblx0XHRcdCcuL2NvbmZpZy9zZWNyZXRzLmpzb24uZ3BnJ1xuXHRcdCk7XG5cdFx0bG9nZ2VyLmluZm8oYFJlc29sdmVkIHNlY3JldHMgcGF0aDogJHtzZWNyZXRzUGF0aH1gKTtcblx0XHRjb25zdCBkZWNyeXB0ZWRTZWNyZXRzID0gZXhlY1N5bmMoXG5cdFx0XHRgc29wcyAtZCAtLW91dHB1dC10eXBlIGpzb24gJHtzZWNyZXRzUGF0aH1gXG5cdFx0KS50b1N0cmluZygpO1xuXHRcdHJldHVybiBKU09OLnBhcnNlKGRlY3J5cHRlZFNlY3JldHMpO1xuXHR9IGNhdGNoIChlcnIpIHtcblx0XHRsb2dnZXIuaW5mbyhgRXJyb3IgcmV0cmlldmluZyBzZWNyZXRzIGZyb20gU09QUzogJHtlcnJ9YCk7XG5cdFx0dGhyb3cgZXJyO1xuXHR9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRlY3J5cHRLZXkoXG5cdHsgbG9nZ2VyLCBleGVjU3luYyB9OiBQaWNrPFNvcHNEZXBlbmRlbmNpZXMsICdsb2dnZXInIHwgJ2V4ZWNTeW5jJz4sXG5cdGVuY3J5cHRlZEZpbGVQYXRoOiBzdHJpbmdcbik6IFByb21pc2U8c3RyaW5nPiB7XG5cdHRyeSB7XG5cdFx0Y29uc3QgZGVjcnlwdGVkS2V5ID0gZXhlY1N5bmMoXG5cdFx0XHRgc29wcyAtZCAtLW91dHB1dC10eXBlIHN0cmluZyAke2VuY3J5cHRlZEZpbGVQYXRofWBcblx0XHQpLnRvU3RyaW5nKCd1dGYtOCcpO1xuXHRcdHJldHVybiBkZWNyeXB0ZWRLZXk7XG5cdH0gY2F0Y2ggKGVycikge1xuXHRcdGxvZ2dlci5lcnJvcihgRXJyb3IgZGVjcnlwdGluZyBrZXk6ICR7ZXJyfWApO1xuXHRcdHRocm93IGVycjtcblx0fVxufVxuXG5hc3luYyBmdW5jdGlvbiBkZWNyeXB0RGF0YUZpbGVzKHtcblx0bG9nZ2VyLFxuXHRleGVjU3luY1xufTogUGljazxTb3BzRGVwZW5kZW5jaWVzLCAnbG9nZ2VyJyB8ICdleGVjU3luYyc+KTogUHJvbWlzZTx7XG5cdFtrZXk6IHN0cmluZ106IHN0cmluZztcbn0+IHtcblx0dHJ5IHtcblx0XHRjb25zdCBmaWxlUGF0aHMgPSBbXG5cdFx0XHRwcm9jZXNzLmVudi5TRVJWRVJfREFUQV9GSUxFX1BBVEhfMSxcblx0XHRcdHByb2Nlc3MuZW52LlNFUlZFUl9EQVRBX0ZJTEVfUEFUSF8yLFxuXHRcdFx0cHJvY2Vzcy5lbnYuU0VSVkVSX0RBVEFfRklMRV9QQVRIXzMsXG5cdFx0XHRwcm9jZXNzLmVudi5TRVJWRVJfREFUQV9GSUxFX1BBVEhfNFxuXHRcdF07XG5cblx0XHRjb25zdCBkZWNyeXB0ZWRGaWxlczogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xuXG5cdFx0Zm9yIChjb25zdCBbaW5kZXgsIGZpbGVQYXRoXSBvZiBmaWxlUGF0aHMuZW50cmllcygpKSB7XG5cdFx0XHRpZiAoZmlsZVBhdGgpIHtcblx0XHRcdFx0ZGVjcnlwdGVkRmlsZXNbYGZpbGVzJHtpbmRleCArIDF9YF0gPSBleGVjU3luYyhcblx0XHRcdFx0XHRgc29wcyAtZCAtLW91dHB1dC10eXBlIGpzb24gJHtmaWxlUGF0aH1gXG5cdFx0XHRcdCkudG9TdHJpbmcoKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGxvZ2dlci53YXJuKFxuXHRcdFx0XHRcdGBTRVJWRVJfREFUQV9GSUxFX1BBVEhfJHtpbmRleCArIDF9IGlzIG5vdCBkZWZpbmVkYFxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiBkZWNyeXB0ZWRGaWxlcztcblx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0bG9nZ2VyLmVycm9yKFxuXHRcdFx0YEVycm9yIGRlY3J5cHRpbmcgZGF0YSBmaWxlcyBmcm9tIGJhY2tlbmQgZGF0YSBmb2xkZXI6ICR7ZXJyfWBcblx0XHQpO1xuXHRcdHRocm93IGVycjtcblx0fVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRTU0xLZXlzKFxuXHRkZXBlbmRlbmNpZXM6IFNvcHNEZXBlbmRlbmNpZXNcbik6IFByb21pc2U8eyBrZXk6IHN0cmluZzsgY2VydDogc3RyaW5nIH0+IHtcblx0Y29uc3QgeyBsb2dnZXIsIGV4ZWNTeW5jLCBnZXREaXJlY3RvcnlQYXRoIH0gPSBkZXBlbmRlbmNpZXM7XG5cdHRyeSB7XG5cdFx0Y29uc3Qga2V5UGF0aCA9IHBhdGguam9pbihcblx0XHRcdGdldERpcmVjdG9yeVBhdGgoKSxcblx0XHRcdCcuL2tleXMvc3NsL2d1ZXN0Ym9va19rZXkucGVtLmdwZydcblx0XHQpO1xuXHRcdGNvbnN0IGNlcnRQYXRoID0gcGF0aC5qb2luKFxuXHRcdFx0Z2V0RGlyZWN0b3J5UGF0aCgpLFxuXHRcdFx0Jy4va2V5cy9zc2wvZ3Vlc3Rib29rX2NlcnQucGVtLmdwZydcblx0XHQpO1xuXHRcdGNvbnN0IGRlY3J5cHRlZEtleSA9IGF3YWl0IGRlY3J5cHRLZXkoeyBsb2dnZXIsIGV4ZWNTeW5jIH0sIGtleVBhdGgpO1xuXHRcdGNvbnN0IGRlY3J5cHRlZENlcnQgPSBhd2FpdCBkZWNyeXB0S2V5KHsgbG9nZ2VyLCBleGVjU3luYyB9LCBjZXJ0UGF0aCk7XG5cblx0XHRyZXR1cm4ge1xuXHRcdFx0a2V5OiBkZWNyeXB0ZWRLZXksXG5cdFx0XHRjZXJ0OiBkZWNyeXB0ZWRDZXJ0XG5cdFx0fTtcblx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0bG9nZ2VyLmVycm9yKFxuXHRcdFx0YEVycm9yIGRlY3J5cHRpbmcgU1NMIGtleXMgZnJvbSBiYWNrZW5kIGtleXMgZm9sZGVyOiAke2Vycn1gXG5cdFx0KTtcblx0XHR0aHJvdyBlcnI7XG5cdH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgeyBnZXRTZWNyZXRzLCBkZWNyeXB0S2V5LCBkZWNyeXB0RGF0YUZpbGVzLCBnZXRTU0xLZXlzIH07XG4iXX0=
