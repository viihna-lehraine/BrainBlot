import cron from 'node-cron';
import fs from 'fs';
import path from 'path';
import compressing from 'compressing';
import { exec } from 'child_process';
import { __dirname } from '../index.js';
import setupLogger from '../config/logger.js';
const logger = await setupLogger();
const compressAndExportLogs = async (sourceDir, exportDir, logFileName) => {
	const timestamp = new Date().toISOString().replace(/:/g, '-');
	const outputFileName = `${logFileName.replace('.log', '')}-${timestamp}.gz`;
	const outputFilePath = path.join(exportDir, outputFileName);
	const sourceFilePath = path.join(sourceDir, logFileName);
	try {
		await compressing.gzip.compressFile(sourceFilePath, outputFilePath);
		logger.info(`${logFileName} successfully compressed`);
		return outputFilePath;
	} catch (err) {
		const error = err;
		logger.error(`Unable to compress ${logFileName}: ${error.message}`);
		throw new Error(`Error compessing log files: ${error.message}`);
	}
};
const runCommandAndLog = (command, logFilePath) => {
	return new Promise((resolve, reject) => {
		const logStream = fs.createWriteStream(logFilePath, { flags: 'a' });
		const process = exec(
			command,
			{ maxBuffer: 1024 * 500 },
			(error, stdout, stderr) => {
				if (error) {
					logStream.write(`ERROR: ${error.message}\n`);
					return reject(error);
				}
				if (stderr) {
					logStream.write(`STDERR: ${stderr}\n`);
				}
				logStream.write(stdout);
				logStream.end();
				resolve();
			}
		);
		process.stdout.pipe(logStream);
		process.stderr.pipe(logStream);
	});
};
const exportLogs = async () => {
	const serverLogDir = path.join(__dirname, process.env.SERVER_LOG_PATH);
	const npmLogDir = path.join(__dirname, process.env.SERVER_NPM_LOG_PATH);
	const exportDir = path.join(
		__dirname,
		process.env.BACKEND_LOGGER_EXPORT_PATH
	);
	// Ensure the export directory exists
	if (!fs.existsSync(exportDir)) {
		fs.mkdirSync(exportDir, { recursive: true });
	}
	try {
		// compress and export server logs
		const serverLogFiles = fs
			.readdirSync(serverLogDir)
			.filter(file => file.endsWith('.log'));
		for (const logFile of serverLogFiles) {
			await compressAndExportLogs(serverLogDir, exportDir, logFile);
		}
		// Compress and export npm logs
		const npmLogFiles = fs
			.readdirSync(npmLogDir)
			.filter(file => file.endsWith('.logs'));
		for (const logFile of npmLogFiles) {
			await compressAndExportLogs(npmLogDir, exportDir, logFile);
		}
		logger.info('Logs have been successfully compresseed and exported.');
	} catch (err) {
		const error = err;
		logger.error(`Error exporting logs: ${error.message}`);
	}
};
// Perform hourly npm audit and update
const performNpmTasks = async () => {
	const npmLogDir = path.join(__dirname, process.env.SERVER_NPM_LOG_PATH);
	const timestamp = new Date().toISOString().replace(/:/g, '-');
	const logFilePath = path.join(
		npmLogDir,
		`npm-audit-update-${timestamp}.log`
	);
	try {
		logger.info('Starting npm audit...');
		await runCommandAndLog('npm audit --verbose', logFilePath);
		logger.info('npm audit completed successfully.');
		logger.info('Starting npm update...');
		await runCommandAndLog('npm update --verbose', logFilePath);
		logger.info('npm update completed successfully.');
	} catch (err) {
		const error = err;
		logger.error(`Error during npm tasks: ${error.message}`);
	}
};
// Determine the cron schedule based on LOGGER environment
const scheduleLogJobs = async () => {
	let schedule = '';
	switch (process.env.LOGGER) {
		case '0':
			break;
		case '1':
			schedule = '*/2 * * * *';
			exportLogs();
			break;
		case '2':
			schedule = '0 */2 * * *';
			break;
		case '3':
			schedule = '0 */6 * * *';
			break;
		case '4':
			schedule = '0 */12 * * *';
			break;
		case '5':
			schedule = '0 0 * * *';
			break;
		case '6':
			schedule = '0 0 */2 * *';
			break;
		case '7':
			schedule = '0 0 * * 0';
			break;
		default:
			schedule = '0 0 * * *';
			logger.warn(
				'LOGGER variable not set. Defaulting to nightly log export'
			);
	}
	cron.schedule(schedule, exportLogs);
	cron.schedule('0 * * * *', performNpmTasks);
};
scheduleLogJobs();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9jcm9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sSUFBSSxNQUFNLFdBQVcsQ0FBQztBQUM3QixPQUFPLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDcEIsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQ3hCLE9BQU8sV0FBVyxNQUFNLGFBQWEsQ0FBQztBQUN0QyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDckMsT0FBTyxXQUFXLE1BQU0sa0JBQWtCLENBQUM7QUFFM0MsTUFBTSxNQUFNLEdBQUcsTUFBTSxXQUFXLEVBQUUsQ0FBQztBQUVuQyxNQUFNLHFCQUFxQixHQUFHLEtBQUssRUFDbEMsU0FBaUIsRUFDakIsU0FBaUIsRUFDakIsV0FBbUIsRUFDRCxFQUFFO0lBQ3BCLE1BQU0sU0FBUyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUM5RCxNQUFNLGNBQWMsR0FBRyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxJQUFJLFNBQVMsS0FBSyxDQUFDO0lBQzVFLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLGNBQWMsQ0FBQyxDQUFDO0lBQzVELE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBRXpELElBQUksQ0FBQztRQUNKLE1BQU0sV0FBVyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsY0FBYyxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQ3BFLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxXQUFXLDBCQUEwQixDQUFDLENB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QUFFLFVBQVUsQ0FBQyxDQUFDO0lBQ3BDLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLGVBQWUsQ0FBQyxDQUFDO0FBQzdDLENBQUMsQ0FBQztBQUVGLGVBQWUsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNyb24gZnJvbSAnbm9kZS1jcm9uJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBjb21wcmVzc2luZyBmcm9tICdjb21wcmVzc2luZyc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgeyBfX2Rpcm5hbWUgfSBmcm9tICcuLi9pbmRleCc7XG5pbXBvcnQgc2V0dXBMb2dnZXIgZnJvbSAnLi4vY29uZmlnL2xvZ2dlcic7XG5cbmNvbnN0IGxvZ2dlciA9IGF3YWl0IHNldHVwTG9nZ2VyKCk7XG5cbmNvbnN0IGNvbXByZXNzQW5kRXhwb3J0TG9ncyA9IGFzeW5jIChcblx0c291cmNlRGlyOiBzdHJpbmcsXG5cdGV4cG9ydERpcjogc3RyaW5nLFxuXHRsb2dGaWxlTmFtZTogc3RyaW5nXG4pOiBQcm9taXNlPHN0cmluZz4gPT4ge1xuXHRjb25zdCB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkucmVwbGFjZSgvOi9nLCAnLScpO1xuXHRjb25zdCBvdXRwdXRGaWxlTmFtZSA9IGAke2xvZ0ZpbGVOYW1lLnJlcGxhY2UoJy5sb2cnLCAnJyl9LSR7dGltZXN0YW1wfS5nemA7XG5cdGNvbnN0IG91dHB1dEZpbGVQYXRoID0gcGF0aC5qb2luKGV4cG9ydERpciwgb3V0cHV0RmlsZU5hbWUpO1xuXHRjb25zdCBzb3VyY2VGaWxlUGF0aCA9IHBhdGguam9pbihzb3VyY2VEaXIsIGxvZ0ZpbGVOYW1lKTtcblxuXHR0cnkge1xuXHRcdGF3YWl0IGNvbXByZXNzaW5nLmd6aXAuY29tcHJlc3NGaWxlKHNvdXJjZUZpbGVQYXRoLCBvdXRwdXRGaWxlUGF0aCk7XG5cdFx0bG9nZ2VyLmluZm8oYCR7bG9nRmlsZU5hbWV9IHN1Y2Nlc3NmdWxseSBjb21wcmVzc2VkYCk7XG5cdFx0cmV0dXJuIG91dHB1dEZpbGVQYXRoO1xuXHR9IGNhdGNoIChlcnIpIHtcblx0XHRjb25zdCBlcnJvciA9IGVyciBhcyBFcnJvcjtcblx0XHRsb2dnZXIuZXJyb3IoYFVuYWJsZSB0byBjb21wcmVzcyAke2xvZ0ZpbGVOYW1lfTogJHtlcnJvci5tZXNzYWdlfWApO1xuXHRcdHRocm93IG5ldyBFcnJvcihgRXJyb3IgY29tcGVzc2luZyBsb2cgZmlsZXM6ICR7ZXJyb3IubWVzc2FnZX1gKTtcblx0fVxufTtcblxuY29uc3QgcnVuQ29tbWFuZEFuZExvZyA9IChcblx0Y29tbWFuZDogc3RyaW5nLFxuXHRsb2dGaWxlUGF0aDogc3RyaW5nXG4pOiBQcm9taXNlPHZvaWQ+ID0+IHtcblx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRjb25zdCBsb2dTdHJlYW0gPSBmcy5jcmVhdGVXcml0ZVN0cmVhbShsb2dGaWxlUGF0aCwgeyBmbGFnczogJ2EnIH0pO1xuXHRcdGNvbnN0IHByb2Nlc3MgPSBleGVjKFxuXHRcdFx0Y29tbWFuZCxcblx0XHRcdHsgbWF4QnVmZmVyOiAxMDI0ICogNTAwIH0sXG5cdFx0XHQoZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSA9PiB7XG5cdFx0XHRcdGlmIChlcnJvcikge1xuXHRcdFx0XHRcdGxvZ1N0cmVhbS53cml0ZShgRVJST1I6ICR7ZXJyb3IubWVzc2FnZX1cXG5gKTtcblx0XHRcdFx0XHRyZXR1cm4gcmVqZWN0KGVycm9yKTtcblx0XHRcdFx0fVxuXHRcdFx0XHRpZiAoc3RkZXJyKSB7XG5cdFx0XHRcdFx0bG9nU3RyZWFtLndyaXRlKGBTVERFUlI6ICR7c3RkZXJyfVxcbmApO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGxvZ1N0cmVhbS53cml0ZShzdGRvdXQpO1xuXHRcdFx0XHRsb2dTdHJlYW0uZW5kKCk7XG5cdFx0XHRcdHJlc29sdmUoKTtcblx0XHRcdH1cblx0XHQpO1xuXG5cdFx0cHJvY2Vzcy5zdGRvdXQhLnBpcGUobG9nU3RyZWFtKTtcblx0XHRwcm9jZXNzLnN0ZGVyciEucGlwZShsb2dTdHJlYW0pO1xuXHR9KTtcbn07XG5cbmNvbnN0IGV4cG9ydExvZ3MgPSBhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XG5cdGNvbnN0IHNlcnZlckxvZ0RpciA9IHBhdGguam9pbihfX2Rpcm5hbWUsIHByb2Nlc3MuZW52LlNFUlZFUl9MT0dfUEFUSCEpO1xuXHRjb25zdCBucG1Mb2dEaXIgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCBwcm9jZXNzLmVudi5TRVJWRVJfTlBNX0xPR19QQVRIISk7XG5cdGNvbnN0IGV4cG9ydERpciA9IHBhdGguam9pbihcblx0XHRfX2Rpcm5hbWUsXG5cdFx0cHJvY2Vzcy5lbnYuQkFDS0VORF9MT0dHRVJfRVhQT1JUX1BBVEghXG5cdCk7XG5cblx0Ly8gRW5zdXJlIHRoZSBleHBvcnQgZGlyZWN0b3J5IGV4aXN0c1xuXHRpZiAoIWZzLmV4aXN0c1N5bmMoZXhwb3J0RGlyKSkge1xuXHRcdGZzLm1rZGlyU3luYyhleHBvcnREaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuXHR9XG5cblx0dHJ5IHtcblx0XHQvLyBjb21wcmVzcyBhbmQgZXhwb3J0IHNlcnZlciBsb2dzXG5cdFx0Y29uc3Qgc2VydmVyTG9nRmlsZXMgPSBmc1xuXHRcdFx0LnJlYWRkaXJTeW5jKHNlcnZlckxvZ0Rpcilcblx0XHRcdC5maWx0ZXIoZmlsZSA9PiBmaWxlLmVuZHNXaXRoKCcubG9nJykpO1xuXHRcdGZvciAoY29uc3QgbG9nRmlsZSBvZiBzZXJ2ZXJMb2dGaWxlcykge1xuXHRcdFx0YXdhaXQgY29tcHJlc3NBbmRFeHBvcnRMb2dzKHNlcnZlckxvZ0RpciwgZXhwb3J0RGlyLCBsb2dGaWxlKTtcblx0XHR9XG5cblx0XHQvLyBDb21wcmVzcyBhbmQgZXhwb3J0IG5wbSBsb2dzXG5cdFx0Y29uc3QgbnBtTG9nRmlsZXMgPSBmc1xuXHRcdFx0LnJlYWRkaXJTeW5jKG5wbUxvZ0Rpcilcblx0XHRcdC5maWx0ZXIoZmlsZSA9PiBmaWxlLmVuZHNXaXRoKCcubG9ncycpKTtcblx0XHRmb3IgKGNvbnN0IGxvZ0ZpbGUgb2YgbnBtTG9nRmlsZXMpIHtcblx0XHRcdGF3YWl0IGNvbXByZXNzQW5kRXhwb3J0TG9ncyhucG1Mb2dEaXIsIGV4cG9ydERpciwgbG9nRmlsZSk7XG5cdFx0fVxuXG5cdFx0bG9nZ2VyLmluZm8oJ0xvZ3MgaGF2ZSBiZWVuIHN1Y2Nlc3NmdWxseSBjb21wcmVzc2VlZCBhbmQgZXhwb3J0ZWQuJyk7XG5cdH0gY2F0Y2ggKGVycikge1xuXHRcdGNvbnN0IGVycm9yID0gZXJyIGFzIEVycm9yO1xuXHRcdGxvZ2dlci5lcnJvcihgRXJyb3IgZXhwb3J0aW5nIGxvZ3M6ICR7ZXJyb3IubWVzc2FnZX1gKTtcblx0fVxufTtcblxuLy8gUGVyZm9ybSBob3VybHkgbnBtIGF1ZGl0IGFuZCB1cGRhdGVcbmNvbnN0IHBlcmZvcm1OcG1UYXNrcyA9IGFzeW5jICgpOiBQcm9taXNlPHZvaWQ+ID0+IHtcblx0Y29uc3QgbnBtTG9nRGlyID0gcGF0aC5qb2luKF9fZGlybmFtZSwgcHJvY2Vzcy5lbnYuU0VSVkVSX05QTV9MT0dfUEFUSCEpO1xuXHRjb25zdCB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkucmVwbGFjZSgvOi9nLCAnLScpO1xuXHRjb25zdCBsb2dGaWxlUGF0aCA9IHBhdGguam9pbihcblx0XHRucG1Mb2dEaXIsXG5cdFx0YG5wbS1hdWRpdC11cGRhdGUtJHt0aW1lc3RhbXB9LmxvZ2Bcblx0KTtcblxuXHR0cnkge1xuXHRcdGxvZ2dlci5pbmZvKCdTdGFydGluZyBucG0gYXVkaXQuLi4nKTtcblx0XHRhd2FpdCBydW5Db21tYW5kQW5kTG9nKCducG0gYXVkaXQgLS12ZXJib3NlJywgbG9nRmlsZVBhdGgpO1xuXHRcdGxvZ2dlci5pbmZvKCducG0gYXVkaXQgY29tcGxldGVkIHN1Y2Nlc3NmdWxseS4nKTtcblxuXHRcdGxvZ2dlci5pbmZvKCdTdGFydGluZyBucG0gdXBkYXRlLi4uJyk7XG5cdFx0YXdhaXQgcnVuQ29tbWFuZEFuZExvZygnbnBtIHVwZGF0ZSAtLXZlcmJvc2UnLCBsb2dGaWxlUGF0aCk7XG5cdFx0bG9nZ2VyLmluZm8oJ25wbSB1cGRhdGUgY29tcGxldGVkIHN1Y2Nlc3NmdWxseS4nKTtcblx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0Y29uc3QgZXJyb3IgPSBlcnIgYXMgRXJyb3I7XG5cdFx0bG9nZ2VyLmVycm9yKGBFcnJvciBkdXJpbmcgbnBtIHRhc2tzOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG5cdH1cbn07XG5cbi8vIERldGVybWluZSB0aGUgY3JvbiBzY2hlZHVsZSBiYXNlZCBvbiBMT0dHRVIgZW52aXJvbm1lbnRcbmNvbnN0IHNjaGVkdWxlTG9nSm9icyA9IGFzeW5jICgpOiBQcm9taXNlPHZvaWQ+ID0+IHtcblx0bGV0IHNjaGVkdWxlID0gJyc7XG5cblx0c3dpdGNoIChwcm9jZXNzLmVudi5MT0dHRVIpIHtcblx0XHRjYXNlICcwJzpcblx0XHRcdGJyZWFrO1xuXHRcdGNhc2UgJzEnOlxuXHRcdFx0c2NoZWR1bGUgPSAnKi8yICogKiAqIConO1xuXHRcdFx0ZXhwb3J0TG9ncygpO1xuXHRcdFx0YnJlYWs7XG5cdFx0Y2FzZSAnMic6XG5cdFx0XHRzY2hlZHVsZSA9ICcwICovMiAqICogKic7XG5cdFx0XHRicmVhaztcblx0XHRjYXNlICczJzpcblx0XHRcdHNjaGVkdWxlID0gJzAgKi82ICogKiAqJztcblx0XHRcdGJyZWFrO1xuXHRcdGNhc2UgJzQnOlxuXHRcdFx0c2NoZWR1bGUgPSAnMCAqLzEyICogKiAqJztcblx0XHRcdGJyZWFrO1xuXHRcdGNhc2UgJzUnOlxuXHRcdFx0c2NoZWR1bGUgPSAnMCAwICogKiAqJztcblx0XHRcdGJyZWFrO1xuXHRcdGNhc2UgJzYnOlxuXHRcdFx0c2NoZWR1bGUgPSAnMCAwICovMiAqIConO1xuXHRcdFx0YnJlYWs7XG5cdFx0Y2FzZSAnNyc6XG5cdFx0XHRzY2hlZHVsZSA9ICcwIDAgKiAqIDAnO1xuXHRcdFx0YnJlYWs7XG5cdFx0ZGVmYXVsdDpcblx0XHRcdHNjaGVkdWxlID0gJzAgMCAqICogKic7XG5cdFx0XHRsb2dnZXIud2Fybihcblx0XHRcdFx0J0xPR0dFUiB2YXJpYWJsZSBub3Qgc2V0LiBEZWZhdWx0aW5nIHRvIG5pZ2h0bHkgbG9nIGV4cG9ydCdcblx0XHRcdCk7XG5cdH1cblxuXHRjcm9uLnNjaGVkdWxlKHNjaGVkdWxlLCBleHBvcnRMb2dzKTtcblx0Y3Jvbi5zY2hlZHVsZSgnMCAqICogKiAqJywgcGVyZm9ybU5wbVRhc2tzKTtcbn07XG5cbnNjaGVkdWxlTG9nSm9icygpO1xuIl19
