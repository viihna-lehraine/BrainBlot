import { Fido2Lib } from 'fido2-lib';
import path from 'path';
import sops from '../utils/sops';
import { validateDependencies } from '../utils/validateDependencies';
import { processError } from '../utils/processError';
import { execSync } from 'child_process';
let fido2 = null;
let secrets;
function getDirectoryPath() {
	return path.resolve(process.cwd());
}
async function initializeFido2(logger) {
	try {
		validateDependencies(
			[
				{ name: 'logger', instance: logger },
				{ name: 'execSync', instance: execSync },
				{ name: 'getDirectoryPath', instance: getDirectoryPath }
			],
			logger
		);
		secrets = await sops.getSecrets({
			logger,
			execSync,
			getDirectoryPath
		});
		validateDependencies(
			[
				{ name: 'secrets.RP_ID', instance: secrets.RP_ID },
				{ name: 'secrets.RP_NAME', instance: secrets.RP_NAME },
				{
					name: 'secrets.FIDO_CHALLENGE_SIZE',
					instance: secrets.FIDO_CHALLENGE_SIZE
				}
			],
			logger
		);
		// Initialize Fido2Lib instance
		fido2 = new Fido2Lib({
			timeout: 60000,
			rpId: secrets.RP_ID,
			rpName: secrets.RP_NAME,
			challengeSize: secrets.FIDO_CHALLENGE_SIZE,
			cryptoParams: secrets.FIDO_CRYPTO_PARAMETERS,
			authenticatorRequireResidentKey:
				secrets.FIDO_AUTHENTICATOR_REQUIRE_RESIDENT_KEY,
			authenticatorUserVerification:
				secrets.FIDO_AUTHENTICATOR_USER_VERIFICATION
		});
		logger.info('Fido2Lib initialized successfully.');
	} catch (error) {
		processError(error, logger);
		throw new Error('Failed to initialize Fido2Lib');
	}
}
async function ensureFido2Initialized(logger) {
	validateDependencies([{ name: 'logger', instance: logger }], logger);
	if (!fido2) {
		logger.debug('Fido2Lib is not initialized, initializing now.');
		await initializeFido2(logger);
	}
}
async function generatePasskeyRegistrationOptions(user, logger) {
	try {
		validateDependencies(
			[
				{ name: 'user', instance: user },
				{ name: 'logger', instance: logger }
			],
			logger
		);
		await ensureFido2Initialized(logger);
		const passkeyRegistrationOptions = await fido2.attestationOptions();
		const registrationOptions = {
			...passkeyRegistrationOptions,
			user: {
				id: Buffer.from(user.id, 'utf-8'),
				name: user.email,
				displayName: user.username
			},
			pubKeyCredParams: [{ type: 'public-key', alg: -7 }],
			timeout: 60000,
			attestation: 'direct',
			authenticatorSelection: {
				authenticatorAttachment: 'platform',
				requireResidentKey: true,
				userVerification: 'preferred'
			}
		};
		logger.info('Passkey registration options generated successfully.');
		return registrationOptions;
	} catch (error) {
		processError(error, logger);
		throw new Error('Failed to generate passkey registration options');
	}
}
async function verifyPasskeyRegistration(
	attestation,
	expectedChallenge,
	logger
) {
	try {
		validateDependencies(
			[
				{ name: 'attestation', instance: attestation },
				{ name: 'expectedChallenge', instance: expectedChallenge },
				{ name: 'logger', instance: logger }
			],
			logger
		);
		await ensureFido2Initialized(logger);
		const u2fAttestationExpectations = {
			challenge: expectedChallenge,
			origin: secrets.RP_ORIGIN,
			factor: 'either',
			rpId: secrets.RP_ID
		};
		const result = await fido2.attestationResult(
			attestation,
			u2fAttestationExpectations
		);
		logger.info('Passkey registration verified successfully.');
		return result;
	} catch (error) {
		processError(error, logger);
		throw new Error('Failed to verify passkey registration');
	}
}
async function generatePasskeyAuthenticationOptions(user, logger) {
	try {
		validateDependencies(
			[
				{ name: 'user', instance: user },
				{ name: 'logger', instance: logger }
			],
			logger
		);
		await ensureFido2Initialized(logger);
		const userCredentials = user.credential.map(credential => ({
			type: 'public-key',
			id: Buffer.from(credential.credentialId, 'base64').buffer
		}));
		const assertionOptions = await fido2.assertionOptions();
		const authenticationOptions = {
			...assertionOptions,
			allowCredentials: userCredentials,
			userVerification: 'required', // ensure passwordless login
			timeout: 60000
		};
		logger.info('Passkey authentication options generated successfully.');
		return authenticationOptions;
	} catch (error) {
		processError(error, logger);
		throw new Error('Failed to generate passkey authentication options');
	}
}
async function verifyPasskeyAuthentication(
	assertion,
	expectedChallenge,
	publicKey,
	previousCounter,
	id,
	logger
) {
	try {
		validateDependencies(
			[
				{ name: 'assertion', instance: assertion },
				{ name: 'expectedChallenge', instance: expectedChallenge },
				{ name: 'publicKey', instance: publicKey },
				{ name: 'previousCounter', instance: previousCounter },
				{ name: 'id', instance: id },
				{ name: 'logger', instance: logger }
			],
			logger
		);
		await ensureFido2Initialized(logger);
		const assertionExpectations = {
			challenge: expectedChallenge,
			origin: secrets.RP_ORIGIN,
			factor: 'either',
			publicKey,
			prevCounter: previousCounter,
			userHandle: id
		};
		const result = await fido2.assertionResult(
			assertion,
			assertionExpectations
		);
		logger.info('Passkey authentication verified successfully.');
		return result;
	} catch (error) {
		processError(error, logger);
		throw new Error('Failed to verify passkey authentication');
	}
}
export default {
	generatePasskeyAuthenticationOptions,
	generatePasskeyRegistrationOptions,
	verifyPasskeyAuthentication,
	verifyPasskeyRegistration
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlkbzJVdGlsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2F1dGgvZmlkbzJVdGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFHTixRQUFRLEVBUVIsTUFBTSxXQUFXLENBQUM7QUFDbkIsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQ3hCLE9BQU8sSUFBb0IsTUFBTSxlQUFlLENBQUM7QUFFakQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDckUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3JELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFekMsSUFBSSxLQUFLLEdBQW9CLElBQUksQ0FBQztBQUNsQyxJQUFJLE9BQW1CLENBQUM7QUFXeEIsU0FBUyxnQkFBZ0I7SUFDeEIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO0FBQ3BDLENBQUM7QUFJRCxLQUFLLFVBQVUsZUFBZSxDQUFDLE1BQWM7SUFDNUMsSUFBSSxDQUFDO1FBQ0osb0JBQW9CLENBQ25CO1lBQ0MsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUU7WUFDcEMsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUU7WUFDeEMsRUFBRSxJQUFJLEVBQUUsa0JBQWtCLEVBQUUsUUFBUSxFQUFFLGdCQUFnQixFQUFFO1NBQ3hELEVBQ0QsTUFBTSxDQUNOLENBQUM7UUFFRixPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDO1lBQy9CLE1BQU07WUFDTixRQUFRO1lBQ1IsZ0JBQWdCO1NBQ2hCLENBQUMsQ0FBQztRQUVILG9CQUFvQixDQUNuQjtZQUNDLEVBQUUsSUFBSSxFQUFFLGVBQWUsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLEtBQUss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QUMxRCxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRTtZQUMxQyxFQUFFLElBQUksRUFBRSxpQkFBaUIsRUFBRSxRQUFRLEVBQUUsZUFBZSxFQUFFO1lBQ3RELEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFO1lBQzVCLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFO1NBQ3BDLEVBQ0QsTUFBTSxDQUNOLENBQUM7UUFFRixNQUFNLHNCQUFzQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRXJDLE1BQU0scUJBQXFCLEdBQTRCO1lBQ3RELFNBQVMsRUFBRSxpQkFBaUI7WUFDNUIsTUFBTSxFQUFFLE9BQU8sQ0FBQyxTQUFtQjtZQUNuQyxNQUFNLEVBQUUsUUFBa0I7WUFDMUIsU0FBUztZQUNULFdBQVcsRUFBRSxlQUFlO1lBQzVCLFVBQVUsRUFBRSxFQUFFO1NBQ2QsQ0FBQztRQUVGLE1BQU0sTUFBTSxHQUFHLENBQUMsTUFBTSxLQUFNLENBQUMsZUFBZSxDQUMzQyxTQUFTLEVBQ1QscUJBQXFCLENBQ3JCLENBQXlCLENBQUM7UUFFM0IsTUFBTSxDQUFDLElBQUksQ0FBQywrQ0FBK0MsQ0FBQyxDQUFDO1FBQzdELE9BQU8sTUFBTSxDQUFDO0lBQ2YsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDaEIsWUFBWSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztRQUM1QixNQUFNLElBQUksS0FBSyxDQUFDLHlDQUF5QyxDQUFDLENBQUM7SUFDNUQsQ0FBQztBQUNGLENBQUM7QUFFRCxlQUFlO0lBQ2Qsb0NBQW9DO0lBQ3BDLGtDQUFrQztJQUNsQywyQkFBMkI7SUFDM0IseUJBQXlCO0NBQ3pCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuXHRFeHBlY3RlZEFzc2VydGlvblJlc3VsdCxcblx0RXhwZWN0ZWRBdHRlc3RhdGlvblJlc3VsdCxcblx0RmlkbzJMaWIsXG5cdFB1YmxpY0tleUNyZWRlbnRpYWxDcmVhdGlvbk9wdGlvbnMsXG5cdFB1YmxpY0tleUNyZWRlbnRpYWxEZXNjcmlwdG9yLFxuXHRQdWJsaWNLZXlDcmVkZW50aWFsUmVxdWVzdE9wdGlvbnMsXG5cdEZpZG8yQXR0ZXN0YXRpb25SZXN1bHQsXG5cdEZpZG8yQXNzZXJ0aW9uUmVzdWx0LFxuXHRBdHRlc3RhdGlvblJlc3VsdCxcblx0QXNzZXJ0aW9uUmVzdWx0XG59IGZyb20gJ2ZpZG8yLWxpYic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBzb3BzLCB7IFNlY3JldHNNYXAgfSBmcm9tICcuLi91dGlscy9zb3BzJztcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJy4uL2NvbmZpZy9sb2dnZXInO1xuaW1wb3J0IHsgdmFsaWRhdGVEZXBlbmRlbmNpZXMgfSBmcm9tICcuLi91dGlscy92YWxpZGF0ZURlcGVuZGVuY2llcyc7XG5pbXBvcnQgeyBwcm9jZXNzRXJyb3IgfSBmcm9tICcuLi91dGlscy9wcm9jZXNzRXJyb3InO1xuaW1wb3J0IHsgZXhlY1N5bmMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcblxubGV0IGZpZG8yOiBGaWRvMkxpYiB8IG51bGwgPSBudWxsO1xubGV0IHNlY3JldHM6IFNlY3JldHNNYXA7XG5cbmludGVyZmFjZSBVc2VyIHtcblx0aWQ6IHN0cmluZztcblx0ZW1haWw6IHN0cmluZztcblx0dXNlcm5hbWU6IHN0cmluZztcblx0Y3JlZGVudGlhbDoge1xuXHRcdGNyZWRlbnRpYWxJZDogc3RyaW5nO1xuXHR9W107XG59XG5cbmZ1bmN0aW9uIGdldERpcmVjdG9yeVBhdGgoKTogc3RyaW5nIHtcblx0cmV0dXJuIHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpKTtcbn1cblxudHlwZSBGYWN0b3IgPSAnZmlyc3QnIHwgJ3NlY29uZCcgfCAnZWl0aGVyJztcblxuYXN5bmMgZnVuY3Rpb24gaW5pdGlhbGl6ZUZpZG8yKGxvZ2dlcjogTG9nZ2VyKTogUHJvbWlzZTx2b2lkPiB7XG5cdHRyeSB7XG5cdFx0dmFsaWRhdGVEZXBlbmRlbmNpZXMoXG5cdFx0XHRbXG5cdFx0XHRcdHsgbmFtZTogJ2xvZ2dlcicsIGluc3RhbmNlOiBsb2dnZXIgfSxcblx0XHRcdFx0eyBuYW1lOiAnZXhlY1N5bmMnLCBpbnN0YW5jZTogZXhlY1N5bmMgfSxcblx0XHRcdFx0eyBuYW1lOiAnZ2V0RGlyZWN0b3J5UGF0aCcsIGluc3RhbmNlOiBnZXREaXJlY3RvcnlQYXRoIH1cblx0XHRcdF0sXG5cdFx0XHRsb2dnZXJcblx0XHQpO1xuXG5cdFx0c2VjcmV0cyA9IGF3YWl0IHNvcHMuZ2V0U2VjcmV0cyh7XG5cdFx0XHRsb2dnZXIsXG5cdFx0XHRleGVjU3luYyxcblx0XHRcdGdldERpcmVjdG9yeVBhdGhcblx0XHR9KTtcblxuXHRcdHZhbGlkYXRlRGVwZW5kZW5jaWVzKFxuXHRcdFx0W1xuXHRcdFx0XHR7IG5hbWU6ICdzZWNyZXRzLlJQX0lEJywgaW5zdGFuY2U6IHNlY3JldHMuUlBfSUQgfSxcblx0XHRcdFx0eyBuYW1lOiAnc2VjcmV0cy5SUF9OQU1FJywgaW5zdGFuY2U6IHNlY3JldHMuUlBfTkFNRSB9LFxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0bmFtZTogJ3NlY3JldHMuRklET19DSEFMTEVOR0VfU0laRScsXG5cdFx0XHRcdFx0aW5zdGFuY2U6IHNlY3JldHMuRklET19DSEFMTEVOR0VfU0laRVxuXHRcdFx0XHR9XG5cdFx0XHRdLFxuXHRcdFx0bG9nZ2VyXG5cdFx0KTtcblxuXHRcdC8vIEluaXRpYWxpemUgRmlkbzJMaWIgaW5zdGFuY2Vcblx0XHRmaWRvMiA9IG5ldyBGaWRvMkxpYih7XG5cdFx0XHR0aW1lb3V0OiA2MDAwMCxcblx0XHRcdHJwSWQ6IHNlY3JldHMuUlBfSUQsXG5cdFx0XHRycE5hbWU6IHNlY3JldHMuUlBfTkFNRSxcblx0XHRcdGNoYWxsZW5nZVNpemU6IHNlY3JldHMuRklET19DSEFMTEVOR0VfU0laRSxcblx0XHRcdGNyeXB0b1BhcmFtczogc2VjcmV0cy5GSURPX0NSWVBUT19QQVJBTUVURVJTLFxuXHRcdFx0YXV0aGVudGljYXRvclJlcXVpcmVSZXNpZGVudEtleTpcblx0XHRcdFx0c2VjcmV0cy5GSURPX0FVVEhFTlRJQ0FUT1JfUkVRVUlSRV9SRVNJREVOVF9LRVksXG5cdFx0XHRhdXRoZW50aWNhdG9yVXNlclZlcmlmaWNhdGlvbjpcblx0XHRcdFx0c2VjcmV0cy5GSURPX0FVVEhFTlRJQ0FUT1JfVVNFUl9WRVJJRklDQVRJT05cblx0XHR9KTtcblxuXHRcdGxvZ2dlci5pbmZvKCdGaWRvMkxpYiBpbml0aWFsaXplZCBzdWNjZXNzZnVsbHkuJyk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0cHJvY2Vzc0Vycm9yKGVycm9yLCBsb2dnZXIpO1xuXHRcdHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGluaXRpYWxpemUgRmlkbzJMaWInKTtcblx0fVxufVxuXG5hc3luYyBmdW5jdGlvbiBlbnN1cmVGaWRvMkluaXRpYWxpemVkKGxvZ2dlcjogTG9nZ2VyKTogUHJvbWlzZTx2b2lkPiB7XG5cdHZhbGlkYXRlRGVwZW5kZW5jaWVzKFt7IG5hbWU6ICdsb2dnZXInLCBpbnN0YW5jZTogbG9nZ2VyIH1dLCBsb2dnZXIpO1xuXG5cdGlmICghZmlkbzIpIHtcblx0XHRsb2dnZXIuZGVidWcoJ0ZpZG8yTGliIGlzIG5vdCBpbml0aWFsaXplZCwgaW5pdGlhbGl6aW5nIG5vdy4nKTtcblx0XHRhd2FpdCBpbml0aWFsaXplRmlkbzIobG9nZ2VyKTtcblx0fVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZW5lcmF0ZVBhc3NrZXlSZWdpc3RyYXRpb25PcHRpb25zKFxuXHR1c2VyOiBVc2VyLFxuXHRsb2dnZXI6IExvZ2dlclxuKTogUHJvbWlzZTxQdWJsaWNLZXlDcmVkZW50aWFsQ3JlYXRpb25PcHRpb25zPiB7XG5cdHRyeSB7XG5cdFx0dmFsaWRhdGVEZXBlbmRlbmNpZXMoXG5cdFx0XHRbXG5cdFx0XHRcdHsgbmFtZTogJ3VzZXInLCBpbnN0YW5jZTogdXNlciB9LFxuXHRcdFx0XHR7IG5hbWU6ICdsb2dnZXInLCBpbnN0YW5jZTogbG9nZ2VyIH1cblx0XHRcdF0sXG5cdFx0XHRsb2dnZXJcblx0XHQpO1xuXG5cdFx0YXdhaXQgZW5zdXJlRmlkbzJJbml0aWFsaXplZChsb2dnZXIpO1xuXG5cdFx0Y29uc3QgcGFzc2tleVJlZ2lzdHJhdGlvbk9wdGlvbnMgPSBhd2FpdCBmaWRvMiEuYXR0ZXN0YXRpb25PcHRpb25zKCk7XG5cblx0XHRjb25zdCByZWdpc3RyYXRpb25PcHRpb25zOiBQdWJsaWNLZXlDcmVkZW50aWFsQ3JlYXRpb25PcHRpb25zID0ge1xuXHRcdFx0Li4ucGFzc2tleVJlZ2lzdHJhdGlvbk9wdGlvbnMsXG5cdFx0XHR1c2VyOiB7XG5cdFx0XHRcdGlkOiBCdWZmZXIuZnJvbSh1c2VyLmlkLCAndXRmLTgnKSxcblx0XHRcdFx0bmFtZTogdXNlci5lbWFpbCxcblx0XHRcdFx0ZGlzcGxheU5hbWU6IHVzZXIudXNlcm5hbWVcblx0XHRcdH0sXG5cdFx0XHRwdWJLZXlDcmVkUGFyYW1zOiBbeyB0eXBlOiAncHVibGljLWtleScsIGFsZzogLTcgfV0sXG5cdFx0XHR0aW1lb3V0OiA2MDAwMCxcblx0XHRcdGF0dGVzdGF0aW9uOiAnZGlyZWN0Jyxcblx0XHRcdGF1dGhlbnRpY2F0b3JTZWxlY3Rpb246IHtcblx0XHRcdFx0YXV0aGVudGljYXRvckF0dGFjaG1lbnQ6ICdwbGF0Zm9ybScsXG5cdFx0XHRcdHJlcXVpcmVSZXNpZGVudEtleTogdHJ1ZSxcblx0XHRcdFx0dXNlclZlcmlmaWNhdGlvbjogJ3ByZWZlcnJlZCdcblx0XHRcdH1cblx0XHR9O1xuXHRcdGxvZ2dlci5pbmZvKCdQYXNza2V5IHJlZ2lzdHJhdGlvbiBvcHRpb25zIGdlbmVyYXRlZCBzdWNjZXNzZnVsbHkuJyk7XG5cdFx0cmV0dXJuIHJlZ2lzdHJhdGlvbk9wdGlvbnM7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0cHJvY2Vzc0Vycm9yKGVycm9yLCBsb2dnZXIpO1xuXHRcdHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGdlbmVyYXRlIHBhc3NrZXkgcmVnaXN0cmF0aW9uIG9wdGlvbnMnKTtcblx0fVxufVxuXG5hc3luYyBmdW5jdGlvbiB2ZXJpZnlQYXNza2V5UmVnaXN0cmF0aW9uKFxuXHRhdHRlc3RhdGlvbjogQXR0ZXN0YXRpb25SZXN1bHQsXG5cdGV4cGVjdGVkQ2hhbGxlbmdlOiBzdHJpbmcsXG5cdGxvZ2dlcjogTG9nZ2VyXG4pOiBQcm9taXNlPEZpZG8yQXR0ZXN0YXRpb25SZXN1bHQ+IHtcblx0dHJ5IHtcblx0XHR2YWxpZGF0ZURlcGVuZGVuY2llcyhcblx0XHRcdFtcblx0XHRcdFx0eyBuYW1lOiAnYXR0ZXN0YXRpb24nLCBpbnN0YW5jZTogYXR0ZXN0YXRpb24gfSxcblx0XHRcdFx0eyBuYW1lOiAnZXhwZWN0ZWRDaGFsbGVuZ2UnLCBpbnN0YW5jZTogZXhwZWN0ZWRDaGFsbGVuZ2UgfSxcblx0XHRcdFx0eyBuYW1lOiAnbG9nZ2VyJywgaW5zdGFuY2U6IGxvZ2dlciB9XG5cdFx0XHRdLFxuXHRcdFx0bG9nZ2VyXG5cdFx0KTtcblxuXHRcdGF3YWl0IGVuc3VyZUZpZG8ySW5pdGlhbGl6ZWQobG9nZ2VyKTtcblxuXHRcdGNvbnN0IHUyZkF0dGVzdGF0aW9uRXhwZWN0YXRpb25zOiBFeHBlY3RlZEF0dGVzdGF0aW9uUmVzdWx0ID0ge1xuXHRcdFx0Y2hhbGxlbmdlOiBleHBlY3RlZENoYWxsZW5nZSxcblx0XHRcdG9yaWdpbjogc2VjcmV0cy5SUF9PUklHSU4gYXMgc3RyaW5nLFxuXHRcdFx0ZmFjdG9yOiAnZWl0aGVyJyBhcyBGYWN0b3IsXG5cdFx0XHRycElkOiBzZWNyZXRzLlJQX0lEXG5cdFx0fTtcblxuXHRcdGNvbnN0IHJlc3VsdCA9IChhd2FpdCBmaWRvMiEuYXR0ZXN0YXRpb25SZXN1bHQoXG5cdFx0XHRhdHRlc3RhdGlvbixcblx0XHRcdHUyZkF0dGVzdGF0aW9uRXhwZWN0YXRpb25zXG5cdFx0KSkgYXMgRmlkbzJBdHRlc3RhdGlvblJlc3VsdDtcblxuXHRcdGxvZ2dlci5pbmZvKCdQYXNza2V5IHJlZ2lzdHJhdGlvbiB2ZXJpZmllZCBzdWNjZXNzZnVsbHkuJyk7XG5cdFx0cmV0dXJuIHJlc3VsdDtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRwcm9jZXNzRXJyb3IoZXJyb3IsIGxvZ2dlcik7XG5cdFx0dGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gdmVyaWZ5IHBhc3NrZXkgcmVnaXN0cmF0aW9uJyk7XG5cdH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVQYXNza2V5QXV0aGVudGljYXRpb25PcHRpb25zKFxuXHR1c2VyOiBVc2VyLFxuXHRsb2dnZXI6IExvZ2dlclxuKTogUHJvbWlzZTxQdWJsaWNLZXlDcmVkZW50aWFsUmVxdWVzdE9wdGlvbnM+IHtcblx0dHJ5IHtcblx0XHR2YWxpZGF0ZURlcGVuZGVuY2llcyhcblx0XHRcdFtcblx0XHRcdFx0eyBuYW1lOiAndXNlcicsIGluc3RhbmNlOiB1c2VyIH0sXG5cdFx0XHRcdHsgbmFtZTogJ2xvZ2dlcicsIGluc3RhbmNlOiBsb2dnZXIgfVxuXHRcdFx0XSxcblx0XHRcdGxvZ2dlclxuXHRcdCk7XG5cblx0XHRhd2FpdCBlbnN1cmVGaWRvMkluaXRpYWxpemVkKGxvZ2dlcik7XG5cblx0XHRjb25zdCB1c2VyQ3JlZGVudGlhbHM6IFB1YmxpY0tleUNyZWRlbnRpYWxEZXNjcmlwdG9yW10gPVxuXHRcdFx0dXNlci5jcmVkZW50aWFsLm1hcChjcmVkZW50aWFsID0+ICh7XG5cdFx0XHRcdHR5cGU6ICdwdWJsaWMta2V5JyBhcyBjb25zdCxcblx0XHRcdFx0aWQ6IEJ1ZmZlci5mcm9tKGNyZWRlbnRpYWwuY3JlZGVudGlhbElkLCAnYmFzZTY0JykuYnVmZmVyXG5cdFx0XHR9KSk7XG5cblx0XHRjb25zdCBhc3NlcnRpb25PcHRpb25zID0gYXdhaXQgZmlkbzIhLmFzc2VydGlvbk9wdGlvbnMoKTtcblxuXHRcdGNvbnN0IGF1dGhlbnRpY2F0aW9uT3B0aW9uczogUHVibGljS2V5Q3JlZGVudGlhbFJlcXVlc3RPcHRpb25zID0ge1xuXHRcdFx0Li4uYXNzZXJ0aW9uT3B0aW9ucyxcblx0XHRcdGFsbG93Q3JlZGVudGlhbHM6IHVzZXJDcmVkZW50aWFscyxcblx0XHRcdHVzZXJWZXJpZmljYXRpb246ICdyZXF1aXJlZCcsIC8vIGVuc3VyZSBwYXNzd29yZGxlc3MgbG9naW5cblx0XHRcdHRpbWVvdXQ6IDYwMDAwXG5cdFx0fTtcblxuXHRcdGxvZ2dlci5pbmZvKCdQYXNza2V5IGF1dGhlbnRpY2F0aW9uIG9wdGlvbnMgZ2VuZXJhdGVkIHN1Y2Nlc3NmdWxseS4nKTtcblx0XHRyZXR1cm4gYXV0aGVudGljYXRpb25PcHRpb25zO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdHByb2Nlc3NFcnJvcihlcnJvciwgbG9nZ2VyKTtcblx0XHR0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBnZW5lcmF0ZSBwYXNza2V5IGF1dGhlbnRpY2F0aW9uIG9wdGlvbnMnKTtcblx0fVxufVxuXG5hc3luYyBmdW5jdGlvbiB2ZXJpZnlQYXNza2V5QXV0aGVudGljYXRpb24oXG5cdGFzc2VydGlvbjogQXNzZXJ0aW9uUmVzdWx0LFxuXHRleHBlY3RlZENoYWxsZW5nZTogc3RyaW5nLFxuXHRwdWJsaWNLZXk6IHN0cmluZyxcblx0cHJldmlvdXNDb3VudGVyOiBudW1iZXIsXG5cdGlkOiBzdHJpbmcsXG5cdGxvZ2dlcjogTG9nZ2VyXG4pOiBQcm9taXNlPEZpZG8yQXNzZXJ0aW9uUmVzdWx0PiB7XG5cdHRyeSB7XG5cdFx0dmFsaWRhdGVEZXBlbmRlbmNpZXMoXG5cdFx0XHRbXG5cdFx0XHRcdHsgbmFtZTogJ2Fzc2VydGlvbicsIGluc3RhbmNlOiBhc3NlcnRpb24gfSxcblx0XHRcdFx0eyBuYW1lOiAnZXhwZWN0ZWRDaGFsbGVuZ2UnLCBpbnN0YW5jZTogZXhwZWN0ZWRDaGFsbGVuZ2UgfSxcblx0XHRcdFx0eyBuYW1lOiAncHVibGljS2V5JywgaW5zdGFuY2U6IHB1YmxpY0tleSB9LFxuXHRcdFx0XHR7IG5hbWU6ICdwcmV2aW91c0NvdW50ZXInLCBpbnN0YW5jZTogcHJldmlvdXNDb3VudGVyIH0sXG5cdFx0XHRcdHsgbmFtZTogJ2lkJywgaW5zdGFuY2U6IGlkIH0sXG5cdFx0XHRcdHsgbmFtZTogJ2xvZ2dlcicsIGluc3RhbmNlOiBsb2dnZXIgfVxuXHRcdFx0XSxcblx0XHRcdGxvZ2dlclxuXHRcdCk7XG5cblx0XHRhd2FpdCBlbnN1cmVGaWRvMkluaXRpYWxpemVkKGxvZ2dlcik7XG5cblx0XHRjb25zdCBhc3NlcnRpb25FeHBlY3RhdGlvbnM6IEV4cGVjdGVkQXNzZXJ0aW9uUmVzdWx0ID0ge1xuXHRcdFx0Y2hhbGxlbmdlOiBleHBlY3RlZENoYWxsZW5nZSxcblx0XHRcdG9yaWdpbjogc2VjcmV0cy5SUF9PUklHSU4gYXMgc3RyaW5nLFxuXHRcdFx0ZmFjdG9yOiAnZWl0aGVyJyBhcyBGYWN0b3IsXG5cdFx0XHRwdWJsaWNLZXksXG5cdFx0XHRwcmV2Q291bnRlcjogcHJldmlvdXNDb3VudGVyLFxuXHRcdFx0dXNlckhhbmRsZTogaWRcblx0XHR9O1xuXG5cdFx0Y29uc3QgcmVzdWx0ID0gKGF3YWl0IGZpZG8yIS5hc3NlcnRpb25SZXN1bHQoXG5cdFx0XHRhc3NlcnRpb24sXG5cdFx0XHRhc3NlcnRpb25FeHBlY3RhdGlvbnNcblx0XHQpKSBhcyBGaWRvMkFzc2VydGlvblJlc3VsdDtcblxuXHRcdGxvZ2dlci5pbmZvKCdQYXNza2V5IGF1dGhlbnRpY2F0aW9uIHZlcmlmaWVkIHN1Y2Nlc3NmdWxseS4nKTtcblx0XHRyZXR1cm4gcmVzdWx0O1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdHByb2Nlc3NFcnJvcihlcnJvciwgbG9nZ2VyKTtcblx0XHR0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byB2ZXJpZnkgcGFzc2tleSBhdXRoZW50aWNhdGlvbicpO1xuXHR9XG59XG5cbmV4cG9ydCBkZWZhdWx0IHtcblx0Z2VuZXJhdGVQYXNza2V5QXV0aGVudGljYXRpb25PcHRpb25zLFxuXHRnZW5lcmF0ZVBhc3NrZXlSZWdpc3RyYXRpb25PcHRpb25zLFxuXHR2ZXJpZnlQYXNza2V5QXV0aGVudGljYXRpb24sXG5cdHZlcmlmeVBhc3NrZXlSZWdpc3RyYXRpb25cbn07XG4iXX0=
