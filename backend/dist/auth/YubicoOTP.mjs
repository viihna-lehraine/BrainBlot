import { ServiceFactory } from '../index/factory.mjs';
import { serviceTTLConfig } from '../config/cache.mjs';
import '../../types/custom/yub.js';
export class YubicoOTPService {
	static instance = null;
	logger;
	errorLogger;
	errorHandler;
	envConfig;
	secrets;
	cacheService;
	yubClient;
	ttl;
	yub;
	constructor(
		logger,
		errorLogger,
		errorHandler,
		envConfig,
		secrets,
		cacheService
	) {
		this.logger = logger;
		this.errorLogger = errorLogger;
		this.errorHandler = errorHandler;
		this.envConfig = envConfig;
		this.secrets = secrets;
		this.cacheService = cacheService;
		this.ttl =
			serviceTTLConfig.YubicoOtpService || serviceTTLConfig.default;
		this.yub = this.initializeYubClient();
	}
	static async getInstance() {
		if (!YubicoOTPService.instance) {
			const logger = await ServiceFactory.getLoggerService();
			const errorLogger = await ServiceFactory.getErrorLoggerService();
			const errorHandler = await ServiceFactory.getErrorHandlerService();
			const envConfig = await ServiceFactory.getEnvConfigService();
			const secrets = await ServiceFactory.getVaultService();
			const cacheService = await ServiceFactory.getCacheService();
			YubicoOTPService.instance = new YubicoOTPService(
				logger,
				errorLogger,
				errorHandler,
				envConfig,
				secrets,
				cacheService
			);
		}
		return YubicoOTPService.instance;
	}
	initializeYubClient() {
		return {
			init: (clientId, secretKey) => {
				console.debug(
					`Initializing Yubico OTP with ${clientId} and ${secretKey}`
				);
				return {
					verify: (otp, callback) => {
						if (otp === 'test-otp') {
							const response = {
								status: 'OK'
							};
							callback(null, response);
						} else {
							const response = {
								status: 'FAIL'
							};
							callback(new Error('Invalid OTP'), response);
						}
					}
				};
			}
		};
	}
	init(clientId, secretKey) {
		return this.yub.init(clientId, secretKey);
	}
	async initializeYubicoOTP() {
		const cacheKey = 'yubicoClient';
		const cachedClient = await this.cacheService.get(cacheKey, 'auth');
		if (
			cachedClient &&
			typeof cachedClient === 'object' &&
			'verify' in cachedClient
		) {
			this.logger.debug('Loaded Yubico Client from cache.');
			this.yubClient = cachedClient;
			return;
		}
		try {
			this.logger.info('Initializing Yubico OTP Utility.');
			const yubiSecrets = await this.secrets.retrieveSecrets(
				['YUBICO_CLIENT_ID', 'YUBICO_SECRET_KEY'],
				secrets => secrets
			);
			if (
				yubiSecrets &&
				typeof yubiSecrets === 'object' &&
				!Array.isArray(yubiSecrets)
			) {
				const yubicoClientId =
					yubiSecrets['YUBICO_CLIENT_ID']?.toString() || '';
				const yubicoSecretKey =
					yubiSecrets['YUBICO_SECRET_KEY']?.toString() || '';
				if (!yubicoClientId || !yubicoSecretKey) {
					throw new Error(
						'Yubico Client ID or Secret Key is missing'
					);
				}
				const initializedClient = this.yub.init(
					yubicoClientId,
					yubicoSecretKey
				);
				if (initializedClient && 'verify' in initializedClient) {
					this.yubClient = initializedClient;
					await this.cacheService.set(
						cacheKey,
						this.yubClient,
						'auth',
						this.ttl
					);
					this.logger.info(
						'Yubico OTP Utility successfully initialized.'
					);
				}
			} else {
				throw new Error('Failed to retrieve Yubico secrets');
			}
		} catch (utilError) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Failed to initialize Yubico OTP Utility: ${
						utilError instanceof Error
							? utilError.message
							: utilError
					}`,
					{ exposeToClient: false }
				);
			this.errorLogger.logError(utilityError.message);
			this.errorHandler.handleError({ error: utilityError });
		}
	}
	async validateYubicoOTP(otp) {
		const cacheKey = `yubicoOtp:${otp}`;
		const cachedResult = await this.cacheService.get(cacheKey, 'auth');
		if (cachedResult !== null) {
			this.logger.debug('Loaded OTP validation result from cache.');
			return cachedResult;
		}
		try {
			if (!this.yubClient) {
				await this.initializeYubicoOTP();
			}
			return new Promise((resolve, reject) => {
				this.yubClient.verify(otp, (utilError, data) => {
					if (utilError) {
						const innerUtilError =
							new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
								`Failed to validate Yubico OTP: ${
									utilError instanceof Error
										? utilError.message
										: String(utilError)
								}`,
								{ exposeToClient: false }
							);
						this.errorLogger.logWarn(innerUtilError.message);
						this.errorHandler.handleError({
							error: innerUtilError
						});
						return reject(innerUtilError);
					}
					const isValid = data && data.status === 'OK';
					this.logger.debug(
						`Yubico OTP validation ${isValid ? 'successful' : 'failed'}.`
					);
					this.cacheService.set(cacheKey, isValid, 'auth', this.ttl);
					resolve(isValid);
				});
			});
		} catch (utilError) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Failed to validate Yubico OTP: ${
						utilError instanceof Error
							? utilError.message
							: utilError
					}`,
					{ exposeToClient: false }
				);
			this.errorLogger.logWarn(utilityError.message);
			this.errorHandler.handleError({ error: utilityError });
			return false;
		}
	}
	async generateYubicoOTPOptions() {
		try {
			this.logger.info('Generating Yubico OTP options.');
			const apiUrl = this.envConfig.getEnvVariable('yubicoApiUrl');
			// Await the retrieval of secrets
			const yubiSecrets = await this.secrets.retrieveSecrets(
				['YUBICO_CLIENT_ID', 'YUBICO_SECRET_KEY'],
				secrets => secrets
			);
			if (
				yubiSecrets &&
				typeof yubiSecrets === 'object' &&
				!Array.isArray(yubiSecrets)
			) {
				const yubicoClientId =
					yubiSecrets['YUBICO_CLIENT_ID']?.toString() || '';
				const yubicoSecretKey =
					yubiSecrets['YUBICO_SECRET_KEY']?.toString() || '';
				if (!yubicoClientId || !yubicoSecretKey) {
					throw new Error(
						'Failed to retrieve or decrypt Yubico client ID or secret key'
					);
				}
				return {
					clientId: parseInt(yubicoClientId, 10),
					apiKey: yubicoSecretKey,
					apiUrl
				};
			} else {
				throw new Error('Failed to retrieve Yubico secrets');
			}
		} catch (utiLError) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Failed to generate Yubico OTP options: ${
						utiLError instanceof Error
							? utiLError.message
							: utiLError
					}; Returning object with placeholder values.`,
					{ exposeToClient: false }
				);
			this.errorLogger.logWarn(utilityError.message);
			this.errorHandler.handleCriticalError({ error: utilityError });
			return {
				clientId: 0,
				apiKey: '',
				apiUrl: ''
			};
		}
	}
	async shutdown() {
		try {
			this.logger.info('Shutting down YubicoOTPService...');
			this.logger.info('Clearing YubicoOTPService cache...');
			await this.cacheService.clearNamespace('YubicoOTPService');
			this.logger.info('YubicoOTPService cache cleared successfully.');
			this.yubClient = undefined;
			YubicoOTPService.instance = null;
			this.logger.info(
				'YubicoOTPService shutdown completed successfully.'
			);
		} catch (error) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Error during YubicoOTPService shutdown: ${error instanceof Error ? error.message : error}`
				);
			this.errorLogger.logError(utilityError.message);
			this.errorHandler.handleError({ error: utilityError });
		}
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiWXViaWNvT1RQLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2F1dGgvWXViaWNvT1RQLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWNBLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUVuRCxPQUFPLDJCQUEyQixDQUFDO0FBRW5DLE1BQU0sT0FBTyxnQkFBZ0I7SUFDcEIsTUFBTSxDQUFDLFFBQVEsR0FBNEIsSUFBSSxDQUFDO0lBQ2hELE1BQU0sQ0FBNEI7SUFDbEMsV0FBVyxDQUE4QjtJQUN6QyxZQUFZLENBQStCO0lBQzNDLFNBQVMsQ0FBNEI7SUFDckMsT0FBTyxDQUF3QjtJQUMvQixZQUFZLENBQXdCO0lBQ3BDLFNBQVMsQ0FBaUM7SUFFMUMsR0FBRyxDQUFTO0lBQ1osR0FBRyxDQUE0QjtJQUV2QyxZQUNDLE1BQWlDLEVBQ2pDLFdBQXdDLEVBQ3hDLFlBQTBDLEVBQzFDLFNBQW9DLEVBQ3BDLE9BQThCLEVBQzlCLFlBQW1DO1FBRW5DLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQy9CLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxHQUFHO1lBQ1AsZ0JBQWdCLENBQUMsZ0JBQWdCLElBQUksZ0JBQWdCLENBQUMsT0FBTyxDQUFDO1FBQy9ELElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7SUFDdkMsQ0FBQztJQUVNLE1BQU0sQ0FBQyxLQUFLLENBQUMsV0FBVztRQUM5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QUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FDM0YsQ0FBQztZQUNILElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNoRCxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO1FBQ3hELENBQUM7SUFDRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcblx0QXBwTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0Q2FjaGVTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFbnZDb25maWdTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFZhdWx0U2VydmljZUludGVyZmFjZSxcblx0WXViaWNvT1RQU2VydmljZUludGVyZmFjZVxufSBmcm9tICcuLi9pbmRleC9pbnRlcmZhY2VzL3NlcnZpY2VzJztcbmltcG9ydCB7XG5cdFl1YkNsaWVudEludGVyZmFjZSxcblx0WXViUmVzcG9uc2VJbnRlcmZhY2UsXG5cdFl1Ymljb09UUE9wdGlvbnNJbnRlcmZhY2Vcbn0gZnJvbSAnLi4vaW5kZXgvaW50ZXJmYWNlcy9zZXJ2aWNlQ29tcG9uZW50cyc7XG5pbXBvcnQgeyBTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4uL2luZGV4L2ZhY3RvcnknO1xuaW1wb3J0IHsgc2VydmljZVRUTENvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy9jYWNoZSc7XG5cbmltcG9ydCAnLi4vLi4vdHlwZXMvY3VzdG9tL3l1Yi5qcyc7XG5cbmV4cG9ydCBjbGFzcyBZdWJpY29PVFBTZXJ2aWNlIGltcGxlbWVudHMgWXViaWNvT1RQU2VydmljZUludGVyZmFjZSB7XG5cdHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBZdWJpY29PVFBTZXJ2aWNlIHwgbnVsbCA9IG51bGw7XG5cdHByaXZhdGUgbG9nZ2VyOiBBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIGVycm9yTG9nZ2VyOiBFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZXJyb3JIYW5kbGVyOiBFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIGVudkNvbmZpZzogRW52Q29uZmlnU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBzZWNyZXRzOiBWYXVsdFNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgY2FjaGVTZXJ2aWNlOiBDYWNoZVNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgeXViQ2xpZW50OiBZdWJDbGllbnRJbnRlcmZhY2UgfCB1bmRlZmluZWQ7XG5cblx0cHJpdmF0ZSB0dGw6IG51bWJlcjtcblx0cHJpdmF0ZSB5dWI6IFl1Ymljb09UUFNlcnZpY2VJbnRlcmZhY2U7XG5cblx0cHJpdmF0ZSBjb25zdHJ1Y3Rvcihcblx0XHRsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0ZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0XHRlcnJvckhhbmRsZXI6IEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0ZW52Q29uZmlnOiBFbnZDb25maWdTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdHNlY3JldHM6IFZhdWx0U2VydmljZUludGVyZmFjZSxcblx0XHRjYWNoZVNlcnZpY2U6IENhY2hlU2VydmljZUludGVyZmFjZVxuXHQpIHtcblx0XHR0aGlzLmxvZ2dlciA9IGxvZ2dlcjtcblx0XHR0aGlzLmVycm9yTG9nZ2VyID0gZXJyb3JMb2dnZXI7XG5cdFx0dGhpcy5lcnJvckhhbmRsZXIgPSBlcnJvckhhbmRsZXI7XG5cdFx0dGhpcy5lbnZDb25maWcgPSBlbnZDb25maWc7XG5cdFx0dGhpcy5zZWNyZXRzID0gc2VjcmV0cztcblx0XHR0aGlzLmNhY2hlU2VydmljZSA9IGNhY2hlU2VydmljZTtcblx0XHR0aGlzLnR0bCA9XG5cdFx0XHRzZXJ2aWNlVFRMQ29uZmlnLll1Ymljb090cFNlcnZpY2UgfHwgc2VydmljZVRUTENvbmZpZy5kZWZhdWx0O1xuXHRcdHRoaXMueXViID0gdGhpcy5pbml0aWFsaXplWXViQ2xpZW50KCk7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGFzeW5jIGdldEluc3RhbmNlKCk6IFByb21pc2U8WXViaWNvT1RQU2VydmljZT4ge1xuXHRcdGlmICghWXViaWNvT1RQU2VydmljZS5pbnN0YW5jZSkge1xuXHRcdFx0Y29uc3QgbG9nZ2VyID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0TG9nZ2VyU2VydmljZSgpO1xuXHRcdFx0Y29uc3QgZXJyb3JMb2dnZXIgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRFcnJvckxvZ2dlclNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGVycm9ySGFuZGxlciA9IGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldEVycm9ySGFuZGxlclNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGVudkNvbmZpZyA9IGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldEVudkNvbmZpZ1NlcnZpY2UoKTtcblx0XHRcdGNvbnN0IHNlY3JldHMgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRWYXVsdFNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGNhY2hlU2VydmljZSA9IGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldENhY2hlU2VydmljZSgpO1xuXG5cdFx0XHRZdWJpY29PVFBTZXJ2aWNlLmluc3RhbmNlID0gbmV3IFl1Ymljb09UUFNlcnZpY2UoXG5cdFx0XHRcdGxvZ2dlcixcblx0XHRcdFx0ZXJyb3JMb2dnZXIsXG5cdFx0XHRcdGVycm9ySGFuZGxlcixcblx0XHRcdFx0ZW52Q29uZmlnLFxuXHRcdFx0XHRzZWNyZXRzLFxuXHRcdFx0XHRjYWNoZVNlcnZpY2Vcblx0XHRcdCk7XG5cdFx0fVxuXHRcdHJldHVybiBZdWJpY29PVFBTZXJ2aWNlLmluc3RhbmNlO1xuXHR9XG5cblx0cHJpdmF0ZSBpbml0aWFsaXplWXViQ2xpZW50KCk6IFl1Ymljb09UUFNlcnZpY2VJbnRlcmZhY2Uge1xuXHRcdHJldHVybiB7XG5cdFx0XHRpbml0OiAoY2xpZW50SWQ6IHN0cmluZywgc2VjcmV0S2V5OiBzdHJpbmcpOiBZdWJDbGllbnRJbnRlcmZhY2UgPT4ge1xuXHRcdFx0XHRjb25zb2xlLmRlYnVnKFxuXHRcdFx0XHRcdGBJbml0aWFsaXppbmcgWXViaWNvIE9UUCB3aXRoICR7Y2xpZW50SWR9IGFuZCAke3NlY3JldEtleX1gXG5cdFx0XHRcdCk7XG5cdFx0XHRcdHJldHVybiB7XG5cdFx0XHRcdFx0dmVyaWZ5OiAoXG5cdFx0XHRcdFx0XHRvdHA6IHN0cmluZyxcblx0XHRcdFx0XHRcdGNhbGxiYWNrOiAoXG5cdFx0XHRcdFx0XHRcdGVycjogRXJyb3IgfCBudWxsLFxuXHRcdFx0XHRcdFx0XHRkYXRhOiBZdWJSZXNwb25zZUludGVyZmFjZVxuXHRcdFx0XHRcdFx0KSA9PiB2b2lkXG5cdFx0XHRcdFx0KSA9PiB7XG5cdFx0XHRcdFx0XHRpZiAob3RwID09PSAndGVzdC1vdHAnKSB7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IHJlc3BvbnNlOiBZdWJSZXNwb25zZUludGVyZmFjZSA9IHtcblx0XHRcdFx0XHRcdFx0XHRzdGF0dXM6ICdPSydcblx0XHRcdFx0XHRcdFx0fTtcblx0XHRcdFx0XHRcdFx0Y2FsbGJhY2sobnVsbCwgcmVzcG9uc2UpO1xuXHRcdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFx0Y29uc3QgcmVzcG9uc2U6IFl1YlJlc3BvbnNlSW50ZXJmYWNlID0ge1xuXHRcdFx0XHRcdFx0XHRcdHN0YXR1czogJ0ZBSUwnXG5cdFx0XHRcdFx0XHRcdH07XG5cdFx0XHRcdFx0XHRcdGNhbGxiYWNrKG5ldyBFcnJvcignSW52YWxpZCBPVFAnKSwgcmVzcG9uc2UpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSBhcyBZdWJDbGllbnRJbnRlcmZhY2U7XG5cdFx0XHR9XG5cdFx0fSBhcyBZdWJpY29PVFBTZXJ2aWNlSW50ZXJmYWNlO1xuXHR9XG5cblx0cHVibGljIGluaXQoY2xpZW50SWQ6IHN0cmluZywgc2VjcmV0S2V5OiBzdHJpbmcpOiBZdWJDbGllbnRJbnRlcmZhY2Uge1xuXHRcdHJldHVybiB0aGlzLnl1Yi5pbml0KGNsaWVudElkLCBzZWNyZXRLZXkpIGFzIFl1YkNsaWVudEludGVyZmFjZTtcblx0fVxuXG5cdHB1YmxpYyBhc3luYyBpbml0aWFsaXplWXViaWNvT1RQKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGNvbnN0IGNhY2hlS2V5ID0gJ3l1Ymljb0NsaWVudCc7XG5cdFx0Y29uc3QgY2FjaGVkQ2xpZW50ID0gYXdhaXQgdGhpcy5jYWNoZVNlcnZpY2UuZ2V0KGNhY2hlS2V5LCAnYXV0aCcpO1xuXG5cdFx0aWYgKFxuXHRcdFx0Y2FjaGVkQ2xpZW50ICYmXG5cdFx0XHR0eXBlb2YgY2FjaGVkQ2xpZW50ID09PSAnb2JqZWN0JyAmJlxuXHRcdFx0J3ZlcmlmeScgaW4gY2FjaGVkQ2xpZW50XG5cdFx0KSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5kZWJ1ZygnTG9hZGVkIFl1YmljbyBDbGllbnQgZnJvbSBjYWNoZS4nKTtcblx0XHRcdHRoaXMueXViQ2xpZW50ID0gY2FjaGVkQ2xpZW50IGFzIFl1YkNsaWVudEludGVyZmFjZTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHR0cnkge1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnSW5pdGlhbGl6aW5nIFl1YmljbyBPVFAgVXRpbGl0eS4nKTtcblxuXHRcdFx0Y29uc3QgeXViaVNlY3JldHMgPSBhd2FpdCB0aGlzLnNlY3JldHMucmV0cmlldmVTZWNyZXRzKFxuXHRcdFx0XHRbJ1lVQklDT19DTElFTlRfSUQnLCAnWVVCSUNPX1NFQ1JFVF9LRVknXSxcblx0XHRcdFx0c2VjcmV0cyA9PiBzZWNyZXRzXG5cdFx0XHQpO1xuXG5cdFx0XHRpZiAoXG5cdFx0XHRcdHl1YmlTZWNyZXRzICYmXG5cdFx0XHRcdHR5cGVvZiB5dWJpU2VjcmV0cyA9PT0gJ29iamVjdCcgJiZcblx0XHRcdFx0IUFycmF5LmlzQXJyYXkoeXViaVNlY3JldHMpXG5cdFx0XHQpIHtcblx0XHRcdFx0Y29uc3QgeXViaWNvQ2xpZW50SWQgPVxuXHRcdFx0XHRcdHl1YmlTZWNyZXRzWydZVUJJQ09fQ0xJRU5UX0lEJ10/LnRvU3RyaW5nKCkgfHwgJyc7XG5cdFx0XHRcdGNvbnN0IHl1Ymljb1NlY3JldEtleSA9XG5cdFx0XHRcdFx0eXViaVNlY3JldHNbJ1lVQklDT19TRUNSRVRfS0VZJ10/LnRvU3RyaW5nKCkgfHwgJyc7XG5cblx0XHRcdFx0aWYgKCF5dWJpY29DbGllbnRJZCB8fCAheXViaWNvU2VjcmV0S2V5KSB7XG5cdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKFxuXHRcdFx0XHRcdFx0J1l1YmljbyBDbGllbnQgSUQgb3IgU2VjcmV0IEtleSBpcyBtaXNzaW5nJ1xuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRjb25zdCBpbml0aWFsaXplZENsaWVudCA9IHRoaXMueXViLmluaXQoXG5cdFx0XHRcdFx0eXViaWNvQ2xpZW50SWQsXG5cdFx0XHRcdFx0eXViaWNvU2VjcmV0S2V5XG5cdFx0XHRcdCk7XG5cblx0XHRcdFx0aWYgKGluaXRpYWxpemVkQ2xpZW50ICYmICd2ZXJpZnknIGluIGluaXRpYWxpemVkQ2xpZW50KSB7XG5cdFx0XHRcdFx0dGhpcy55dWJDbGllbnQgPSBpbml0aWFsaXplZENsaWVudCBhcyBZdWJDbGllbnRJbnRlcmZhY2U7XG5cblx0XHRcdFx0XHRhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5zZXQoXG5cdFx0XHRcdFx0XHRjYWNoZUtleSxcblx0XHRcdFx0XHRcdHRoaXMueXViQ2xpZW50LFxuXHRcdFx0XHRcdFx0J2F1dGgnLFxuXHRcdFx0XHRcdFx0dGhpcy50dGxcblx0XHRcdFx0XHQpO1xuXG5cdFx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0XHRcdCdZdWJpY28gT1RQIFV0aWxpdHkgc3VjY2Vzc2Z1bGx5IGluaXRpYWxpemVkLidcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR9XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byByZXRyaWV2ZSBZdWJpY28gc2VjcmV0cycpO1xuXHRcdFx0fVxuXHRcdH0gY2F0Y2ggKHV0aWxFcnJvcikge1xuXHRcdFx0Y29uc3QgdXRpbGl0eUVycm9yID1cblx0XHRcdFx0bmV3IHRoaXMuZXJyb3JIYW5kbGVyLkVycm9yQ2xhc3Nlcy5VdGlsaXR5RXJyb3JSZWNvdmVyYWJsZShcblx0XHRcdFx0XHRgRmFpbGVkIHRvIGluaXRpYWxpemUgWXViaWNvIE9UUCBVdGlsaXR5OiAke1xuXHRcdFx0XHRcdFx0dXRpbEVycm9yIGluc3RhbmNlb2YgRXJyb3Jcblx0XHRcdFx0XHRcdFx0PyB1dGlsRXJyb3IubWVzc2FnZVxuXHRcdFx0XHRcdFx0XHQ6IHV0aWxFcnJvclxuXHRcdFx0XHRcdH1gLFxuXHRcdFx0XHRcdHsgZXhwb3NlVG9DbGllbnQ6IGZhbHNlIH1cblx0XHRcdFx0KTtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nRXJyb3IodXRpbGl0eUVycm9yLm1lc3NhZ2UpO1xuXHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3IoeyBlcnJvcjogdXRpbGl0eUVycm9yIH0pO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyB2YWxpZGF0ZVl1Ymljb09UUChvdHA6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuXHRcdGNvbnN0IGNhY2hlS2V5ID0gYHl1Ymljb090cDoke290cH1gO1xuXHRcdGNvbnN0IGNhY2hlZFJlc3VsdCA9IGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLmdldChjYWNoZUtleSwgJ2F1dGgnKTtcblx0XHRpZiAoY2FjaGVkUmVzdWx0ICE9PSBudWxsKSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5kZWJ1ZygnTG9hZGVkIE9UUCB2YWxpZGF0aW9uIHJlc3VsdCBmcm9tIGNhY2hlLicpO1xuXHRcdFx0cmV0dXJuIGNhY2hlZFJlc3VsdCBhcyBib29sZWFuO1xuXHRcdH1cblxuXHRcdHRyeSB7XG5cdFx0XHRpZiAoIXRoaXMueXViQ2xpZW50KSB7XG5cdFx0XHRcdGF3YWl0IHRoaXMuaW5pdGlhbGl6ZVl1Ymljb09UUCgpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0XHR0aGlzLnl1YkNsaWVudCEudmVyaWZ5KFxuXHRcdFx0XHRcdG90cCxcblx0XHRcdFx0XHQodXRpbEVycm9yOiBFcnJvciB8IG51bGwsIGRhdGE6IFl1YlJlc3BvbnNlSW50ZXJmYWNlKSA9PiB7XG5cdFx0XHRcdFx0XHRpZiAodXRpbEVycm9yKSB7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IGlubmVyVXRpbEVycm9yID1cblx0XHRcdFx0XHRcdFx0XHRuZXcgdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JDbGFzc2VzLlV0aWxpdHlFcnJvclJlY292ZXJhYmxlKFxuXHRcdFx0XHRcdFx0XHRcdFx0YEZhaWxlZCB0byB2YWxpZGF0ZSBZdWJpY28gT1RQOiAke1xuXHRcdFx0XHRcdFx0XHRcdFx0XHR1dGlsRXJyb3IgaW5zdGFuY2VvZiBFcnJvclxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdD8gdXRpbEVycm9yLm1lc3NhZ2Vcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHQ6IFN0cmluZyh1dGlsRXJyb3IpXG5cdFx0XHRcdFx0XHRcdFx0XHR9YCxcblx0XHRcdFx0XHRcdFx0XHRcdHsgZXhwb3NlVG9DbGllbnQ6IGZhbHNlIH1cblx0XHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ1dhcm4oaW5uZXJVdGlsRXJyb3IubWVzc2FnZSk7XG5cdFx0XHRcdFx0XHRcdHRoaXMuZXJyb3JIYW5kbGVyLmhhbmRsZUVycm9yKHtcblx0XHRcdFx0XHRcdFx0XHRlcnJvcjogaW5uZXJVdGlsRXJyb3Jcblx0XHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRcdHJldHVybiByZWplY3QoaW5uZXJVdGlsRXJyb3IpO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRjb25zdCBpc1ZhbGlkID0gZGF0YSAmJiBkYXRhLnN0YXR1cyA9PT0gJ09LJztcblx0XHRcdFx0XHRcdHRoaXMubG9nZ2VyLmRlYnVnKFxuXHRcdFx0XHRcdFx0XHRgWXViaWNvIE9UUCB2YWxpZGF0aW9uICR7XG5cdFx0XHRcdFx0XHRcdFx0aXNWYWxpZCA/ICdzdWNjZXNzZnVsJyA6ICdmYWlsZWQnXG5cdFx0XHRcdFx0XHRcdH0uYFxuXHRcdFx0XHRcdFx0KTtcblxuXHRcdFx0XHRcdFx0dGhpcy5jYWNoZVNlcnZpY2Uuc2V0KFxuXHRcdFx0XHRcdFx0XHRjYWNoZUtleSxcblx0XHRcdFx0XHRcdFx0aXNWYWxpZCxcblx0XHRcdFx0XHRcdFx0J2F1dGgnLFxuXHRcdFx0XHRcdFx0XHR0aGlzLnR0bFxuXHRcdFx0XHRcdFx0KTtcblxuXHRcdFx0XHRcdFx0cmVzb2x2ZShpc1ZhbGlkKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdCk7XG5cdFx0XHR9KTtcblx0XHR9IGNhdGNoICh1dGlsRXJyb3IpIHtcblx0XHRcdGNvbnN0IHV0aWxpdHlFcnJvciA9XG5cdFx0XHRcdG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuVXRpbGl0eUVycm9yUmVjb3ZlcmFibGUoXG5cdFx0XHRcdFx0YEZhaWxlZCB0byB2YWxpZGF0ZSBZdWJpY28gT1RQOiAke1xuXHRcdFx0XHRcdFx0dXRpbEVycm9yIGluc3RhbmNlb2YgRXJyb3Jcblx0XHRcdFx0XHRcdFx0PyB1dGlsRXJyb3IubWVzc2FnZVxuXHRcdFx0XHRcdFx0XHQ6IHV0aWxFcnJvclxuXHRcdFx0XHRcdH1gLFxuXHRcdFx0XHRcdHsgZXhwb3NlVG9DbGllbnQ6IGZhbHNlIH1cblx0XHRcdFx0KTtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nV2Fybih1dGlsaXR5RXJyb3IubWVzc2FnZSk7XG5cdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7IGVycm9yOiB1dGlsaXR5RXJyb3IgfSk7XG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIGdlbmVyYXRlWXViaWNvT1RQT3B0aW9ucygpOiBQcm9taXNlPFl1Ymljb09UUE9wdGlvbnNJbnRlcmZhY2U+IHtcblx0XHR0cnkge1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnR2VuZXJhdGluZyBZdWJpY28gT1RQIG9wdGlvbnMuJyk7XG5cblx0XHRcdGNvbnN0IGFwaVVybCA9IHRoaXMuZW52Q29uZmlnLmdldEVudlZhcmlhYmxlKFxuXHRcdFx0XHQneXViaWNvQXBpVXJsJ1xuXHRcdFx0KSBhcyBzdHJpbmc7XG5cblx0XHRcdC8vIEF3YWl0IHRoZSByZXRyaWV2YWwgb2Ygc2VjcmV0c1xuXHRcdFx0Y29uc3QgeXViaVNlY3JldHMgPSBhd2FpdCB0aGlzLnNlY3JldHMucmV0cmlldmVTZWNyZXRzKFxuXHRcdFx0XHRbJ1lVQklDT19DTElFTlRfSUQnLCAnWVVCSUNPX1NFQ1JFVF9LRVknXSxcblx0XHRcdFx0c2VjcmV0cyA9PiBzZWNyZXRzXG5cdFx0XHQpO1xuXG5cdFx0XHRpZiAoXG5cdFx0XHRcdHl1YmlTZWNyZXRzICYmXG5cdFx0XHRcdHR5cGVvZiB5dWJpU2VjcmV0cyA9PT0gJ29iamVjdCcgJiZcblx0XHRcdFx0IUFycmF5LmlzQXJyYXkoeXViaVNlY3JldHMpXG5cdFx0XHQpIHtcblx0XHRcdFx0Y29uc3QgeXViaWNvQ2xpZW50SWQgPVxuXHRcdFx0XHRcdHl1YmlTZWNyZXRzWydZVUJJQ09fQ0xJRU5UX0lEJ10/LnRvU3RyaW5nKCkgfHwgJyc7XG5cdFx0XHRcdGNvbnN0IHl1Ymljb1NlY3JldEtleSA9XG5cdFx0XHRcdFx0eXViaVNlY3JldHNbJ1lVQklDT19TRUNSRVRfS0VZJ10/LnRvU3RyaW5nKCkgfHwgJyc7XG5cblx0XHRcdFx0aWYgKCF5dWJpY29DbGllbnRJZCB8fCAheXViaWNvU2VjcmV0S2V5KSB7XG5cdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKFxuXHRcdFx0XHRcdFx0J0ZhaWxlZCB0byByZXRyaWV2ZSBvciBkZWNyeXB0IFl1YmljbyBjbGllbnQgSUQgb3Igc2VjcmV0IGtleSdcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0XHRjbGllbnRJZDogcGFyc2VJbnQoeXViaWNvQ2xpZW50SWQsIDEwKSxcblx0XHRcdFx0XHRhcGlLZXk6IHl1Ymljb1NlY3JldEtleSxcblx0XHRcdFx0XHRhcGlVcmxcblx0XHRcdFx0fTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHJldHJpZXZlIFl1YmljbyBzZWNyZXRzJyk7XG5cdFx0XHR9XG5cdFx0fSBjYXRjaCAodXRpTEVycm9yKSB7XG5cdFx0XHRjb25zdCB1dGlsaXR5RXJyb3IgPVxuXHRcdFx0XHRuZXcgdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JDbGFzc2VzLlV0aWxpdHlFcnJvclJlY292ZXJhYmxlKFxuXHRcdFx0XHRcdGBGYWlsZWQgdG8gZ2VuZXJhdGUgWXViaWNvIE9UUCBvcHRpb25zOiAke1xuXHRcdFx0XHRcdFx0dXRpTEVycm9yIGluc3RhbmNlb2YgRXJyb3Jcblx0XHRcdFx0XHRcdFx0PyB1dGlMRXJyb3IubWVzc2FnZVxuXHRcdFx0XHRcdFx0XHQ6IHV0aUxFcnJvclxuXHRcdFx0XHRcdH07IFJldHVybmluZyBvYmplY3Qgd2l0aCBwbGFjZWhvbGRlciB2YWx1ZXMuYCxcblx0XHRcdFx0XHR7IGV4cG9zZVRvQ2xpZW50OiBmYWxzZSB9XG5cdFx0XHRcdCk7XG5cblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nV2Fybih1dGlsaXR5RXJyb3IubWVzc2FnZSk7XG5cdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVDcml0aWNhbEVycm9yKHsgZXJyb3I6IHV0aWxpdHlFcnJvciB9KTtcblxuXHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0Y2xpZW50SWQ6IDAsXG5cdFx0XHRcdGFwaUtleTogJycsXG5cdFx0XHRcdGFwaVVybDogJydcblx0XHRcdH07XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIHNodXRkb3duKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdHRyeSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdTaHV0dGluZyBkb3duIFl1Ymljb09UUFNlcnZpY2UuLi4nKTtcblxuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnQ2xlYXJpbmcgWXViaWNvT1RQU2VydmljZSBjYWNoZS4uLicpO1xuXHRcdFx0YXdhaXQgdGhpcy5jYWNoZVNlcnZpY2UuY2xlYXJOYW1lc3BhY2UoJ1l1Ymljb09UUFNlcnZpY2UnKTtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ1l1Ymljb09UUFNlcnZpY2UgY2FjaGUgY2xlYXJlZCBzdWNjZXNzZnVsbHkuJyk7XG5cblx0XHRcdHRoaXMueXViQ2xpZW50ID0gdW5kZWZpbmVkO1xuXHRcdFx0WXViaWNvT1RQU2VydmljZS5pbnN0YW5jZSA9IG51bGw7XG5cblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdCdZdWJpY29PVFBTZXJ2aWNlIHNodXRkb3duIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkuJ1xuXHRcdFx0KTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0Y29uc3QgdXRpbGl0eUVycm9yID1cblx0XHRcdFx0bmV3IHRoaXMuZXJyb3JIYW5kbGVyLkVycm9yQ2xhc3Nlcy5VdGlsaXR5RXJyb3JSZWNvdmVyYWJsZShcblx0XHRcdFx0XHRgRXJyb3IgZHVyaW5nIFl1Ymljb09UUFNlcnZpY2Ugc2h1dGRvd246ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcn1gXG5cdFx0XHRcdCk7XG5cdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKHV0aWxpdHlFcnJvci5tZXNzYWdlKTtcblx0XHRcdHRoaXMuZXJyb3JIYW5kbGVyLmhhbmRsZUVycm9yKHsgZXJyb3I6IHV0aWxpdHlFcnJvciB9KTtcblx0XHR9XG5cdH1cbn1cbiJdfQ==
