import '../../types/custom/yub.js';
import { processError } from '../utils/processError.mjs';
import { validateDependencies } from '../utils/validateDependencies.mjs';
export default function createYubicoOtpUtil({
	yub,
	getSecrets,
	logger,
	execSync,
	getDirectoryPath
}) {
	let secrets = null;
	let yubClient;
	validateDependencies(
		[
			{ name: 'yub', instance: yub },
			{ name: 'getSecrets', instance: getSecrets },
			{ name: 'logger', instance: logger },
			{ name: 'execSync', instance: execSync },
			{ name: 'getDirectoryPath', instance: getDirectoryPath }
		],
		logger
	);
	async function initializeYubicoOtpUtil() {
		try {
			logger.info('Initializing Yubico OTP Utility.');
			secrets = await getSecrets({ logger, execSync, getDirectoryPath });
			if (!secrets) {
				throw new Error('Secrets could not be loaded');
			}
			yubClient = yub.init(
				secrets.YUBICO_CLIENT_ID.toString(),
				secrets.YUBICO_SECRET_KEY
			);
			logger.info('Yubico OTP Utility initialized successfully.');
		} catch (error) {
			processError(error, logger);
			throw new Error(
				`Failed to initialize Yubico OTP Utility: ${error instanceof Error ? error.message : String(error)}`
			);
		}
	}
	async function validateYubicoOTP(otp) {
		try {
			if (!yubClient) {
				logger.warn('Yubico client not initialized, initializing now.');
				await initializeYubicoOtpUtil();
			}
			return new Promise((resolve, reject) => {
				yubClient.verify(otp, (error, data) => {
					if (error) {
						processError(error, logger);
						return reject(error);
					}
					if (data && data.status === 'OK') {
						logger.info('Yubico OTP validation successful.');
						resolve(true);
					} else {
						logger.info('Yubico OTP validation failed.');
						resolve(false);
					}
				});
			});
		} catch (error) {
			processError(error, logger);
			throw new Error(
				`Failed to validate Yubico OTP: ${error instanceof Error ? error.message : String(error)}`
			);
		}
	}
	function generateYubicoOtpOptions() {
		try {
			if (!secrets) {
				throw new Error('Secrets have not been initialized');
			}
			logger.info('Generating Yubico OTP options.');
			return {
				clientId: secrets.YUBICO_CLIENT_ID,
				apiKey: secrets.YUBICO_SECRET_KEY,
				apiUrl: secrets.YUBICO_API_URL
			};
		} catch (error) {
			processError(error, logger);
			throw new Error(
				`Failed to generate Yubico OTP options: ${error instanceof Error ? error.message : String(error)}`
			);
		}
	}
	return {
		initializeYubicoOtpUtil,
		validateYubicoOTP,
		generateYubicoOtpOptions
	};
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieXViaWNvT3RwVXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hdXRoL3l1Ymljb090cFV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTywyQkFBMkIsQ0FBQztBQUVuQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFckQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUE0QnJFLE1BQU0sQ0FBQyxPQUFPLFVBQVUsbUJBQW1CLENBQUMsRUFDM0MsR0FBRyxFQUNILFVBQVUsRUFDVixNQUFNLEVBQ04sUUFBUSxFQUNSLGdCQUFnQixFQUNRO0lBS3hCLElBQUksT0FBTyxHQUFzQixJQUFJLENBQUM7SUFDdEMsSUFBSSxTQUFnQyxDQUFDO0lBRXJDLG9CQUFvQixDQUNuQjtRQUNDLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFO1FBQzlCLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFO1FBQzVDLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFO1FBQ3BDLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFO1FBQ3hDLEVBQUUsSUFBSSxFQUFFLGtCQUFrQixFQUFFLFFBQVEsRUFBRSxnQkFBZ0IsRUFBRTtLQUN4RCxFQUNELE1BQU0sQ0FDTixDQUFDO0lBRUYsS0FBSyxVQUFVLHVCQUF1QjtRQUNyQyxJQUFJLENBQUM7WUFDSixNQUFNLENBQUMsSUFBSSxDQUFDLGtDQUFrQyxDQUFDLENBQUM7WUFDaEQsT0FBTyxHQUFHLE1BQU0sVUFBVSxDQUFDLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxnQkFBZ0IsRUFBRSxDQUFDLENBQUM7WUFFbkUsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNkLE1BQU0sSUFBSSxLQUFLLENB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QUFDO0lBQ0YsQ0FBQztJQUVELE9BQU87UUFDTix1QkFBdUI7UUFDdkIsaUJBQWlCO1FBQ2pCLHdCQUF3QjtLQUN4QixDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGV4ZWNTeW5jIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgeXViIGZyb20gJ3l1Yic7XG5pbXBvcnQgJy4uLy4uL3R5cGVzL2N1c3RvbS95dWIuanMnO1xuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSAnLi4vY29uZmlnL2xvZ2dlci5qcyc7XG5pbXBvcnQgeyBwcm9jZXNzRXJyb3IgfSBmcm9tICcuLi91dGlscy9wcm9jZXNzRXJyb3InO1xuaW1wb3J0IGdldFNlY3JldHMsIHsgU2VjcmV0c01hcCB9IGZyb20gJy4uL3V0aWxzL3NvcHMuanMnO1xuaW1wb3J0IHsgdmFsaWRhdGVEZXBlbmRlbmNpZXMgfSBmcm9tICcuLi91dGlscy92YWxpZGF0ZURlcGVuZGVuY2llcyc7XG5cbmludGVyZmFjZSBZdWJDbGllbnQge1xuXHR2ZXJpZnkoXG5cdFx0b3RwOiBzdHJpbmcsXG5cdFx0Y2FsbGJhY2s6IChlcnI6IEVycm9yIHwgbnVsbCwgZGF0YTogWXViUmVzcG9uc2UpID0+IHZvaWRcblx0KTogdm9pZDtcbn1cblxuaW50ZXJmYWNlIFl1YlJlc3BvbnNlIHtcblx0c3RhdHVzOiBzdHJpbmc7XG5cdFtrZXk6IHN0cmluZ106IHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfCBvYmplY3QgfCBudWxsIHwgdW5kZWZpbmVkO1xufVxuXG5pbnRlcmZhY2UgWXViaWNvT3RwT3B0aW9ucyB7XG5cdGNsaWVudElkOiBudW1iZXI7XG5cdGFwaUtleTogc3RyaW5nO1xuXHRhcGlVcmw6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIFl1Ymljb1V0aWxEZXBlbmRlbmNpZXMge1xuXHR5dWI6IHR5cGVvZiB5dWI7XG5cdGdldFNlY3JldHM6IHR5cGVvZiBnZXRTZWNyZXRzLmdldFNlY3JldHM7XG5cdGxvZ2dlcjogTG9nZ2VyO1xuXHRleGVjU3luYzogdHlwZW9mIGV4ZWNTeW5jO1xuXHRnZXREaXJlY3RvcnlQYXRoOiAoKSA9PiBzdHJpbmc7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGNyZWF0ZVl1Ymljb090cFV0aWwoe1xuXHR5dWIsXG5cdGdldFNlY3JldHMsXG5cdGxvZ2dlcixcblx0ZXhlY1N5bmMsXG5cdGdldERpcmVjdG9yeVBhdGhcbn06IFl1Ymljb1V0aWxEZXBlbmRlbmNpZXMpOiB7XG5cdGluaXRpYWxpemVZdWJpY29PdHBVdGlsOiAoKSA9PiBQcm9taXNlPHZvaWQ+O1xuXHR2YWxpZGF0ZVl1Ymljb09UUDogKG90cDogc3RyaW5nKSA9PiBQcm9taXNlPGJvb2xlYW4+O1xuXHRnZW5lcmF0ZVl1Ymljb090cE9wdGlvbnM6ICgpID0+IFl1Ymljb090cE9wdGlvbnM7XG59IHtcblx0bGV0IHNlY3JldHM6IFNlY3JldHNNYXAgfCBudWxsID0gbnVsbDtcblx0bGV0IHl1YkNsaWVudDogWXViQ2xpZW50IHwgdW5kZWZpbmVkO1xuXG5cdHZhbGlkYXRlRGVwZW5kZW5jaWVzKFxuXHRcdFtcblx0XHRcdHsgbmFtZTogJ3l1YicsIGluc3RhbmNlOiB5dWIgfSxcblx0XHRcdHsgbmFtZTogJ2dldFNlY3JldHMnLCBpbnN0YW5jZTogZ2V0U2VjcmV0cyB9LFxuXHRcdFx0eyBuYW1lOiAnbG9nZ2VyJywgaW5zdGFuY2U6IGxvZ2dlciB9LFxuXHRcdFx0eyBuYW1lOiAnZXhlY1N5bmMnLCBpbnN0YW5jZTogZXhlY1N5bmMgfSxcblx0XHRcdHsgbmFtZTogJ2dldERpcmVjdG9yeVBhdGgnLCBpbnN0YW5jZTogZ2V0RGlyZWN0b3J5UGF0aCB9XG5cdFx0XSxcblx0XHRsb2dnZXJcblx0KTtcblxuXHRhc3luYyBmdW5jdGlvbiBpbml0aWFsaXplWXViaWNvT3RwVXRpbCgpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHR0cnkge1xuXHRcdFx0bG9nZ2VyLmluZm8oJ0luaXRpYWxpemluZyBZdWJpY28gT1RQIFV0aWxpdHkuJyk7XG5cdFx0XHRzZWNyZXRzID0gYXdhaXQgZ2V0U2VjcmV0cyh7IGxvZ2dlciwgZXhlY1N5bmMsIGdldERpcmVjdG9yeVBhdGggfSk7XG5cblx0XHRcdGlmICghc2VjcmV0cykge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ1NlY3JldHMgY291bGQgbm90IGJlIGxvYWRlZCcpO1xuXHRcdFx0fVxuXG5cdFx0XHR5dWJDbGllbnQgPSB5dWIuaW5pdChcblx0XHRcdFx0c2VjcmV0cy5ZVUJJQ09fQ0xJRU5UX0lELnRvU3RyaW5nKCksXG5cdFx0XHRcdHNlY3JldHMuWVVCSUNPX1NFQ1JFVF9LRVlcblx0XHRcdCkgYXMgWXViQ2xpZW50O1xuXG5cdFx0XHRsb2dnZXIuaW5mbygnWXViaWNvIE9UUCBVdGlsaXR5IGluaXRpYWxpemVkIHN1Y2Nlc3NmdWxseS4nKTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0cHJvY2Vzc0Vycm9yKGVycm9yLCBsb2dnZXIpO1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFxuXHRcdFx0XHRgRmFpbGVkIHRvIGluaXRpYWxpemUgWXViaWNvIE9UUCBVdGlsaXR5OiAke1xuXHRcdFx0XHRcdGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKVxuXHRcdFx0XHR9YFxuXHRcdFx0KTtcblx0XHR9XG5cdH1cblxuXHRhc3luYyBmdW5jdGlvbiB2YWxpZGF0ZVl1Ymljb09UUChvdHA6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuXHRcdHRyeSB7XG5cdFx0XHRpZiAoIXl1YkNsaWVudCkge1xuXHRcdFx0XHRsb2dnZXIud2FybignWXViaWNvIGNsaWVudCBub3QgaW5pdGlhbGl6ZWQsIGluaXRpYWxpemluZyBub3cuJyk7XG5cdFx0XHRcdGF3YWl0IGluaXRpYWxpemVZdWJpY29PdHBVdGlsKCk7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0XHRcdHl1YkNsaWVudCEudmVyaWZ5KFxuXHRcdFx0XHRcdG90cCxcblx0XHRcdFx0XHQoZXJyb3I6IEVycm9yIHwgbnVsbCwgZGF0YTogWXViUmVzcG9uc2UpID0+IHtcblx0XHRcdFx0XHRcdGlmIChlcnJvcikge1xuXHRcdFx0XHRcdFx0XHRwcm9jZXNzRXJyb3IoZXJyb3IsIGxvZ2dlcik7XG5cdFx0XHRcdFx0XHRcdHJldHVybiByZWplY3QoZXJyb3IpO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRpZiAoZGF0YSAmJiBkYXRhLnN0YXR1cyA9PT0gJ09LJykge1xuXHRcdFx0XHRcdFx0XHRsb2dnZXIuaW5mbygnWXViaWNvIE9UUCB2YWxpZGF0aW9uIHN1Y2Nlc3NmdWwuJyk7XG5cdFx0XHRcdFx0XHRcdHJlc29sdmUodHJ1ZSk7XG5cdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRsb2dnZXIuaW5mbygnWXViaWNvIE9UUCB2YWxpZGF0aW9uIGZhaWxlZC4nKTtcblx0XHRcdFx0XHRcdFx0cmVzb2x2ZShmYWxzZSk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHQpO1xuXHRcdFx0fSk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHByb2Nlc3NFcnJvcihlcnJvciwgbG9nZ2VyKTtcblx0XHRcdHRocm93IG5ldyBFcnJvcihcblx0XHRcdFx0YEZhaWxlZCB0byB2YWxpZGF0ZSBZdWJpY28gT1RQOiAke1xuXHRcdFx0XHRcdGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKVxuXHRcdFx0XHR9YFxuXHRcdFx0KTtcblx0XHR9XG5cdH1cblxuXHRmdW5jdGlvbiBnZW5lcmF0ZVl1Ymljb090cE9wdGlvbnMoKTogWXViaWNvT3RwT3B0aW9ucyB7XG5cdFx0dHJ5IHtcblx0XHRcdGlmICghc2VjcmV0cykge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ1NlY3JldHMgaGF2ZSBub3QgYmVlbiBpbml0aWFsaXplZCcpO1xuXHRcdFx0fVxuXG5cdFx0XHRsb2dnZXIuaW5mbygnR2VuZXJhdGluZyBZdWJpY28gT1RQIG9wdGlvbnMuJyk7XG5cdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRjbGllbnRJZDogc2VjcmV0cy5ZVUJJQ09fQ0xJRU5UX0lEIGFzIG51bWJlcixcblx0XHRcdFx0YXBpS2V5OiBzZWNyZXRzLllVQklDT19TRUNSRVRfS0VZIGFzIHN0cmluZyxcblx0XHRcdFx0YXBpVXJsOiBzZWNyZXRzLllVQklDT19BUElfVVJMIGFzIHN0cmluZ1xuXHRcdFx0fTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0cHJvY2Vzc0Vycm9yKGVycm9yLCBsb2dnZXIpO1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFxuXHRcdFx0XHRgRmFpbGVkIHRvIGdlbmVyYXRlIFl1YmljbyBPVFAgb3B0aW9uczogJHtcblx0XHRcdFx0XHRlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcilcblx0XHRcdFx0fWBcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIHtcblx0XHRpbml0aWFsaXplWXViaWNvT3RwVXRpbCxcblx0XHR2YWxpZGF0ZVl1Ymljb09UUCxcblx0XHRnZW5lcmF0ZVl1Ymljb090cE9wdGlvbnNcblx0fTtcbn1cbiJdfQ==
