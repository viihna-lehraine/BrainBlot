import { Fido2Lib } from 'fido2-lib';
import { validateDependencies } from '../utils/helpers.mjs';
import { ServiceFactory } from '../index/factory.mjs';
import { serviceTTLConfig } from '../config/cache.mjs';
import '../../types/custom/yub.js';
export class FIDO2Service {
	static instance = null;
	FIDO2 = null;
	logger;
	errorLogger;
	errorHandler;
	envConfig;
	cacheService;
	timeout;
	constructor() {
		this.timeout = this.envConfig.getEnvVariable('fido2Timeout') || 50000;
	}
	static async getInstance() {
		if (!FIDO2Service.instance) {
			const errorLogger = await ServiceFactory.getErrorLoggerService();
			const errorHandler = await ServiceFactory.getErrorHandlerService();
			const envConfig = await ServiceFactory.getEnvConfigService();
			const cacheService = await ServiceFactory.getCacheService();
			const logger = await ServiceFactory.getLoggerService();
			FIDO2Service.instance = new FIDO2Service();
			FIDO2Service.instance.errorLogger = errorLogger;
			FIDO2Service.instance.errorHandler = errorHandler;
			FIDO2Service.instance.envConfig = envConfig;
			FIDO2Service.instance.cacheService = cacheService;
			FIDO2Service.instance.logger = logger;
		}
		return FIDO2Service.instance;
	}
	async initializeFIDO2Service() {
		const cacheKey = 'FIDO2Lib';
		const cachedFIDO2Lib = await this.cacheService.get(cacheKey, 'auth');
		if (cachedFIDO2Lib) {
			this.FIDO2 = cachedFIDO2Lib;
			this.logger.debug('Loaded Fido2Lib from cache.');
			return;
		}
		try {
			const rpId = this.envConfig.getEnvVariable('rpId');
			const rpName = this.envConfig.getEnvVariable('rpName');
			const challengeSize =
				this.envConfig.getEnvVariable('fidoChallengeSize');
			const cryptoParams =
				this.envConfig.getEnvVariable('fidoCryptoParams');
			const requireResidentKey = this.envConfig.getEnvVariable(
				'fidoAuthRequireResidentKey'
			);
			const userVerification = this.envConfig.getEnvVariable(
				'fidoAuthUserVerification'
			);
			const validUserVerificationValues = [
				'required',
				'preferred',
				'discouraged'
			];
			const timeout = this.timeout;
			if (!validUserVerificationValues.includes(userVerification)) {
				throw new Error(
					'Invalid value for authenticatorUserVerification'
				);
			}
			this.FIDO2 = new Fido2Lib({
				timeout,
				rpId,
				rpName,
				challengeSize,
				cryptoParams,
				authenticatorRequireResidentKey: requireResidentKey,
				authenticatorUserVerification: userVerification
			});
			await this.cacheService.set(
				cacheKey,
				this.FIDO2,
				'auth',
				serviceTTLConfig.FIDO2 || serviceTTLConfig.default
			);
			this.logger.info('Fido2Lib initialized successfully.');
		} catch (error) {
			this.handleError('initializeFido2', error);
		}
	}
	async ensureInitialized() {
		validateDependencies(
			[{ name: 'logger', instance: this.logger }],
			this.logger
		);
		if (!this.FIDO2) {
			this.logger.debug('Fido2Lib is not initialized, initializing now.');
			await this.initializeFIDO2Service();
		} else {
			this.logger.debug('Fido2Lib is already initialized.');
		}
	}
	async generateFIDO2RegistrationOptions(user) {
		const cacheKey = `FIDO2Registration:${user.id}`;
		const cachedOptions = await this.cacheService.get(cacheKey, 'auth');
		if (cachedOptions) {
			this.logger.debug('Loaded registration options from cache.');
			return cachedOptions;
		}
		try {
			validateDependencies(
				[{ name: 'user', instance: user }],
				this.logger
			);
			await this.ensureInitialized();
			const timeout = this.timeout;
			const passkeyRegistrationOptions =
				await this.FIDO2.attestationOptions();
			const registrationOptions = {
				...passkeyRegistrationOptions,
				user: {
					id: Buffer.from(user.id, 'utf-8'),
					name: user.email,
					displayName: user.username
				},
				pubKeyCredParams: [{ type: 'public-key', alg: -7 }],
				timeout,
				attestation: 'direct',
				authenticatorSelection: {
					authenticatorAttachment: 'platform',
					requireResidentKey: true,
					userVerification: 'preferred'
				}
			};
			await this.cacheService.set(
				cacheKey,
				registrationOptions,
				'auth',
				serviceTTLConfig.FIDO2Registration || serviceTTLConfig.default
			);
			this.logger.info(
				'Passkey registration options generated successfully.'
			);
			return registrationOptions;
		} catch (error) {
			this.handleError('generateRegistrationOptions', error);
			return {};
		}
	}
	async verifyFIDO2Registration(attestation, expectedChallenge) {
		try {
			validateDependencies(
				[
					{ name: 'attestation', instance: attestation },
					{ name: 'expectedChallenge', instance: expectedChallenge }
				],
				this.logger
			);
			await this.ensureInitialized();
			const u2fAttestationExpectations = {
				challenge: expectedChallenge,
				origin: this.envConfig.getEnvVariable('rpOrigin'),
				factor: 'either',
				rpId: this.envConfig.getEnvVariable('rpId')
			};
			const result = await this.FIDO2.attestationResult(
				attestation,
				u2fAttestationExpectations
			);
			this.logger.info('Passkey registration verified successfully.');
			return result;
		} catch (error) {
			this.handleError('verifyRegistration', error);
			return {};
		}
	}
	async generateFIDO2AuthenticationOptions(user) {
		const cacheKey = `FIDO2Auth:${user.id}`;
		const cachedOptions = await this.cacheService.get(cacheKey, 'auth');
		if (cachedOptions) {
			this.logger.debug('Loaded authentication options from cache.');
			return cachedOptions;
		}
		try {
			await this.ensureInitialized();
			const userCredentials = user.credential.map(credential => ({
				type: 'public-key',
				id: Buffer.from(credential.credentialId, 'base64').buffer
			}));
			const assertionOptions = await this.FIDO2.assertionOptions();
			const authenticationOptions = {
				...assertionOptions,
				allowCredentials: userCredentials,
				userVerification: 'required',
				timeout: 60000
			};
			await this.cacheService.set(
				cacheKey,
				authenticationOptions,
				'auth',
				serviceTTLConfig.FIDO2Authentication || serviceTTLConfig.default
			);
			this.logger.info(
				'Passkey authentication options generated successfully.'
			);
			return authenticationOptions;
		} catch (error) {
			this.handleError('generateAuthenticationOptions', error);
			return {};
		}
	}
	async verifyAuthentication(
		assertion,
		expectedChallenge,
		publicKey,
		previousCounter,
		id
	) {
		try {
			validateDependencies(
				[
					{ name: 'assertion', instance: assertion },
					{ name: 'expectedChallenge', instance: expectedChallenge },
					{ name: 'publicKey', instance: publicKey },
					{ name: 'previousCounter', instance: previousCounter },
					{ name: 'id', instance: id }
				],
				this.logger
			);
			await this.ensureInitialized();
			const assertionExpectations = {
				challenge: expectedChallenge,
				origin: this.envConfig.getEnvVariable('rpOrigin'),
				factor: 'either',
				publicKey,
				prevCounter: previousCounter,
				userHandle: id
			};
			const result = await this.FIDO2.assertionResult(
				assertion,
				assertionExpectations
			);
			this.logger.info('Passkey authentication verified successfully.');
			return result;
		} catch (error) {
			this.handleError('verifyAuthentication', error);
			return {};
		}
	}
	// *DEV-NOTE* use, for example, when user updates credentials
	async invalidateFido2Cache(userId, action) {
		const cacheKeyRegistration = `FIDO2Registration:${userId}`;
		const cacheKeyAuth = `FIDO2Auth:${userId}`;
		this.logger.info(
			`Invalidating FIDO2 cache for user ${userId} due to ${action}`
		);
		try {
			await this.cacheService.del(cacheKeyRegistration, 'auth');
			await this.cacheService.del(cacheKeyAuth, 'auth');
			this.logger.info(`FIDO2 cache invalidated for user ${userId}`);
		} catch (error) {
			this.handleError('invalidateFido2Cache', error);
		}
	}
	async shutdown() {
		try {
			if (this.FIDO2) {
				this.logger.info(
					'Clearing FIDO2Lib and cache entries before shutdown...'
				);
				this.FIDO2 = null;
				await this.cacheService.del('FIDO2Lib', 'auth');
				this.logger.info(
					'FIDO2 cache and instance cleared successfully.'
				);
				FIDO2Service.instance = null;
				this.logger.info('FIDO2Service shut down successfully.');
			} else {
				this.logger.info(
					'FIDO2Service is already shut down or uninitialized.'
				);
			}
		} catch (error) {
			this.handleError('shutdown', error);
		}
	}
	async handleError(utility, error) {
		const errorMessage = `Error in ${utility}: ${error instanceof Error ? error.message : error}`;
		this.errorLogger.logError(errorMessage);
		const utilityError =
			new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
				errorMessage,
				{
					exposeToClient: false
				}
			);
		this.errorHandler.handleError({ error: utilityError });
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRklETzIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYXV0aC9GSURPMi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBSU4sUUFBUSxFQVFSLE1BQU0sV0FBVyxDQUFDO0FBV25CLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUVuRCxPQUFPLDJCQUEyQixDQUFDO0FBRW5DLE1BQU0sT0FBTyxZQUFZO0lBQ2hCLE1BQU0sQ0FBQyxRQUFRLEdBQXdCLElBQUksQ0FBQztJQUM1QyxLQUFLLEdBQW9CLElBQUksQ0FBQztJQUM5QixNQUFNLENBQTZCO0lBQ25DLFdBQVcsQ0FBK0I7SUFDMUMsWUFBWSxDQUFnQztJQUM1QyxTQUFTLENBQTZCO0lBQ3RDLFlBQVksQ0FBeUI7SUFDckMsT0FBTyxDQUFTO0lBRXhCO1FBQ0MsSUFBSSxDQUFDLE9BQU87WUFDVixJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxjQUFjLENBQVksSUFBSSxLQUFLLENBQUM7SUFDckUsQ0FBQztJQUVNLE1BQU0sQ0FBQyxLQUFLLENBQUMsV0FBVztRQUM5QixJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQzVCLE1BQU0sV0FBVyxHQUFHLE1BQU0sY0FBYyxDQUFDLHFCQUFxQixFQUFFLENBQUM7WUFDakUsTUFBTSxZQUFZLEdBQUcsTUFBTSxjQUFjLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztZQUNuRSxNQUFNLFNBQVMsR0FBRyxNQUFNLGNBQWMsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1lBQzdELE1BQU0sWUFBWSxHQUFHLE1BQU0sY0FBYyxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQzVELE1BQU0sTUFBTSxHQUFHLE1BQU0sY0FBYyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFFdkQsWUFBWSxDQUFDLFFBQVEsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1lBQzNDLFlBQVksQ0FBQyxRQUFRLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQztZQUNoRCxZQUFZLENBQUMsUUFBUSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUM7WUFDbEQsWUFBWSxDQUFDLFFBQVEsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1lBQzVDLFlBQVksQ0FBQyxRQUFRLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztZQUNsRCxZQUFZLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDdkMsQ0FBQztRQUVELE9BQU8sWUFBWSxDQUFDLFFBQVEsQ0FBQztJQUM5QixDQUFDO0lBRU0sS0FBSyxDQUFDLHNCQUFzQjtRQUNsQyxNQUFNLFFBQVEsR0FBRyxVQUFVLENBQUM7UUFDNUIsTUFBTSxjQUFjLEdBQUcsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFckUsSUFBSSxjQUFjLEVBQUUsQ0FBQztZQUNwQixJQUFJLENBQUMsS0FBSyxHQUFHLGNBQTBCLENBQUM7WUFDeEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsNkJBQTZCLENBQUMsQ0FBQztZQUNqRCxPQUFPO1FBQ1IsQ0FBQztRQUVELElBQUksQ0FBQztZQUNKLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ25ELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3ZELE1BQU0sYUFBYSxHQUNsQixJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1lBQ3BELE1BQU0sWUFBWSxHQUNqQixJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQ25ELE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQ3ZELDRCQUE0QixDQUM1QixDQUFDO1lBQ0YsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FDckQsMEJBQTBCLENBQzFCLENBQUM7WUFDRixNQUFNLDJCQUEyQixHQUF1QjtnQkFDdkQsVUFBVTtnQkFDVixXQUFXO2dCQUNYLGFBQWE7YUFDYixDQUFDO1lBQ0YsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUU3QixJQUNDLENBQUMsMkJBQTJCLENBQUMsUUFBUSxDQUNwQyxnQkFBb0MsQ0FDcEMsRUFDQSxDQUFDO2dCQUNGLE1BQU0sSUFBSSxLQUFLLENBQ2QsaURBQWlELENBQ2pELENBQUM7WUFDSCxDQUFDO1lBRUQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLFFBQVEsQ0FBQztnQkFDekIsT0FBTztnQkFDUCxJQUFJO2dCQUNKLE1BQU07Z0JBQ04sYUFBYTtnQkFDYixZQUFZO2dCQUNaLCtCQUErQixFQUFFLGtCQUFrQjtnQkFDbkQsNkJBQTZCLEVBQzVCLGdCQUFvQzthQUNyQyxDQUFDLENBQUM7WUFDSCxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUMxQixRQUFRLEVBQ1IsSUFBSSxDQUFDLEtBQUssRUFDVixNQUFNLEVBQ04sZ0JBQWdCLENBQUMsS0FBSyxJQUFJLGdCQUFnQixDQUFDLE9BQU8sQ0FDbEQsQ0FBQztZQUVGLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLG9DQUFvQyxDQUFDLENBQUM7UUFDeEQsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDaEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUM1QyxDQUFDO0lBQ0YsQ0FBQztJQUVNLEtBQUssQ0FBQyxpQkFBaUI7UUFDN0Isb0JBQW9CLENBQ25CLENBQUMsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFDM0MsSUFBSSxDQUFDLE1BQU0sQ0FDWCxDQUFDO1FBQ0YsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNqQixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDO1lBQ3BFLE1BQU0sSUFBSSxDQUFDLHNCQUFzQixFQUFFLENBQUM7UUFDckMsQ0FBQzthQUFNLENBQUM7WUFDUCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO1FBQ3ZELENBQUM7SUFDRixDQUFDO0lBRU0sS0FBSyxDQUFDLGdDQUFnQyxDQUM1QyxJQUF1QjtRQUV2QixNQUFNLFFBQVEsR0FBRyxxQkFBcUIsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ2hELE1BQU0sYUFBYSxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRXBFLElBQUksYUFBYSxFQUFFLENBQUM7WUFDbkIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMseUNBQXlDLENBQUMsQ0FBQztZQUM3RCxPQUFPLGFBQW1ELENBQUM7UUFDNUQsQ0FBQztRQUVELElBQUksQ0FBQztZQUNKLG9CQUFvQixDQUNuQixDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFDbEMsSUFBSSxDQUFDLE1BQU0sQ0FDWCxDQUFDO1lBRUYsTUFBTSxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztZQUUvQixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQzdCLE1BQU0sMEJBQTBCLEdBQy9CLE1BQU0sSUFBSSxDQUFDLEtBQU0sQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1lBQ3hDLE1BQU0sbUJBQW1CLEdBQXVDO2dCQUMvRCxHQUFHLDBCQUEwQjtnQkFDN0IsSUFBSSxFQUFFO29CQUNMLEVBQUUsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDO29CQUNqQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUs7b0JBQ2hCLFdBQVcsRUFBRSxJQUFJLENBQUMsUUFBUTtpQkFDMUI7Z0JBQ0QsZ0JBQWdCLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUM7Z0JBQ25ELE9BQU87Z0JBQ1AsV0FBVyxFQUFFLFFBQVE7Z0JBQ3JCLHNCQUFzQixFQUFFO29CQUN2Qix1QkFBdUIsRUFBRSxVQUFVO29CQUNuQyxrQkFBa0IsRUFBRSxJQUFJO29CQUN4QixnQkFBZ0IsRUFBRSxXQUFXO2lCQUM3QjthQUNELENBQUM7WUFFRixNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUMxQixRQUFRLEVBQ1IsbUJBQW1CLEVBQ25CLE1BQU0sRUFDTixnQkFBZ0IsQ0FBQyxpQkFBaUIsSUFBSSxnQkFBZ0IsQ0FBQyxPQUFPLENBQzlELENBQUM7WUFDRixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDZixzREFBc0QsQ0FDdEQsQ0FBQztZQUNGLE9BQU8sbUJBQW1CLENBQUM7UUFDNUIsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDaEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyw2QkFBNkIsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUN2RCxPQUFPLEVBQXdDLENBQUM7UUFDakQsQ0FBQztJQUNGLENBQUM7SUFFTSxLQUFLLENBQUMsdUJBQXVCLENBQ25DLFdBQThCLEVBQzlCLGlCQUF5QjtRQUV6QixJQUFJLENBQUM7WUFDSixvQkFBb0IsQ0FDbkI7Z0JBQ0MsRUFBRSxJQUFJLEVBQUUsYUFBYSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUU7Z0JBQzlDLEVBQUUsSUFBSSxFQUFFLG1CQUFtQixFQUFFLFFBQVEsRUFBRSxpQkFBaUIsRUFBRTthQUMxRCxFQUNELElBQUksQ0FBQyxNQUFNLENBQ1gsQ0FBQztZQUNGLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFFL0IsTUFBTSwwQkFBMEIsR0FBOEI7Z0JBQzdELFNBQVMsRUFBRSxpQkFBaUI7Z0JBQzVCLE1BQU0sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUM7Z0JBQ2pELE1BQU0sRUFBRSxRQUFzQjtnQkFDOUIsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQzthQUMzQyxDQUFDO1lBRUYsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsS0FBTSxDQUFDLGlCQUFpQixDQUNqRCxXQUFXLEVBQ1gsMEJBQTBCLENBQzFCLENBQUM7WUFDRixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO1lBQ2hFLE9BQU8sTUFBZ0MsQ0FBQztRQUN6QyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNoQixJQUFJLENBQUMsV0FBVyxDQUFDLG9CQUFvQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzlDLE9BQU8sRUFBNEIsQ0FBQztRQUNyQyxDQUFDO0lBQ0YsQ0FBQztJQUVNLEtBQUssQ0FBQyxrQ0FBa0MsQ0FDOUMsSUFBdUI7UUFFdkIsTUFBTSxRQUFRLEdBQUcsYUFBYSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDeEMsTUFBTSxhQUFhLEdBQUcsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFcEUsSUFBSSxhQUFhLEVBQUUsQ0FBQztZQUNuQixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDO1lBQy9ELE9BQU8sYUFBa0QsQ0FBQztRQUMzRCxDQUFDO1FBRUQsSUFBSSxDQUFDO1lBQ0osTUFBTSxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztZQUUvQixNQUFNLGVBQWUsR0FDcEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUNsQyxJQUFJLEVBQUUsWUFBWTtnQkFDbEIsRUFBRSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksRUFBRSxRQUFRLENBQUMsQ0FBQyxNQUFNO2FBQ3pELENBQUMsQ0FBQyxDQUFDO1lBRUwsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLElBQUksQ0FBQyxLQUFNLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUM5RCxNQUFNLHFCQUFxQixHQUFzQztnQkFDaEUsR0FBRyxnQkFBZ0I7Z0JBQ25CLGdCQUFnQixFQUFFLGVBQWU7Z0JBQ2pDLGdCQUFnQixFQUFFLFVBQVU7Z0JBQzVCLE9BQU8sRUFBRSxLQUFLO2FBQ2QsQ0FBQztZQUVGLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQzFCLFFBQVEsRUFDUixxQkFBcUIsRUFDckIsTUFBTSxFQUNOLGdCQUFnQixDQUFDLG1CQUFtQixJQUFJLGdCQUFnQixDQUFDLE9BQU8sQ0FDaEUsQ0FBQztZQUNGLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNmLHdEQUF3RCxDQUN4RCxDQUFDO1lBQ0YsT0FBTyxxQkFBcUIsQ0FBQztRQUM5QixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNoQixJQUFJLENBQUMsV0FBVyxDQUFDLCtCQUErQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3pELE9BQU8sRUFBdUMsQ0FBQztRQUNoRCxDQUFDO0lBQ0YsQ0FBQztJQUVNLEtBQUssQ0FBQyxvQkFBb0IsQ0FDaEMsU0FBMEIsRUFDMUIsaUJBQXlCLEVBQ3pCLFNBQWlCLEVBQ2pCLGVBQXVCLEVBQ3ZCLEVBQVU7UUFFVixJQUFJLENBQUM7WUFDSixvQkFBb0IsQ0FDbkI7Z0JBQ0MsRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUU7Z0JBQzFDLEVBQUUsSUFBSSxFQUFFLG1CQUFtQixFQUFFLFFBQVEsRUFBRSxpQkFBaUIsRUFBRTtnQkFDMUQsRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUU7Z0JBQzFDLEVBQUUsSUFBSSxFQUFFLGlCQUFpQixFQUFFLFFBQVEsRUFBRSxlQUFlLEVBQUU7Z0JBQ3RELEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFO2FBQzVCLEVBQ0QsSUFBSSxDQUFDLE1BQU0sQ0FDWCxDQUFDO1lBQ0YsTUFBTSxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztZQUUvQixNQUFNLHFCQUFxQixHQUE0QjtnQkFDdEQsU0FBUyxFQUFFLGlCQUFpQjtnQkFDNUIsTUFBTSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQztnQkFDakQsTUFBTSxFQUFFLFFBQXNCO2dCQUM5QixTQUFTO2dCQUNULFdBQVcsRUFBRSxlQUFlO2dCQUM1QixVQUFVLEVBQUUsRUFBRTthQUNkLENBQUM7WUFFRixNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxLQUFNLENBQUMsZUFBZSxDQUMvQyxTQUFTLEVBQ1QscUJBQXFCLENBQ3JCLENBQUM7WUFDRixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQywrQ0FBK0MsQ0FBQyxDQUFDO1lBQ2xFLE9BQU8sTUFBOEIsQ0FBQztRQUN2QyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNoQixJQUFJLENBQUMsV0FBVyxDQUFDLHNCQUFzQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ2hELE9BQU8sRUFBMEIsQ0FBQztRQUNuQyxDQUFDO0lBQ0YsQ0FBQztJQUVELDZEQUE2RDtJQUN0RCxLQUFLLENBQUMsb0JBQW9CLENBQ2hDLE1BQWMsRUFDZCxNQUFjO1FBRWQsTUFBTSxvQkFBb0IsR0FBRyxxQkFBcUIsTUFBTSxFQUFFLENBQUM7UUFDM0QsTUFBTSxZQUFZLEdBQUcsYUFBYSxNQUFNLEVBQUUsQ0FBQztRQUUzQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDZixxQ0FBcUMsTUFBTSxXQUFXLE1BQU0sRUFBRSxDQUM5RCxDQUFDO1FBRUYsSUFBSSxDQUFDO1lBQ0osTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUMxRCxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxNQUFNLENBQUMsQ0FBQztZQUVsRCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxvQ0FBb0MsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUNoRSxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNoQixJQUFJLENBQUMsV0FBVyxDQUFDLHNCQUFzQixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2pELENBQUM7SUFDRixDQUFDO0lBRU0sS0FBSyxDQUFDLFFBQVE7UUFDcEIsSUFBSSxDQUFDO1lBQ0osSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7Z0JBQ2hCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNmLHdEQUF3RCxDQUN4RCxDQUFDO2dCQUNGLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO2dCQUVsQixNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQztnQkFDaEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQ2YsZ0RBQWdELENBQ2hELENBQUM7Z0JBQ0YsWUFBWSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7Z0JBQzdCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLHNDQUFzQyxDQUFDLENBQUM7WUFDMUQsQ0FBQztpQkFBTSxDQUFDO2dCQUNQLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNmLHFEQUFxRCxDQUNyRCxDQUFDO1lBQ0gsQ0FBQztRQUNGLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2hCLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3JDLENBQUM7SUFDRixDQUFDO0lBRU8sS0FBSyxDQUFDLFdBQVcsQ0FBQyxPQUFlLEVBQUUsS0FBYztRQUN4RCxNQUFNLFlBQVksR0FBRyxZQUFZLE9BQU8sS0FBSyxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUM5RixJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUN4QyxNQUFNLFlBQVksR0FDakIsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyx1QkFBdUIsQ0FDekQsWUFBWSxFQUNaO1lBQ0MsY0FBYyxFQUFFLEtBQUs7U0FDckIsQ0FDRCxDQUFDO1FBQ0gsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQztJQUN4RCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcblx0QXR0ZXN0YXRpb25SZXN1bHQsXG5cdEV4cGVjdGVkQXNzZXJ0aW9uUmVzdWx0LFxuXHRFeHBlY3RlZEF0dGVzdGF0aW9uUmVzdWx0LFxuXHRGaWRvMkxpYixcblx0UHVibGljS2V5Q3JlZGVudGlhbENyZWF0aW9uT3B0aW9ucyxcblx0UHVibGljS2V5Q3JlZGVudGlhbERlc2NyaXB0b3IsXG5cdFB1YmxpY0tleUNyZWRlbnRpYWxSZXF1ZXN0T3B0aW9ucyxcblx0RmlkbzJBdHRlc3RhdGlvblJlc3VsdCxcblx0RmlkbzJBc3NlcnRpb25SZXN1bHQsXG5cdEFzc2VydGlvblJlc3VsdCxcblx0VXNlclZlcmlmaWNhdGlvblxufSBmcm9tICdmaWRvMi1saWInO1xuaW1wb3J0IHtcblx0QXBwTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0Q2FjaGVTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFbnZDb25maWdTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdEZJRE8yU2VydmljZUludGVyZmFjZVxufSBmcm9tICcuLi9pbmRleC9pbnRlcmZhY2VzL3NlcnZpY2VzJztcbmltcG9ydCB7IEZpZG9Vc2VySW50ZXJmYWNlIH0gZnJvbSAnLi4vaW5kZXgvaW50ZXJmYWNlcy9zZXJ2aWNlQ29tcG9uZW50cyc7XG5pbXBvcnQgeyBGaWRvRmFjdG9yIH0gZnJvbSAnLi4vaW5kZXgvaW50ZXJmYWNlcy90eXBlcyc7XG5pbXBvcnQgeyB2YWxpZGF0ZURlcGVuZGVuY2llcyB9IGZyb20gJy4uL3V0aWxzL2hlbHBlcnMnO1xuaW1wb3J0IHsgU2VydmljZUZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5JztcbmltcG9ydCB7IHNlcnZpY2VUVExDb25maWcgfSBmcm9tICcuLi9jb25maWcvY2FjaGUnO1xuXG5pbXBvcnQgJy4uLy4uL3R5cGVzL2N1c3RvbS95dWIuanMnO1xuXG5leHBvcnQgY2xhc3MgRklETzJTZXJ2aWNlIGltcGxlbWVudHMgRklETzJTZXJ2aWNlSW50ZXJmYWNlIHtcblx0cHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IEZJRE8yU2VydmljZSB8IG51bGwgPSBudWxsO1xuXHRwcml2YXRlIEZJRE8yOiBGaWRvMkxpYiB8IG51bGwgPSBudWxsO1xuXHRwcml2YXRlIGxvZ2dlciE6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZXJyb3JMb2dnZXIhOiBFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZXJyb3JIYW5kbGVyITogRXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBlbnZDb25maWchOiBFbnZDb25maWdTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIGNhY2hlU2VydmljZSE6IENhY2hlU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSB0aW1lb3V0OiBudW1iZXI7XG5cblx0cHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHtcblx0XHR0aGlzLnRpbWVvdXQgPVxuXHRcdFx0KHRoaXMuZW52Q29uZmlnLmdldEVudlZhcmlhYmxlKCdmaWRvMlRpbWVvdXQnKSBhcyBudW1iZXIpIHx8IDUwMDAwO1xuXHR9XG5cblx0cHVibGljIHN0YXRpYyBhc3luYyBnZXRJbnN0YW5jZSgpOiBQcm9taXNlPEZJRE8yU2VydmljZT4ge1xuXHRcdGlmICghRklETzJTZXJ2aWNlLmluc3RhbmNlKSB7XG5cdFx0XHRjb25zdCBlcnJvckxvZ2dlciA9IGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldEVycm9yTG9nZ2VyU2VydmljZSgpO1xuXHRcdFx0Y29uc3QgZXJyb3JIYW5kbGVyID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0RXJyb3JIYW5kbGVyU2VydmljZSgpO1xuXHRcdFx0Y29uc3QgZW52Q29uZmlnID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0RW52Q29uZmlnU2VydmljZSgpO1xuXHRcdFx0Y29uc3QgY2FjaGVTZXJ2aWNlID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0Q2FjaGVTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBsb2dnZXIgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRMb2dnZXJTZXJ2aWNlKCk7XG5cblx0XHRcdEZJRE8yU2VydmljZS5pbnN0YW5jZSA9IG5ldyBGSURPMlNlcnZpY2UoKTtcblx0XHRcdEZJRE8yU2VydmljZS5pbnN0YW5jZS5lcnJvckxvZ2dlciA9IGVycm9yTG9nZ2VyO1xuXHRcdFx0RklETzJTZXJ2aWNlLmluc3RhbmNlLmVycm9ySGFuZGxlciA9IGVycm9ySGFuZGxlcjtcblx0XHRcdEZJRE8yU2VydmljZS5pbnN0YW5jZS5lbnZDb25maWcgPSBlbnZDb25maWc7XG5cdFx0XHRGSURPMlNlcnZpY2UuaW5zdGFuY2UuY2FjaGVTZXJ2aWNlID0gY2FjaGVTZXJ2aWNlO1xuXHRcdFx0RklETzJTZXJ2aWNlLmluc3RhbmNlLmxvZ2dlciA9IGxvZ2dlcjtcblx0XHR9XG5cblx0XHRyZXR1cm4gRklETzJTZXJ2aWNlLmluc3RhbmNlO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGluaXRpYWxpemVGSURPMlNlcnZpY2UoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgY2FjaGVLZXkgPSAnRklETzJMaWInO1xuXHRcdGNvbnN0IGNhY2hlZEZJRE8yTGliID0gYXdhaXQgdGhpcy5jYWNoZVNlcnZpY2UuZ2V0KGNhY2hlS2V5LCAnYXV0aCcpO1xuXG5cdFx0aWYgKGNhY2hlZEZJRE8yTGliKSB7XG5cdFx0XHR0aGlzLkZJRE8yID0gY2FjaGVkRklETzJMaWIgYXMgRmlkbzJMaWI7XG5cdFx0XHR0aGlzLmxvZ2dlci5kZWJ1ZygnTG9hZGVkIEZpZG8yTGliIGZyb20gY2FjaGUuJyk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IHJwSWQgPSB0aGlzLmVudkNvbmZpZy5nZXRFbnZWYXJpYWJsZSgncnBJZCcpO1xuXHRcdFx0Y29uc3QgcnBOYW1lID0gdGhpcy5lbnZDb25maWcuZ2V0RW52VmFyaWFibGUoJ3JwTmFtZScpO1xuXHRcdFx0Y29uc3QgY2hhbGxlbmdlU2l6ZSA9XG5cdFx0XHRcdHRoaXMuZW52Q29uZmlnLmdldEVudlZhcmlhYmxlKCdmaWRvQ2hhbGxlbmdlU2l6ZScpO1xuXHRcdFx0Y29uc3QgY3J5cHRvUGFyYW1zID1cblx0XHRcdFx0dGhpcy5lbnZDb25maWcuZ2V0RW52VmFyaWFibGUoJ2ZpZG9DcnlwdG9QYXJhbXMnKTtcblx0XHRcdGNvbnN0IHJlcXVpcmVSZXNpZGVudEtleSA9IHRoaXMuZW52Q29uZmlnLmdldEVudlZhcmlhYmxlKFxuXHRcdFx0XHQnZmlkb0F1dGhSZXF1aXJlUmVzaWRlbnRLZXknXG5cdFx0XHQpO1xuXHRcdFx0Y29uc3QgdXNlclZlcmlmaWNhdGlvbiA9IHRoaXMuZW52Q29uZmlnLmdldEVudlZhcmlhYmxlKFxuXHRcdFx0XHQnZmlkb0F1dGhVc2VyVmVyaWZpY2F0aW9uJ1xuXHRcdFx0KTtcblx0XHRcdGNvbnN0IHZhbGlkVXNlclZlcmlmaWNhdGlvblZhbHVlczogVXNlclZlcmlmaWNhdGlvbltdID0gW1xuXHRcdFx0XHQncmVxdWlyZWQnLFxuXHRcdFx0XHQncHJlZmVycmVkJyxcblx0XHRcdFx0J2Rpc2NvdXJhZ2VkJ1xuXHRcdFx0XTtcblx0XHRcdGNvbnN0IHRpbWVvdXQgPSB0aGlzLnRpbWVvdXQ7XG5cblx0XHRcdGlmIChcblx0XHRcdFx0IXZhbGlkVXNlclZlcmlmaWNhdGlvblZhbHVlcy5pbmNsdWRlcyhcblx0XHRcdFx0XHR1c2VyVmVyaWZpY2F0aW9uIGFzIFVzZXJWZXJpZmljYXRpb25cblx0XHRcdFx0KVxuXHRcdFx0KSB7XG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcihcblx0XHRcdFx0XHQnSW52YWxpZCB2YWx1ZSBmb3IgYXV0aGVudGljYXRvclVzZXJWZXJpZmljYXRpb24nXG5cdFx0XHRcdCk7XG5cdFx0XHR9XG5cblx0XHRcdHRoaXMuRklETzIgPSBuZXcgRmlkbzJMaWIoe1xuXHRcdFx0XHR0aW1lb3V0LFxuXHRcdFx0XHRycElkLFxuXHRcdFx0XHRycE5hbWUsXG5cdFx0XHRcdGNoYWxsZW5nZVNpemUsXG5cdFx0XHRcdGNyeXB0b1BhcmFtcyxcblx0XHRcdFx0YXV0aGVudGljYXRvclJlcXVpcmVSZXNpZGVudEtleTogcmVxdWlyZVJlc2lkZW50S2V5LFxuXHRcdFx0XHRhdXRoZW50aWNhdG9yVXNlclZlcmlmaWNhdGlvbjpcblx0XHRcdFx0XHR1c2VyVmVyaWZpY2F0aW9uIGFzIFVzZXJWZXJpZmljYXRpb25cblx0XHRcdH0pO1xuXHRcdFx0YXdhaXQgdGhpcy5jYWNoZVNlcnZpY2Uuc2V0KFxuXHRcdFx0XHRjYWNoZUtleSxcblx0XHRcdFx0dGhpcy5GSURPMixcblx0XHRcdFx0J2F1dGgnLFxuXHRcdFx0XHRzZXJ2aWNlVFRMQ29uZmlnLkZJRE8yIHx8IHNlcnZpY2VUVExDb25maWcuZGVmYXVsdFxuXHRcdFx0KTtcblxuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnRmlkbzJMaWIgaW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5LicpO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmhhbmRsZUVycm9yKCdpbml0aWFsaXplRmlkbzInLCBlcnJvcik7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIGVuc3VyZUluaXRpYWxpemVkKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdHZhbGlkYXRlRGVwZW5kZW5jaWVzKFxuXHRcdFx0W3sgbmFtZTogJ2xvZ2dlcicsIGluc3RhbmNlOiB0aGlzLmxvZ2dlciB9XSxcblx0XHRcdHRoaXMubG9nZ2VyXG5cdFx0KTtcblx0XHRpZiAoIXRoaXMuRklETzIpIHtcblx0XHRcdHRoaXMubG9nZ2VyLmRlYnVnKCdGaWRvMkxpYiBpcyBub3QgaW5pdGlhbGl6ZWQsIGluaXRpYWxpemluZyBub3cuJyk7XG5cdFx0XHRhd2FpdCB0aGlzLmluaXRpYWxpemVGSURPMlNlcnZpY2UoKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5sb2dnZXIuZGVidWcoJ0ZpZG8yTGliIGlzIGFscmVhZHkgaW5pdGlhbGl6ZWQuJyk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIGdlbmVyYXRlRklETzJSZWdpc3RyYXRpb25PcHRpb25zKFxuXHRcdHVzZXI6IEZpZG9Vc2VySW50ZXJmYWNlXG5cdCk6IFByb21pc2U8UHVibGljS2V5Q3JlZGVudGlhbENyZWF0aW9uT3B0aW9ucz4ge1xuXHRcdGNvbnN0IGNhY2hlS2V5ID0gYEZJRE8yUmVnaXN0cmF0aW9uOiR7dXNlci5pZH1gO1xuXHRcdGNvbnN0IGNhY2hlZE9wdGlvbnMgPSBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5nZXQoY2FjaGVLZXksICdhdXRoJyk7XG5cblx0XHRpZiAoY2FjaGVkT3B0aW9ucykge1xuXHRcdFx0dGhpcy5sb2dnZXIuZGVidWcoJ0xvYWRlZCByZWdpc3RyYXRpb24gb3B0aW9ucyBmcm9tIGNhY2hlLicpO1xuXHRcdFx0cmV0dXJuIGNhY2hlZE9wdGlvbnMgYXMgUHVibGljS2V5Q3JlZGVudGlhbENyZWF0aW9uT3B0aW9ucztcblx0XHR9XG5cblx0XHR0cnkge1xuXHRcdFx0dmFsaWRhdGVEZXBlbmRlbmNpZXMoXG5cdFx0XHRcdFt7IG5hbWU6ICd1c2VyJywgaW5zdGFuY2U6IHVzZXIgfV0sXG5cdFx0XHRcdHRoaXMubG9nZ2VyXG5cdFx0XHQpO1xuXG5cdFx0XHRhd2FpdCB0aGlzLmVuc3VyZUluaXRpYWxpemVkKCk7XG5cblx0XHRcdGNvbnN0IHRpbWVvdXQgPSB0aGlzLnRpbWVvdXQ7XG5cdFx0XHRjb25zdCBwYXNza2V5UmVnaXN0cmF0aW9uT3B0aW9ucyA9XG5cdFx0XHRcdGF3YWl0IHRoaXMuRklETzIhLmF0dGVzdGF0aW9uT3B0aW9ucygpO1xuXHRcdFx0Y29uc3QgcmVnaXN0cmF0aW9uT3B0aW9uczogUHVibGljS2V5Q3JlZGVudGlhbENyZWF0aW9uT3B0aW9ucyA9IHtcblx0XHRcdFx0Li4ucGFzc2tleVJlZ2lzdHJhdGlvbk9wdGlvbnMsXG5cdFx0XHRcdHVzZXI6IHtcblx0XHRcdFx0XHRpZDogQnVmZmVyLmZyb20odXNlci5pZCwgJ3V0Zi04JyksXG5cdFx0XHRcdFx0bmFtZTogdXNlci5lbWFpbCxcblx0XHRcdFx0XHRkaXNwbGF5TmFtZTogdXNlci51c2VybmFtZVxuXHRcdFx0XHR9LFxuXHRcdFx0XHRwdWJLZXlDcmVkUGFyYW1zOiBbeyB0eXBlOiAncHVibGljLWtleScsIGFsZzogLTcgfV0sXG5cdFx0XHRcdHRpbWVvdXQsXG5cdFx0XHRcdGF0dGVzdGF0aW9uOiAnZGlyZWN0Jyxcblx0XHRcdFx0YXV0aGVudGljYXRvclNlbGVjdGlvbjoge1xuXHRcdFx0XHRcdGF1dGhlbnRpY2F0b3JBdHRhY2htZW50OiAncGxhdGZvcm0nLFxuXHRcdFx0XHRcdHJlcXVpcmVSZXNpZGVudEtleTogdHJ1ZSxcblx0XHRcdFx0XHR1c2VyVmVyaWZpY2F0aW9uOiAncHJlZmVycmVkJ1xuXHRcdFx0XHR9XG5cdFx0XHR9O1xuXG5cdFx0XHRhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5zZXQoXG5cdFx0XHRcdGNhY2hlS2V5LFxuXHRcdFx0XHRyZWdpc3RyYXRpb25PcHRpb25zLFxuXHRcdFx0XHQnYXV0aCcsXG5cdFx0XHRcdHNlcnZpY2VUVExDb25maWcuRklETzJSZWdpc3RyYXRpb24gfHwgc2VydmljZVRUTENvbmZpZy5kZWZhdWx0XG5cdFx0XHQpO1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0J1Bhc3NrZXkgcmVnaXN0cmF0aW9uIG9wdGlvbnMgZ2VuZXJhdGVkIHN1Y2Nlc3NmdWxseS4nXG5cdFx0XHQpO1xuXHRcdFx0cmV0dXJuIHJlZ2lzdHJhdGlvbk9wdGlvbnM7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlRXJyb3IoJ2dlbmVyYXRlUmVnaXN0cmF0aW9uT3B0aW9ucycsIGVycm9yKTtcblx0XHRcdHJldHVybiB7fSBhcyBQdWJsaWNLZXlDcmVkZW50aWFsQ3JlYXRpb25PcHRpb25zO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyB2ZXJpZnlGSURPMlJlZ2lzdHJhdGlvbihcblx0XHRhdHRlc3RhdGlvbjogQXR0ZXN0YXRpb25SZXN1bHQsXG5cdFx0ZXhwZWN0ZWRDaGFsbGVuZ2U6IHN0cmluZ1xuXHQpOiBQcm9taXNlPEZpZG8yQXR0ZXN0YXRpb25SZXN1bHQ+IHtcblx0XHR0cnkge1xuXHRcdFx0dmFsaWRhdGVEZXBlbmRlbmNpZXMoXG5cdFx0XHRcdFtcblx0XHRcdFx0XHR7IG5hbWU6ICdhdHRlc3RhdGlvbicsIGluc3RhbmNlOiBhdHRlc3RhdGlvbiB9LFxuXHRcdFx0XHRcdHsgbmFtZTogJ2V4cGVjdGVkQ2hhbGxlbmdlJywgaW5zdGFuY2U6IGV4cGVjdGVkQ2hhbGxlbmdlIH1cblx0XHRcdFx0XSxcblx0XHRcdFx0dGhpcy5sb2dnZXJcblx0XHRcdCk7XG5cdFx0XHRhd2FpdCB0aGlzLmVuc3VyZUluaXRpYWxpemVkKCk7XG5cblx0XHRcdGNvbnN0IHUyZkF0dGVzdGF0aW9uRXhwZWN0YXRpb25zOiBFeHBlY3RlZEF0dGVzdGF0aW9uUmVzdWx0ID0ge1xuXHRcdFx0XHRjaGFsbGVuZ2U6IGV4cGVjdGVkQ2hhbGxlbmdlLFxuXHRcdFx0XHRvcmlnaW46IHRoaXMuZW52Q29uZmlnLmdldEVudlZhcmlhYmxlKCdycE9yaWdpbicpLFxuXHRcdFx0XHRmYWN0b3I6ICdlaXRoZXInIGFzIEZpZG9GYWN0b3IsXG5cdFx0XHRcdHJwSWQ6IHRoaXMuZW52Q29uZmlnLmdldEVudlZhcmlhYmxlKCdycElkJylcblx0XHRcdH07XG5cblx0XHRcdGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuRklETzIhLmF0dGVzdGF0aW9uUmVzdWx0KFxuXHRcdFx0XHRhdHRlc3RhdGlvbixcblx0XHRcdFx0dTJmQXR0ZXN0YXRpb25FeHBlY3RhdGlvbnNcblx0XHRcdCk7XG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdQYXNza2V5IHJlZ2lzdHJhdGlvbiB2ZXJpZmllZCBzdWNjZXNzZnVsbHkuJyk7XG5cdFx0XHRyZXR1cm4gcmVzdWx0IGFzIEZpZG8yQXR0ZXN0YXRpb25SZXN1bHQ7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlRXJyb3IoJ3ZlcmlmeVJlZ2lzdHJhdGlvbicsIGVycm9yKTtcblx0XHRcdHJldHVybiB7fSBhcyBGaWRvMkF0dGVzdGF0aW9uUmVzdWx0O1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBnZW5lcmF0ZUZJRE8yQXV0aGVudGljYXRpb25PcHRpb25zKFxuXHRcdHVzZXI6IEZpZG9Vc2VySW50ZXJmYWNlXG5cdCk6IFByb21pc2U8UHVibGljS2V5Q3JlZGVudGlhbFJlcXVlc3RPcHRpb25zPiB7XG5cdFx0Y29uc3QgY2FjaGVLZXkgPSBgRklETzJBdXRoOiR7dXNlci5pZH1gO1xuXHRcdGNvbnN0IGNhY2hlZE9wdGlvbnMgPSBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5nZXQoY2FjaGVLZXksICdhdXRoJyk7XG5cblx0XHRpZiAoY2FjaGVkT3B0aW9ucykge1xuXHRcdFx0dGhpcy5sb2dnZXIuZGVidWcoJ0xvYWRlZCBhdXRoZW50aWNhdGlvbiBvcHRpb25zIGZyb20gY2FjaGUuJyk7XG5cdFx0XHRyZXR1cm4gY2FjaGVkT3B0aW9ucyBhcyBQdWJsaWNLZXlDcmVkZW50aWFsUmVxdWVzdE9wdGlvbnM7XG5cdFx0fVxuXG5cdFx0dHJ5IHtcblx0XHRcdGF3YWl0IHRoaXMuZW5zdXJlSW5pdGlhbGl6ZWQoKTtcblxuXHRcdFx0Y29uc3QgdXNlckNyZWRlbnRpYWxzOiBQdWJsaWNLZXlDcmVkZW50aWFsRGVzY3JpcHRvcltdID1cblx0XHRcdFx0dXNlci5jcmVkZW50aWFsLm1hcChjcmVkZW50aWFsID0+ICh7XG5cdFx0XHRcdFx0dHlwZTogJ3B1YmxpYy1rZXknLFxuXHRcdFx0XHRcdGlkOiBCdWZmZXIuZnJvbShjcmVkZW50aWFsLmNyZWRlbnRpYWxJZCwgJ2Jhc2U2NCcpLmJ1ZmZlclxuXHRcdFx0XHR9KSk7XG5cblx0XHRcdGNvbnN0IGFzc2VydGlvbk9wdGlvbnMgPSBhd2FpdCB0aGlzLkZJRE8yIS5hc3NlcnRpb25PcHRpb25zKCk7XG5cdFx0XHRjb25zdCBhdXRoZW50aWNhdGlvbk9wdGlvbnM6IFB1YmxpY0tleUNyZWRlbnRpYWxSZXF1ZXN0T3B0aW9ucyA9IHtcblx0XHRcdFx0Li4uYXNzZXJ0aW9uT3B0aW9ucyxcblx0XHRcdFx0YWxsb3dDcmVkZW50aWFsczogdXNlckNyZWRlbnRpYWxzLFxuXHRcdFx0XHR1c2VyVmVyaWZpY2F0aW9uOiAncmVxdWlyZWQnLFxuXHRcdFx0XHR0aW1lb3V0OiA2MDAwMFxuXHRcdFx0fTtcblxuXHRcdFx0YXdhaXQgdGhpcy5jYWNoZVNlcnZpY2Uuc2V0KFxuXHRcdFx0XHRjYWNoZUtleSxcblx0XHRcdFx0YXV0aGVudGljYXRpb25PcHRpb25zLFxuXHRcdFx0XHQnYXV0aCcsXG5cdFx0XHRcdHNlcnZpY2VUVExDb25maWcuRklETzJBdXRoZW50aWNhdGlvbiB8fCBzZXJ2aWNlVFRMQ29uZmlnLmRlZmF1bHRcblx0XHRcdCk7XG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKFxuXHRcdFx0XHQnUGFzc2tleSBhdXRoZW50aWNhdGlvbiBvcHRpb25zIGdlbmVyYXRlZCBzdWNjZXNzZnVsbHkuJ1xuXHRcdFx0KTtcblx0XHRcdHJldHVybiBhdXRoZW50aWNhdGlvbk9wdGlvbnM7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlRXJyb3IoJ2dlbmVyYXRlQXV0aGVudGljYXRpb25PcHRpb25zJywgZXJyb3IpO1xuXHRcdFx0cmV0dXJuIHt9IGFzIFB1YmxpY0tleUNyZWRlbnRpYWxSZXF1ZXN0T3B0aW9ucztcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgdmVyaWZ5QXV0aGVudGljYXRpb24oXG5cdFx0YXNzZXJ0aW9uOiBBc3NlcnRpb25SZXN1bHQsXG5cdFx0ZXhwZWN0ZWRDaGFsbGVuZ2U6IHN0cmluZyxcblx0XHRwdWJsaWNLZXk6IHN0cmluZyxcblx0XHRwcmV2aW91c0NvdW50ZXI6IG51bWJlcixcblx0XHRpZDogc3RyaW5nXG5cdCk6IFByb21pc2U8RmlkbzJBc3NlcnRpb25SZXN1bHQ+IHtcblx0XHR0cnkge1xuXHRcdFx0dmFsaWRhdGVEZXBlbmRlbmNpZXMoXG5cdFx0XHRcdFtcblx0XHRcdFx0XHR7IG5hbWU6ICdhc3NlcnRpb24nLCBpbnN0YW5jZTogYXNzZXJ0aW9uIH0sXG5cdFx0XHRcdFx0eyBuYW1lOiAnZXhwZWN0ZWRDaGFsbGVuZ2UnLCBpbnN0YW5jZTogZXhwZWN0ZWRDaGFsbGVuZ2UgfSxcblx0XHRcdFx0XHR7IG5hbWU6ICdwdWJsaWNLZXknLCBpbnN0YW5jZTogcHVibGljS2V5IH0sXG5cdFx0XHRcdFx0eyBuYW1lOiAncHJldmlvdXNDb3VudGVyJywgaW5zdGFuY2U6IHByZXZpb3VzQ291bnRlciB9LFxuXHRcdFx0XHRcdHsgbmFtZTogJ2lkJywgaW5zdGFuY2U6IGlkIH1cblx0XHRcdFx0XSxcblx0XHRcdFx0dGhpcy5sb2dnZXJcblx0XHRcdCk7XG5cdFx0XHRhd2FpdCB0aGlzLmVuc3VyZUluaXRpYWxpemVkKCk7XG5cblx0XHRcdGNvbnN0IGFzc2VydGlvbkV4cGVjdGF0aW9uczogRXhwZWN0ZWRBc3NlcnRpb25SZXN1bHQgPSB7XG5cdFx0XHRcdGNoYWxsZW5nZTogZXhwZWN0ZWRDaGFsbGVuZ2UsXG5cdFx0XHRcdG9yaWdpbjogdGhpcy5lbnZDb25maWcuZ2V0RW52VmFyaWFibGUoJ3JwT3JpZ2luJyksXG5cdFx0XHRcdGZhY3RvcjogJ2VpdGhlcicgYXMgRmlkb0ZhY3Rvcixcblx0XHRcdFx0cHVibGljS2V5LFxuXHRcdFx0XHRwcmV2Q291bnRlcjogcHJldmlvdXNDb3VudGVyLFxuXHRcdFx0XHR1c2VySGFuZGxlOiBpZFxuXHRcdFx0fTtcblxuXHRcdFx0Y29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5GSURPMiEuYXNzZXJ0aW9uUmVzdWx0KFxuXHRcdFx0XHRhc3NlcnRpb24sXG5cdFx0XHRcdGFzc2VydGlvbkV4cGVjdGF0aW9uc1xuXHRcdFx0KTtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ1Bhc3NrZXkgYXV0aGVudGljYXRpb24gdmVyaWZpZWQgc3VjY2Vzc2Z1bGx5LicpO1xuXHRcdFx0cmV0dXJuIHJlc3VsdCBhcyBGaWRvMkFzc2VydGlvblJlc3VsdDtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5oYW5kbGVFcnJvcigndmVyaWZ5QXV0aGVudGljYXRpb24nLCBlcnJvcik7XG5cdFx0XHRyZXR1cm4ge30gYXMgRmlkbzJBc3NlcnRpb25SZXN1bHQ7XG5cdFx0fVxuXHR9XG5cblx0Ly8gKkRFVi1OT1RFKiB1c2UsIGZvciBleGFtcGxlLCB3aGVuIHVzZXIgdXBkYXRlcyBjcmVkZW50aWFsc1xuXHRwdWJsaWMgYXN5bmMgaW52YWxpZGF0ZUZpZG8yQ2FjaGUoXG5cdFx0dXNlcklkOiBzdHJpbmcsXG5cdFx0YWN0aW9uOiBzdHJpbmdcblx0KTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgY2FjaGVLZXlSZWdpc3RyYXRpb24gPSBgRklETzJSZWdpc3RyYXRpb246JHt1c2VySWR9YDtcblx0XHRjb25zdCBjYWNoZUtleUF1dGggPSBgRklETzJBdXRoOiR7dXNlcklkfWA7XG5cblx0XHR0aGlzLmxvZ2dlci5pbmZvKFxuXHRcdFx0YEludmFsaWRhdGluZyBGSURPMiBjYWNoZSBmb3IgdXNlciAke3VzZXJJZH0gZHVlIHRvICR7YWN0aW9ufWBcblx0XHQpO1xuXG5cdFx0dHJ5IHtcblx0XHRcdGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLmRlbChjYWNoZUtleVJlZ2lzdHJhdGlvbiwgJ2F1dGgnKTtcblx0XHRcdGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLmRlbChjYWNoZUtleUF1dGgsICdhdXRoJyk7XG5cblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oYEZJRE8yIGNhY2hlIGludmFsaWRhdGVkIGZvciB1c2VyICR7dXNlcklkfWApO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmhhbmRsZUVycm9yKCdpbnZhbGlkYXRlRmlkbzJDYWNoZScsIGVycm9yKTtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgc2h1dGRvd24oKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGlmICh0aGlzLkZJRE8yKSB7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0J0NsZWFyaW5nIEZJRE8yTGliIGFuZCBjYWNoZSBlbnRyaWVzIGJlZm9yZSBzaHV0ZG93bi4uLidcblx0XHRcdFx0KTtcblx0XHRcdFx0dGhpcy5GSURPMiA9IG51bGw7XG5cblx0XHRcdFx0YXdhaXQgdGhpcy5jYWNoZVNlcnZpY2UuZGVsKCdGSURPMkxpYicsICdhdXRoJyk7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0J0ZJRE8yIGNhY2hlIGFuZCBpbnN0YW5jZSBjbGVhcmVkIHN1Y2Nlc3NmdWxseS4nXG5cdFx0XHRcdCk7XG5cdFx0XHRcdEZJRE8yU2VydmljZS5pbnN0YW5jZSA9IG51bGw7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ0ZJRE8yU2VydmljZSBzaHV0IGRvd24gc3VjY2Vzc2Z1bGx5LicpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0XHQnRklETzJTZXJ2aWNlIGlzIGFscmVhZHkgc2h1dCBkb3duIG9yIHVuaW5pdGlhbGl6ZWQuJ1xuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmhhbmRsZUVycm9yKCdzaHV0ZG93bicsIGVycm9yKTtcblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIGhhbmRsZUVycm9yKHV0aWxpdHk6IHN0cmluZywgZXJyb3I6IHVua25vd24pOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRjb25zdCBlcnJvck1lc3NhZ2UgPSBgRXJyb3IgaW4gJHt1dGlsaXR5fTogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yfWA7XG5cdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcihlcnJvck1lc3NhZ2UpO1xuXHRcdGNvbnN0IHV0aWxpdHlFcnJvciA9XG5cdFx0XHRuZXcgdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JDbGFzc2VzLlV0aWxpdHlFcnJvclJlY292ZXJhYmxlKFxuXHRcdFx0XHRlcnJvck1lc3NhZ2UsXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRleHBvc2VUb0NsaWVudDogZmFsc2Vcblx0XHRcdFx0fVxuXHRcdFx0KTtcblx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7IGVycm9yOiB1dGlsaXR5RXJyb3IgfSk7XG5cdH1cbn1cbiJdfQ==
