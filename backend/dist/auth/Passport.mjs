import { Strategy as LocalStrategy } from 'passport-local';
import { ExtractJwt, Strategy as JwtStrategy } from 'passport-jwt';
import { LoggerServiceFactory } from '../index/factory/subfactories/LoggerServiceFactory.mjs';
import { AuthServiceFactory } from '../index/factory/subfactories/AuthServiceFactory.mjs';
import { ErrorHandlerServiceFactory } from '../index/factory/subfactories/ErrorHandlerServiceFactory.mjs';
import { VaultServiceFactory } from '../index/factory/subfactories/VaultServiceFactory.mjs';
export class PassportService {
	static instance = null;
	passwordService;
	logger;
	errorLogger;
	errorHandler;
	vault;
	constructor(passwordService, logger, errorLogger, errorHandler, secrets) {
		this.passwordService = passwordService;
		this.logger = logger;
		this.errorLogger = errorLogger;
		this.errorHandler = errorHandler;
		this.vault = secrets;
	}
	static async getInstance() {
		if (!PassportService.instance) {
			const passwordService =
				await AuthServiceFactory.getPasswordService();
			const logger = await LoggerServiceFactory.getLoggerService();
			const errorLogger =
				await LoggerServiceFactory.getErrorLoggerService();
			const errorHandler =
				await ErrorHandlerServiceFactory.getErrorHandlerService();
			const vault = await VaultServiceFactory.getVaultService();
			PassportService.instance = new PassportService(
				passwordService,
				logger,
				errorLogger,
				errorHandler,
				vault
			);
		}
		return PassportService.instance;
	}
	async configurePassport(passport, UserModel) {
		try {
			const jwtSecret = this.vault.retrieveSecret(
				'JWT_SECRET',
				secret => secret
			);
			if (typeof jwtSecret !== 'string') {
				const jwtSecretError =
					new this.errorHandler.ErrorClasses.ConfigurationError(
						'Invalid JWT secret'
					);
				this.errorLogger.logError(jwtSecretError.message);
				this.errorHandler.handleError({ error: jwtSecretError });
				throw jwtSecretError;
			}
			const opts = {
				jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
				secretOrKey: jwtSecret
			};
			passport.use(
				new JwtStrategy(opts, async (jwtPayload, done) => {
					try {
						const user = await UserModel.findByPk(jwtPayload.id);
						if (user) {
							this.logger.info(
								`JWT authentication successful for user: ${user.username}`
							);
							return done(null, user);
						} else {
							this.logger.warn(
								'JWT authentication failed: User not found'
							);
							return done(null, false, {
								message: 'User not found'
							});
						}
					} catch (error) {
						this.handlePassportAuthServiceError(
							error,
							'JWT authentication failed',
							{ jwtPayload },
							'JWT authentication failed'
						);
					}
				})
			);
			passport.use(
				new LocalStrategy(async (username, password, done) => {
					try {
						const user = await UserModel.findOne({
							where: { username }
						});
						if (!user) {
							this.logger.warn(
								`Local authentication failed: User not found: ${username}`
							);
							return done(null, false, {
								message: 'User not found'
							});
						}
						const pepper = this.vault.retrieveSecret(
							'PEPPER',
							secret => secret
						);
						if (typeof pepper !== 'string') {
							this.logger.error(
								'Failed to retrieve valid PEPPER secret'
							);
							throw new Error('Invalid PEPPER secret');
						}
						const passwordService =
							await AuthServiceFactory.getPasswordService();
						const isMatch = await passwordService.comparePassword(
							user.password,
							password,
							pepper
						);
						if (isMatch) {
							this.logger.info(
								`Local authentication successful for user: ${username}`
							);
							return done(null, user);
						} else {
							this.logger.warn(
								`Local authentication failed: Incorrect password for user: ${username}`
							);
							return done(null, false, {
								message: 'Incorrect password'
							});
						}
					} catch (error) {
						this.handlePassportAuthServiceError(
							error,
							'Local authentication failed',
							{ username, password },
							'Local authentication failed'
						);
					}
				})
			);
			this.logger.info('Passport configured successfully');
		} catch (error) {
			this.errorLogger.logError('Failed to configure Passport');
			this.handlePassportAuthServiceError(
				error,
				'Passport configuration failed',
				{ error },
				'Failed to configure Passport'
			);
		}
	}
	async shutdown() {
		try {
			this.logger.info('Shutting down PassportService...');
			this.logger.info(
				'Clearing PassportService cache or handlers (if any)...'
			);
			PassportService.instance = null;
			this.logger.info(
				'PassportService shutdown completed successfully.'
			);
		} catch (error) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Error during PassportService shutdown: ${error instanceof Error ? error.message : error}`
				);
			this.errorLogger.logError(utilityError.message);
			this.errorHandler.handleError({ error: utilityError });
		}
	}
	handlePassportAuthServiceError(
		error,
		errorHeader,
		errorDetails,
		customMessage
	) {
		try {
			const errorMessage = `${customMessage}: ${error}\n${error instanceof Error ? error.stack : ''}`;
			this.errorLogger.logError(errorMessage);
			const resourceError =
				new this.errorHandler.ErrorClasses.PassportAuthServiceError(
					errorHeader,
					{
						details: errorDetails,
						exposeToClient: false
					}
				);
			this.errorHandler.handleError({
				error: resourceError
			});
		} catch (error) {
			this.logger.error(
				`Error handling Passport Auth Service error: ${error}`
			);
			const severity = this.errorHandler.ErrorSeverity.WARNING;
			this.errorHandler.handleError({
				error,
				details: {
					context: 'Passport Auth Service',
					action: 'Passing error from Passport Auth Service handler to ErrorHandlerService',
					notes: 'Error occurred while handling Auth Controller error: PassportAuthService.handlePassportAuthServiceError'
				},
				severity
			});
		}
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGFzc3BvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYXV0aC9QYXNzcG9ydC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxJQUFJLGFBQWEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNELE9BQU8sRUFDTixVQUFVLEVBQ1YsUUFBUSxJQUFJLFdBQVcsRUFHdkIsTUFBTSxjQUFjLENBQUM7QUFTdEIsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sb0RBQW9ELENBQUM7QUFDMUYsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sa0RBQWtELENBQUM7QUFDdEYsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sMERBQTBELENBQUM7QUFDdEcsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbURBQW1ELENBQUM7QUFFeEYsTUFBTSxPQUFPLGVBQWU7SUFDbkIsTUFBTSxDQUFDLFFBQVEsR0FBMkIsSUFBSSxDQUFDO0lBRS9DLGVBQWUsQ0FBMkI7SUFDMUMsTUFBTSxDQUE0QjtJQUNsQyxXQUFXLENBQThCO0lBQ3pDLFlBQVksQ0FBK0I7SUFDM0MsS0FBSyxDQUF3QjtJQUVyQyxZQUNDLGVBQXlDLEVBQ3pDLE1BQWlDLEVBQ2pDLFdBQXdDLEVBQ3hDLFlBQTBDLEVBQzFDLE9BQThCO1FBRTlCLElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQy9CLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDO0lBQ3RCLENBQUM7SUFFTSxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVc7UUFDOUIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUMvQixNQUFNLGVBQWUsR0FDcEIs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O0lBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN0cmF0ZWd5IGFzIExvY2FsU3RyYXRlZ3kgfSBmcm9tICdwYXNzcG9ydC1sb2NhbCc7XG5pbXBvcnQge1xuXHRFeHRyYWN0Snd0LFxuXHRTdHJhdGVneSBhcyBKd3RTdHJhdGVneSxcblx0U3RyYXRlZ3lPcHRpb25zLFxuXHRWZXJpZmllZENhbGxiYWNrXG59IGZyb20gJ3Bhc3Nwb3J0LWp3dCc7XG5pbXBvcnQge1xuXHRBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFBhc3Nwb3J0U2VydmljZUludGVyZmFjZSxcblx0UGFzc3dvcmRTZXJ2aWNlSW50ZXJmYWNlLFxuXHRWYXVsdFNlcnZpY2VJbnRlcmZhY2Vcbn0gZnJvbSAnLi4vaW5kZXgvaW50ZXJmYWNlcy9tYWluJztcbmltcG9ydCB7IExvZ2dlclNlcnZpY2VGYWN0b3J5IH0gZnJvbSAnLi4vaW5kZXgvZmFjdG9yeS9zdWJmYWN0b3JpZXMvTG9nZ2VyU2VydmljZUZhY3RvcnknO1xuaW1wb3J0IHsgQXV0aFNlcnZpY2VGYWN0b3J5IH0gZnJvbSAnLi4vaW5kZXgvZmFjdG9yeS9zdWJmYWN0b3JpZXMvQXV0aFNlcnZpY2VGYWN0b3J5JztcbmltcG9ydCB7IEVycm9ySGFuZGxlclNlcnZpY2VGYWN0b3J5IH0gZnJvbSAnLi4vaW5kZXgvZmFjdG9yeS9zdWJmYWN0b3JpZXMvRXJyb3JIYW5kbGVyU2VydmljZUZhY3RvcnknO1xuaW1wb3J0IHsgVmF1bHRTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4uL2luZGV4L2ZhY3Rvcnkvc3ViZmFjdG9yaWVzL1ZhdWx0U2VydmljZUZhY3RvcnknO1xuXG5leHBvcnQgY2xhc3MgUGFzc3BvcnRTZXJ2aWNlIGltcGxlbWVudHMgUGFzc3BvcnRTZXJ2aWNlSW50ZXJmYWNlIHtcblx0cHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IFBhc3Nwb3J0U2VydmljZSB8IG51bGwgPSBudWxsO1xuXG5cdHByaXZhdGUgcGFzc3dvcmRTZXJ2aWNlOiBQYXNzd29yZFNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgbG9nZ2VyOiBBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIGVycm9yTG9nZ2VyOiBFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZXJyb3JIYW5kbGVyOiBFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIHZhdWx0OiBWYXVsdFNlcnZpY2VJbnRlcmZhY2U7XG5cblx0cHJpdmF0ZSBjb25zdHJ1Y3Rvcihcblx0XHRwYXNzd29yZFNlcnZpY2U6IFBhc3N3b3JkU2VydmljZUludGVyZmFjZSxcblx0XHRsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0ZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0XHRlcnJvckhhbmRsZXI6IEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0c2VjcmV0czogVmF1bHRTZXJ2aWNlSW50ZXJmYWNlXG5cdCkge1xuXHRcdHRoaXMucGFzc3dvcmRTZXJ2aWNlID0gcGFzc3dvcmRTZXJ2aWNlO1xuXHRcdHRoaXMubG9nZ2VyID0gbG9nZ2VyO1xuXHRcdHRoaXMuZXJyb3JMb2dnZXIgPSBlcnJvckxvZ2dlcjtcblx0XHR0aGlzLmVycm9ySGFuZGxlciA9IGVycm9ySGFuZGxlcjtcblx0XHR0aGlzLnZhdWx0ID0gc2VjcmV0cztcblx0fVxuXG5cdHB1YmxpYyBzdGF0aWMgYXN5bmMgZ2V0SW5zdGFuY2UoKTogUHJvbWlzZTxQYXNzcG9ydFNlcnZpY2U+IHtcblx0XHRpZiAoIVBhc3Nwb3J0U2VydmljZS5pbnN0YW5jZSkge1xuXHRcdFx0Y29uc3QgcGFzc3dvcmRTZXJ2aWNlID1cblx0XHRcdFx0YXdhaXQgQXV0aFNlcnZpY2VGYWN0b3J5LmdldFBhc3N3b3JkU2VydmljZSgpO1xuXHRcdFx0Y29uc3QgbG9nZ2VyID0gYXdhaXQgTG9nZ2VyU2VydmljZUZhY3RvcnkuZ2V0TG9nZ2VyU2VydmljZSgpO1xuXHRcdFx0Y29uc3QgZXJyb3JMb2dnZXIgPVxuXHRcdFx0XHRhd2FpdCBMb2dnZXJTZXJ2aWNlRmFjdG9yeS5nZXRFcnJvckxvZ2dlclNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGVycm9ySGFuZGxlciA9XG5cdFx0XHRcdGF3YWl0IEVycm9ySGFuZGxlclNlcnZpY2VGYWN0b3J5LmdldEVycm9ySGFuZGxlclNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IHZhdWx0ID0gYXdhaXQgVmF1bHRTZXJ2aWNlRmFjdG9yeS5nZXRWYXVsdFNlcnZpY2UoKTtcblxuXHRcdFx0UGFzc3BvcnRTZXJ2aWNlLmluc3RhbmNlID0gbmV3IFBhc3Nwb3J0U2VydmljZShcblx0XHRcdFx0cGFzc3dvcmRTZXJ2aWNlLFxuXHRcdFx0XHRsb2dnZXIsXG5cdFx0XHRcdGVycm9yTG9nZ2VyLFxuXHRcdFx0XHRlcnJvckhhbmRsZXIsXG5cdFx0XHRcdHZhdWx0XG5cdFx0XHQpO1xuXHRcdH1cblxuXHRcdHJldHVybiBQYXNzcG9ydFNlcnZpY2UuaW5zdGFuY2U7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgY29uZmlndXJlUGFzc3BvcnQoXG5cdFx0cGFzc3BvcnQ6IGltcG9ydCgncGFzc3BvcnQnKS5QYXNzcG9ydFN0YXRpYyxcblx0XHRVc2VyTW9kZWw6IHR5cGVvZiBpbXBvcnQoJy4uL21vZGVscy9Vc2VyJykuVXNlclxuXHQpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3Qgand0U2VjcmV0ID0gdGhpcy52YXVsdC5yZXRyaWV2ZVNlY3JldChcblx0XHRcdFx0J0pXVF9TRUNSRVQnLFxuXHRcdFx0XHRzZWNyZXQgPT4gc2VjcmV0XG5cdFx0XHQpO1xuXG5cdFx0XHRpZiAodHlwZW9mIGp3dFNlY3JldCAhPT0gJ3N0cmluZycpIHtcblx0XHRcdFx0Y29uc3Qgand0U2VjcmV0RXJyb3IgPVxuXHRcdFx0XHRcdG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuQ29uZmlndXJhdGlvbkVycm9yKFxuXHRcdFx0XHRcdFx0J0ludmFsaWQgSldUIHNlY3JldCdcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKGp3dFNlY3JldEVycm9yLm1lc3NhZ2UpO1xuXHRcdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7IGVycm9yOiBqd3RTZWNyZXRFcnJvciB9KTtcblx0XHRcdFx0dGhyb3cgand0U2VjcmV0RXJyb3I7XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IG9wdHM6IFN0cmF0ZWd5T3B0aW9ucyA9IHtcblx0XHRcdFx0and0RnJvbVJlcXVlc3Q6IEV4dHJhY3RKd3QuZnJvbUF1dGhIZWFkZXJBc0JlYXJlclRva2VuKCksXG5cdFx0XHRcdHNlY3JldE9yS2V5OiBqd3RTZWNyZXRcblx0XHRcdH07XG5cblx0XHRcdHBhc3Nwb3J0LnVzZShcblx0XHRcdFx0bmV3IEp3dFN0cmF0ZWd5KFxuXHRcdFx0XHRcdG9wdHMsXG5cdFx0XHRcdFx0YXN5bmMgKGp3dFBheWxvYWQsIGRvbmU6IFZlcmlmaWVkQ2FsbGJhY2spID0+IHtcblx0XHRcdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyTW9kZWwuZmluZEJ5UGsoXG5cdFx0XHRcdFx0XHRcdFx0and0UGF5bG9hZC5pZFxuXHRcdFx0XHRcdFx0XHQpO1xuXG5cdFx0XHRcdFx0XHRcdGlmICh1c2VyKSB7XG5cdFx0XHRcdFx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0XHRcdFx0XHRcdGBKV1QgYXV0aGVudGljYXRpb24gc3VjY2Vzc2Z1bCBmb3IgdXNlcjogJHt1c2VyLnVzZXJuYW1lfWBcblx0XHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHRcdHJldHVybiBkb25lKG51bGwsIHVzZXIpO1xuXHRcdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRcdHRoaXMubG9nZ2VyLndhcm4oXG5cdFx0XHRcdFx0XHRcdFx0XHQnSldUIGF1dGhlbnRpY2F0aW9uIGZhaWxlZDogVXNlciBub3QgZm91bmQnXG5cdFx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gZG9uZShudWxsLCBmYWxzZSwge1xuXHRcdFx0XHRcdFx0XHRcdFx0bWVzc2FnZTogJ1VzZXIgbm90IGZvdW5kJ1xuXHRcdFx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0XHRcdFx0XHR0aGlzLmhhbmRsZVBhc3Nwb3J0QXV0aFNlcnZpY2VFcnJvcihcblx0XHRcdFx0XHRcdFx0XHRlcnJvcixcblx0XHRcdFx0XHRcdFx0XHQnSldUIGF1dGhlbnRpY2F0aW9uIGZhaWxlZCcsXG5cdFx0XHRcdFx0XHRcdFx0eyBqd3RQYXlsb2FkIH0sXG5cdFx0XHRcdFx0XHRcdFx0J0pXVCBhdXRoZW50aWNhdGlvbiBmYWlsZWQnXG5cdFx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHQpXG5cdFx0XHQpO1xuXG5cdFx0XHRwYXNzcG9ydC51c2UoXG5cdFx0XHRcdG5ldyBMb2NhbFN0cmF0ZWd5KGFzeW5jICh1c2VybmFtZSwgcGFzc3dvcmQsIGRvbmUpID0+IHtcblx0XHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdFx0Y29uc3QgdXNlciA9IGF3YWl0IFVzZXJNb2RlbC5maW5kT25lKHtcblx0XHRcdFx0XHRcdFx0d2hlcmU6IHsgdXNlcm5hbWUgfVxuXHRcdFx0XHRcdFx0fSk7XG5cblx0XHRcdFx0XHRcdGlmICghdXNlcikge1xuXHRcdFx0XHRcdFx0XHR0aGlzLmxvZ2dlci53YXJuKFxuXHRcdFx0XHRcdFx0XHRcdGBMb2NhbCBhdXRoZW50aWNhdGlvbiBmYWlsZWQ6IFVzZXIgbm90IGZvdW5kOiAke3VzZXJuYW1lfWBcblx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdFx0cmV0dXJuIGRvbmUobnVsbCwgZmFsc2UsIHtcblx0XHRcdFx0XHRcdFx0XHRtZXNzYWdlOiAnVXNlciBub3QgZm91bmQnXG5cdFx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRjb25zdCBwZXBwZXIgPSB0aGlzLnZhdWx0LnJldHJpZXZlU2VjcmV0KFxuXHRcdFx0XHRcdFx0XHQnUEVQUEVSJyxcblx0XHRcdFx0XHRcdFx0c2VjcmV0ID0+IHNlY3JldFxuXHRcdFx0XHRcdFx0KTtcblxuXHRcdFx0XHRcdFx0aWYgKHR5cGVvZiBwZXBwZXIgIT09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdFx0XHRcdHRoaXMubG9nZ2VyLmVycm9yKFxuXHRcdFx0XHRcdFx0XHRcdCdGYWlsZWQgdG8gcmV0cmlldmUgdmFsaWQgUEVQUEVSIHNlY3JldCdcblx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIFBFUFBFUiBzZWNyZXQnKTtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0Y29uc3QgcGFzc3dvcmRTZXJ2aWNlID1cblx0XHRcdFx0XHRcdFx0YXdhaXQgQXV0aFNlcnZpY2VGYWN0b3J5LmdldFBhc3N3b3JkU2VydmljZSgpO1xuXHRcdFx0XHRcdFx0Y29uc3QgaXNNYXRjaCA9IGF3YWl0IHBhc3N3b3JkU2VydmljZS5jb21wYXJlUGFzc3dvcmQoXG5cdFx0XHRcdFx0XHRcdHVzZXIucGFzc3dvcmQsXG5cdFx0XHRcdFx0XHRcdHBhc3N3b3JkLFxuXHRcdFx0XHRcdFx0XHRwZXBwZXJcblx0XHRcdFx0XHRcdCk7XG5cblx0XHRcdFx0XHRcdGlmIChpc01hdGNoKSB7XG5cdFx0XHRcdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0XHRcdFx0YExvY2FsIGF1dGhlbnRpY2F0aW9uIHN1Y2Nlc3NmdWwgZm9yIHVzZXI6ICR7dXNlcm5hbWV9YFxuXHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHRyZXR1cm4gZG9uZShudWxsLCB1c2VyKTtcblx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdHRoaXMubG9nZ2VyLndhcm4oXG5cdFx0XHRcdFx0XHRcdFx0YExvY2FsIGF1dGhlbnRpY2F0aW9uIGZhaWxlZDogSW5jb3JyZWN0IHBhc3N3b3JkIGZvciB1c2VyOiAke3VzZXJuYW1lfWBcblx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdFx0cmV0dXJuIGRvbmUobnVsbCwgZmFsc2UsIHtcblx0XHRcdFx0XHRcdFx0XHRtZXNzYWdlOiAnSW5jb3JyZWN0IHBhc3N3b3JkJ1xuXHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0XHRcdFx0dGhpcy5oYW5kbGVQYXNzcG9ydEF1dGhTZXJ2aWNlRXJyb3IoXG5cdFx0XHRcdFx0XHRcdGVycm9yLFxuXHRcdFx0XHRcdFx0XHQnTG9jYWwgYXV0aGVudGljYXRpb24gZmFpbGVkJyxcblx0XHRcdFx0XHRcdFx0eyB1c2VybmFtZSwgcGFzc3dvcmQgfSxcblx0XHRcdFx0XHRcdFx0J0xvY2FsIGF1dGhlbnRpY2F0aW9uIGZhaWxlZCdcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KVxuXHRcdFx0KTtcblxuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnUGFzc3BvcnQgY29uZmlndXJlZCBzdWNjZXNzZnVsbHknKTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcignRmFpbGVkIHRvIGNvbmZpZ3VyZSBQYXNzcG9ydCcpO1xuXHRcdFx0dGhpcy5oYW5kbGVQYXNzcG9ydEF1dGhTZXJ2aWNlRXJyb3IoXG5cdFx0XHRcdGVycm9yLFxuXHRcdFx0XHQnUGFzc3BvcnQgY29uZmlndXJhdGlvbiBmYWlsZWQnLFxuXHRcdFx0XHR7IGVycm9yIH0sXG5cdFx0XHRcdCdGYWlsZWQgdG8gY29uZmlndXJlIFBhc3Nwb3J0J1xuXHRcdFx0KTtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgc2h1dGRvd24oKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ1NodXR0aW5nIGRvd24gUGFzc3BvcnRTZXJ2aWNlLi4uJyk7XG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKFxuXHRcdFx0XHQnQ2xlYXJpbmcgUGFzc3BvcnRTZXJ2aWNlIGNhY2hlIG9yIGhhbmRsZXJzIChpZiBhbnkpLi4uJ1xuXHRcdFx0KTtcblxuXHRcdFx0UGFzc3BvcnRTZXJ2aWNlLmluc3RhbmNlID0gbnVsbDtcblxuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0J1Bhc3Nwb3J0U2VydmljZSBzaHV0ZG93biBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5Lidcblx0XHRcdCk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdGNvbnN0IHV0aWxpdHlFcnJvciA9XG5cdFx0XHRcdG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuVXRpbGl0eUVycm9yUmVjb3ZlcmFibGUoXG5cdFx0XHRcdFx0YEVycm9yIGR1cmluZyBQYXNzcG9ydFNlcnZpY2Ugc2h1dGRvd246ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcn1gXG5cdFx0XHRcdCk7XG5cdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKHV0aWxpdHlFcnJvci5tZXNzYWdlKTtcblx0XHRcdHRoaXMuZXJyb3JIYW5kbGVyLmhhbmRsZUVycm9yKHsgZXJyb3I6IHV0aWxpdHlFcnJvciB9KTtcblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIGhhbmRsZVBhc3Nwb3J0QXV0aFNlcnZpY2VFcnJvcihcblx0XHRlcnJvcjogdW5rbm93bixcblx0XHRlcnJvckhlYWRlcjogc3RyaW5nLFxuXHRcdGVycm9yRGV0YWlsczogb2JqZWN0LFxuXHRcdGN1c3RvbU1lc3NhZ2U6IHN0cmluZ1xuXHQpOiB2b2lkIHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgZXJyb3JNZXNzYWdlID0gYCR7Y3VzdG9tTWVzc2FnZX06ICR7ZXJyb3J9XFxuJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3Iuc3RhY2sgOiAnJ31gO1xuXHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcihlcnJvck1lc3NhZ2UpO1xuXG5cdFx0XHRjb25zdCByZXNvdXJjZUVycm9yID1cblx0XHRcdFx0bmV3IHRoaXMuZXJyb3JIYW5kbGVyLkVycm9yQ2xhc3Nlcy5QYXNzcG9ydEF1dGhTZXJ2aWNlRXJyb3IoXG5cdFx0XHRcdFx0ZXJyb3JIZWFkZXIsXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0ZGV0YWlsczogZXJyb3JEZXRhaWxzLFxuXHRcdFx0XHRcdFx0ZXhwb3NlVG9DbGllbnQ6IGZhbHNlXG5cdFx0XHRcdFx0fVxuXHRcdFx0XHQpO1xuXG5cdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7XG5cdFx0XHRcdGVycm9yOiByZXNvdXJjZUVycm9yXG5cdFx0XHR9KTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5sb2dnZXIuZXJyb3IoXG5cdFx0XHRcdGBFcnJvciBoYW5kbGluZyBQYXNzcG9ydCBBdXRoIFNlcnZpY2UgZXJyb3I6ICR7ZXJyb3J9YFxuXHRcdFx0KTtcblx0XHRcdGNvbnN0IHNldmVyaXR5ID0gdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JTZXZlcml0eS5XQVJOSU5HO1xuXHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3Ioe1xuXHRcdFx0XHRlcnJvcixcblx0XHRcdFx0ZGV0YWlsczoge1xuXHRcdFx0XHRcdGNvbnRleHQ6ICdQYXNzcG9ydCBBdXRoIFNlcnZpY2UnLFxuXHRcdFx0XHRcdGFjdGlvbjogJ1Bhc3NpbmcgZXJyb3IgZnJvbSBQYXNzcG9ydCBBdXRoIFNlcnZpY2UgaGFuZGxlciB0byBFcnJvckhhbmRsZXJTZXJ2aWNlJyxcblx0XHRcdFx0XHRub3RlczogJ0Vycm9yIG9jY3VycmVkIHdoaWxlIGhhbmRsaW5nIEF1dGggQ29udHJvbGxlciBlcnJvcjogUGFzc3BvcnRBdXRoU2VydmljZS5oYW5kbGVQYXNzcG9ydEF1dGhTZXJ2aWNlRXJyb3InXG5cdFx0XHRcdH0sXG5cdFx0XHRcdHNldmVyaXR5XG5cdFx0XHR9KTtcblx0XHR9XG5cdH1cbn1cbiJdfQ==
