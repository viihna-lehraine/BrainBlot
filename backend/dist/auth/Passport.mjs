import { Strategy as LocalStrategy } from 'passport-local';
import { ExtractJwt, Strategy as JwtStrategy } from 'passport-jwt';
import { ServiceFactory } from '../index/factory.mjs';
export class PassportService {
	static instance = null;
	passwordService;
	logger;
	errorLogger;
	errorHandler;
	secrets;
	constructor(passwordService, logger, errorLogger, errorHandler, secrets) {
		this.passwordService = passwordService;
		this.logger = logger;
		this.errorLogger = errorLogger;
		this.errorHandler = errorHandler;
		this.secrets = secrets;
	}
	static async getInstance() {
		if (!PassportService.instance) {
			const passwordService = await ServiceFactory.getPasswordService();
			const logger = await ServiceFactory.getLoggerService();
			const errorLogger = await ServiceFactory.getErrorLoggerService();
			const errorHandler = await ServiceFactory.getErrorHandlerService();
			const secrets = await ServiceFactory.getVaultService();
			PassportService.instance = new PassportService(
				passwordService,
				logger,
				errorLogger,
				errorHandler,
				secrets
			);
		}
		return PassportService.instance;
	}
	async configurePassport(passport, UserModel) {
		try {
			const jwtSecret = this.secrets.retrieveSecret(
				'JWT_SECRET',
				secret => secret
			);
			if (typeof jwtSecret !== 'string') {
				const jwtSecretError =
					new this.errorHandler.ErrorClasses.ConfigurationError(
						'Invalid JWT secret'
					);
				this.errorLogger.logError(jwtSecretError.message);
				this.errorHandler.handleError({ error: jwtSecretError });
				throw jwtSecretError;
			}
			const opts = {
				jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
				secretOrKey: jwtSecret
			};
			passport.use(
				new JwtStrategy(opts, async (jwtPayload, done) => {
					try {
						const user = await UserModel.findByPk(jwtPayload.id);
						if (user) {
							this.logger.info(
								`JWT authentication successful for user: ${user.username}`
							);
							return done(null, user);
						} else {
							this.logger.warn(
								'JWT authentication failed: User not found'
							);
							return done(null, false, {
								message: 'User not found'
							});
						}
					} catch (error) {
						this.handlePassportAuthServiceError(
							error,
							'JWT authentication failed',
							{ jwtPayload },
							'JWT authentication failed'
						);
					}
				})
			);
			passport.use(
				new LocalStrategy(async (username, password, done) => {
					try {
						const user = await UserModel.findOne({
							where: { username }
						});
						if (!user) {
							this.logger.warn(
								`Local authentication failed: User not found: ${username}`
							);
							return done(null, false, {
								message: 'User not found'
							});
						}
						const pepper = this.secrets.retrieveSecret(
							'PEPPER',
							secret => secret
						);
						if (typeof pepper !== 'string') {
							this.logger.error(
								'Failed to retrieve valid PEPPER secret'
							);
							throw new Error('Invalid PEPPER secret');
						}
						const passwordService =
							await ServiceFactory.getPasswordService();
						const isMatch = await passwordService.comparePassword(
							user.password,
							password
						);
						if (isMatch) {
							this.logger.info(
								`Local authentication successful for user: ${username}`
							);
							return done(null, user);
						} else {
							this.logger.warn(
								`Local authentication failed: Incorrect password for user: ${username}`
							);
							return done(null, false, {
								message: 'Incorrect password'
							});
						}
					} catch (error) {
						this.handlePassportAuthServiceError(
							error,
							'Local authentication failed',
							{ username, password },
							'Local authentication failed'
						);
					}
				})
			);
			this.logger.info('Passport configured successfully');
		} catch (error) {
			this.errorLogger.logError('Failed to configure Passport');
			this.handlePassportAuthServiceError(
				error,
				'Passport configuration failed',
				{ error },
				'Failed to configure Passport'
			);
		}
	}
	async shutdown() {
		try {
			this.logger.info('Shutting down PassportService...');
			this.logger.info(
				'Clearing PassportService cache or handlers (if any)...'
			);
			PassportService.instance = null;
			this.logger.info(
				'PassportService shutdown completed successfully.'
			);
		} catch (error) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Error during PassportService shutdown: ${error instanceof Error ? error.message : error}`
				);
			this.errorLogger.logError(utilityError.message);
			this.errorHandler.handleError({ error: utilityError });
		}
	}
	handlePassportAuthServiceError(
		error,
		errorHeader,
		errorDetails,
		customMessage
	) {
		try {
			const errorMessage = `${customMessage}: ${error}\n${error instanceof Error ? error.stack : ''}`;
			this.errorLogger.logError(errorMessage);
			const resourceError =
				new this.errorHandler.ErrorClasses.PassportAuthServiceError(
					errorHeader,
					{
						details: errorDetails,
						exposeToClient: false
					}
				);
			this.errorHandler.handleError({
				error: resourceError
			});
		} catch (error) {
			this.logger.error(
				`Error handling Passport Auth Service error: ${error}`
			);
			const severity = this.errorHandler.ErrorSeverity.WARNING;
			this.errorHandler.handleError({
				error,
				details: {
					context: 'Passport Auth Service',
					action: 'Passing error from Passport Auth Service handler to ErrorHandlerService',
					notes: 'Error occurred while handling Auth Controller error: PassportAuthService.handlePassportAuthServiceError'
				},
				severity
			});
		}
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGFzc3BvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYXV0aC9QYXNzcG9ydC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxJQUFJLGFBQWEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNELE9BQU8sRUFDTixVQUFVLEVBQ1YsUUFBUSxJQUFJLFdBQVcsRUFHdkIsTUFBTSxjQUFjLENBQUM7QUFTdEIsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWxELE1BQU0sT0FBTyxlQUFlO0lBQ25CLE1BQU0sQ0FBQyxRQUFRLEdBQTJCLElBQUksQ0FBQztJQUUvQyxlQUFlLENBQTJCO0lBQzFDLE1BQU0sQ0FBNEI7SUFDbEMsV0FBVyxDQUE4QjtJQUN6QyxZQUFZLENBQStCO0lBQzNDLE9BQU8sQ0FBd0I7SUFFdkMsWUFDQyxlQUF5QyxFQUN6QyxNQUFpQyxFQUNqQyxXQUF3QyxFQUN4QyxZQUEwQyxFQUMxQyxPQUE4QjtRQUU5QixJQUFJLENBQUMsZUFBZSxHQUFHLGVBQWUsQ0FBQztRQUN2QyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQztRQUMvQixJQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztRQUNqQyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztJQUN4QixDQUFDO0lBRU0sTUFBTSxDQUFDLEtBQUssQ0FBQyxXQUFXO1FBQzlCLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDL0IsTUFBTSxlQUFlLEdBQUcsTUFBTSxjQUFjLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztZQUNsRSxNQUFNLE1BQU0sR0FBRyxNQUFNLGNBQWMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3ZELE1BQU0sV0FBVyxHQUFHLE1BQU0sY0FBYyxDQUFDLHFCQUFxQixFQUFFLENBQUM7WUFDakUsTUFBTSxZQUFZLEdBQUcsTUFBTSxjQUFjLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztZQUNuRSxNQUFNLE9BQU8sR0FBRyxNQUFNLGNBQWMsQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUV2RCxlQUFlLENBQUMsUUFBUSxHQUFHLElBQUksZUFBZSxDQUM3QyxlQUFlLEVBQ2YsTUFBTSxFQUNOLFdBQVcsRUFDWCxZQUFZLEVBQ1osT0FBTyxDQUNQLENBQUM7UUFDSCxDQUFDO1FBRUQsT0FBTyxlQUFlLENBQUMsUUFBUSxDQUFDO0lBQ2pDLENBQUM7SUFFTSxLQUFLLENBQUMsaUJBQWlCLENBQzdCLFFBQTJDLEVBQzNDLFNBQStDO1FBRS9DLElBQUksQ0FBQztZQUNKLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUM1QyxZQUFZLEVBQ1osTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQ2hCLENBQUM7WUFFRixJQUFJLE9BQU8sU0FBUyxLQUFLLFFBQVEsRUFBRSxDQUFDO2dCQUNuQyxNQUFNLGNBQWMsR0FDbkIsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxrQkFBa0IsQ0FDcEQsb0JBQW9CLENBQ3BCLENBQUM7Z0JBQ0gsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNsRCxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDO2dCQUN6RCxNQUFNLGNBQWMsQ0FBQztZQUN0QixDQUFDO1lBRUQsTUFBTSxJQUFJLEdBQW9CO2dCQUM3QixjQUFjLEVBQUUsVUFBVSxDQUFDLDJCQUEyQixFQUFFO2dCQUN4RCxXQUFXLEVBQUUsU0FBUzthQUN0QixDQUFDO1lBRUYsUUFBUSxDQUFDLEdBQUcsQ0FDWCxJQUFJLFdBQVcsQ0FDZCxJQUFJLEVBQ0osS0FBSyxFQUFFLFVBQVUsRUFBRSxJQUFzQixFQUFFLEVBQUU7Z0JBQzVDLElBQUksQ0FBQztvQkFDSixNQUFNLElBQUksR0FBRyxNQUFNLFNBQVMsQ0FBQyxRQUFRLENBQ3BDLFVBQVUsQ0FBQyxFQUFFLENBQ2IsQ0FBQztvQkFFRixJQUFJLElBQUksRUFBRSxDQUFDO3dCQUNWLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNmLDJDQUEyQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQzFELENBQUM7d0JBQ0YsT0FBTyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUN6QixDQUFDO3lCQUFNLENBQUM7d0JBQ1AsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQ2YsMkNBQTJDLENBQzNDLENBQUM7d0JBQ0YsT0FBTyxJQUFJLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRTs0QkFDeEIsT0FBTyxFQUFFLGdCQUFnQjt5QkFDekIsQ0FBQyxDQUFDO29CQUNKLENBQUM7Z0JBQ0YsQ0FBQztnQkFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO29CQUNoQixJQUFJLENBQUMsOEJBQThCLENBQ2xDLEtBQUssRUFDTCwyQkFBMkIsRUFDM0IsRUFBRSxVQUFVLEVBQUUsRUFDZCwyQkFBMkIsQ0FDM0IsQ0FBQztnQkFDSCxDQUFDO1lBQ0YsQ0FBQyxDQUNELENBQ0QsQ0FBQztZQUVGLFFBQVEsQ0FBQyxHQUFHLENBQ1gsSUFBSSxhQUFhLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLEVBQUU7Z0JBQ3BELElBQUksQ0FBQztvQkFDSixNQUFNLElBQUksR0FBRyxNQUFNLFNBQVMsQ0FBQyxPQUFPLENBQUM7d0JBQ3BDLEtBQUssRUFBRSxFQUFFLFFBQVEsRUFBRTtxQkFDbkIsQ0FBQyxDQUFDO29CQUVILElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQzt3QkFDWCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDZixnREFBZ0QsUUFBUSxFQUFFLENBQzFELENBQUM7d0JBQ0YsT0FBTyxJQUFJLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRTs0QkFDeEIsT0FBTyxFQUFFLGdCQUFnQjt5QkFDekIsQ0FBQyxDQUFDO29CQUNKLENBQUM7b0JBRUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQ3pDLFFBQVEsRUFDUixNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FDaEIsQ0FBQztvQkFFRixJQUFJLE9BQU8sTUFBTSxLQUFLLFFBQVEsRUFBRSxDQUFDO3dCQUNoQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FDaEIsd0NBQXdDLENBQ3hDLENBQUM7d0JBQ0YsTUFBTSxJQUFJLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO29CQUMxQyxDQUFDO29CQUVELE1BQU0sZUFBZSxHQUNwQixNQUFNLGNBQWMsQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO29CQUMzQyxNQUFNLE9BQU8sR0FBRyxNQUFNLGVBQWUsQ0FBQyxlQUFlLENBQ3BELElBQUksQ0FBQyxRQUFRLEVBQ2IsUUFBUSxDQUNSLENBQUM7b0JBRUYsSUFBSSxPQUFPLEVBQUUsQ0FBQzt3QkFDYixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDZiw2Q0FBNkMsUUFBUSxFQUFFLENBQ3ZELENBQUM7d0JBQ0YsT0FBTyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUN6QixDQUFDO3lCQUFNLENBQUM7d0JBQ1AsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQ2YsNkRBQTZELFFBQVEsRUFBRSxDQUN2RSxDQUFDO3dCQUNGLE9BQU8sSUFBSSxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUU7NEJBQ3hCLE9BQU8sRUFBRSxvQkFBb0I7eUJBQzdCLENBQUMsQ0FBQztvQkFDSixDQUFDO2dCQUNGLENBQUM7Z0JBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztvQkFDaEIsSUFBSSxDQUFDLDhCQUE4QixDQUNsQyxLQUFLLEVBQ0wsNkJBQTZCLEVBQzdCLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxFQUN0Qiw2QkFBNkIsQ0FDN0IsQ0FBQztnQkFDSCxDQUFDO1lBQ0YsQ0FBQyxDQUFDLENBQ0YsQ0FBQztZQUVGLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGtDQUFrQyxDQUFDLENBQUM7UUFDdEQsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDaEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsOEJBQThCLENBQUMsQ0FBQztZQUMxRCxJQUFJLENBQUMsOEJBQThCLENBQ2xDLEtBQUssRUFDTCwrQkFBK0IsRUFDL0IsRUFBRSxLQUFLLEVBQUUsRUFDVCw4QkFBOEIsQ0FDOUIsQ0FBQztRQUNILENBQUM7SUFDRixDQUFDO0lBRU0sS0FBSyxDQUFDLFFBQVE7UUFDcEIsSUFBSSxDQUFDO1lBQ0osSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsa0NBQWtDLENBQUMsQ0FBQztZQUNyRCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDZix3REFBd0QsQ0FDeEQsQ0FBQztZQUVGLGVBQWUsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1lBRWhDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNmLGtEQUFrRCxDQUNsRCxDQUFDO1FBQ0gsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDaEIsTUFBTSxZQUFZLEdBQ2pCLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsdUJBQXVCLENBQ3pELDBDQUEwQyxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FDMUYsQ0FBQztZQUNILElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNoRCxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO1FBQ3hELENBQUM7SUFDRixDQUFDO0lBRU8sOEJBQThCLENBQ3JDLEtBQWMsRUFDZCxXQUFtQixFQUNuQixZQUFvQixFQUNwQixhQUFxQjtRQUVyQixJQUFJLENBQUM7WUFDSixNQUFNLFlBQVksR0FBRyxHQUFHLGFBQWEsS0FBSyxLQUFLLEtBQUssS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDaEcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7WUFFeEMsTUFBTSxhQUFhLEdBQ2xCLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsd0JBQXdCLENBQzFELFdBQVcsRUFDWDtnQkFDQyxPQUFPLEVBQUUsWUFBWTtnQkFDckIsY0FBYyxFQUFFLEtBQUs7YUFDckIsQ0FDRCxDQUFDO1lBRUgsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUM7Z0JBQzdCLEtBQUssRUFBRSxhQUFhO2FBQ3BCLENBQUMsQ0FBQztRQUNKLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2hCLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUNoQiwrQ0FBK0MsS0FBSyxFQUFFLENBQ3RELENBQUM7WUFDRixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUM7WUFDekQsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUM7Z0JBQzdCLEtBQUs7Z0JBQ0wsT0FBTyxFQUFFO29CQUNSLE9BQU8sRUFBRSx1QkFBdUI7b0JBQ2hDLE1BQU0sRUFBRSx5RUFBeUU7b0JBQ2pGLEtBQUssRUFBRSx5R0FBeUc7aUJBQ2hIO2dCQUNELFFBQVE7YUFDUixDQUFDLENBQUM7UUFDSixDQUFDO0lBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN0cmF0ZWd5IGFzIExvY2FsU3RyYXRlZ3kgfSBmcm9tICdwYXNzcG9ydC1sb2NhbCc7XG5pbXBvcnQge1xuXHRFeHRyYWN0Snd0LFxuXHRTdHJhdGVneSBhcyBKd3RTdHJhdGVneSxcblx0U3RyYXRlZ3lPcHRpb25zLFxuXHRWZXJpZmllZENhbGxiYWNrXG59IGZyb20gJ3Bhc3Nwb3J0LWp3dCc7XG5pbXBvcnQge1xuXHRBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFBhc3Nwb3J0U2VydmljZUludGVyZmFjZSxcblx0UGFzc3dvcmRTZXJ2aWNlSW50ZXJmYWNlLFxuXHRWYXVsdFNlcnZpY2VJbnRlcmZhY2Vcbn0gZnJvbSAnLi4vaW5kZXgvaW50ZXJmYWNlcy9zZXJ2aWNlcyc7XG5pbXBvcnQgeyBTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4uL2luZGV4L2ZhY3RvcnknO1xuXG5leHBvcnQgY2xhc3MgUGFzc3BvcnRTZXJ2aWNlIGltcGxlbWVudHMgUGFzc3BvcnRTZXJ2aWNlSW50ZXJmYWNlIHtcblx0cHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IFBhc3Nwb3J0U2VydmljZSB8IG51bGwgPSBudWxsO1xuXG5cdHByaXZhdGUgcGFzc3dvcmRTZXJ2aWNlOiBQYXNzd29yZFNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgbG9nZ2VyOiBBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIGVycm9yTG9nZ2VyOiBFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZXJyb3JIYW5kbGVyOiBFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIHNlY3JldHM6IFZhdWx0U2VydmljZUludGVyZmFjZTtcblxuXHRwcml2YXRlIGNvbnN0cnVjdG9yKFxuXHRcdHBhc3N3b3JkU2VydmljZTogUGFzc3dvcmRTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGxvZ2dlcjogQXBwTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0XHRlcnJvckxvZ2dlcjogRXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGVycm9ySGFuZGxlcjogRXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZSxcblx0XHRzZWNyZXRzOiBWYXVsdFNlcnZpY2VJbnRlcmZhY2Vcblx0KSB7XG5cdFx0dGhpcy5wYXNzd29yZFNlcnZpY2UgPSBwYXNzd29yZFNlcnZpY2U7XG5cdFx0dGhpcy5sb2dnZXIgPSBsb2dnZXI7XG5cdFx0dGhpcy5lcnJvckxvZ2dlciA9IGVycm9yTG9nZ2VyO1xuXHRcdHRoaXMuZXJyb3JIYW5kbGVyID0gZXJyb3JIYW5kbGVyO1xuXHRcdHRoaXMuc2VjcmV0cyA9IHNlY3JldHM7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGFzeW5jIGdldEluc3RhbmNlKCk6IFByb21pc2U8UGFzc3BvcnRTZXJ2aWNlPiB7XG5cdFx0aWYgKCFQYXNzcG9ydFNlcnZpY2UuaW5zdGFuY2UpIHtcblx0XHRcdGNvbnN0IHBhc3N3b3JkU2VydmljZSA9IGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldFBhc3N3b3JkU2VydmljZSgpO1xuXHRcdFx0Y29uc3QgbG9nZ2VyID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0TG9nZ2VyU2VydmljZSgpO1xuXHRcdFx0Y29uc3QgZXJyb3JMb2dnZXIgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRFcnJvckxvZ2dlclNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGVycm9ySGFuZGxlciA9IGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldEVycm9ySGFuZGxlclNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IHNlY3JldHMgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRWYXVsdFNlcnZpY2UoKTtcblxuXHRcdFx0UGFzc3BvcnRTZXJ2aWNlLmluc3RhbmNlID0gbmV3IFBhc3Nwb3J0U2VydmljZShcblx0XHRcdFx0cGFzc3dvcmRTZXJ2aWNlLFxuXHRcdFx0XHRsb2dnZXIsXG5cdFx0XHRcdGVycm9yTG9nZ2VyLFxuXHRcdFx0XHRlcnJvckhhbmRsZXIsXG5cdFx0XHRcdHNlY3JldHNcblx0XHRcdCk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIFBhc3Nwb3J0U2VydmljZS5pbnN0YW5jZTtcblx0fVxuXG5cdHB1YmxpYyBhc3luYyBjb25maWd1cmVQYXNzcG9ydChcblx0XHRwYXNzcG9ydDogaW1wb3J0KCdwYXNzcG9ydCcpLlBhc3Nwb3J0U3RhdGljLFxuXHRcdFVzZXJNb2RlbDogdHlwZW9mIGltcG9ydCgnLi4vbW9kZWxzL1VzZXInKS5Vc2VyXG5cdCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCBqd3RTZWNyZXQgPSB0aGlzLnNlY3JldHMucmV0cmlldmVTZWNyZXQoXG5cdFx0XHRcdCdKV1RfU0VDUkVUJyxcblx0XHRcdFx0c2VjcmV0ID0+IHNlY3JldFxuXHRcdFx0KTtcblxuXHRcdFx0aWYgKHR5cGVvZiBqd3RTZWNyZXQgIT09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdGNvbnN0IGp3dFNlY3JldEVycm9yID1cblx0XHRcdFx0XHRuZXcgdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JDbGFzc2VzLkNvbmZpZ3VyYXRpb25FcnJvcihcblx0XHRcdFx0XHRcdCdJbnZhbGlkIEpXVCBzZWNyZXQnXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcihqd3RTZWNyZXRFcnJvci5tZXNzYWdlKTtcblx0XHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3IoeyBlcnJvcjogand0U2VjcmV0RXJyb3IgfSk7XG5cdFx0XHRcdHRocm93IGp3dFNlY3JldEVycm9yO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCBvcHRzOiBTdHJhdGVneU9wdGlvbnMgPSB7XG5cdFx0XHRcdGp3dEZyb21SZXF1ZXN0OiBFeHRyYWN0Snd0LmZyb21BdXRoSGVhZGVyQXNCZWFyZXJUb2tlbigpLFxuXHRcdFx0XHRzZWNyZXRPcktleTogand0U2VjcmV0XG5cdFx0XHR9O1xuXG5cdFx0XHRwYXNzcG9ydC51c2UoXG5cdFx0XHRcdG5ldyBKd3RTdHJhdGVneShcblx0XHRcdFx0XHRvcHRzLFxuXHRcdFx0XHRcdGFzeW5jIChqd3RQYXlsb2FkLCBkb25lOiBWZXJpZmllZENhbGxiYWNrKSA9PiB7XG5cdFx0XHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdFx0XHRjb25zdCB1c2VyID0gYXdhaXQgVXNlck1vZGVsLmZpbmRCeVBrKFxuXHRcdFx0XHRcdFx0XHRcdGp3dFBheWxvYWQuaWRcblx0XHRcdFx0XHRcdFx0KTtcblxuXHRcdFx0XHRcdFx0XHRpZiAodXNlcikge1xuXHRcdFx0XHRcdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0XHRcdFx0XHRgSldUIGF1dGhlbnRpY2F0aW9uIHN1Y2Nlc3NmdWwgZm9yIHVzZXI6ICR7dXNlci51c2VybmFtZX1gXG5cdFx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gZG9uZShudWxsLCB1c2VyKTtcblx0XHRcdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFx0XHR0aGlzLmxvZ2dlci53YXJuKFxuXHRcdFx0XHRcdFx0XHRcdFx0J0pXVCBhdXRoZW50aWNhdGlvbiBmYWlsZWQ6IFVzZXIgbm90IGZvdW5kJ1xuXHRcdFx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRcdFx0cmV0dXJuIGRvbmUobnVsbCwgZmFsc2UsIHtcblx0XHRcdFx0XHRcdFx0XHRcdG1lc3NhZ2U6ICdVc2VyIG5vdCBmb3VuZCdcblx0XHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdFx0XHRcdFx0dGhpcy5oYW5kbGVQYXNzcG9ydEF1dGhTZXJ2aWNlRXJyb3IoXG5cdFx0XHRcdFx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdFx0XHRcdFx0J0pXVCBhdXRoZW50aWNhdGlvbiBmYWlsZWQnLFxuXHRcdFx0XHRcdFx0XHRcdHsgand0UGF5bG9hZCB9LFxuXHRcdFx0XHRcdFx0XHRcdCdKV1QgYXV0aGVudGljYXRpb24gZmFpbGVkJ1xuXHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0KVxuXHRcdFx0KTtcblxuXHRcdFx0cGFzc3BvcnQudXNlKFxuXHRcdFx0XHRuZXcgTG9jYWxTdHJhdGVneShhc3luYyAodXNlcm5hbWUsIHBhc3N3b3JkLCBkb25lKSA9PiB7XG5cdFx0XHRcdFx0dHJ5IHtcblx0XHRcdFx0XHRcdGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyTW9kZWwuZmluZE9uZSh7XG5cdFx0XHRcdFx0XHRcdHdoZXJlOiB7IHVzZXJuYW1lIH1cblx0XHRcdFx0XHRcdH0pO1xuXG5cdFx0XHRcdFx0XHRpZiAoIXVzZXIpIHtcblx0XHRcdFx0XHRcdFx0dGhpcy5sb2dnZXIud2Fybihcblx0XHRcdFx0XHRcdFx0XHRgTG9jYWwgYXV0aGVudGljYXRpb24gZmFpbGVkOiBVc2VyIG5vdCBmb3VuZDogJHt1c2VybmFtZX1gXG5cdFx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRcdHJldHVybiBkb25lKG51bGwsIGZhbHNlLCB7XG5cdFx0XHRcdFx0XHRcdFx0bWVzc2FnZTogJ1VzZXIgbm90IGZvdW5kJ1xuXHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0Y29uc3QgcGVwcGVyID0gdGhpcy5zZWNyZXRzLnJldHJpZXZlU2VjcmV0KFxuXHRcdFx0XHRcdFx0XHQnUEVQUEVSJyxcblx0XHRcdFx0XHRcdFx0c2VjcmV0ID0+IHNlY3JldFxuXHRcdFx0XHRcdFx0KTtcblxuXHRcdFx0XHRcdFx0aWYgKHR5cGVvZiBwZXBwZXIgIT09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdFx0XHRcdHRoaXMubG9nZ2VyLmVycm9yKFxuXHRcdFx0XHRcdFx0XHRcdCdGYWlsZWQgdG8gcmV0cmlldmUgdmFsaWQgUEVQUEVSIHNlY3JldCdcblx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIFBFUFBFUiBzZWNyZXQnKTtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0Y29uc3QgcGFzc3dvcmRTZXJ2aWNlID1cblx0XHRcdFx0XHRcdFx0YXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0UGFzc3dvcmRTZXJ2aWNlKCk7XG5cdFx0XHRcdFx0XHRjb25zdCBpc01hdGNoID0gYXdhaXQgcGFzc3dvcmRTZXJ2aWNlLmNvbXBhcmVQYXNzd29yZChcblx0XHRcdFx0XHRcdFx0dXNlci5wYXNzd29yZCxcblx0XHRcdFx0XHRcdFx0cGFzc3dvcmRcblx0XHRcdFx0XHRcdCk7XG5cblx0XHRcdFx0XHRcdGlmIChpc01hdGNoKSB7XG5cdFx0XHRcdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0XHRcdFx0YExvY2FsIGF1dGhlbnRpY2F0aW9uIHN1Y2Nlc3NmdWwgZm9yIHVzZXI6ICR7dXNlcm5hbWV9YFxuXHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHRyZXR1cm4gZG9uZShudWxsLCB1c2VyKTtcblx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdHRoaXMubG9nZ2VyLndhcm4oXG5cdFx0XHRcdFx0XHRcdFx0YExvY2FsIGF1dGhlbnRpY2F0aW9uIGZhaWxlZDogSW5jb3JyZWN0IHBhc3N3b3JkIGZvciB1c2VyOiAke3VzZXJuYW1lfWBcblx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdFx0cmV0dXJuIGRvbmUobnVsbCwgZmFsc2UsIHtcblx0XHRcdFx0XHRcdFx0XHRtZXNzYWdlOiAnSW5jb3JyZWN0IHBhc3N3b3JkJ1xuXHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0XHRcdFx0dGhpcy5oYW5kbGVQYXNzcG9ydEF1dGhTZXJ2aWNlRXJyb3IoXG5cdFx0XHRcdFx0XHRcdGVycm9yLFxuXHRcdFx0XHRcdFx0XHQnTG9jYWwgYXV0aGVudGljYXRpb24gZmFpbGVkJyxcblx0XHRcdFx0XHRcdFx0eyB1c2VybmFtZSwgcGFzc3dvcmQgfSxcblx0XHRcdFx0XHRcdFx0J0xvY2FsIGF1dGhlbnRpY2F0aW9uIGZhaWxlZCdcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KVxuXHRcdFx0KTtcblxuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnUGFzc3BvcnQgY29uZmlndXJlZCBzdWNjZXNzZnVsbHknKTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcignRmFpbGVkIHRvIGNvbmZpZ3VyZSBQYXNzcG9ydCcpO1xuXHRcdFx0dGhpcy5oYW5kbGVQYXNzcG9ydEF1dGhTZXJ2aWNlRXJyb3IoXG5cdFx0XHRcdGVycm9yLFxuXHRcdFx0XHQnUGFzc3BvcnQgY29uZmlndXJhdGlvbiBmYWlsZWQnLFxuXHRcdFx0XHR7IGVycm9yIH0sXG5cdFx0XHRcdCdGYWlsZWQgdG8gY29uZmlndXJlIFBhc3Nwb3J0J1xuXHRcdFx0KTtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgc2h1dGRvd24oKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ1NodXR0aW5nIGRvd24gUGFzc3BvcnRTZXJ2aWNlLi4uJyk7XG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKFxuXHRcdFx0XHQnQ2xlYXJpbmcgUGFzc3BvcnRTZXJ2aWNlIGNhY2hlIG9yIGhhbmRsZXJzIChpZiBhbnkpLi4uJ1xuXHRcdFx0KTtcblxuXHRcdFx0UGFzc3BvcnRTZXJ2aWNlLmluc3RhbmNlID0gbnVsbDtcblxuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0J1Bhc3Nwb3J0U2VydmljZSBzaHV0ZG93biBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5Lidcblx0XHRcdCk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdGNvbnN0IHV0aWxpdHlFcnJvciA9XG5cdFx0XHRcdG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuVXRpbGl0eUVycm9yUmVjb3ZlcmFibGUoXG5cdFx0XHRcdFx0YEVycm9yIGR1cmluZyBQYXNzcG9ydFNlcnZpY2Ugc2h1dGRvd246ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcn1gXG5cdFx0XHRcdCk7XG5cdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKHV0aWxpdHlFcnJvci5tZXNzYWdlKTtcblx0XHRcdHRoaXMuZXJyb3JIYW5kbGVyLmhhbmRsZUVycm9yKHsgZXJyb3I6IHV0aWxpdHlFcnJvciB9KTtcblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIGhhbmRsZVBhc3Nwb3J0QXV0aFNlcnZpY2VFcnJvcihcblx0XHRlcnJvcjogdW5rbm93bixcblx0XHRlcnJvckhlYWRlcjogc3RyaW5nLFxuXHRcdGVycm9yRGV0YWlsczogb2JqZWN0LFxuXHRcdGN1c3RvbU1lc3NhZ2U6IHN0cmluZ1xuXHQpOiB2b2lkIHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgZXJyb3JNZXNzYWdlID0gYCR7Y3VzdG9tTWVzc2FnZX06ICR7ZXJyb3J9XFxuJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3Iuc3RhY2sgOiAnJ31gO1xuXHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcihlcnJvck1lc3NhZ2UpO1xuXG5cdFx0XHRjb25zdCByZXNvdXJjZUVycm9yID1cblx0XHRcdFx0bmV3IHRoaXMuZXJyb3JIYW5kbGVyLkVycm9yQ2xhc3Nlcy5QYXNzcG9ydEF1dGhTZXJ2aWNlRXJyb3IoXG5cdFx0XHRcdFx0ZXJyb3JIZWFkZXIsXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0ZGV0YWlsczogZXJyb3JEZXRhaWxzLFxuXHRcdFx0XHRcdFx0ZXhwb3NlVG9DbGllbnQ6IGZhbHNlXG5cdFx0XHRcdFx0fVxuXHRcdFx0XHQpO1xuXG5cdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7XG5cdFx0XHRcdGVycm9yOiByZXNvdXJjZUVycm9yXG5cdFx0XHR9KTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5sb2dnZXIuZXJyb3IoXG5cdFx0XHRcdGBFcnJvciBoYW5kbGluZyBQYXNzcG9ydCBBdXRoIFNlcnZpY2UgZXJyb3I6ICR7ZXJyb3J9YFxuXHRcdFx0KTtcblx0XHRcdGNvbnN0IHNldmVyaXR5ID0gdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JTZXZlcml0eS5XQVJOSU5HO1xuXHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3Ioe1xuXHRcdFx0XHRlcnJvcixcblx0XHRcdFx0ZGV0YWlsczoge1xuXHRcdFx0XHRcdGNvbnRleHQ6ICdQYXNzcG9ydCBBdXRoIFNlcnZpY2UnLFxuXHRcdFx0XHRcdGFjdGlvbjogJ1Bhc3NpbmcgZXJyb3IgZnJvbSBQYXNzcG9ydCBBdXRoIFNlcnZpY2UgaGFuZGxlciB0byBFcnJvckhhbmRsZXJTZXJ2aWNlJyxcblx0XHRcdFx0XHRub3RlczogJ0Vycm9yIG9jY3VycmVkIHdoaWxlIGhhbmRsaW5nIEF1dGggQ29udHJvbGxlciBlcnJvcjogUGFzc3BvcnRBdXRoU2VydmljZS5oYW5kbGVQYXNzcG9ydEF1dGhTZXJ2aWNlRXJyb3InXG5cdFx0XHRcdH0sXG5cdFx0XHRcdHNldmVyaXR5XG5cdFx0XHR9KTtcblx0XHR9XG5cdH1cbn1cbiJdfQ==
