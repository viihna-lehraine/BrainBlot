import { ServiceFactory } from '../index/factory.mjs';
export class EmailMFAService {
	static instance = null;
	cacheService;
	logger;
	errorLogger;
	errorHandler;
	vault;
	constructor() {}
	static async getInstance() {
		if (!EmailMFAService.instance) {
			const cacheService = await ServiceFactory.getCacheService();
			const logger = await ServiceFactory.getLoggerService();
			const errorLogger = await ServiceFactory.getErrorLoggerService();
			const errorHandler = await ServiceFactory.getErrorHandlerService();
			const vault = await ServiceFactory.getVaultService();
			EmailMFAService.instance = new EmailMFAService();
			EmailMFAService.instance.cacheService = cacheService;
			EmailMFAService.instance.logger = logger;
			EmailMFAService.instance.errorLogger = errorLogger;
			EmailMFAService.instance.errorHandler = errorHandler;
			EmailMFAService.instance.vault = vault;
		}
		return EmailMFAService.instance;
	}
	async generateEmailMFACode({ bcrypt, jwt }) {
		try {
			const emailMFACode = await bcrypt.genSalt(6);
			const key = await this.vault.retrieveSecret(
				'EMAIL_MFA_KEY',
				secret => secret
			);
			if (typeof key !== 'string') {
				this.logger.warn(
					'Valid Email MFA key not found during email 2FA code generation'
				);
				return { emailMFACode: '', emailMFAToken: '' };
			}
			const emailMFAToken = jwt.sign({ emailMFACode }, key, {
				expiresIn: '30m'
			});
			return { emailMFACode, emailMFAToken };
		} catch (utilError) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Error generating email 2FA code: ${
						utilError instanceof Error
							? utilError.message
							: utilError
					}`
				);
			this.errorLogger.logError(utilityError.message);
			this.errorHandler.handleError({ error: utilityError });
			return { emailMFACode: '', emailMFAToken: '' };
		}
	}
	async verifyEmailMFACode(email, submittedCode) {
		try {
			const cachedToken = await this.cacheService.get(
				`mfaToken:${email}`,
				'auth'
			);
			if (!cachedToken) {
				this.logger.warn(
					`MFA token not found or expired for email: ${email}`
				);
				throw new this.errorHandler.ErrorClasses.InvalidInputError(
					'MFA token expired or invalid'
				);
			}
			const jwt = await this.loadJwt();
			const emailMFAKey = await this.vault.retrieveSecret(
				'EMAIL_MFA_KEY',
				secret => secret
			);
			if (!emailMFAKey) {
				this.logger.warn(
					'Valid Email MFA key not found during email 2FA code verification'
				);
				return false;
			}
			const decodedToken = jwt.verify(cachedToken, emailMFAKey);
			if (
				!decodedToken ||
				typeof decodedToken.emailMFACode !== 'string'
			) {
				this.logger.warn(
					`Invalid token structure during MFA verification for email: ${email}`
				);
				return false;
			}
			if (decodedToken.emailMFACode !== submittedCode) {
				this.logger.warn(`Invalid MFA code for email: ${email}`);
				return false;
			}
			await this.cacheService.del(`mfaToken:${email}`, 'auth');
			this.logger.info(`MFA verification successful for email: ${email}`);
			return true;
		} catch (error) {
			this.logger.error(`Error verifying MFA for email: ${email}`, {
				error
			});
			throw error;
		}
	}
	async shutdown() {
		try {
			this.logger.info('Clearing MFA tokens from cache...');
			await this.cacheService.clearNamespace('auth');
			EmailMFAService.instance = null;
			this.logger.info('EmailMFAService shutdown successfully.');
		} catch (error) {
			this.errorLogger.logError(
				`Error shutting down EmailMFAService: ${error instanceof Error ? error.message : error}`
			);
		}
	}
	async loadJwt() {
		return (await import('jsonwebtoken')).default;
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRW1haWxNRkEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYXV0aC9FbWFpbE1GQS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFTQSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFHbEQsTUFBTSxPQUFPLGVBQWU7SUFDbkIsTUFBTSxDQUFDLFFBQVEsR0FBMkIsSUFBSSxDQUFDO0lBQy9DLFlBQVksQ0FBeUI7SUFDckMsTUFBTSxDQUE2QjtJQUNuQyxXQUFXLENBQStCO0lBQzFDLFlBQVksQ0FBZ0M7SUFDNUMsS0FBSyxDQUF5QjtJQUV0QyxnQkFBdUIsQ0FBQztJQUVqQixNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVc7UUFDOUIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUMvQixNQUFNLFlBQVksR0FBRyxNQUFNLGNBQWMsQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUM1RCxNQUFNLE1BQU0sR0FBRyxNQUFNLGNBQWMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3ZELE1BQU0sV0FBVyxHQUFHLE1BQU0sY0FBYyxDQUFDLHFCQUFxQixFQUFFLENBQUM7WUFDakUsTUFBTSxZQUFZLEdBQUcsTUFBTSxjQUFjLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztZQUNuRSxNQUFNLEtBQUssR0FBRyxNQUFNLGNBQWMsQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUVyRCxlQUFlLENBQUMsUUFBUSxHQUFHLElBQUksZUFBZSxFQUFFLENBQUM7WUFDakQsZUFBZSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1lBQ3JELGVBQWUsQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztZQUN6QyxlQUFlLENBQUMsUUFBUSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7WUFDbkQsZUFBZSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1lBQ3JELGVBQWUsQ0FBQyxRQUFR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S0FBSyxFQUFFLENBQ3hGLENBQUM7UUFDSCxDQUFDO0lBQ0YsQ0FBQztJQUVTLEtBQUssQ0FBQyxPQUFPO1FBQ3RCLE9BQU8sQ0FBQyxNQUFNLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztJQUMvQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcblx0QXBwTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0Q2FjaGVTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFbWFpbE1GQVNlcnZpY2VJbnRlcmZhY2UsXG5cdEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0RXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZSxcblx0VmF1bHRTZXJ2aWNlSW50ZXJmYWNlXG59IGZyb20gJy4uL2luZGV4L2ludGVyZmFjZXMvc2VydmljZXMnO1xuaW1wb3J0IHsgRW1haWxNRkFTZXJ2aWNlRGVwcyB9IGZyb20gJy4uL2luZGV4L2ludGVyZmFjZXMvc2VydmljZURlcHMnO1xuaW1wb3J0IHsgU2VydmljZUZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5JztcbmltcG9ydCB7IEp3dFBheWxvYWQgfSBmcm9tICdqc29ud2VidG9rZW4nO1xuXG5leHBvcnQgY2xhc3MgRW1haWxNRkFTZXJ2aWNlIGltcGxlbWVudHMgRW1haWxNRkFTZXJ2aWNlSW50ZXJmYWNlIHtcblx0cHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IEVtYWlsTUZBU2VydmljZSB8IG51bGwgPSBudWxsO1xuXHRwcml2YXRlIGNhY2hlU2VydmljZSE6IENhY2hlU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBsb2dnZXIhOiBBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIGVycm9yTG9nZ2VyITogRXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIGVycm9ySGFuZGxlciE6IEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgdmF1bHQhOiBWYXVsdFNlcnZpY2VJbnRlcmZhY2U7XG5cblx0cHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHt9XG5cblx0cHVibGljIHN0YXRpYyBhc3luYyBnZXRJbnN0YW5jZSgpOiBQcm9taXNlPEVtYWlsTUZBU2VydmljZUludGVyZmFjZT4ge1xuXHRcdGlmICghRW1haWxNRkFTZXJ2aWNlLmluc3RhbmNlKSB7XG5cdFx0XHRjb25zdCBjYWNoZVNlcnZpY2UgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRDYWNoZVNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGxvZ2dlciA9IGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldExvZ2dlclNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGVycm9yTG9nZ2VyID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0RXJyb3JMb2dnZXJTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCBlcnJvckhhbmRsZXIgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRFcnJvckhhbmRsZXJTZXJ2aWNlKCk7XG5cdFx0XHRjb25zdCB2YXVsdCA9IGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldFZhdWx0U2VydmljZSgpO1xuXG5cdFx0XHRFbWFpbE1GQVNlcnZpY2UuaW5zdGFuY2UgPSBuZXcgRW1haWxNRkFTZXJ2aWNlKCk7XG5cdFx0XHRFbWFpbE1GQVNlcnZpY2UuaW5zdGFuY2UuY2FjaGVTZXJ2aWNlID0gY2FjaGVTZXJ2aWNlO1xuXHRcdFx0RW1haWxNRkFTZXJ2aWNlLmluc3RhbmNlLmxvZ2dlciA9IGxvZ2dlcjtcblx0XHRcdEVtYWlsTUZBU2VydmljZS5pbnN0YW5jZS5lcnJvckxvZ2dlciA9IGVycm9yTG9nZ2VyO1xuXHRcdFx0RW1haWxNRkFTZXJ2aWNlLmluc3RhbmNlLmVycm9ySGFuZGxlciA9IGVycm9ySGFuZGxlcjtcblx0XHRcdEVtYWlsTUZBU2VydmljZS5pbnN0YW5jZS52YXVsdCA9IHZhdWx0O1xuXHRcdH1cblxuXHRcdHJldHVybiBFbWFpbE1GQVNlcnZpY2UuaW5zdGFuY2U7XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgZ2VuZXJhdGVFbWFpbE1GQUNvZGUoe1xuXHRcdGJjcnlwdCxcblx0XHRqd3Rcblx0fTogRW1haWxNRkFTZXJ2aWNlRGVwcyk6IFByb21pc2U8e1xuXHRcdGVtYWlsTUZBQ29kZTogc3RyaW5nO1xuXHRcdGVtYWlsTUZBVG9rZW46IHN0cmluZztcblx0fT4ge1xuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCBlbWFpbE1GQUNvZGUgPSBhd2FpdCBiY3J5cHQuZ2VuU2FsdCg2KTtcblx0XHRcdGNvbnN0IGtleSA9IGF3YWl0IHRoaXMudmF1bHQucmV0cmlldmVTZWNyZXQoXG5cdFx0XHRcdCdFTUFJTF9NRkFfS0VZJyxcblx0XHRcdFx0c2VjcmV0ID0+IHNlY3JldFxuXHRcdFx0KTtcblxuXHRcdFx0aWYgKHR5cGVvZiBrZXkgIT09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLndhcm4oXG5cdFx0XHRcdFx0J1ZhbGlkIEVtYWlsIE1GQSBrZXkgbm90IGZvdW5kIGR1cmluZyBlbWFpbCAyRkEgY29kZSBnZW5lcmF0aW9uJ1xuXHRcdFx0XHQpO1xuXHRcdFx0XHRyZXR1cm4geyBlbWFpbE1GQUNvZGU6ICcnLCBlbWFpbE1GQVRva2VuOiAnJyB9O1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCBlbWFpbE1GQVRva2VuID0gand0LnNpZ24oeyBlbWFpbE1GQUNvZGUgfSwga2V5LCB7XG5cdFx0XHRcdGV4cGlyZXNJbjogJzMwbSdcblx0XHRcdH0pO1xuXG5cdFx0XHRyZXR1cm4geyBlbWFpbE1GQUNvZGUsIGVtYWlsTUZBVG9rZW4gfTtcblx0XHR9IGNhdGNoICh1dGlsRXJyb3IpIHtcblx0XHRcdGNvbnN0IHV0aWxpdHlFcnJvciA9XG5cdFx0XHRcdG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuVXRpbGl0eUVycm9yUmVjb3ZlcmFibGUoXG5cdFx0XHRcdFx0YEVycm9yIGdlbmVyYXRpbmcgZW1haWwgMkZBIGNvZGU6ICR7XG5cdFx0XHRcdFx0XHR1dGlsRXJyb3IgaW5zdGFuY2VvZiBFcnJvclxuXHRcdFx0XHRcdFx0XHQ/IHV0aWxFcnJvci5tZXNzYWdlXG5cdFx0XHRcdFx0XHRcdDogdXRpbEVycm9yXG5cdFx0XHRcdFx0fWBcblx0XHRcdFx0KTtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nRXJyb3IodXRpbGl0eUVycm9yLm1lc3NhZ2UpO1xuXHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3IoeyBlcnJvcjogdXRpbGl0eUVycm9yIH0pO1xuXG5cdFx0XHRyZXR1cm4geyBlbWFpbE1GQUNvZGU6ICcnLCBlbWFpbE1GQVRva2VuOiAnJyB9O1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyB2ZXJpZnlFbWFpbE1GQUNvZGUoXG5cdFx0ZW1haWw6IHN0cmluZyxcblx0XHRzdWJtaXR0ZWRDb2RlOiBzdHJpbmdcblx0KTogUHJvbWlzZTxib29sZWFuPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IGNhY2hlZFRva2VuID0gYXdhaXQgdGhpcy5jYWNoZVNlcnZpY2UuZ2V0PHN0cmluZz4oXG5cdFx0XHRcdGBtZmFUb2tlbjoke2VtYWlsfWAsXG5cdFx0XHRcdCdhdXRoJ1xuXHRcdFx0KTtcblxuXHRcdFx0aWYgKCFjYWNoZWRUb2tlbikge1xuXHRcdFx0XHR0aGlzLmxvZ2dlci53YXJuKFxuXHRcdFx0XHRcdGBNRkEgdG9rZW4gbm90IGZvdW5kIG9yIGV4cGlyZWQgZm9yIGVtYWlsOiAke2VtYWlsfWBcblx0XHRcdFx0KTtcblx0XHRcdFx0dGhyb3cgbmV3IHRoaXMuZXJyb3JIYW5kbGVyLkVycm9yQ2xhc3Nlcy5JbnZhbGlkSW5wdXRFcnJvcihcblx0XHRcdFx0XHQnTUZBIHRva2VuIGV4cGlyZWQgb3IgaW52YWxpZCdcblx0XHRcdFx0KTtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3Qgand0ID0gYXdhaXQgdGhpcy5sb2FkSnd0KCk7XG5cdFx0XHRjb25zdCBlbWFpbE1GQUtleSA9IGF3YWl0IHRoaXMudmF1bHQucmV0cmlldmVTZWNyZXQoXG5cdFx0XHRcdCdFTUFJTF9NRkFfS0VZJyxcblx0XHRcdFx0c2VjcmV0ID0+IHNlY3JldFxuXHRcdFx0KTtcblxuXHRcdFx0aWYgKCFlbWFpbE1GQUtleSkge1xuXHRcdFx0XHR0aGlzLmxvZ2dlci53YXJuKFxuXHRcdFx0XHRcdCdWYWxpZCBFbWFpbCBNRkEga2V5IG5vdCBmb3VuZCBkdXJpbmcgZW1haWwgMkZBIGNvZGUgdmVyaWZpY2F0aW9uJ1xuXHRcdFx0XHQpO1xuXHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IGRlY29kZWRUb2tlbiA9IGp3dC52ZXJpZnkoXG5cdFx0XHRcdGNhY2hlZFRva2VuLFxuXHRcdFx0XHRlbWFpbE1GQUtleVxuXHRcdFx0KSBhcyBKd3RQYXlsb2FkO1xuXG5cdFx0XHRpZiAoXG5cdFx0XHRcdCFkZWNvZGVkVG9rZW4gfHxcblx0XHRcdFx0dHlwZW9mIGRlY29kZWRUb2tlbi5lbWFpbE1GQUNvZGUgIT09ICdzdHJpbmcnXG5cdFx0XHQpIHtcblx0XHRcdFx0dGhpcy5sb2dnZXIud2Fybihcblx0XHRcdFx0XHRgSW52YWxpZCB0b2tlbiBzdHJ1Y3R1cmUgZHVyaW5nIE1GQSB2ZXJpZmljYXRpb24gZm9yIGVtYWlsOiAke2VtYWlsfWBcblx0XHRcdFx0KTtcblx0XHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoZGVjb2RlZFRva2VuLmVtYWlsTUZBQ29kZSAhPT0gc3VibWl0dGVkQ29kZSkge1xuXHRcdFx0XHR0aGlzLmxvZ2dlci53YXJuKGBJbnZhbGlkIE1GQSBjb2RlIGZvciBlbWFpbDogJHtlbWFpbH1gKTtcblx0XHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdFx0fVxuXG5cdFx0XHRhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5kZWwoYG1mYVRva2VuOiR7ZW1haWx9YCwgJ2F1dGgnKTtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oYE1GQSB2ZXJpZmljYXRpb24gc3VjY2Vzc2Z1bCBmb3IgZW1haWw6ICR7ZW1haWx9YCk7XG5cblx0XHRcdHJldHVybiB0cnVlO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5lcnJvcihgRXJyb3IgdmVyaWZ5aW5nIE1GQSBmb3IgZW1haWw6ICR7ZW1haWx9YCwge1xuXHRcdFx0XHRlcnJvclxuXHRcdFx0fSk7XG5cdFx0XHR0aHJvdyBlcnJvcjtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgc2h1dGRvd24oKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ0NsZWFyaW5nIE1GQSB0b2tlbnMgZnJvbSBjYWNoZS4uLicpO1xuXHRcdFx0YXdhaXQgdGhpcy5jYWNoZVNlcnZpY2UuY2xlYXJOYW1lc3BhY2UoJ2F1dGgnKTtcblxuXHRcdFx0RW1haWxNRkFTZXJ2aWNlLmluc3RhbmNlID0gbnVsbDtcblxuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnRW1haWxNRkFTZXJ2aWNlIHNodXRkb3duIHN1Y2Nlc3NmdWxseS4nKTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcihcblx0XHRcdFx0YEVycm9yIHNodXR0aW5nIGRvd24gRW1haWxNRkFTZXJ2aWNlOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogZXJyb3J9YFxuXHRcdFx0KTtcblx0XHR9XG5cdH1cblxuXHRwcm90ZWN0ZWQgYXN5bmMgbG9hZEp3dCgpOiBQcm9taXNlPEVtYWlsTUZBU2VydmljZURlcHNbJ2p3dCddPiB7XG5cdFx0cmV0dXJuIChhd2FpdCBpbXBvcnQoJ2pzb253ZWJ0b2tlbicpKS5kZWZhdWx0O1xuXHR9XG59XG4iXX0=
