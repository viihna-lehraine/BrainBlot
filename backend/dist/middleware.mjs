import sops from './utils/sops';
import { execSync } from 'child_process';
import compression from 'compression';
import responseTime from 'response-time';
import validator from 'validator';
import { initializeSlowdownMiddleware } from './middleware/slowdown';
import { validateDependencies } from './utils/validateDependencies';
export async function initializeMiddleware({
	express,
	session,
	cookieParser,
	cors,
	hpp,
	morgan,
	passport,
	randomBytes,
	RedisStore,
	initializeCsrfMiddleware,
	getRedisClient,
	ipBlacklistMiddleware,
	initializeRateLimitMiddleware,
	initializeSecurityHeaders,
	createMemoryMonitor,
	logger,
	staticRootPath,
	featureFlags,
	expressErrorHandler,
	processError,
	verifyJwt,
	initializeJwtAuthMiddleware,
	initializePassportAuthMiddleware,
	authenticateOptions,
	initializeValidatorMiddleware
}) {
	try {
		const app = express();
		validateDependencies(
			[
				{ name: 'express', instance: express },
				{ name: 'session', instance: session },
				{ name: 'cookieParser', instance: cookieParser },
				{ name: 'cors', instance: cors },
				{ name: 'hpp', instance: hpp },
				{ name: 'morgan', instance: morgan },
				{ name: 'passport', instance: passport },
				{ name: 'randomBytes', instance: randomBytes },
				{ name: 'RedisStore', instance: RedisStore },
				{
					name: 'initializeCsrfMiddleware',
					instance: initializeCsrfMiddleware
				},
				{ name: 'getRedisClient', instance: getRedisClient },
				{
					name: 'ipBlacklistMiddleware',
					instance: ipBlacklistMiddleware
				},
				{
					name: 'initializeRateLimitMiddleware',
					instance: initializeRateLimitMiddleware
				},
				{
					name: 'initializeSecurityHeaders',
					instance: initializeSecurityHeaders
				},
				{ name: 'createMemoryMonitor', instance: createMemoryMonitor },
				{ name: 'logger', instance: logger },
				{ name: 'staticRootPath', instance: staticRootPath },
				{ name: 'featureFlags', instance: featureFlags },
				{ name: 'expressErrorHandler', instance: expressErrorHandler },
				{ name: 'processError', instance: processError }
			],
			logger || console
		);
		const secrets = await sops.getSecrets({
			logger,
			execSync,
			getDirectoryPath: () => process.cwd()
		});
		const redisClient = await getRedisClient();
		// initialize body parser
		app.use(express.json());
		app.use(express.urlencoded({ extended: true }));
		// initialize cookie parser
		app.use(cookieParser());
		// initialize morgan logger
		const stream = {
			write: message => logger.info(message.trim())
		};
		app.use(morgan('combined', { stream }));
		// initialize CORS
		app.use(cors());
		// initialize HPP
		app.use(hpp());
		// initialize session with Redis store
		app.use(
			session({
				secret: secrets.SESSION_SECRET,
				resave: false,
				saveUninitialized: true,
				store:
					featureFlags.enableRedisFlag && redisClient
						? new RedisStore({ client: redisClient })
						: undefined,
				cookie: {
					secure: featureFlags.enableSslFlag,
					httpOnly: true,
					sameSite: 'strict'
				}
			})
		);
		// initialize passport
		app.use(passport.initialize());
		app.use(passport.session());
		// initialize compression
		app.use(compression());
		// initialize response time
		app.use(responseTime());
		// set e-tag header for client-side caching
		app.set('etag', 'strong');
		// initialize security headers
		initializeSecurityHeaders(app, {
			helmetOptions: {},
			permissionsPolicyOptions: {}
		});
		// initialize CSRF middleware
		app.use(initializeCsrfMiddleware);
		// initialize validator middleware
		initializeValidatorMiddleware({ validator, logger });
		// initialize memory monitor or Redis session based on flag
		if (!featureFlags.enableRedisFlag) {
			createMemoryMonitor();
		}
		// initialize rate limiter
		if (featureFlags.enableRateLimitFlag) {
			app.use(initializeRateLimitMiddleware);
		}
		// initialize slowdown middleware
		initializeSlowdownMiddleware({ slowdownThreshold: 100, logger });
		// initialize IP blacklist middleware
		if (featureFlags.enableIpBlacklistFlag) {
			app.use(ipBlacklistMiddleware);
		}
		// initialize JWT authentication middleware
		app.use(initializeJwtAuthMiddleware({ logger, verifyJwt }));
		// initialize passport authentication middleware
		app.use(
			initializePassportAuthMiddleware({
				passport,
				authenticateOptions,
				logger
			})
		);
		// initialize error handler
		app.use(expressErrorHandler({ logger, featureFlags }));
		return app;
	} catch (error) {
		processError(error, logger || console);
		throw new Error(
			`Failed to initialize app. See logs for more details: ${error instanceof Error ? error.message : error}`
		);
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWlkZGxld2FyZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9taWRkbGV3YXJlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWtCQSxPQUFPLElBQW9CLE1BQU0sY0FBYyxDQUFDO0FBQ2hELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxXQUFXLE1BQU0sYUFBYSxDQUFDO0FBQ3RDLE9BQU8sWUFBWSxNQUFNLGVBQWUsQ0FBQztBQUd6QyxPQUFPLFNBQVMsTUFBTSxXQUFXLENBQUM7QUFDbEMsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDckUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFpQ3BFLE1BQU0sQ0FBQyxLQUFLLFVBQVUsb0JBQW9CLENBQUMsRUFDMUMsT0FBTyxFQUNQLE9BQU8sRUFDUCxZQUFZLEVBQ1osSUFBSSxFQUNKLEdBQUcsRUFDSCxNQUFNLEVBQ04sUUFBUSxFQUNSLFdBQVcsRUFDWCxVQUFVLEVBQ1Ysd0JBQXdCLEVBQ3hCLGNBQWMsRUFDZCxxQkFBcUIsRUFDckIsNkJBQTZCLEVBQzdCLHlCQUF5QixFQUN6QixtQkFBbUIsRUFDbkIsTUFBTSxFQUNOLGNBQWMsRUFDZCxZQUFZLEVBQ1osbUJBQW1CLEVBQ25CLFlBQVksRUFDWixTQUFTLEVBQ1QsMkJBQTJCLEVBQzNCLGdDQUFnQyxFQUNoQyxtQkFBbUIsRUFDbkIsNkJBQTZCLEVBQ0w7SUFDeEIsSUFBSSxDQUFDO1FBQ0osTUFBTSxHQUFHLEdBQUcsT0FBTyxFQUFFLENBQUM7UUFFdEIsb0JBQW9CLENBQ25CO1lBQ0MsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUU7WUFDdEMsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUU7WUFDdEMsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFB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QyxHQUFHLENBQUMsR0FBRyxDQUFDLDZCQUE2QixDQUFDLENBQUM7UUFDeEMsQ0FBQztRQUVELGlDQUFpQztRQUNqQyw0QkFBNEIsQ0FBQyxFQUFFLGlCQUFpQixFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBRWpFLHFDQUFxQztRQUNyQyxJQUFJLFlBQVksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1lBQ3hDLEdBQUcsQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUNoQyxDQUFDO1FBRUQsMkNBQTJDO1FBQzNDLEdBQUcsQ0FBQyxHQUFHLENBQUMsMkJBQTJCLENBQUMsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRTVELGdEQUFnRDtRQUNoRCxHQUFHLENBQUMsR0FBRyxDQUNOLGdDQUFnQyxDQUFDO1lBQ2hDLFFBQVE7WUFDUixtQkFBbUI7WUFDbkIsTUFBTTtTQUNOLENBQUMsQ0FDRixDQUFDO1FBRUYsMkJBQTJCO1FBQzNCLEdBQUcsQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRXZELE9BQU8sR0FBRyxDQUFDO0lBQ1osQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDaEIsWUFBWSxDQUFDLEtBQWMsRUFBRSxNQUFNLElBQUksT0FBTyxDQUFDLENBQUM7UUFDaEQsTUFBTSxJQUFJLEtBQUssQ0FDZCx3REFBd0QsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQ3hHLENBQUM7SUFDSCxDQUFDO0FBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBleHByZXNzLCB7IEFwcGxpY2F0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgc2Vzc2lvbiBmcm9tICdleHByZXNzLXNlc3Npb24nO1xuaW1wb3J0IG1vcmdhbiwgeyBTdHJlYW1PcHRpb25zIH0gZnJvbSAnbW9yZ2FuJztcbmltcG9ydCBjb29raWVQYXJzZXIgZnJvbSAnY29va2llLXBhcnNlcic7XG5pbXBvcnQgY29ycyBmcm9tICdjb3JzJztcbmltcG9ydCBocHAgZnJvbSAnaHBwJztcbmltcG9ydCBwYXNzcG9ydCwgeyBBdXRoZW50aWNhdGVPcHRpb25zIH0gZnJvbSAncGFzc3BvcnQnO1xuaW1wb3J0IFJlZGlzU3RvcmUgZnJvbSAnY29ubmVjdC1yZWRpcyc7XG5pbXBvcnQgeyByYW5kb21CeXRlcyB9IGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgeyBpbml0aWFsaXplQ3NyZk1pZGRsZXdhcmUgfSBmcm9tICcuL21pZGRsZXdhcmUvY3NyZic7XG5pbXBvcnQgeyBleHByZXNzRXJyb3JIYW5kbGVyIH0gZnJvbSAnLi9taWRkbGV3YXJlL2V4cHJlc3NFcnJvckhhbmRsZXInO1xuaW1wb3J0IHsgaW5pdGlhbGl6ZVNlY3VyaXR5SGVhZGVycyB9IGZyb20gJy4vbWlkZGxld2FyZS9zZWN1cml0eUhlYWRlcnMnO1xuaW1wb3J0IHsgaXBCbGFja2xpc3RNaWRkbGV3YXJlIH0gZnJvbSAnLi9taWRkbGV3YXJlL2lwQmxhY2tsaXN0JztcbmltcG9ydCB7IGluaXRpYWxpemVKd3RBdXRoTWlkZGxld2FyZSB9IGZyb20gJy4vbWlkZGxld2FyZS9qd3RBdXRoJztcbmltcG9ydCB7IGluaXRpYWxpemVSYXRlTGltaXRNaWRkbGV3YXJlIH0gZnJvbSAnLi9taWRkbGV3YXJlL3JhdGVMaW1pdCc7XG5pbXBvcnQgeyBGZWF0dXJlRmxhZ3MgfSBmcm9tICcuL2NvbmZpZy9lbnZpcm9ubWVudENvbmZpZyc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICcuL2NvbmZpZy9sb2dnZXInO1xuaW1wb3J0IHsgZ2V0UmVkaXNDbGllbnQgfSBmcm9tICcuL2NvbmZpZy9yZWRpcyc7XG5pbXBvcnQgc29wcywgeyBTZWNyZXRzTWFwIH0gZnJvbSAnLi91dGlscy9zb3BzJztcbmltcG9ydCB7IGV4ZWNTeW5jIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgY29tcHJlc3Npb24gZnJvbSAnY29tcHJlc3Npb24nO1xuaW1wb3J0IHJlc3BvbnNlVGltZSBmcm9tICdyZXNwb25zZS10aW1lJztcbmltcG9ydCB7IGluaXRpYWxpemVQYXNzcG9ydEF1dGhNaWRkbGV3YXJlIH0gZnJvbSAnLi9taWRkbGV3YXJlL3Bhc3Nwb3J0QXV0aCc7XG5pbXBvcnQgeyBpbml0aWFsaXplVmFsaWRhdG9yTWlkZGxld2FyZSB9IGZyb20gJy4vbWlkZGxld2FyZS92YWxpZGF0b3InO1xuaW1wb3J0IHZhbGlkYXRvciBmcm9tICd2YWxpZGF0b3InO1xuaW1wb3J0IHsgaW5pdGlhbGl6ZVNsb3dkb3duTWlkZGxld2FyZSB9IGZyb20gJy4vbWlkZGxld2FyZS9zbG93ZG93bic7XG5pbXBvcnQgeyB2YWxpZGF0ZURlcGVuZGVuY2llcyB9IGZyb20gJy4vdXRpbHMvdmFsaWRhdGVEZXBlbmRlbmNpZXMnO1xuaW1wb3J0IHsgcHJvY2Vzc0Vycm9yIH0gZnJvbSAnLi91dGlscy9wcm9jZXNzRXJyb3InO1xuXG5pbnRlcmZhY2UgTWlkZGxld2FyZURlcGVuZGVuY2llcyB7XG5cdGV4cHJlc3M6IHR5cGVvZiBleHByZXNzO1xuXHRzZXNzaW9uOiB0eXBlb2Ygc2Vzc2lvbjtcblx0Y29va2llUGFyc2VyOiB0eXBlb2YgY29va2llUGFyc2VyO1xuXHRjb3JzOiB0eXBlb2YgY29ycztcblx0aHBwOiB0eXBlb2YgaHBwO1xuXHRtb3JnYW46IHR5cGVvZiBtb3JnYW47XG5cdHBhc3Nwb3J0OiB0eXBlb2YgcGFzc3BvcnQ7XG5cdHJhbmRvbUJ5dGVzOiB0eXBlb2YgcmFuZG9tQnl0ZXM7XG5cdFJlZGlzU3RvcmU6IHR5cGVvZiBSZWRpc1N0b3JlO1xuXHRpbml0aWFsaXplQ3NyZk1pZGRsZXdhcmU6IHR5cGVvZiBpbml0aWFsaXplQ3NyZk1pZGRsZXdhcmU7XG5cdGdldFJlZGlzQ2xpZW50OiB0eXBlb2YgZ2V0UmVkaXNDbGllbnQ7XG5cdGlwQmxhY2tsaXN0TWlkZGxld2FyZTogdHlwZW9mIGlwQmxhY2tsaXN0TWlkZGxld2FyZTtcblx0aW5pdGlhbGl6ZVJhdGVMaW1pdE1pZGRsZXdhcmU6IHR5cGVvZiBpbml0aWFsaXplUmF0ZUxpbWl0TWlkZGxld2FyZTtcblx0aW5pdGlhbGl6ZVNlY3VyaXR5SGVhZGVyczogdHlwZW9mIGluaXRpYWxpemVTZWN1cml0eUhlYWRlcnM7XG5cdGNyZWF0ZU1lbW9yeU1vbml0b3I6ICgpID0+IHZvaWQ7XG5cdGxvZ2dlcjogTG9nZ2VyO1xuXHRzdGF0aWNSb290UGF0aDogc3RyaW5nO1xuXHRmZWF0dXJlRmxhZ3M6IEZlYXR1cmVGbGFncztcblx0ZXhwcmVzc0Vycm9ySGFuZGxlcjogdHlwZW9mIGV4cHJlc3NFcnJvckhhbmRsZXI7XG5cdHByb2Nlc3NFcnJvcjogdHlwZW9mIHByb2Nlc3NFcnJvcjtcblx0c2VjcmV0czogU2VjcmV0c01hcDtcblx0dmVyaWZ5Snd0OiAodG9rZW46IHN0cmluZykgPT4gUHJvbWlzZTxzdHJpbmcgfCBvYmplY3QgfCBudWxsPjtcblx0aW5pdGlhbGl6ZUp3dEF1dGhNaWRkbGV3YXJlOiB0eXBlb2YgaW5pdGlhbGl6ZUp3dEF1dGhNaWRkbGV3YXJlO1xuXHRpbml0aWFsaXplUGFzc3BvcnRBdXRoTWlkZGxld2FyZTogdHlwZW9mIGluaXRpYWxpemVQYXNzcG9ydEF1dGhNaWRkbGV3YXJlO1xuXHRhdXRoZW50aWNhdGVPcHRpb25zOiBBdXRoZW50aWNhdGVPcHRpb25zO1xuXHRpbml0aWFsaXplVmFsaWRhdG9yTWlkZGxld2FyZTogdHlwZW9mIGluaXRpYWxpemVWYWxpZGF0b3JNaWRkbGV3YXJlO1xuXHRpbml0aWFsaXplU2xvd2Rvd25NaWRkbGV3YXJlOiB0eXBlb2YgaW5pdGlhbGl6ZVNsb3dkb3duTWlkZGxld2FyZTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGluaXRpYWxpemVNaWRkbGV3YXJlKHtcblx0ZXhwcmVzcyxcblx0c2Vzc2lvbixcblx0Y29va2llUGFyc2VyLFxuXHRjb3JzLFxuXHRocHAsXG5cdG1vcmdhbixcblx0cGFzc3BvcnQsXG5cdHJhbmRvbUJ5dGVzLFxuXHRSZWRpc1N0b3JlLFxuXHRpbml0aWFsaXplQ3NyZk1pZGRsZXdhcmUsXG5cdGdldFJlZGlzQ2xpZW50LFxuXHRpcEJsYWNrbGlzdE1pZGRsZXdhcmUsXG5cdGluaXRpYWxpemVSYXRlTGltaXRNaWRkbGV3YXJlLFxuXHRpbml0aWFsaXplU2VjdXJpdHlIZWFkZXJzLFxuXHRjcmVhdGVNZW1vcnlNb25pdG9yLFxuXHRsb2dnZXIsXG5cdHN0YXRpY1Jvb3RQYXRoLFxuXHRmZWF0dXJlRmxhZ3MsXG5cdGV4cHJlc3NFcnJvckhhbmRsZXIsXG5cdHByb2Nlc3NFcnJvcixcblx0dmVyaWZ5Snd0LFxuXHRpbml0aWFsaXplSnd0QXV0aE1pZGRsZXdhcmUsXG5cdGluaXRpYWxpemVQYXNzcG9ydEF1dGhNaWRkbGV3YXJlLFxuXHRhdXRoZW50aWNhdGVPcHRpb25zLFxuXHRpbml0aWFsaXplVmFsaWRhdG9yTWlkZGxld2FyZVxufTogTWlkZGxld2FyZURlcGVuZGVuY2llcyk6IFByb21pc2U8QXBwbGljYXRpb24+IHtcblx0dHJ5IHtcblx0XHRjb25zdCBhcHAgPSBleHByZXNzKCk7XG5cblx0XHR2YWxpZGF0ZURlcGVuZGVuY2llcyhcblx0XHRcdFtcblx0XHRcdFx0eyBuYW1lOiAnZXhwcmVzcycsIGluc3RhbmNlOiBleHByZXNzIH0sXG5cdFx0XHRcdHsgbmFtZTogJ3Nlc3Npb24nLCBpbnN0YW5jZTogc2Vzc2lvbiB9LFxuXHRcdFx0XHR7IG5hbWU6ICdjb29raWVQYXJzZXInLCBpbnN0YW5jZTogY29va2llUGFyc2VyIH0sXG5cdFx0XHRcdHsgbmFtZTogJ2NvcnMnLCBpbnN0YW5jZTogY29ycyB9LFxuXHRcdFx0XHR7IG5hbWU6ICdocHAnLCBpbnN0YW5jZTogaHBwIH0sXG5cdFx0XHRcdHsgbmFtZTogJ21vcmdhbicsIGluc3RhbmNlOiBtb3JnYW4gfSxcblx0XHRcdFx0eyBuYW1lOiAncGFzc3BvcnQnLCBpbnN0YW5jZTogcGFzc3BvcnQgfSxcblx0XHRcdFx0eyBuYW1lOiAncmFuZG9tQnl0ZXMnLCBpbnN0YW5jZTogcmFuZG9tQnl0ZXMgfSxcblx0XHRcdFx0eyBuYW1lOiAnUmVkaXNTdG9yZScsIGluc3RhbmNlOiBSZWRpc1N0b3JlIH0sXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRuYW1lOiAnaW5pdGlhbGl6ZUNzcmZNaWRkbGV3YXJlJyxcblx0XHRcdFx0XHRpbnN0YW5jZTogaW5pdGlhbGl6ZUNzcmZNaWRkbGV3YXJlXG5cdFx0XHRcdH0sXG5cdFx0XHRcdHsgbmFtZTogJ2dldFJlZGlzQ2xpZW50JywgaW5zdGFuY2U6IGdldFJlZGlzQ2xpZW50IH0sXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRuYW1lOiAnaXBCbGFja2xpc3RNaWRkbGV3YXJlJyxcblx0XHRcdFx0XHRpbnN0YW5jZTogaXBCbGFja2xpc3RNaWRkbGV3YXJlXG5cdFx0XHRcdH0sXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRuYW1lOiAnaW5pdGlhbGl6ZVJhdGVMaW1pdE1pZGRsZXdhcmUnLFxuXHRcdFx0XHRcdGluc3RhbmNlOiBpbml0aWFsaXplUmF0ZUxpbWl0TWlkZGxld2FyZVxuXHRcdFx0XHR9LFxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0bmFtZTogJ2luaXRpYWxpemVTZWN1cml0eUhlYWRlcnMnLFxuXHRcdFx0XHRcdGluc3RhbmNlOiBpbml0aWFsaXplU2VjdXJpdHlIZWFkZXJzXG5cdFx0XHRcdH0sXG5cdFx0XHRcdHsgbmFtZTogJ2NyZWF0ZU1lbW9yeU1vbml0b3InLCBpbnN0YW5jZTogY3JlYXRlTWVtb3J5TW9uaXRvciB9LFxuXHRcdFx0XHR7IG5hbWU6ICdsb2dnZXInLCBpbnN0YW5jZTogbG9nZ2VyIH0sXG5cdFx0XHRcdHsgbmFtZTogJ3N0YXRpY1Jvb3RQYXRoJywgaW5zdGFuY2U6IHN0YXRpY1Jvb3RQYXRoIH0sXG5cdFx0XHRcdHsgbmFtZTogJ2ZlYXR1cmVGbGFncycsIGluc3RhbmNlOiBmZWF0dXJlRmxhZ3MgfSxcblx0XHRcdFx0eyBuYW1lOiAnZXhwcmVzc0Vycm9ySGFuZGxlcicsIGluc3RhbmNlOiBleHByZXNzRXJyb3JIYW5kbGVyIH0sXG5cdFx0XHRcdHsgbmFtZTogJ3Byb2Nlc3NFcnJvcicsIGluc3RhbmNlOiBwcm9jZXNzRXJyb3IgfVxuXHRcdFx0XSxcblx0XHRcdGxvZ2dlciB8fCBjb25zb2xlXG5cdFx0KTtcblxuXHRcdGNvbnN0IHNlY3JldHMgPSBhd2FpdCBzb3BzLmdldFNlY3JldHMoe1xuXHRcdFx0bG9nZ2VyLFxuXHRcdFx0ZXhlY1N5bmMsXG5cdFx0XHRnZXREaXJlY3RvcnlQYXRoOiAoKSA9PiBwcm9jZXNzLmN3ZCgpXG5cdFx0fSk7XG5cblx0XHRjb25zdCByZWRpc0NsaWVudCA9IGF3YWl0IGdldFJlZGlzQ2xpZW50KCk7XG5cblx0XHQvLyBpbml0aWFsaXplIGJvZHkgcGFyc2VyXG5cdFx0YXBwLnVzZShleHByZXNzLmpzb24oKSk7XG5cdFx0YXBwLnVzZShleHByZXNzLnVybGVuY29kZWQoeyBleHRlbmRlZDogdHJ1ZSB9KSk7XG5cblx0XHQvLyBpbml0aWFsaXplIGNvb2tpZSBwYXJzZXJcblx0XHRhcHAudXNlKGNvb2tpZVBhcnNlcigpKTtcblxuXHRcdC8vIGluaXRpYWxpemUgbW9yZ2FuIGxvZ2dlclxuXHRcdGNvbnN0IHN0cmVhbTogU3RyZWFtT3B0aW9ucyA9IHtcblx0XHRcdHdyaXRlOiAobWVzc2FnZTogc3RyaW5nKSA9PiBsb2dnZXIuaW5mbyhtZXNzYWdlLnRyaW0oKSlcblx0XHR9O1xuXHRcdGFwcC51c2UobW9yZ2FuKCdjb21iaW5lZCcsIHsgc3RyZWFtIH0pKTtcblxuXHRcdC8vIGluaXRpYWxpemUgQ09SU1xuXHRcdGFwcC51c2UoY29ycygpKTtcblxuXHRcdC8vIGluaXRpYWxpemUgSFBQXG5cdFx0YXBwLnVzZShocHAoKSk7XG5cblx0XHQvLyBpbml0aWFsaXplIHNlc3Npb24gd2l0aCBSZWRpcyBzdG9yZVxuXHRcdGFwcC51c2UoXG5cdFx0XHRzZXNzaW9uKHtcblx0XHRcdFx0c2VjcmV0OiBzZWNyZXRzLlNFU1NJT05fU0VDUkVULFxuXHRcdFx0XHRyZXNhdmU6IGZhbHNlLFxuXHRcdFx0XHRzYXZlVW5pbml0aWFsaXplZDogdHJ1ZSxcblx0XHRcdFx0c3RvcmU6XG5cdFx0XHRcdFx0ZmVhdHVyZUZsYWdzLmVuYWJsZVJlZGlzRmxhZyAmJiByZWRpc0NsaWVudFxuXHRcdFx0XHRcdFx0PyBuZXcgUmVkaXNTdG9yZSh7IGNsaWVudDogcmVkaXNDbGllbnQgfSlcblx0XHRcdFx0XHRcdDogdW5kZWZpbmVkLFxuXHRcdFx0XHRjb29raWU6IHtcblx0XHRcdFx0XHRzZWN1cmU6IGZlYXR1cmVGbGFncy5lbmFibGVTc2xGbGFnLFxuXHRcdFx0XHRcdGh0dHBPbmx5OiB0cnVlLFxuXHRcdFx0XHRcdHNhbWVTaXRlOiAnc3RyaWN0J1xuXHRcdFx0XHR9XG5cdFx0XHR9KVxuXHRcdCk7XG5cblx0XHQvLyBpbml0aWFsaXplIHBhc3Nwb3J0XG5cdFx0YXBwLnVzZShwYXNzcG9ydC5pbml0aWFsaXplKCkpO1xuXHRcdGFwcC51c2UocGFzc3BvcnQuc2Vzc2lvbigpKTtcblxuXHRcdC8vIGluaXRpYWxpemUgY29tcHJlc3Npb25cblx0XHRhcHAudXNlKGNvbXByZXNzaW9uKCkpO1xuXG5cdFx0Ly8gaW5pdGlhbGl6ZSByZXNwb25zZSB0aW1lXG5cdFx0YXBwLnVzZShyZXNwb25zZVRpbWUoKSk7XG5cblx0XHQvLyBzZXQgZS10YWcgaGVhZGVyIGZvciBjbGllbnQtc2lkZSBjYWNoaW5nXG5cdFx0YXBwLnNldCgnZXRhZycsICdzdHJvbmcnKTtcblxuXHRcdC8vIGluaXRpYWxpemUgc2VjdXJpdHkgaGVhZGVyc1xuXHRcdGluaXRpYWxpemVTZWN1cml0eUhlYWRlcnMoYXBwLCB7XG5cdFx0XHRoZWxtZXRPcHRpb25zOiB7fSxcblx0XHRcdHBlcm1pc3Npb25zUG9saWN5T3B0aW9uczoge31cblx0XHR9KTtcblxuXHRcdC8vIGluaXRpYWxpemUgQ1NSRiBtaWRkbGV3YXJlXG5cdFx0YXBwLnVzZShpbml0aWFsaXplQ3NyZk1pZGRsZXdhcmUpO1xuXG5cdFx0Ly8gaW5pdGlhbGl6ZSB2YWxpZGF0b3IgbWlkZGxld2FyZVxuXHRcdGluaXRpYWxpemVWYWxpZGF0b3JNaWRkbGV3YXJlKHsgdmFsaWRhdG9yLCBsb2dnZXIgfSk7XG5cblx0XHQvLyBpbml0aWFsaXplIG1lbW9yeSBtb25pdG9yIG9yIFJlZGlzIHNlc3Npb24gYmFzZWQgb24gZmxhZ1xuXHRcdGlmICghZmVhdHVyZUZsYWdzLmVuYWJsZVJlZGlzRmxhZykge1xuXHRcdFx0Y3JlYXRlTWVtb3J5TW9uaXRvcigpO1xuXHRcdH1cblxuXHRcdC8vIGluaXRpYWxpemUgcmF0ZSBsaW1pdGVyXG5cdFx0aWYgKGZlYXR1cmVGbGFncy5lbmFibGVSYXRlTGltaXRGbGFnKSB7XG5cdFx0XHRhcHAudXNlKGluaXRpYWxpemVSYXRlTGltaXRNaWRkbGV3YXJlKTtcblx0XHR9XG5cblx0XHQvLyBpbml0aWFsaXplIHNsb3dkb3duIG1pZGRsZXdhcmVcblx0XHRpbml0aWFsaXplU2xvd2Rvd25NaWRkbGV3YXJlKHsgc2xvd2Rvd25UaHJlc2hvbGQ6IDEwMCwgbG9nZ2VyIH0pO1xuXG5cdFx0Ly8gaW5pdGlhbGl6ZSBJUCBibGFja2xpc3QgbWlkZGxld2FyZVxuXHRcdGlmIChmZWF0dXJlRmxhZ3MuZW5hYmxlSXBCbGFja2xpc3RGbGFnKSB7XG5cdFx0XHRhcHAudXNlKGlwQmxhY2tsaXN0TWlkZGxld2FyZSk7XG5cdFx0fVxuXG5cdFx0Ly8gaW5pdGlhbGl6ZSBKV1QgYXV0aGVudGljYXRpb24gbWlkZGxld2FyZVxuXHRcdGFwcC51c2UoaW5pdGlhbGl6ZUp3dEF1dGhNaWRkbGV3YXJlKHsgbG9nZ2VyLCB2ZXJpZnlKd3QgfSkpO1xuXG5cdFx0Ly8gaW5pdGlhbGl6ZSBwYXNzcG9ydCBhdXRoZW50aWNhdGlvbiBtaWRkbGV3YXJlXG5cdFx0YXBwLnVzZShcblx0XHRcdGluaXRpYWxpemVQYXNzcG9ydEF1dGhNaWRkbGV3YXJlKHtcblx0XHRcdFx0cGFzc3BvcnQsXG5cdFx0XHRcdGF1dGhlbnRpY2F0ZU9wdGlvbnMsXG5cdFx0XHRcdGxvZ2dlclxuXHRcdFx0fSlcblx0XHQpO1xuXG5cdFx0Ly8gaW5pdGlhbGl6ZSBlcnJvciBoYW5kbGVyXG5cdFx0YXBwLnVzZShleHByZXNzRXJyb3JIYW5kbGVyKHsgbG9nZ2VyLCBmZWF0dXJlRmxhZ3MgfSkpO1xuXG5cdFx0cmV0dXJuIGFwcDtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRwcm9jZXNzRXJyb3IoZXJyb3IgYXMgRXJyb3IsIGxvZ2dlciB8fCBjb25zb2xlKTtcblx0XHR0aHJvdyBuZXcgRXJyb3IoXG5cdFx0XHRgRmFpbGVkIHRvIGluaXRpYWxpemUgYXBwLiBTZWUgbG9ncyBmb3IgbW9yZSBkZXRhaWxzOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogZXJyb3J9YFxuXHRcdCk7XG5cdH1cbn1cbiJdfQ==
