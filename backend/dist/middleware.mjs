import { execSync } from 'child_process';
import compression from 'compression';
import responseTime from 'response-time';
import validator from 'validator';
import sops from './utils/sops.mjs';
import { initializeSlowdownMiddleware } from './middleware/slowdown.mjs';
import { validateDependencies } from './utils/validateDependencies.mjs';
export async function initializeMiddleware({
	express,
	session,
	cookieParser,
	cors,
	hpp,
	morgan,
	passport,
	randomBytes,
	RedisStore,
	initializeCsrfMiddleware,
	getRedisClient,
	ipBlacklistMiddleware,
	initializeRateLimitMiddleware,
	initializeSecurityHeaders,
	createMemoryMonitor,
	logger,
	staticRootPath,
	featureFlags,
	expressErrorHandler,
	processError,
	verifyJwt,
	initializeJwtAuthMiddleware,
	initializePassportAuthMiddleware,
	authenticateOptions,
	initializeValidatorMiddleware
}) {
	try {
		const app = express();
		validateDependencies(
			[
				{ name: 'express', instance: express },
				{ name: 'session', instance: session },
				{ name: 'cookieParser', instance: cookieParser },
				{ name: 'cors', instance: cors },
				{ name: 'hpp', instance: hpp },
				{ name: 'morgan', instance: morgan },
				{ name: 'passport', instance: passport },
				{ name: 'randomBytes', instance: randomBytes },
				{ name: 'RedisStore', instance: RedisStore },
				{
					name: 'initializeCsrfMiddleware',
					instance: initializeCsrfMiddleware
				},
				{ name: 'getRedisClient', instance: getRedisClient },
				{
					name: 'ipBlacklistMiddleware',
					instance: ipBlacklistMiddleware
				},
				{
					name: 'initializeRateLimitMiddleware',
					instance: initializeRateLimitMiddleware
				},
				{
					name: 'initializeSecurityHeaders',
					instance: initializeSecurityHeaders
				},
				{ name: 'createMemoryMonitor', instance: createMemoryMonitor },
				{ name: 'logger', instance: logger },
				{ name: 'staticRootPath', instance: staticRootPath },
				{ name: 'featureFlags', instance: featureFlags },
				{ name: 'expressErrorHandler', instance: expressErrorHandler },
				{ name: 'processError', instance: processError }
			],
			logger || console
		);
		const secrets = await sops.getSecrets({
			logger,
			execSync,
			getDirectoryPath: () => process.cwd()
		});
		const redisClient = await getRedisClient();
		// initialize body parser
		app.use(express.json());
		app.use(express.urlencoded({ extended: true }));
		// initialize cookie parser
		app.use(cookieParser());
		// initialize morgan logger
		const stream = {
			write: message => logger.info(message.trim())
		};
		app.use(morgan('combined', { stream }));
		// initialize CORS
		app.use(cors());
		// initialize HPP
		app.use(hpp());
		// initialize session with Redis store
		app.use(
			session({
				secret: secrets.SESSION_SECRET,
				resave: false,
				saveUninitialized: true,
				store:
					featureFlags.enableRedisFlag && redisClient
						? new RedisStore({ client: redisClient })
						: undefined,
				cookie: {
					secure: featureFlags.enableSslFlag,
					httpOnly: true,
					sameSite: 'strict'
				}
			})
		);
		// initialize passport
		app.use(passport.initialize());
		app.use(passport.session());
		// initialize compression
		app.use(compression());
		// initialize response time
		app.use(responseTime());
		// set e-tag header for client-side caching
		app.set('etag', 'strong');
		// initialize security headers
		initializeSecurityHeaders(app, {
			helmetOptions: {},
			permissionsPolicyOptions: {}
		});
		// initialize CSRF middleware
		app.use(initializeCsrfMiddleware);
		// initialize validator middleware
		initializeValidatorMiddleware({ validator, logger });
		// initialize memory monitor or Redis session based on flag
		if (!featureFlags.enableRedisFlag) {
			createMemoryMonitor();
		}
		// initialize rate limiter
		if (featureFlags.enableRateLimitFlag) {
			app.use(initializeRateLimitMiddleware);
		}
		// initialize slowdown middleware
		initializeSlowdownMiddleware({ slowdownThreshold: 100, logger });
		// initialize IP blacklist middleware
		if (featureFlags.enableIpBlacklistFlag) {
			app.use(ipBlacklistMiddleware);
		}
		// initialize JWT authentication middleware
		app.use(initializeJwtAuthMiddleware({ logger, verifyJwt }));
		// initialize passport authentication middleware
		app.use(
			initializePassportAuthMiddleware({
				passport,
				authenticateOptions,
				logger
			})
		);
		// initialize error handler
		app.use(expressErrorHandler({ logger, featureFlags }));
		return app;
	} catch (error) {
		processError(error, logger || console);
		throw new Error(
			`Failed to initialize app. See logs for more details: ${error instanceof Error ? error.message : error}`
		);
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWlkZGxld2FyZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9taWRkbGV3YXJlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxXQUFXLE1BQU0sYUFBYSxDQUFDO0FBUXRDLE9BQU8sWUFBWSxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLFNBQVMsTUFBTSxXQUFXLENBQUM7QUFJbEMsT0FBTyxJQUFvQixNQUFNLGNBQWMsQ0FBQztBQVFoRCxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUdyRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQWdDcEUsTUFBTSxDQUFDLEtBQUssVUFBVSxvQkFBb0IsQ0FBQyxFQUMxQyxPQUFPLEVBQ1AsT0FBTyxFQUNQLFlBQVksRUFDWixJQUFJLEVBQ0osR0FBRyxFQUNILE1BQU0sRUFDTixRQUFRLEVBQ1IsV0FBVyxFQUNYLFVBQVUsRUFDVix3QkFBd0IsRUFDeEIsY0FBYyxFQUNkLHFCQUFxQixFQUNyQiw2QkFBNkIsRUFDN0IseUJBQXlCLEVBQ3pCLG1CQUFtQixFQUNuQixNQUFNLEVBQ04sY0FBYyxFQUNkLFlBQVksRUFDWixtQkFBbUIsRUFDbkIsWUFBWSxFQUNaLFNBQVMsRUFDVCwyQkFBMkIsRUFDM0IsZ0NBQWdDLEVBQ2hDLG1CQUFtQixFQUNuQiw2QkFBNkIsRUFDTDtJQUN4QixJQUFJLENBQUM7UUFDSixNQUFNLEdBQUcsR0FBRyxPQUFPLEVBQUUsQ0FBQztRQUV0QixvQkFBb0IsQ0FDbkI7WUFDQyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRTtZQUN0QyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRTtZQUN0QyxFQUFFLElBQUksRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBRTtZQUNoRCxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRTtZQUNoQyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRTtZQUM5QixFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRTtZQUNwQyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRTtZQUN4QyxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRTtZQUM5QyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRTtZQUM1QztnQkFDQyxJQUFJLEVBQUUsMEJBQTBCO2dCQUNoQyxRQUFRLEVBQUUsd0JBQXdCO2FBQ2xDO1lBQ0QsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsUUFBUSxFQUFFLGNBQWMsRUFBRTtZQUNwRDtnQkFDQyxJQUFJLEVBQUUsdUJBQXVCO2dCQUM3QixRQUFRLEVBQUUscUJBQXFCO2FBQy9CO1lBQ0Q7Z0JBQ0MsSUFBSSxFQUFFLCtCQUErQjtnQkFDckMsUUFBUSxFQUFFLDZCQUE2QjthQUN2QztZQUNEO2dCQUNDLElBQUksRUFBRSwyQkFBMkI7Z0JBQ2pDLFFBQVEsRUFBRSx5QkFBeUI7YUFDbkM7WUFDRCxFQUFFLElBQUksRUFBRSxxQkFBcUIsRUFBRSxRQUFRLEVBQUUsbUJBQW1CLEVBQUU7WUFDOUQsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUU7WUFDcEMsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsUUFBUSxFQUFFLGNBQWMsRUFBRTtZQUNwRCxFQUFFLElBQUksRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBRTtZQUNoRCxFQUFFLElBQUksRUFBRSxxQkFBcUIsRUFBRSxRQUFRLEVBQUUsbUJBQW1CLEVBQUU7WUFDOUQsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUU7U0FDaEQsRUFDRCxNQUFNLElBQUksT0FBTyxDQUNqQixDQUFDO1FBRUYsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDO1lBQ3JDLE1BQU07WUFDTixRQUFRO1lBQ1IsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRTtTQUNyQyxDQUFDLENBQUM7UUFFSCxNQUFNLFdBQVcsR0FBRyxNQUFNLGNBQWMsRUFBRSxDQUFDO1FBRTNDLHlCQUF5QjtRQUN6QixHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ3hCLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFaEQsMkJBQTJCO1FBQzNCLEdBQUcsQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQztRQUV4QiwyQkFBMkI7UUFDM0IsTUFBTSxNQUFNLEdBQWtCO1lBQzdCLEtBQUssRUFBRSxDQUFDLE9BQWUsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDdkQsQ0FBQztRQUNGLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUV4QyxrQkFBa0I7UUFDbEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRWhCLGlCQUFpQjtRQUNqQixHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFFZixzQ0FBc0M7UUFDdEMsR0FBRyxDQUFDLEdBQUcsQ0FDTixPQUFPLENBQUM7WUFDUCxNQUFNLEVBQUUsT0FBTyxDQUFDLGNBQWM7WUFDOUIsTUFBTSxFQUFFLEtBQUs7WUFDYixpQkFBaUIsRUFBRSxJQUFJO1lBQ3ZCLEtBQUssRUFDSixZQUFZLENBQUMsZUFBZSxJQUFJLFdBQVc7Z0JBQzFDLENBQUMsQ0FBQyxJQUFJLFVBQVUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsQ0FBQztnQkFDekMsQ0FBQyxDQUFDLFNBQVM7WUFDYixNQUFNLEVBQUU7Z0JBQ1AsTUFBTSxFQUFFLFlBQVksQ0FBQyxhQUFhO2dCQUNsQyxRQUFRLEVBQUUsSUFBSTtnQkFDZCxRQUFRLEVBQUUsUUFBUTthQUNsQjtTQUNELENBQUMsQ0FDRixDQUFDO1FBRUYsc0JBQXNCO1FBQ3RCLEdBQUcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7UUFDL0IsR0FBRyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUU1Qix5QkFBeUI7UUFDekIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBRXZCLDJCQUEyQjtRQUMzQixHQUFHLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUM7UUFFeEIsMkNBQTJDO1FBQzNDLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRTFCLDhCQUE4QjtRQUM5Qix5QkFBeUIsQ0FBQyxHQUFHLEVBQUU7WUFDOUIsYUFBYSxFQUFFLEVBQUU7WUFDakIsd0JBQXdCLEVBQUUsRUFBRTtTQUM1QixDQUFDLENBQUM7UUFFSCw2QkFBNkI7UUFDN0IsR0FBRyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBRWxDLGtDQUFrQztRQUNsQyw2QkFBNkIsQ0FBQyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBRXJELDJEQUEyRDtRQUMzRCxJQUFJLENBQUMsWUFBWSxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQ25DLG1CQUFtQixFQUFFLENBQUM7UUFDdkIsQ0FBQztRQUVELDBCQUEwQjtRQUMxQixJQUFJLFlBQVksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1lBQ3RDLEdBQUcsQ0FBQyxHQUFHLENBQUMsNkJBQTZCLENBQUMsQ0FBQztRQUN4QyxDQUFDO1FBRUQsaUNBQWlDO1FBQ2pDLDRCQUE0QixDQUFDLEVBQUUsaUJBQWlCLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFFakUscUNBQXFDO1FBQ3JDLElBQUksWUFBWSxDQUFDLHFCQUFxQixFQUFFLENBQUM7WUFDeEMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQ2hDLENBQUM7UUFFRCwyQ0FBMkM7UUFDM0MsR0FBRyxDQUFDLEdBQUcsQ0FBQywyQkFBMkIsQ0FBQyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFNUQsZ0RBQWdEO1FBQ2hELEdBQUcsQ0FBQyxHQUFHLENBQ04sZ0NBQWdDLENBQUM7WUFDaEMsUUFBUTtZQUNSLG1CQUFtQjtZQUNuQixNQUFNO1NBQ04sQ0FBQyxDQUNGLENBQUM7UUFFRiwyQkFBMkI7UUFDM0IsR0FBRyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFdkQsT0FBTyxHQUFHLENBQUM7SUFDWixDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNoQixZQUFZLENBQUMsS0FBYyxFQUFFLE1BQU0sSUFBSSxPQUFPLENBQUMsQ0FBQztRQUNoRCxNQUFNLElBQUksS0FBSyxDQUNkLHdEQUF3RCxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FDeEcsQ0FBQztJQUNILENBQUM7QUFDRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlZGlzU3RvcmUgZnJvbSAnY29ubmVjdC1yZWRpcyc7XG5pbXBvcnQgY29va2llUGFyc2VyIGZyb20gJ2Nvb2tpZS1wYXJzZXInO1xuaW1wb3J0IHsgZXhlY1N5bmMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCBjb21wcmVzc2lvbiBmcm9tICdjb21wcmVzc2lvbic7XG5pbXBvcnQgY29ycyBmcm9tICdjb3JzJztcbmltcG9ydCB7IHJhbmRvbUJ5dGVzIH0gZnJvbSAnY3J5cHRvJztcbmltcG9ydCBleHByZXNzLCB7IEFwcGxpY2F0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgc2Vzc2lvbiBmcm9tICdleHByZXNzLXNlc3Npb24nO1xuaW1wb3J0IGhwcCBmcm9tICdocHAnO1xuaW1wb3J0IG1vcmdhbiwgeyBTdHJlYW1PcHRpb25zIH0gZnJvbSAnbW9yZ2FuJztcbmltcG9ydCBwYXNzcG9ydCwgeyBBdXRoZW50aWNhdGVPcHRpb25zIH0gZnJvbSAncGFzc3BvcnQnO1xuaW1wb3J0IHJlc3BvbnNlVGltZSBmcm9tICdyZXNwb25zZS10aW1lJztcbmltcG9ydCB2YWxpZGF0b3IgZnJvbSAndmFsaWRhdG9yJztcbmltcG9ydCB7IEZlYXR1cmVGbGFncyB9IGZyb20gJy4vY29uZmlnL2Vudmlyb25tZW50Q29uZmlnJztcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJy4vY29uZmlnL2xvZ2dlcic7XG5pbXBvcnQgeyBnZXRSZWRpc0NsaWVudCB9IGZyb20gJy4vY29uZmlnL3JlZGlzJztcbmltcG9ydCBzb3BzLCB7IFNlY3JldHNNYXAgfSBmcm9tICcuL3V0aWxzL3NvcHMnO1xuaW1wb3J0IHsgaW5pdGlhbGl6ZUNzcmZNaWRkbGV3YXJlIH0gZnJvbSAnLi9taWRkbGV3YXJlL2NzcmYnO1xuaW1wb3J0IHsgZXhwcmVzc0Vycm9ySGFuZGxlciB9IGZyb20gJy4vbWlkZGxld2FyZS9leHByZXNzRXJyb3JIYW5kbGVyJztcbmltcG9ydCB7IGlwQmxhY2tsaXN0TWlkZGxld2FyZSB9IGZyb20gJy4vbWlkZGxld2FyZS9pcEJsYWNrbGlzdCc7XG5pbXBvcnQgeyBpbml0aWFsaXplSnd0QXV0aE1pZGRsZXdhcmUgfSBmcm9tICcuL21pZGRsZXdhcmUvand0QXV0aCc7XG5pbXBvcnQgeyBpbml0aWFsaXplUGFzc3BvcnRBdXRoTWlkZGxld2FyZSB9IGZyb20gJy4vbWlkZGxld2FyZS9wYXNzcG9ydEF1dGgnO1xuaW1wb3J0IHsgaW5pdGlhbGl6ZVJhdGVMaW1pdE1pZGRsZXdhcmUgfSBmcm9tICcuL21pZGRsZXdhcmUvcmF0ZUxpbWl0JztcbmltcG9ydCB7IGluaXRpYWxpemVTZWN1cml0eUhlYWRlcnMgfSBmcm9tICcuL21pZGRsZXdhcmUvc2VjdXJpdHlIZWFkZXJzJztcbmltcG9ydCB7IGluaXRpYWxpemVTbG93ZG93bk1pZGRsZXdhcmUgfSBmcm9tICcuL21pZGRsZXdhcmUvc2xvd2Rvd24nO1xuaW1wb3J0IHsgaW5pdGlhbGl6ZVZhbGlkYXRvck1pZGRsZXdhcmUgfSBmcm9tICcuL21pZGRsZXdhcmUvdmFsaWRhdG9yJztcbmltcG9ydCB7IHByb2Nlc3NFcnJvciB9IGZyb20gJy4vdXRpbHMvcHJvY2Vzc0Vycm9yJztcbmltcG9ydCB7IHZhbGlkYXRlRGVwZW5kZW5jaWVzIH0gZnJvbSAnLi91dGlscy92YWxpZGF0ZURlcGVuZGVuY2llcyc7XG5cbmludGVyZmFjZSBNaWRkbGV3YXJlRGVwZW5kZW5jaWVzIHtcblx0ZXhwcmVzczogdHlwZW9mIGV4cHJlc3M7XG5cdHNlc3Npb246IHR5cGVvZiBzZXNzaW9uO1xuXHRjb29raWVQYXJzZXI6IHR5cGVvZiBjb29raWVQYXJzZXI7XG5cdGNvcnM6IHR5cGVvZiBjb3JzO1xuXHRocHA6IHR5cGVvZiBocHA7XG5cdG1vcmdhbjogdHlwZW9mIG1vcmdhbjtcblx0cGFzc3BvcnQ6IHR5cGVvZiBwYXNzcG9ydDtcblx0cmFuZG9tQnl0ZXM6IHR5cGVvZiByYW5kb21CeXRlcztcblx0UmVkaXNTdG9yZTogdHlwZW9mIFJlZGlzU3RvcmU7XG5cdGluaXRpYWxpemVDc3JmTWlkZGxld2FyZTogdHlwZW9mIGluaXRpYWxpemVDc3JmTWlkZGxld2FyZTtcblx0Z2V0UmVkaXNDbGllbnQ6IHR5cGVvZiBnZXRSZWRpc0NsaWVudDtcblx0aXBCbGFja2xpc3RNaWRkbGV3YXJlOiB0eXBlb2YgaXBCbGFja2xpc3RNaWRkbGV3YXJlO1xuXHRpbml0aWFsaXplUmF0ZUxpbWl0TWlkZGxld2FyZTogdHlwZW9mIGluaXRpYWxpemVSYXRlTGltaXRNaWRkbGV3YXJlO1xuXHRpbml0aWFsaXplU2VjdXJpdHlIZWFkZXJzOiB0eXBlb2YgaW5pdGlhbGl6ZVNlY3VyaXR5SGVhZGVycztcblx0Y3JlYXRlTWVtb3J5TW9uaXRvcjogKCkgPT4gdm9pZDtcblx0bG9nZ2VyOiBMb2dnZXI7XG5cdHN0YXRpY1Jvb3RQYXRoOiBzdHJpbmc7XG5cdGZlYXR1cmVGbGFnczogRmVhdHVyZUZsYWdzO1xuXHRleHByZXNzRXJyb3JIYW5kbGVyOiB0eXBlb2YgZXhwcmVzc0Vycm9ySGFuZGxlcjtcblx0cHJvY2Vzc0Vycm9yOiB0eXBlb2YgcHJvY2Vzc0Vycm9yO1xuXHRzZWNyZXRzOiBTZWNyZXRzTWFwO1xuXHR2ZXJpZnlKd3Q6ICh0b2tlbjogc3RyaW5nKSA9PiBQcm9taXNlPHN0cmluZyB8IG9iamVjdCB8IG51bGw+O1xuXHRpbml0aWFsaXplSnd0QXV0aE1pZGRsZXdhcmU6IHR5cGVvZiBpbml0aWFsaXplSnd0QXV0aE1pZGRsZXdhcmU7XG5cdGluaXRpYWxpemVQYXNzcG9ydEF1dGhNaWRkbGV3YXJlOiB0eXBlb2YgaW5pdGlhbGl6ZVBhc3Nwb3J0QXV0aE1pZGRsZXdhcmU7XG5cdGF1dGhlbnRpY2F0ZU9wdGlvbnM6IEF1dGhlbnRpY2F0ZU9wdGlvbnM7XG5cdGluaXRpYWxpemVWYWxpZGF0b3JNaWRkbGV3YXJlOiB0eXBlb2YgaW5pdGlhbGl6ZVZhbGlkYXRvck1pZGRsZXdhcmU7XG5cdGluaXRpYWxpemVTbG93ZG93bk1pZGRsZXdhcmU6IHR5cGVvZiBpbml0aWFsaXplU2xvd2Rvd25NaWRkbGV3YXJlO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaW5pdGlhbGl6ZU1pZGRsZXdhcmUoe1xuXHRleHByZXNzLFxuXHRzZXNzaW9uLFxuXHRjb29raWVQYXJzZXIsXG5cdGNvcnMsXG5cdGhwcCxcblx0bW9yZ2FuLFxuXHRwYXNzcG9ydCxcblx0cmFuZG9tQnl0ZXMsXG5cdFJlZGlzU3RvcmUsXG5cdGluaXRpYWxpemVDc3JmTWlkZGxld2FyZSxcblx0Z2V0UmVkaXNDbGllbnQsXG5cdGlwQmxhY2tsaXN0TWlkZGxld2FyZSxcblx0aW5pdGlhbGl6ZVJhdGVMaW1pdE1pZGRsZXdhcmUsXG5cdGluaXRpYWxpemVTZWN1cml0eUhlYWRlcnMsXG5cdGNyZWF0ZU1lbW9yeU1vbml0b3IsXG5cdGxvZ2dlcixcblx0c3RhdGljUm9vdFBhdGgsXG5cdGZlYXR1cmVGbGFncyxcblx0ZXhwcmVzc0Vycm9ySGFuZGxlcixcblx0cHJvY2Vzc0Vycm9yLFxuXHR2ZXJpZnlKd3QsXG5cdGluaXRpYWxpemVKd3RBdXRoTWlkZGxld2FyZSxcblx0aW5pdGlhbGl6ZVBhc3Nwb3J0QXV0aE1pZGRsZXdhcmUsXG5cdGF1dGhlbnRpY2F0ZU9wdGlvbnMsXG5cdGluaXRpYWxpemVWYWxpZGF0b3JNaWRkbGV3YXJlXG59OiBNaWRkbGV3YXJlRGVwZW5kZW5jaWVzKTogUHJvbWlzZTxBcHBsaWNhdGlvbj4ge1xuXHR0cnkge1xuXHRcdGNvbnN0IGFwcCA9IGV4cHJlc3MoKTtcblxuXHRcdHZhbGlkYXRlRGVwZW5kZW5jaWVzKFxuXHRcdFx0W1xuXHRcdFx0XHR7IG5hbWU6ICdleHByZXNzJywgaW5zdGFuY2U6IGV4cHJlc3MgfSxcblx0XHRcdFx0eyBuYW1lOiAnc2Vzc2lvbicsIGluc3RhbmNlOiBzZXNzaW9uIH0sXG5cdFx0XHRcdHsgbmFtZTogJ2Nvb2tpZVBhcnNlcicsIGluc3RhbmNlOiBjb29raWVQYXJzZXIgfSxcblx0XHRcdFx0eyBuYW1lOiAnY29ycycsIGluc3RhbmNlOiBjb3JzIH0sXG5cdFx0XHRcdHsgbmFtZTogJ2hwcCcsIGluc3RhbmNlOiBocHAgfSxcblx0XHRcdFx0eyBuYW1lOiAnbW9yZ2FuJywgaW5zdGFuY2U6IG1vcmdhbiB9LFxuXHRcdFx0XHR7IG5hbWU6ICdwYXNzcG9ydCcsIGluc3RhbmNlOiBwYXNzcG9ydCB9LFxuXHRcdFx0XHR7IG5hbWU6ICdyYW5kb21CeXRlcycsIGluc3RhbmNlOiByYW5kb21CeXRlcyB9LFxuXHRcdFx0XHR7IG5hbWU6ICdSZWRpc1N0b3JlJywgaW5zdGFuY2U6IFJlZGlzU3RvcmUgfSxcblx0XHRcdFx0e1xuXHRcdFx0XHRcdG5hbWU6ICdpbml0aWFsaXplQ3NyZk1pZGRsZXdhcmUnLFxuXHRcdFx0XHRcdGluc3RhbmNlOiBpbml0aWFsaXplQ3NyZk1pZGRsZXdhcmVcblx0XHRcdFx0fSxcblx0XHRcdFx0eyBuYW1lOiAnZ2V0UmVkaXNDbGllbnQnLCBpbnN0YW5jZTogZ2V0UmVkaXNDbGllbnQgfSxcblx0XHRcdFx0e1xuXHRcdFx0XHRcdG5hbWU6ICdpcEJsYWNrbGlzdE1pZGRsZXdhcmUnLFxuXHRcdFx0XHRcdGluc3RhbmNlOiBpcEJsYWNrbGlzdE1pZGRsZXdhcmVcblx0XHRcdFx0fSxcblx0XHRcdFx0e1xuXHRcdFx0XHRcdG5hbWU6ICdpbml0aWFsaXplUmF0ZUxpbWl0TWlkZGxld2FyZScsXG5cdFx0XHRcdFx0aW5zdGFuY2U6IGluaXRpYWxpemVSYXRlTGltaXRNaWRkbGV3YXJlXG5cdFx0XHRcdH0sXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRuYW1lOiAnaW5pdGlhbGl6ZVNlY3VyaXR5SGVhZGVycycsXG5cdFx0XHRcdFx0aW5zdGFuY2U6IGluaXRpYWxpemVTZWN1cml0eUhlYWRlcnNcblx0XHRcdFx0fSxcblx0XHRcdFx0eyBuYW1lOiAnY3JlYXRlTWVtb3J5TW9uaXRvcicsIGluc3RhbmNlOiBjcmVhdGVNZW1vcnlNb25pdG9yIH0sXG5cdFx0XHRcdHsgbmFtZTogJ2xvZ2dlcicsIGluc3RhbmNlOiBsb2dnZXIgfSxcblx0XHRcdFx0eyBuYW1lOiAnc3RhdGljUm9vdFBhdGgnLCBpbnN0YW5jZTogc3RhdGljUm9vdFBhdGggfSxcblx0XHRcdFx0eyBuYW1lOiAnZmVhdHVyZUZsYWdzJywgaW5zdGFuY2U6IGZlYXR1cmVGbGFncyB9LFxuXHRcdFx0XHR7IG5hbWU6ICdleHByZXNzRXJyb3JIYW5kbGVyJywgaW5zdGFuY2U6IGV4cHJlc3NFcnJvckhhbmRsZXIgfSxcblx0XHRcdFx0eyBuYW1lOiAncHJvY2Vzc0Vycm9yJywgaW5zdGFuY2U6IHByb2Nlc3NFcnJvciB9XG5cdFx0XHRdLFxuXHRcdFx0bG9nZ2VyIHx8IGNvbnNvbGVcblx0XHQpO1xuXG5cdFx0Y29uc3Qgc2VjcmV0cyA9IGF3YWl0IHNvcHMuZ2V0U2VjcmV0cyh7XG5cdFx0XHRsb2dnZXIsXG5cdFx0XHRleGVjU3luYyxcblx0XHRcdGdldERpcmVjdG9yeVBhdGg6ICgpID0+IHByb2Nlc3MuY3dkKClcblx0XHR9KTtcblxuXHRcdGNvbnN0IHJlZGlzQ2xpZW50ID0gYXdhaXQgZ2V0UmVkaXNDbGllbnQoKTtcblxuXHRcdC8vIGluaXRpYWxpemUgYm9keSBwYXJzZXJcblx0XHRhcHAudXNlKGV4cHJlc3MuanNvbigpKTtcblx0XHRhcHAudXNlKGV4cHJlc3MudXJsZW5jb2RlZCh7IGV4dGVuZGVkOiB0cnVlIH0pKTtcblxuXHRcdC8vIGluaXRpYWxpemUgY29va2llIHBhcnNlclxuXHRcdGFwcC51c2UoY29va2llUGFyc2VyKCkpO1xuXG5cdFx0Ly8gaW5pdGlhbGl6ZSBtb3JnYW4gbG9nZ2VyXG5cdFx0Y29uc3Qgc3RyZWFtOiBTdHJlYW1PcHRpb25zID0ge1xuXHRcdFx0d3JpdGU6IChtZXNzYWdlOiBzdHJpbmcpID0+IGxvZ2dlci5pbmZvKG1lc3NhZ2UudHJpbSgpKVxuXHRcdH07XG5cdFx0YXBwLnVzZShtb3JnYW4oJ2NvbWJpbmVkJywgeyBzdHJlYW0gfSkpO1xuXG5cdFx0Ly8gaW5pdGlhbGl6ZSBDT1JTXG5cdFx0YXBwLnVzZShjb3JzKCkpO1xuXG5cdFx0Ly8gaW5pdGlhbGl6ZSBIUFBcblx0XHRhcHAudXNlKGhwcCgpKTtcblxuXHRcdC8vIGluaXRpYWxpemUgc2Vzc2lvbiB3aXRoIFJlZGlzIHN0b3JlXG5cdFx0YXBwLnVzZShcblx0XHRcdHNlc3Npb24oe1xuXHRcdFx0XHRzZWNyZXQ6IHNlY3JldHMuU0VTU0lPTl9TRUNSRVQsXG5cdFx0XHRcdHJlc2F2ZTogZmFsc2UsXG5cdFx0XHRcdHNhdmVVbmluaXRpYWxpemVkOiB0cnVlLFxuXHRcdFx0XHRzdG9yZTpcblx0XHRcdFx0XHRmZWF0dXJlRmxhZ3MuZW5hYmxlUmVkaXNGbGFnICYmIHJlZGlzQ2xpZW50XG5cdFx0XHRcdFx0XHQ/IG5ldyBSZWRpc1N0b3JlKHsgY2xpZW50OiByZWRpc0NsaWVudCB9KVxuXHRcdFx0XHRcdFx0OiB1bmRlZmluZWQsXG5cdFx0XHRcdGNvb2tpZToge1xuXHRcdFx0XHRcdHNlY3VyZTogZmVhdHVyZUZsYWdzLmVuYWJsZVNzbEZsYWcsXG5cdFx0XHRcdFx0aHR0cE9ubHk6IHRydWUsXG5cdFx0XHRcdFx0c2FtZVNpdGU6ICdzdHJpY3QnXG5cdFx0XHRcdH1cblx0XHRcdH0pXG5cdFx0KTtcblxuXHRcdC8vIGluaXRpYWxpemUgcGFzc3BvcnRcblx0XHRhcHAudXNlKHBhc3Nwb3J0LmluaXRpYWxpemUoKSk7XG5cdFx0YXBwLnVzZShwYXNzcG9ydC5zZXNzaW9uKCkpO1xuXG5cdFx0Ly8gaW5pdGlhbGl6ZSBjb21wcmVzc2lvblxuXHRcdGFwcC51c2UoY29tcHJlc3Npb24oKSk7XG5cblx0XHQvLyBpbml0aWFsaXplIHJlc3BvbnNlIHRpbWVcblx0XHRhcHAudXNlKHJlc3BvbnNlVGltZSgpKTtcblxuXHRcdC8vIHNldCBlLXRhZyBoZWFkZXIgZm9yIGNsaWVudC1zaWRlIGNhY2hpbmdcblx0XHRhcHAuc2V0KCdldGFnJywgJ3N0cm9uZycpO1xuXG5cdFx0Ly8gaW5pdGlhbGl6ZSBzZWN1cml0eSBoZWFkZXJzXG5cdFx0aW5pdGlhbGl6ZVNlY3VyaXR5SGVhZGVycyhhcHAsIHtcblx0XHRcdGhlbG1ldE9wdGlvbnM6IHt9LFxuXHRcdFx0cGVybWlzc2lvbnNQb2xpY3lPcHRpb25zOiB7fVxuXHRcdH0pO1xuXG5cdFx0Ly8gaW5pdGlhbGl6ZSBDU1JGIG1pZGRsZXdhcmVcblx0XHRhcHAudXNlKGluaXRpYWxpemVDc3JmTWlkZGxld2FyZSk7XG5cblx0XHQvLyBpbml0aWFsaXplIHZhbGlkYXRvciBtaWRkbGV3YXJlXG5cdFx0aW5pdGlhbGl6ZVZhbGlkYXRvck1pZGRsZXdhcmUoeyB2YWxpZGF0b3IsIGxvZ2dlciB9KTtcblxuXHRcdC8vIGluaXRpYWxpemUgbWVtb3J5IG1vbml0b3Igb3IgUmVkaXMgc2Vzc2lvbiBiYXNlZCBvbiBmbGFnXG5cdFx0aWYgKCFmZWF0dXJlRmxhZ3MuZW5hYmxlUmVkaXNGbGFnKSB7XG5cdFx0XHRjcmVhdGVNZW1vcnlNb25pdG9yKCk7XG5cdFx0fVxuXG5cdFx0Ly8gaW5pdGlhbGl6ZSByYXRlIGxpbWl0ZXJcblx0XHRpZiAoZmVhdHVyZUZsYWdzLmVuYWJsZVJhdGVMaW1pdEZsYWcpIHtcblx0XHRcdGFwcC51c2UoaW5pdGlhbGl6ZVJhdGVMaW1pdE1pZGRsZXdhcmUpO1xuXHRcdH1cblxuXHRcdC8vIGluaXRpYWxpemUgc2xvd2Rvd24gbWlkZGxld2FyZVxuXHRcdGluaXRpYWxpemVTbG93ZG93bk1pZGRsZXdhcmUoeyBzbG93ZG93blRocmVzaG9sZDogMTAwLCBsb2dnZXIgfSk7XG5cblx0XHQvLyBpbml0aWFsaXplIElQIGJsYWNrbGlzdCBtaWRkbGV3YXJlXG5cdFx0aWYgKGZlYXR1cmVGbGFncy5lbmFibGVJcEJsYWNrbGlzdEZsYWcpIHtcblx0XHRcdGFwcC51c2UoaXBCbGFja2xpc3RNaWRkbGV3YXJlKTtcblx0XHR9XG5cblx0XHQvLyBpbml0aWFsaXplIEpXVCBhdXRoZW50aWNhdGlvbiBtaWRkbGV3YXJlXG5cdFx0YXBwLnVzZShpbml0aWFsaXplSnd0QXV0aE1pZGRsZXdhcmUoeyBsb2dnZXIsIHZlcmlmeUp3dCB9KSk7XG5cblx0XHQvLyBpbml0aWFsaXplIHBhc3Nwb3J0IGF1dGhlbnRpY2F0aW9uIG1pZGRsZXdhcmVcblx0XHRhcHAudXNlKFxuXHRcdFx0aW5pdGlhbGl6ZVBhc3Nwb3J0QXV0aE1pZGRsZXdhcmUoe1xuXHRcdFx0XHRwYXNzcG9ydCxcblx0XHRcdFx0YXV0aGVudGljYXRlT3B0aW9ucyxcblx0XHRcdFx0bG9nZ2VyXG5cdFx0XHR9KVxuXHRcdCk7XG5cblx0XHQvLyBpbml0aWFsaXplIGVycm9yIGhhbmRsZXJcblx0XHRhcHAudXNlKGV4cHJlc3NFcnJvckhhbmRsZXIoeyBsb2dnZXIsIGZlYXR1cmVGbGFncyB9KSk7XG5cblx0XHRyZXR1cm4gYXBwO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdHByb2Nlc3NFcnJvcihlcnJvciBhcyBFcnJvciwgbG9nZ2VyIHx8IGNvbnNvbGUpO1xuXHRcdHRocm93IG5ldyBFcnJvcihcblx0XHRcdGBGYWlsZWQgdG8gaW5pdGlhbGl6ZSBhcHAuIFNlZSBsb2dzIGZvciBtb3JlIGRldGFpbHM6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcn1gXG5cdFx0KTtcblx0fVxufVxuIl19
