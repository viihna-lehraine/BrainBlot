import { validateDependencies } from '../utils/helpers.mjs';
import { ServiceFactory } from '../index/factory.mjs';
export class MailerService {
	nodemailer;
	emailUser;
	static instance = null;
	logger;
	errorLogger;
	errorHandler;
	envConfig;
	vault;
	transporter = null;
	constructor(nodemailer, emailUser) {
		this.nodemailer = nodemailer;
		this.emailUser = emailUser;
	}
	static async getInstance(deps) {
		deps.validateDependencies(
			[
				{ name: 'nodemailer', instance: deps.nodemailer },
				{ name: 'emailUser', instance: deps.emailUser }
			],
			await ServiceFactory.getLoggerService()
		);
		if (!MailerService.instance) {
			const logger = await ServiceFactory.getLoggerService();
			const errorLogger = await ServiceFactory.getErrorLoggerService();
			const errorHandler = await ServiceFactory.getErrorHandlerService();
			const envConfig = await ServiceFactory.getEnvConfigService();
			const vault = await ServiceFactory.getVaultService();
			MailerService.instance = new MailerService(
				deps.nodemailer,
				deps.emailUser
			);
			MailerService.instance.logger = logger;
			MailerService.instance.errorLogger = errorLogger;
			MailerService.instance.errorHandler = errorHandler;
			MailerService.instance.envConfig = envConfig;
			MailerService.instance.vault = vault;
		}
		return MailerService.instance;
	}
	validateMailerDependencies() {
		validateDependencies(
			[
				{ name: 'nodemailer', instance: this.nodemailer },
				{ name: 'emailUser', instance: this.emailUser }
			],
			this.logger
		);
	}
	async createMailTransporter() {
		try {
			this.validateMailerDependencies();
			const smtpToken = this.vault.retrieveSecret(
				'SMTP_TOKEN',
				secret => secret
			);
			if (typeof smtpToken !== 'string') {
				const smtpTokenError =
					new this.errorHandler.ErrorClasses.ConfigurationError(
						'Invalid SMTP token'
					);
				this.errorLogger.logError(smtpTokenError.message);
				this.errorHandler.handleError({ error: smtpTokenError });
				throw smtpTokenError;
			}
			const transportOptions = {
				host: this.envConfig.getEnvVariable('emailHost'),
				port: this.envConfig.getEnvVariable('emailPort'),
				secure: this.envConfig.getEnvVariable('emailSecure'),
				auth: {
					user: this.emailUser,
					pass: smtpToken
				}
			};
			return this.nodemailer.createTransport(transportOptions);
		} catch (depError) {
			const dependencyError =
				new this.errorHandler.ErrorClasses.DependencyErrorRecoverable(
					`Unable to create transporter for Mailer Service\n${depError instanceof Error ? depError.message : 'Unknown error'};`,
					{ exposeToClient: false }
				);
			this.errorLogger.logError(dependencyError.message);
			this.errorHandler.handleError({
				error:
					dependencyError ||
					depError ||
					Error ||
					'Unable to create transporter for Mailer Service'
			});
			throw dependencyError;
		}
	}
	async getTransporter() {
		try {
			this.validateMailerDependencies();
			if (!this.transporter) {
				this.transporter = await this.createMailTransporter();
			}
			return this.transporter;
		} catch (depError) {
			const dependencyError =
				new this.errorHandler.ErrorClasses.DependencyErrorRecoverable(
					`Unable to retrieve transporter for Mailer Service\n${depError instanceof Error ? depError.message : 'Unknown error'};`,
					{
						dependency: 'getTransporter()',
						originalError: depError,
						exposeToClient: false
					}
				);
			this.logger.logError(dependencyError.message);
			this.errorHandler.handleError({
				error: dependencyError || depError || Error || 'Unknown error'
			});
			throw dependencyError;
		}
	}
	async shutdown() {
		try {
			if (this.transporter) {
				this.transporter.close();
				MailerService.instance = null;
				this.logger.info('Mailer service transporter closed.');
			}
		} catch (error) {
			this.errorLogger.logError(
				`Error shutting down Mailer service: ${error instanceof Error ? error.message : error}`
			);
		}
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFpbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3NlcnZpY2VzL01haWxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQVV4RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFHbEQsTUFBTSxPQUFPLGFBQWE7SUFVaEI7SUFDQTtJQVZELE1BQU0sQ0FBQyxRQUFRLEdBQXlCLElBQUksQ0FBQztJQUM3QyxNQUFNLENBQTZCO0lBQ25DLFdBQVcsQ0FBK0I7SUFDMUMsWUFBWSxDQUFnQztJQUM1QyxTQUFTLENBQTZCO0lBQ3RDLEtBQUssQ0FBeUI7SUFDOUIsV0FBVyxHQUF1QixJQUFJLENBQUM7SUFFL0MsWUFDUyxVQUF1QyxFQUN2QyxTQUFpQjtRQURqQixlQUFVLEdBQVYsVUFBVSxDQUE2QjtRQUN2QyxjQUFTLEdBQVQsU0FBUyxDQUFRO0lBQ3ZCLENBQUM7SUFFRyxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FDOUIsSUFBdUI7UUFFdkIsSUFBSSxDQUFDLG9CQUFvQixDQUN4QjtZQUNDLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNqRCxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUU7U0FDL0MsRUFDRCxNQUFNLGNBQWMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUN2QyxDQUFDO1FBRUYsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUM3QixNQUFNLE1BQU0sR0FBRyxNQUFNLGNBQWMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3ZELE1BQU0sV0FBVyxHQUFHLE1BQU0sY0FBYyxDQUFDLHFCQUFxQixFQUFFLENBQUM7WUFDakUsTUFBTSxZQUFZLEdBQUcsTUFBTSxjQUFjLENBQUMsc0JB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QUMsS0FBSyxFQUFFLENBQUM7Z0JBQ3pCLGFBQWEsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO2dCQUM5QixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO1lBQ3hELENBQUM7UUFDRixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNoQixJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FDeEIsdUNBQXVDLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUN2RixDQUFDO1FBQ0gsQ0FBQztJQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUcmFuc3BvcnRlciB9IGZyb20gJ25vZGVtYWlsZXInO1xuaW1wb3J0IHsgdmFsaWRhdGVEZXBlbmRlbmNpZXMgfSBmcm9tICcuLi91dGlscy9oZWxwZXJzJztcbmltcG9ydCB7IE1haWxlclNlcnZpY2VEZXBzIH0gZnJvbSAnLi4vaW5kZXgvaW50ZXJmYWNlcy9zZXJ2aWNlRGVwcyc7XG5pbXBvcnQge1xuXHRBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFbnZDb25maWdTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2UsXG5cdE1haWxlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFZhdWx0U2VydmljZUludGVyZmFjZVxufSBmcm9tICcuLi9pbmRleC9pbnRlcmZhY2VzL3NlcnZpY2VzJztcbmltcG9ydCB7IFNlcnZpY2VGYWN0b3J5IH0gZnJvbSAnLi4vaW5kZXgvZmFjdG9yeSc7XG5pbXBvcnQgU01UUFRyYW5zcG9ydCBmcm9tICdub2RlbWFpbGVyL2xpYi9zbXRwLXRyYW5zcG9ydCc7XG5cbmV4cG9ydCBjbGFzcyBNYWlsZXJTZXJ2aWNlIGltcGxlbWVudHMgTWFpbGVyU2VydmljZUludGVyZmFjZSB7XG5cdHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBNYWlsZXJTZXJ2aWNlIHwgbnVsbCA9IG51bGw7XG5cdHByaXZhdGUgbG9nZ2VyITogQXBwTG9nZ2VyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBlcnJvckxvZ2dlciE6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBlcnJvckhhbmRsZXIhOiBFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIGVudkNvbmZpZyE6IEVudkNvbmZpZ1NlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgdmF1bHQhOiBWYXVsdFNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgdHJhbnNwb3J0ZXI6IFRyYW5zcG9ydGVyIHwgbnVsbCA9IG51bGw7XG5cblx0cHJpdmF0ZSBjb25zdHJ1Y3Rvcihcblx0XHRwcml2YXRlIG5vZGVtYWlsZXI6IHR5cGVvZiBpbXBvcnQoJ25vZGVtYWlsZXInKSxcblx0XHRwcml2YXRlIGVtYWlsVXNlcjogc3RyaW5nXG5cdCkge31cblxuXHRwdWJsaWMgc3RhdGljIGFzeW5jIGdldEluc3RhbmNlKFxuXHRcdGRlcHM6IE1haWxlclNlcnZpY2VEZXBzXG5cdCk6IFByb21pc2U8TWFpbGVyU2VydmljZT4ge1xuXHRcdGRlcHMudmFsaWRhdGVEZXBlbmRlbmNpZXMoXG5cdFx0XHRbXG5cdFx0XHRcdHsgbmFtZTogJ25vZGVtYWlsZXInLCBpbnN0YW5jZTogZGVwcy5ub2RlbWFpbGVyIH0sXG5cdFx0XHRcdHsgbmFtZTogJ2VtYWlsVXNlcicsIGluc3RhbmNlOiBkZXBzLmVtYWlsVXNlciB9XG5cdFx0XHRdLFxuXHRcdFx0YXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0TG9nZ2VyU2VydmljZSgpXG5cdFx0KTtcblxuXHRcdGlmICghTWFpbGVyU2VydmljZS5pbnN0YW5jZSkge1xuXHRcdFx0Y29uc3QgbG9nZ2VyID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0TG9nZ2VyU2VydmljZSgpO1xuXHRcdFx0Y29uc3QgZXJyb3JMb2dnZXIgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRFcnJvckxvZ2dlclNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGVycm9ySGFuZGxlciA9IGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldEVycm9ySGFuZGxlclNlcnZpY2UoKTtcblx0XHRcdGNvbnN0IGVudkNvbmZpZyA9IGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldEVudkNvbmZpZ1NlcnZpY2UoKTtcblx0XHRcdGNvbnN0IHZhdWx0ID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0VmF1bHRTZXJ2aWNlKCk7XG5cblx0XHRcdE1haWxlclNlcnZpY2UuaW5zdGFuY2UgPSBuZXcgTWFpbGVyU2VydmljZShcblx0XHRcdFx0ZGVwcy5ub2RlbWFpbGVyLFxuXHRcdFx0XHRkZXBzLmVtYWlsVXNlclxuXHRcdFx0KTtcblxuXHRcdFx0TWFpbGVyU2VydmljZS5pbnN0YW5jZS5sb2dnZXIgPSBsb2dnZXI7XG5cdFx0XHRNYWlsZXJTZXJ2aWNlLmluc3RhbmNlLmVycm9yTG9nZ2VyID0gZXJyb3JMb2dnZXI7XG5cdFx0XHRNYWlsZXJTZXJ2aWNlLmluc3RhbmNlLmVycm9ySGFuZGxlciA9IGVycm9ySGFuZGxlcjtcblx0XHRcdE1haWxlclNlcnZpY2UuaW5zdGFuY2UuZW52Q29uZmlnID0gZW52Q29uZmlnO1xuXHRcdFx0TWFpbGVyU2VydmljZS5pbnN0YW5jZS52YXVsdCA9IHZhdWx0O1xuXHRcdH1cblxuXHRcdHJldHVybiBNYWlsZXJTZXJ2aWNlLmluc3RhbmNlO1xuXHR9XG5cblx0cHVibGljIHZhbGlkYXRlTWFpbGVyRGVwZW5kZW5jaWVzKCk6IHZvaWQge1xuXHRcdHZhbGlkYXRlRGVwZW5kZW5jaWVzKFxuXHRcdFx0W1xuXHRcdFx0XHR7IG5hbWU6ICdub2RlbWFpbGVyJywgaW5zdGFuY2U6IHRoaXMubm9kZW1haWxlciB9LFxuXHRcdFx0XHR7IG5hbWU6ICdlbWFpbFVzZXInLCBpbnN0YW5jZTogdGhpcy5lbWFpbFVzZXIgfVxuXHRcdFx0XSxcblx0XHRcdHRoaXMubG9nZ2VyXG5cdFx0KTtcblx0fVxuXG5cdHB1YmxpYyBhc3luYyBjcmVhdGVNYWlsVHJhbnNwb3J0ZXIoKTogUHJvbWlzZTxUcmFuc3BvcnRlcj4ge1xuXHRcdHRyeSB7XG5cdFx0XHR0aGlzLnZhbGlkYXRlTWFpbGVyRGVwZW5kZW5jaWVzKCk7XG5cblx0XHRcdGNvbnN0IHNtdHBUb2tlbiA9IHRoaXMudmF1bHQucmV0cmlldmVTZWNyZXQoXG5cdFx0XHRcdCdTTVRQX1RPS0VOJyxcblx0XHRcdFx0c2VjcmV0ID0+IHNlY3JldFxuXHRcdFx0KTtcblxuXHRcdFx0aWYgKHR5cGVvZiBzbXRwVG9rZW4gIT09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdGNvbnN0IHNtdHBUb2tlbkVycm9yID1cblx0XHRcdFx0XHRuZXcgdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JDbGFzc2VzLkNvbmZpZ3VyYXRpb25FcnJvcihcblx0XHRcdFx0XHRcdCdJbnZhbGlkIFNNVFAgdG9rZW4nXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcihzbXRwVG9rZW5FcnJvci5tZXNzYWdlKTtcblx0XHRcdFx0dGhpcy5lcnJvckhhbmRsZXIuaGFuZGxlRXJyb3IoeyBlcnJvcjogc210cFRva2VuRXJyb3IgfSk7XG5cdFx0XHRcdHRocm93IHNtdHBUb2tlbkVycm9yO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCB0cmFuc3BvcnRPcHRpb25zOiBTTVRQVHJhbnNwb3J0Lk9wdGlvbnMgPSB7XG5cdFx0XHRcdGhvc3Q6IHRoaXMuZW52Q29uZmlnLmdldEVudlZhcmlhYmxlKCdlbWFpbEhvc3QnKSxcblx0XHRcdFx0cG9ydDogdGhpcy5lbnZDb25maWcuZ2V0RW52VmFyaWFibGUoJ2VtYWlsUG9ydCcpLFxuXHRcdFx0XHRzZWN1cmU6IHRoaXMuZW52Q29uZmlnLmdldEVudlZhcmlhYmxlKCdlbWFpbFNlY3VyZScpLFxuXHRcdFx0XHRhdXRoOiB7XG5cdFx0XHRcdFx0dXNlcjogdGhpcy5lbWFpbFVzZXIsXG5cdFx0XHRcdFx0cGFzczogc210cFRva2VuXG5cdFx0XHRcdH1cblx0XHRcdH07XG5cblx0XHRcdHJldHVybiB0aGlzLm5vZGVtYWlsZXIuY3JlYXRlVHJhbnNwb3J0KHRyYW5zcG9ydE9wdGlvbnMpO1xuXHRcdH0gY2F0Y2ggKGRlcEVycm9yKSB7XG5cdFx0XHRjb25zdCBkZXBlbmRlbmN5RXJyb3IgPVxuXHRcdFx0XHRuZXcgdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JDbGFzc2VzLkRlcGVuZGVuY3lFcnJvclJlY292ZXJhYmxlKFxuXHRcdFx0XHRcdGBVbmFibGUgdG8gY3JlYXRlIHRyYW5zcG9ydGVyIGZvciBNYWlsZXIgU2VydmljZVxcbiR7ZGVwRXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGRlcEVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9O2AsXG5cdFx0XHRcdFx0eyBleHBvc2VUb0NsaWVudDogZmFsc2UgfVxuXHRcdFx0XHQpO1xuXHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcihkZXBlbmRlbmN5RXJyb3IubWVzc2FnZSk7XG5cdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7XG5cdFx0XHRcdGVycm9yOlxuXHRcdFx0XHRcdGRlcGVuZGVuY3lFcnJvciB8fFxuXHRcdFx0XHRcdGRlcEVycm9yIHx8XG5cdFx0XHRcdFx0RXJyb3IgfHxcblx0XHRcdFx0XHQnVW5hYmxlIHRvIGNyZWF0ZSB0cmFuc3BvcnRlciBmb3IgTWFpbGVyIFNlcnZpY2UnXG5cdFx0XHR9KTtcblx0XHRcdHRocm93IGRlcGVuZGVuY3lFcnJvcjtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgZ2V0VHJhbnNwb3J0ZXIoKTogUHJvbWlzZTxUcmFuc3BvcnRlcj4ge1xuXHRcdHRyeSB7XG5cdFx0XHR0aGlzLnZhbGlkYXRlTWFpbGVyRGVwZW5kZW5jaWVzKCk7XG5cblx0XHRcdGlmICghdGhpcy50cmFuc3BvcnRlcikge1xuXHRcdFx0XHR0aGlzLnRyYW5zcG9ydGVyID0gYXdhaXQgdGhpcy5jcmVhdGVNYWlsVHJhbnNwb3J0ZXIoKTtcblx0XHRcdH1cblx0XHRcdHJldHVybiB0aGlzLnRyYW5zcG9ydGVyITtcblx0XHR9IGNhdGNoIChkZXBFcnJvcikge1xuXHRcdFx0Y29uc3QgZGVwZW5kZW5jeUVycm9yID1cblx0XHRcdFx0bmV3IHRoaXMuZXJyb3JIYW5kbGVyLkVycm9yQ2xhc3Nlcy5EZXBlbmRlbmN5RXJyb3JSZWNvdmVyYWJsZShcblx0XHRcdFx0XHRgVW5hYmxlIHRvIHJldHJpZXZlIHRyYW5zcG9ydGVyIGZvciBNYWlsZXIgU2VydmljZVxcbiR7ZGVwRXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGRlcEVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9O2AsXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0ZGVwZW5kZW5jeTogJ2dldFRyYW5zcG9ydGVyKCknLFxuXHRcdFx0XHRcdFx0b3JpZ2luYWxFcnJvcjogZGVwRXJyb3IsXG5cdFx0XHRcdFx0XHRleHBvc2VUb0NsaWVudDogZmFsc2Vcblx0XHRcdFx0XHR9XG5cdFx0XHRcdCk7XG5cdFx0XHR0aGlzLmxvZ2dlci5sb2dFcnJvcihkZXBlbmRlbmN5RXJyb3IubWVzc2FnZSk7XG5cdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7XG5cdFx0XHRcdGVycm9yOiBkZXBlbmRlbmN5RXJyb3IgfHwgZGVwRXJyb3IgfHwgRXJyb3IgfHwgJ1Vua25vd24gZXJyb3InXG5cdFx0XHR9KTtcblx0XHRcdHRocm93IGRlcGVuZGVuY3lFcnJvcjtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgc2h1dGRvd24oKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGlmICh0aGlzLnRyYW5zcG9ydGVyKSB7XG5cdFx0XHRcdHRoaXMudHJhbnNwb3J0ZXIuY2xvc2UoKTtcblx0XHRcdFx0TWFpbGVyU2VydmljZS5pbnN0YW5jZSA9IG51bGw7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ01haWxlciBzZXJ2aWNlIHRyYW5zcG9ydGVyIGNsb3NlZC4nKTtcblx0XHRcdH1cblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcihcblx0XHRcdFx0YEVycm9yIHNodXR0aW5nIGRvd24gTWFpbGVyIHNlcnZpY2U6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBlcnJvcn1gXG5cdFx0XHQpO1xuXHRcdH1cblx0fVxufVxuIl19
