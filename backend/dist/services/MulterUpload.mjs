import { readFile } from 'fs/promises';
import EventEmitter from 'events';
import { EnvConfigServiceFactory } from '../index/factory/subfactories/EnvConfigServiceFactory.mjs';
export class MulterUploadService extends EventEmitter {
	static instance = null;
	envConfig;
	_deps;
	fileSizeLimit;
	storageDir;
	uploadDir;
	allowedMimeTypes;
	allowedExtensions;
	constructor(
		envConfig,
		deps,
		allowedMimeTypes = [],
		allowedExtensions = []
	) {
		super();
		this.envConfig = envConfig;
		this._deps = deps;
		this.setMaxListeners(5);
		this.fileSizeLimit = this.envConfig.getEnvVariable(
			'multerFileSizeLimit'
		);
		this.storageDir = this.envConfig.getEnvVariable('multerStorageDir');
		this.uploadDir = this.envConfig.getEnvVariable('multerUploadDir');
		this.allowedMimeTypes =
			allowedMimeTypes.length > 0
				? allowedMimeTypes
				: this.getDefaultMimeTypes();
		this.allowedExtensions =
			allowedExtensions.length > 0
				? allowedExtensions
				: this.getDefaultExtensions();
		deps.validateDependencies(
			[
				{ name: 'multer', instance: deps.multer },
				{
					name: 'fileTypeFromBuffer',
					instance: deps.fileTypeFromBuffer
				},
				{ name: 'fs', instance: deps.fs },
				{ name: 'path', instance: deps.path }
			],
			deps.logger
		);
		this._deps.logger.info('Multer Upload Service initialized');
	}
	static async getInstance(
		deps,
		allowedMimeTypes = [],
		allowedExtensions = []
	) {
		if (!MulterUploadService.instance) {
			const envConfig =
				await EnvConfigServiceFactory.getEnvConfigService();
			MulterUploadService.instance = new MulterUploadService(
				envConfig,
				deps,
				allowedMimeTypes,
				allowedExtensions
			);
		}
		return MulterUploadService.instance;
	}
	setFileSizeLimit(limit) {
		if (limit <= 0) {
			throw new Error('File size limit must be greater than zero');
		}
		this.fileSizeLimit = limit;
		this._deps.logger.info(`File size limit set to ${limit} bytes`);
	}
	setAllowedMimeTypes(mimeTypes) {
		if (!mimeTypes.every(mimeType => typeof mimeType === 'string')) {
			throw new Error('Invalid MIME types provided');
		}
		this.allowedMimeTypes = mimeTypes;
		this._deps.logger.info(`Allowed MIME types updated\n${mimeTypes}`);
	}
	setAllowedExtensions(extensions) {
		if (!extensions.every(ext => typeof ext === 'string')) {
			throw new Error('Invalid file extensions provided');
		}
		this.allowedExtensions = extensions;
		this._deps.logger.info(`Allowed extensions updated\n${extensions}`);
	}
	createMulterUpload(validationCallback) {
		try {
			const storage = this._deps.multer.diskStorage({
				destination: (req, file, cb) => {
					this._deps.logger.info(
						`Storing file in: ${this.storageDir}`
					);
					cb(null, this.storageDir);
				},
				filename: (req, file, cb) => {
					const uniqueSuffix = `${Date.now()}-${Math.round(Math.random() * 1e9)}`;
					this._deps.logger.info(
						`File ${file.originalname} will be saved as: ${uniqueSuffix}-${file.originalname}`
					);
					cb(null, `${uniqueSuffix}-${file.originalname}`);
				}
			});
			const fileFilter = async (req, file, cb) => {
				const ext = this._deps.path
					.extname(file.originalname)
					.toLowerCase();
				const isValid = await this.isValidFile(file, ext);
				const isValidationPassed = validationCallback
					? validationCallback(file)
					: true;
				if (isValid && isValidationPassed) {
					this.emit('uploadAccepted', file);
					this._deps.logger.info(
						`File accepted: ${file.originalname}`
					);
					cb(null, true);
				} else {
					this.emit('uploadRejected', file);
					this._deps.logger.warn(
						`File rejected: ${file.originalname}`
					);
					cb(null, false);
				}
			};
			return this._deps.multer({
				storage,
				fileFilter,
				limits: { fileSize: this.fileSizeLimit }
			});
		} catch (depError) {
			this.handleError(
				'Unable to create Multer Upload instance',
				depError || Error || 'Unknown error'
			);
			return undefined;
		}
	}
	onUploadSuccess(callback) {
		this.once('uploadAccepted', callback);
	}
	async isValidFile(file, ext) {
		const isMimeValid = this.allowedMimeTypes.includes(file.mimetype);
		const isExtensionValid = this.allowedExtensions.includes(ext);
		const buffer = await readFile(file.path);
		const fileType = await this._deps.fileTypeFromBuffer(buffer);
		const isContentValid = fileType
			? this.allowedMimeTypes.includes(fileType.mime)
			: false;
		const result = isMimeValid && isExtensionValid && isContentValid;
		this._deps.logger.info(
			`File validation result for ${file.originalname}: ${result}`
		);
		return isMimeValid && isExtensionValid && isContentValid;
	}
	getDefaultMimeTypes() {
		return [
			'image/jpeg',
			'image/png',
			'image/gif',
			'video/mp4',
			'application/pdf',
			'text/plain'
		];
	}
	getDefaultExtensions() {
		return [
			'.bmp',
			'.gif',
			'.jpeg',
			'.jpg',
			'.mp4',
			'.pdf',
			'.png',
			'.txt',
			'.wav'
		];
	}
	shutdown() {
		try {
			this.removeAllListeners();
			MulterUploadService.instance = null;
			this._deps.logger.info(
				'Multer Upload Service shutdown successfully.'
			);
		} catch (error) {
			this._deps.errorLogger.logError(
				`Error shutting down Multer Upload service: ${error instanceof Error ? error.message : error}`
			);
		}
	}
	handleError(message, error) {
		const errorMessage =
			error instanceof Error ? error.message : String(error);
		const dependencyError =
			new this._deps.errorHandler.ErrorClasses.DependencyErrorFatal(
				`${message}: ${errorMessage}`,
				{ exposeToClient: false }
			);
		this._deps.errorLogger.logError(dependencyError.message);
		this._deps.errorHandler.handleError({ error: dependencyError });
		throw dependencyError;
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTXVsdGVyVXBsb2FkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3NlcnZpY2VzL011bHRlclVwbG9hZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3ZDLE9BQU8sWUFBWSxNQUFNLFFBQVEsQ0FBQztBQU9sQyxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSx1REFBdUQsQ0FBQztBQUVoRyxNQUFNLE9BQU8sbUJBQ1osU0FBUSxZQUFZO0lBR1osTUFBTSxDQUFDLFFBQVEsR0FBK0IsSUFBSSxDQUFDO0lBRW5ELFNBQVMsQ0FBNEI7SUFFNUIsS0FBSyxDQUEwQjtJQUN6QyxhQUFhLENBQVM7SUFDdEIsVUFBVSxDQUFTO0lBQ25CLFNBQVMsQ0FBUztJQUNsQixnQkFBZ0IsQ0FBVztJQUMzQixpQkFBaUIsQ0FBVztJQUVuQyxZQUNDLFNBQW9DLEVBQ3BDLElBQTZCLEVBQzdCLG1CQUE2QixFQUFFLEVBQy9CLG9CQUE4QixFQUFFO1FBRWhDLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDM0IsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDbEIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4QixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUNqRCxxQkFBcUIsQ0FDckIsQ0FBQztRQUNGLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUNwRSxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDbEUsSUFBSSxDQUFDLGdCQUFnQjtZQUNwQixnQkFBZ0IsQ0FBQyxNQUFNLEdBQUcsQ0FBQztnQkFDMUIsQ0FBQyxDQUFDLGdCQUFnQjtnQkFDbEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1FBQy9CLElBQUksQ0FBQyxpQkFBaUI7WUFDckIsaUJBQWlCLENBQUMsTUFBTSxHQUFHLENBQUM7Z0JBQzNCLENBQUMsQ0FBQyxpQkFBaUI7Z0JBQ25CLENBQUMsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUVoQyxJQUFJLENBQUMsb0JBQW9CLENBQ3hCO1lBQ0MsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ3pDO2dCQUNDLElBQUksRUFBRSxvQkFBb0I7Z0JBQzFCLFFBQVEsRUFBRSxJQUFJLENBQUMsa0JBQWtCO2FBQ2pDO1lBQ0QsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ2pDLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRTtTQUNyQyxFQUNELElBQUksQ0FBQyxNQUFNLENBQ1gsQ0FBQztRQUNGLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFFTSxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FDOUIsSUFBNkIsRUFDN0IsbUJBQTZCLEVBQUUsRUFDL0Isb0JBQThCLEVBQUU7UUFFaEMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ25DLE1BQU0sU0FBUyxHQUNkLE1BQU0sdUJBQXVCLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztZQUNyRCxtQkFBbUIsQ0FBQyxRQUFRLEdBQUcsSUFBSSxtQkFBbUIsQ0FDckQsU0FBUyxFQUNULElBQUksRUFDSixnQkFBZ0IsRUFDaEIsaUJBQWlCLENBQ2pCLENBQUM7UUFDSCxDQUFDO1FBQ0QsT0FBTyxtQkFBbUIsQ0FBQyxRQUFRLENBQUM7SUFDckMsQ0FBQztJQUVNLGdCQUFnQixDQUFDLEtBQWE7UUFDcEMsSUFBSSxLQUFLLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDaEIsTUFBTSxJQUFJLEtBQUssQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDO1FBQzlELENBQUM7UUFDRCxJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQztRQUMzQixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsMEJBQTBCLEtBQUssUUFBUSxDQUFDLENBQUM7SUFDakUsQ0FBQztJQUVNLG1CQUFtQixDQUFDLFNBQW1CO1FBQzdDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsT0FBTyxRQUFRLEtBQUssUUFBUSxDQUFDLEVBQUUsQ0FBQztZQUNoRSxNQUFNLElBQUksS0FBSyxDQUFDLDZCQUE2QixDQUFDLENBQUM7UUFDaEQsQ0FBQztRQUNELElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxTQUFTLENBQUM7UUFDbEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLCtCQUErQixTQUFTLEVBQUUsQ0FBQyxDQUFDO0lBQ3BFLENBQUM7SUFFTSxvQkFBb0IsQ0FBQyxVQUFvQjtRQUMvQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLE9BQU8sR0FBRyxLQUFLLFFBQVEsQ0FBQyxFQUFFLENBQUM7WUFDdkQsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO1FBQ3JELENBQUM7UUFDRCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsVUFBVSxDQUFDO1FBQ3BDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQywrQkFBK0IsVUFBVSxFQUFFLENBQUMsQ0FBQztJQUNyRSxDQUFDO0lBRU0sa0JBQWtCLENBQ3hCLGtCQUEyRDtRQUUzRCxJQUFJLENBQUM7WUFDSixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUM7Z0JBQzdDLFdBQVcsRUFBRSxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLEVBQUU7b0JBQzlCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDckIsb0JBQW9CLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FDckMsQ0FBQztvQkFDRixFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDM0IsQ0FBQztnQkFDRCxRQUFRLEVBQUUsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxFQUFFO29CQUMzQixNQUFNLFlBQVksR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsRUFBRSxDQUFDO29CQUN4RSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQ3JCLFFBQVEsSUFBSSxDQUFDLFlBQVksc0JBQXNCLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQ2xGLENBQUM7b0JBQ0YsRUFBRSxDQUFDLElBQUksRUFBRSxHQUFHLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQztnQkFDbEQsQ0FBQzthQUNELENBQUMsQ0FBQztZQUVILE1BQU0sVUFBVSxHQUFHLEtBQUssRUFDdkIsR0FBWSxFQUNaLElBQXlCLEVBQ3pCLEVBQXNCLEVBQ04sRUFBRTtnQkFDbEIsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJO3FCQUN6QixPQUFPLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQztxQkFDMUIsV0FBVyxFQUFFLENBQUM7Z0JBQ2hCLE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBRWxELE1BQU0sa0JBQWtCLEdBQUcsa0JBQWtCO29CQUM1QyxDQUFDLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDO29CQUMxQixDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUVSLElBQUksT0FBTyxJQUFJLGtCQUFrQixFQUFFLENBQUM7b0JBQ25DLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLENBQUM7b0JBQ2xDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDckIsa0JBQWtCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FDckMsQ0FBQztvQkFDRixFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUNoQixDQUFDO3FCQUFNLENBQUM7b0JBQ1AsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsQ0FBQztvQkFDbEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNyQixrQkFBa0IsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUNyQyxDQUFDO29CQUNGLEVBQUUsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQ2pCLENBQUM7WUFDRixDQUFDLENBQUM7WUFFRixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO2dCQUN4QixPQUFPO2dCQUNQLFVBQVU7Z0JBQ1YsTUFBTSxFQUFFLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxhQUFhLEVBQUU7YUFDeEMsQ0FBQyxDQUFDO1FBQ0osQ0FBQztRQUFDLE9BQU8sUUFBUSxFQUFFLENBQUM7WUFDbkIsSUFBSSxDQUFDLFdBQVcsQ0FDZix5Q0FBeUMsRUFDekMsUUFBUSxJQUFJLEtBQUssSUFBSSxlQUFlLENBQ3BDLENBQUM7WUFDRixPQUFPLFNBQVMsQ0FBQztRQUNsQixDQUFDO0lBQ0YsQ0FBQztJQUVNLGVBQWUsQ0FDckIsUUFBNkM7UUFFN0MsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBRU8sS0FBSyxDQUFDLFdBQVcsQ0FDeEIsSUFBeUIsRUFDekIsR0FBVztRQUVYLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2xFLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUU5RCxNQUFNLE1BQU0sR0FBRyxNQUFNLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDekMsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTdELE1BQU0sY0FBYyxHQUFHLFFBQVE7WUFDOUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztZQUMvQyxDQUFDLENBQUMsS0FBSyxDQUFDO1FBRVQsTUFBTSxNQUFNLEdBQUcsV0FBVyxJQUFJLGdCQUFnQixJQUFJLGNBQWMsQ0FBQztRQUVqRSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQ3JCLDhCQUE4QixJQUFJLENBQUMsWUFBWSxLQUFLLE1BQU0sRUFBRSxDQUM1RCxDQUFDO1FBQ0YsT0FBTyxXQUFXLElBQUksZ0JBQWdCLElBQUksY0FBYyxDQUFDO0lBQzFELENBQUM7SUFFTyxtQkFBbUI7UUFDMUIsT0FBTztZQUNOLFlBQVk7WUFDWixXQUFXO1lBQ1gsV0FBVztZQUNYLFdBQVc7WUFDWCxpQkFBaUI7WUFDakIsWUFBWTtTQUNaLENBQUM7SUFDSCxDQUFDO0lBRU8sb0JBQW9CO1FBQzNCLE9BQU87WUFDTixNQUFNO1lBQ04sTUFBTTtZQUNOLE9BQU87WUFDUCxNQUFNO1lBQ04sTUFBTTtZQUNOLE1BQU07WUFDTixNQUFNO1lBQ04sTUFBTTtZQUNOLE1BQU07U0FDTixDQUFDO0lBQ0gsQ0FBQztJQUVNLFFBQVE7UUFDZCxJQUFJLENBQUM7WUFDSixJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztZQUMxQixtQkFBbUIsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1lBQ3BDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDckIsOENBQThDLENBQzlDLENBQUM7UUFDSCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNoQixJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQzlCLDhDQUNDLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQzFDLEVBQUUsQ0FDRixDQUFDO1FBQ0gsQ0FBQztJQUNGLENBQUM7SUFFTyxXQUFXLENBQUMsT0FBZSxFQUFFLEtBQWM7UUFDbEQsTUFBTSxZQUFZLEdBQ2pCLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN4RCxNQUFNLGVBQWUsR0FDcEIsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsb0JBQW9CLENBQzVELEdBQUcsT0FBTyxLQUFLLFlBQVksRUFBRSxFQUM3QixFQUFFLGNBQWMsRUFBRSxLQUFLLEVBQUUsQ0FDekIsQ0FBQztRQUVILElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDekQsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLEVBQUUsS0FBSyxFQUFFLGVBQWUsRUFBRSxDQUFDLENBQUM7UUFFaEUsTUFBTSxlQUFlLENBQUM7SUFDdkIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcXVlc3QgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IHJlYWRGaWxlIH0gZnJvbSAnZnMvcHJvbWlzZXMnO1xuaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICdldmVudHMnO1xuaW1wb3J0IHsgRmlsZUZpbHRlckNhbGxiYWNrLCBNdWx0ZXIgfSBmcm9tICdtdWx0ZXInO1xuaW1wb3J0IHtcblx0RW52Q29uZmlnU2VydmljZUludGVyZmFjZSxcblx0TXVsdGVyVXBsb2FkU2VydmljZURlcHMsXG5cdE11bHRlclVwbG9hZFNlcnZpY2VJbnRlcmZhY2Vcbn0gZnJvbSAnLi4vaW5kZXgvaW50ZXJmYWNlcy9tYWluJztcbmltcG9ydCB7IEVudkNvbmZpZ1NlcnZpY2VGYWN0b3J5IH0gZnJvbSAnLi4vaW5kZXgvZmFjdG9yeS9zdWJmYWN0b3JpZXMvRW52Q29uZmlnU2VydmljZUZhY3RvcnknO1xuXG5leHBvcnQgY2xhc3MgTXVsdGVyVXBsb2FkU2VydmljZVxuXHRleHRlbmRzIEV2ZW50RW1pdHRlclxuXHRpbXBsZW1lbnRzIE11bHRlclVwbG9hZFNlcnZpY2VJbnRlcmZhY2Vcbntcblx0cHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IE11bHRlclVwbG9hZFNlcnZpY2UgfCBudWxsID0gbnVsbDtcblxuXHRwcml2YXRlIGVudkNvbmZpZzogRW52Q29uZmlnU2VydmljZUludGVyZmFjZTtcblxuXHRwcml2YXRlIHJlYWRvbmx5IF9kZXBzOiBNdWx0ZXJVcGxvYWRTZXJ2aWNlRGVwcztcblx0cHVibGljIGZpbGVTaXplTGltaXQ6IG51bWJlcjtcblx0cHVibGljIHN0b3JhZ2VEaXI6IHN0cmluZztcblx0cHVibGljIHVwbG9hZERpcjogc3RyaW5nO1xuXHRwdWJsaWMgYWxsb3dlZE1pbWVUeXBlczogc3RyaW5nW107XG5cdHB1YmxpYyBhbGxvd2VkRXh0ZW5zaW9uczogc3RyaW5nW107XG5cblx0cHJpdmF0ZSBjb25zdHJ1Y3Rvcihcblx0XHRlbnZDb25maWc6IEVudkNvbmZpZ1NlcnZpY2VJbnRlcmZhY2UsXG5cdFx0ZGVwczogTXVsdGVyVXBsb2FkU2VydmljZURlcHMsXG5cdFx0YWxsb3dlZE1pbWVUeXBlczogc3RyaW5nW10gPSBbXSxcblx0XHRhbGxvd2VkRXh0ZW5zaW9uczogc3RyaW5nW10gPSBbXVxuXHQpIHtcblx0XHRzdXBlcigpO1xuXHRcdHRoaXMuZW52Q29uZmlnID0gZW52Q29uZmlnO1xuXHRcdHRoaXMuX2RlcHMgPSBkZXBzO1xuXHRcdHRoaXMuc2V0TWF4TGlzdGVuZXJzKDUpO1xuXHRcdHRoaXMuZmlsZVNpemVMaW1pdCA9IHRoaXMuZW52Q29uZmlnLmdldEVudlZhcmlhYmxlKFxuXHRcdFx0J211bHRlckZpbGVTaXplTGltaXQnXG5cdFx0KTtcblx0XHR0aGlzLnN0b3JhZ2VEaXIgPSB0aGlzLmVudkNvbmZpZy5nZXRFbnZWYXJpYWJsZSgnbXVsdGVyU3RvcmFnZURpcicpO1xuXHRcdHRoaXMudXBsb2FkRGlyID0gdGhpcy5lbnZDb25maWcuZ2V0RW52VmFyaWFibGUoJ211bHRlclVwbG9hZERpcicpO1xuXHRcdHRoaXMuYWxsb3dlZE1pbWVUeXBlcyA9XG5cdFx0XHRhbGxvd2VkTWltZVR5cGVzLmxlbmd0aCA+IDBcblx0XHRcdFx0PyBhbGxvd2VkTWltZVR5cGVzXG5cdFx0XHRcdDogdGhpcy5nZXREZWZhdWx0TWltZVR5cGVzKCk7XG5cdFx0dGhpcy5hbGxvd2VkRXh0ZW5zaW9ucyA9XG5cdFx0XHRhbGxvd2VkRXh0ZW5zaW9ucy5sZW5ndGggPiAwXG5cdFx0XHRcdD8gYWxsb3dlZEV4dGVuc2lvbnNcblx0XHRcdFx0OiB0aGlzLmdldERlZmF1bHRFeHRlbnNpb25zKCk7XG5cblx0XHRkZXBzLnZhbGlkYXRlRGVwZW5kZW5jaWVzKFxuXHRcdFx0W1xuXHRcdFx0XHR7IG5hbWU6ICdtdWx0ZXInLCBpbnN0YW5jZTogZGVwcy5tdWx0ZXIgfSxcblx0XHRcdFx0e1xuXHRcdFx0XHRcdG5hbWU6ICdmaWxlVHlwZUZyb21CdWZmZXInLFxuXHRcdFx0XHRcdGluc3RhbmNlOiBkZXBzLmZpbGVUeXBlRnJvbUJ1ZmZlclxuXHRcdFx0XHR9LFxuXHRcdFx0XHR7IG5hbWU6ICdmcycsIGluc3RhbmNlOiBkZXBzLmZzIH0sXG5cdFx0XHRcdHsgbmFtZTogJ3BhdGgnLCBpbnN0YW5jZTogZGVwcy5wYXRoIH1cblx0XHRcdF0sXG5cdFx0XHRkZXBzLmxvZ2dlclxuXHRcdCk7XG5cdFx0dGhpcy5fZGVwcy5sb2dnZXIuaW5mbygnTXVsdGVyIFVwbG9hZCBTZXJ2aWNlIGluaXRpYWxpemVkJyk7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGFzeW5jIGdldEluc3RhbmNlKFxuXHRcdGRlcHM6IE11bHRlclVwbG9hZFNlcnZpY2VEZXBzLFxuXHRcdGFsbG93ZWRNaW1lVHlwZXM6IHN0cmluZ1tdID0gW10sXG5cdFx0YWxsb3dlZEV4dGVuc2lvbnM6IHN0cmluZ1tdID0gW11cblx0KTogUHJvbWlzZTxNdWx0ZXJVcGxvYWRTZXJ2aWNlPiB7XG5cdFx0aWYgKCFNdWx0ZXJVcGxvYWRTZXJ2aWNlLmluc3RhbmNlKSB7XG5cdFx0XHRjb25zdCBlbnZDb25maWcgPVxuXHRcdFx0XHRhd2FpdCBFbnZDb25maWdTZXJ2aWNlRmFjdG9yeS5nZXRFbnZDb25maWdTZXJ2aWNlKCk7XG5cdFx0XHRNdWx0ZXJVcGxvYWRTZXJ2aWNlLmluc3RhbmNlID0gbmV3IE11bHRlclVwbG9hZFNlcnZpY2UoXG5cdFx0XHRcdGVudkNvbmZpZyxcblx0XHRcdFx0ZGVwcyxcblx0XHRcdFx0YWxsb3dlZE1pbWVUeXBlcyxcblx0XHRcdFx0YWxsb3dlZEV4dGVuc2lvbnNcblx0XHRcdCk7XG5cdFx0fVxuXHRcdHJldHVybiBNdWx0ZXJVcGxvYWRTZXJ2aWNlLmluc3RhbmNlO1xuXHR9XG5cblx0cHVibGljIHNldEZpbGVTaXplTGltaXQobGltaXQ6IG51bWJlcik6IHZvaWQge1xuXHRcdGlmIChsaW1pdCA8PSAwKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ0ZpbGUgc2l6ZSBsaW1pdCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvJyk7XG5cdFx0fVxuXHRcdHRoaXMuZmlsZVNpemVMaW1pdCA9IGxpbWl0O1xuXHRcdHRoaXMuX2RlcHMubG9nZ2VyLmluZm8oYEZpbGUgc2l6ZSBsaW1pdCBzZXQgdG8gJHtsaW1pdH0gYnl0ZXNgKTtcblx0fVxuXG5cdHB1YmxpYyBzZXRBbGxvd2VkTWltZVR5cGVzKG1pbWVUeXBlczogc3RyaW5nW10pOiB2b2lkIHtcblx0XHRpZiAoIW1pbWVUeXBlcy5ldmVyeShtaW1lVHlwZSA9PiB0eXBlb2YgbWltZVR5cGUgPT09ICdzdHJpbmcnKSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIE1JTUUgdHlwZXMgcHJvdmlkZWQnKTtcblx0XHR9XG5cdFx0dGhpcy5hbGxvd2VkTWltZVR5cGVzID0gbWltZVR5cGVzO1xuXHRcdHRoaXMuX2RlcHMubG9nZ2VyLmluZm8oYEFsbG93ZWQgTUlNRSB0eXBlcyB1cGRhdGVkXFxuJHttaW1lVHlwZXN9YCk7XG5cdH1cblxuXHRwdWJsaWMgc2V0QWxsb3dlZEV4dGVuc2lvbnMoZXh0ZW5zaW9uczogc3RyaW5nW10pOiB2b2lkIHtcblx0XHRpZiAoIWV4dGVuc2lvbnMuZXZlcnkoZXh0ID0+IHR5cGVvZiBleHQgPT09ICdzdHJpbmcnKSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGZpbGUgZXh0ZW5zaW9ucyBwcm92aWRlZCcpO1xuXHRcdH1cblx0XHR0aGlzLmFsbG93ZWRFeHRlbnNpb25zID0gZXh0ZW5zaW9ucztcblx0XHR0aGlzLl9kZXBzLmxvZ2dlci5pbmZvKGBBbGxvd2VkIGV4dGVuc2lvbnMgdXBkYXRlZFxcbiR7ZXh0ZW5zaW9uc31gKTtcblx0fVxuXG5cdHB1YmxpYyBjcmVhdGVNdWx0ZXJVcGxvYWQoXG5cdFx0dmFsaWRhdGlvbkNhbGxiYWNrPzogKGZpbGU6IEV4cHJlc3MuTXVsdGVyLkZpbGUpID0+IGJvb2xlYW5cblx0KTogTXVsdGVyIHwgdW5kZWZpbmVkIHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3Qgc3RvcmFnZSA9IHRoaXMuX2RlcHMubXVsdGVyLmRpc2tTdG9yYWdlKHtcblx0XHRcdFx0ZGVzdGluYXRpb246IChyZXEsIGZpbGUsIGNiKSA9PiB7XG5cdFx0XHRcdFx0dGhpcy5fZGVwcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0XHRcdGBTdG9yaW5nIGZpbGUgaW46ICR7dGhpcy5zdG9yYWdlRGlyfWBcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdGNiKG51bGwsIHRoaXMuc3RvcmFnZURpcik7XG5cdFx0XHRcdH0sXG5cdFx0XHRcdGZpbGVuYW1lOiAocmVxLCBmaWxlLCBjYikgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IHVuaXF1ZVN1ZmZpeCA9IGAke0RhdGUubm93KCl9LSR7TWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogMWU5KX1gO1xuXHRcdFx0XHRcdHRoaXMuX2RlcHMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0XHRgRmlsZSAke2ZpbGUub3JpZ2luYWxuYW1lfSB3aWxsIGJlIHNhdmVkIGFzOiAke3VuaXF1ZVN1ZmZpeH0tJHtmaWxlLm9yaWdpbmFsbmFtZX1gXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRjYihudWxsLCBgJHt1bmlxdWVTdWZmaXh9LSR7ZmlsZS5vcmlnaW5hbG5hbWV9YCk7XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXG5cdFx0XHRjb25zdCBmaWxlRmlsdGVyID0gYXN5bmMgKFxuXHRcdFx0XHRyZXE6IFJlcXVlc3QsXG5cdFx0XHRcdGZpbGU6IEV4cHJlc3MuTXVsdGVyLkZpbGUsXG5cdFx0XHRcdGNiOiBGaWxlRmlsdGVyQ2FsbGJhY2tcblx0XHRcdCk6IFByb21pc2U8dm9pZD4gPT4ge1xuXHRcdFx0XHRjb25zdCBleHQgPSB0aGlzLl9kZXBzLnBhdGhcblx0XHRcdFx0XHQuZXh0bmFtZShmaWxlLm9yaWdpbmFsbmFtZSlcblx0XHRcdFx0XHQudG9Mb3dlckNhc2UoKTtcblx0XHRcdFx0Y29uc3QgaXNWYWxpZCA9IGF3YWl0IHRoaXMuaXNWYWxpZEZpbGUoZmlsZSwgZXh0KTtcblxuXHRcdFx0XHRjb25zdCBpc1ZhbGlkYXRpb25QYXNzZWQgPSB2YWxpZGF0aW9uQ2FsbGJhY2tcblx0XHRcdFx0XHQ/IHZhbGlkYXRpb25DYWxsYmFjayhmaWxlKVxuXHRcdFx0XHRcdDogdHJ1ZTtcblxuXHRcdFx0XHRpZiAoaXNWYWxpZCAmJiBpc1ZhbGlkYXRpb25QYXNzZWQpIHtcblx0XHRcdFx0XHR0aGlzLmVtaXQoJ3VwbG9hZEFjY2VwdGVkJywgZmlsZSk7XG5cdFx0XHRcdFx0dGhpcy5fZGVwcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0XHRcdGBGaWxlIGFjY2VwdGVkOiAke2ZpbGUub3JpZ2luYWxuYW1lfWBcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdGNiKG51bGwsIHRydWUpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHRoaXMuZW1pdCgndXBsb2FkUmVqZWN0ZWQnLCBmaWxlKTtcblx0XHRcdFx0XHR0aGlzLl9kZXBzLmxvZ2dlci53YXJuKFxuXHRcdFx0XHRcdFx0YEZpbGUgcmVqZWN0ZWQ6ICR7ZmlsZS5vcmlnaW5hbG5hbWV9YFxuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0Y2IobnVsbCwgZmFsc2UpO1xuXHRcdFx0XHR9XG5cdFx0XHR9O1xuXG5cdFx0XHRyZXR1cm4gdGhpcy5fZGVwcy5tdWx0ZXIoe1xuXHRcdFx0XHRzdG9yYWdlLFxuXHRcdFx0XHRmaWxlRmlsdGVyLFxuXHRcdFx0XHRsaW1pdHM6IHsgZmlsZVNpemU6IHRoaXMuZmlsZVNpemVMaW1pdCB9XG5cdFx0XHR9KTtcblx0XHR9IGNhdGNoIChkZXBFcnJvcikge1xuXHRcdFx0dGhpcy5oYW5kbGVFcnJvcihcblx0XHRcdFx0J1VuYWJsZSB0byBjcmVhdGUgTXVsdGVyIFVwbG9hZCBpbnN0YW5jZScsXG5cdFx0XHRcdGRlcEVycm9yIHx8IEVycm9yIHx8ICdVbmtub3duIGVycm9yJ1xuXHRcdFx0KTtcblx0XHRcdHJldHVybiB1bmRlZmluZWQ7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIG9uVXBsb2FkU3VjY2Vzcyhcblx0XHRjYWxsYmFjazogKGZpbGU6IEV4cHJlc3MuTXVsdGVyLkZpbGUpID0+IHZvaWRcblx0KTogdm9pZCB7XG5cdFx0dGhpcy5vbmNlKCd1cGxvYWRBY2NlcHRlZCcsIGNhbGxiYWNrKTtcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgaXNWYWxpZEZpbGUoXG5cdFx0ZmlsZTogRXhwcmVzcy5NdWx0ZXIuRmlsZSxcblx0XHRleHQ6IHN0cmluZ1xuXHQpOiBQcm9taXNlPGJvb2xlYW4+IHtcblx0XHRjb25zdCBpc01pbWVWYWxpZCA9IHRoaXMuYWxsb3dlZE1pbWVUeXBlcy5pbmNsdWRlcyhmaWxlLm1pbWV0eXBlKTtcblx0XHRjb25zdCBpc0V4dGVuc2lvblZhbGlkID0gdGhpcy5hbGxvd2VkRXh0ZW5zaW9ucy5pbmNsdWRlcyhleHQpO1xuXG5cdFx0Y29uc3QgYnVmZmVyID0gYXdhaXQgcmVhZEZpbGUoZmlsZS5wYXRoKTtcblx0XHRjb25zdCBmaWxlVHlwZSA9IGF3YWl0IHRoaXMuX2RlcHMuZmlsZVR5cGVGcm9tQnVmZmVyKGJ1ZmZlcik7XG5cblx0XHRjb25zdCBpc0NvbnRlbnRWYWxpZCA9IGZpbGVUeXBlXG5cdFx0XHQ/IHRoaXMuYWxsb3dlZE1pbWVUeXBlcy5pbmNsdWRlcyhmaWxlVHlwZS5taW1lKVxuXHRcdFx0OiBmYWxzZTtcblxuXHRcdGNvbnN0IHJlc3VsdCA9IGlzTWltZVZhbGlkICYmIGlzRXh0ZW5zaW9uVmFsaWQgJiYgaXNDb250ZW50VmFsaWQ7XG5cblx0XHR0aGlzLl9kZXBzLmxvZ2dlci5pbmZvKFxuXHRcdFx0YEZpbGUgdmFsaWRhdGlvbiByZXN1bHQgZm9yICR7ZmlsZS5vcmlnaW5hbG5hbWV9OiAke3Jlc3VsdH1gXG5cdFx0KTtcblx0XHRyZXR1cm4gaXNNaW1lVmFsaWQgJiYgaXNFeHRlbnNpb25WYWxpZCAmJiBpc0NvbnRlbnRWYWxpZDtcblx0fVxuXG5cdHByaXZhdGUgZ2V0RGVmYXVsdE1pbWVUeXBlcygpOiBzdHJpbmdbXSB7XG5cdFx0cmV0dXJuIFtcblx0XHRcdCdpbWFnZS9qcGVnJyxcblx0XHRcdCdpbWFnZS9wbmcnLFxuXHRcdFx0J2ltYWdlL2dpZicsXG5cdFx0XHQndmlkZW8vbXA0Jyxcblx0XHRcdCdhcHBsaWNhdGlvbi9wZGYnLFxuXHRcdFx0J3RleHQvcGxhaW4nXG5cdFx0XTtcblx0fVxuXG5cdHByaXZhdGUgZ2V0RGVmYXVsdEV4dGVuc2lvbnMoKTogc3RyaW5nW10ge1xuXHRcdHJldHVybiBbXG5cdFx0XHQnLmJtcCcsXG5cdFx0XHQnLmdpZicsXG5cdFx0XHQnLmpwZWcnLFxuXHRcdFx0Jy5qcGcnLFxuXHRcdFx0Jy5tcDQnLFxuXHRcdFx0Jy5wZGYnLFxuXHRcdFx0Jy5wbmcnLFxuXHRcdFx0Jy50eHQnLFxuXHRcdFx0Jy53YXYnXG5cdFx0XTtcblx0fVxuXG5cdHB1YmxpYyBzaHV0ZG93bigpOiB2b2lkIHtcblx0XHR0cnkge1xuXHRcdFx0dGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoKTtcblx0XHRcdE11bHRlclVwbG9hZFNlcnZpY2UuaW5zdGFuY2UgPSBudWxsO1xuXHRcdFx0dGhpcy5fZGVwcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0J011bHRlciBVcGxvYWQgU2VydmljZSBzaHV0ZG93biBzdWNjZXNzZnVsbHkuJ1xuXHRcdFx0KTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5fZGVwcy5lcnJvckxvZ2dlci5sb2dFcnJvcihcblx0XHRcdFx0YEVycm9yIHNodXR0aW5nIGRvd24gTXVsdGVyIFVwbG9hZCBzZXJ2aWNlOiAke1xuXHRcdFx0XHRcdGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogZXJyb3Jcblx0XHRcdFx0fWBcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSBoYW5kbGVFcnJvcihtZXNzYWdlOiBzdHJpbmcsIGVycm9yOiB1bmtub3duKTogdm9pZCB7XG5cdFx0Y29uc3QgZXJyb3JNZXNzYWdlID1cblx0XHRcdGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKTtcblx0XHRjb25zdCBkZXBlbmRlbmN5RXJyb3IgPVxuXHRcdFx0bmV3IHRoaXMuX2RlcHMuZXJyb3JIYW5kbGVyLkVycm9yQ2xhc3Nlcy5EZXBlbmRlbmN5RXJyb3JGYXRhbChcblx0XHRcdFx0YCR7bWVzc2FnZX06ICR7ZXJyb3JNZXNzYWdlfWAsXG5cdFx0XHRcdHsgZXhwb3NlVG9DbGllbnQ6IGZhbHNlIH1cblx0XHRcdCk7XG5cblx0XHR0aGlzLl9kZXBzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKGRlcGVuZGVuY3lFcnJvci5tZXNzYWdlKTtcblx0XHR0aGlzLl9kZXBzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7IGVycm9yOiBkZXBlbmRlbmN5RXJyb3IgfSk7XG5cblx0XHR0aHJvdyBkZXBlbmRlbmN5RXJyb3I7XG5cdH1cbn1cbiJdfQ==
