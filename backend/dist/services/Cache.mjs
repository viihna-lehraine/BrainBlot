import { ServiceFactory } from '../index/factory.mjs';
import { serviceTTLConfig } from '../config/cache.mjs';
import { withRetry } from '../utils/helpers.mjs';
export class CacheService {
	static instance = null;
	logger;
	errorLogger;
	errorHandler;
	redisService;
	memoryCache = new Map();
	memoryCacheLRU = new Map();
	serviceMetrics = {};
	constructor(logger, errorLogger, errorHandler, redisService) {
		this.logger = logger;
		this.errorLogger = errorLogger;
		this.errorHandler = errorHandler;
		this.redisService = redisService;
	}
	static async getInstance() {
		if (!CacheService.instance) {
			CacheService.instance = new CacheService(
				await ServiceFactory.getLoggerService(),
				await ServiceFactory.getErrorLoggerService(),
				await ServiceFactory.getErrorHandlerService(),
				await ServiceFactory.getRedisService()
			);
		}
		return CacheService.instance;
	}
	getServiceTTL(service) {
		return serviceTTLConfig[service] || serviceTTLConfig['default'];
	}
	getNamespacedKey(service, key) {
		return `${service}:${key}`;
	}
	updateMetrics(service, type) {
		if (!this.serviceMetrics[service]) {
			this.serviceMetrics[service] = {
				cacheHits: 0,
				cacheMisses: 0,
				redisHits: 0
			};
		}
		if (type === 'hit') {
			this.serviceMetrics[service].cacheHits++;
		} else if (type === 'miss') {
			this.serviceMetrics[service].cacheMisses++;
		} else if (type === 'redisHit') {
			this.serviceMetrics[service].redisHits++;
		}
	}
	getCacheMetrics(service) {
		return (
			this.serviceMetrics[service] || {
				cacheHits: 0,
				cacheMisses: 0,
				redisHits: 0
			}
		);
	}
	getMemoryCache(service) {
		return this.memoryCache.get(service) || null;
	}
	async get(key, service) {
		const namespacedKey = this.getNamespacedKey(service, key);
		try {
			const serviceMemoryCache = this.memoryCache.get(service);
			if (serviceMemoryCache) {
				const memoryEntry = serviceMemoryCache.get(namespacedKey);
				if (memoryEntry) {
					if (
						memoryEntry.expiration &&
						Date.now() > memoryEntry.expiration
					) {
						serviceMemoryCache.delete(namespacedKey);
						this.logger.info(
							`Memory cache expired for key: ${namespacedKey}`
						);
					} else {
						this.memoryCacheLRU.set(namespacedKey, Date.now());
						this.updateMetrics(service, 'hit');
						this.logger.info(
							`Memory cache hit for key: ${namespacedKey}`
						);
						return memoryEntry.value;
					}
				}
			}
			const redisValue =
				(await this.redisService?.get(namespacedKey)) ?? null;
			if (redisValue !== null) {
				const defaultExpiration =
					Date.now() + this.getServiceTTL(service) * 1000;
				if (!serviceMemoryCache) {
					this.memoryCache.set(service, new Map());
				}
				this.memoryCache.get(service)?.set(namespacedKey, {
					value: redisValue,
					expiration: defaultExpiration
				});
				this.memoryCacheLRU.set(namespacedKey, Date.now());
				this.updateMetrics(service, 'redisHit');
				this.logger.info(`Fetched key: ${namespacedKey} from Redis`);
				return redisValue;
			} else {
				this.updateMetrics(service, 'miss');
				this.logger.info(`Cache miss for key: ${namespacedKey}`);
			}
			return null;
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_GET_ERROR',
				{ key, service },
				`Error fetching key ${namespacedKey} from cache for service ${service}`
			);
			return null;
		}
	}
	async set(key, value, service, expirationInSeconds) {
		const namespacedKey = this.getNamespacedKey(service, key);
		try {
			const expiration = expirationInSeconds
				? Date.now() + Number(expirationInSeconds) * 1000
				: Date.now() + this.getServiceTTL(service) * 1000;
			let serviceMemoryCache = this.memoryCache.get(service);
			if (!serviceMemoryCache) {
				serviceMemoryCache = new Map();
				this.memoryCache.set(service, serviceMemoryCache);
			}
			serviceMemoryCache.set(namespacedKey, { value, expiration });
			this.memoryCacheLRU.set(namespacedKey, Date.now());
			await this.redisService?.set(
				namespacedKey,
				value,
				Number(expirationInSeconds)
			);
			this.logger.info(
				`Key ${namespacedKey} set with TTL ${expirationInSeconds || this.getServiceTTL(service)} seconds in both memory and Redis cache`
			);
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_SET_ERROR',
				{ key, service, expirationInSeconds },
				`Error setting key ${namespacedKey} in cache for service ${service}`
			);
		}
	}
	async exists(key, service) {
		const namespacedKey = this.getNamespacedKey(service, key);
		try {
			const serviceMemoryCache = this.memoryCache.get(service);
			if (serviceMemoryCache?.has(namespacedKey)) {
				this.logger.info(
					`Key ${namespacedKey} exists in memory cache, checked by service ${service}`
				);
				this.updateMetrics(service, 'hit');
				return true;
			}
			const redisExists = await this.redisService?.exists(namespacedKey);
			if (redisExists) {
				this.logger.info(
					`Key ${namespacedKey} exists in Redis, checked by service ${service}`
				);
				this.updateMetrics(service, 'redisHit');
				return true;
			}
			this.logger.info(
				`Key ${namespacedKey} does not exist in memory or Redis, checked by service ${service}`
			);
			this.updateMetrics(service, 'miss');
			return false;
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_EXISTS_ERROR',
				{ key, service },
				`Error checking existence of key ${namespacedKey} for service ${service}`
			);
			return false;
		}
	}
	async del(key, service) {
		const namespacedKey = this.getNamespacedKey(service, key);
		try {
			const serviceMemoryCache = this.memoryCache.get(service);
			if (serviceMemoryCache) {
				serviceMemoryCache.delete(namespacedKey);
				this.logger.info(
					`Key ${namespacedKey} deleted from memory cache by service ${service}`
				);
			}
			await this.redisService?.del(namespacedKey);
			this.logger.info(
				`Key ${namespacedKey} deleted from Redis by service ${service}`
			);
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_DELETE_ERROR',
				{ key, service },
				`Error deleting key ${namespacedKey} from cache for service ${service}`
			);
		}
	}
	async increment(key, service, expirationInSeconds) {
		const namespacedKey = this.getNamespacedKey(service, key);
		try {
			let serviceMemoryCache = this.memoryCache.get(service);
			let newValue = null;
			if (serviceMemoryCache) {
				const memoryEntry = serviceMemoryCache.get(namespacedKey);
				if (memoryEntry && typeof memoryEntry.value === 'number') {
					memoryEntry.value += 1;
					newValue = memoryEntry.value;
					this.logger.info(
						`Memory cache incremented for key: ${namespacedKey} by service: ${service}`
					);
				}
			}
			if (!serviceMemoryCache || typeof newValue !== 'number') {
				newValue =
					(await this.redisService?.increment(
						namespacedKey,
						expirationInSeconds
					)) ?? null;
				if (newValue !== null) {
					const expiration = expirationInSeconds
						? Date.now() + expirationInSeconds * 1000
						: Date.now() + this.getServiceTTL(service) * 1000;
					if (!serviceMemoryCache) {
						serviceMemoryCache = new Map();
						this.memoryCache.set(service, serviceMemoryCache);
					}
					serviceMemoryCache.set(namespacedKey, {
						value: newValue,
						expiration
					});
					this.logger.info(
						`Fetched incremented value from Redis and added to memory cache for key: ${namespacedKey} by service: ${service}`
					);
				}
			}
			return newValue;
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_INCREMENT_ERROR',
				{
					reason: `Cache increment failed for key ${key}`,
					key: key || 'unknown',
					expiration: expirationInSeconds || 'unknown',
					service: service || 'unknown'
				},
				`Error incrementing key ${namespacedKey} in cache for service ${service}`
			);
			return null;
		}
	}
	async flushCache(service) {
		try {
			const serviceMemoryCache = this.memoryCache.get(service);
			if (serviceMemoryCache) {
				serviceMemoryCache.clear();
				this.memoryCache.delete(service);
				this.logger.info(
					`Memory cache flushed for service: ${service}`
				);
			}
			const serviceKeys = await this.redisService?.getKeysByPattern(
				`${service}:*`
			);
			if (typeof serviceKeys === 'undefined') {
				this.logger.warn(
					`Redis cache flush failed for service: ${service}`
				);
				return;
			}
			if (serviceKeys.length > 0) {
				await this.redisService?.delMultiple(service, serviceKeys);
				this.logger.info(`Redis cache flushed for service: ${service}`);
			}
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_FLUSH_ERROR',
				{
					reason: `Cache flush failed for service ${service}`,
					service: service || 'unknown'
				},
				`Error flushing cache for service ${service}`
			);
		}
	}
	cleanupExpiredEntries() {
		withRetry(
			() => {
				for (const [service, cache] of this.memoryCache.entries()) {
					for (const [key, { expiration }] of cache.entries()) {
						if (expiration && Date.now() > expiration) {
							cache.delete(key);
							this.logger.info(
								`Expired memory cache entry removed for key: ${key} from service: ${service}`
							);
						}
					}
				}
			},
			3,
			1000
		).catch(error => {
			this.logger.error(
				`Error cleaning up expired memory cache entries after retries: ${error}`
			);
		});
	}
	async clearNamespace(service) {
		try {
			const serviceMemoryCache = this.memoryCache.get(service);
			if (serviceMemoryCache) {
				serviceMemoryCache.clear();
				this.memoryCache.delete(service);
				this.logger.info(
					`Memory cache cleared for service: ${service}`
				);
			}
			const serviceKeys = await this.redisService?.getKeysByPattern(
				`${service}:*`
			);
			if (typeof serviceKeys === 'undefined') {
				this.logger.warn(
					`Redis cache clear failed for service: ${service}`
				);
				return;
			}
			if (serviceKeys.length > 0) {
				await this.redisService?.delMultiple(service, serviceKeys);
				this.logger.info(`Redis cache cleared for service: ${service}`);
			}
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_CLEAR_NAMESPACE_ERROR',
				{ service },
				`Error clearing cache for service ${service}`
			);
		}
	}
	async closeConnection() {
		try {
			await withRetry(
				async () => await this.redisService?.cleanUpRedisClient(),
				3,
				1000
			);
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_CLOSE_CONNECTION_ERROR',
				{
					reason: `Cache connection close failed`
				},
				`Error closing cache connection`
			);
		}
	}
	async shutdown() {
		try {
			this.logger.info(
				'Shutting down Redis connection before Cache Service...'
			);
			try {
				await this.redisService?.cleanUpRedisClient();
				this.logger.info('Redis connection closed successfully.');
			} catch (redisError) {
				this.logger.error(
					`Failed to shut down Redis connection: ${redisError instanceof Error ? redisError.message : redisError}`
				);
			}
			this.logger.info('Clearing memory cache in Cache Service...');
			this.memoryCache.clear();
			this.memoryCacheLRU.clear();
			this.logger.info('Memory cache cleared successfully.');
			this.redisService = null;
			this.logger.info('Cache service shutdown completed.');
		} catch (error) {
			this.handleCacheError(
				error,
				'CACHE_SHUTDOWN_ERROR',
				{},
				`Error shutting down Cache Service`
			);
		}
	}
	handleCacheError(error, errorHeader, errorDetails, customMessage) {
		const errorMessage = `${customMessage}: ${error}\n${error instanceof Error ? error.stack : ''}`;
		this.errorLogger.logError(errorMessage);
		const cacheError = new this.errorHandler.ErrorClasses.CacheServiceError(
			errorHeader,
			{
				details: errorDetails,
				exposeToClient: false
			}
		);
		this.errorHandler.handleError({
			error: cacheError
		});
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2FjaGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2VydmljZXMvQ2FjaGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBUUEsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUU3QyxNQUFNLE9BQU8sWUFBWTtJQUNoQixNQUFNLENBQUMsUUFBUSxHQUF3QixJQUFJLENBQUM7SUFFNUMsTUFBTSxDQUE0QjtJQUNsQyxXQUFXLENBQThCO0lBQ3pDLFlBQVksQ0FBK0I7SUFDM0MsWUFBWSxDQUErQjtJQUUzQyxXQUFXLEdBQUcsSUFBSSxHQUFHLEVBRzFCLENBQUM7SUFDSSxjQUFjLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUM7SUFDM0MsY0FBYyxHQU1sQixFQUFFLENBQUM7SUFFUCxZQUNDLE1BQWlDLEVBQ2pDLFdBQXdDLEVBQ3hDLFlBQTBDLEVBQzFDLFlBQW1DO1FBRW5DLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQy9CLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO0lBQ2xDLENBQUM7SUFFTSxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVc7UUFDOUIsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUM1QixZQUFZLENBQUMsUUFBUSxHQUFHLElBQUksWUFBWSxDQUN2QyxNQUFNLGNBQWMsQ0FBQyxnQkFBZ0IsRUFBRSxFQUN2QyxNQUFNLGNBQWMsQ0FBQyxxQkFBcUIsRUFBRSxFQUM1QyxNQUFNLGNBQWMsQ0FBQyxzQkFBc0IsRUFBRSxFQUM3QyxNQUFNLGNBQWMsQ0FB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LENBQUMsRUFBRSxFQUFFLENBQUM7UUFDaEcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFeEMsTUFBTSxVQUFVLEdBQUcsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxpQkFBaUIsQ0FDdEUsV0FBVyxFQUNYO1lBQ0MsT0FBTyxFQUFFLFlBQVk7WUFDckIsY0FBYyxFQUFFLEtBQUs7U0FDckIsQ0FDRCxDQUFDO1FBRUYsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUM7WUFDN0IsS0FBSyxFQUFFLFVBQVU7U0FDakIsQ0FBQyxDQUFDO0lBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG5cdEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdENhY2hlU2VydmljZUludGVyZmFjZSxcblx0RXJyb3JIYW5kbGVyU2VydmljZUludGVyZmFjZSxcblx0RXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRSZWRpc1NlcnZpY2VJbnRlcmZhY2Vcbn0gZnJvbSAnLi4vaW5kZXgvaW50ZXJmYWNlcy9zZXJ2aWNlcyc7XG5pbXBvcnQgeyBDYWNoZU1ldHJpY3MgfSBmcm9tICcuLi9pbmRleC9pbnRlcmZhY2VzL3NlcnZpY2VDb21wb25lbnRzJztcbmltcG9ydCB7IFNlcnZpY2VGYWN0b3J5IH0gZnJvbSAnLi4vaW5kZXgvZmFjdG9yeSc7XG5pbXBvcnQgeyBzZXJ2aWNlVFRMQ29uZmlnIH0gZnJvbSAnLi4vY29uZmlnL2NhY2hlJztcbmltcG9ydCB7IHdpdGhSZXRyeSB9IGZyb20gJy4uL3V0aWxzL2hlbHBlcnMnO1xuXG5leHBvcnQgY2xhc3MgQ2FjaGVTZXJ2aWNlIGltcGxlbWVudHMgQ2FjaGVTZXJ2aWNlSW50ZXJmYWNlIHtcblx0cHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IENhY2hlU2VydmljZSB8IG51bGwgPSBudWxsO1xuXG5cdHByaXZhdGUgbG9nZ2VyOiBBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIGVycm9yTG9nZ2VyOiBFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZXJyb3JIYW5kbGVyOiBFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIHJlZGlzU2VydmljZTogUmVkaXNTZXJ2aWNlSW50ZXJmYWNlIHwgbnVsbDtcblxuXHRwcml2YXRlIG1lbW9yeUNhY2hlID0gbmV3IE1hcDxcblx0XHRzdHJpbmcsXG5cdFx0TWFwPHN0cmluZywgeyB2YWx1ZTogdW5rbm93bjsgZXhwaXJhdGlvbjogbnVtYmVyIHwgdW5kZWZpbmVkIH0+XG5cdD4oKTtcblx0cHJpdmF0ZSBtZW1vcnlDYWNoZUxSVSA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XG5cdHByaXZhdGUgc2VydmljZU1ldHJpY3M6IHtcblx0XHRbc2VydmljZTogc3RyaW5nXToge1xuXHRcdFx0Y2FjaGVIaXRzOiBudW1iZXI7XG5cdFx0XHRjYWNoZU1pc3NlczogbnVtYmVyO1xuXHRcdFx0cmVkaXNIaXRzOiBudW1iZXI7XG5cdFx0fTtcblx0fSA9IHt9O1xuXG5cdHByaXZhdGUgY29uc3RydWN0b3IoXG5cdFx0bG9nZ2VyOiBBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGVycm9yTG9nZ2VyOiBFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0ZXJyb3JIYW5kbGVyOiBFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdHJlZGlzU2VydmljZTogUmVkaXNTZXJ2aWNlSW50ZXJmYWNlXG5cdCkge1xuXHRcdHRoaXMubG9nZ2VyID0gbG9nZ2VyO1xuXHRcdHRoaXMuZXJyb3JMb2dnZXIgPSBlcnJvckxvZ2dlcjtcblx0XHR0aGlzLmVycm9ySGFuZGxlciA9IGVycm9ySGFuZGxlcjtcblx0XHR0aGlzLnJlZGlzU2VydmljZSA9IHJlZGlzU2VydmljZTtcblx0fVxuXG5cdHB1YmxpYyBzdGF0aWMgYXN5bmMgZ2V0SW5zdGFuY2UoKTogUHJvbWlzZTxDYWNoZVNlcnZpY2U+IHtcblx0XHRpZiAoIUNhY2hlU2VydmljZS5pbnN0YW5jZSkge1xuXHRcdFx0Q2FjaGVTZXJ2aWNlLmluc3RhbmNlID0gbmV3IENhY2hlU2VydmljZShcblx0XHRcdFx0YXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0TG9nZ2VyU2VydmljZSgpLFxuXHRcdFx0XHRhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRFcnJvckxvZ2dlclNlcnZpY2UoKSxcblx0XHRcdFx0YXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0RXJyb3JIYW5kbGVyU2VydmljZSgpLFxuXHRcdFx0XHRhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRSZWRpc1NlcnZpY2UoKVxuXHRcdFx0KTtcblx0XHR9XG5cblx0XHRyZXR1cm4gQ2FjaGVTZXJ2aWNlLmluc3RhbmNlO1xuXHR9XG5cblx0cHJpdmF0ZSBnZXRTZXJ2aWNlVFRMKHNlcnZpY2U6IHN0cmluZyk6IG51bWJlciB7XG5cdFx0cmV0dXJuIHNlcnZpY2VUVExDb25maWdbc2VydmljZV0gfHwgc2VydmljZVRUTENvbmZpZ1snZGVmYXVsdCddO1xuXHR9XG5cblx0cHJpdmF0ZSBnZXROYW1lc3BhY2VkS2V5KHNlcnZpY2U6IHN0cmluZywga2V5OiBzdHJpbmcpOiBzdHJpbmcge1xuXHRcdHJldHVybiBgJHtzZXJ2aWNlfToke2tleX1gO1xuXHR9XG5cblx0cHJpdmF0ZSB1cGRhdGVNZXRyaWNzKFxuXHRcdHNlcnZpY2U6IHN0cmluZyxcblx0XHR0eXBlOiAnaGl0JyB8ICdtaXNzJyB8ICdyZWRpc0hpdCdcblx0KTogdm9pZCB7XG5cdFx0aWYgKCF0aGlzLnNlcnZpY2VNZXRyaWNzW3NlcnZpY2VdKSB7XG5cdFx0XHR0aGlzLnNlcnZpY2VNZXRyaWNzW3NlcnZpY2VdID0ge1xuXHRcdFx0XHRjYWNoZUhpdHM6IDAsXG5cdFx0XHRcdGNhY2hlTWlzc2VzOiAwLFxuXHRcdFx0XHRyZWRpc0hpdHM6IDBcblx0XHRcdH07XG5cdFx0fVxuXG5cdFx0aWYgKHR5cGUgPT09ICdoaXQnKSB7XG5cdFx0XHR0aGlzLnNlcnZpY2VNZXRyaWNzW3NlcnZpY2VdLmNhY2hlSGl0cysrO1xuXHRcdH0gZWxzZSBpZiAodHlwZSA9PT0gJ21pc3MnKSB7XG5cdFx0XHR0aGlzLnNlcnZpY2VNZXRyaWNzW3NlcnZpY2VdLmNhY2hlTWlzc2VzKys7XG5cdFx0fSBlbHNlIGlmICh0eXBlID09PSAncmVkaXNIaXQnKSB7XG5cdFx0XHR0aGlzLnNlcnZpY2VNZXRyaWNzW3NlcnZpY2VdLnJlZGlzSGl0cysrO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBnZXRDYWNoZU1ldHJpY3Moc2VydmljZTogc3RyaW5nKTogQ2FjaGVNZXRyaWNzIHtcblx0XHRyZXR1cm4gKFxuXHRcdFx0dGhpcy5zZXJ2aWNlTWV0cmljc1tzZXJ2aWNlXSB8fCB7XG5cdFx0XHRcdGNhY2hlSGl0czogMCxcblx0XHRcdFx0Y2FjaGVNaXNzZXM6IDAsXG5cdFx0XHRcdHJlZGlzSGl0czogMFxuXHRcdFx0fVxuXHRcdCk7XG5cdH1cblxuXHRwdWJsaWMgZ2V0TWVtb3J5Q2FjaGUoXG5cdFx0c2VydmljZTogc3RyaW5nXG5cdCk6IE1hcDxzdHJpbmcsIHsgdmFsdWU6IHVua25vd247IGV4cGlyYXRpb246IG51bWJlciB8IHVuZGVmaW5lZCB9PiB8IG51bGwge1xuXHRcdHJldHVybiB0aGlzLm1lbW9yeUNhY2hlLmdldChzZXJ2aWNlKSB8fCBudWxsO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIGdldDxUPihrZXk6IHN0cmluZywgc2VydmljZTogc3RyaW5nKTogUHJvbWlzZTxUIHwgbnVsbD4ge1xuXHRcdGNvbnN0IG5hbWVzcGFjZWRLZXkgPSB0aGlzLmdldE5hbWVzcGFjZWRLZXkoc2VydmljZSwga2V5KTtcblxuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCBzZXJ2aWNlTWVtb3J5Q2FjaGUgPSB0aGlzLm1lbW9yeUNhY2hlLmdldChzZXJ2aWNlKTtcblx0XHRcdGlmIChzZXJ2aWNlTWVtb3J5Q2FjaGUpIHtcblx0XHRcdFx0Y29uc3QgbWVtb3J5RW50cnkgPSBzZXJ2aWNlTWVtb3J5Q2FjaGUuZ2V0KG5hbWVzcGFjZWRLZXkpO1xuXHRcdFx0XHRpZiAobWVtb3J5RW50cnkpIHtcblx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRtZW1vcnlFbnRyeS5leHBpcmF0aW9uICYmXG5cdFx0XHRcdFx0XHREYXRlLm5vdygpID4gbWVtb3J5RW50cnkuZXhwaXJhdGlvblxuXHRcdFx0XHRcdCkge1xuXHRcdFx0XHRcdFx0c2VydmljZU1lbW9yeUNhY2hlLmRlbGV0ZShuYW1lc3BhY2VkS2V5KTtcblx0XHRcdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0XHRcdGBNZW1vcnkgY2FjaGUgZXhwaXJlZCBmb3Iga2V5OiAke25hbWVzcGFjZWRLZXl9YFxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0dGhpcy5tZW1vcnlDYWNoZUxSVS5zZXQobmFtZXNwYWNlZEtleSwgRGF0ZS5ub3coKSk7XG5cdFx0XHRcdFx0XHR0aGlzLnVwZGF0ZU1ldHJpY3Moc2VydmljZSwgJ2hpdCcpO1xuXHRcdFx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0XHRcdFx0YE1lbW9yeSBjYWNoZSBoaXQgZm9yIGtleTogJHtuYW1lc3BhY2VkS2V5fWBcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRyZXR1cm4gbWVtb3J5RW50cnkudmFsdWUgYXMgVDtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgcmVkaXNWYWx1ZSA9XG5cdFx0XHRcdChhd2FpdCB0aGlzLnJlZGlzU2VydmljZT8uZ2V0PFQ+KG5hbWVzcGFjZWRLZXkpKSA/PyBudWxsO1xuXHRcdFx0aWYgKHJlZGlzVmFsdWUgIT09IG51bGwpIHtcblx0XHRcdFx0Y29uc3QgZGVmYXVsdEV4cGlyYXRpb24gPVxuXHRcdFx0XHRcdERhdGUubm93KCkgKyB0aGlzLmdldFNlcnZpY2VUVEwoc2VydmljZSkgKiAxMDAwO1xuXHRcdFx0XHRpZiAoIXNlcnZpY2VNZW1vcnlDYWNoZSkge1xuXHRcdFx0XHRcdHRoaXMubWVtb3J5Q2FjaGUuc2V0KHNlcnZpY2UsIG5ldyBNYXAoKSk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHR0aGlzLm1lbW9yeUNhY2hlLmdldChzZXJ2aWNlKT8uc2V0KG5hbWVzcGFjZWRLZXksIHtcblx0XHRcdFx0XHR2YWx1ZTogcmVkaXNWYWx1ZSxcblx0XHRcdFx0XHRleHBpcmF0aW9uOiBkZWZhdWx0RXhwaXJhdGlvblxuXHRcdFx0XHR9KTtcblx0XHRcdFx0dGhpcy5tZW1vcnlDYWNoZUxSVS5zZXQobmFtZXNwYWNlZEtleSwgRGF0ZS5ub3coKSk7XG5cblx0XHRcdFx0dGhpcy51cGRhdGVNZXRyaWNzKHNlcnZpY2UsICdyZWRpc0hpdCcpO1xuXHRcdFx0XHR0aGlzLmxvZ2dlci5pbmZvKGBGZXRjaGVkIGtleTogJHtuYW1lc3BhY2VkS2V5fSBmcm9tIFJlZGlzYCk7XG5cdFx0XHRcdHJldHVybiByZWRpc1ZhbHVlO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhpcy51cGRhdGVNZXRyaWNzKHNlcnZpY2UsICdtaXNzJyk7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oYENhY2hlIG1pc3MgZm9yIGtleTogJHtuYW1lc3BhY2VkS2V5fWApO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gbnVsbDtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5oYW5kbGVDYWNoZUVycm9yKFxuXHRcdFx0XHRlcnJvcixcblx0XHRcdFx0J0NBQ0hFX0dFVF9FUlJPUicsXG5cdFx0XHRcdHsga2V5LCBzZXJ2aWNlIH0sXG5cdFx0XHRcdGBFcnJvciBmZXRjaGluZyBrZXkgJHtuYW1lc3BhY2VkS2V5fSBmcm9tIGNhY2hlIGZvciBzZXJ2aWNlICR7c2VydmljZX1gXG5cdFx0XHQpO1xuXHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIHNldDxUPihcblx0XHRrZXk6IHN0cmluZyxcblx0XHR2YWx1ZTogVCxcblx0XHRzZXJ2aWNlOiBzdHJpbmcsXG5cdFx0ZXhwaXJhdGlvbkluU2Vjb25kcz86IHN0cmluZyB8IG51bWJlclxuXHQpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRjb25zdCBuYW1lc3BhY2VkS2V5ID0gdGhpcy5nZXROYW1lc3BhY2VkS2V5KHNlcnZpY2UsIGtleSk7XG5cblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgZXhwaXJhdGlvbiA9IGV4cGlyYXRpb25JblNlY29uZHNcblx0XHRcdFx0PyBEYXRlLm5vdygpICsgTnVtYmVyKGV4cGlyYXRpb25JblNlY29uZHMpICogMTAwMFxuXHRcdFx0XHQ6IERhdGUubm93KCkgKyB0aGlzLmdldFNlcnZpY2VUVEwoc2VydmljZSkgKiAxMDAwO1xuXG5cdFx0XHRsZXQgc2VydmljZU1lbW9yeUNhY2hlID0gdGhpcy5tZW1vcnlDYWNoZS5nZXQoc2VydmljZSk7XG5cblx0XHRcdGlmICghc2VydmljZU1lbW9yeUNhY2hlKSB7XG5cdFx0XHRcdHNlcnZpY2VNZW1vcnlDYWNoZSA9IG5ldyBNYXAoKTtcblx0XHRcdFx0dGhpcy5tZW1vcnlDYWNoZS5zZXQoc2VydmljZSwgc2VydmljZU1lbW9yeUNhY2hlKTtcblx0XHRcdH1cblxuXHRcdFx0c2VydmljZU1lbW9yeUNhY2hlLnNldChuYW1lc3BhY2VkS2V5LCB7IHZhbHVlLCBleHBpcmF0aW9uIH0pO1xuXHRcdFx0dGhpcy5tZW1vcnlDYWNoZUxSVS5zZXQobmFtZXNwYWNlZEtleSwgRGF0ZS5ub3coKSk7XG5cblx0XHRcdGF3YWl0IHRoaXMucmVkaXNTZXJ2aWNlPy5zZXQoXG5cdFx0XHRcdG5hbWVzcGFjZWRLZXksXG5cdFx0XHRcdHZhbHVlLFxuXHRcdFx0XHROdW1iZXIoZXhwaXJhdGlvbkluU2Vjb25kcylcblx0XHRcdCk7XG5cblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdGBLZXkgJHtuYW1lc3BhY2VkS2V5fSBzZXQgd2l0aCBUVEwgJHtcblx0XHRcdFx0XHRleHBpcmF0aW9uSW5TZWNvbmRzIHx8IHRoaXMuZ2V0U2VydmljZVRUTChzZXJ2aWNlKVxuXHRcdFx0XHR9IHNlY29uZHMgaW4gYm90aCBtZW1vcnkgYW5kIFJlZGlzIGNhY2hlYFxuXHRcdFx0KTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5oYW5kbGVDYWNoZUVycm9yKFxuXHRcdFx0XHRlcnJvcixcblx0XHRcdFx0J0NBQ0hFX1NFVF9FUlJPUicsXG5cdFx0XHRcdHsga2V5LCBzZXJ2aWNlLCBleHBpcmF0aW9uSW5TZWNvbmRzIH0sXG5cdFx0XHRcdGBFcnJvciBzZXR0aW5nIGtleSAke25hbWVzcGFjZWRLZXl9IGluIGNhY2hlIGZvciBzZXJ2aWNlICR7c2VydmljZX1gXG5cdFx0XHQpO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBleGlzdHMoa2V5OiBzdHJpbmcsIHNlcnZpY2U6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuXHRcdGNvbnN0IG5hbWVzcGFjZWRLZXkgPSB0aGlzLmdldE5hbWVzcGFjZWRLZXkoc2VydmljZSwga2V5KTtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3Qgc2VydmljZU1lbW9yeUNhY2hlID0gdGhpcy5tZW1vcnlDYWNoZS5nZXQoc2VydmljZSk7XG5cdFx0XHRpZiAoc2VydmljZU1lbW9yeUNhY2hlPy5oYXMobmFtZXNwYWNlZEtleSkpIHtcblx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0XHRgS2V5ICR7bmFtZXNwYWNlZEtleX0gZXhpc3RzIGluIG1lbW9yeSBjYWNoZSwgY2hlY2tlZCBieSBzZXJ2aWNlICR7c2VydmljZX1gXG5cdFx0XHRcdCk7XG5cdFx0XHRcdHRoaXMudXBkYXRlTWV0cmljcyhzZXJ2aWNlLCAnaGl0Jyk7XG5cdFx0XHRcdHJldHVybiB0cnVlO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCByZWRpc0V4aXN0cyA9IGF3YWl0IHRoaXMucmVkaXNTZXJ2aWNlPy5leGlzdHMobmFtZXNwYWNlZEtleSk7XG5cdFx0XHRpZiAocmVkaXNFeGlzdHMpIHtcblx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0XHRgS2V5ICR7bmFtZXNwYWNlZEtleX0gZXhpc3RzIGluIFJlZGlzLCBjaGVja2VkIGJ5IHNlcnZpY2UgJHtzZXJ2aWNlfWBcblx0XHRcdFx0KTtcblx0XHRcdFx0dGhpcy51cGRhdGVNZXRyaWNzKHNlcnZpY2UsICdyZWRpc0hpdCcpO1xuXHRcdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHRcdH1cblxuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0YEtleSAke25hbWVzcGFjZWRLZXl9IGRvZXMgbm90IGV4aXN0IGluIG1lbW9yeSBvciBSZWRpcywgY2hlY2tlZCBieSBzZXJ2aWNlICR7c2VydmljZX1gXG5cdFx0XHQpO1xuXHRcdFx0dGhpcy51cGRhdGVNZXRyaWNzKHNlcnZpY2UsICdtaXNzJyk7XG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlQ2FjaGVFcnJvcihcblx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdCdDQUNIRV9FWElTVFNfRVJST1InLFxuXHRcdFx0XHR7IGtleSwgc2VydmljZSB9LFxuXHRcdFx0XHRgRXJyb3IgY2hlY2tpbmcgZXhpc3RlbmNlIG9mIGtleSAke25hbWVzcGFjZWRLZXl9IGZvciBzZXJ2aWNlICR7c2VydmljZX1gXG5cdFx0XHQpO1xuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBkZWwoa2V5OiBzdHJpbmcsIHNlcnZpY2U6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGNvbnN0IG5hbWVzcGFjZWRLZXkgPSB0aGlzLmdldE5hbWVzcGFjZWRLZXkoc2VydmljZSwga2V5KTtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3Qgc2VydmljZU1lbW9yeUNhY2hlID0gdGhpcy5tZW1vcnlDYWNoZS5nZXQoc2VydmljZSk7XG5cdFx0XHRpZiAoc2VydmljZU1lbW9yeUNhY2hlKSB7XG5cdFx0XHRcdHNlcnZpY2VNZW1vcnlDYWNoZS5kZWxldGUobmFtZXNwYWNlZEtleSk7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0YEtleSAke25hbWVzcGFjZWRLZXl9IGRlbGV0ZWQgZnJvbSBtZW1vcnkgY2FjaGUgYnkgc2VydmljZSAke3NlcnZpY2V9YFxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXG5cdFx0XHRhd2FpdCB0aGlzLnJlZGlzU2VydmljZT8uZGVsKG5hbWVzcGFjZWRLZXkpO1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0YEtleSAke25hbWVzcGFjZWRLZXl9IGRlbGV0ZWQgZnJvbSBSZWRpcyBieSBzZXJ2aWNlICR7c2VydmljZX1gXG5cdFx0XHQpO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmhhbmRsZUNhY2hlRXJyb3IoXG5cdFx0XHRcdGVycm9yLFxuXHRcdFx0XHQnQ0FDSEVfREVMRVRFX0VSUk9SJyxcblx0XHRcdFx0eyBrZXksIHNlcnZpY2UgfSxcblx0XHRcdFx0YEVycm9yIGRlbGV0aW5nIGtleSAke25hbWVzcGFjZWRLZXl9IGZyb20gY2FjaGUgZm9yIHNlcnZpY2UgJHtzZXJ2aWNlfWBcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIGluY3JlbWVudChcblx0XHRrZXk6IHN0cmluZyxcblx0XHRzZXJ2aWNlOiBzdHJpbmcsXG5cdFx0ZXhwaXJhdGlvbkluU2Vjb25kcz86IG51bWJlclxuXHQpOiBQcm9taXNlPG51bWJlciB8IG51bGw+IHtcblx0XHRjb25zdCBuYW1lc3BhY2VkS2V5ID0gdGhpcy5nZXROYW1lc3BhY2VkS2V5KHNlcnZpY2UsIGtleSk7XG5cblx0XHR0cnkge1xuXHRcdFx0bGV0IHNlcnZpY2VNZW1vcnlDYWNoZSA9IHRoaXMubWVtb3J5Q2FjaGUuZ2V0KHNlcnZpY2UpO1xuXHRcdFx0bGV0IG5ld1ZhbHVlOiBudW1iZXIgfCBudWxsID0gbnVsbDtcblxuXHRcdFx0aWYgKHNlcnZpY2VNZW1vcnlDYWNoZSkge1xuXHRcdFx0XHRjb25zdCBtZW1vcnlFbnRyeSA9IHNlcnZpY2VNZW1vcnlDYWNoZS5nZXQobmFtZXNwYWNlZEtleSk7XG5cdFx0XHRcdGlmIChtZW1vcnlFbnRyeSAmJiB0eXBlb2YgbWVtb3J5RW50cnkudmFsdWUgPT09ICdudW1iZXInKSB7XG5cdFx0XHRcdFx0bWVtb3J5RW50cnkudmFsdWUgKz0gMTtcblx0XHRcdFx0XHRuZXdWYWx1ZSA9IG1lbW9yeUVudHJ5LnZhbHVlO1xuXHRcdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0XHRgTWVtb3J5IGNhY2hlIGluY3JlbWVudGVkIGZvciBrZXk6ICR7bmFtZXNwYWNlZEtleX0gYnkgc2VydmljZTogJHtzZXJ2aWNlfWBcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdGlmICghc2VydmljZU1lbW9yeUNhY2hlIHx8IHR5cGVvZiBuZXdWYWx1ZSAhPT0gJ251bWJlcicpIHtcblx0XHRcdFx0bmV3VmFsdWUgPVxuXHRcdFx0XHRcdChhd2FpdCB0aGlzLnJlZGlzU2VydmljZT8uaW5jcmVtZW50KFxuXHRcdFx0XHRcdFx0bmFtZXNwYWNlZEtleSxcblx0XHRcdFx0XHRcdGV4cGlyYXRpb25JblNlY29uZHNcblx0XHRcdFx0XHQpKSA/PyBudWxsO1xuXHRcdFx0XHRpZiAobmV3VmFsdWUgIT09IG51bGwpIHtcblx0XHRcdFx0XHRjb25zdCBleHBpcmF0aW9uID0gZXhwaXJhdGlvbkluU2Vjb25kc1xuXHRcdFx0XHRcdFx0PyBEYXRlLm5vdygpICsgZXhwaXJhdGlvbkluU2Vjb25kcyAqIDEwMDBcblx0XHRcdFx0XHRcdDogRGF0ZS5ub3coKSArIHRoaXMuZ2V0U2VydmljZVRUTChzZXJ2aWNlKSAqIDEwMDA7XG5cblx0XHRcdFx0XHRpZiAoIXNlcnZpY2VNZW1vcnlDYWNoZSkge1xuXHRcdFx0XHRcdFx0c2VydmljZU1lbW9yeUNhY2hlID0gbmV3IE1hcCgpO1xuXHRcdFx0XHRcdFx0dGhpcy5tZW1vcnlDYWNoZS5zZXQoc2VydmljZSwgc2VydmljZU1lbW9yeUNhY2hlKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0c2VydmljZU1lbW9yeUNhY2hlLnNldChuYW1lc3BhY2VkS2V5LCB7XG5cdFx0XHRcdFx0XHR2YWx1ZTogbmV3VmFsdWUsXG5cdFx0XHRcdFx0XHRleHBpcmF0aW9uXG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0XHRcdGBGZXRjaGVkIGluY3JlbWVudGVkIHZhbHVlIGZyb20gUmVkaXMgYW5kIGFkZGVkIHRvIG1lbW9yeSBjYWNoZSBmb3Iga2V5OiAke25hbWVzcGFjZWRLZXl9IGJ5IHNlcnZpY2U6ICR7c2VydmljZX1gXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gbmV3VmFsdWU7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlQ2FjaGVFcnJvcihcblx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdCdDQUNIRV9JTkNSRU1FTlRfRVJST1InLFxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmVhc29uOiBgQ2FjaGUgaW5jcmVtZW50IGZhaWxlZCBmb3Iga2V5ICR7a2V5fWAsXG5cdFx0XHRcdFx0a2V5OiBrZXkgfHwgJ3Vua25vd24nLFxuXHRcdFx0XHRcdGV4cGlyYXRpb246IGV4cGlyYXRpb25JblNlY29uZHMgfHwgJ3Vua25vd24nLFxuXHRcdFx0XHRcdHNlcnZpY2U6IHNlcnZpY2UgfHwgJ3Vua25vd24nXG5cdFx0XHRcdH0sXG5cdFx0XHRcdGBFcnJvciBpbmNyZW1lbnRpbmcga2V5ICR7bmFtZXNwYWNlZEtleX0gaW4gY2FjaGUgZm9yIHNlcnZpY2UgJHtzZXJ2aWNlfWBcblx0XHRcdCk7XG5cdFx0XHRyZXR1cm4gbnVsbDtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgZmx1c2hDYWNoZShzZXJ2aWNlOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3Qgc2VydmljZU1lbW9yeUNhY2hlID0gdGhpcy5tZW1vcnlDYWNoZS5nZXQoc2VydmljZSk7XG5cdFx0XHRpZiAoc2VydmljZU1lbW9yeUNhY2hlKSB7XG5cdFx0XHRcdHNlcnZpY2VNZW1vcnlDYWNoZS5jbGVhcigpO1xuXHRcdFx0XHR0aGlzLm1lbW9yeUNhY2hlLmRlbGV0ZShzZXJ2aWNlKTtcblx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0XHRgTWVtb3J5IGNhY2hlIGZsdXNoZWQgZm9yIHNlcnZpY2U6ICR7c2VydmljZX1gXG5cdFx0XHRcdCk7XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IHNlcnZpY2VLZXlzID0gYXdhaXQgdGhpcy5yZWRpc1NlcnZpY2U/LmdldEtleXNCeVBhdHRlcm4oXG5cdFx0XHRcdGAke3NlcnZpY2V9OipgXG5cdFx0XHQpO1xuXG5cdFx0XHRpZiAodHlwZW9mIHNlcnZpY2VLZXlzID09PSAndW5kZWZpbmVkJykge1xuXHRcdFx0XHR0aGlzLmxvZ2dlci53YXJuKFxuXHRcdFx0XHRcdGBSZWRpcyBjYWNoZSBmbHVzaCBmYWlsZWQgZm9yIHNlcnZpY2U6ICR7c2VydmljZX1gXG5cdFx0XHRcdCk7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblx0XHRcdGlmIChzZXJ2aWNlS2V5cy5sZW5ndGggPiAwKSB7XG5cdFx0XHRcdGF3YWl0IHRoaXMucmVkaXNTZXJ2aWNlPy5kZWxNdWx0aXBsZShzZXJ2aWNlLCBzZXJ2aWNlS2V5cyk7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oYFJlZGlzIGNhY2hlIGZsdXNoZWQgZm9yIHNlcnZpY2U6ICR7c2VydmljZX1gKTtcblx0XHRcdH1cblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5oYW5kbGVDYWNoZUVycm9yKFxuXHRcdFx0XHRlcnJvcixcblx0XHRcdFx0J0NBQ0hFX0ZMVVNIX0VSUk9SJyxcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHJlYXNvbjogYENhY2hlIGZsdXNoIGZhaWxlZCBmb3Igc2VydmljZSAke3NlcnZpY2V9YCxcblx0XHRcdFx0XHRzZXJ2aWNlOiBzZXJ2aWNlIHx8ICd1bmtub3duJ1xuXHRcdFx0XHR9LFxuXHRcdFx0XHRgRXJyb3IgZmx1c2hpbmcgY2FjaGUgZm9yIHNlcnZpY2UgJHtzZXJ2aWNlfWBcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGNsZWFudXBFeHBpcmVkRW50cmllcygpOiB2b2lkIHtcblx0XHR3aXRoUmV0cnkoXG5cdFx0XHQoKSA9PiB7XG5cdFx0XHRcdGZvciAoY29uc3QgW3NlcnZpY2UsIGNhY2hlXSBvZiB0aGlzLm1lbW9yeUNhY2hlLmVudHJpZXMoKSkge1xuXHRcdFx0XHRcdGZvciAoY29uc3QgW2tleSwgeyBleHBpcmF0aW9uIH1dIG9mIGNhY2hlLmVudHJpZXMoKSkge1xuXHRcdFx0XHRcdFx0aWYgKGV4cGlyYXRpb24gJiYgRGF0ZS5ub3coKSA+IGV4cGlyYXRpb24pIHtcblx0XHRcdFx0XHRcdFx0Y2FjaGUuZGVsZXRlKGtleSk7XG5cdFx0XHRcdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0XHRcdFx0YEV4cGlyZWQgbWVtb3J5IGNhY2hlIGVudHJ5IHJlbW92ZWQgZm9yIGtleTogJHtrZXl9IGZyb20gc2VydmljZTogJHtzZXJ2aWNlfWBcblx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH0sXG5cdFx0XHQzLFxuXHRcdFx0MTAwMFxuXHRcdCkuY2F0Y2goZXJyb3IgPT4ge1xuXHRcdFx0dGhpcy5sb2dnZXIuZXJyb3IoXG5cdFx0XHRcdGBFcnJvciBjbGVhbmluZyB1cCBleHBpcmVkIG1lbW9yeSBjYWNoZSBlbnRyaWVzIGFmdGVyIHJldHJpZXM6ICR7ZXJyb3J9YFxuXHRcdFx0KTtcblx0XHR9KTtcblx0fVxuXG5cdHB1YmxpYyBhc3luYyBjbGVhck5hbWVzcGFjZShzZXJ2aWNlOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3Qgc2VydmljZU1lbW9yeUNhY2hlID0gdGhpcy5tZW1vcnlDYWNoZS5nZXQoc2VydmljZSk7XG5cblx0XHRcdGlmIChzZXJ2aWNlTWVtb3J5Q2FjaGUpIHtcblx0XHRcdFx0c2VydmljZU1lbW9yeUNhY2hlLmNsZWFyKCk7XG5cdFx0XHRcdHRoaXMubWVtb3J5Q2FjaGUuZGVsZXRlKHNlcnZpY2UpO1xuXHRcdFx0XHR0aGlzLmxvZ2dlci5pbmZvKFxuXHRcdFx0XHRcdGBNZW1vcnkgY2FjaGUgY2xlYXJlZCBmb3Igc2VydmljZTogJHtzZXJ2aWNlfWBcblx0XHRcdFx0KTtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3Qgc2VydmljZUtleXMgPSBhd2FpdCB0aGlzLnJlZGlzU2VydmljZT8uZ2V0S2V5c0J5UGF0dGVybihcblx0XHRcdFx0YCR7c2VydmljZX06KmBcblx0XHRcdCk7XG5cblx0XHRcdGlmICh0eXBlb2Ygc2VydmljZUtleXMgPT09ICd1bmRlZmluZWQnKSB7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLndhcm4oXG5cdFx0XHRcdFx0YFJlZGlzIGNhY2hlIGNsZWFyIGZhaWxlZCBmb3Igc2VydmljZTogJHtzZXJ2aWNlfWBcblx0XHRcdFx0KTtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoc2VydmljZUtleXMubGVuZ3RoID4gMCkge1xuXHRcdFx0XHRhd2FpdCB0aGlzLnJlZGlzU2VydmljZT8uZGVsTXVsdGlwbGUoc2VydmljZSwgc2VydmljZUtleXMpO1xuXHRcdFx0XHR0aGlzLmxvZ2dlci5pbmZvKGBSZWRpcyBjYWNoZSBjbGVhcmVkIGZvciBzZXJ2aWNlOiAke3NlcnZpY2V9YCk7XG5cdFx0XHR9XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlQ2FjaGVFcnJvcihcblx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdCdDQUNIRV9DTEVBUl9OQU1FU1BBQ0VfRVJST1InLFxuXHRcdFx0XHR7IHNlcnZpY2UgfSxcblx0XHRcdFx0YEVycm9yIGNsZWFyaW5nIGNhY2hlIGZvciBzZXJ2aWNlICR7c2VydmljZX1gXG5cdFx0XHQpO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBjbG9zZUNvbm5lY3Rpb24oKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGF3YWl0IHdpdGhSZXRyeShcblx0XHRcdFx0YXN5bmMgKCkgPT4gYXdhaXQgdGhpcy5yZWRpc1NlcnZpY2U/LmNsZWFuVXBSZWRpc0NsaWVudCgpLFxuXHRcdFx0XHQzLFxuXHRcdFx0XHQxMDAwXG5cdFx0XHQpO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmhhbmRsZUNhY2hlRXJyb3IoXG5cdFx0XHRcdGVycm9yLFxuXHRcdFx0XHQnQ0FDSEVfQ0xPU0VfQ09OTkVDVElPTl9FUlJPUicsXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRyZWFzb246IGBDYWNoZSBjb25uZWN0aW9uIGNsb3NlIGZhaWxlZGBcblx0XHRcdFx0fSxcblx0XHRcdFx0YEVycm9yIGNsb3NpbmcgY2FjaGUgY29ubmVjdGlvbmBcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIHNodXRkb3duKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdHRyeSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKFxuXHRcdFx0XHQnU2h1dHRpbmcgZG93biBSZWRpcyBjb25uZWN0aW9uIGJlZm9yZSBDYWNoZSBTZXJ2aWNlLi4uJ1xuXHRcdFx0KTtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdGF3YWl0IHRoaXMucmVkaXNTZXJ2aWNlPy5jbGVhblVwUmVkaXNDbGllbnQoKTtcblx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnUmVkaXMgY29ubmVjdGlvbiBjbG9zZWQgc3VjY2Vzc2Z1bGx5LicpO1xuXHRcdFx0fSBjYXRjaCAocmVkaXNFcnJvcikge1xuXHRcdFx0XHR0aGlzLmxvZ2dlci5lcnJvcihcblx0XHRcdFx0XHRgRmFpbGVkIHRvIHNodXQgZG93biBSZWRpcyBjb25uZWN0aW9uOiAke3JlZGlzRXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IHJlZGlzRXJyb3IubWVzc2FnZSA6IHJlZGlzRXJyb3J9YFxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdDbGVhcmluZyBtZW1vcnkgY2FjaGUgaW4gQ2FjaGUgU2VydmljZS4uLicpO1xuXG5cdFx0XHR0aGlzLm1lbW9yeUNhY2hlLmNsZWFyKCk7XG5cdFx0XHR0aGlzLm1lbW9yeUNhY2hlTFJVLmNsZWFyKCk7XG5cblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ01lbW9yeSBjYWNoZSBjbGVhcmVkIHN1Y2Nlc3NmdWxseS4nKTtcblxuXHRcdFx0dGhpcy5yZWRpc1NlcnZpY2UgPSBudWxsO1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnQ2FjaGUgc2VydmljZSBzaHV0ZG93biBjb21wbGV0ZWQuJyk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlQ2FjaGVFcnJvcihcblx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdCdDQUNIRV9TSFVURE9XTl9FUlJPUicsXG5cdFx0XHRcdHt9LFxuXHRcdFx0XHRgRXJyb3Igc2h1dHRpbmcgZG93biBDYWNoZSBTZXJ2aWNlYFxuXHRcdFx0KTtcblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIGhhbmRsZUNhY2hlRXJyb3IoXG5cdFx0ZXJyb3I6IHVua25vd24sXG5cdFx0ZXJyb3JIZWFkZXI6IHN0cmluZyxcblx0XHRlcnJvckRldGFpbHM6IG9iamVjdCxcblx0XHRjdXN0b21NZXNzYWdlOiBzdHJpbmdcblx0KTogdm9pZCB7XG5cdFx0Y29uc3QgZXJyb3JNZXNzYWdlID0gYCR7Y3VzdG9tTWVzc2FnZX06ICR7ZXJyb3J9XFxuJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3Iuc3RhY2sgOiAnJ31gO1xuXHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nRXJyb3IoZXJyb3JNZXNzYWdlKTtcblxuXHRcdGNvbnN0IGNhY2hlRXJyb3IgPSBuZXcgdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JDbGFzc2VzLkNhY2hlU2VydmljZUVycm9yKFxuXHRcdFx0ZXJyb3JIZWFkZXIsXG5cdFx0XHR7XG5cdFx0XHRcdGRldGFpbHM6IGVycm9yRGV0YWlscyxcblx0XHRcdFx0ZXhwb3NlVG9DbGllbnQ6IGZhbHNlXG5cdFx0XHR9XG5cdFx0KTtcblxuXHRcdHRoaXMuZXJyb3JIYW5kbGVyLmhhbmRsZUVycm9yKHtcblx0XHRcdGVycm9yOiBjYWNoZUVycm9yXG5cdFx0fSk7XG5cdH1cbn1cbiJdfQ==
