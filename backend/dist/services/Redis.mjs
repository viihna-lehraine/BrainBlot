import { LoggerServiceFactory } from '../index/factory/subfactories/LoggerServiceFactory.mjs';
import { ErrorHandlerServiceFactory } from '../index/factory/subfactories/ErrorHandlerServiceFactory.mjs';
import { EnvConfigServiceFactory } from '../index/factory/subfactories/EnvConfigServiceFactory.mjs';
export class RedisService {
	createRedisClient;
	static instance = null;
	logger;
	errorLogger;
	errorHandler;
	envConfig;
	redisClient = null;
	constructor(
		createRedisClient,
		logger,
		errorLogger,
		errorHandler,
		envConfig
	) {
		this.createRedisClient = createRedisClient;
		this.logger = logger;
		this.errorLogger = errorLogger;
		this.errorHandler = errorHandler;
		this.envConfig = envConfig;
	}
	static async getInstance(deps) {
		if (!RedisService.instance) {
			RedisService.instance = new RedisService(
				deps.createRedisClient,
				await LoggerServiceFactory.getLoggerService(),
				await LoggerServiceFactory.getErrorLoggerService(),
				await ErrorHandlerServiceFactory.getErrorHandlerService(),
				await EnvConfigServiceFactory.getEnvConfigService()
			);
		}
		return RedisService.instance;
	}
	async connectRedisClient() {
		if (this.redisClient) return;
		try {
			this.redisClient = this.createRedisClient({
				url: this.envConfig.getEnvVariable('redisUrl'),
				socket: {
					reconnectStrategy: retries => {
						const retryAfter = Math.min(retries * 100, 3000);
						this.errorLogger.logWarn(
							`Error connecting to Redis, retrying in ${retryAfter}ms. Retries: ${retries}`
						);
						if (retries >= 10) {
							this.handleRedisFailure(retries);
						}
						return retryAfter;
					}
				}
			});
			this.redisClient.on('error', error => {
				this.errorLogger.logError(`Redis error: ${error}`);
			});
			await this.redisClient.connect();
			this.logger.info('Connected to Redis');
		} catch (error) {
			this.handleRedisError(
				error,
				'REDIS_CONNECTION_ERROR',
				{ reason: 'Failed to connect to Redis' },
				'Error connecting to Redis'
			);
		}
	}
	async getRedisClient() {
		try {
			await this.connectRedisClient();
			return this.redisClient;
		} catch (error) {
			this.handleRedisError(
				error,
				'REDIS_CLIENT_ERROR',
				{ reason: 'Failed to get Redis client' },
				'Error getting Redis client'
			);
			return null;
		}
	}
	async get(key) {
		await this.connectRedisClient();
		if (!this.redisClient) throw new Error('Redis client is not connected');
		try {
			const result = await this.redisClient.get(key);
			if (!result) {
				this.logger.info(`Key ${key} not found or expired in Redis`);
				return null;
			}
			return result ? JSON.parse(result) : null;
		} catch (error) {
			this.handleRedisError(
				error,
				'REDIS_GET_ERROR',
				{ reason: `Failed to get key` },
				`Error fetching key ${key} from Redis`
			);
			return null;
		}
	}
	async set(key, value, expiration) {
		await this.connectRedisClient();
		if (!this.redisClient) throw new Error('Redis client is not connected');
		try {
			const valueString = JSON.stringify(value);
			if (expiration) {
				await this.redisClient.set(key, valueString, {
					EX: expiration
				});
			} else {
				await this.redisClient.set(key, valueString);
			}
			this.logger.info(
				`Key ${key} set in Redis with expiration ${expiration ?? 'no expiration'}`
			);
		} catch (error) {
			this.handleRedisError(
				error,
				'REDIS_SET_ERROR',
				{ reason: `Failed to set key ${key}` },
				`Error setting key ${key} in Redis`
			);
		}
	}
	async del(key) {
		if (!this.redisClient) {
			throw new Error('Redis client is not connected');
		}
		try {
			await this.redisClient.del(key);
			this.logger.info(`Key ${key} deleted from Redis`);
		} catch (error) {
			this.handleRedisError(
				error,
				'REDIS_DEL_ERROR',
				{ reason: `Failed to delete key ${key}` },
				`Error deleting key ${key} from Redis`
			);
		}
	}
	async exists(key) {
		if (!this.redisClient) {
			throw new Error('Redis client is not connected');
		}
		try {
			const result = await this.redisClient.exists(key);
			return result > 0;
		} catch (error) {
			this.handleRedisError(
				error,
				'REDIS_EXISTS_ERROR',
				{ reason: `Failed to check existence of key ${key}` },
				`Error checking existence of key ${key} in Redis`
			);
			return false;
		}
	}
	async increment(key, expiration) {
		if (!this.redisClient) {
			throw new Error('Redis client is not connected');
		}
		try {
			const newValue = await this.redisClient.incr(key);
			if (expiration) {
				await this.redisClient.expire(key, expiration);
			}
			return newValue;
		} catch (error) {
			this.handleRedisError(
				error,
				'REDIS_INCREMENT_ERROR',
				{ reason: `Failed to increment key ${key}` },
				`Error incrementing key ${key} in Redis`
			);
			return null;
		}
	}
	async getKeysByPattern(pattern) {
		try {
			await this.connectRedisClient();
			if (!this.redisClient) {
				throw new Error('Redis client is not connected');
			}
			const keys = await this.redisClient.keys(pattern);
			this.logger.info(
				`Found ${keys.length} keys matching pattern: ${pattern}`
			);
			return keys;
		} catch (error) {
			this.handleRedisError(
				error,
				'REDIS_KEY_PATTERN_ERROR',
				{ reason: `Failed to get keys by pattern ${pattern}` },
				`Error fetching keys by pattern ${pattern} from Redis`
			);
			return [];
		}
	}
	async delMultiple(service, keys) {
		try {
			await this.connectRedisClient();
			if (!this.redisClient) {
				throw new Error('Redis client is not connected');
			}
			if (keys.length > 0) {
				const namespacedKeys = keys.map(key => `${service}:${key}`);
				await this.redisClient.del(namespacedKeys);
				this.logger.info(
					`Deleted ${keys.length} keys from Redis for service ${service}`
				);
			} else {
				this.logger.info(`No keys to delete for service ${service}`);
			}
		} catch (error) {
			this.handleRedisError(
				error,
				'REDIS_DEL_MULTIPLE_ERROR',
				{
					reason: `Failed to delete multiple keys for service ${service}`
				},
				`Error deleting multiple keys from Redis for service ${service}`
			);
		}
	}
	async flushCacheByService(service) {
		try {
			const servicePattern = `${service}:*`;
			const serviceKeys = await this.getKeysByPattern(servicePattern);
			if (serviceKeys.length > 0) {
				await this.delMultiple(service, serviceKeys);
				this.logger.info(`Flushed Redis cache for service ${service}`);
			} else {
				this.logger.info(
					`No keys found to flush for service ${service}`
				);
			}
		} catch (error) {
			this.handleRedisError(
				error,
				'REDIS_FLUSH_CACHE_BY_SERVICE_ERROR',
				{ service },
				`Error flushing Redis cache for service ${service}`
			);
		}
	}
	async flushRedisMemoryCache() {
		try {
			await this.connectRedisClient();
			if (this.redisClient) {
				try {
					await this.redisClient.flushAll();
					this.logger.info('Redis cache flushed successfully');
				} catch (error) {
					this.handleRedisError(
						error,
						'REDIS_FLUSH_ERROR',
						{ reason: 'Redis not connected' },
						'Error flushing Redis cache'
					);
				}
			} else {
				this.errorLogger.logWarn(
					'Redis client is not available for cache flush'
				);
			}
		} catch (error) {
			this.handleRedisError(
				error,
				'REDIS_FLUSH_ERROR',
				{ reason: 'Failed to flush Redis cache' },
				'Error flushing Redis cache'
			);
		}
	}
	async cleanUpRedisClient() {
		try {
			if (this.redisClient) {
				try {
					await this.redisClient.quit();
					this.logger.info('Redis client disconnected successfully');
					this.redisClient = null;
				} catch (error) {
					this.errorLogger.logError(
						`Error disconnecting Redis client: ${error}`
					);
				}
			}
		} catch (error) {
			this.handleRedisError(
				error,
				'REDIS_DISCONNECT_ERROR',
				{ reason: 'Failed to disconnect Redis client' },
				'Error disconnecting Redis client'
			);
		}
	}
	async getRedisInfo() {
		try {
			await this.connectRedisClient();
			if (!this.redisClient) {
				throw new Error('Redis client is not connected');
			}
			const info = await this.redisClient.info();
			const parsedInfo = this.parseRedisInfo(info);
			this.logger.info(`Redis metrics: ${JSON.stringify(parsedInfo)}`);
			return parsedInfo;
		} catch (error) {
			this.handleRedisError(
				error,
				'REDIS_METRICS_RETRIEVAL_ERROR',
				{ reason: 'Failed to retrieve Redis metrics' },
				`Error retrieving Redis metrics`
			);
			throw new Error('Error retrieving Redis metrics');
		}
	}
	parseRedisInfo(info) {
		const result = {};
		const lines = info.split('\n');
		lines.forEach(line => {
			const [key, value] = line.split(':');
			if (key && value) {
				switch (key.trim()) {
					case 'uptime_in_seconds':
						result.uptime_in_seconds =
							parseInt(value.trim(), 10) || 0;
						break;
					case 'used_memory':
						result.used_memory = parseInt(value.trim(), 10) || 0;
						break;
					case 'connected_clients':
						result.connected_clients =
							parseInt(value.trim(), 10) || 0;
						break;
					case 'db0':
						const sizeMatch = value.match(/keys=(\d+)/);
						if (sizeMatch) {
							result.db0_size = parseInt(sizeMatch[1], 10);
						}
						break;
				}
			}
		});
		return result;
	}
	async shutdown() {
		try {
			this.logger.info('Shutting down Redis client...');
			await this.cleanUpRedisClient();
			this.logger.info('Redis client shutdown completed.');
		} catch (error) {
			this.logger.error(
				`Failed to shut down Redis: ${error instanceof Error ? error.message : error}`
			);
		} finally {
			RedisService.instance = null;
			this.logger.info('RedisService instance has been nullified.');
		}
	}
	handleRedisFailure(retries) {
		this.errorLogger.logError(
			`Max retries (${retries}) reached for Redis connection`
		);
		this.errorHandler.handleError({
			error: new Error('Redis connection failed after max retries'),
			details: { reason: 'Failed to connect to Redis' }
		});
	}
	handleRedisError(error, errorHeader, errorDetails, customMessage) {
		const errorMessage = `${customMessage}: ${error}\n${error instanceof Error ? error.stack : ''}`;
		this.errorLogger.logError(errorMessage);
		const redisError = new this.errorHandler.ErrorClasses.RedisServiceError(
			errorHeader,
			{
				details: errorDetails,
				exposeToClient: false
			}
		);
		this.errorHandler.handleError({
			error: redisError
		});
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVkaXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2VydmljZXMvUmVkaXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBVUEsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sb0RBQW9ELENBQUM7QUFDMUYsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sMERBQTBELENBQUM7QUFDdEcsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sdURBQXVELENBQUM7QUFFaEcsTUFBTSxPQUFPLFlBQVk7SUFXTjtJQVZWLE1BQU0sQ0FBQyxRQUFRLEdBQXdCLElBQUksQ0FBQztJQUU1QyxNQUFNLENBQTRCO0lBQ2xDLFdBQVcsQ0FBOEI7SUFDekMsWUFBWSxDQUErQjtJQUMzQyxTQUFTLENBQTRCO0lBRXJDLFdBQVcsR0FBMkIsSUFBSSxDQUFDO0lBRW5ELFlBQ2tCLGlCQUFzRCxFQUN2RSxNQUFpQyxFQUNqQyxXQUF3QyxFQUN4QyxZQUEwQyxFQUMxQyxTQUFvQztRQUpuQixzQkFBaUIsR0FBakIsaUJBQWlCLENBQXFDO1FBTXZFLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQy9CLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO0lBQzVCLENBQUM7SUFFTSxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FDOUIsSUFBc0I7UUFFdEIsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUM1QixZQUFZLENBQUMsUUFBUSxHQUFHLElBQUksWUFBWSxDQUN2QyxJQUFJLENBQUMsaUJBQWlCLEVBQ3RCLE1BQU0sb0JBQW9CLENBQUMsZ0JBQWdCLEVBQUUsRUFDN0MsTUFBTSxvQkFBb0IsQ0FBQyxxQkFBcUIsRUFBRSxFQUNsRCxNQUFNLDBCQUEwQixDQUFDLHNCQUFzQixF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SUFBSSxDQUFDO1lBQzdCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLDJDQUEyQyxDQUFDLENBQUM7UUFDL0QsQ0FBQztJQUNGLENBQUM7SUFFTyxrQkFBa0IsQ0FBQyxPQUFlO1FBQ3pDLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUN4QixnQkFBZ0IsT0FBTyxnQ0FBZ0MsQ0FDdkQsQ0FBQztRQUNGLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDO1lBQzdCLEtBQUssRUFBRSxJQUFJLEtBQUssQ0FBQywyQ0FBMkMsQ0FBQztZQUM3RCxPQUFPLEVBQUUsRUFBRSxNQUFNLEVBQUUsNEJBQTRCLEVBQUU7U0FDakQsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVPLGdCQUFnQixDQUN2QixLQUFjLEVBQ2QsV0FBbUIsRUFDbkIsWUFBb0IsRUFDcEIsYUFBcUI7UUFFckIsTUFBTSxZQUFZLEdBQUcsR0FBRyxhQUFhLEtBQUssS0FBSyxLQUFLLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ2hHLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRXhDLE1BQU0sVUFBVSxHQUFHLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsaUJBQWlCLENBQ3RFLFdBQVcsRUFDWDtZQUNDLE9BQU8sRUFBRSxZQUFZO1lBQ3JCLGNBQWMsRUFBRSxLQUFLO1NBQ3JCLENBQ0QsQ0FBQztRQUVGLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDO1lBQzdCLEtBQUssRUFBRSxVQUFVO1NBQ2pCLENBQUMsQ0FBQztJQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZWRpc0NsaWVudFR5cGUgfSBmcm9tICdyZWRpcyc7XG5pbXBvcnQge1xuXHRBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFbnZDb25maWdTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFJlZGlzTWV0cmljcyxcblx0UmVkaXNTZXJ2aWNlRGVwcyxcblx0UmVkaXNTZXJ2aWNlSW50ZXJmYWNlXG59IGZyb20gJy4uL2luZGV4L2ludGVyZmFjZXMvbWFpbic7XG5pbXBvcnQgeyBMb2dnZXJTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4uL2luZGV4L2ZhY3Rvcnkvc3ViZmFjdG9yaWVzL0xvZ2dlclNlcnZpY2VGYWN0b3J5JztcbmltcG9ydCB7IEVycm9ySGFuZGxlclNlcnZpY2VGYWN0b3J5IH0gZnJvbSAnLi4vaW5kZXgvZmFjdG9yeS9zdWJmYWN0b3JpZXMvRXJyb3JIYW5kbGVyU2VydmljZUZhY3RvcnknO1xuaW1wb3J0IHsgRW52Q29uZmlnU2VydmljZUZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5L3N1YmZhY3Rvcmllcy9FbnZDb25maWdTZXJ2aWNlRmFjdG9yeSc7XG5cbmV4cG9ydCBjbGFzcyBSZWRpc1NlcnZpY2UgaW1wbGVtZW50cyBSZWRpc1NlcnZpY2VJbnRlcmZhY2Uge1xuXHRwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTogUmVkaXNTZXJ2aWNlIHwgbnVsbCA9IG51bGw7XG5cblx0cHJpdmF0ZSBsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBlcnJvckhhbmRsZXI6IEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZW52Q29uZmlnOiBFbnZDb25maWdTZXJ2aWNlSW50ZXJmYWNlO1xuXG5cdHByaXZhdGUgcmVkaXNDbGllbnQ6IFJlZGlzQ2xpZW50VHlwZSB8IG51bGwgPSBudWxsO1xuXG5cdHByaXZhdGUgY29uc3RydWN0b3IoXG5cdFx0cHJpdmF0ZSByZWFkb25seSBjcmVhdGVSZWRpc0NsaWVudDogdHlwZW9mIGltcG9ydCgncmVkaXMnKS5jcmVhdGVDbGllbnQsXG5cdFx0bG9nZ2VyOiBBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGVycm9yTG9nZ2VyOiBFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0ZXJyb3JIYW5kbGVyOiBFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGVudkNvbmZpZzogRW52Q29uZmlnU2VydmljZUludGVyZmFjZVxuXHQpIHtcblx0XHR0aGlzLmxvZ2dlciA9IGxvZ2dlcjtcblx0XHR0aGlzLmVycm9yTG9nZ2VyID0gZXJyb3JMb2dnZXI7XG5cdFx0dGhpcy5lcnJvckhhbmRsZXIgPSBlcnJvckhhbmRsZXI7XG5cdFx0dGhpcy5lbnZDb25maWcgPSBlbnZDb25maWc7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGFzeW5jIGdldEluc3RhbmNlKFxuXHRcdGRlcHM6IFJlZGlzU2VydmljZURlcHNcblx0KTogUHJvbWlzZTxSZWRpc1NlcnZpY2U+IHtcblx0XHRpZiAoIVJlZGlzU2VydmljZS5pbnN0YW5jZSkge1xuXHRcdFx0UmVkaXNTZXJ2aWNlLmluc3RhbmNlID0gbmV3IFJlZGlzU2VydmljZShcblx0XHRcdFx0ZGVwcy5jcmVhdGVSZWRpc0NsaWVudCxcblx0XHRcdFx0YXdhaXQgTG9nZ2VyU2VydmljZUZhY3RvcnkuZ2V0TG9nZ2VyU2VydmljZSgpLFxuXHRcdFx0XHRhd2FpdCBMb2dnZXJTZXJ2aWNlRmFjdG9yeS5nZXRFcnJvckxvZ2dlclNlcnZpY2UoKSxcblx0XHRcdFx0YXdhaXQgRXJyb3JIYW5kbGVyU2VydmljZUZhY3RvcnkuZ2V0RXJyb3JIYW5kbGVyU2VydmljZSgpLFxuXHRcdFx0XHRhd2FpdCBFbnZDb25maWdTZXJ2aWNlRmFjdG9yeS5nZXRFbnZDb25maWdTZXJ2aWNlKClcblx0XHRcdCk7XG5cdFx0fVxuXHRcdHJldHVybiBSZWRpc1NlcnZpY2UuaW5zdGFuY2U7XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIGNvbm5lY3RSZWRpc0NsaWVudCgpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRpZiAodGhpcy5yZWRpc0NsaWVudCkgcmV0dXJuO1xuXG5cdFx0dHJ5IHtcblx0XHRcdHRoaXMucmVkaXNDbGllbnQgPSB0aGlzLmNyZWF0ZVJlZGlzQ2xpZW50KHtcblx0XHRcdFx0dXJsOiB0aGlzLmVudkNvbmZpZy5nZXRFbnZWYXJpYWJsZSgncmVkaXNVcmwnKSxcblx0XHRcdFx0c29ja2V0OiB7XG5cdFx0XHRcdFx0cmVjb25uZWN0U3RyYXRlZ3k6IHJldHJpZXMgPT4ge1xuXHRcdFx0XHRcdFx0Y29uc3QgcmV0cnlBZnRlciA9IE1hdGgubWluKHJldHJpZXMgKiAxMDAsIDMwMDApO1xuXHRcdFx0XHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dXYXJuKFxuXHRcdFx0XHRcdFx0XHRgRXJyb3IgY29ubmVjdGluZyB0byBSZWRpcywgcmV0cnlpbmcgaW4gJHtyZXRyeUFmdGVyfW1zLiBSZXRyaWVzOiAke3JldHJpZXN9YFxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdGlmIChyZXRyaWVzID49IDEwKSB7XG5cdFx0XHRcdFx0XHRcdHRoaXMuaGFuZGxlUmVkaXNGYWlsdXJlKHJldHJpZXMpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0cmV0dXJuIHJldHJ5QWZ0ZXI7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblxuXHRcdFx0dGhpcy5yZWRpc0NsaWVudC5vbignZXJyb3InLCBlcnJvciA9PiB7XG5cdFx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nRXJyb3IoYFJlZGlzIGVycm9yOiAke2Vycm9yfWApO1xuXHRcdFx0fSk7XG5cblx0XHRcdGF3YWl0IHRoaXMucmVkaXNDbGllbnQuY29ubmVjdCgpO1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnQ29ubmVjdGVkIHRvIFJlZGlzJyk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlUmVkaXNFcnJvcihcblx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdCdSRURJU19DT05ORUNUSU9OX0VSUk9SJyxcblx0XHRcdFx0eyByZWFzb246ICdGYWlsZWQgdG8gY29ubmVjdCB0byBSZWRpcycgfSxcblx0XHRcdFx0J0Vycm9yIGNvbm5lY3RpbmcgdG8gUmVkaXMnXG5cdFx0XHQpO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBnZXRSZWRpc0NsaWVudCgpOiBQcm9taXNlPFJlZGlzQ2xpZW50VHlwZSB8IG51bGw+IHtcblx0XHR0cnkge1xuXHRcdFx0YXdhaXQgdGhpcy5jb25uZWN0UmVkaXNDbGllbnQoKTtcblx0XHRcdHJldHVybiB0aGlzLnJlZGlzQ2xpZW50O1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmhhbmRsZVJlZGlzRXJyb3IoXG5cdFx0XHRcdGVycm9yLFxuXHRcdFx0XHQnUkVESVNfQ0xJRU5UX0VSUk9SJyxcblx0XHRcdFx0eyByZWFzb246ICdGYWlsZWQgdG8gZ2V0IFJlZGlzIGNsaWVudCcgfSxcblx0XHRcdFx0J0Vycm9yIGdldHRpbmcgUmVkaXMgY2xpZW50J1xuXHRcdFx0KTtcblx0XHRcdHJldHVybiBudWxsO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBnZXQ8VD4oa2V5OiBzdHJpbmcpOiBQcm9taXNlPFQgfCBudWxsPiB7XG5cdFx0YXdhaXQgdGhpcy5jb25uZWN0UmVkaXNDbGllbnQoKTtcblx0XHRpZiAoIXRoaXMucmVkaXNDbGllbnQpIHRocm93IG5ldyBFcnJvcignUmVkaXMgY2xpZW50IGlzIG5vdCBjb25uZWN0ZWQnKTtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5yZWRpc0NsaWVudC5nZXQoa2V5KTtcblxuXHRcdFx0aWYgKCFyZXN1bHQpIHtcblx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhgS2V5ICR7a2V5fSBub3QgZm91bmQgb3IgZXhwaXJlZCBpbiBSZWRpc2ApO1xuXHRcdFx0XHRyZXR1cm4gbnVsbDtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIHJlc3VsdCA/IEpTT04ucGFyc2UocmVzdWx0KSA6IG51bGw7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlUmVkaXNFcnJvcihcblx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdCdSRURJU19HRVRfRVJST1InLFxuXHRcdFx0XHR7IHJlYXNvbjogYEZhaWxlZCB0byBnZXQga2V5YCB9LFxuXHRcdFx0XHRgRXJyb3IgZmV0Y2hpbmcga2V5ICR7a2V5fSBmcm9tIFJlZGlzYFxuXHRcdFx0KTtcblx0XHRcdHJldHVybiBudWxsO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBzZXQ8VD4oXG5cdFx0a2V5OiBzdHJpbmcsXG5cdFx0dmFsdWU6IFQsXG5cdFx0ZXhwaXJhdGlvbj86IG51bWJlclxuXHQpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRhd2FpdCB0aGlzLmNvbm5lY3RSZWRpc0NsaWVudCgpO1xuXHRcdGlmICghdGhpcy5yZWRpc0NsaWVudCkgdGhyb3cgbmV3IEVycm9yKCdSZWRpcyBjbGllbnQgaXMgbm90IGNvbm5lY3RlZCcpO1xuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCB2YWx1ZVN0cmluZyA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcblx0XHRcdGlmIChleHBpcmF0aW9uKSB7XG5cdFx0XHRcdGF3YWl0IHRoaXMucmVkaXNDbGllbnQuc2V0KGtleSwgdmFsdWVTdHJpbmcsIHtcblx0XHRcdFx0XHRFWDogZXhwaXJhdGlvblxuXHRcdFx0XHR9KTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGF3YWl0IHRoaXMucmVkaXNDbGllbnQuc2V0KGtleSwgdmFsdWVTdHJpbmcpO1xuXHRcdFx0fVxuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0YEtleSAke2tleX0gc2V0IGluIFJlZGlzIHdpdGggZXhwaXJhdGlvbiAke2V4cGlyYXRpb24gPz8gJ25vIGV4cGlyYXRpb24nfWBcblx0XHRcdCk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlUmVkaXNFcnJvcihcblx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdCdSRURJU19TRVRfRVJST1InLFxuXHRcdFx0XHR7IHJlYXNvbjogYEZhaWxlZCB0byBzZXQga2V5ICR7a2V5fWAgfSxcblx0XHRcdFx0YEVycm9yIHNldHRpbmcga2V5ICR7a2V5fSBpbiBSZWRpc2Bcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIGRlbChrZXk6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGlmICghdGhpcy5yZWRpc0NsaWVudCkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdSZWRpcyBjbGllbnQgaXMgbm90IGNvbm5lY3RlZCcpO1xuXHRcdH1cblx0XHR0cnkge1xuXHRcdFx0YXdhaXQgdGhpcy5yZWRpc0NsaWVudC5kZWwoa2V5KTtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oYEtleSAke2tleX0gZGVsZXRlZCBmcm9tIFJlZGlzYCk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlUmVkaXNFcnJvcihcblx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdCdSRURJU19ERUxfRVJST1InLFxuXHRcdFx0XHR7IHJlYXNvbjogYEZhaWxlZCB0byBkZWxldGUga2V5ICR7a2V5fWAgfSxcblx0XHRcdFx0YEVycm9yIGRlbGV0aW5nIGtleSAke2tleX0gZnJvbSBSZWRpc2Bcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIGV4aXN0cyhrZXk6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuXHRcdGlmICghdGhpcy5yZWRpc0NsaWVudCkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdSZWRpcyBjbGllbnQgaXMgbm90IGNvbm5lY3RlZCcpO1xuXHRcdH1cblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5yZWRpc0NsaWVudC5leGlzdHMoa2V5KTtcblx0XHRcdHJldHVybiByZXN1bHQgPiAwO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmhhbmRsZVJlZGlzRXJyb3IoXG5cdFx0XHRcdGVycm9yLFxuXHRcdFx0XHQnUkVESVNfRVhJU1RTX0VSUk9SJyxcblx0XHRcdFx0eyByZWFzb246IGBGYWlsZWQgdG8gY2hlY2sgZXhpc3RlbmNlIG9mIGtleSAke2tleX1gIH0sXG5cdFx0XHRcdGBFcnJvciBjaGVja2luZyBleGlzdGVuY2Ugb2Yga2V5ICR7a2V5fSBpbiBSZWRpc2Bcblx0XHRcdCk7XG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIGluY3JlbWVudChcblx0XHRrZXk6IHN0cmluZyxcblx0XHRleHBpcmF0aW9uPzogbnVtYmVyXG5cdCk6IFByb21pc2U8bnVtYmVyIHwgbnVsbD4ge1xuXHRcdGlmICghdGhpcy5yZWRpc0NsaWVudCkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdSZWRpcyBjbGllbnQgaXMgbm90IGNvbm5lY3RlZCcpO1xuXHRcdH1cblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgbmV3VmFsdWUgPSBhd2FpdCB0aGlzLnJlZGlzQ2xpZW50LmluY3Ioa2V5KTtcblx0XHRcdGlmIChleHBpcmF0aW9uKSB7XG5cdFx0XHRcdGF3YWl0IHRoaXMucmVkaXNDbGllbnQuZXhwaXJlKGtleSwgZXhwaXJhdGlvbik7XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gbmV3VmFsdWU7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlUmVkaXNFcnJvcihcblx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdCdSRURJU19JTkNSRU1FTlRfRVJST1InLFxuXHRcdFx0XHR7IHJlYXNvbjogYEZhaWxlZCB0byBpbmNyZW1lbnQga2V5ICR7a2V5fWAgfSxcblx0XHRcdFx0YEVycm9yIGluY3JlbWVudGluZyBrZXkgJHtrZXl9IGluIFJlZGlzYFxuXHRcdFx0KTtcblx0XHRcdHJldHVybiBudWxsO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBnZXRLZXlzQnlQYXR0ZXJuKHBhdHRlcm46IHN0cmluZyk6IFByb21pc2U8c3RyaW5nW10+IHtcblx0XHR0cnkge1xuXHRcdFx0YXdhaXQgdGhpcy5jb25uZWN0UmVkaXNDbGllbnQoKTtcblxuXHRcdFx0aWYgKCF0aGlzLnJlZGlzQ2xpZW50KSB7XG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcignUmVkaXMgY2xpZW50IGlzIG5vdCBjb25uZWN0ZWQnKTtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3Qga2V5cyA9IGF3YWl0IHRoaXMucmVkaXNDbGllbnQua2V5cyhwYXR0ZXJuKTtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdGBGb3VuZCAke2tleXMubGVuZ3RofSBrZXlzIG1hdGNoaW5nIHBhdHRlcm46ICR7cGF0dGVybn1gXG5cdFx0XHQpO1xuXHRcdFx0cmV0dXJuIGtleXM7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlUmVkaXNFcnJvcihcblx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdCdSRURJU19LRVlfUEFUVEVSTl9FUlJPUicsXG5cdFx0XHRcdHsgcmVhc29uOiBgRmFpbGVkIHRvIGdldCBrZXlzIGJ5IHBhdHRlcm4gJHtwYXR0ZXJufWAgfSxcblx0XHRcdFx0YEVycm9yIGZldGNoaW5nIGtleXMgYnkgcGF0dGVybiAke3BhdHRlcm59IGZyb20gUmVkaXNgXG5cdFx0XHQpO1xuXHRcdFx0cmV0dXJuIFtdO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBkZWxNdWx0aXBsZShzZXJ2aWNlOiBzdHJpbmcsIGtleXM6IHN0cmluZ1tdKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGF3YWl0IHRoaXMuY29ubmVjdFJlZGlzQ2xpZW50KCk7XG5cblx0XHRcdGlmICghdGhpcy5yZWRpc0NsaWVudCkge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ1JlZGlzIGNsaWVudCBpcyBub3QgY29ubmVjdGVkJyk7XG5cdFx0XHR9XG5cblx0XHRcdGlmIChrZXlzLmxlbmd0aCA+IDApIHtcblx0XHRcdFx0Y29uc3QgbmFtZXNwYWNlZEtleXMgPSBrZXlzLm1hcChrZXkgPT4gYCR7c2VydmljZX06JHtrZXl9YCk7XG5cblx0XHRcdFx0YXdhaXQgdGhpcy5yZWRpc0NsaWVudC5kZWwobmFtZXNwYWNlZEtleXMpO1xuXHRcdFx0XHR0aGlzLmxvZ2dlci5pbmZvKFxuXHRcdFx0XHRcdGBEZWxldGVkICR7a2V5cy5sZW5ndGh9IGtleXMgZnJvbSBSZWRpcyBmb3Igc2VydmljZSAke3NlcnZpY2V9YFxuXHRcdFx0XHQpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhgTm8ga2V5cyB0byBkZWxldGUgZm9yIHNlcnZpY2UgJHtzZXJ2aWNlfWApO1xuXHRcdFx0fVxuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmhhbmRsZVJlZGlzRXJyb3IoXG5cdFx0XHRcdGVycm9yLFxuXHRcdFx0XHQnUkVESVNfREVMX01VTFRJUExFX0VSUk9SJyxcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHJlYXNvbjogYEZhaWxlZCB0byBkZWxldGUgbXVsdGlwbGUga2V5cyBmb3Igc2VydmljZSAke3NlcnZpY2V9YFxuXHRcdFx0XHR9LFxuXHRcdFx0XHRgRXJyb3IgZGVsZXRpbmcgbXVsdGlwbGUga2V5cyBmcm9tIFJlZGlzIGZvciBzZXJ2aWNlICR7c2VydmljZX1gXG5cdFx0XHQpO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBmbHVzaENhY2hlQnlTZXJ2aWNlKHNlcnZpY2U6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCBzZXJ2aWNlUGF0dGVybiA9IGAke3NlcnZpY2V9OipgO1xuXHRcdFx0Y29uc3Qgc2VydmljZUtleXMgPSBhd2FpdCB0aGlzLmdldEtleXNCeVBhdHRlcm4oc2VydmljZVBhdHRlcm4pO1xuXHRcdFx0aWYgKHNlcnZpY2VLZXlzLmxlbmd0aCA+IDApIHtcblx0XHRcdFx0YXdhaXQgdGhpcy5kZWxNdWx0aXBsZShzZXJ2aWNlLCBzZXJ2aWNlS2V5cyk7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oYEZsdXNoZWQgUmVkaXMgY2FjaGUgZm9yIHNlcnZpY2UgJHtzZXJ2aWNlfWApO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbyhcblx0XHRcdFx0XHRgTm8ga2V5cyBmb3VuZCB0byBmbHVzaCBmb3Igc2VydmljZSAke3NlcnZpY2V9YFxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmhhbmRsZVJlZGlzRXJyb3IoXG5cdFx0XHRcdGVycm9yLFxuXHRcdFx0XHQnUkVESVNfRkxVU0hfQ0FDSEVfQllfU0VSVklDRV9FUlJPUicsXG5cdFx0XHRcdHsgc2VydmljZSB9LFxuXHRcdFx0XHRgRXJyb3IgZmx1c2hpbmcgUmVkaXMgY2FjaGUgZm9yIHNlcnZpY2UgJHtzZXJ2aWNlfWBcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIGZsdXNoUmVkaXNNZW1vcnlDYWNoZSgpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHR0cnkge1xuXHRcdFx0YXdhaXQgdGhpcy5jb25uZWN0UmVkaXNDbGllbnQoKTtcblxuXHRcdFx0aWYgKHRoaXMucmVkaXNDbGllbnQpIHtcblx0XHRcdFx0dHJ5IHtcblx0XHRcdFx0XHRhd2FpdCB0aGlzLnJlZGlzQ2xpZW50LmZsdXNoQWxsKCk7XG5cdFx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnUmVkaXMgY2FjaGUgZmx1c2hlZCBzdWNjZXNzZnVsbHknKTtcblx0XHRcdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdFx0XHR0aGlzLmhhbmRsZVJlZGlzRXJyb3IoXG5cdFx0XHRcdFx0XHRlcnJvcixcblx0XHRcdFx0XHRcdCdSRURJU19GTFVTSF9FUlJPUicsXG5cdFx0XHRcdFx0XHR7IHJlYXNvbjogJ1JlZGlzIG5vdCBjb25uZWN0ZWQnIH0sXG5cdFx0XHRcdFx0XHQnRXJyb3IgZmx1c2hpbmcgUmVkaXMgY2FjaGUnXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fVxuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dXYXJuKFxuXHRcdFx0XHRcdCdSZWRpcyBjbGllbnQgaXMgbm90IGF2YWlsYWJsZSBmb3IgY2FjaGUgZmx1c2gnXG5cdFx0XHRcdCk7XG5cdFx0XHR9XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlUmVkaXNFcnJvcihcblx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdCdSRURJU19GTFVTSF9FUlJPUicsXG5cdFx0XHRcdHsgcmVhc29uOiAnRmFpbGVkIHRvIGZsdXNoIFJlZGlzIGNhY2hlJyB9LFxuXHRcdFx0XHQnRXJyb3IgZmx1c2hpbmcgUmVkaXMgY2FjaGUnXG5cdFx0XHQpO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBjbGVhblVwUmVkaXNDbGllbnQoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGlmICh0aGlzLnJlZGlzQ2xpZW50KSB7XG5cdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0YXdhaXQgdGhpcy5yZWRpc0NsaWVudC5xdWl0KCk7XG5cdFx0XHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnUmVkaXMgY2xpZW50IGRpc2Nvbm5lY3RlZCBzdWNjZXNzZnVsbHknKTtcblx0XHRcdFx0XHR0aGlzLnJlZGlzQ2xpZW50ID0gbnVsbDtcblx0XHRcdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKFxuXHRcdFx0XHRcdFx0YEVycm9yIGRpc2Nvbm5lY3RpbmcgUmVkaXMgY2xpZW50OiAke2Vycm9yfWBcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuaGFuZGxlUmVkaXNFcnJvcihcblx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdCdSRURJU19ESVNDT05ORUNUX0VSUk9SJyxcblx0XHRcdFx0eyByZWFzb246ICdGYWlsZWQgdG8gZGlzY29ubmVjdCBSZWRpcyBjbGllbnQnIH0sXG5cdFx0XHRcdCdFcnJvciBkaXNjb25uZWN0aW5nIFJlZGlzIGNsaWVudCdcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIGdldFJlZGlzSW5mbygpOiBQcm9taXNlPFJlZGlzTWV0cmljcz4ge1xuXHRcdHRyeSB7XG5cdFx0XHRhd2FpdCB0aGlzLmNvbm5lY3RSZWRpc0NsaWVudCgpO1xuXHRcdFx0aWYgKCF0aGlzLnJlZGlzQ2xpZW50KSB7XG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcignUmVkaXMgY2xpZW50IGlzIG5vdCBjb25uZWN0ZWQnKTtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgaW5mbyA9IGF3YWl0IHRoaXMucmVkaXNDbGllbnQuaW5mbygpO1xuXHRcdFx0Y29uc3QgcGFyc2VkSW5mbyA9IHRoaXMucGFyc2VSZWRpc0luZm8oaW5mbyk7XG5cblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oYFJlZGlzIG1ldHJpY3M6ICR7SlNPTi5zdHJpbmdpZnkocGFyc2VkSW5mbyl9YCk7XG5cdFx0XHRyZXR1cm4gcGFyc2VkSW5mbztcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5oYW5kbGVSZWRpc0Vycm9yKFxuXHRcdFx0XHRlcnJvcixcblx0XHRcdFx0J1JFRElTX01FVFJJQ1NfUkVUUklFVkFMX0VSUk9SJyxcblx0XHRcdFx0eyByZWFzb246ICdGYWlsZWQgdG8gcmV0cmlldmUgUmVkaXMgbWV0cmljcycgfSxcblx0XHRcdFx0YEVycm9yIHJldHJpZXZpbmcgUmVkaXMgbWV0cmljc2Bcblx0XHRcdCk7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ0Vycm9yIHJldHJpZXZpbmcgUmVkaXMgbWV0cmljcycpO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgcGFyc2VSZWRpc0luZm8oaW5mbzogc3RyaW5nKTogUmVkaXNNZXRyaWNzIHtcblx0XHRjb25zdCByZXN1bHQ6IFBhcnRpYWw8UmVkaXNNZXRyaWNzPiA9IHt9O1xuXHRcdGNvbnN0IGxpbmVzID0gaW5mby5zcGxpdCgnXFxuJyk7XG5cblx0XHRsaW5lcy5mb3JFYWNoKGxpbmUgPT4ge1xuXHRcdFx0Y29uc3QgW2tleSwgdmFsdWVdID0gbGluZS5zcGxpdCgnOicpO1xuXHRcdFx0aWYgKGtleSAmJiB2YWx1ZSkge1xuXHRcdFx0XHRzd2l0Y2ggKGtleS50cmltKCkpIHtcblx0XHRcdFx0XHRjYXNlICd1cHRpbWVfaW5fc2Vjb25kcyc6XG5cdFx0XHRcdFx0XHRyZXN1bHQudXB0aW1lX2luX3NlY29uZHMgPVxuXHRcdFx0XHRcdFx0XHRwYXJzZUludCh2YWx1ZS50cmltKCksIDEwKSB8fCAwO1xuXHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0Y2FzZSAndXNlZF9tZW1vcnknOlxuXHRcdFx0XHRcdFx0cmVzdWx0LnVzZWRfbWVtb3J5ID0gcGFyc2VJbnQodmFsdWUudHJpbSgpLCAxMCkgfHwgMDtcblx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdGNhc2UgJ2Nvbm5lY3RlZF9jbGllbnRzJzpcblx0XHRcdFx0XHRcdHJlc3VsdC5jb25uZWN0ZWRfY2xpZW50cyA9XG5cdFx0XHRcdFx0XHRcdHBhcnNlSW50KHZhbHVlLnRyaW0oKSwgMTApIHx8IDA7XG5cdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRjYXNlICdkYjAnOlxuXHRcdFx0XHRcdFx0Y29uc3Qgc2l6ZU1hdGNoID0gdmFsdWUubWF0Y2goL2tleXM9KFxcZCspLyk7XG5cdFx0XHRcdFx0XHRpZiAoc2l6ZU1hdGNoKSB7XG5cdFx0XHRcdFx0XHRcdHJlc3VsdC5kYjBfc2l6ZSA9IHBhcnNlSW50KHNpemVNYXRjaFsxXSwgMTApO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdHJldHVybiByZXN1bHQgYXMgUmVkaXNNZXRyaWNzO1xuXHR9XG5cblx0cHVibGljIGFzeW5jIHNodXRkb3duKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdHRyeSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdTaHV0dGluZyBkb3duIFJlZGlzIGNsaWVudC4uLicpO1xuXHRcdFx0YXdhaXQgdGhpcy5jbGVhblVwUmVkaXNDbGllbnQoKTtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ1JlZGlzIGNsaWVudCBzaHV0ZG93biBjb21wbGV0ZWQuJyk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMubG9nZ2VyLmVycm9yKFxuXHRcdFx0XHRgRmFpbGVkIHRvIHNodXQgZG93biBSZWRpczogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IGVycm9yfWBcblx0XHRcdCk7XG5cdFx0fSBmaW5hbGx5IHtcblx0XHRcdFJlZGlzU2VydmljZS5pbnN0YW5jZSA9IG51bGw7XG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdSZWRpc1NlcnZpY2UgaW5zdGFuY2UgaGFzIGJlZW4gbnVsbGlmaWVkLicpO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgaGFuZGxlUmVkaXNGYWlsdXJlKHJldHJpZXM6IG51bWJlcik6IHZvaWQge1xuXHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nRXJyb3IoXG5cdFx0XHRgTWF4IHJldHJpZXMgKCR7cmV0cmllc30pIHJlYWNoZWQgZm9yIFJlZGlzIGNvbm5lY3Rpb25gXG5cdFx0KTtcblx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7XG5cdFx0XHRlcnJvcjogbmV3IEVycm9yKCdSZWRpcyBjb25uZWN0aW9uIGZhaWxlZCBhZnRlciBtYXggcmV0cmllcycpLFxuXHRcdFx0ZGV0YWlsczogeyByZWFzb246ICdGYWlsZWQgdG8gY29ubmVjdCB0byBSZWRpcycgfVxuXHRcdH0pO1xuXHR9XG5cblx0cHJpdmF0ZSBoYW5kbGVSZWRpc0Vycm9yKFxuXHRcdGVycm9yOiB1bmtub3duLFxuXHRcdGVycm9ySGVhZGVyOiBzdHJpbmcsXG5cdFx0ZXJyb3JEZXRhaWxzOiBvYmplY3QsXG5cdFx0Y3VzdG9tTWVzc2FnZTogc3RyaW5nXG5cdCk6IHZvaWQge1xuXHRcdGNvbnN0IGVycm9yTWVzc2FnZSA9IGAke2N1c3RvbU1lc3NhZ2V9OiAke2Vycm9yfVxcbiR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLnN0YWNrIDogJyd9YDtcblx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKGVycm9yTWVzc2FnZSk7XG5cblx0XHRjb25zdCByZWRpc0Vycm9yID0gbmV3IHRoaXMuZXJyb3JIYW5kbGVyLkVycm9yQ2xhc3Nlcy5SZWRpc1NlcnZpY2VFcnJvcihcblx0XHRcdGVycm9ySGVhZGVyLFxuXHRcdFx0e1xuXHRcdFx0XHRkZXRhaWxzOiBlcnJvckRldGFpbHMsXG5cdFx0XHRcdGV4cG9zZVRvQ2xpZW50OiBmYWxzZVxuXHRcdFx0fVxuXHRcdCk7XG5cblx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7XG5cdFx0XHRlcnJvcjogcmVkaXNFcnJvclxuXHRcdH0pO1xuXHR9XG59XG4iXX0=
