import {
	AppError,
	ErrorClasses,
	ErrorSeverity
} from '../errors/ErrorClasses.mjs';
import { v4 as uuidv4 } from 'uuid';
import { sanitizeRequestBody } from '../utils/validator.mjs';
export class ErrorHandlerService {
	static instance;
	ErrorClasses = ErrorClasses;
	ErrorSeverity = ErrorSeverity;
	logger;
	errorLogger;
	shutdownFunction = null;
	constructor(logger, errorLogger) {
		this.logger = logger;
		this.errorLogger = errorLogger;
	}
	static async getInstance(logger, errorLogger) {
		if (!ErrorHandlerService.instance) {
			ErrorHandlerService.instance = new ErrorHandlerService(
				logger,
				errorLogger
			);
			ErrorHandlerService.instance.initializeGlobalErrorHandlers();
		}
		return ErrorHandlerService.instance;
	}
	handleError(params) {
		const {
			error,
			req,
			details,
			severity = ErrorSeverity.RECOVERABLE,
			action = 'unknown',
			userId = null,
			sequelize
		} = params;
		let appError;
		if (error instanceof AppError) {
			appError = error;
		} else if (error instanceof Error) {
			appError = new AppError(error.message);
		} else {
			appError = new AppError(`Unknown error type encountered\n${error}`);
		}
		const errorDetails = this.errorLogger.getErrorDetails(
			() => 'handleError',
			action,
			req,
			userId,
			details
		);
		if (sequelize) {
			this.errorLogger.logAppError(appError, sequelize, errorDetails);
		} else {
			this.logger.logError('Error occurred.', errorDetails);
		}
		if (severity === ErrorSeverity.FATAL) {
			this.logger.logCritical('A fatal error occurred.', errorDetails);
		} else {
			this.logger.logError('A recoverable error occurred.', errorDetails);
		}
	}
	expressErrorHandler() {
		return (err, req, res, next) => {
			const responseId = uuidv4();
			let statusCode = err instanceof AppError ? err.statusCode : 500;
			let message = 'An unexpected error occurred';
			let errorCode = 'ERR_GENERIC';
			const logDetails = {
				responseId,
				method: req.method,
				url: req.url,
				ip: req.ip,
				headers: req.headers,
				query: req.query,
				body: req.body ? sanitizeRequestBody(req.body) : null
			};
			if (err instanceof AppError) {
				statusCode = err.statusCode ?? 500;
				message = err.message || message;
				errorCode = err.errorCode ?? errorCode;
				if (err.details?.retryAfter) {
					res.set('Retry-After', String(err.details.retryAfter));
				}
				this.handleError({
					error: err,
					req,
					details: {
						...logDetails,
						severity: err.severity ?? 'unknown',
						errorCode: err.errorCode ?? 'ERR_GENERIC'
					},
					severity: err.severity
				});
				res.status(statusCode).json({
					status: 'error',
					message: err.message,
					code: errorCode,
					details: err.details || null,
					responseId
				});
			} else if (err instanceof Error) {
				statusCode = 500;
				message = err.message || message;
				this.handleError({
					error: err,
					req,
					details: logDetails
				});
				res.status(statusCode).json({
					status: 'error',
					message,
					responseId
				});
			} else {
				this.handleError({
					error: new Error(`Unknown error: ${String(err)}`),
					req,
					details: logDetails
				});
				res.status(500).json({
					status: 'error',
					message: 'Unknown error occurred',
					responseId
				});
			}
			this.logger.logInfo(
				`Error response sent to client. Response ID: ${responseId} | Status Code: ${statusCode} | Message: ${message}`,
				logDetails
			);
			next();
		};
	}
	handleCriticalError(params) {
		const { error, req, details = {} } = params;
		const errorMessage =
			error instanceof Error ? error.message : String(error);
		const errorStack = error instanceof Error ? error.stack : undefined;
		const logDetails = {
			method: req?.method ?? 'Unknown method',
			url: req?.url ?? 'Unknown URL',
			ip: req?.ip ?? 'Unknown IP',
			...details
		};
		this.logger.logCritical(`CriticalError: ${errorMessage}`, {
			stack: errorStack,
			...logDetails
		});
		if (process.env.NODE_ENV === 'production') {
			process.exitCode = 1;
			setTimeout(() => process.exit(1), 1500);
		} else {
			this.errorLogger.logCritical(
				`Non-Prod environment: Critical error occurred\n${error}`
			);
			throw new Error(errorMessage);
		}
	}
	async sendClientErrorResponse({
		message,
		res,
		responseId,
		statusCode = 400
	}) {
		if (!responseId) {
			responseId = uuidv4();
		}
		res.status(statusCode).json({
			status: 'error',
			message,
			responseId
		});
		this.logger.logInfo(
			`Client error response sent. Response ID: ${responseId}\nMessage: ${message}`,
			{ statusCode, responseId }
		);
	}
	initializeGlobalErrorHandlers() {
		process.on('SIGINT', async () => {
			this.logger.logInfo('Received SIGINT. Gracefully shutting down...');
			await this.performGracefulShutdown();
		});
		process.on('SIGTERM', async () => {
			this.logger.logInfo(
				'Received SIGTERM. Gracefully shutting down...'
			);
			await this.performGracefulShutdown();
		});
		process.on('unhandledRejection', (reason, promise) => {
			const rejectionMessage = `Unhandled promise rejection: ${reason}`;
			this.handleError({
				error: new Error(rejectionMessage),
				details: { reason, promise },
				action: 'unhandledRejection'
			});
			console.error(rejectionMessage);
		});
		process.on('uncaughtException', error => {
			this.handleCriticalError({
				error,
				details: { action: 'uncaughtException' }
			});
			console.error('Uncaught Exception:', error);
			if (process.env.NODE_ENV === 'production') {
				process.exit(1);
			}
		});
	}
	setShutdownHandler(shutdownFn) {
		this.shutdownFunction = shutdownFn;
	}
	async performGracefulShutdown() {
		try {
			if (this.shutdownFunction) {
				this.logger.logInfo('Performing graceful shutdown...');
				await this.shutdownFunction();
			} else {
				this.logger.logError('Shutdown function not set.');
			}
		} catch (error) {
			this.handleCriticalError({
				error,
				details: { action: 'gracefulShutdown' }
			});
			process.exit(1);
		}
	}
	async shutdown() {
		this.logger.logInfo('Initiating ErrorHandlerService shutdown...');
		if (this.shutdownFunction) {
			await this.shutdownFunction();
			this.logger.logInfo('Error Handler shutdown function completed.');
		}
		this.logger.logInfo('ErrorHandlerService shutdown completed.');
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXJyb3JIYW5kbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3NlcnZpY2VzL0Vycm9ySGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ04sUUFBUSxFQUVSLFlBQVksRUFDWixhQUFhLEVBRWIsTUFBTSx3QkFBd0IsQ0FBQztBQU9oQyxPQUFPLEVBQUUsRUFBRSxJQUFJLE1BQU0sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUVwQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUV6RCxNQUFNLE9BQU8sbUJBQW1CO0lBQ3ZCLE1BQU0sQ0FBQyxRQUFRLENBQXNCO0lBQ3RDLFlBQVksR0FBRyxZQUFZLENBQUM7SUFDNUIsYUFBYSxHQUFHLGFBQWEsQ0FBQztJQUM3QixNQUFNLENBQTRCO0lBQ2xDLFdBQVcsQ0FBOEI7SUFDekMsZ0JBQWdCLEdBQWlDLElBQUksQ0FBQztJQUU5RCxZQUNDLE1BQWlDLEVBQ2pDLFdBQXdDO1FBRXhDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO0lBQ2hDLENBQUM7SUFFTSxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FDOUIsTUFBaUMsRUFDakMsV0FBd0M7UUFFeEMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ25DLG1CQUFtQixDQUFDLFFBQVEsR0FBRyxJQUFJLG1CQUFtQixDQUNyRCxNQUFNLEVBQ04sV0FBVyxDQUNYLENBQUM7WUFDRixtQkFBbUIsQ0FBQyxRQUFRLENBQUMsNkJBQTZCLEVBQUUsQ0FBQztRQUM5RCxDQUFDO1FBQ0QsT0FBTyxtQkFBbUIsQ0FBQyxRQUFRLENBQUM7SUFDckMsQ0FBQztJQUVNLFdBQVcsQ0FBQyxNQVFsQjtRQUNBLE1BQU0sRUFDTCxLQUFLLEVBQ0wsR0FBRyxFQUNILE9BQU8sRUFDUCxRQUFRLEdB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SSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsaUNBQWlDLENBQUMsQ0FBQztnQkFDdkQsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUMvQixDQUFDO2lCQUFNLENBQUM7Z0JBQ1AsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsNEJBQTRCLENBQUMsQ0FBQztZQUNwRCxDQUFDO1FBQ0YsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDaEIsSUFBSSxDQUFDLG1CQUFtQixDQUFDO2dCQUN4QixLQUFLO2dCQUNMLE9BQU8sRUFBRSxFQUFFLE1BQU0sRUFBRSxrQkFBa0IsRUFBRTthQUN2QyxDQUFDLENBQUM7WUFDSCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pCLENBQUM7SUFDRixDQUFDO0lBRU0sS0FBSyxDQUFDLFFBQVE7UUFDcEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsNENBQTRDLENBQUMsQ0FBQztRQUVsRSxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQzNCLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDOUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsNENBQTRDLENBQUMsQ0FBQztRQUNuRSxDQUFDO1FBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMseUNBQXlDLENBQUMsQ0FBQztJQUNoRSxDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuXHRBcHBFcnJvcixcblx0Q2xpZW50RXJyb3IsXG5cdEVycm9yQ2xhc3Nlcyxcblx0RXJyb3JTZXZlcml0eSxcblx0RXJyb3JTZXZlcml0eVR5cGVcbn0gZnJvbSAnLi4vZXJyb3JzL0Vycm9yQ2xhc3Nlcyc7XG5pbXBvcnQgeyBOZXh0RnVuY3Rpb24sIFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQge1xuXHRBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2Vcbn0gZnJvbSAnLi4vaW5kZXgvaW50ZXJmYWNlcy9zZXJ2aWNlcyc7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcbmltcG9ydCB7IFNlcXVlbGl6ZSB9IGZyb20gJ3NlcXVlbGl6ZSc7XG5pbXBvcnQgeyBzYW5pdGl6ZVJlcXVlc3RCb2R5IH0gZnJvbSAnLi4vdXRpbHMvdmFsaWRhdG9yJztcblxuZXhwb3J0IGNsYXNzIEVycm9ySGFuZGxlclNlcnZpY2UgaW1wbGVtZW50cyBFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlIHtcblx0cHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IEVycm9ySGFuZGxlclNlcnZpY2U7XG5cdHB1YmxpYyBFcnJvckNsYXNzZXMgPSBFcnJvckNsYXNzZXM7XG5cdHB1YmxpYyBFcnJvclNldmVyaXR5ID0gRXJyb3JTZXZlcml0eTtcblx0cHJpdmF0ZSBsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByaXZhdGUgZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBzaHV0ZG93bkZ1bmN0aW9uOiAoKCkgPT4gUHJvbWlzZTx2b2lkPikgfCBudWxsID0gbnVsbDtcblxuXHRwcml2YXRlIGNvbnN0cnVjdG9yKFxuXHRcdGxvZ2dlcjogQXBwTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0XHRlcnJvckxvZ2dlcjogRXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlXG5cdCkge1xuXHRcdHRoaXMubG9nZ2VyID0gbG9nZ2VyO1xuXHRcdHRoaXMuZXJyb3JMb2dnZXIgPSBlcnJvckxvZ2dlcjtcblx0fVxuXG5cdHB1YmxpYyBzdGF0aWMgYXN5bmMgZ2V0SW5zdGFuY2UoXG5cdFx0bG9nZ2VyOiBBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGVycm9yTG9nZ2VyOiBFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2Vcblx0KTogUHJvbWlzZTxFcnJvckhhbmRsZXJTZXJ2aWNlPiB7XG5cdFx0aWYgKCFFcnJvckhhbmRsZXJTZXJ2aWNlLmluc3RhbmNlKSB7XG5cdFx0XHRFcnJvckhhbmRsZXJTZXJ2aWNlLmluc3RhbmNlID0gbmV3IEVycm9ySGFuZGxlclNlcnZpY2UoXG5cdFx0XHRcdGxvZ2dlcixcblx0XHRcdFx0ZXJyb3JMb2dnZXJcblx0XHRcdCk7XG5cdFx0XHRFcnJvckhhbmRsZXJTZXJ2aWNlLmluc3RhbmNlLmluaXRpYWxpemVHbG9iYWxFcnJvckhhbmRsZXJzKCk7XG5cdFx0fVxuXHRcdHJldHVybiBFcnJvckhhbmRsZXJTZXJ2aWNlLmluc3RhbmNlO1xuXHR9XG5cblx0cHVibGljIGhhbmRsZUVycm9yKHBhcmFtczoge1xuXHRcdGVycm9yOiB1bmtub3duO1xuXHRcdHJlcT86IFJlcXVlc3Q7XG5cdFx0ZGV0YWlscz86IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuXHRcdHNldmVyaXR5PzogRXJyb3JTZXZlcml0eVR5cGU7XG5cdFx0YWN0aW9uPzogc3RyaW5nO1xuXHRcdHVzZXJJZD86IHN0cmluZztcblx0XHRzZXF1ZWxpemU/OiBTZXF1ZWxpemU7XG5cdH0pOiB2b2lkIHtcblx0XHRjb25zdCB7XG5cdFx0XHRlcnJvcixcblx0XHRcdHJlcSxcblx0XHRcdGRldGFpbHMsXG5cdFx0XHRzZXZlcml0eSA9IEVycm9yU2V2ZXJpdHkuUkVDT1ZFUkFCTEUsXG5cdFx0XHRhY3Rpb24gPSAndW5rbm93bicsXG5cdFx0XHR1c2VySWQgPSBudWxsLFxuXHRcdFx0c2VxdWVsaXplXG5cdFx0fSA9IHBhcmFtcztcblxuXHRcdGxldCBhcHBFcnJvcjogQXBwRXJyb3I7XG5cblx0XHRpZiAoZXJyb3IgaW5zdGFuY2VvZiBBcHBFcnJvcikge1xuXHRcdFx0YXBwRXJyb3IgPSBlcnJvcjtcblx0XHR9IGVsc2UgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpIHtcblx0XHRcdGFwcEVycm9yID0gbmV3IEFwcEVycm9yKGVycm9yLm1lc3NhZ2UpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRhcHBFcnJvciA9IG5ldyBBcHBFcnJvcihgVW5rbm93biBlcnJvciB0eXBlIGVuY291bnRlcmVkXFxuJHtlcnJvcn1gKTtcblx0XHR9XG5cblx0XHRjb25zdCBlcnJvckRldGFpbHMgPSB0aGlzLmVycm9yTG9nZ2VyLmdldEVycm9yRGV0YWlscyhcblx0XHRcdCgpID0+ICdoYW5kbGVFcnJvcicsXG5cdFx0XHRhY3Rpb24sXG5cdFx0XHRyZXEsXG5cdFx0XHR1c2VySWQsXG5cdFx0XHRkZXRhaWxzXG5cdFx0KTtcblxuXHRcdGlmIChzZXF1ZWxpemUpIHtcblx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nQXBwRXJyb3IoYXBwRXJyb3IsIHNlcXVlbGl6ZSwgZXJyb3JEZXRhaWxzKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5sb2dnZXIubG9nRXJyb3IoJ0Vycm9yIG9jY3VycmVkLicsIGVycm9yRGV0YWlscyk7XG5cdFx0fVxuXG5cdFx0aWYgKHNldmVyaXR5ID09PSBFcnJvclNldmVyaXR5LkZBVEFMKSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5sb2dDcml0aWNhbCgnQSBmYXRhbCBlcnJvciBvY2N1cnJlZC4nLCBlcnJvckRldGFpbHMpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5sb2dFcnJvcignQSByZWNvdmVyYWJsZSBlcnJvciBvY2N1cnJlZC4nLCBlcnJvckRldGFpbHMpO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBleHByZXNzRXJyb3JIYW5kbGVyKCkge1xuXHRcdHJldHVybiAoXG5cdFx0XHRlcnI6IEFwcEVycm9yIHwgQ2xpZW50RXJyb3IgfCBFcnJvciB8IFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuXHRcdFx0cmVxOiBSZXF1ZXN0LFxuXHRcdFx0cmVzOiBSZXNwb25zZSxcblx0XHRcdG5leHQ6IE5leHRGdW5jdGlvblxuXHRcdCk6IHZvaWQgPT4ge1xuXHRcdFx0Y29uc3QgcmVzcG9uc2VJZCA9IHV1aWR2NCgpO1xuXHRcdFx0bGV0IHN0YXR1c0NvZGUgPSBlcnIgaW5zdGFuY2VvZiBBcHBFcnJvciA/IGVyci5zdGF0dXNDb2RlIDogNTAwO1xuXHRcdFx0bGV0IG1lc3NhZ2UgPSAnQW4gdW5leHBlY3RlZCBlcnJvciBvY2N1cnJlZCc7XG5cdFx0XHRsZXQgZXJyb3JDb2RlID0gJ0VSUl9HRU5FUklDJztcblxuXHRcdFx0Y29uc3QgbG9nRGV0YWlscyA9IHtcblx0XHRcdFx0cmVzcG9uc2VJZCxcblx0XHRcdFx0bWV0aG9kOiByZXEubWV0aG9kLFxuXHRcdFx0XHR1cmw6IHJlcS51cmwsXG5cdFx0XHRcdGlwOiByZXEuaXAsXG5cdFx0XHRcdGhlYWRlcnM6IHJlcS5oZWFkZXJzLFxuXHRcdFx0XHRxdWVyeTogcmVxLnF1ZXJ5LFxuXHRcdFx0XHRib2R5OiByZXEuYm9keSA/IHNhbml0aXplUmVxdWVzdEJvZHkocmVxLmJvZHkpIDogbnVsbFxuXHRcdFx0fTtcblxuXHRcdFx0aWYgKGVyciBpbnN0YW5jZW9mIEFwcEVycm9yKSB7XG5cdFx0XHRcdHN0YXR1c0NvZGUgPSBlcnIuc3RhdHVzQ29kZSA/PyA1MDA7XG5cdFx0XHRcdG1lc3NhZ2UgPSBlcnIubWVzc2FnZSB8fCBtZXNzYWdlO1xuXHRcdFx0XHRlcnJvckNvZGUgPSBlcnIuZXJyb3JDb2RlID8/IGVycm9yQ29kZTtcblxuXHRcdFx0XHRpZiAoZXJyLmRldGFpbHM/LnJldHJ5QWZ0ZXIpIHtcblx0XHRcdFx0XHRyZXMuc2V0KCdSZXRyeS1BZnRlcicsIFN0cmluZyhlcnIuZGV0YWlscy5yZXRyeUFmdGVyKSk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHR0aGlzLmhhbmRsZUVycm9yKHtcblx0XHRcdFx0XHRlcnJvcjogZXJyLFxuXHRcdFx0XHRcdHJlcSxcblx0XHRcdFx0XHRkZXRhaWxzOiB7XG5cdFx0XHRcdFx0XHQuLi5sb2dEZXRhaWxzLFxuXHRcdFx0XHRcdFx0c2V2ZXJpdHk6IGVyci5zZXZlcml0eSA/PyAndW5rbm93bicsXG5cdFx0XHRcdFx0XHRlcnJvckNvZGU6IGVyci5lcnJvckNvZGUgPz8gJ0VSUl9HRU5FUklDJ1xuXHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0c2V2ZXJpdHk6IGVyci5zZXZlcml0eVxuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHRyZXMuc3RhdHVzKHN0YXR1c0NvZGUpLmpzb24oe1xuXHRcdFx0XHRcdHN0YXR1czogJ2Vycm9yJyxcblx0XHRcdFx0XHRtZXNzYWdlOiBlcnIubWVzc2FnZSxcblx0XHRcdFx0XHRjb2RlOiBlcnJvckNvZGUsXG5cdFx0XHRcdFx0ZGV0YWlsczogZXJyLmRldGFpbHMgfHwgbnVsbCxcblx0XHRcdFx0XHRyZXNwb25zZUlkXG5cdFx0XHRcdH0pO1xuXHRcdFx0fSBlbHNlIGlmIChlcnIgaW5zdGFuY2VvZiBFcnJvcikge1xuXHRcdFx0XHRzdGF0dXNDb2RlID0gNTAwO1xuXHRcdFx0XHRtZXNzYWdlID0gZXJyLm1lc3NhZ2UgfHwgbWVzc2FnZTtcblxuXHRcdFx0XHR0aGlzLmhhbmRsZUVycm9yKHtcblx0XHRcdFx0XHRlcnJvcjogZXJyLFxuXHRcdFx0XHRcdHJlcSxcblx0XHRcdFx0XHRkZXRhaWxzOiBsb2dEZXRhaWxzXG5cdFx0XHRcdH0pO1xuXG5cdFx0XHRcdHJlcy5zdGF0dXMoc3RhdHVzQ29kZSkuanNvbih7XG5cdFx0XHRcdFx0c3RhdHVzOiAnZXJyb3InLFxuXHRcdFx0XHRcdG1lc3NhZ2UsXG5cdFx0XHRcdFx0cmVzcG9uc2VJZFxuXHRcdFx0XHR9KTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHRoaXMuaGFuZGxlRXJyb3Ioe1xuXHRcdFx0XHRcdGVycm9yOiBuZXcgRXJyb3IoYFVua25vd24gZXJyb3I6ICR7U3RyaW5nKGVycil9YCksXG5cdFx0XHRcdFx0cmVxLFxuXHRcdFx0XHRcdGRldGFpbHM6IGxvZ0RldGFpbHNcblx0XHRcdFx0fSk7XG5cblx0XHRcdFx0cmVzLnN0YXR1cyg1MDApLmpzb24oe1xuXHRcdFx0XHRcdHN0YXR1czogJ2Vycm9yJyxcblx0XHRcdFx0XHRtZXNzYWdlOiAnVW5rbm93biBlcnJvciBvY2N1cnJlZCcsXG5cdFx0XHRcdFx0cmVzcG9uc2VJZFxuXHRcdFx0XHR9KTtcblx0XHRcdH1cblxuXHRcdFx0dGhpcy5sb2dnZXIubG9nSW5mbyhcblx0XHRcdFx0YEVycm9yIHJlc3BvbnNlIHNlbnQgdG8gY2xpZW50LiBSZXNwb25zZSBJRDogJHtyZXNwb25zZUlkfSB8IFN0YXR1cyBDb2RlOiAke3N0YXR1c0NvZGV9IHwgTWVzc2FnZTogJHttZXNzYWdlfWAsXG5cdFx0XHRcdGxvZ0RldGFpbHNcblx0XHRcdCk7XG5cblx0XHRcdG5leHQoKTtcblx0XHR9O1xuXHR9XG5cblx0cHVibGljIGhhbmRsZUNyaXRpY2FsRXJyb3IocGFyYW1zOiB7XG5cdFx0ZXJyb3I6IHVua25vd247XG5cdFx0cmVxPzogUmVxdWVzdDtcblx0XHRkZXRhaWxzPzogUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG5cdH0pOiB2b2lkIHtcblx0XHRjb25zdCB7IGVycm9yLCByZXEsIGRldGFpbHMgPSB7fSB9ID0gcGFyYW1zO1xuXHRcdGNvbnN0IGVycm9yTWVzc2FnZSA9XG5cdFx0XHRlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcik7XG5cdFx0Y29uc3QgZXJyb3JTdGFjayA9IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5zdGFjayA6IHVuZGVmaW5lZDtcblxuXHRcdGNvbnN0IGxvZ0RldGFpbHMgPSB7XG5cdFx0XHRtZXRob2Q6IHJlcT8ubWV0aG9kID8/ICdVbmtub3duIG1ldGhvZCcsXG5cdFx0XHR1cmw6IHJlcT8udXJsID8/ICdVbmtub3duIFVSTCcsXG5cdFx0XHRpcDogcmVxPy5pcCA/PyAnVW5rbm93biBJUCcsXG5cdFx0XHQuLi5kZXRhaWxzXG5cdFx0fTtcblxuXHRcdHRoaXMubG9nZ2VyLmxvZ0NyaXRpY2FsKGBDcml0aWNhbEVycm9yOiAke2Vycm9yTWVzc2FnZX1gLCB7XG5cdFx0XHRzdGFjazogZXJyb3JTdGFjayxcblx0XHRcdC4uLmxvZ0RldGFpbHNcblx0XHR9KTtcblxuXHRcdGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nKSB7XG5cdFx0XHRwcm9jZXNzLmV4aXRDb2RlID0gMTtcblx0XHRcdHNldFRpbWVvdXQoKCkgPT4gcHJvY2Vzcy5leGl0KDEpLCAxNTAwKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dDcml0aWNhbChcblx0XHRcdFx0YE5vbi1Qcm9kIGVudmlyb25tZW50OiBDcml0aWNhbCBlcnJvciBvY2N1cnJlZFxcbiR7ZXJyb3J9YFxuXHRcdFx0KTtcblx0XHRcdHRocm93IG5ldyBFcnJvcihlcnJvck1lc3NhZ2UpO1xuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBhc3luYyBzZW5kQ2xpZW50RXJyb3JSZXNwb25zZSh7XG5cdFx0bWVzc2FnZSxcblx0XHRyZXMsXG5cdFx0cmVzcG9uc2VJZCxcblx0XHRzdGF0dXNDb2RlID0gNDAwXG5cdH06IHtcblx0XHRtZXNzYWdlOiBzdHJpbmc7XG5cdFx0c3RhdHVzQ29kZT86IG51bWJlcjtcblx0XHRyZXM6IFJlc3BvbnNlO1xuXHRcdHJlc3BvbnNlSWQ/OiBzdHJpbmc7XG5cdH0pOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRpZiAoIXJlc3BvbnNlSWQpIHtcblx0XHRcdHJlc3BvbnNlSWQgPSB1dWlkdjQoKTtcblx0XHR9XG5cblx0XHRyZXMuc3RhdHVzKHN0YXR1c0NvZGUpLmpzb24oe1xuXHRcdFx0c3RhdHVzOiAnZXJyb3InLFxuXHRcdFx0bWVzc2FnZSxcblx0XHRcdHJlc3BvbnNlSWRcblx0XHR9KTtcblxuXHRcdHRoaXMubG9nZ2VyLmxvZ0luZm8oXG5cdFx0XHRgQ2xpZW50IGVycm9yIHJlc3BvbnNlIHNlbnQuIFJlc3BvbnNlIElEOiAke3Jlc3BvbnNlSWR9XFxuTWVzc2FnZTogJHttZXNzYWdlfWAsXG5cdFx0XHR7IHN0YXR1c0NvZGUsIHJlc3BvbnNlSWQgfVxuXHRcdCk7XG5cdH1cblxuXHRwdWJsaWMgaW5pdGlhbGl6ZUdsb2JhbEVycm9ySGFuZGxlcnMoKTogdm9pZCB7XG5cdFx0cHJvY2Vzcy5vbignU0lHSU5UJywgYXN5bmMgKCkgPT4ge1xuXHRcdFx0dGhpcy5sb2dnZXIubG9nSW5mbygnUmVjZWl2ZWQgU0lHSU5ULiBHcmFjZWZ1bGx5IHNodXR0aW5nIGRvd24uLi4nKTtcblx0XHRcdGF3YWl0IHRoaXMucGVyZm9ybUdyYWNlZnVsU2h1dGRvd24oKTtcblx0XHR9KTtcblxuXHRcdHByb2Nlc3Mub24oJ1NJR1RFUk0nLCBhc3luYyAoKSA9PiB7XG5cdFx0XHR0aGlzLmxvZ2dlci5sb2dJbmZvKFxuXHRcdFx0XHQnUmVjZWl2ZWQgU0lHVEVSTS4gR3JhY2VmdWxseSBzaHV0dGluZyBkb3duLi4uJ1xuXHRcdFx0KTtcblx0XHRcdGF3YWl0IHRoaXMucGVyZm9ybUdyYWNlZnVsU2h1dGRvd24oKTtcblx0XHR9KTtcblxuXHRcdHByb2Nlc3Mub24oJ3VuaGFuZGxlZFJlamVjdGlvbicsIChyZWFzb24sIHByb21pc2UpID0+IHtcblx0XHRcdGNvbnN0IHJlamVjdGlvbk1lc3NhZ2UgPSBgVW5oYW5kbGVkIHByb21pc2UgcmVqZWN0aW9uOiAke3JlYXNvbn1gO1xuXHRcdFx0dGhpcy5oYW5kbGVFcnJvcih7XG5cdFx0XHRcdGVycm9yOiBuZXcgRXJyb3IocmVqZWN0aW9uTWVzc2FnZSksXG5cdFx0XHRcdGRldGFpbHM6IHsgcmVhc29uLCBwcm9taXNlIH0sXG5cdFx0XHRcdGFjdGlvbjogJ3VuaGFuZGxlZFJlamVjdGlvbidcblx0XHRcdH0pO1xuXHRcdFx0Y29uc29sZS5lcnJvcihyZWplY3Rpb25NZXNzYWdlKTtcblx0XHR9KTtcblxuXHRcdHByb2Nlc3Mub24oJ3VuY2F1Z2h0RXhjZXB0aW9uJywgZXJyb3IgPT4ge1xuXHRcdFx0dGhpcy5oYW5kbGVDcml0aWNhbEVycm9yKHtcblx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdGRldGFpbHM6IHsgYWN0aW9uOiAndW5jYXVnaHRFeGNlcHRpb24nIH1cblx0XHRcdH0pO1xuXHRcdFx0Y29uc29sZS5lcnJvcignVW5jYXVnaHQgRXhjZXB0aW9uOicsIGVycm9yKTtcblx0XHRcdGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nKSB7XG5cdFx0XHRcdHByb2Nlc3MuZXhpdCgxKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXG5cdHB1YmxpYyBzZXRTaHV0ZG93bkhhbmRsZXIoc2h1dGRvd25GbjogKCkgPT4gUHJvbWlzZTx2b2lkPik6IHZvaWQge1xuXHRcdHRoaXMuc2h1dGRvd25GdW5jdGlvbiA9IHNodXRkb3duRm47XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIHBlcmZvcm1HcmFjZWZ1bFNodXRkb3duKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdHRyeSB7XG5cdFx0XHRpZiAodGhpcy5zaHV0ZG93bkZ1bmN0aW9uKSB7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmxvZ0luZm8oJ1BlcmZvcm1pbmcgZ3JhY2VmdWwgc2h1dGRvd24uLi4nKTtcblx0XHRcdFx0YXdhaXQgdGhpcy5zaHV0ZG93bkZ1bmN0aW9uKCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0aGlzLmxvZ2dlci5sb2dFcnJvcignU2h1dGRvd24gZnVuY3Rpb24gbm90IHNldC4nKTtcblx0XHRcdH1cblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5oYW5kbGVDcml0aWNhbEVycm9yKHtcblx0XHRcdFx0ZXJyb3IsXG5cdFx0XHRcdGRldGFpbHM6IHsgYWN0aW9uOiAnZ3JhY2VmdWxTaHV0ZG93bicgfVxuXHRcdFx0fSk7XG5cdFx0XHRwcm9jZXNzLmV4aXQoMSk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIHNodXRkb3duKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdHRoaXMubG9nZ2VyLmxvZ0luZm8oJ0luaXRpYXRpbmcgRXJyb3JIYW5kbGVyU2VydmljZSBzaHV0ZG93bi4uLicpO1xuXG5cdFx0aWYgKHRoaXMuc2h1dGRvd25GdW5jdGlvbikge1xuXHRcdFx0YXdhaXQgdGhpcy5zaHV0ZG93bkZ1bmN0aW9uKCk7XG5cdFx0XHR0aGlzLmxvZ2dlci5sb2dJbmZvKCdFcnJvciBIYW5kbGVyIHNodXRkb3duIGZ1bmN0aW9uIGNvbXBsZXRlZC4nKTtcblx0XHR9XG5cblx0XHR0aGlzLmxvZ2dlci5sb2dJbmZvKCdFcnJvckhhbmRsZXJTZXJ2aWNlIHNodXRkb3duIGNvbXBsZXRlZC4nKTtcblx0fVxufVxuIl19
