import {
	AppError,
	ErrorClasses,
	ErrorSeverity
} from '../errors/ErrorClasses.mjs';
import { v4 as uuidv4 } from 'uuid';
import { sanitizeRequestBody } from '../utils/validator.mjs';
export class ErrorHandlerService {
	static instance;
	ErrorClasses = ErrorClasses;
	ErrorSeverity = ErrorSeverity;
	logger;
	errorLogger;
	shutdownFunction = null;
	constructor(logger, errorLogger) {
		this.logger = logger;
		this.errorLogger = errorLogger;
	}
	static async getInstance(logger, errorLogger) {
		if (!ErrorHandlerService.instance) {
			ErrorHandlerService.instance = new ErrorHandlerService(
				logger,
				errorLogger
			);
			ErrorHandlerService.instance.initializeGlobalErrorHandlers();
		}
		return ErrorHandlerService.instance;
	}
	handleError(params) {
		const {
			error,
			req,
			details,
			severity = ErrorSeverity.RECOVERABLE,
			action = 'unknown',
			userId = null,
			sequelize
		} = params;
		let appError;
		if (error instanceof AppError) {
			appError = error;
		} else if (error instanceof Error) {
			appError = new AppError(error.message);
		} else {
			appError = new AppError(`Unknown error type encountered\n${error}`);
		}
		const errorDetails = this.errorLogger.getErrorDetails(
			() => 'handleError',
			action,
			req,
			userId,
			details
		);
		if (sequelize) {
			this.errorLogger.logAppError(appError, sequelize, errorDetails);
		} else {
			this.logger.logError('Error occurred.', errorDetails);
		}
		if (severity === ErrorSeverity.FATAL) {
			this.logger.logCritical('A fatal error occurred.', errorDetails);
		} else {
			this.logger.logError('A recoverable error occurred.', errorDetails);
		}
	}
	expressErrorHandler() {
		return (err, req, res, next) => {
			const responseId = uuidv4();
			let statusCode = err instanceof AppError ? err.statusCode : 500;
			let message = 'An unexpected error occurred';
			let errorCode = 'ERR_GENERIC';
			const logDetails = {
				responseId,
				method: req.method,
				url: req.url,
				ip: req.ip,
				headers: req.headers,
				query: req.query,
				body: req.body ? sanitizeRequestBody(req.body) : null
			};
			if (err instanceof AppError) {
				statusCode = err.statusCode ?? 500;
				message = err.message || message;
				errorCode = err.errorCode ?? errorCode;
				if (err.details?.retryAfter) {
					res.set('Retry-After', String(err.details.retryAfter));
				}
				this.handleError({
					error: err,
					req,
					details: {
						...logDetails,
						severity: err.severity ?? 'unknown',
						errorCode: err.errorCode ?? 'ERR_GENERIC'
					},
					severity: err.severity
				});
				res.status(statusCode).json({
					status: 'error',
					message: err.message,
					code: errorCode,
					details: err.details || null,
					responseId
				});
			} else if (err instanceof Error) {
				statusCode = 500;
				message = err.message || message;
				this.handleError({
					error: err,
					req,
					details: logDetails
				});
				res.status(statusCode).json({
					status: 'error',
					message,
					responseId
				});
			} else {
				this.handleError({
					error: new Error(`Unknown error: ${String(err)}`),
					req,
					details: logDetails
				});
				res.status(500).json({
					status: 'error',
					message: 'Unknown error occurred',
					responseId
				});
			}
			this.logger.logInfo(
				`Error response sent to client. Response ID: ${responseId} | Status Code: ${statusCode} | Message: ${message}`,
				logDetails
			);
			next();
		};
	}
	handleCriticalError(params) {
		const { error, req, details = {} } = params;
		const errorMessage =
			error instanceof Error ? error.message : String(error);
		const errorStack = error instanceof Error ? error.stack : undefined;
		const logDetails = {
			method: req?.method ?? 'Unknown method',
			url: req?.url ?? 'Unknown URL',
			ip: req?.ip ?? 'Unknown IP',
			...details
		};
		this.logger.logCritical(`CriticalError: ${errorMessage}`, {
			stack: errorStack,
			...logDetails
		});
		if (process.env.NODE_ENV === 'production') {
			process.exitCode = 1;
			setTimeout(() => process.exit(1), 1500);
		} else {
			this.errorLogger.logCritical(
				`Non-Prod environment: Critical error occurred\n${error}`
			);
			throw new Error(errorMessage);
		}
	}
	async sendClientErrorResponse({
		message,
		res,
		responseId,
		statusCode = 400
	}) {
		if (!responseId) {
			responseId = uuidv4();
		}
		res.status(statusCode).json({
			status: 'error',
			message,
			responseId
		});
		this.logger.logInfo(
			`Client error response sent. Response ID: ${responseId}\nMessage: ${message}`,
			{ statusCode, responseId }
		);
	}
	initializeGlobalErrorHandlers() {
		process.on('SIGINT', async () => {
			this.logger.logInfo('Received SIGINT. Gracefully shutting down...');
			await this.performGracefulShutdown();
		});
		process.on('SIGTERM', async () => {
			this.logger.logInfo(
				'Received SIGTERM. Gracefully shutting down...'
			);
			await this.performGracefulShutdown();
		});
		process.on('unhandledRejection', (reason, promise) => {
			const rejectionMessage = `Unhandled promise rejection: ${reason}`;
			this.handleError({
				error: new Error(rejectionMessage),
				details: { reason, promise },
				action: 'unhandledRejection'
			});
			console.error(rejectionMessage);
		});
		process.on('uncaughtException', error => {
			this.handleCriticalError({
				error,
				details: { action: 'uncaughtException' }
			});
			console.error('Uncaught Exception:', error);
			if (process.env.NODE_ENV === 'production') {
				process.exit(1);
			}
		});
	}
	setShutdownHandler(shutdownFn) {
		this.shutdownFunction = shutdownFn;
	}
	async performGracefulShutdown() {
		try {
			if (this.shutdownFunction) {
				this.logger.logInfo('Performing graceful shutdown...');
				await this.shutdownFunction();
			} else {
				this.logger.logError('Shutdown function not set.');
			}
		} catch (error) {
			this.handleCriticalError({
				error,
				details: { action: 'gracefulShutdown' }
			});
			process.exit(1);
		}
	}
	async shutdown() {
		this.logger.logInfo('Initiating ErrorHandlerService shutdown...');
		if (this.shutdownFunction) {
			await this.shutdownFunction();
			this.logger.logInfo('Error Handler shutdown function completed.');
		}
		this.logger.logInfo('ErrorHandlerService shutdown completed.');
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXJyb3JIYW5kbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3NlcnZpY2VzL0Vycm9ySGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ04sUUFBUSxFQUVSLFlBQVksRUFDWixhQUFhLEVBRWIsTUFBTSx3QkFBd0IsQ0FBQztBQU9oQyxPQUFPLEVBQUUsRUFBRSxJQUFJLE1BQU0sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUVwQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUV6RCxNQUFNLE9BQU8sbUJBQW1CO0lBQ3ZCLE1BQU0sQ0FBQyxRQUFRLENBQXNCO0lBQ3RDLFlBQVksR0FBRyxZQUFZLENBQUM7SUFDNUIsYUFBYSxHQUFHLGFBQWEsQ0FBQztJQUM3QixNQUFNLENBQTRCO0lBQ2xDLFdBQVcsQ0FBOEI7SUFDekMsZ0JBQWdCLEdBQWlDLElBQUksQ0FBQztJQUU5RCxZQUNDLE1BQWlDLEVBQ2pDLFdBQXdDO1FBRXhDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO0lBQ2hDLENBQUM7SUFFTSxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FDOUIsTUFBaUMsRUFDakMsV0FBd0M7UUFFeEMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ25DLG1CQUFtQixDQUFDLFFBQVEsR0FBRyxJQUFJLG1CQUFtQixDQUNyRCxNQUFNLEVBQ04sV0FBVyxDQUNYLENBQUM7WUFDRixtQkFBbUIsQ0FBQyxRQUFRLENBQUMsNkJBQTZCLEVBQUUsQ0FBQztRQUM5RCxDQUFDO1FBQ0QsT0FBTyxtQkFBbUIsQ0FBQyxRQUFRLENBQUM7SUFDckMsQ0FBQztJQUVNLFdBQVcsQ0FBQyxNQVFsQjtRQUNBLE1BQU0sRUFDTCxLQUFLLEVBQ0wsR0FBRyxFQUNILE9BQU8sRUFDUCxRQUFRLEdB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SSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsaUNBQWlDLENBQUMsQ0FBQztnQkFDdkQsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUMvQixDQUFDO2lCQUFNLENBQUM7Z0JBQ1AsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsNEJBQTRCLENBQUMsQ0FBQztZQUNwRCxDQUFDO1FBQ0YsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDaEIsSUFBSSxDQUFDLG1CQUFtQixDQUFDO2dCQUN4QixLQUFLO2dCQUNMLE9BQU8sRUFBRSxFQUFFLE1BQU0sRUFBRSxrQkFBa0IsRUFBRTthQUN2QyxDQUFDLENBQUM7WUFDSCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pCLENBQUM7SUFDRixDQUFDO0lBRU0sS0FBSyxDQUFDLFFBQVE7UUFDcEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsNENBQTRDLENBQUMsQ0FBQztRQUVsRSxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQzNCLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDOUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsNENBQTRDLENBQUMsQ0FBQztRQUNuRSxDQUFDO1FBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMseUNBQXlDLENBQUMsQ0FBQztJQUNoRSxDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuXHRBcHBFcnJvcixcblx0Q2xpZW50RXJyb3IsXG5cdEVycm9yQ2xhc3Nlcyxcblx0RXJyb3JTZXZlcml0eSxcblx0RXJyb3JTZXZlcml0eVR5cGVcbn0gZnJvbSAnLi4vZXJyb3JzL0Vycm9yQ2xhc3Nlcyc7XG5pbXBvcnQgeyBOZXh0RnVuY3Rpb24sIFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQge1xuXHRBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2Vcbn0gZnJvbSAnLi4vaW5kZXgvaW50ZXJmYWNlcy9tYWluJztcbmltcG9ydCB7IHY0IGFzIHV1aWR2NCB9IGZyb20gJ3V1aWQnO1xuaW1wb3J0IHsgU2VxdWVsaXplIH0gZnJvbSAnc2VxdWVsaXplJztcbmltcG9ydCB7IHNhbml0aXplUmVxdWVzdEJvZHkgfSBmcm9tICcuLi91dGlscy92YWxpZGF0b3InO1xuXG5leHBvcnQgY2xhc3MgRXJyb3JIYW5kbGVyU2VydmljZSBpbXBsZW1lbnRzIEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2Uge1xuXHRwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTogRXJyb3JIYW5kbGVyU2VydmljZTtcblx0cHVibGljIEVycm9yQ2xhc3NlcyA9IEVycm9yQ2xhc3Nlcztcblx0cHVibGljIEVycm9yU2V2ZXJpdHkgPSBFcnJvclNldmVyaXR5O1xuXHRwcml2YXRlIGxvZ2dlcjogQXBwTG9nZ2VyU2VydmljZUludGVyZmFjZTtcblx0cHJpdmF0ZSBlcnJvckxvZ2dlcjogRXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcml2YXRlIHNodXRkb3duRnVuY3Rpb246ICgoKSA9PiBQcm9taXNlPHZvaWQ+KSB8IG51bGwgPSBudWxsO1xuXG5cdHByaXZhdGUgY29uc3RydWN0b3IoXG5cdFx0bG9nZ2VyOiBBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGVycm9yTG9nZ2VyOiBFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2Vcblx0KSB7XG5cdFx0dGhpcy5sb2dnZXIgPSBsb2dnZXI7XG5cdFx0dGhpcy5lcnJvckxvZ2dlciA9IGVycm9yTG9nZ2VyO1xuXHR9XG5cblx0cHVibGljIHN0YXRpYyBhc3luYyBnZXRJbnN0YW5jZShcblx0XHRsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0ZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZVxuXHQpOiBQcm9taXNlPEVycm9ySGFuZGxlclNlcnZpY2U+IHtcblx0XHRpZiAoIUVycm9ySGFuZGxlclNlcnZpY2UuaW5zdGFuY2UpIHtcblx0XHRcdEVycm9ySGFuZGxlclNlcnZpY2UuaW5zdGFuY2UgPSBuZXcgRXJyb3JIYW5kbGVyU2VydmljZShcblx0XHRcdFx0bG9nZ2VyLFxuXHRcdFx0XHRlcnJvckxvZ2dlclxuXHRcdFx0KTtcblx0XHRcdEVycm9ySGFuZGxlclNlcnZpY2UuaW5zdGFuY2UuaW5pdGlhbGl6ZUdsb2JhbEVycm9ySGFuZGxlcnMoKTtcblx0XHR9XG5cdFx0cmV0dXJuIEVycm9ySGFuZGxlclNlcnZpY2UuaW5zdGFuY2U7XG5cdH1cblxuXHRwdWJsaWMgaGFuZGxlRXJyb3IocGFyYW1zOiB7XG5cdFx0ZXJyb3I6IHVua25vd247XG5cdFx0cmVxPzogUmVxdWVzdDtcblx0XHRkZXRhaWxzPzogUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG5cdFx0c2V2ZXJpdHk/OiBFcnJvclNldmVyaXR5VHlwZTtcblx0XHRhY3Rpb24/OiBzdHJpbmc7XG5cdFx0dXNlcklkPzogc3RyaW5nO1xuXHRcdHNlcXVlbGl6ZT86IFNlcXVlbGl6ZTtcblx0fSk6IHZvaWQge1xuXHRcdGNvbnN0IHtcblx0XHRcdGVycm9yLFxuXHRcdFx0cmVxLFxuXHRcdFx0ZGV0YWlscyxcblx0XHRcdHNldmVyaXR5ID0gRXJyb3JTZXZlcml0eS5SRUNPVkVSQUJMRSxcblx0XHRcdGFjdGlvbiA9ICd1bmtub3duJyxcblx0XHRcdHVzZXJJZCA9IG51bGwsXG5cdFx0XHRzZXF1ZWxpemVcblx0XHR9ID0gcGFyYW1zO1xuXG5cdFx0bGV0IGFwcEVycm9yOiBBcHBFcnJvcjtcblxuXHRcdGlmIChlcnJvciBpbnN0YW5jZW9mIEFwcEVycm9yKSB7XG5cdFx0XHRhcHBFcnJvciA9IGVycm9yO1xuXHRcdH0gZWxzZSBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcikge1xuXHRcdFx0YXBwRXJyb3IgPSBuZXcgQXBwRXJyb3IoZXJyb3IubWVzc2FnZSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGFwcEVycm9yID0gbmV3IEFwcEVycm9yKGBVbmtub3duIGVycm9yIHR5cGUgZW5jb3VudGVyZWRcXG4ke2Vycm9yfWApO1xuXHRcdH1cblxuXHRcdGNvbnN0IGVycm9yRGV0YWlscyA9IHRoaXMuZXJyb3JMb2dnZXIuZ2V0RXJyb3JEZXRhaWxzKFxuXHRcdFx0KCkgPT4gJ2hhbmRsZUVycm9yJyxcblx0XHRcdGFjdGlvbixcblx0XHRcdHJlcSxcblx0XHRcdHVzZXJJZCxcblx0XHRcdGRldGFpbHNcblx0XHQpO1xuXG5cdFx0aWYgKHNlcXVlbGl6ZSkge1xuXHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dBcHBFcnJvcihhcHBFcnJvciwgc2VxdWVsaXplLCBlcnJvckRldGFpbHMpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR0aGlzLmxvZ2dlci5sb2dFcnJvcignRXJyb3Igb2NjdXJyZWQuJywgZXJyb3JEZXRhaWxzKTtcblx0XHR9XG5cblx0XHRpZiAoc2V2ZXJpdHkgPT09IEVycm9yU2V2ZXJpdHkuRkFUQUwpIHtcblx0XHRcdHRoaXMubG9nZ2VyLmxvZ0NyaXRpY2FsKCdBIGZhdGFsIGVycm9yIG9jY3VycmVkLicsIGVycm9yRGV0YWlscyk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRoaXMubG9nZ2VyLmxvZ0Vycm9yKCdBIHJlY292ZXJhYmxlIGVycm9yIG9jY3VycmVkLicsIGVycm9yRGV0YWlscyk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGV4cHJlc3NFcnJvckhhbmRsZXIoKSB7XG5cdFx0cmV0dXJuIChcblx0XHRcdGVycjogQXBwRXJyb3IgfCBDbGllbnRFcnJvciB8IEVycm9yIHwgUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG5cdFx0XHRyZXE6IFJlcXVlc3QsXG5cdFx0XHRyZXM6IFJlc3BvbnNlLFxuXHRcdFx0bmV4dDogTmV4dEZ1bmN0aW9uXG5cdFx0KTogdm9pZCA9PiB7XG5cdFx0XHRjb25zdCByZXNwb25zZUlkID0gdXVpZHY0KCk7XG5cdFx0XHRsZXQgc3RhdHVzQ29kZSA9IGVyciBpbnN0YW5jZW9mIEFwcEVycm9yID8gZXJyLnN0YXR1c0NvZGUgOiA1MDA7XG5cdFx0XHRsZXQgbWVzc2FnZSA9ICdBbiB1bmV4cGVjdGVkIGVycm9yIG9jY3VycmVkJztcblx0XHRcdGxldCBlcnJvckNvZGUgPSAnRVJSX0dFTkVSSUMnO1xuXG5cdFx0XHRjb25zdCBsb2dEZXRhaWxzID0ge1xuXHRcdFx0XHRyZXNwb25zZUlkLFxuXHRcdFx0XHRtZXRob2Q6IHJlcS5tZXRob2QsXG5cdFx0XHRcdHVybDogcmVxLnVybCxcblx0XHRcdFx0aXA6IHJlcS5pcCxcblx0XHRcdFx0aGVhZGVyczogcmVxLmhlYWRlcnMsXG5cdFx0XHRcdHF1ZXJ5OiByZXEucXVlcnksXG5cdFx0XHRcdGJvZHk6IHJlcS5ib2R5ID8gc2FuaXRpemVSZXF1ZXN0Qm9keShyZXEuYm9keSkgOiBudWxsXG5cdFx0XHR9O1xuXG5cdFx0XHRpZiAoZXJyIGluc3RhbmNlb2YgQXBwRXJyb3IpIHtcblx0XHRcdFx0c3RhdHVzQ29kZSA9IGVyci5zdGF0dXNDb2RlID8/IDUwMDtcblx0XHRcdFx0bWVzc2FnZSA9IGVyci5tZXNzYWdlIHx8IG1lc3NhZ2U7XG5cdFx0XHRcdGVycm9yQ29kZSA9IGVyci5lcnJvckNvZGUgPz8gZXJyb3JDb2RlO1xuXG5cdFx0XHRcdGlmIChlcnIuZGV0YWlscz8ucmV0cnlBZnRlcikge1xuXHRcdFx0XHRcdHJlcy5zZXQoJ1JldHJ5LUFmdGVyJywgU3RyaW5nKGVyci5kZXRhaWxzLnJldHJ5QWZ0ZXIpKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdHRoaXMuaGFuZGxlRXJyb3Ioe1xuXHRcdFx0XHRcdGVycm9yOiBlcnIsXG5cdFx0XHRcdFx0cmVxLFxuXHRcdFx0XHRcdGRldGFpbHM6IHtcblx0XHRcdFx0XHRcdC4uLmxvZ0RldGFpbHMsXG5cdFx0XHRcdFx0XHRzZXZlcml0eTogZXJyLnNldmVyaXR5ID8/ICd1bmtub3duJyxcblx0XHRcdFx0XHRcdGVycm9yQ29kZTogZXJyLmVycm9yQ29kZSA/PyAnRVJSX0dFTkVSSUMnXG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRzZXZlcml0eTogZXJyLnNldmVyaXR5XG5cdFx0XHRcdH0pO1xuXG5cdFx0XHRcdHJlcy5zdGF0dXMoc3RhdHVzQ29kZSkuanNvbih7XG5cdFx0XHRcdFx0c3RhdHVzOiAnZXJyb3InLFxuXHRcdFx0XHRcdG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuXHRcdFx0XHRcdGNvZGU6IGVycm9yQ29kZSxcblx0XHRcdFx0XHRkZXRhaWxzOiBlcnIuZGV0YWlscyB8fCBudWxsLFxuXHRcdFx0XHRcdHJlc3BvbnNlSWRcblx0XHRcdFx0fSk7XG5cdFx0XHR9IGVsc2UgaWYgKGVyciBpbnN0YW5jZW9mIEVycm9yKSB7XG5cdFx0XHRcdHN0YXR1c0NvZGUgPSA1MDA7XG5cdFx0XHRcdG1lc3NhZ2UgPSBlcnIubWVzc2FnZSB8fCBtZXNzYWdlO1xuXG5cdFx0XHRcdHRoaXMuaGFuZGxlRXJyb3Ioe1xuXHRcdFx0XHRcdGVycm9yOiBlcnIsXG5cdFx0XHRcdFx0cmVxLFxuXHRcdFx0XHRcdGRldGFpbHM6IGxvZ0RldGFpbHNcblx0XHRcdFx0fSk7XG5cblx0XHRcdFx0cmVzLnN0YXR1cyhzdGF0dXNDb2RlKS5qc29uKHtcblx0XHRcdFx0XHRzdGF0dXM6ICdlcnJvcicsXG5cdFx0XHRcdFx0bWVzc2FnZSxcblx0XHRcdFx0XHRyZXNwb25zZUlkXG5cdFx0XHRcdH0pO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhpcy5oYW5kbGVFcnJvcih7XG5cdFx0XHRcdFx0ZXJyb3I6IG5ldyBFcnJvcihgVW5rbm93biBlcnJvcjogJHtTdHJpbmcoZXJyKX1gKSxcblx0XHRcdFx0XHRyZXEsXG5cdFx0XHRcdFx0ZGV0YWlsczogbG9nRGV0YWlsc1xuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHRyZXMuc3RhdHVzKDUwMCkuanNvbih7XG5cdFx0XHRcdFx0c3RhdHVzOiAnZXJyb3InLFxuXHRcdFx0XHRcdG1lc3NhZ2U6ICdVbmtub3duIGVycm9yIG9jY3VycmVkJyxcblx0XHRcdFx0XHRyZXNwb25zZUlkXG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXG5cdFx0XHR0aGlzLmxvZ2dlci5sb2dJbmZvKFxuXHRcdFx0XHRgRXJyb3IgcmVzcG9uc2Ugc2VudCB0byBjbGllbnQuIFJlc3BvbnNlIElEOiAke3Jlc3BvbnNlSWR9IHwgU3RhdHVzIENvZGU6ICR7c3RhdHVzQ29kZX0gfCBNZXNzYWdlOiAke21lc3NhZ2V9YCxcblx0XHRcdFx0bG9nRGV0YWlsc1xuXHRcdFx0KTtcblxuXHRcdFx0bmV4dCgpO1xuXHRcdH07XG5cdH1cblxuXHRwdWJsaWMgaGFuZGxlQ3JpdGljYWxFcnJvcihwYXJhbXM6IHtcblx0XHRlcnJvcjogdW5rbm93bjtcblx0XHRyZXE/OiBSZXF1ZXN0O1xuXHRcdGRldGFpbHM/OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcblx0fSk6IHZvaWQge1xuXHRcdGNvbnN0IHsgZXJyb3IsIHJlcSwgZGV0YWlscyA9IHt9IH0gPSBwYXJhbXM7XG5cdFx0Y29uc3QgZXJyb3JNZXNzYWdlID1cblx0XHRcdGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKTtcblx0XHRjb25zdCBlcnJvclN0YWNrID0gZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLnN0YWNrIDogdW5kZWZpbmVkO1xuXG5cdFx0Y29uc3QgbG9nRGV0YWlscyA9IHtcblx0XHRcdG1ldGhvZDogcmVxPy5tZXRob2QgPz8gJ1Vua25vd24gbWV0aG9kJyxcblx0XHRcdHVybDogcmVxPy51cmwgPz8gJ1Vua25vd24gVVJMJyxcblx0XHRcdGlwOiByZXE/LmlwID8/ICdVbmtub3duIElQJyxcblx0XHRcdC4uLmRldGFpbHNcblx0XHR9O1xuXG5cdFx0dGhpcy5sb2dnZXIubG9nQ3JpdGljYWwoYENyaXRpY2FsRXJyb3I6ICR7ZXJyb3JNZXNzYWdlfWAsIHtcblx0XHRcdHN0YWNrOiBlcnJvclN0YWNrLFxuXHRcdFx0Li4ubG9nRGV0YWlsc1xuXHRcdH0pO1xuXG5cdFx0aWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicpIHtcblx0XHRcdHByb2Nlc3MuZXhpdENvZGUgPSAxO1xuXHRcdFx0c2V0VGltZW91dCgoKSA9PiBwcm9jZXNzLmV4aXQoMSksIDE1MDApO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0NyaXRpY2FsKFxuXHRcdFx0XHRgTm9uLVByb2QgZW52aXJvbm1lbnQ6IENyaXRpY2FsIGVycm9yIG9jY3VycmVkXFxuJHtlcnJvcn1gXG5cdFx0XHQpO1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGVycm9yTWVzc2FnZSk7XG5cdFx0fVxuXHR9XG5cblx0cHVibGljIGFzeW5jIHNlbmRDbGllbnRFcnJvclJlc3BvbnNlKHtcblx0XHRtZXNzYWdlLFxuXHRcdHJlcyxcblx0XHRyZXNwb25zZUlkLFxuXHRcdHN0YXR1c0NvZGUgPSA0MDBcblx0fToge1xuXHRcdG1lc3NhZ2U6IHN0cmluZztcblx0XHRzdGF0dXNDb2RlPzogbnVtYmVyO1xuXHRcdHJlczogUmVzcG9uc2U7XG5cdFx0cmVzcG9uc2VJZD86IHN0cmluZztcblx0fSk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGlmICghcmVzcG9uc2VJZCkge1xuXHRcdFx0cmVzcG9uc2VJZCA9IHV1aWR2NCgpO1xuXHRcdH1cblxuXHRcdHJlcy5zdGF0dXMoc3RhdHVzQ29kZSkuanNvbih7XG5cdFx0XHRzdGF0dXM6ICdlcnJvcicsXG5cdFx0XHRtZXNzYWdlLFxuXHRcdFx0cmVzcG9uc2VJZFxuXHRcdH0pO1xuXG5cdFx0dGhpcy5sb2dnZXIubG9nSW5mbyhcblx0XHRcdGBDbGllbnQgZXJyb3IgcmVzcG9uc2Ugc2VudC4gUmVzcG9uc2UgSUQ6ICR7cmVzcG9uc2VJZH1cXG5NZXNzYWdlOiAke21lc3NhZ2V9YCxcblx0XHRcdHsgc3RhdHVzQ29kZSwgcmVzcG9uc2VJZCB9XG5cdFx0KTtcblx0fVxuXG5cdHB1YmxpYyBpbml0aWFsaXplR2xvYmFsRXJyb3JIYW5kbGVycygpOiB2b2lkIHtcblx0XHRwcm9jZXNzLm9uKCdTSUdJTlQnLCBhc3luYyAoKSA9PiB7XG5cdFx0XHR0aGlzLmxvZ2dlci5sb2dJbmZvKCdSZWNlaXZlZCBTSUdJTlQuIEdyYWNlZnVsbHkgc2h1dHRpbmcgZG93bi4uLicpO1xuXHRcdFx0YXdhaXQgdGhpcy5wZXJmb3JtR3JhY2VmdWxTaHV0ZG93bigpO1xuXHRcdH0pO1xuXG5cdFx0cHJvY2Vzcy5vbignU0lHVEVSTScsIGFzeW5jICgpID0+IHtcblx0XHRcdHRoaXMubG9nZ2VyLmxvZ0luZm8oXG5cdFx0XHRcdCdSZWNlaXZlZCBTSUdURVJNLiBHcmFjZWZ1bGx5IHNodXR0aW5nIGRvd24uLi4nXG5cdFx0XHQpO1xuXHRcdFx0YXdhaXQgdGhpcy5wZXJmb3JtR3JhY2VmdWxTaHV0ZG93bigpO1xuXHRcdH0pO1xuXG5cdFx0cHJvY2Vzcy5vbigndW5oYW5kbGVkUmVqZWN0aW9uJywgKHJlYXNvbiwgcHJvbWlzZSkgPT4ge1xuXHRcdFx0Y29uc3QgcmVqZWN0aW9uTWVzc2FnZSA9IGBVbmhhbmRsZWQgcHJvbWlzZSByZWplY3Rpb246ICR7cmVhc29ufWA7XG5cdFx0XHR0aGlzLmhhbmRsZUVycm9yKHtcblx0XHRcdFx0ZXJyb3I6IG5ldyBFcnJvcihyZWplY3Rpb25NZXNzYWdlKSxcblx0XHRcdFx0ZGV0YWlsczogeyByZWFzb24sIHByb21pc2UgfSxcblx0XHRcdFx0YWN0aW9uOiAndW5oYW5kbGVkUmVqZWN0aW9uJ1xuXHRcdFx0fSk7XG5cdFx0XHRjb25zb2xlLmVycm9yKHJlamVjdGlvbk1lc3NhZ2UpO1xuXHRcdH0pO1xuXG5cdFx0cHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb24nLCBlcnJvciA9PiB7XG5cdFx0XHR0aGlzLmhhbmRsZUNyaXRpY2FsRXJyb3Ioe1xuXHRcdFx0XHRlcnJvcixcblx0XHRcdFx0ZGV0YWlsczogeyBhY3Rpb246ICd1bmNhdWdodEV4Y2VwdGlvbicgfVxuXHRcdFx0fSk7XG5cdFx0XHRjb25zb2xlLmVycm9yKCdVbmNhdWdodCBFeGNlcHRpb246JywgZXJyb3IpO1xuXHRcdFx0aWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicpIHtcblx0XHRcdFx0cHJvY2Vzcy5leGl0KDEpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cblx0cHVibGljIHNldFNodXRkb3duSGFuZGxlcihzaHV0ZG93bkZuOiAoKSA9PiBQcm9taXNlPHZvaWQ+KTogdm9pZCB7XG5cdFx0dGhpcy5zaHV0ZG93bkZ1bmN0aW9uID0gc2h1dGRvd25Gbjtcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgcGVyZm9ybUdyYWNlZnVsU2h1dGRvd24oKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGlmICh0aGlzLnNodXRkb3duRnVuY3Rpb24pIHtcblx0XHRcdFx0dGhpcy5sb2dnZXIubG9nSW5mbygnUGVyZm9ybWluZyBncmFjZWZ1bCBzaHV0ZG93bi4uLicpO1xuXHRcdFx0XHRhd2FpdCB0aGlzLnNodXRkb3duRnVuY3Rpb24oKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmxvZ0Vycm9yKCdTaHV0ZG93biBmdW5jdGlvbiBub3Qgc2V0LicpO1xuXHRcdFx0fVxuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmhhbmRsZUNyaXRpY2FsRXJyb3Ioe1xuXHRcdFx0XHRlcnJvcixcblx0XHRcdFx0ZGV0YWlsczogeyBhY3Rpb246ICdncmFjZWZ1bFNodXRkb3duJyB9XG5cdFx0XHR9KTtcblx0XHRcdHByb2Nlc3MuZXhpdCgxKTtcblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgYXN5bmMgc2h1dGRvd24oKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dGhpcy5sb2dnZXIubG9nSW5mbygnSW5pdGlhdGluZyBFcnJvckhhbmRsZXJTZXJ2aWNlIHNodXRkb3duLi4uJyk7XG5cblx0XHRpZiAodGhpcy5zaHV0ZG93bkZ1bmN0aW9uKSB7XG5cdFx0XHRhd2FpdCB0aGlzLnNodXRkb3duRnVuY3Rpb24oKTtcblx0XHRcdHRoaXMubG9nZ2VyLmxvZ0luZm8oJ0Vycm9yIEhhbmRsZXIgc2h1dGRvd24gZnVuY3Rpb24gY29tcGxldGVkLicpO1xuXHRcdH1cblxuXHRcdHRoaXMubG9nZ2VyLmxvZ0luZm8oJ0Vycm9ySGFuZGxlclNlcnZpY2Ugc2h1dGRvd24gY29tcGxldGVkLicpO1xuXHR9XG59XG4iXX0=
