import process from 'process';
import { login } from './admin.mjs';
import { ServiceFactory } from './index/factory.mjs';
import { VaultService } from './services/Vault.mjs';
let app;
let logger;
async function start() {
	try {
		return login()
			.then(async ({ encryptionKey, gpgPassphrase, adminId }) => {
				if (!encryptionKey || !gpgPassphrase || !adminId) {
					throw new Error(
						'Keys or Admin ID not found. Shutting down...'
					);
				}
				const logger = await ServiceFactory.getLoggerService();
				const errorLogger =
					await ServiceFactory.getErrorLoggerService();
				logger.setAdminId(adminId);
				const errorHandler =
					await ServiceFactory.getErrorHandlerService();
				logger.setErrorHandler(errorHandler);
				const envConfig = await ServiceFactory.getEnvConfigService();
				const vault = await VaultService.initialize(
					encryptionKey,
					gpgPassphrase
				);
				setInterval(
					() => vault.clearExpiredSecretsFromMemory(),
					envConfig.getEnvVariable('clearExpiredSecretsInterval')
				);
				setInterval(
					() => vault.batchClearSecrets(),
					envConfig.getEnvVariable('batchReEncryptSecretsInterval')
				);
				logger.info(
					'Secrets store initialized. READY TO ROCK AND ROLL!!!'
				);
				return { envConfig, errorLogger, errorHandler, logger, vault };
			})
			.then(async () => {
				const middlewareStatusService =
					await ServiceFactory.getMiddlewareStatusService();
				return middlewareStatusService;
			})
			.then(async () => {
				const rootMiddleware =
					await ServiceFactory.getRootMiddlewareService();
				rootMiddleware.initialize();
				return rootMiddleware;
			})
			.then(async () => {
				const databaseController =
					await ServiceFactory.getDatabaseController();
				databaseController.initialize();
				return databaseController;
			})
			.then(async () => {
				const [cacheService, redisService] = await Promise.all([
					ServiceFactory.getCacheService(),
					ServiceFactory.getRedisService()
				]);
				return { cacheService, redisService };
			})
			.then(async () => {
				const gatekeeper = await ServiceFactory.getGatekeeperService();
				return gatekeeper.initialize();
			})
			.then(async () => {
				const accessControl =
					await ServiceFactory.getAccessControlMiddlewareService();
				return accessControl;
			})
			.then(async () => {
				const baseRouter = await ServiceFactory.getBaseRouter();
				return baseRouter;
			})
			.then(async () => {
				const userController = await ServiceFactory.getUserController();
				return userController;
			})
			.then(async () => {
				const authController = await ServiceFactory.getAuthController();
				return authController;
			})
			.then(async () => {
				const [
					backupCodeService,
					emailMFAService,
					fido2Service,
					jwtService,
					passportService,
					passwordService,
					totpService,
					yubicoOTPService
				] = await Promise.all([
					ServiceFactory.getBackupCodeService(),
					ServiceFactory.getEmailMFAService(),
					ServiceFactory.getFIDO2Service(),
					ServiceFactory.getJWTService(),
					ServiceFactory.getPassportService(),
					ServiceFactory.getPasswordService(),
					ServiceFactory.getTOTPService(),
					ServiceFactory.getYubicoOTPService()
				]);
				return {
					backupCodeService,
					emailMFAService,
					fido2Service,
					jwtService,
					passportService,
					passwordService,
					totpService,
					yubicoOTPService
				};
			})
			.then(async () => {
				const [
					csrfMiddleware,
					helmetMiddleware,
					jwtAuthMiddleware,
					passportAuthMiddleware
				] = await Promise.all([
					ServiceFactory.getCSRFMiddlewareService(),
					ServiceFactory.getHelmetMiddlewareService(),
					ServiceFactory.getJWTAuthMiddlewareService(),
					ServiceFactory.getPassportAuthMiddlewareService()
				]);
				return {
					csrfMiddleware,
					helmetMiddleware,
					jwtAuthMiddleware,
					passportAuthMiddleware
				};
			})
			.then(async () => {
				const [mailerService, multerUploadService] = await Promise.all([
					ServiceFactory.getMailerService(),
					ServiceFactory.getMulterUploadService()
				]);
				return {
					mailerService,
					multerUploadService
				};
			})
			.then(async () => {
				const httpsServer = await ServiceFactory.getHTTPSServer(app);
				return httpsServer.startServer();
			})
			.then(async () => {
				const resourceManager =
					await ServiceFactory.getResourceManager();
				return resourceManager;
			})
			.then(async () => {
				const healthCheckService =
					await ServiceFactory.getHealthCheckService();
				return healthCheckService;
			})
			.then(async () => {
				logger.info('All services initialized successfully.');
			})
			.catch(error => {
				const fallbackLogger = logger;
				if (!fallbackLogger) {
					console.error(
						`Critical error occurred during startup\n${error instanceof Error ? error.message : String(error)}`
					);
					process.exit(1);
				} else {
					fallbackLogger.error(
						`Critical error occurred during startup\n${error instanceof Error ? error.message : String(error)}`
					);
					process.exit(1);
				}
			});
	} catch (error) {
		const fallbackLogger = await ServiceFactory.getLoggerService();
		if (!fallbackLogger) {
			console.error(
				`Critical error occurred during startup\n${error instanceof Error ? error.message : String(error)}`
			);
			process.exit(1);
		} else {
			fallbackLogger.logError(
				`Critical error occurred during startup\n${error instanceof Error ? error.message : String(error)}`
			);
			process.exit(1);
		}
	}
}
await start();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2FwcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLE9BQU8sTUFBTSxTQUFTLENBQUM7QUFDOUIsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNoQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDakQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBSWhELElBQUksR0FBZ0IsQ0FBQztBQUNyQixJQUFJLE1BQWlDLENBQUM7QUFFdEMsS0FBSyxVQUFVLEtBQUs7SUFDbkIsSUFBSSxDQUFDO1FBQ0osT0FBTyxLQUFLLEVBQUU7YUFDWixJQUFJLENBQUMsS0FBSyxFQUFFLEVBQUUsYUFBYSxFQUFFLGFBQWEsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFO1lBQ3pELElBQUksQ0FBQyxhQUFhLElBQUksQ0FBQyxhQUFhLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDbEQsTUFBTSxJQUFJLEtBQUssQ0FDZCw4Q0FBOEMsQ0FDOUMsQ0FBQztZQUNILENBQUM7WUFFRCxNQUFNLE1BQU0sR0FBRyxNQUFNLGNBQWMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3ZELE1BQU0sV0FBVyxHQUNoQixNQUFNLGNBQWMsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1lBRTlDLE1BQU0sQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFM0IsTUFBTSxZQUFZLEdBQ2pCLE1BQU0sY0FBYyxDQUFDLHNCQUFzQixFQUFFLENBQUM7WUFFL0MsTUFBTSxDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUVyQyxNQUFNLFNBQVMsR0FBRyxNQUFNLGNBQWMsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1lBRTdELE1BQU0sS0FBSyxHQUFHLE1BQU0sWUFBWSxDQUFDLFVBQVUsQ0FDMUMsYUFBYSxFQUNiLGFBQWEsQ0FDYixDQUFDO1lBRUYsV0FBVyxDQUNWLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyw2QkFBNkIsRUFBRSxFQUMzQyxTQUFTLENBQUMsY0FBYyxDQUFDLDZCQUE2QixDQUFDLENBQ3ZELENBQUM7WUFDRixXQUFXLENBQ1YsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLGlCQUFpQixFQUFFLEVBQy9CLFNBQVMsQ0FBQyxjQUFjLENBQUMsK0JBQStCLENBQUMsQ0FDekQsQ0FBQztZQUVGLE1BQU0sQ0FBQyxJQUFJLENBQ1Ysc0RBQXNELENBQ3RELENBQUM7WUFDRixPQUFPLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDO1FBQ2hFLENBQUMsQ0FBQzthQUNELElBQUksQ0FBQyxLQUFLLElBQUksRUFBRTtZQUNoQixNQUFNLHVCQUF1QixHQUM1QixNQUFNLGNBQWMsQ0FBQywwQkFBMEIsRUFBRSxDQUFDO1lBQ25ELE9BQU8sdUJBQXVCLENBQUM7UUFDaEMsQ0FBQyxDQUFDO2FBQ0QsSUFBSSxDQUFDLEtBQUssSUFBSSxFQUFFO1lBQ2hCLE1BQU0sY0FBYyxHQUNuQixNQUFNLGNBQWMsQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO1lBQ2pELGNBQWMsQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUM1QixPQUFPLGNBQWMsQ0FBQztRQUN2QixDQUFDLENBQUM7YUFDRCxJQUFJLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDaEIsTUFBTSxrQkFBa0IsR0FDdkIsTUFBTSxjQUFjLENBQUMscUJBQXFCLEVBQUUsQ0FBQztZQUM5QyxrQkFBa0IsQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUNoQyxPQUFPLGtCQUFrQixDQUFDO1FBQzNCLENBQUMsQ0FBQzthQUNELElBQUksQ0FBQyxLQUFLLElBQUksRUFBRTtZQUNoQixNQUFNLENBQUMsWUFBWSxFQUFFLFlBQVksQ0FBQyxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQztnQkFDdEQsY0FBYyxDQUFDLGVBQWUsRUFBRTtnQkFDaEMsY0FBYyxDQUFDLGVBQWUsRUFBRTthQUNoQyxDQUFDLENBQUM7WUFDSCxPQUFPLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxDQUFDO1FBQ3ZDLENBQUMsQ0FBQzthQUNELElBQUksQ0FBQyxLQUFLLElBQUksRUFBRTtZQUNoQixNQUFNLFVBQVUsR0FBRyxNQUFNLGNBQWMsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1lBQy9ELE9BQU8sVUFBVSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ2hDLENBQUMsQ0FBQzthQUNELElBQUksQ0FBQyxLQUFLLElBQUksRUFBRTtZQUNoQixNQUFNLGFBQWEsR0FDbEIsTUFBTSxjQUFjLENBQUMsaUNBQWlDLEVBQUUsQ0FBQztZQUMxRCxPQUFPLGFBQWEsQ0FBQztRQUN0QixDQUFDLENBQUM7YUFDRCxJQUFJLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDaEIsTUFBTSxVQUFVLEdBQUcsTUFBTSxjQUFjLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDeEQsT0FBTyxVQUFVLENBQUM7UUFDbkIsQ0FBQyxDQUFDO2FBQ0QsSUFBSSxDQUFDLEtBQUssSUFBSSxFQUFFO1lBQ2hCLE1BQU0sY0FBYyxHQUFHLE1BQU0sY0FBYyxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFDaEUsT0FBTyxjQUFjLENBQUM7UUFDdkIsQ0FBQyxDQUFDO2FBQ0QsSUFBSSxDQUFDLEtBQUssSUFBSSxFQUFFO1lBQ2hCLE1BQU0sY0FBYyxHQUFHLE1BQU0sY0FBYyxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFDaEUsT0FBTyxjQUFjLENBQUM7UUFDdkIsQ0FBQyxDQUFDO2FBQ0QsSUFBSSxDQUFDLEtBQUssSUFBSSxFQUFFO1lBQ2hCLE1BQU0sQ0FDTCxpQkFBaUIsRUFDakIsZUFBZSxFQUNmLFlBQVksRUFDWixVQUFVLEVBQ1YsZUFBZSxFQUNmLGVBQWUsRUFDZixXQUFXLEVBQ1gsZ0JBQWdCLENBQ2hCLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDO2dCQUNyQixjQUFjLENBQUMsb0JBQW9CLEVBQUU7Z0JBQ3JDLGNBQWMsQ0FBQyxrQkFBa0IsRUFBRTtnQkFDbkMsY0FBYyxDQUFDLGVBQWUsRUFBRTtnQkFDaEMsY0FBYyxDQUFDLGFBQWEsRUFBRTtnQkFDOUIsY0FBYyxDQUFDLGtCQUFrQixFQUFFO2dCQUNuQyxjQUFjLENBQUMsa0JBQWtCLEVBQUU7Z0JBQ25DLGNBQWMsQ0FBQyxjQUFjLEVBQUU7Z0JBQy9CLGNBQWMsQ0FBQyxtQkFBbUIsRUFBRTthQUNwQyxDQUFDLENBQUM7WUFDSCxPQUFPO2dCQUNOLGlCQUFpQjtnQkFDakIsZUFBZTtnQkFDZixZQUFZO2dCQUNaLFVBQVU7Z0JBQ1YsZUFBZTtnQkFDZixlQUFlO2dCQUNmLFdBQVc7Z0JBQ1gsZ0JBQWdCO2FBQ2hCLENBQUM7UUFDSCxDQUFDLENBQUM7YUFDRCxJQUFJLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDaEIsTUFBTSxDQUNMLGNBQWMsRUFDZCxnQkFBZ0IsRUFDaEIsaUJBQWlCLEVBQ2pCLHNCQUFzQixDQUN0QixHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQztnQkFDckIsY0FBYyxDQUFDLHdCQUF3QixFQUFFO2dCQUN6QyxjQUFjLENBQUMsMEJBQTBCLEVBQUU7Z0JBQzNDLGNBQWMsQ0FBQywyQkFBMkIsRUFBRTtnQkFDNUMsY0FBYyxDQUFDLGdDQUFnQyxFQUFFO2FBQ2pELENBQUMsQ0FBQztZQUNILE9BQU87Z0JBQ04sY0FBYztnQkFDZCxnQkFBZ0I7Z0JBQ2hCLGlCQUFpQjtnQkFDakIsc0JBQXNCO2FBQ3RCLENBQUM7UUFDSCxDQUFDLENBQUM7YUFDRCxJQUFJLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDaEIsTUFBTSxDQUFDLGFBQWEsRUFBRSxtQkFBbUIsQ0FBQyxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQztnQkFDOUQsY0FBYyxDQUFDLGdCQUFnQixFQUFFO2dCQUNqQyxjQUFjLENBQUMsc0JBQXNCLEVBQUU7YUFDdkMsQ0FBQyxDQUFDO1lBQ0gsT0FBTztnQkFDTixhQUFhO2dCQUNiLG1CQUFtQjthQUNuQixDQUFDO1FBQ0gsQ0FBQyxDQUFDO2FBQ0QsSUFBSSxDQUFDLEtBQUssSUFBSSxFQUFFO1lBQ2hCLE1BQU0sV0FBVyxHQUFHLE1BQU0sY0FBYyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUM3RCxPQUFPLFdBQVcsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNsQyxDQUFDLENBQUM7YUFDRCxJQUFJLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDaEIsTUFBTSxlQUFlLEdBQ3BCLE1BQU0sY0FBYyxDQUFDLGtCQUFrQixFQUFFLENBQUM7WUFDM0MsT0FBTyxlQUFlLENBQUM7UUFDeEIsQ0FBQyxDQUFDO2FBQ0QsSUFBSSxDQUFDLEtBQUssSUFBSSxFQUFFO1lBQ2hCLE1BQU0sa0JBQWtCLEdBQ3ZCLE1BQU0sY0FBYyxDQUFDLHFCQUFxQixFQUFFLENBQUM7WUFDOUMsT0FBTyxrQkFBa0IsQ0FBQztRQUMzQixDQUFDLENBQUM7YUFDRCxJQUFJLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDaEIsTUFBTSxDQUFDLElBQUksQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDO1FBQ3ZELENBQUMsQ0FBQzthQUNELEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUNkLE1BQU0sY0FBYyxHQUFHLE1BQU0sQ0FBQztZQUM5QixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7Z0JBQ3JCLE9BQU8sQ0FBQyxLQUFLLENBQ1osMkNBQTJDLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUNuRyxDQUFDO2dCQUNGLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDakIsQ0FBQztpQkFBTSxDQUFDO2dCQUNQLGNBQWMsQ0FBQyxLQUFLLENBQ25CLDJDQUEyQyxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FDbkcsQ0FBQztnQkFDRixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pCLENBQUM7UUFDRixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2hCLE1BQU0sY0FBYyxHQUFHLE1BQU0sY0FBYyxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDL0QsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3JCLE9BQU8sQ0FBQyxLQUFLLENBQ1osMkNBQTJDLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUNuRyxDQUFDO1lBQ0YsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqQixDQUFDO2FBQU0sQ0FBQztZQUNQLGNBQWMsQ0FBQyxRQUFRLENBQ3RCLDJDQUEyQyxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FDbkcsQ0FBQztZQUNGLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDakIsQ0FBQztJQUNGLENBQUM7QUFDRixDQUFDO0FBRUQsTUFBTSxLQUFLLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwcm9jZXNzIGZyb20gJ3Byb2Nlc3MnO1xuaW1wb3J0IHsgbG9naW4gfSBmcm9tICcuL2FkbWluJztcbmltcG9ydCB7IFNlcnZpY2VGYWN0b3J5IH0gZnJvbSAnLi9pbmRleC9mYWN0b3J5JztcbmltcG9ydCB7IFZhdWx0U2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvVmF1bHQnO1xuaW1wb3J0IHsgQXBwbGljYXRpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2UgfSBmcm9tICcuL2luZGV4L2ludGVyZmFjZXMvc2VydmljZXMnO1xuXG5sZXQgYXBwOiBBcHBsaWNhdGlvbjtcbmxldCBsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2U7XG5cbmFzeW5jIGZ1bmN0aW9uIHN0YXJ0KCk6IFByb21pc2U8dm9pZD4ge1xuXHR0cnkge1xuXHRcdHJldHVybiBsb2dpbigpXG5cdFx0XHQudGhlbihhc3luYyAoeyBlbmNyeXB0aW9uS2V5LCBncGdQYXNzcGhyYXNlLCBhZG1pbklkIH0pID0+IHtcblx0XHRcdFx0aWYgKCFlbmNyeXB0aW9uS2V5IHx8ICFncGdQYXNzcGhyYXNlIHx8ICFhZG1pbklkKSB7XG5cdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKFxuXHRcdFx0XHRcdFx0J0tleXMgb3IgQWRtaW4gSUQgbm90IGZvdW5kLiBTaHV0dGluZyBkb3duLi4uJ1xuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRjb25zdCBsb2dnZXIgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRMb2dnZXJTZXJ2aWNlKCk7XG5cdFx0XHRcdGNvbnN0IGVycm9yTG9nZ2VyID1cblx0XHRcdFx0XHRhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRFcnJvckxvZ2dlclNlcnZpY2UoKTtcblxuXHRcdFx0XHRsb2dnZXIuc2V0QWRtaW5JZChhZG1pbklkKTtcblxuXHRcdFx0XHRjb25zdCBlcnJvckhhbmRsZXIgPVxuXHRcdFx0XHRcdGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldEVycm9ySGFuZGxlclNlcnZpY2UoKTtcblxuXHRcdFx0XHRsb2dnZXIuc2V0RXJyb3JIYW5kbGVyKGVycm9ySGFuZGxlcik7XG5cblx0XHRcdFx0Y29uc3QgZW52Q29uZmlnID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0RW52Q29uZmlnU2VydmljZSgpO1xuXG5cdFx0XHRcdGNvbnN0IHZhdWx0ID0gYXdhaXQgVmF1bHRTZXJ2aWNlLmluaXRpYWxpemUoXG5cdFx0XHRcdFx0ZW5jcnlwdGlvbktleSxcblx0XHRcdFx0XHRncGdQYXNzcGhyYXNlXG5cdFx0XHRcdCk7XG5cblx0XHRcdFx0c2V0SW50ZXJ2YWwoXG5cdFx0XHRcdFx0KCkgPT4gdmF1bHQuY2xlYXJFeHBpcmVkU2VjcmV0c0Zyb21NZW1vcnkoKSxcblx0XHRcdFx0XHRlbnZDb25maWcuZ2V0RW52VmFyaWFibGUoJ2NsZWFyRXhwaXJlZFNlY3JldHNJbnRlcnZhbCcpXG5cdFx0XHRcdCk7XG5cdFx0XHRcdHNldEludGVydmFsKFxuXHRcdFx0XHRcdCgpID0+IHZhdWx0LmJhdGNoQ2xlYXJTZWNyZXRzKCksXG5cdFx0XHRcdFx0ZW52Q29uZmlnLmdldEVudlZhcmlhYmxlKCdiYXRjaFJlRW5jcnlwdFNlY3JldHNJbnRlcnZhbCcpXG5cdFx0XHRcdCk7XG5cblx0XHRcdFx0bG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0J1NlY3JldHMgc3RvcmUgaW5pdGlhbGl6ZWQuIFJFQURZIFRPIFJPQ0sgQU5EIFJPTEwhISEnXG5cdFx0XHRcdCk7XG5cdFx0XHRcdHJldHVybiB7IGVudkNvbmZpZywgZXJyb3JMb2dnZXIsIGVycm9ySGFuZGxlciwgbG9nZ2VyLCB2YXVsdCB9O1xuXHRcdFx0fSlcblx0XHRcdC50aGVuKGFzeW5jICgpID0+IHtcblx0XHRcdFx0Y29uc3QgbWlkZGxld2FyZVN0YXR1c1NlcnZpY2UgPVxuXHRcdFx0XHRcdGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldE1pZGRsZXdhcmVTdGF0dXNTZXJ2aWNlKCk7XG5cdFx0XHRcdHJldHVybiBtaWRkbGV3YXJlU3RhdHVzU2VydmljZTtcblx0XHRcdH0pXG5cdFx0XHQudGhlbihhc3luYyAoKSA9PiB7XG5cdFx0XHRcdGNvbnN0IHJvb3RNaWRkbGV3YXJlID1cblx0XHRcdFx0XHRhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRSb290TWlkZGxld2FyZVNlcnZpY2UoKTtcblx0XHRcdFx0cm9vdE1pZGRsZXdhcmUuaW5pdGlhbGl6ZSgpO1xuXHRcdFx0XHRyZXR1cm4gcm9vdE1pZGRsZXdhcmU7XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oYXN5bmMgKCkgPT4ge1xuXHRcdFx0XHRjb25zdCBkYXRhYmFzZUNvbnRyb2xsZXIgPVxuXHRcdFx0XHRcdGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldERhdGFiYXNlQ29udHJvbGxlcigpO1xuXHRcdFx0XHRkYXRhYmFzZUNvbnRyb2xsZXIuaW5pdGlhbGl6ZSgpO1xuXHRcdFx0XHRyZXR1cm4gZGF0YWJhc2VDb250cm9sbGVyO1xuXHRcdFx0fSlcblx0XHRcdC50aGVuKGFzeW5jICgpID0+IHtcblx0XHRcdFx0Y29uc3QgW2NhY2hlU2VydmljZSwgcmVkaXNTZXJ2aWNlXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcblx0XHRcdFx0XHRTZXJ2aWNlRmFjdG9yeS5nZXRDYWNoZVNlcnZpY2UoKSxcblx0XHRcdFx0XHRTZXJ2aWNlRmFjdG9yeS5nZXRSZWRpc1NlcnZpY2UoKVxuXHRcdFx0XHRdKTtcblx0XHRcdFx0cmV0dXJuIHsgY2FjaGVTZXJ2aWNlLCByZWRpc1NlcnZpY2UgfTtcblx0XHRcdH0pXG5cdFx0XHQudGhlbihhc3luYyAoKSA9PiB7XG5cdFx0XHRcdGNvbnN0IGdhdGVrZWVwZXIgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRHYXRla2VlcGVyU2VydmljZSgpO1xuXHRcdFx0XHRyZXR1cm4gZ2F0ZWtlZXBlci5pbml0aWFsaXplKCk7XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oYXN5bmMgKCkgPT4ge1xuXHRcdFx0XHRjb25zdCBhY2Nlc3NDb250cm9sID1cblx0XHRcdFx0XHRhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRBY2Nlc3NDb250cm9sTWlkZGxld2FyZVNlcnZpY2UoKTtcblx0XHRcdFx0cmV0dXJuIGFjY2Vzc0NvbnRyb2w7XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oYXN5bmMgKCkgPT4ge1xuXHRcdFx0XHRjb25zdCBiYXNlUm91dGVyID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0QmFzZVJvdXRlcigpO1xuXHRcdFx0XHRyZXR1cm4gYmFzZVJvdXRlcjtcblx0XHRcdH0pXG5cdFx0XHQudGhlbihhc3luYyAoKSA9PiB7XG5cdFx0XHRcdGNvbnN0IHVzZXJDb250cm9sbGVyID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0VXNlckNvbnRyb2xsZXIoKTtcblx0XHRcdFx0cmV0dXJuIHVzZXJDb250cm9sbGVyO1xuXHRcdFx0fSlcblx0XHRcdC50aGVuKGFzeW5jICgpID0+IHtcblx0XHRcdFx0Y29uc3QgYXV0aENvbnRyb2xsZXIgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRBdXRoQ29udHJvbGxlcigpO1xuXHRcdFx0XHRyZXR1cm4gYXV0aENvbnRyb2xsZXI7XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oYXN5bmMgKCkgPT4ge1xuXHRcdFx0XHRjb25zdCBbXG5cdFx0XHRcdFx0YmFja3VwQ29kZVNlcnZpY2UsXG5cdFx0XHRcdFx0ZW1haWxNRkFTZXJ2aWNlLFxuXHRcdFx0XHRcdGZpZG8yU2VydmljZSxcblx0XHRcdFx0XHRqd3RTZXJ2aWNlLFxuXHRcdFx0XHRcdHBhc3Nwb3J0U2VydmljZSxcblx0XHRcdFx0XHRwYXNzd29yZFNlcnZpY2UsXG5cdFx0XHRcdFx0dG90cFNlcnZpY2UsXG5cdFx0XHRcdFx0eXViaWNvT1RQU2VydmljZVxuXHRcdFx0XHRdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuXHRcdFx0XHRcdFNlcnZpY2VGYWN0b3J5LmdldEJhY2t1cENvZGVTZXJ2aWNlKCksXG5cdFx0XHRcdFx0U2VydmljZUZhY3RvcnkuZ2V0RW1haWxNRkFTZXJ2aWNlKCksXG5cdFx0XHRcdFx0U2VydmljZUZhY3RvcnkuZ2V0RklETzJTZXJ2aWNlKCksXG5cdFx0XHRcdFx0U2VydmljZUZhY3RvcnkuZ2V0SldUU2VydmljZSgpLFxuXHRcdFx0XHRcdFNlcnZpY2VGYWN0b3J5LmdldFBhc3Nwb3J0U2VydmljZSgpLFxuXHRcdFx0XHRcdFNlcnZpY2VGYWN0b3J5LmdldFBhc3N3b3JkU2VydmljZSgpLFxuXHRcdFx0XHRcdFNlcnZpY2VGYWN0b3J5LmdldFRPVFBTZXJ2aWNlKCksXG5cdFx0XHRcdFx0U2VydmljZUZhY3RvcnkuZ2V0WXViaWNvT1RQU2VydmljZSgpXG5cdFx0XHRcdF0pO1xuXHRcdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRcdGJhY2t1cENvZGVTZXJ2aWNlLFxuXHRcdFx0XHRcdGVtYWlsTUZBU2VydmljZSxcblx0XHRcdFx0XHRmaWRvMlNlcnZpY2UsXG5cdFx0XHRcdFx0and0U2VydmljZSxcblx0XHRcdFx0XHRwYXNzcG9ydFNlcnZpY2UsXG5cdFx0XHRcdFx0cGFzc3dvcmRTZXJ2aWNlLFxuXHRcdFx0XHRcdHRvdHBTZXJ2aWNlLFxuXHRcdFx0XHRcdHl1Ymljb09UUFNlcnZpY2Vcblx0XHRcdFx0fTtcblx0XHRcdH0pXG5cdFx0XHQudGhlbihhc3luYyAoKSA9PiB7XG5cdFx0XHRcdGNvbnN0IFtcblx0XHRcdFx0XHRjc3JmTWlkZGxld2FyZSxcblx0XHRcdFx0XHRoZWxtZXRNaWRkbGV3YXJlLFxuXHRcdFx0XHRcdGp3dEF1dGhNaWRkbGV3YXJlLFxuXHRcdFx0XHRcdHBhc3Nwb3J0QXV0aE1pZGRsZXdhcmVcblx0XHRcdFx0XSA9IGF3YWl0IFByb21pc2UuYWxsKFtcblx0XHRcdFx0XHRTZXJ2aWNlRmFjdG9yeS5nZXRDU1JGTWlkZGxld2FyZVNlcnZpY2UoKSxcblx0XHRcdFx0XHRTZXJ2aWNlRmFjdG9yeS5nZXRIZWxtZXRNaWRkbGV3YXJlU2VydmljZSgpLFxuXHRcdFx0XHRcdFNlcnZpY2VGYWN0b3J5LmdldEpXVEF1dGhNaWRkbGV3YXJlU2VydmljZSgpLFxuXHRcdFx0XHRcdFNlcnZpY2VGYWN0b3J5LmdldFBhc3Nwb3J0QXV0aE1pZGRsZXdhcmVTZXJ2aWNlKClcblx0XHRcdFx0XSk7XG5cdFx0XHRcdHJldHVybiB7XG5cdFx0XHRcdFx0Y3NyZk1pZGRsZXdhcmUsXG5cdFx0XHRcdFx0aGVsbWV0TWlkZGxld2FyZSxcblx0XHRcdFx0XHRqd3RBdXRoTWlkZGxld2FyZSxcblx0XHRcdFx0XHRwYXNzcG9ydEF1dGhNaWRkbGV3YXJlXG5cdFx0XHRcdH07XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oYXN5bmMgKCkgPT4ge1xuXHRcdFx0XHRjb25zdCBbbWFpbGVyU2VydmljZSwgbXVsdGVyVXBsb2FkU2VydmljZV0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG5cdFx0XHRcdFx0U2VydmljZUZhY3RvcnkuZ2V0TWFpbGVyU2VydmljZSgpLFxuXHRcdFx0XHRcdFNlcnZpY2VGYWN0b3J5LmdldE11bHRlclVwbG9hZFNlcnZpY2UoKVxuXHRcdFx0XHRdKTtcblx0XHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0XHRtYWlsZXJTZXJ2aWNlLFxuXHRcdFx0XHRcdG11bHRlclVwbG9hZFNlcnZpY2Vcblx0XHRcdFx0fTtcblx0XHRcdH0pXG5cdFx0XHQudGhlbihhc3luYyAoKSA9PiB7XG5cdFx0XHRcdGNvbnN0IGh0dHBzU2VydmVyID0gYXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0SFRUUFNTZXJ2ZXIoYXBwKTtcblx0XHRcdFx0cmV0dXJuIGh0dHBzU2VydmVyLnN0YXJ0U2VydmVyKCk7XG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oYXN5bmMgKCkgPT4ge1xuXHRcdFx0XHRjb25zdCByZXNvdXJjZU1hbmFnZXIgPVxuXHRcdFx0XHRcdGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldFJlc291cmNlTWFuYWdlcigpO1xuXHRcdFx0XHRyZXR1cm4gcmVzb3VyY2VNYW5hZ2VyO1xuXHRcdFx0fSlcblx0XHRcdC50aGVuKGFzeW5jICgpID0+IHtcblx0XHRcdFx0Y29uc3QgaGVhbHRoQ2hlY2tTZXJ2aWNlID1cblx0XHRcdFx0XHRhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRIZWFsdGhDaGVja1NlcnZpY2UoKTtcblx0XHRcdFx0cmV0dXJuIGhlYWx0aENoZWNrU2VydmljZTtcblx0XHRcdH0pXG5cdFx0XHQudGhlbihhc3luYyAoKSA9PiB7XG5cdFx0XHRcdGxvZ2dlci5pbmZvKCdBbGwgc2VydmljZXMgaW5pdGlhbGl6ZWQgc3VjY2Vzc2Z1bGx5LicpO1xuXHRcdFx0fSlcblx0XHRcdC5jYXRjaChlcnJvciA9PiB7XG5cdFx0XHRcdGNvbnN0IGZhbGxiYWNrTG9nZ2VyID0gbG9nZ2VyO1xuXHRcdFx0XHRpZiAoIWZhbGxiYWNrTG9nZ2VyKSB7XG5cdFx0XHRcdFx0Y29uc29sZS5lcnJvcihcblx0XHRcdFx0XHRcdGBDcml0aWNhbCBlcnJvciBvY2N1cnJlZCBkdXJpbmcgc3RhcnR1cFxcbiR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWBcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdHByb2Nlc3MuZXhpdCgxKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRmYWxsYmFja0xvZ2dlci5lcnJvcihcblx0XHRcdFx0XHRcdGBDcml0aWNhbCBlcnJvciBvY2N1cnJlZCBkdXJpbmcgc3RhcnR1cFxcbiR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWBcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdHByb2Nlc3MuZXhpdCgxKTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0Y29uc3QgZmFsbGJhY2tMb2dnZXIgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRMb2dnZXJTZXJ2aWNlKCk7XG5cdFx0aWYgKCFmYWxsYmFja0xvZ2dlcikge1xuXHRcdFx0Y29uc29sZS5lcnJvcihcblx0XHRcdFx0YENyaXRpY2FsIGVycm9yIG9jY3VycmVkIGR1cmluZyBzdGFydHVwXFxuJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcil9YFxuXHRcdFx0KTtcblx0XHRcdHByb2Nlc3MuZXhpdCgxKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0ZmFsbGJhY2tMb2dnZXIubG9nRXJyb3IoXG5cdFx0XHRcdGBDcml0aWNhbCBlcnJvciBvY2N1cnJlZCBkdXJpbmcgc3RhcnR1cFxcbiR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfWBcblx0XHRcdCk7XG5cdFx0XHRwcm9jZXNzLmV4aXQoMSk7XG5cdFx0fVxuXHR9XG59XG5cbmF3YWl0IHN0YXJ0KCk7XG4iXX0=
