import express from 'express';
import session from 'express-session';
import { dirname } from 'path';
import { fileURLToPath } from 'url';
import cookieParser from 'cookie-parser';
import cors from 'cors';
import hpp from 'hpp';
import morgan from 'morgan';
import passport from 'passport';
import { randomBytes } from 'crypto';
import path from 'path';
import RedisStore from 'connect-redis';
import initializeStaticRoutes from '../routes/staticRoutes.js';
import apiRoutes from '../routes/apiRoutes.js';
import {
	csrfMiddleware,
	errorHandler,
	getFeatureFlags,
	getRedisClient,
	ipBlacklistMiddleware,
	loadTestRoutes,
	rateLimitMiddleware,
	setupSecurityHeaders,
	startMemoryMonitor
} from '../index.js';
import setupLogger from './logger.js';
const app = express();
const logger = setupLogger();
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const staticRootPath =
	process.env.STATIC_ROOT_PATH ?? path.join(__dirname, '../public');
const featureFlags = getFeatureFlags();
const NODE_ENV = process.env.NODE_ENV;
const SSL_FLAG = featureFlags.enableSslFlag;
const REDIS_FLAG = featureFlags.enableRedisFlag;
async function initializeApp() {
	let memoryMonitor = false;
	if (NODE_ENV === 'development' || NODE_ENV === 'testing') {
		memoryMonitor = true;
	}
	if (memoryMonitor) {
		logger.info('Memory monitor started');
		startMemoryMonitor();
	}
	const middlewares = [
		express.json(),
		express.urlencoded({ extended: true }),
		cookieParser(),
		passport.initialize(),
		express.static(staticRootPath),
		hpp(),
		rateLimitMiddleware,
		ipBlacklistMiddleware,
		csrfMiddleware
	];
	app.use(...middlewares);
	app.use(
		cors({
			methods: 'GET,POST,PUT,DELETE',
			allowedHeaders: 'Content-Type,Authorization',
			credentials: true
		})
	);
	app.use(
		morgan('combined', {
			stream: { write: (message = '') => logger.info(message.trim()) }
		})
	);
	app.use('/', initializeStaticRoutes);
	app.use('/api', apiRoutes);
	app.use(async (req, res, next) => {
		try {
			res.locals.cspNonce = randomBytes(16).toString('hex');
			next();
		} catch {
			next();
		}
	});
	setupSecurityHeaders(app);
	loadTestRoutes(app);
	// Session management
	if (REDIS_FLAG && getRedisClient()) {
		logger.info('REDIS_FLAG is true. Using Redis for session management');
		app.use(
			session({
				store: new RedisStore({ client: getRedisClient }),
				secret: 'secrets.REDIS_KEY',
				resave: false,
				saveUninitialized: false,
				cookie: { secure: true }
			})
		);
	} else {
		logger.info(
			'REDIS_FLAG is false. Skipping Redis operations because REDIS_FLAG is false or Redis is not connected. Using in-memory storage for session management'
		);
		let secureCookie;
		if (SSL_FLAG) {
			logger.info('SSL_FLAG is true. Using secure cookies');
			secureCookie = true;
		} else {
			logger.info('SSL_FLAG is false. Using insecure cookies');
			secureCookie = false;
		}
		app.use(
			session({
				secret: 'secrets.SESSION_KEY',
				resave: false,
				saveUninitialized: false,
				cookie: { secure: secureCookie }
			})
		);
	}
	// 404 error handling
	app.use((req, res, next) => {
		res.status(404).sendFile(
			path.join(__dirname, '../public', 'not-found.html')
		);
		next();
	});
	// General error handling
	app.use(errorHandler);
}
export { app, initializeApp };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NvbmZpZy9hcHAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxPQUE0QyxNQUFNLFNBQVMsQ0FBQztBQUNuRSxPQUFPLE9BQU8sTUFBTSxpQkFBaUIsQ0FBQztBQUN0QyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxLQUFLLENBQUM7QUFDcEMsT0FBTyxZQUFZLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUN4QixPQUFPLEdBQUcsTUFBTSxLQUFLLENBQUM7QUFDdEIsT0FBTyxNQUFNLE1BQU0sUUFBUSxDQUFDO0FBQzVCLE9BQU8sUUFBUSxNQUFNLFVBQVUsQ0FBQztBQUNoQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQ3JDLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUN4QixPQUFPLFVBQVUsTUFBTSxlQUFlLENBQUM7QUFDdkMsT0FBTyxzQkFBc0IsTUFBTSx3QkFBd0IsQ0FBQztBQUM1RCxPQUFPLFNBQVMsTUFBTSxxQkFBcUIsQ0FBQztBQUM1QyxPQUFPLEVBQ04sY0FBYyxFQUNkLFlBQVksRUFDWixlQUFlLEVBQ2YsY0FBYyxFQUNkLHFCQUFxQixFQUNyQixjQUFjLEVBQ2QsbUJBQW1CLEVBQ25CLG9CQUFvQixFQUNwQixrQkFBa0IsRUFDbEIsTUFBTSxVQUFVLENBQUM7QUFDbEIsT0FBTyxXQUFXLE1BQU0sVUFBVSxDQUFDO0FBRW5DLE1BQU0sR0FBRyxHQUFHLE9BQU8sRUFBRSxDQUFDO0FBQ3RCLE1BQU0sTUFBTSxHQUFHLFdBQVcsRUFBRSxDQUFDO0FBQzdCLE1BQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2xELE1BQU0sU0FBUyxHQUFH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dCBleHByZXNzLCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBzZXNzaW9uIGZyb20gJ2V4cHJlc3Mtc2Vzc2lvbic7XG5pbXBvcnQgeyBkaXJuYW1lIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBmaWxlVVJMVG9QYXRoIH0gZnJvbSAndXJsJztcbmltcG9ydCBjb29raWVQYXJzZXIgZnJvbSAnY29va2llLXBhcnNlcic7XG5pbXBvcnQgY29ycyBmcm9tICdjb3JzJztcbmltcG9ydCBocHAgZnJvbSAnaHBwJztcbmltcG9ydCBtb3JnYW4gZnJvbSAnbW9yZ2FuJztcbmltcG9ydCBwYXNzcG9ydCBmcm9tICdwYXNzcG9ydCc7XG5pbXBvcnQgeyByYW5kb21CeXRlcyB9IGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBSZWRpc1N0b3JlIGZyb20gJ2Nvbm5lY3QtcmVkaXMnO1xuaW1wb3J0IGluaXRpYWxpemVTdGF0aWNSb3V0ZXMgZnJvbSAnLi4vcm91dGVzL3N0YXRpY1JvdXRlcyc7XG5pbXBvcnQgYXBpUm91dGVzIGZyb20gJy4uL3JvdXRlcy9hcGlSb3V0ZXMnO1xuaW1wb3J0IHtcblx0Y3NyZk1pZGRsZXdhcmUsXG5cdGVycm9ySGFuZGxlcixcblx0Z2V0RmVhdHVyZUZsYWdzLFxuXHRnZXRSZWRpc0NsaWVudCxcblx0aXBCbGFja2xpc3RNaWRkbGV3YXJlLFxuXHRsb2FkVGVzdFJvdXRlcyxcblx0cmF0ZUxpbWl0TWlkZGxld2FyZSxcblx0c2V0dXBTZWN1cml0eUhlYWRlcnMsXG5cdHN0YXJ0TWVtb3J5TW9uaXRvclxufSBmcm9tICcuLi9pbmRleCc7XG5pbXBvcnQgc2V0dXBMb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuXG5jb25zdCBhcHAgPSBleHByZXNzKCk7XG5jb25zdCBsb2dnZXIgPSBzZXR1cExvZ2dlcigpO1xuY29uc3QgX19maWxlbmFtZSA9IGZpbGVVUkxUb1BhdGgoaW1wb3J0Lm1ldGEudXJsKTtcbmNvbnN0IF9fZGlybmFtZSA9IGRpcm5hbWUoX19maWxlbmFtZSk7XG5jb25zdCBzdGF0aWNSb290UGF0aCA9XG5cdHByb2Nlc3MuZW52LlNUQVRJQ19ST09UX1BBVEggPz8gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL3B1YmxpYycpO1xuY29uc3QgZmVhdHVyZUZsYWdzID0gZ2V0RmVhdHVyZUZsYWdzKCk7XG5cbmNvbnN0IE5PREVfRU5WID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlY7XG5jb25zdCBTU0xfRkxBRyA9IGZlYXR1cmVGbGFncy5lbmFibGVTc2xGbGFnO1xuY29uc3QgUkVESVNfRkxBRyA9IGZlYXR1cmVGbGFncy5lbmFibGVSZWRpc0ZsYWc7XG5cbmFzeW5jIGZ1bmN0aW9uIGluaXRpYWxpemVBcHAoKTogUHJvbWlzZTx2b2lkPiB7XG5cdGxldCBtZW1vcnlNb25pdG9yID0gZmFsc2U7XG5cblx0aWYgKE5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnIHx8IE5PREVfRU5WID09PSAndGVzdGluZycpIHtcblx0XHRtZW1vcnlNb25pdG9yID0gdHJ1ZTtcblx0fVxuXG5cdGlmIChtZW1vcnlNb25pdG9yKSB7XG5cdFx0bG9nZ2VyLmluZm8oJ01lbW9yeSBtb25pdG9yIHN0YXJ0ZWQnKTtcblx0XHRzdGFydE1lbW9yeU1vbml0b3IoKTtcblx0fVxuXG5cdGNvbnN0IG1pZGRsZXdhcmVzID0gW1xuXHRcdGV4cHJlc3MuanNvbigpLFxuXHRcdGV4cHJlc3MudXJsZW5jb2RlZCh7IGV4dGVuZGVkOiB0cnVlIH0pLFxuXHRcdGNvb2tpZVBhcnNlcigpLFxuXHRcdHBhc3Nwb3J0LmluaXRpYWxpemUoKSxcblx0XHRleHByZXNzLnN0YXRpYyhzdGF0aWNSb290UGF0aCksXG5cdFx0aHBwKCksXG5cdFx0cmF0ZUxpbWl0TWlkZGxld2FyZSxcblx0XHRpcEJsYWNrbGlzdE1pZGRsZXdhcmUsXG5cdFx0Y3NyZk1pZGRsZXdhcmVcblx0XTtcblxuXHRhcHAudXNlKC4uLm1pZGRsZXdhcmVzKTtcblxuXHRhcHAudXNlKFxuXHRcdGNvcnMoe1xuXHRcdFx0bWV0aG9kczogJ0dFVCxQT1NULFBVVCxERUxFVEUnLFxuXHRcdFx0YWxsb3dlZEhlYWRlcnM6ICdDb250ZW50LVR5cGUsQXV0aG9yaXphdGlvbicsXG5cdFx0XHRjcmVkZW50aWFsczogdHJ1ZVxuXHRcdH0pXG5cdCk7XG5cblx0YXBwLnVzZShcblx0XHRtb3JnYW4oJ2NvbWJpbmVkJywge1xuXHRcdFx0c3RyZWFtOiB7IHdyaXRlOiAobWVzc2FnZSA9ICcnKSA9PiBsb2dnZXIuaW5mbyhtZXNzYWdlLnRyaW0oKSkgfVxuXHRcdH0pXG5cdCk7XG5cblx0YXBwLnVzZSgnLycsIGluaXRpYWxpemVTdGF0aWNSb3V0ZXMpO1xuXG5cdGFwcC51c2UoJy9hcGknLCBhcGlSb3V0ZXMpO1xuXG5cdGFwcC51c2UoYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG5cdFx0dHJ5IHtcblx0XHRcdHJlcy5sb2NhbHMuY3NwTm9uY2UgPSByYW5kb21CeXRlcygxNikudG9TdHJpbmcoJ2hleCcpO1xuXHRcdFx0bmV4dCgpO1xuXHRcdH0gY2F0Y2gge1xuXHRcdFx0bmV4dCgpO1xuXHRcdH1cblx0fSk7XG5cblx0c2V0dXBTZWN1cml0eUhlYWRlcnMoYXBwKTtcblxuXHRsb2FkVGVzdFJvdXRlcyhhcHApO1xuXG5cdC8vIFNlc3Npb24gbWFuYWdlbWVudFxuXHRpZiAoUkVESVNfRkxBRyAmJiBnZXRSZWRpc0NsaWVudCgpKSB7XG5cdFx0bG9nZ2VyLmluZm8oJ1JFRElTX0ZMQUcgaXMgdHJ1ZS4gVXNpbmcgUmVkaXMgZm9yIHNlc3Npb24gbWFuYWdlbWVudCcpO1xuXHRcdGFwcC51c2UoXG5cdFx0XHRzZXNzaW9uKHtcblx0XHRcdFx0c3RvcmU6IG5ldyBSZWRpc1N0b3JlKHsgY2xpZW50OiBnZXRSZWRpc0NsaWVudCB9KSxcblx0XHRcdFx0c2VjcmV0OiAnc2VjcmV0cy5SRURJU19LRVknLFxuXHRcdFx0XHRyZXNhdmU6IGZhbHNlLFxuXHRcdFx0XHRzYXZlVW5pbml0aWFsaXplZDogZmFsc2UsXG5cdFx0XHRcdGNvb2tpZTogeyBzZWN1cmU6IHRydWUgfVxuXHRcdFx0fSlcblx0XHQpO1xuXHR9IGVsc2Uge1xuXHRcdGxvZ2dlci5pbmZvKFxuXHRcdFx0J1JFRElTX0ZMQUcgaXMgZmFsc2UuIFNraXBwaW5nIFJlZGlzIG9wZXJhdGlvbnMgYmVjYXVzZSBSRURJU19GTEFHIGlzIGZhbHNlIG9yIFJlZGlzIGlzIG5vdCBjb25uZWN0ZWQuIFVzaW5nIGluLW1lbW9yeSBzdG9yYWdlIGZvciBzZXNzaW9uIG1hbmFnZW1lbnQnXG5cdFx0KTtcblxuXHRcdGxldCBzZWN1cmVDb29raWU6IGJvb2xlYW47XG5cblx0XHRpZiAoU1NMX0ZMQUcpIHtcblx0XHRcdGxvZ2dlci5pbmZvKCdTU0xfRkxBRyBpcyB0cnVlLiBVc2luZyBzZWN1cmUgY29va2llcycpO1xuXHRcdFx0c2VjdXJlQ29va2llID0gdHJ1ZTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0bG9nZ2VyLmluZm8oJ1NTTF9GTEFHIGlzIGZhbHNlLiBVc2luZyBpbnNlY3VyZSBjb29raWVzJyk7XG5cdFx0XHRzZWN1cmVDb29raWUgPSBmYWxzZTtcblx0XHR9XG5cblx0XHRhcHAudXNlKFxuXHRcdFx0c2Vzc2lvbih7XG5cdFx0XHRcdHNlY3JldDogJ3NlY3JldHMuU0VTU0lPTl9LRVknLFxuXHRcdFx0XHRyZXNhdmU6IGZhbHNlLFxuXHRcdFx0XHRzYXZlVW5pbml0aWFsaXplZDogZmFsc2UsXG5cdFx0XHRcdGNvb2tpZTogeyBzZWN1cmU6IHNlY3VyZUNvb2tpZSB9XG5cdFx0XHR9KVxuXHRcdCk7XG5cdH1cblxuXHQvLyA0MDQgZXJyb3IgaGFuZGxpbmdcblx0YXBwLnVzZSgocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcblx0XHRyZXMuc3RhdHVzKDQwNCkuc2VuZEZpbGUoXG5cdFx0XHRwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vcHVibGljJywgJ25vdC1mb3VuZC5odG1sJylcblx0XHQpO1xuXHRcdG5leHQoKTtcblx0fSk7XG5cblx0Ly8gR2VuZXJhbCBlcnJvciBoYW5kbGluZ1xuXHRhcHAudXNlKGVycm9ySGFuZGxlcik7XG59XG5cbmV4cG9ydCB7IGFwcCwgaW5pdGlhbGl6ZUFwcCB9O1xuIl19
