import { promises as fs } from 'fs';
import { constants } from 'crypto';
import gracefulShutdown from 'http-graceful-shutdown';
import https from 'https';
import setupLogger from './logger.mjs';
import sops from './sops.mjs';
import {
	getFeatureFlags,
	getRedisClient,
	getSequelizeInstance,
	initializeDatabase
} from '../index.mjs';
const logger = setupLogger();
const featureFlags = getFeatureFlags();
const SERVER_PORT = process.env.SERVER_PORT || 3000;
const SSL_KEY = process.env.SERVER_SSL_KEY_PATH;
const SSL_CERT = process.env.SERVER_SSL_CERT_PATH;
const DECRYPT_KEYS = featureFlags.decryptKeysFlag;
const SSL_FLAG = featureFlags.enableSslFlag;
const REDIS_FLAG = featureFlags.enableRedisFlag;
const ciphers = [
	'ECDHE-ECDSA-AES256-GCM-SHA384',
	'ECDHE-RSA-AES256-GCM-SHA384',
	'ECDHE-ECDSA-CHACHA20-POLY1305',
	'ECDHE-RSA-CHACHA20-POLY1305',
	'ECDHE-ECDSA-AES128-GCM-SHA256',
	'ECDHE-RSA-AES128-GCM-SHA256',
	'ECDHE-ECDSA-AES256-SHA384',
	'ECDHE-RSA-AES256-SHA384',
	'ECDHE-ECDSA-AES128-SHA256',
	'ECDHE-RSA-AES128-SHA256'
];
async function declareOptions() {
	let sslKeys;
	if (DECRYPT_KEYS) {
		sslKeys = await sops.getSSLKeys();
		logger.info('SSL keys retrieved via sops.getSSLKeys()');
	} else {
		if (!SSL_KEY || !SSL_CERT) {
			throw new Error(
				'SSL_KEY or SSL_CERT environment variable is not set'
			);
		}
		const key = await fs.readFile(SSL_KEY, 'utf8');
		const cert = await fs.readFile(SSL_CERT, 'utf8');
		sslKeys = { key, cert };
		logger.info('Using unencrypted SSL keys from environment files');
	}
	try {
		const options = {
			key: sslKeys.key,
			cert: sslKeys.cert,
			allowHTTP1: true,
			secureOptions:
				constants.SSL_OP_NO_TLSv1 | constants.SSL_OP_NO_TLSv1_1,
			ciphers: ciphers.join(':'),
			honorCipherOrder: true
		};
		return options;
	} catch (error) {
		logger.error(`Error declaring options: ${error}`);
		throw new Error('Error declaring options');
	}
}
export async function setupHttp(app) {
	logger.info('setupHttp() executing');
	const options = await declareOptions();
	async function onShutdown() {
		logger.info('Cleaning up resources before shutdown');
		const sequelize = getSequelizeInstance();
		try {
			await sequelize.close();
			logger.info('Database connection closed');
		} catch (error) {
			logger.error(`Error closing database connection: ${error}`);
		}
		if (REDIS_FLAG) {
			logger.info('REDIS_FLAG is true. Closing Redis connection');
		}
		try {
			const redisClient = getRedisClient();
			if (redisClient) {
				await redisClient.quit();
				logger.info('Redis connection closed');
			}
		} catch (error) {
			logger.error(`Error closing Redis connection: ${error}`);
		}
		// Notify monitoring systems here
		// try {
		// } catch (error) {
		// } logger.error(`Error notifying monitoring systems: ${error} `);
		try {
			await new Promise(resolve => {
				logger.close();
				resolve();
			});
			console.log('Logger closed');
		} catch (error) {
			logger.error(`Error closing logger: ${error}`);
		}
	}
	async function startServer() {
		try {
			logger.info(`Starting HTTP server on port ${SERVER_PORT}`);
			logger.info(
				'Initializing database before starting server. Awaiting execution of initializeDatabase()'
			);
			await initializeDatabase();
			let server;
			if (SSL_FLAG) {
				logger.info('SSL_FLAG is true. Starting HTTP server with SSL');
				server = https
					.createServer(options, app)
					.listen(SERVER_PORT, () => {
						logger.info(
							`HTTP1.1 server running on port ${SERVER_PORT}`
						);
					});
			} else {
				logger.info(
					'SSL_FLAG is false. Starting HTTP server without SSL'
				);
				server = app.listen(SERVER_PORT, () => {
					logger.info(
						`HTTP1.1 server running on port ${SERVER_PORT}`
					);
				});
			}
			gracefulShutdown(server, {
				signals: 'SIGINT SIGTERM',
				timeout: 30000,
				development: false,
				onShutdown,
				finally: () => {
					console.log('Server has gracefully shut down');
				}
			});
		} catch (err) {
			if (err instanceof Error) {
				logger.error(`Failed to start server: ${err.message}`);
			} else {
				logger.error('Failed to start server due to an unknown error');
			}
			process.exit(1);
		}
	}
	return { startServer };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb25maWcvaHR0cC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsUUFBUSxJQUFJLEVBQUUsRUFBRSxNQUFNLElBQUksQ0FBQztBQUNwQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQ25DLE9BQU8sZ0JBQWdCLE1BQU0sd0JBQXdCLENBQUM7QUFDdEQsT0FBTyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBQzFCLE9BQU8sV0FBVyxNQUFNLFVBQVUsQ0FBQztBQUNuQyxPQUFPLElBQUksTUFBTSxRQUFRLENBQUM7QUFHMUIsT0FBTyxFQUNOLGVBQWUsRUFDZixjQUFjLEVBQ2Qsb0JBQW9CLEVBQ3BCLGtCQUFrQixFQUNsQixNQUFNLFVBQVUsQ0FBQztBQVNsQixNQUFNLE1BQU0sR0FBRyxXQUFXLEVBQUUsQ0FBQztBQUM3QixNQUFNLFlBQVksR0FBRyxlQUFlLEVBQUUsQ0FBQztBQUV2QyxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUM7QUFDcEQsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQztBQUNoRCxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDO0FBQ2xELE1BQU0sWUFBWSxHQUFHLFlBQVksQ0FBQyxlQUFlLENBQUM7QUFDbEQsTUFBTSxRQUFRLEdBQUcsWUFBWSxDQUFDLGFBQWEsQ0FBQztBQUM1QyxNQUFNLFVBQVUsR0FBRyxZQUFZLENBQUMsZUFBZSxDQUFDO0FBRWhELE1BQU0sT0FBTyxHQUFHO0lBQ2YsK0JBQStCO0lBQy9CLDZCQUE2QjtJQUM3QiwrQkFBK0I7SUFDL0IsNkJBQTZCO0lBQzdCLCtCQUErQjtJQUMvQiw2QkFBNkI7SUFDN0IsMkJBQTJCO0lBQzNCLHlCQUF5QjtJQUN6QiwyQkFBMkI7SUFDM0IseUJBQXlCO0NBQ3pCLENBQUM7QUFFRixLQUFLLFVBQVUsY0FBYztJQUN6QixJQUFJLE9BQWdCLENBQUM7SUFFckIsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUNmLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUNsQyxNQUFNLENBQUMsSUFBSSxDQUFDLDBDQUEwQyxDQUFDLENBQUM7SUFDNUQsQ0FBQztTQUFNLENBQUM7UUFDSixJQUFJLENBQUMsT0FBTyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDeEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxxREFBcUQsQ0FBQyxDQUFDO1FBQzNFLENBQUM7UUFDRCxNQUFNLEdBQUcsR0FBRyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQy9DLE1BQU0sSUFBSSxHQUFHLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFakQsT0FBTyxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDO1FBQ3hCLE1BQU0sQ0FBQyxJQUFJLENBQUMsbURBQW1ELENBQUMsQ0FBQztJQUNyRSxDQUFDO0lBRUQsSUFBSSxDQUFDO1FBQ0QsTUFBTSxPQUFPLEdBQUc7WUFDWixHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUc7WUFDaEIsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJO1lBQ2xCLFVBQVUsRUFBRSxJQUFJO1lBQ2hCLGFBQWEsRUFDVCxTQUFTLENBQUMsZUFBZSxHQUFHLFNBQVMsQ0FBQyxpQkFBaUI7WUFDM0QsT0FBTyxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO1lBQzFCLGdCQUFnQixFQUFFLElBQUk7U0FDekIsQ0FBQztRQUVGLE9BQU8sT0FBTyxDQUFDO0lBQ25CLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2IsTUFBTSxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUNsRCxNQUFNLElBQUksS0FBSyxDQUFDLHlCQUF5QixDQUFDLENBQUM7SUFDL0MsQ0FBQztBQUNMLENBQUM7QUFFRCxNQUFNLENBQUMsS0FBSyxVQUFVLFNBQVMsQ0FBQyxHQUFnQjtJQUMvQyxNQUFNLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7SUFFckMsTUFBTSxPQUFPLEdBQUcsTUFBTSxjQUFjLEVBQUUsQ0FBQztJQUV2QyxLQUFLLFVBQVUsVUFBVTtRQUN4QixNQUFNLENBQUMsSUFBSSxDQUFDLHVDQUF1QyxDQUFDLENBQUM7UUFFckQsTUFBTSxTQUFTLEdBQWMsb0JBQW9CLEVBQUUsQ0FBQztRQUVwRCxJQUFJLENBQUM7WUFDSixNQUFNLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUN4QixNQUFNLENBQUMsSUFBSSxDQUFDLDRCQUE0QixDQUFDLENBQUM7UUFDM0MsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDaEIsTUFBTSxDQUFDLEtBQUssQ0FBQyxzQ0FBc0MsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUM3RCxDQUFDO1FBRUQsSUFBSSxVQUFVLEVBQUUsQ0FBQztZQUNoQixNQUFNLENBQUMsSUFBSSxDQUFDLDhDQUE4QyxDQUFDLENBQUM7UUFDN0QsQ0FBQztRQUNELElBQUksQ0FBQztZQUNKLE1BQU0sV0FBVyxHQUFHLGNBQWMsRUFBRSxDQUFDO1lBQ3JDLElBQUksV0FBVyxFQUFFLENBQUM7Z0JBQ2pCLE1BQU0sV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUN6QixNQUFNLENBQUMsSUFBSSxDQUFDLHlCQUF5QixDQUFDLENBQUM7WUFDeEMsQ0FBQztRQUNGLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2hCLE1BQU0sQ0FBQyxLQUFLLENBQUMsbUNBQW1DLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDMUQsQ0FBQztRQUVELGlDQUFpQztRQUNqQyxRQUFRO1FBQ1Isb0JBQW9CO1FBQ3BCLG1FQUFtRTtRQUVuRSxJQUFJLENBQUM7WUFDSixNQUFNLElBQUksT0FBTyxDQUFPLE9BQU8sQ0FBQyxFQUFFO2dCQUNqQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7Z0JBQ2YsT0FBTyxFQUFFLENBQUM7WUFDWCxDQUFDLENBQUMsQ0FBQztZQUNILE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDOUIsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDaEIsTUFBTSxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUNoRCxDQUFDO0lBQ0YsQ0FBQztJQUVELEtBQUssVUFBVSxXQUFXO1FBQ3pCLElBQUksQ0FBQztZQUNKLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0NBQWdDLFdBQVcsRUFBRSxDQUFDLENBQUM7WUFDM0QsTUFBTSxDQUFDLElBQUksQ0FDViwwRkFBMEYsQ0FDMUYsQ0FBQztZQUVGLE1BQU0sa0JBQWtCLEVBQUUsQ0FBQztZQUUzQixJQUFJLE1BQU0sQ0FBQztZQUVYLElBQUksUUFBUSxFQUFFLENBQUM7Z0JBQ2QsTUFBTSxDQUFDLElBQUksQ0FBQyxpREFBaUQsQ0FBQyxDQUFDO2dCQUUvRCxNQUFNLEdBQUcsS0FBSztxQkFDWixZQUFZLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQztxQkFDMUIsTUFBTSxDQUFDLFdBQVcsRUFBRSxHQUFHLEVBQUU7b0JBQ3pCLE1BQU0sQ0FBQyxJQUFJLENBQ1Ysa0NBQWtDLFdBQVcsRUFBRSxDQUMvQyxDQUFDO2dCQUNILENBQUMsQ0FBQyxDQUFDO1lBQ0wsQ0FBQztpQkFBTSxDQUFDO2dCQUNQLE1BQU0sQ0FBQyxJQUFJLENBQ1YscURBQXFELENBQ3JELENBQUM7Z0JBRUYsTUFBTSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLEdBQUcsRUFBRTtvQkFDckMsTUFBTSxDQUFDLElBQUksQ0FDVixrQ0FBa0MsV0FBVyxFQUFFLENBQy9DLENBQUM7Z0JBQ0gsQ0FBQyxDQUFDLENBQUM7WUFDSixDQUFDO1lBRUQsZ0JBQWdCLENBQUMsTUFBTSxFQUFFO2dCQUN4QixPQUFPLEVBQUUsZ0JBQWdCO2dCQUN6QixPQUFPLEVBQUUsS0FBSztnQkFDZCxXQUFXLEVBQUUsS0FBSztnQkFDbEIsVUFBVTtnQkFDVixPQUFPLEVBQUUsR0FBRyxFQUFFO29CQUNiLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUNBQWlDLENBQUMsQ0FBQztnQkFDaEQsQ0FBQzthQUNELENBQUMsQ0FBQztRQUNKLENBQUM7UUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1lBQ2QsSUFBSSxHQUFHLFlBQVksS0FBSyxFQUFFLENBQUM7Z0JBQzFCLE1BQU0sQ0FBQyxLQUFLLENBQUMsMkJBQTJCLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBQ3hELENBQUM7aUJBQU0sQ0FBQztnQkFDUCxNQUFNLENBQUMsS0FBSyxDQUFDLGdEQUFnRCxDQUFDLENBQUM7WUFDaEUsQ0FBQztZQUNELE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDakIsQ0FBQztJQUNGLENBQUM7SUFFRCxPQUFPLEVBQUUsV0FBVyxFQUFFLENBQUM7QUFDeEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwcGxpY2F0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBwcm9taXNlcyBhcyBmcyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IGNvbnN0YW50cyB9IGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgZ3JhY2VmdWxTaHV0ZG93biBmcm9tICdodHRwLWdyYWNlZnVsLXNodXRkb3duJztcbmltcG9ydCBodHRwcyBmcm9tICdodHRwcyc7XG5pbXBvcnQgc2V0dXBMb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHNvcHMgZnJvbSAnLi9zb3BzJztcbmltcG9ydCB7IFNlcXVlbGl6ZSB9IGZyb20gJ3NlcXVlbGl6ZSc7XG5pbXBvcnQgeyBTZWN1cmVDb250ZXh0T3B0aW9ucyB9IGZyb20gJ3Rscyc7XG5pbXBvcnQge1xuXHRnZXRGZWF0dXJlRmxhZ3MsXG5cdGdldFJlZGlzQ2xpZW50LFxuXHRnZXRTZXF1ZWxpemVJbnN0YW5jZSxcblx0aW5pdGlhbGl6ZURhdGFiYXNlXG59IGZyb20gJy4uL2luZGV4JztcblxuaW50ZXJmYWNlIFNTTEtleXMge1xuXHRrZXk6IHN0cmluZztcblx0Y2VydDogc3RyaW5nO1xufVxuXG50eXBlIE9wdGlvbnMgPSBTZWN1cmVDb250ZXh0T3B0aW9ucztcblxuY29uc3QgbG9nZ2VyID0gc2V0dXBMb2dnZXIoKTtcbmNvbnN0IGZlYXR1cmVGbGFncyA9IGdldEZlYXR1cmVGbGFncygpO1xuXG5jb25zdCBTRVJWRVJfUE9SVCA9IHByb2Nlc3MuZW52LlNFUlZFUl9QT1JUIHx8IDMwMDA7XG5jb25zdCBTU0xfS0VZID0gcHJvY2Vzcy5lbnYuU0VSVkVSX1NTTF9LRVlfUEFUSDtcbmNvbnN0IFNTTF9DRVJUID0gcHJvY2Vzcy5lbnYuU0VSVkVSX1NTTF9DRVJUX1BBVEg7XG5jb25zdCBERUNSWVBUX0tFWVMgPSBmZWF0dXJlRmxhZ3MuZGVjcnlwdEtleXNGbGFnO1xuY29uc3QgU1NMX0ZMQUcgPSBmZWF0dXJlRmxhZ3MuZW5hYmxlU3NsRmxhZztcbmNvbnN0IFJFRElTX0ZMQUcgPSBmZWF0dXJlRmxhZ3MuZW5hYmxlUmVkaXNGbGFnO1xuXG5jb25zdCBjaXBoZXJzID0gW1xuXHQnRUNESEUtRUNEU0EtQUVTMjU2LUdDTS1TSEEzODQnLFxuXHQnRUNESEUtUlNBLUFFUzI1Ni1HQ00tU0hBMzg0Jyxcblx0J0VDREhFLUVDRFNBLUNIQUNIQTIwLVBPTFkxMzA1Jyxcblx0J0VDREhFLVJTQS1DSEFDSEEyMC1QT0xZMTMwNScsXG5cdCdFQ0RIRS1FQ0RTQS1BRVMxMjgtR0NNLVNIQTI1NicsXG5cdCdFQ0RIRS1SU0EtQUVTMTI4LUdDTS1TSEEyNTYnLFxuXHQnRUNESEUtRUNEU0EtQUVTMjU2LVNIQTM4NCcsXG5cdCdFQ0RIRS1SU0EtQUVTMjU2LVNIQTM4NCcsXG5cdCdFQ0RIRS1FQ0RTQS1BRVMxMjgtU0hBMjU2Jyxcblx0J0VDREhFLVJTQS1BRVMxMjgtU0hBMjU2J1xuXTtcblxuYXN5bmMgZnVuY3Rpb24gZGVjbGFyZU9wdGlvbnMoKTogUHJvbWlzZTxPcHRpb25zPiB7XG4gICAgbGV0IHNzbEtleXM6IFNTTEtleXM7XG5cbiAgICBpZiAoREVDUllQVF9LRVlTKSB7XG4gICAgICAgIHNzbEtleXMgPSBhd2FpdCBzb3BzLmdldFNTTEtleXMoKTtcbiAgICAgICAgbG9nZ2VyLmluZm8oJ1NTTCBrZXlzIHJldHJpZXZlZCB2aWEgc29wcy5nZXRTU0xLZXlzKCknKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoIVNTTF9LRVkgfHwgIVNTTF9DRVJUKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NTTF9LRVkgb3IgU1NMX0NFUlQgZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgbm90IHNldCcpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGtleSA9IGF3YWl0IGZzLnJlYWRGaWxlKFNTTF9LRVksICd1dGY4Jyk7XG4gICAgICAgIGNvbnN0IGNlcnQgPSBhd2FpdCBmcy5yZWFkRmlsZShTU0xfQ0VSVCwgJ3V0ZjgnKTtcblxuICAgICAgICBzc2xLZXlzID0geyBrZXksIGNlcnQgfTtcbiAgICAgICAgbG9nZ2VyLmluZm8oJ1VzaW5nIHVuZW5jcnlwdGVkIFNTTCBrZXlzIGZyb20gZW52aXJvbm1lbnQgZmlsZXMnKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICAgICAga2V5OiBzc2xLZXlzLmtleSxcbiAgICAgICAgICAgIGNlcnQ6IHNzbEtleXMuY2VydCxcbiAgICAgICAgICAgIGFsbG93SFRUUDE6IHRydWUsXG4gICAgICAgICAgICBzZWN1cmVPcHRpb25zOlxuICAgICAgICAgICAgICAgIGNvbnN0YW50cy5TU0xfT1BfTk9fVExTdjEgfCBjb25zdGFudHMuU1NMX09QX05PX1RMU3YxXzEsXG4gICAgICAgICAgICBjaXBoZXJzOiBjaXBoZXJzLmpvaW4oJzonKSxcbiAgICAgICAgICAgIGhvbm9yQ2lwaGVyT3JkZXI6IHRydWVcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gb3B0aW9ucztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoYEVycm9yIGRlY2xhcmluZyBvcHRpb25zOiAke2Vycm9yfWApO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Vycm9yIGRlY2xhcmluZyBvcHRpb25zJyk7XG4gICAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2V0dXBIdHRwKGFwcDogQXBwbGljYXRpb24pIHtcblx0bG9nZ2VyLmluZm8oJ3NldHVwSHR0cCgpIGV4ZWN1dGluZycpO1xuXG5cdGNvbnN0IG9wdGlvbnMgPSBhd2FpdCBkZWNsYXJlT3B0aW9ucygpO1xuXG5cdGFzeW5jIGZ1bmN0aW9uIG9uU2h1dGRvd24oKSB7XG5cdFx0bG9nZ2VyLmluZm8oJ0NsZWFuaW5nIHVwIHJlc291cmNlcyBiZWZvcmUgc2h1dGRvd24nKTtcblxuXHRcdGNvbnN0IHNlcXVlbGl6ZTogU2VxdWVsaXplID0gZ2V0U2VxdWVsaXplSW5zdGFuY2UoKTtcblxuXHRcdHRyeSB7XG5cdFx0XHRhd2FpdCBzZXF1ZWxpemUuY2xvc2UoKTtcblx0XHRcdGxvZ2dlci5pbmZvKCdEYXRhYmFzZSBjb25uZWN0aW9uIGNsb3NlZCcpO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHRsb2dnZXIuZXJyb3IoYEVycm9yIGNsb3NpbmcgZGF0YWJhc2UgY29ubmVjdGlvbjogJHtlcnJvcn1gKTtcblx0XHR9XG5cblx0XHRpZiAoUkVESVNfRkxBRykge1xuXHRcdFx0bG9nZ2VyLmluZm8oJ1JFRElTX0ZMQUcgaXMgdHJ1ZS4gQ2xvc2luZyBSZWRpcyBjb25uZWN0aW9uJyk7XG5cdFx0fVxuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCByZWRpc0NsaWVudCA9IGdldFJlZGlzQ2xpZW50KCk7XG5cdFx0XHRpZiAocmVkaXNDbGllbnQpIHtcblx0XHRcdFx0YXdhaXQgcmVkaXNDbGllbnQucXVpdCgpO1xuXHRcdFx0XHRsb2dnZXIuaW5mbygnUmVkaXMgY29ubmVjdGlvbiBjbG9zZWQnKTtcblx0XHRcdH1cblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0bG9nZ2VyLmVycm9yKGBFcnJvciBjbG9zaW5nIFJlZGlzIGNvbm5lY3Rpb246ICR7ZXJyb3J9YCk7XG5cdFx0fVxuXG5cdFx0Ly8gTm90aWZ5IG1vbml0b3Jpbmcgc3lzdGVtcyBoZXJlXG5cdFx0Ly8gdHJ5IHtcblx0XHQvLyB9IGNhdGNoIChlcnJvcikge1xuXHRcdC8vIH0gbG9nZ2VyLmVycm9yKGBFcnJvciBub3RpZnlpbmcgbW9uaXRvcmluZyBzeXN0ZW1zOiAke2Vycm9yfSBgKTtcblxuXHRcdHRyeSB7XG5cdFx0XHRhd2FpdCBuZXcgUHJvbWlzZTx2b2lkPihyZXNvbHZlID0+IHtcblx0XHRcdFx0bG9nZ2VyLmNsb3NlKCk7XG5cdFx0XHRcdHJlc29sdmUoKTtcblx0XHRcdH0pO1xuXHRcdFx0Y29uc29sZS5sb2coJ0xvZ2dlciBjbG9zZWQnKTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0bG9nZ2VyLmVycm9yKGBFcnJvciBjbG9zaW5nIGxvZ2dlcjogJHtlcnJvcn1gKTtcblx0XHR9XG5cdH1cblxuXHRhc3luYyBmdW5jdGlvbiBzdGFydFNlcnZlcigpIHtcblx0XHR0cnkge1xuXHRcdFx0bG9nZ2VyLmluZm8oYFN0YXJ0aW5nIEhUVFAgc2VydmVyIG9uIHBvcnQgJHtTRVJWRVJfUE9SVH1gKTtcblx0XHRcdGxvZ2dlci5pbmZvKFxuXHRcdFx0XHQnSW5pdGlhbGl6aW5nIGRhdGFiYXNlIGJlZm9yZSBzdGFydGluZyBzZXJ2ZXIuIEF3YWl0aW5nIGV4ZWN1dGlvbiBvZiBpbml0aWFsaXplRGF0YWJhc2UoKSdcblx0XHRcdCk7XG5cblx0XHRcdGF3YWl0IGluaXRpYWxpemVEYXRhYmFzZSgpO1xuXG5cdFx0XHRsZXQgc2VydmVyO1xuXG5cdFx0XHRpZiAoU1NMX0ZMQUcpIHtcblx0XHRcdFx0bG9nZ2VyLmluZm8oJ1NTTF9GTEFHIGlzIHRydWUuIFN0YXJ0aW5nIEhUVFAgc2VydmVyIHdpdGggU1NMJyk7XG5cblx0XHRcdFx0c2VydmVyID0gaHR0cHNcblx0XHRcdFx0XHQuY3JlYXRlU2VydmVyKG9wdGlvbnMsIGFwcClcblx0XHRcdFx0XHQubGlzdGVuKFNFUlZFUl9QT1JULCAoKSA9PiB7XG5cdFx0XHRcdFx0XHRsb2dnZXIuaW5mbyhcblx0XHRcdFx0XHRcdFx0YEhUVFAxLjEgc2VydmVyIHJ1bm5pbmcgb24gcG9ydCAke1NFUlZFUl9QT1JUfWBcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRsb2dnZXIuaW5mbyhcblx0XHRcdFx0XHQnU1NMX0ZMQUcgaXMgZmFsc2UuIFN0YXJ0aW5nIEhUVFAgc2VydmVyIHdpdGhvdXQgU1NMJ1xuXHRcdFx0XHQpO1xuXG5cdFx0XHRcdHNlcnZlciA9IGFwcC5saXN0ZW4oU0VSVkVSX1BPUlQsICgpID0+IHtcblx0XHRcdFx0XHRsb2dnZXIuaW5mbyhcblx0XHRcdFx0XHRcdGBIVFRQMS4xIHNlcnZlciBydW5uaW5nIG9uIHBvcnQgJHtTRVJWRVJfUE9SVH1gXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cblx0XHRcdGdyYWNlZnVsU2h1dGRvd24oc2VydmVyLCB7XG5cdFx0XHRcdHNpZ25hbHM6ICdTSUdJTlQgU0lHVEVSTScsXG5cdFx0XHRcdHRpbWVvdXQ6IDMwMDAwLFxuXHRcdFx0XHRkZXZlbG9wbWVudDogZmFsc2UsXG5cdFx0XHRcdG9uU2h1dGRvd24sXG5cdFx0XHRcdGZpbmFsbHk6ICgpID0+IHtcblx0XHRcdFx0XHRjb25zb2xlLmxvZygnU2VydmVyIGhhcyBncmFjZWZ1bGx5IHNodXQgZG93bicpO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdGlmIChlcnIgaW5zdGFuY2VvZiBFcnJvcikge1xuXHRcdFx0XHRsb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBzdGFydCBzZXJ2ZXI6ICR7ZXJyLm1lc3NhZ2V9YCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBzdGFydCBzZXJ2ZXIgZHVlIHRvIGFuIHVua25vd24gZXJyb3InKTtcblx0XHRcdH1cblx0XHRcdHByb2Nlc3MuZXhpdCgxKTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4geyBzdGFydFNlcnZlciB9O1xufVxuIl19
