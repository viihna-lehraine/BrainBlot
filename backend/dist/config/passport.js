import { Strategy as JwtStrategy, ExtractJwt } from 'passport-jwt';
import { Strategy as LocalStrategy } from 'passport-local';
import setupLogger from '../middleware/logger.js';
import getSecrets from './secrets.js';
import UserModelPromise from '../models/User.js';
export default async function configurePassport(passport) {
	let secrets = await getSecrets();
	let logger = await setupLogger();
	let UserModel = await UserModelPromise;
	let opts = {
		jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
		secretOrKey: secrets.JWT_SECRET
	};
	passport.use(
		new JwtStrategy(opts, async (jwt_payload, done) => {
			try {
				let user = await UserModel.findByPk(jwt_payload.id);
				if (user) {
					logger.info(
						'JWT authentication successful for user ID: ',
						jwt_payload.id
					);
					return done(null, user);
				} else {
					logger.warn(
						'JWT authentication failed for user ID: ',
						jwt_payload.id
					);
					return done(null, false);
				}
			} catch (err) {
				logger.error('JWT authentication error: ', err);
				return done(err, false);
			}
		})
	);
	passport.use(
		new LocalStrategy(async (username, password, done) => {
			try {
				let user = await UserModel.findOne({ where: { username } });
				if (!user) {
					logger.warn(
						'Local authentication failed: User not found: ',
						username
					);
					return done(null, false, { message: 'User not found' });
				}
				let isMatch = await user.comparePassword(password);
				if (isMatch) {
					logger.info(
						'Local authentication successful for user: ',
						username
					);
					return done(null, user);
				} else {
					logger.warn(
						'Local authentication failed: incorrect password for user: ',
						username
					);
					return done(null, false, { message: 'Incorrect password' });
				}
			} catch (err) {
				logger.error(
					'Local authenticaton error for user: ',
					username,
					' : Error: ',
					err
				);
				return done(err);
			}
		})
	);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFzc3BvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29uZmlnL3Bhc3Nwb3J0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFDTixRQUFRLElBQUksV0FBVyxFQUN2QixVQUFVLEVBRVYsTUFBTSxjQUFjLENBQUM7QUFDdEIsT0FBTyxFQUFFLFFBQVEsSUFBSSxhQUFhLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzRCxPQUFPLFdBQVcsTUFBTSxzQkFBc0IsQ0FBQztBQUMvQyxPQUFPLFVBQVUsTUFBTSxXQUFXLENBQUM7QUFDbkMsT0FBTyxnQkFBZ0IsTUFBTSxnQkFBZ0IsQ0FBQztBQVM5QyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssVUFBVSxpQkFBaUIsQ0FBQyxRQUF3QjtJQUN2RSxJQUFJLE9BQU8sR0FBRyxNQUFNLFVBQVUsRUFBRSxDQUFDO0lBQ2pDLElBQUksTUFBTSxHQUFHLE1BQU0sV0FBVyxFQUFFLENBQUM7SUFDakMsSUFBSSxTQUFTLEdBQUcsTUFBTSxnQkFBZ0IsQ0FBQztJQUV2QyxJQUFJLElBQUksR0FBb0I7UUFDM0IsY0FBYyxFQUFFLFVBQVUsQ0FBQywyQkFBMkIsRUFBRTtRQUN4RCxXQUFXLEVBQUUsT0FBTyxDQUFDLFVBQVU7S0FDL0IsQ0FBQztJQUVGLFFBQVEsQ0FBQyxHQUFHLENBQ1gsSUFBSSxXQUFXLENBQ2QsSUFBSSxFQUNKLEtBQUssRUFDSixXQUEyQixFQUMzQixJQUlTLEVBQ1IsRUFBRTtRQUNILElBQUksQ0FBQztZQUNKLElBQUksSUFBSSxHQUFHLE1BQU0sU0FBUyxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDcEQsSUFBSSxJQUFJLEVBQUUsQ0FBQztnQkFDVixNQUFNLENBQUMsSUFBSSxDQUNWLDZDQUE2QyxFQUM3QyxXQUFXLENBQUMsRUFBRSxDQUNkLENBQUM7Z0JBQ0YsT0FBTyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ3pCLENBQUM7aUJBQU0sQ0FBQztnQkFDUCxNQUFNLENBQUMsSUFBSSxDQUNWLHlDQUF5QyxFQUN6QyxXQUFXLENBQUMsRUFBRSxDQUNkLENBQUM7Z0JBQ0YsT0FBTyxJQUFJLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzFCLENBQUM7UUFDRixDQUFDO1FBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNkLE1BQU0sQ0FBQyxLQUFLLENBQUMsNEJBQTRCLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDaEQsT0FBTyxJQUFJLENBQUMsR0FBWSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2xDLENBQUM7SUFDRixDQUFDLENBQ0QsQ0FDRCxDQUFDO0lBRUYsUUFBUSxDQUFDLEdBQUcsQ0FDWCxJQUFJLGFBQWEsQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsRUFBRTtRQUNwRCxJQUFJLENBQUM7WUFDSixJQUFJLElBQUksR0FBRyxNQUFNLFNBQVMsQ0FBQyxPQUFPLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRSxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDNUQsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNYLE1BQU0sQ0FBQyxJQUFJLENBQ1YsK0NBQStDLEVBQy9DLFFBQVEsQ0FDUixDQUFDO2dCQUNGLE9BQU8sSUFBSSxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO1lBQ3pELENBQUM7WUFFRCxJQUFJLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDbkQsSUFBSSxPQUFPLEVBQUUsQ0FBQztnQkFDYixNQUFNLENBQUMsSUFBSSxDQUNWLDRDQUE0QyxFQUM1QyxRQUFRLENBQ1IsQ0FBQztnQkFDRixPQUFPLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDekIsQ0FBQztpQkFBTSxDQUFDO2dCQUNQLE1BQU0sQ0FBQyxJQUFJLENBQ1YsNERBQTRELEVBQzVELFFBQVEsQ0FDUixDQUFDO2dCQUNGLE9BQU8sSUFBSSxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsQ0FBQyxDQUFDO1lBQzdELENBQUM7UUFDRixDQUFDO1FBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNkLE1BQU0sQ0FBQyxLQUFLLENBQ1gsc0NBQXNDLEVBQ3RDLFFBQVEsRUFDUixZQUFZLEVBQ1osR0FBRyxDQUNILENBQUM7WUFDRixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsQixDQUFDO0lBQ0YsQ0FBQyxDQUFDLENBQ0YsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQYXNzcG9ydFN0YXRpYyB9IGZyb20gJ3Bhc3Nwb3J0JztcbmltcG9ydCB7XG5cdFN0cmF0ZWd5IGFzIEp3dFN0cmF0ZWd5LFxuXHRFeHRyYWN0Snd0LFxuXHRTdHJhdGVneU9wdGlvbnNcbn0gZnJvbSAncGFzc3BvcnQtand0JztcbmltcG9ydCB7IFN0cmF0ZWd5IGFzIExvY2FsU3RyYXRlZ3kgfSBmcm9tICdwYXNzcG9ydC1sb2NhbCc7XG5pbXBvcnQgc2V0dXBMb2dnZXIgZnJvbSAnLi4vbWlkZGxld2FyZS9sb2dnZXInO1xuaW1wb3J0IGdldFNlY3JldHMgZnJvbSAnLi9zZWNyZXRzJztcbmltcG9ydCBVc2VyTW9kZWxQcm9taXNlIGZyb20gJy4uL21vZGVscy9Vc2VyJztcblxuLy8gRGVmaW5lIHRoZSBzaGFwZSBvZiBhIHVzZXIgaW5zdGFuY2UgYmFzZWQgb24gVXNlciBtb2RlbFxuaW50ZXJmYWNlIFVzZXJJbnN0YW5jZSB7XG5cdGlkOiBzdHJpbmc7XG5cdHVzZXJuYW1lOiBzdHJpbmc7XG5cdGNvbXBhcmVQYXNzd29yZDogKHBhc3N3b3JkOiBzdHJpbmcpID0+IFByb21pc2U8Ym9vbGVhbj47XG59XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIGZ1bmN0aW9uIGNvbmZpZ3VyZVBhc3Nwb3J0KHBhc3Nwb3J0OiBQYXNzcG9ydFN0YXRpYykge1xuXHRsZXQgc2VjcmV0cyA9IGF3YWl0IGdldFNlY3JldHMoKTtcblx0bGV0IGxvZ2dlciA9IGF3YWl0IHNldHVwTG9nZ2VyKCk7XG5cdGxldCBVc2VyTW9kZWwgPSBhd2FpdCBVc2VyTW9kZWxQcm9taXNlO1xuXG5cdGxldCBvcHRzOiBTdHJhdGVneU9wdGlvbnMgPSB7XG5cdFx0and0RnJvbVJlcXVlc3Q6IEV4dHJhY3RKd3QuZnJvbUF1dGhIZWFkZXJBc0JlYXJlclRva2VuKCksXG5cdFx0c2VjcmV0T3JLZXk6IHNlY3JldHMuSldUX1NFQ1JFVFxuXHR9O1xuXG5cdHBhc3Nwb3J0LnVzZShcblx0XHRuZXcgSnd0U3RyYXRlZ3koXG5cdFx0XHRvcHRzLFxuXHRcdFx0YXN5bmMgKFxuXHRcdFx0XHRqd3RfcGF5bG9hZDogeyBpZDogc3RyaW5nIH0sXG5cdFx0XHRcdGRvbmU6IChcblx0XHRcdFx0XHRlcnJvcjogRXJyb3IgfCBudWxsLFxuXHRcdFx0XHRcdHVzZXI/OiBVc2VySW5zdGFuY2UgfCBmYWxzZSxcblx0XHRcdFx0XHRpbmZvPzogdW5rbm93blxuXHRcdFx0XHQpID0+IHZvaWRcblx0XHRcdCkgPT4ge1xuXHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdGxldCB1c2VyID0gYXdhaXQgVXNlck1vZGVsLmZpbmRCeVBrKGp3dF9wYXlsb2FkLmlkKTtcblx0XHRcdFx0XHRpZiAodXNlcikge1xuXHRcdFx0XHRcdFx0bG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0XHRcdCdKV1QgYXV0aGVudGljYXRpb24gc3VjY2Vzc2Z1bCBmb3IgdXNlciBJRDogJyxcblx0XHRcdFx0XHRcdFx0and0X3BheWxvYWQuaWRcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRyZXR1cm4gZG9uZShudWxsLCB1c2VyKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0bG9nZ2VyLndhcm4oXG5cdFx0XHRcdFx0XHRcdCdKV1QgYXV0aGVudGljYXRpb24gZmFpbGVkIGZvciB1c2VyIElEOiAnLFxuXHRcdFx0XHRcdFx0XHRqd3RfcGF5bG9hZC5pZFxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdHJldHVybiBkb25lKG51bGwsIGZhbHNlKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0XHRcdGxvZ2dlci5lcnJvcignSldUIGF1dGhlbnRpY2F0aW9uIGVycm9yOiAnLCBlcnIpO1xuXHRcdFx0XHRcdHJldHVybiBkb25lKGVyciBhcyBFcnJvciwgZmFsc2UpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0KVxuXHQpO1xuXG5cdHBhc3Nwb3J0LnVzZShcblx0XHRuZXcgTG9jYWxTdHJhdGVneShhc3luYyAodXNlcm5hbWUsIHBhc3N3b3JkLCBkb25lKSA9PiB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRsZXQgdXNlciA9IGF3YWl0IFVzZXJNb2RlbC5maW5kT25lKHsgd2hlcmU6IHsgdXNlcm5hbWUgfSB9KTtcblx0XHRcdFx0aWYgKCF1c2VyKSB7XG5cdFx0XHRcdFx0bG9nZ2VyLndhcm4oXG5cdFx0XHRcdFx0XHQnTG9jYWwgYXV0aGVudGljYXRpb24gZmFpbGVkOiBVc2VyIG5vdCBmb3VuZDogJyxcblx0XHRcdFx0XHRcdHVzZXJuYW1lXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRyZXR1cm4gZG9uZShudWxsLCBmYWxzZSwgeyBtZXNzYWdlOiAnVXNlciBub3QgZm91bmQnIH0pO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0bGV0IGlzTWF0Y2ggPSBhd2FpdCB1c2VyLmNvbXBhcmVQYXNzd29yZChwYXNzd29yZCk7XG5cdFx0XHRcdGlmIChpc01hdGNoKSB7XG5cdFx0XHRcdFx0bG9nZ2VyLmluZm8oXG5cdFx0XHRcdFx0XHQnTG9jYWwgYXV0aGVudGljYXRpb24gc3VjY2Vzc2Z1bCBmb3IgdXNlcjogJyxcblx0XHRcdFx0XHRcdHVzZXJuYW1lXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRyZXR1cm4gZG9uZShudWxsLCB1c2VyKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRsb2dnZXIud2Fybihcblx0XHRcdFx0XHRcdCdMb2NhbCBhdXRoZW50aWNhdGlvbiBmYWlsZWQ6IGluY29ycmVjdCBwYXNzd29yZCBmb3IgdXNlcjogJyxcblx0XHRcdFx0XHRcdHVzZXJuYW1lXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRyZXR1cm4gZG9uZShudWxsLCBmYWxzZSwgeyBtZXNzYWdlOiAnSW5jb3JyZWN0IHBhc3N3b3JkJyB9KTtcblx0XHRcdFx0fVxuXHRcdFx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0XHRcdGxvZ2dlci5lcnJvcihcblx0XHRcdFx0XHQnTG9jYWwgYXV0aGVudGljYXRvbiBlcnJvciBmb3IgdXNlcjogJyxcblx0XHRcdFx0XHR1c2VybmFtZSxcblx0XHRcdFx0XHQnIDogRXJyb3I6ICcsXG5cdFx0XHRcdFx0ZXJyXG5cdFx0XHRcdCk7XG5cdFx0XHRcdHJldHVybiBkb25lKGVycik7XG5cdFx0XHR9XG5cdFx0fSlcblx0KTtcbn1cbiJdfQ==
