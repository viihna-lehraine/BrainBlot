import fs from 'fs';
import { createLogger, format, transports } from 'winston';
import DailyRotateFile from 'winston-daily-rotate-file';
import { environmentVariables } from './environmentConfig.mjs';
import { validateDependencies } from '../utils/validateDependencies.mjs';
const { colorize, combine, errors, json, printf, timestamp } = format;
const logFormat = printf(({ level, message, timestamp, stack }) => {
	return `${timestamp} ${level}: ${stack || message}`;
});
let loggerInstance = null;
export function setupLogger({
	logLevel = environmentVariables.logLevel || 'info',
	logDirectory = environmentVariables.serverLogPath,
	serviceName = environmentVariables.serviceName,
	isProduction = environmentVariables.nodeEnv === 'production'
} = {}) {
	try {
		validateDependencies(
			[
				{ name: 'logLevel', instance: logLevel },
				{ name: 'logDirectory', instance: logDirectory },
				{ name: 'serviceName', instance: serviceName },
				{ name: 'isProduction', instance: isProduction }
			],
			console
		);
		if (loggerInstance) {
			console.log(
				'Logger instance already exists. Returning the existing instance.'
			);
			return loggerInstance;
		}
		if (!logDirectory || typeof logDirectory !== 'string') {
			logDirectory = './logs';
			console.warn(
				'Invalid or missing log directory path. Using default "./logs".'
			);
		}
		if (!fs.existsSync(logDirectory)) {
			console.error(
				`Log directory does not exist at ${logDirectory}. Attempting to create it...`
			);
			try {
				fs.mkdirSync(logDirectory, { recursive: true });
				console.log(
					`Log directory ${logDirectory} created successfully.`
				);
			} catch (error) {
				console.error(`Failed to create log directory`);
				throw new Error(`Failed to create log directory`);
			}
		}
		loggerInstance = createLogger({
			level: isProduction ? 'info' : logLevel,
			format: combine(
				errors({ stack: true }),
				timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
				json()
			),
			defaultMeta: { service: serviceName },
			transports: [
				new transports.Console({
					format: combine(colorize(), logFormat)
				}),
				new DailyRotateFile({
					filename: 'server-%DATE%.log',
					dirname: logDirectory,
					datePattern: 'YYYY-MM-DD',
					zippedArchive: true,
					maxSize: '20m',
					maxFiles: '14d',
					format: combine(
						timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
						logFormat
					)
				})
			]
		});
		console.log = (...args) => loggerInstance?.info(args.join(' '));
		console.info = (...args) => loggerInstance?.info(args.join(' '));
		console.warn = (...args) => loggerInstance?.warn(args.join(' '));
		console.error = (...args) => loggerInstance?.error(args.join(' '));
		console.debug = (...args) => loggerInstance?.debug(args.join(' '));
		return loggerInstance;
	} catch (error) {
		console.error(`Failed to initialize logger: ${error}`);
		return Object.assign(
			createLogger({
				level: 'error',
				format: combine(timestamp(), logFormat),
				transports: [
					new transports.Console({
						format: combine(colorize(), logFormat)
					})
				]
			}),
			{
				stream: {
					write: message => {
						console.error(message.trim());
					}
				}
			}
		);
	}
}
export function isLogger(logger) {
	return (
		logger !== undefined &&
		logger !== null &&
		typeof logger.error === 'function' &&
		typeof logger.warn === 'function' &&
		typeof logger.debug === 'function' &&
		typeof logger.info === 'function'
	);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NvbmZpZy9sb2dnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3BCLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUEyQixVQUFVLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDcEYsT0FBTyxlQUFlLE1BQU0sMkJBQTJCLENBQUM7QUFDeEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDM0QsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFFckUsTUFBTSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLEdBQUcsTUFBTSxDQUFDO0FBRXRFLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRTtJQUNqRSxPQUFPLEdBQUcsU0FBUyxJQUFJLEtBQUssS0FBSyxLQUFLLElBQUksT0FBTyxFQUFFLENBQUM7QUFDckQsQ0FBQyxDQUFDLENBQUM7QUFVSCxJQUFJLGNBQWMsR0FBeUIsSUFBSSxDQUFDO0FBRWhELE1BQU0sVUFBVSxXQUFXLENBQUMsRUFDM0IsUUFBUSxHQUFHLG9CQUFvQixDQUFDLFFBQVEsSUFBSSxNQUFNLEVBQ2xELFlBQVksR0FBRyxvQkFBb0IsQ0FBQyxhQUFhLEVBQ2pELFdBQVcsR0FBRyxvQkFBb0IsQ0FBQyxXQUFXLEVBQzlDLFlBQVksR0FBRyxvQkFBb0IsQ0FBQyxPQUFPLEtBQUssWUFBWSxNQUNyQyxFQUFFO0lBQ3pCLElBQUksQ0FBQztRQUNKLG9CQUFvQixDQUNuQjtZQUNDLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFO1lBQ3hDLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFO1lBQ2hELEVBQUUsSUFBSSxFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFO1lBQzlDLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFO1NBQ2hELEVBQ0QsT0FBTyxDQUNQLENBQUM7UUFFRixJQUFJLGNBQWMsRUFBRSxDQUFDO1lBQ3BCLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0VBQWtFLENBQUMsQ0FBQztZQUNoRixPQUFPLGNBQWMsQ0FBQztRQUN2QixDQUFDO1FBRUQsSUFBSSxDQUFDLFlBQVksSUFBSSxPQUFPLFlBQVksS0FBSyxRQUFRLEVBQUUsQ0FBQztZQUN2RCxZQUFZLEdBQUcsUUFBUSxDQUFDO1lBQ3hCLE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0VBQWdFLENBQUMsQ0FBQztRQUNoRixDQUFDO1FBRUQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQztZQUNsQyxPQUFPLENBQUMsS0FBSyxDQUFDLG1DQUFtQyxZQUFZLDhCQUE4QixDQUFDLENBQUM7WUFDN0YsSUFBSSxDQUFDO2dCQUNKLEVBQUUsQ0FBQyxTQUFTLENBQUMsWUFBWSxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7Z0JBQ2hELE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLFlBQVksd0JBQXdCLENBQUMsQ0FBQztZQUNwRSxDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDaEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO2dCQUNoRCxNQUFNLElBQUksS0FBSyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7WUFDbkQsQ0FBQztRQUNGLENBQUM7UUFFRCxjQUFjLEdBQUcsWUFBWSxDQUFDO1lBQzdCLEtBQUssRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsUUFBUTtZQUN2QyxNQUFNLEVBQUUsT0FBTyxDQUNkLE1BQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUN2QixTQUFTLENBQUMsRUFBRSxNQUFNLEVBQUUscUJBQXFCLEVBQUUsQ0FBQyxFQUM1QyxJQUFJLEVBQUUsQ0FDTjtZQUNELFdBQVcsRUFBRSxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUU7WUFDckMsVUFBVSxFQUFFO2dCQUNYLElBQUksVUFBVSxDQUFDLE9BQU8sQ0FBQztvQkFDdEIsTUFBTSxFQUFFLE9BQU8sQ0FBQyxRQUFRLEVBQUUsRUFBRSxTQUFTLENBQUM7aUJBQ3RDLENBQUM7Z0JBQ0YsSUFBSSxlQUFlLENBQUM7b0JBQ25CLFFBQVEsRUFBRSxtQkFBbUI7b0JBQzdCLE9BQU8sRUFBRSxZQUFZO29CQUNyQixXQUFXLEVBQUUsWUFBWTtvQkFDekIsYUFBYSxFQUFFLElBQUk7b0JBQ25CLE9BQU8sRUFBRSxLQUFLO29CQUNkLFFBQVEsRUFBRSxLQUFLO29CQUNmLE1BQU0sRUFBRSxPQUFPLENBQ2QsU0FBUyxDQUFDLEVBQUUsTUFBTSxFQUFFLHFCQUFxQixFQUFFLENBQUMsRUFDNUMsU0FBUyxDQUNUO2lCQUNELENBQUM7YUFDRjtTQUNELENBQUMsQ0FBQztRQUVILE9BQU8sQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLElBQUksRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDaEUsT0FBTyxDQUFDLElBQUksR0FBRyxDQUFDLEdBQUcsSUFBSSxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNqRSxPQUFPLENBQUMsSUFBSSxHQUFHLENBQUMsR0FBRyxJQUFJLEVBQUUsRUFBRSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2pFLE9BQU8sQ0FBQyxLQUFLLEdBQUcsQ0FBQyxHQUFHLElBQUksRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDbkUsT0FBTyxDQUFDLEtBQUssR0FBRyxDQUFDLEdBQUcsSUFBSSxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUVuRSxPQUFPLGNBQWMsQ0FBQztJQUN2QixDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNoQixPQUFPLENBQUMsS0FBSyxDQUFDLGdDQUFnQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQ3ZELE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUM7WUFDakMsS0FBSyxFQUFFLE9BQU87WUFDZCxNQUFNLEVBQUUsT0FBTyxDQUFDLFNBQVMsRUFBRSxFQUFFLFNBQVMsQ0FBQztZQUN2QyxVQUFVLEVBQUU7Z0JBQ1gsSUFBSSxVQUFVLENBQUMsT0FBTyxDQUFDO29CQUN0QixNQUFNLEVBQUUsT0FBTyxDQUFDLFFBQVEsRUFBRSxFQUFFLFNBQVMsQ0FBQztpQkFDdEMsQ0FBQzthQUNGO1NBQ0QsQ0FBQyxFQUFFO1lBQ0gsTUFBTSxFQUFFO2dCQUNQLEtBQUssRUFBRSxDQUFDLE9BQWUsRUFBRSxFQUFFO29CQUMxQixPQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO2dCQUMvQixDQUFDO2FBQ0Q7U0FDRCxDQUFDLENBQUM7SUFDSixDQUFDO0FBQ0YsQ0FBQztBQUVELE1BQU0sVUFBVSxRQUFRLENBQUMsTUFBb0M7SUFDNUQsT0FBTyxDQUNOLE1BQU0sS0FBSyxTQUFTO1FBQ3BCLE1BQU0sS0FBSyxJQUFJO1FBQ2YsT0FBTyxNQUFNLENBQUMsS0FBSyxLQUFLLFVBQVU7UUFDbEMsT0FBTyxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVU7UUFDakMsT0FBTyxNQUFNLENBQUMsS0FBSyxLQUFLLFVBQVU7UUFDbEMsT0FBTyxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FDakMsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgY3JlYXRlTG9nZ2VyLCBmb3JtYXQsIExvZ2dlciBhcyBXaW5zdG9uTG9nZ2VyLCB0cmFuc3BvcnRzIH0gZnJvbSAnd2luc3Rvbic7XG5pbXBvcnQgRGFpbHlSb3RhdGVGaWxlIGZyb20gJ3dpbnN0b24tZGFpbHktcm90YXRlLWZpbGUnO1xuaW1wb3J0IHsgZW52aXJvbm1lbnRWYXJpYWJsZXMgfSBmcm9tICcuL2Vudmlyb25tZW50Q29uZmlnJztcbmltcG9ydCB7IHZhbGlkYXRlRGVwZW5kZW5jaWVzIH0gZnJvbSAnLi4vdXRpbHMvdmFsaWRhdGVEZXBlbmRlbmNpZXMnO1xuXG5jb25zdCB7IGNvbG9yaXplLCBjb21iaW5lLCBlcnJvcnMsIGpzb24sIHByaW50ZiwgdGltZXN0YW1wIH0gPSBmb3JtYXQ7XG5cbmNvbnN0IGxvZ0Zvcm1hdCA9IHByaW50ZigoeyBsZXZlbCwgbWVzc2FnZSwgdGltZXN0YW1wLCBzdGFjayB9KSA9PiB7XG5cdHJldHVybiBgJHt0aW1lc3RhbXB9ICR7bGV2ZWx9OiAke3N0YWNrIHx8IG1lc3NhZ2V9YDtcbn0pO1xuXG5leHBvcnQgaW50ZXJmYWNlIExvZ2dlckRlcGVuZGVuY2llcyB7XG5cdGxvZ0xldmVsPzogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXHRsb2dEaXJlY3Rvcnk/OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cdHNlcnZpY2VOYW1lPzogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXHRpc1Byb2R1Y3Rpb24/OiBib29sZWFuIHwgdW5kZWZpbmVkO1xuXHRjb25zb2xlPzogdHlwZW9mIGNvbnNvbGU7XG59XG5cbmxldCBsb2dnZXJJbnN0YW5jZTogV2luc3RvbkxvZ2dlciB8IG51bGwgPSBudWxsO1xuXG5leHBvcnQgZnVuY3Rpb24gc2V0dXBMb2dnZXIoe1xuXHRsb2dMZXZlbCA9IGVudmlyb25tZW50VmFyaWFibGVzLmxvZ0xldmVsIHx8ICdpbmZvJyxcblx0bG9nRGlyZWN0b3J5ID0gZW52aXJvbm1lbnRWYXJpYWJsZXMuc2VydmVyTG9nUGF0aCxcblx0c2VydmljZU5hbWUgPSBlbnZpcm9ubWVudFZhcmlhYmxlcy5zZXJ2aWNlTmFtZSxcblx0aXNQcm9kdWN0aW9uID0gZW52aXJvbm1lbnRWYXJpYWJsZXMubm9kZUVudiA9PT0gJ3Byb2R1Y3Rpb24nLFxufTogTG9nZ2VyRGVwZW5kZW5jaWVzID0ge30pOiBXaW5zdG9uTG9nZ2VyIHtcblx0dHJ5IHtcblx0XHR2YWxpZGF0ZURlcGVuZGVuY2llcyhcblx0XHRcdFtcblx0XHRcdFx0eyBuYW1lOiAnbG9nTGV2ZWwnLCBpbnN0YW5jZTogbG9nTGV2ZWwgfSxcblx0XHRcdFx0eyBuYW1lOiAnbG9nRGlyZWN0b3J5JywgaW5zdGFuY2U6IGxvZ0RpcmVjdG9yeSB9LFxuXHRcdFx0XHR7IG5hbWU6ICdzZXJ2aWNlTmFtZScsIGluc3RhbmNlOiBzZXJ2aWNlTmFtZSB9LFxuXHRcdFx0XHR7IG5hbWU6ICdpc1Byb2R1Y3Rpb24nLCBpbnN0YW5jZTogaXNQcm9kdWN0aW9uIH1cblx0XHRcdF0sXG5cdFx0XHRjb25zb2xlXG5cdFx0KTtcblxuXHRcdGlmIChsb2dnZXJJbnN0YW5jZSkge1xuXHRcdFx0Y29uc29sZS5sb2coJ0xvZ2dlciBpbnN0YW5jZSBhbHJlYWR5IGV4aXN0cy4gUmV0dXJuaW5nIHRoZSBleGlzdGluZyBpbnN0YW5jZS4nKTtcblx0XHRcdHJldHVybiBsb2dnZXJJbnN0YW5jZTtcblx0XHR9XG5cblx0XHRpZiAoIWxvZ0RpcmVjdG9yeSB8fCB0eXBlb2YgbG9nRGlyZWN0b3J5ICE9PSAnc3RyaW5nJykge1xuXHRcdFx0bG9nRGlyZWN0b3J5ID0gJy4vbG9ncyc7XG5cdFx0XHRjb25zb2xlLndhcm4oJ0ludmFsaWQgb3IgbWlzc2luZyBsb2cgZGlyZWN0b3J5IHBhdGguIFVzaW5nIGRlZmF1bHQgXCIuL2xvZ3NcIi4nKTtcblx0XHR9XG5cblx0XHRpZiAoIWZzLmV4aXN0c1N5bmMobG9nRGlyZWN0b3J5KSkge1xuXHRcdFx0Y29uc29sZS5lcnJvcihgTG9nIGRpcmVjdG9yeSBkb2VzIG5vdCBleGlzdCBhdCAke2xvZ0RpcmVjdG9yeX0uIEF0dGVtcHRpbmcgdG8gY3JlYXRlIGl0Li4uYCk7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRmcy5ta2RpclN5bmMobG9nRGlyZWN0b3J5LCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcblx0XHRcdFx0Y29uc29sZS5sb2coYExvZyBkaXJlY3RvcnkgJHtsb2dEaXJlY3Rvcnl9IGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5LmApO1xuXHRcdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdFx0Y29uc29sZS5lcnJvcihgRmFpbGVkIHRvIGNyZWF0ZSBsb2cgZGlyZWN0b3J5YCk7XG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGNyZWF0ZSBsb2cgZGlyZWN0b3J5YCk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0bG9nZ2VySW5zdGFuY2UgPSBjcmVhdGVMb2dnZXIoe1xuXHRcdFx0bGV2ZWw6IGlzUHJvZHVjdGlvbiA/ICdpbmZvJyA6IGxvZ0xldmVsLFxuXHRcdFx0Zm9ybWF0OiBjb21iaW5lKFxuXHRcdFx0XHRlcnJvcnMoeyBzdGFjazogdHJ1ZSB9KSxcblx0XHRcdFx0dGltZXN0YW1wKHsgZm9ybWF0OiAnWVlZWS1NTS1ERCBISDptbTpzcycgfSksXG5cdFx0XHRcdGpzb24oKVxuXHRcdFx0KSxcblx0XHRcdGRlZmF1bHRNZXRhOiB7IHNlcnZpY2U6IHNlcnZpY2VOYW1lIH0sXG5cdFx0XHR0cmFuc3BvcnRzOiBbXG5cdFx0XHRcdG5ldyB0cmFuc3BvcnRzLkNvbnNvbGUoe1xuXHRcdFx0XHRcdGZvcm1hdDogY29tYmluZShjb2xvcml6ZSgpLCBsb2dGb3JtYXQpLFxuXHRcdFx0XHR9KSxcblx0XHRcdFx0bmV3IERhaWx5Um90YXRlRmlsZSh7XG5cdFx0XHRcdFx0ZmlsZW5hbWU6ICdzZXJ2ZXItJURBVEUlLmxvZycsXG5cdFx0XHRcdFx0ZGlybmFtZTogbG9nRGlyZWN0b3J5LFxuXHRcdFx0XHRcdGRhdGVQYXR0ZXJuOiAnWVlZWS1NTS1ERCcsXG5cdFx0XHRcdFx0emlwcGVkQXJjaGl2ZTogdHJ1ZSxcblx0XHRcdFx0XHRtYXhTaXplOiAnMjBtJyxcblx0XHRcdFx0XHRtYXhGaWxlczogJzE0ZCcsXG5cdFx0XHRcdFx0Zm9ybWF0OiBjb21iaW5lKFxuXHRcdFx0XHRcdFx0dGltZXN0YW1wKHsgZm9ybWF0OiAnWVlZWS1NTS1ERCBISDptbTpzcycgfSksXG5cdFx0XHRcdFx0XHRsb2dGb3JtYXRcblx0XHRcdFx0XHQpXG5cdFx0XHRcdH0pXG5cdFx0XHRdLFxuXHRcdH0pO1xuXG5cdFx0Y29uc29sZS5sb2cgPSAoLi4uYXJncykgPT4gbG9nZ2VySW5zdGFuY2U/LmluZm8oYXJncy5qb2luKCcgJykpO1xuXHRcdGNvbnNvbGUuaW5mbyA9ICguLi5hcmdzKSA9PiBsb2dnZXJJbnN0YW5jZT8uaW5mbyhhcmdzLmpvaW4oJyAnKSk7XG5cdFx0Y29uc29sZS53YXJuID0gKC4uLmFyZ3MpID0+IGxvZ2dlckluc3RhbmNlPy53YXJuKGFyZ3Muam9pbignICcpKTtcblx0XHRjb25zb2xlLmVycm9yID0gKC4uLmFyZ3MpID0+IGxvZ2dlckluc3RhbmNlPy5lcnJvcihhcmdzLmpvaW4oJyAnKSk7XG5cdFx0Y29uc29sZS5kZWJ1ZyA9ICguLi5hcmdzKSA9PiBsb2dnZXJJbnN0YW5jZT8uZGVidWcoYXJncy5qb2luKCcgJykpO1xuXG5cdFx0cmV0dXJuIGxvZ2dlckluc3RhbmNlO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBpbml0aWFsaXplIGxvZ2dlcjogJHtlcnJvcn1gKTtcblx0XHRyZXR1cm4gT2JqZWN0LmFzc2lnbihjcmVhdGVMb2dnZXIoe1xuXHRcdFx0bGV2ZWw6ICdlcnJvcicsXG5cdFx0XHRmb3JtYXQ6IGNvbWJpbmUodGltZXN0YW1wKCksIGxvZ0Zvcm1hdCksXG5cdFx0XHR0cmFuc3BvcnRzOiBbXG5cdFx0XHRcdG5ldyB0cmFuc3BvcnRzLkNvbnNvbGUoe1xuXHRcdFx0XHRcdGZvcm1hdDogY29tYmluZShjb2xvcml6ZSgpLCBsb2dGb3JtYXQpXG5cdFx0XHRcdH0pXG5cdFx0XHRdXG5cdFx0fSksIHtcblx0XHRcdHN0cmVhbToge1xuXHRcdFx0XHR3cml0ZTogKG1lc3NhZ2U6IHN0cmluZykgPT4ge1xuXHRcdFx0XHRcdGNvbnNvbGUuZXJyb3IobWVzc2FnZS50cmltKCkpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzTG9nZ2VyKGxvZ2dlcjogTG9nZ2VyIHwgQ29uc29sZSB8IHVuZGVmaW5lZCk6IGxvZ2dlciBpcyBMb2dnZXIge1xuXHRyZXR1cm4gKFxuXHRcdGxvZ2dlciAhPT0gdW5kZWZpbmVkICYmXG5cdFx0bG9nZ2VyICE9PSBudWxsICYmXG5cdFx0dHlwZW9mIGxvZ2dlci5lcnJvciA9PT0gJ2Z1bmN0aW9uJyAmJlxuXHRcdHR5cGVvZiBsb2dnZXIud2FybiA9PT0gJ2Z1bmN0aW9uJyAmJlxuXHRcdHR5cGVvZiBsb2dnZXIuZGVidWcgPT09ICdmdW5jdGlvbicgJiZcblx0XHR0eXBlb2YgbG9nZ2VyLmluZm8gPT09ICdmdW5jdGlvbidcblx0KTtcbn1cblxuZXhwb3J0IHR5cGUgTG9nZ2VyID0gV2luc3RvbkxvZ2dlcjtcbiJdfQ==
