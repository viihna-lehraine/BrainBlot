import fs from 'fs';
import { createLogger, format, transports } from 'winston';
import DailyRotateFile from 'winston-daily-rotate-file';
import { environmentVariables } from './environmentConfig.mjs';
import { validateDependencies } from '../utils/validateDependencies.mjs';
const { colorize, combine, errors, json, printf, timestamp } = format;
const logFormat = printf(({ level, message, timestamp, stack }) => {
	return `${timestamp} ${level}: ${stack || message}`;
});
let loggerInstance = null;
export function setupLogger({
	logLevel = environmentVariables.logLevel || 'info',
	logDirectory = environmentVariables.serverLogPath,
	serviceName = environmentVariables.serviceName,
	isProduction = environmentVariables.nodeEnv === 'production'
} = {}) {
	try {
		validateDependencies(
			[
				{ name: 'logLevel', instance: logLevel },
				{ name: 'logDirectory', instance: logDirectory },
				{ name: 'serviceName', instance: serviceName },
				{ name: 'isProduction', instance: isProduction }
			],
			console
		);
		if (loggerInstance) {
			console.log(
				'Logger instance already exists. Returning the existing instance.'
			);
			return loggerInstance;
		}
		if (!fs.existsSync(logDirectory)) {
			console.error(
				'Log directory does not exist. Attempting to create it...'
			);
			try {
				fs.mkdirSync(logDirectory, { recursive: true });
				console.log(
					`Log directory ${logDirectory} created successfully.`
				);
			} catch (error) {
				if (error instanceof Error) {
					console.error(
						`Failed to create log directory: ${error.message}`
					);
					throw new Error(
						`Failed to create log directory: ${error.message}`
					);
				} else {
					console.error(
						`Failed to create log directory: ${String(error)}`
					);
					throw new Error(
						`Failed to create log directory: ${String(error)}`
					);
				}
			}
		}
		loggerInstance = createLogger({
			level: isProduction ? 'info' : logLevel,
			format: combine(
				errors({ stack: true }),
				timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
				json()
			),
			defaultMeta: { service: serviceName },
			transports: [
				new transports.Console({
					format: combine(colorize(), logFormat)
				}),
				new DailyRotateFile({
					filename: 'server-%DATE%.log',
					dirname: logDirectory,
					datePattern: 'YYYY-MM-DD',
					zippedArchive: true,
					maxSize: '20m',
					maxFiles: '14d',
					format: combine(
						timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
						logFormat
					)
				})
			]
		});
		console.log = (...args) => {
			loggerInstance?.info(args.join(' '));
		};
		console.info = (...args) => {
			loggerInstance?.info(args.join(' '));
		};
		console.warn = (...args) => {
			loggerInstance?.warn(args.join(' '));
		};
		console.error = (...args) => {
			loggerInstance?.error(args.join(' '));
		};
		console.debug = (...args) => {
			loggerInstance?.debug(args.join(' '));
		};
		return Object.assign(loggerInstance, {
			stream: {
				write: message => {
					loggerInstance?.info(message.trim());
				}
			}
		});
	} catch (error) {
		console.error(`Failed to initialize logger: ${error}`);
		return Object.assign(
			createLogger({
				level: 'error',
				format: combine(timestamp(), logFormat),
				transports: [
					new transports.Console({
						format: combine(colorize(), logFormat)
					})
				]
			}),
			{
				stream: {
					write: message => {
						console.error(message.trim());
					}
				}
			}
		);
	}
}
export function isLogger(logger) {
	return (
		logger !== undefined &&
		logger !== null &&
		typeof logger.error === 'function' &&
		typeof logger.warn === 'function' &&
		typeof logger.debug === 'function' &&
		typeof logger.info === 'function'
	);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NvbmZpZy9sb2dnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3BCLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUEyQixVQUFVLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDcEYsT0FBTyxlQUFlLE1BQU0sMkJBQTJCLENBQUM7QUFDeEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDM0QsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFFckUsTUFBTSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLEdBQUcsTUFBTSxDQUFDO0FBRXRFLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRTtJQUNqRSxPQUFPLEdBQUcsU0FBUyxJQUFJLEtBQUssS0FBSyxLQUFLLElBQUksT0FBTyxFQUFFLENBQUM7QUFDckQsQ0FBQyxDQUFDLENBQUM7QUFVSCxJQUFJLGNBQWMsR0FBeUIsSUFBSSxDQUFDO0FBRWhELE1BQU0sVUFBVSxXQUFXLENBQUMsRUFDM0IsUUFBUSxHQUFHLG9CQUFvQixDQUFDLFFBQVEsSUFBSSxNQUFNLEVBQ2xELFlBQVksR0FBRyxvQkFBb0IsQ0FBQyxhQUFhLEVBQ2pELFdBQVcsR0FBRyxvQkFBb0IsQ0FBQyxXQUFXLEVBQzlDLFlBQVksR0FBRyxvQkFBb0IsQ0FBQyxPQUFPLEtBQUssWUFBWSxNQUNyQyxFQUFFO0lBQ3pCLElBQUksQ0FBQztRQUNKLG9CQUFvQixDQUNuQjtZQUNDLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFO1lBQ3hDLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFO1lBQ2hELEVBQUUsSUFBSSxFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFO1lBQzlDLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFO1NBQ2hELEVBQ0QsT0FBTyxDQUNQLENBQUM7UUFFRixJQUFJLGNBQWMsRUFBRSxDQUFDO1lBQ3BCLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0VBQWtFLENBQUMsQ0FBQztZQUNoRixPQUFPLGNBQWMsQ0FBQztRQUN2QixDQUFDO1FBRUQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQztZQUNsQyxPQUFPLENBQUMsS0FBSyxDQUFDLDBEQUEwRCxDQUFDLENBQUM7WUFDMUUsSUFBSSxDQUFDO2dCQUNKLEVBQUUsQ0FBQyxTQUFTLENBQUMsWUFBWSxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7Z0JBQ2hELE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLFlBQVksd0JBQXdCLENBQUMsQ0FBQztZQUNwRSxDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDaEIsSUFBSSxLQUFLLFlBQVksS0FBSyxFQUFFLENBQUM7b0JBQzVCLE9BQU8sQ0FBQyxLQUFLLENBQUMsbUNBQW1DLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO29CQUNsRSxNQUFNLElBQUksS0FBSyxDQUFDLG1DQUFtQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztnQkFDckUsQ0FBQztxQkFBTSxDQUFDO29CQUNQLE9BQU8sQ0FBQyxLQUFLLENBQUMsbUNBQW1DLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7b0JBQ2xFLE1BQU0sSUFBSSxLQUFLLENBQUMsbUNBQW1DLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ3JFLENBQUM7WUFDRixDQUFDO1FBQ0YsQ0FBQztRQUVELGNBQWMsR0FBRyxZQUFZLENBQUM7WUFDN0IsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxRQUFRO1lBQ3ZDLE1BQU0sRUFBRSxPQUFPLENBQ2QsTUFBTSxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQ3ZCLFNBQVMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxxQkFBcUIsRUFBRSxDQUFDLEVBQzVDLElBQUksRUFBRSxDQUNOO1lBQ0QsV0FBVyxFQUFFLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRTtZQUNyQyxVQUFVLEVBQUU7Z0JBQ1gsSUFBSSxVQUFVLENBQUMsT0FBTyxDQUFDO29CQUN0QixNQUFNLEVBQUUsT0FBTyxDQUFDLFFBQVEsRUFBRSxFQUFFLFNBQVMsQ0FBQztpQkFDdEMsQ0FBQztnQkFDRixJQUFJLGVBQWUsQ0FBQztvQkFDbkIsUUFBUSxFQUFFLG1CQUFtQjtvQkFDN0IsT0FBTyxFQUFFLFlBQVk7b0JBQ3JCLFdBQVcsRUFBRSxZQUFZO29CQUN6QixhQUFhLEVBQUUsSUFBSTtvQkFDbkIsT0FBTyxFQUFFLEtBQUs7b0JBQ2QsUUFBUSxFQUFFLEtBQUs7b0JBQ2YsTUFBTSxFQUFFLE9BQU8sQ0FDZCxTQUFTLENBQUMsRUFBRSxNQUFNLEVBQUUscUJBQXFCLEVBQUUsQ0FBQyxFQUM1QyxTQUFTLENBQ1Q7aUJBQ0QsQ0FBQzthQUNGO1NBQ0QsQ0FBQyxDQUFDO1FBRUgsT0FBTyxDQUFDLEdBQUcsR0FBRyxDQUFDLEdBQUcsSUFBSSxFQUFFLEVBQUU7WUFDekIsY0FBYyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDdEMsQ0FBQyxDQUFDO1FBQ0YsT0FBTyxDQUFDLElBQUksR0FBRyxDQUFDLEdBQUcsSUFBSSxFQUFFLEVBQUU7WUFDMUIsY0FBYyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDdEMsQ0FBQyxDQUFBO1FBQ0QsT0FBTyxDQUFDLElBQUksR0FBRyxDQUFDLEdBQUcsSUFBSSxFQUFFLEVBQUU7WUFDMUIsY0FBYyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDdEMsQ0FBQyxDQUFBO1FBQ0QsT0FBTyxDQUFDLEtBQUssR0FBRyxDQUFDLEdBQUcsSUFBSSxFQUFFLEVBQUU7WUFDM0IsY0FBYyxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFBO1FBQ0QsT0FBTyxDQUFDLEtBQUssR0FBRyxDQUFDLEdBQUcsSUFBSSxFQUFFLEVBQUU7WUFDM0IsY0FBYyxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFBO1FBRUQsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLGNBQWMsRUFBRTtZQUNwQyxNQUFNLEVBQUU7Z0JBQ1AsS0FBSyxFQUFFLENBQUMsT0FBZSxFQUFFLEVBQUU7b0JBQzFCLGNBQWMsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7Z0JBQ3RDLENBQUM7YUFDRDtTQUNELENBQUMsQ0FBQztJQUNKLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2hCLE9BQU8sQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDdkQsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQztZQUNqQyxLQUFLLEVBQUUsT0FBTztZQUNkLE1BQU0sRUFBRSxPQUFPLENBQUMsU0FBUyxFQUFFLEVBQUUsU0FBUyxDQUFDO1lBQ3ZDLFVBQVUsRUFBRTtnQkFDWCxJQUFJLFVBQVUsQ0FBQyxPQUFPLENBQUM7b0JBQ3RCLE1BQU0sRUFBRSxPQUFPLENBQUMsUUFBUSxFQUFFLEVBQUUsU0FBUyxDQUFDO2lCQUN0QyxDQUFDO2FBQ0Y7U0FDRCxDQUFDLEVBQUU7WUFDSCxNQUFNLEVBQUU7Z0JBQ1AsS0FBSyxFQUFFLENBQUMsT0FBZSxFQUFFLEVBQUU7b0JBQzFCLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7Z0JBQy9CLENBQUM7YUFDRDtTQUNELENBQUMsQ0FBQztJQUNKLENBQUM7QUFDRixDQUFDO0FBRUQsTUFBTSxVQUFVLFFBQVEsQ0FBQyxNQUFvQztJQUM1RCxPQUFPLENBQ04sTUFBTSxLQUFLLFNBQVM7UUFDcEIsTUFBTSxLQUFLLElBQUk7UUFDZixPQUFPLE1BQU0sQ0FBQyxLQUFLLEtBQUssVUFBVTtRQUNsQyxPQUFPLE1BQU0sQ0FBQyxJQUFJLEtBQUssVUFBVTtRQUNqQyxPQUFPLE1BQU0sQ0FBQyxLQUFLLEtBQUssVUFBVTtRQUNsQyxPQUFPLE1BQU0sQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUNqQyxDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgeyBjcmVhdGVMb2dnZXIsIGZvcm1hdCwgTG9nZ2VyIGFzIFdpbnN0b25Mb2dnZXIsIHRyYW5zcG9ydHMgfSBmcm9tICd3aW5zdG9uJztcbmltcG9ydCBEYWlseVJvdGF0ZUZpbGUgZnJvbSAnd2luc3Rvbi1kYWlseS1yb3RhdGUtZmlsZSc7XG5pbXBvcnQgeyBlbnZpcm9ubWVudFZhcmlhYmxlcyB9IGZyb20gJy4vZW52aXJvbm1lbnRDb25maWcnO1xuaW1wb3J0IHsgdmFsaWRhdGVEZXBlbmRlbmNpZXMgfSBmcm9tICcuLi91dGlscy92YWxpZGF0ZURlcGVuZGVuY2llcyc7XG5cbmNvbnN0IHsgY29sb3JpemUsIGNvbWJpbmUsIGVycm9ycywganNvbiwgcHJpbnRmLCB0aW1lc3RhbXAgfSA9IGZvcm1hdDtcblxuY29uc3QgbG9nRm9ybWF0ID0gcHJpbnRmKCh7IGxldmVsLCBtZXNzYWdlLCB0aW1lc3RhbXAsIHN0YWNrIH0pID0+IHtcblx0cmV0dXJuIGAke3RpbWVzdGFtcH0gJHtsZXZlbH06ICR7c3RhY2sgfHwgbWVzc2FnZX1gO1xufSk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTG9nZ2VyRGVwZW5kZW5jaWVzIHtcblx0bG9nTGV2ZWw/OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cdGxvZ0RpcmVjdG9yeT86IHN0cmluZyB8IHVuZGVmaW5lZDtcblx0c2VydmljZU5hbWU/OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cdGlzUHJvZHVjdGlvbj86IGJvb2xlYW4gfCB1bmRlZmluZWQ7XG5cdGNvbnNvbGU/OiB0eXBlb2YgY29uc29sZTtcbn1cblxubGV0IGxvZ2dlckluc3RhbmNlOiBXaW5zdG9uTG9nZ2VyIHwgbnVsbCA9IG51bGw7XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXR1cExvZ2dlcih7XG5cdGxvZ0xldmVsID0gZW52aXJvbm1lbnRWYXJpYWJsZXMubG9nTGV2ZWwgfHwgJ2luZm8nLFxuXHRsb2dEaXJlY3RvcnkgPSBlbnZpcm9ubWVudFZhcmlhYmxlcy5zZXJ2ZXJMb2dQYXRoLFxuXHRzZXJ2aWNlTmFtZSA9IGVudmlyb25tZW50VmFyaWFibGVzLnNlcnZpY2VOYW1lLFxuXHRpc1Byb2R1Y3Rpb24gPSBlbnZpcm9ubWVudFZhcmlhYmxlcy5ub2RlRW52ID09PSAncHJvZHVjdGlvbicsXG59OiBMb2dnZXJEZXBlbmRlbmNpZXMgPSB7fSk6IFdpbnN0b25Mb2dnZXIge1xuXHR0cnkge1xuXHRcdHZhbGlkYXRlRGVwZW5kZW5jaWVzKFxuXHRcdFx0W1xuXHRcdFx0XHR7IG5hbWU6ICdsb2dMZXZlbCcsIGluc3RhbmNlOiBsb2dMZXZlbCB9LFxuXHRcdFx0XHR7IG5hbWU6ICdsb2dEaXJlY3RvcnknLCBpbnN0YW5jZTogbG9nRGlyZWN0b3J5IH0sXG5cdFx0XHRcdHsgbmFtZTogJ3NlcnZpY2VOYW1lJywgaW5zdGFuY2U6IHNlcnZpY2VOYW1lIH0sXG5cdFx0XHRcdHsgbmFtZTogJ2lzUHJvZHVjdGlvbicsIGluc3RhbmNlOiBpc1Byb2R1Y3Rpb24gfVxuXHRcdFx0XSxcblx0XHRcdGNvbnNvbGVcblx0XHQpO1xuXG5cdFx0aWYgKGxvZ2dlckluc3RhbmNlKSB7XG5cdFx0XHRjb25zb2xlLmxvZygnTG9nZ2VyIGluc3RhbmNlIGFscmVhZHkgZXhpc3RzLiBSZXR1cm5pbmcgdGhlIGV4aXN0aW5nIGluc3RhbmNlLicpO1xuXHRcdFx0cmV0dXJuIGxvZ2dlckluc3RhbmNlO1xuXHRcdH1cblxuXHRcdGlmICghZnMuZXhpc3RzU3luYyhsb2dEaXJlY3RvcnkpKSB7XG5cdFx0XHRjb25zb2xlLmVycm9yKCdMb2cgZGlyZWN0b3J5IGRvZXMgbm90IGV4aXN0LiBBdHRlbXB0aW5nIHRvIGNyZWF0ZSBpdC4uLicpO1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0ZnMubWtkaXJTeW5jKGxvZ0RpcmVjdG9yeSwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG5cdFx0XHRcdGNvbnNvbGUubG9nKGBMb2cgZGlyZWN0b3J5ICR7bG9nRGlyZWN0b3J5fSBjcmVhdGVkIHN1Y2Nlc3NmdWxseS5gKTtcblx0XHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHRcdGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XG5cdFx0XHRcdFx0Y29uc29sZS5lcnJvcihgRmFpbGVkIHRvIGNyZWF0ZSBsb2cgZGlyZWN0b3J5OiAke2Vycm9yLm1lc3NhZ2V9YCk7XG5cdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gY3JlYXRlIGxvZyBkaXJlY3Rvcnk6ICR7ZXJyb3IubWVzc2FnZX1gKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gY3JlYXRlIGxvZyBkaXJlY3Rvcnk6ICR7U3RyaW5nKGVycm9yKX1gKTtcblx0XHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBjcmVhdGUgbG9nIGRpcmVjdG9yeTogJHtTdHJpbmcoZXJyb3IpfWApO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0bG9nZ2VySW5zdGFuY2UgPSBjcmVhdGVMb2dnZXIoe1xuXHRcdFx0bGV2ZWw6IGlzUHJvZHVjdGlvbiA/ICdpbmZvJyA6IGxvZ0xldmVsLFxuXHRcdFx0Zm9ybWF0OiBjb21iaW5lKFxuXHRcdFx0XHRlcnJvcnMoeyBzdGFjazogdHJ1ZSB9KSxcblx0XHRcdFx0dGltZXN0YW1wKHsgZm9ybWF0OiAnWVlZWS1NTS1ERCBISDptbTpzcycgfSksXG5cdFx0XHRcdGpzb24oKVxuXHRcdFx0KSxcblx0XHRcdGRlZmF1bHRNZXRhOiB7IHNlcnZpY2U6IHNlcnZpY2VOYW1lIH0sXG5cdFx0XHR0cmFuc3BvcnRzOiBbXG5cdFx0XHRcdG5ldyB0cmFuc3BvcnRzLkNvbnNvbGUoe1xuXHRcdFx0XHRcdGZvcm1hdDogY29tYmluZShjb2xvcml6ZSgpLCBsb2dGb3JtYXQpXG5cdFx0XHRcdH0pLFxuXHRcdFx0XHRuZXcgRGFpbHlSb3RhdGVGaWxlKHtcblx0XHRcdFx0XHRmaWxlbmFtZTogJ3NlcnZlci0lREFURSUubG9nJyxcblx0XHRcdFx0XHRkaXJuYW1lOiBsb2dEaXJlY3RvcnksXG5cdFx0XHRcdFx0ZGF0ZVBhdHRlcm46ICdZWVlZLU1NLUREJyxcblx0XHRcdFx0XHR6aXBwZWRBcmNoaXZlOiB0cnVlLFxuXHRcdFx0XHRcdG1heFNpemU6ICcyMG0nLFxuXHRcdFx0XHRcdG1heEZpbGVzOiAnMTRkJyxcblx0XHRcdFx0XHRmb3JtYXQ6IGNvbWJpbmUoXG5cdFx0XHRcdFx0XHR0aW1lc3RhbXAoeyBmb3JtYXQ6ICdZWVlZLU1NLUREIEhIOm1tOnNzJyB9KSxcblx0XHRcdFx0XHRcdGxvZ0Zvcm1hdFxuXHRcdFx0XHRcdClcblx0XHRcdFx0fSlcblx0XHRcdF1cblx0XHR9KTtcblxuXHRcdGNvbnNvbGUubG9nID0gKC4uLmFyZ3MpID0+IHtcblx0XHRcdGxvZ2dlckluc3RhbmNlPy5pbmZvKGFyZ3Muam9pbignICcpKTtcblx0XHR9O1xuXHRcdGNvbnNvbGUuaW5mbyA9ICguLi5hcmdzKSA9PiB7XG5cdFx0XHRsb2dnZXJJbnN0YW5jZT8uaW5mbyhhcmdzLmpvaW4oJyAnKSk7XG5cdFx0fVxuXHRcdGNvbnNvbGUud2FybiA9ICguLi5hcmdzKSA9PiB7XG5cdFx0XHRsb2dnZXJJbnN0YW5jZT8ud2FybihhcmdzLmpvaW4oJyAnKSk7XG5cdFx0fVxuXHRcdGNvbnNvbGUuZXJyb3IgPSAoLi4uYXJncykgPT4ge1xuXHRcdFx0bG9nZ2VySW5zdGFuY2U/LmVycm9yKGFyZ3Muam9pbignICcpKTtcblx0XHR9XG5cdFx0Y29uc29sZS5kZWJ1ZyA9ICguLi5hcmdzKSA9PiB7XG5cdFx0XHRsb2dnZXJJbnN0YW5jZT8uZGVidWcoYXJncy5qb2luKCcgJykpO1xuXHRcdH1cblxuXHRcdHJldHVybiBPYmplY3QuYXNzaWduKGxvZ2dlckluc3RhbmNlLCB7XG5cdFx0XHRzdHJlYW06IHtcblx0XHRcdFx0d3JpdGU6IChtZXNzYWdlOiBzdHJpbmcpID0+IHtcblx0XHRcdFx0XHRsb2dnZXJJbnN0YW5jZT8uaW5mbyhtZXNzYWdlLnRyaW0oKSk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9KTtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gaW5pdGlhbGl6ZSBsb2dnZXI6ICR7ZXJyb3J9YCk7XG5cdFx0cmV0dXJuIE9iamVjdC5hc3NpZ24oY3JlYXRlTG9nZ2VyKHtcblx0XHRcdGxldmVsOiAnZXJyb3InLFxuXHRcdFx0Zm9ybWF0OiBjb21iaW5lKHRpbWVzdGFtcCgpLCBsb2dGb3JtYXQpLFxuXHRcdFx0dHJhbnNwb3J0czogW1xuXHRcdFx0XHRuZXcgdHJhbnNwb3J0cy5Db25zb2xlKHtcblx0XHRcdFx0XHRmb3JtYXQ6IGNvbWJpbmUoY29sb3JpemUoKSwgbG9nRm9ybWF0KVxuXHRcdFx0XHR9KVxuXHRcdFx0XVxuXHRcdH0pLCB7XG5cdFx0XHRzdHJlYW06IHtcblx0XHRcdFx0d3JpdGU6IChtZXNzYWdlOiBzdHJpbmcpID0+IHtcblx0XHRcdFx0XHRjb25zb2xlLmVycm9yKG1lc3NhZ2UudHJpbSgpKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0xvZ2dlcihsb2dnZXI6IExvZ2dlciB8IENvbnNvbGUgfCB1bmRlZmluZWQpOiBsb2dnZXIgaXMgTG9nZ2VyIHtcblx0cmV0dXJuIChcblx0XHRsb2dnZXIgIT09IHVuZGVmaW5lZCAmJlxuXHRcdGxvZ2dlciAhPT0gbnVsbCAmJlxuXHRcdHR5cGVvZiBsb2dnZXIuZXJyb3IgPT09ICdmdW5jdGlvbicgJiZcblx0XHR0eXBlb2YgbG9nZ2VyLndhcm4gPT09ICdmdW5jdGlvbicgJiZcblx0XHR0eXBlb2YgbG9nZ2VyLmRlYnVnID09PSAnZnVuY3Rpb24nICYmXG5cdFx0dHlwZW9mIGxvZ2dlci5pbmZvID09PSAnZnVuY3Rpb24nXG5cdCk7XG59XG5cbmV4cG9ydCB0eXBlIExvZ2dlciA9IFdpbnN0b25Mb2dnZXI7XG4iXX0=
