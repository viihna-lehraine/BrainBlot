import { Strategy as LocalStrategy } from 'passport-local';
import { ExtractJwt, Strategy as JwtStrategy } from 'passport-jwt';
import { processError } from '../utils/processError.mjs';
import { validateDependencies } from '../utils/validateDependencies.mjs';
export default async function configurePassport({
	passport,
	logger,
	getSecrets,
	UserModel,
	argon2
}) {
	try {
		validateDependencies(
			[
				{ name: 'passport', instance: passport },
				{ name: 'logger', instance: logger },
				{ name: 'getSecrets', instance: getSecrets },
				{ name: 'UserModel', instance: UserModel },
				{ name: 'argon2', instance: argon2 }
			],
			logger || console
		);
		const secrets = await getSecrets();
		const opts = {
			jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
			secretOrKey: secrets.JWT_SECRET
		};
		// implement JWT strategy
		passport.use(
			new JwtStrategy(opts, async (jwtPayload, done) => {
				try {
					validateDependencies(
						[
							{ name: 'jwtPayload', instance: jwtPayload },
							{ name: 'jwtPayload', instance: jwtPayload },
							{ name: 'done', instance: done }
						],
						logger || console
					);
					const user = await UserModel.findByPk(jwtPayload.id);
					if (user) {
						logger.info(
							`JWT authentication successful for user: ${user.username}`
						);
						return done(null, user);
					} else {
						logger.warn(
							'JWT authentication failed: User not found'
						);
						return done(null, false, { message: 'User not found' });
					}
				} catch (err) {
					processError(err, logger || console);
					return done(
						new Error(
							err instanceof Error ? err.message : String(err)
						),
						false
					);
				}
			})
		);
		// implement local strategy for username and password login
		passport.use(
			new LocalStrategy(async (username, password, done) => {
				try {
					validateDependencies(
						[
							{ name: 'username', instance: username },
							{ name: 'password', instance: password },
							{ name: 'done', instance: done }
						],
						logger || console
					);
					const user = await UserModel.findOne({
						where: { username }
					});
					if (!user) {
						logger.warn(
							`Local authentication failed: User not found: ${username}`
						);
						return done(null, false, { message: 'User not found' });
					}
					const isMatch = await user.comparePassword(
						password,
						argon2,
						secrets,
						logger
					);
					if (isMatch) {
						logger.info(
							`Local authentication successful for user: ${username}`
						);
						return done(null, user);
					} else {
						logger.warn(
							`Local authentication failed: Incorrect password for user: ${username}`
						);
						return done(null, false, {
							message: 'Incorrect password'
						});
					}
				} catch (err) {
					processError(err, logger || console);
					return done(
						new Error(
							err instanceof Error ? err.message : String(err)
						)
					);
				}
			})
		);
		logger.info('Passport configured successfully');
	} catch (error) {
		processError(error, logger || console);
		throw new Error(error instanceof Error ? error.message : String(error));
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFzc3BvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29uZmlnL3Bhc3Nwb3J0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxRQUFRLElBQUksYUFBYSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0QsT0FBTyxFQUNOLFVBQVUsRUFDVixRQUFRLElBQUksV0FBVyxFQUd2QixNQUFNLGNBQWMsQ0FBQztBQUV0QixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFckQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUF5QnJFLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxVQUFVLGlCQUFpQixDQUFDLEVBQy9DLFFBQVEsRUFDUixNQUFNLEVBQ04sVUFBVSxFQUNWLFNBQVMsRUFDVCxNQUFNLEVBQ2dCO0lBQ3RCLElBQUksQ0FBQztRQUNKLG9CQUFvQixDQUNuQjtZQUNDLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFO1lBQ3hDLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFO1lBQ3BDLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFO1lBQzVDLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFO1lBQzFDLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFO1NBQ3BDLEVBQ0QsTUFBTSxJQUFJLE9BQU8sQ0FDakIsQ0FBQztRQUVGLE1BQU0sT0FBTyxHQUFHLE1BQU0sVUFBVSxFQUFFLENBQUM7UUFFbkMsTUFBTSxJQUFJLEdBQW9CO1lBQzdCLGNBQWMsRUFBRSxVQUFVLENBQUMsMkJBQTJCLEVBQUU7WUFDeEQsV0FBVyxFQUFFLE9BQU8sQ0FBQyxVQUFVO1NBQy9CLENBQUM7UUFFRix5QkFB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SSxDQUFDLDZEQUE2RCxRQUFRLEVBQUUsQ0FBQyxDQUFDO29CQUNyRixPQUFPLElBQUksQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLENBQUMsQ0FBQztnQkFDN0QsQ0FBQztZQUNGLENBQUM7WUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO2dCQUNkLFlBQVksQ0FBQyxHQUFHLEVBQUUsTUFBTSxJQUFJLE9BQU8sQ0FBQyxDQUFDO2dCQUNyQyxPQUFPLElBQUksQ0FBQyxJQUFJLEtBQUssQ0FBQyxHQUFHLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFFLENBQUM7UUFDRixDQUFDLENBQUMsQ0FDRixDQUFDO1FBRUYsTUFBTSxDQUFDLElBQUksQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2hCLFlBQVksQ0FBQyxLQUFLLEVBQUUsTUFBTSxJQUFJLE9BQU8sQ0FBQyxDQUFDO1FBQ3ZDLE1BQU0sSUFBSSxLQUFLLENBQUMsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDekUsQ0FBQztBQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQYXNzcG9ydFN0YXRpYyB9IGZyb20gJ3Bhc3Nwb3J0JztcbmltcG9ydCB7IFN0cmF0ZWd5IGFzIExvY2FsU3RyYXRlZ3kgfSBmcm9tICdwYXNzcG9ydC1sb2NhbCc7XG5pbXBvcnQge1xuXHRFeHRyYWN0Snd0LFxuXHRTdHJhdGVneSBhcyBKd3RTdHJhdGVneSxcblx0U3RyYXRlZ3lPcHRpb25zLFxuXHRWZXJpZmllZENhbGxiYWNrXG59IGZyb20gJ3Bhc3Nwb3J0LWp3dCc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBwcm9jZXNzRXJyb3IgfSBmcm9tICcuLi91dGlscy9wcm9jZXNzRXJyb3InO1xuaW1wb3J0IGNyZWF0ZVVzZXJNb2RlbCBmcm9tICcuLi9tb2RlbHMvVXNlcic7XG5pbXBvcnQgeyB2YWxpZGF0ZURlcGVuZGVuY2llcyB9IGZyb20gJy4uL3V0aWxzL3ZhbGlkYXRlRGVwZW5kZW5jaWVzJztcblxuZXhwb3J0IGludGVyZmFjZSBVc2VySW5zdGFuY2Uge1xuXHRpZDogc3RyaW5nO1xuXHR1c2VybmFtZTogc3RyaW5nO1xuXHRjb21wYXJlUGFzc3dvcmQ6IChcblx0XHRwYXNzd29yZDogc3RyaW5nLFxuXHRcdGFyZ29uMjogdHlwZW9mIGltcG9ydCgnYXJnb24yJyksXG5cdFx0c2VjcmV0czogUGFzc3BvcnRTZWNyZXRzXG5cdCkgPT4gUHJvbWlzZTxib29sZWFuPjtcbn1cblxuaW50ZXJmYWNlIFBhc3Nwb3J0U2VjcmV0cyB7XG5cdEpXVF9TRUNSRVQ6IHN0cmluZztcblx0UEVQUEVSOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBQYXNzcG9ydERlcGVuZGVuY2llcyB7XG5cdHJlYWRvbmx5IHBhc3Nwb3J0OiBQYXNzcG9ydFN0YXRpYztcblx0cmVhZG9ubHkgbG9nZ2VyOiBMb2dnZXI7XG5cdHJlYWRvbmx5IGdldFNlY3JldHM6ICgpID0+IFByb21pc2U8UGFzc3BvcnRTZWNyZXRzPjtcblx0cmVhZG9ubHkgVXNlck1vZGVsOiBSZXR1cm5UeXBlPHR5cGVvZiBjcmVhdGVVc2VyTW9kZWw+O1xuXHRyZWFkb25seSBhcmdvbjI6IHR5cGVvZiBpbXBvcnQoJ2FyZ29uMicpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBhc3luYyBmdW5jdGlvbiBjb25maWd1cmVQYXNzcG9ydCh7XG5cdHBhc3Nwb3J0LFxuXHRsb2dnZXIsXG5cdGdldFNlY3JldHMsXG5cdFVzZXJNb2RlbCxcblx0YXJnb24yXG59OiBQYXNzcG9ydERlcGVuZGVuY2llcyk6IFByb21pc2U8dm9pZD4ge1xuXHR0cnkge1xuXHRcdHZhbGlkYXRlRGVwZW5kZW5jaWVzKFxuXHRcdFx0W1xuXHRcdFx0XHR7IG5hbWU6ICdwYXNzcG9ydCcsIGluc3RhbmNlOiBwYXNzcG9ydCB9LFxuXHRcdFx0XHR7IG5hbWU6ICdsb2dnZXInLCBpbnN0YW5jZTogbG9nZ2VyIH0sXG5cdFx0XHRcdHsgbmFtZTogJ2dldFNlY3JldHMnLCBpbnN0YW5jZTogZ2V0U2VjcmV0cyB9LFxuXHRcdFx0XHR7IG5hbWU6ICdVc2VyTW9kZWwnLCBpbnN0YW5jZTogVXNlck1vZGVsIH0sXG5cdFx0XHRcdHsgbmFtZTogJ2FyZ29uMicsIGluc3RhbmNlOiBhcmdvbjIgfVxuXHRcdFx0XSxcblx0XHRcdGxvZ2dlciB8fCBjb25zb2xlXG5cdFx0KTtcblxuXHRcdGNvbnN0IHNlY3JldHMgPSBhd2FpdCBnZXRTZWNyZXRzKCk7XG5cblx0XHRjb25zdCBvcHRzOiBTdHJhdGVneU9wdGlvbnMgPSB7XG5cdFx0XHRqd3RGcm9tUmVxdWVzdDogRXh0cmFjdEp3dC5mcm9tQXV0aEhlYWRlckFzQmVhcmVyVG9rZW4oKSxcblx0XHRcdHNlY3JldE9yS2V5OiBzZWNyZXRzLkpXVF9TRUNSRVRcblx0XHR9O1xuXG5cdFx0Ly8gaW1wbGVtZW50IEpXVCBzdHJhdGVneVxuXHRcdHBhc3Nwb3J0LnVzZShcblx0XHRcdG5ldyBKd3RTdHJhdGVneShvcHRzLCBhc3luYyAoand0UGF5bG9hZCwgZG9uZTogVmVyaWZpZWRDYWxsYmFjaykgPT4ge1xuXHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdHZhbGlkYXRlRGVwZW5kZW5jaWVzKFxuXHRcdFx0XHRcdFx0W1xuXHRcdFx0XHRcdFx0XHR7IG5hbWU6ICdqd3RQYXlsb2FkJywgaW5zdGFuY2U6IGp3dFBheWxvYWQgfSxcblx0XHRcdFx0XHRcdFx0eyBuYW1lOiAnand0UGF5bG9hZCcsIGluc3RhbmNlOiBqd3RQYXlsb2FkIH0sXG5cdFx0XHRcdFx0XHRcdHsgbmFtZTogJ2RvbmUnLCBpbnN0YW5jZTogZG9uZSB9XG5cdFx0XHRcdFx0XHRdLFxuXHRcdFx0XHRcdFx0bG9nZ2VyIHx8IGNvbnNvbGVcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyTW9kZWwuZmluZEJ5UGsoand0UGF5bG9hZC5pZCk7XG5cdFx0XHRcdFx0aWYgKHVzZXIpIHtcblx0XHRcdFx0XHRcdGxvZ2dlci5pbmZvKGBKV1QgYXV0aGVudGljYXRpb24gc3VjY2Vzc2Z1bCBmb3IgdXNlcjogJHt1c2VyLnVzZXJuYW1lfWApO1xuXHRcdFx0XHRcdFx0cmV0dXJuIGRvbmUobnVsbCwgdXNlcik7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdGxvZ2dlci53YXJuKCdKV1QgYXV0aGVudGljYXRpb24gZmFpbGVkOiBVc2VyIG5vdCBmb3VuZCcpO1xuXHRcdFx0XHRcdFx0cmV0dXJuIGRvbmUobnVsbCwgZmFsc2UsIHsgbWVzc2FnZTogJ1VzZXIgbm90IGZvdW5kJyB9KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0XHRcdHByb2Nlc3NFcnJvcihlcnIsIGxvZ2dlciB8fCBjb25zb2xlKTtcblx0XHRcdFx0XHRyZXR1cm4gZG9uZShuZXcgRXJyb3IoZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIubWVzc2FnZSA6IFN0cmluZyhlcnIpKSwgZmFsc2UpO1xuXHRcdFx0XHR9XG5cdFx0XHR9KVxuXHRcdCk7XG5cblx0XHQvLyBpbXBsZW1lbnQgbG9jYWwgc3RyYXRlZ3kgZm9yIHVzZXJuYW1lIGFuZCBwYXNzd29yZCBsb2dpblxuXHRcdHBhc3Nwb3J0LnVzZShcblx0XHRcdG5ldyBMb2NhbFN0cmF0ZWd5KGFzeW5jICh1c2VybmFtZSwgcGFzc3dvcmQsIGRvbmUpID0+IHtcblx0XHRcdFx0dHJ5IHtcblx0XHRcdFx0XHR2YWxpZGF0ZURlcGVuZGVuY2llcyhcblx0XHRcdFx0XHRcdFtcblx0XHRcdFx0XHRcdFx0eyBuYW1lOiAndXNlcm5hbWUnLCBpbnN0YW5jZTogdXNlcm5hbWUgfSxcblx0XHRcdFx0XHRcdFx0eyBuYW1lOiAncGFzc3dvcmQnLCBpbnN0YW5jZTogcGFzc3dvcmQgfSxcblx0XHRcdFx0XHRcdFx0eyBuYW1lOiAnZG9uZScsIGluc3RhbmNlOiBkb25lIH1cblx0XHRcdFx0XHRcdF0sXG5cdFx0XHRcdFx0XHRsb2dnZXIgfHwgY29uc29sZVxuXHRcdFx0XHRcdCk7XG5cblx0XHRcdFx0XHRjb25zdCB1c2VyID0gYXdhaXQgVXNlck1vZGVsLmZpbmRPbmUoeyB3aGVyZTogeyB1c2VybmFtZSB9IH0pO1xuXHRcdFx0XHRcdGlmICghdXNlcikge1xuXHRcdFx0XHRcdFx0bG9nZ2VyLndhcm4oYExvY2FsIGF1dGhlbnRpY2F0aW9uIGZhaWxlZDogVXNlciBub3QgZm91bmQ6ICR7dXNlcm5hbWV9YCk7XG5cdFx0XHRcdFx0XHRyZXR1cm4gZG9uZShudWxsLCBmYWxzZSwgeyBtZXNzYWdlOiAnVXNlciBub3QgZm91bmQnIH0pO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGNvbnN0IGlzTWF0Y2ggPSBhd2FpdCB1c2VyLmNvbXBhcmVQYXNzd29yZChwYXNzd29yZCwgYXJnb24yLCBzZWNyZXRzLCBsb2dnZXIpO1xuXG5cdFx0XHRcdFx0aWYgKGlzTWF0Y2gpIHtcblx0XHRcdFx0XHRcdGxvZ2dlci5pbmZvKGBMb2NhbCBhdXRoZW50aWNhdGlvbiBzdWNjZXNzZnVsIGZvciB1c2VyOiAke3VzZXJuYW1lfWApO1xuXHRcdFx0XHRcdFx0cmV0dXJuIGRvbmUobnVsbCwgdXNlcik7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdGxvZ2dlci53YXJuKGBMb2NhbCBhdXRoZW50aWNhdGlvbiBmYWlsZWQ6IEluY29ycmVjdCBwYXNzd29yZCBmb3IgdXNlcjogJHt1c2VybmFtZX1gKTtcblx0XHRcdFx0XHRcdHJldHVybiBkb25lKG51bGwsIGZhbHNlLCB7IG1lc3NhZ2U6ICdJbmNvcnJlY3QgcGFzc3dvcmQnIH0pO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0XHRcdFx0cHJvY2Vzc0Vycm9yKGVyciwgbG9nZ2VyIHx8IGNvbnNvbGUpO1xuXHRcdFx0XHRcdHJldHVybiBkb25lKG5ldyBFcnJvcihlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogU3RyaW5nKGVycikpKTtcblx0XHRcdFx0fVxuXHRcdFx0fSlcblx0XHQpO1xuXG5cdFx0bG9nZ2VyLmluZm8oJ1Bhc3Nwb3J0IGNvbmZpZ3VyZWQgc3VjY2Vzc2Z1bGx5Jyk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0cHJvY2Vzc0Vycm9yKGVycm9yLCBsb2dnZXIgfHwgY29uc29sZSk7XG5cdFx0dGhyb3cgbmV3IEVycm9yKGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSk7XG5cdH1cbn1cbiJdfQ==
