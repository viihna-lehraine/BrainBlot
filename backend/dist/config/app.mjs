async function initializeApp({
	express,
	session,
	cookieParser,
	cors,
	hpp,
	morgan,
	passport,
	randomBytes,
	path,
	RedisStore,
	initializeStaticRoutes,
	csrfMiddleware,
	errorHandler,
	getRedisClient,
	ipBlacklistMiddleware,
	createTestRouter,
	rateLimitMiddleware,
	setupSecurityHeaders,
	startMemoryMonitor,
	logger,
	staticRootPath,
	NODE_ENV,
	SSL_FLAG,
	REDIS_FLAG
}) {
	const app = express();
	const memoryMonitor = NODE_ENV === 'development' || NODE_ENV === 'testing';
	if (memoryMonitor) {
		logger.info('Memory Monitor enabled');
		startMemoryMonitor();
	}
	const middlewares = [
		express.json(),
		express.urlencoded({ extended: true }),
		cookieParser(),
		passport.initialize(),
		express.static(staticRootPath),
		hpp(),
		rateLimitMiddleware,
		ipBlacklistMiddleware,
		csrfMiddleware
	];
	app.use(...middlewares);
	app.use(
		cors({
			methods: 'GET,POST,PUT,DELETE',
			allowedHeaders: 'Content-Type,Authorization',
			credentials: true
		})
	);
	app.use(
		morgan('combined', {
			stream: { write: (message = '') => logger.info(message.trim()) }
		})
	);
	initializeStaticRoutes(app);
	app.use(async (req, res, next) => {
		try {
			res.locals.cspNonce = randomBytes(16).toString('hex');
			next();
		} catch {
			next();
		}
	});
	setupSecurityHeaders(app, {
		helmetOptions: {
			// *DEV-NOTE* FILL THIS OUT
		},
		permissionsPolicyOptions: {
			// *DEV-NOTE* FILL THIS OUT
		}
	});
	createTestRouter(app);
	// session management
	if (REDIS_FLAG && getRedisClient()) {
		logger.info('REDIS_FLAG is true. Using Redis for session management');
		app.use(
			session({
				store: new RedisStore({ client: getRedisClient() }),
				secret: 'secrets.REDIS_KEY',
				resave: false,
				saveUninitialized: false,
				cookie: { secure: true }
			})
		);
	} else {
		logger.info(
			'REDIS_FLAG is false. Using in-memory store for session management'
		);
		app.use(
			session({
				secret: 'secrets.SESSION_KEY',
				resave: false,
				saveUninitialized: false,
				cookie: { secure: SSL_FLAG }
			})
		);
	}
	// 404 error handling
	app.use((req, res, next) => {
		res.status(404).sendFile(path.join(staticRootPath, '404.html'));
		next();
	});
	// general error handling
	app.use(errorHandler);
	return app;
}
export { initializeApp };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NvbmZpZy9hcHAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBMkNBLEtBQUssVUFBVSxhQUFhLENBQUMsRUFDNUIsT0FBTyxFQUNQLE9BQU8sRUFDUCxZQUFZLEVBQ1osSUFBSSxFQUNKLEdBQUcsRUFDSCxNQUFNLEVBQ04sUUFBUSxFQUNSLFdBQVcsRUFDWCxJQUFJLEVBQ0osVUFBVSxFQUNWLHNCQUFzQixFQUN0QixjQUFjLEVBQ2QsWUFBWSxFQUNaLGNBQWMsRUFDZCxxQkFBcUIsRUFDckIsZ0JBQWdCLEVBQ2hCLG1CQUFtQixFQUNuQixvQkFBb0IsRUFDcEIsa0JBQWtCLEVBQ2xCLE1BQU0sRUFDTixjQUFjLEVBQ2QsUUFBUSxFQUNSLFFBQVEsRUFDUixVQUFVLEdBQ087SUFDakIsTUFBTSxHQUFHLEdBQUcsT0FBTyxFQUFFLENBQUM7SUFFdEIsSUFBSSxhQUFhLEdBQUcsUUFBUSxLQUFLLGFBQWEsSUFBSSxRQUFRLEtBQUssU0FBUyxDQUFDO0lBQ3pFLElBQUksYUFBYSxFQUFFLENBQUM7UUFDbkIsTUFBTSxDQUFDLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBQ3RDLGtCQUFrQixFQUFFLENBQUM7SUFDdEIsQ0FBQztJQUVELE1BQU0sV0FBVyxHQUFHO1FBQ25CLE9BQU8sQ0FBQyxJQUFJLEVBQUU7UUFDZCxPQUFPLENBQUMsVUFBVSxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDO1FBQ3RDLFlBQVksRUFBRTtRQUNkLFFBQVEsQ0FBQyxVQUFVLEVBQUU7UUFDckIsT0FBTyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUM7UUFDOUIsR0FBRyxFQUFFO1FBQ0wsbUJBQW1CO1FBQ25CLHFCQUFxQjtRQUNyQixjQUFjO0tBQ2QsQ0FBQztJQUVGLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxXQUFXLENBQUMsQ0FBQztJQUV4QixHQUFHLENBQUMsR0FBRyxDQUNOLElBQUksQ0FBQztRQUNKLE9BQU8sRUFBRSxxQkFBcUI7UUFDOUIsY0FBYyxFQUFFLDRCQUE0QjtRQUM1QyxXQUFXLEVBQUUsSUFBSTtLQUNqQixDQUFDLENBQ0YsQ0FBQztJQUVGLEdBQUcsQ0FBQyxHQUFHLENBQ04sTUFBTSxDQUFDLFVBQVUsRUFBRTtRQUNsQixNQUFNLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxPQUFPLEdBQUcsRUFBRSxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFO0tBQ2hFLENBQUMsQ0FDRixDQUFDO0lBRUYsc0JBQXNCLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFNUIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQixFQUFFLEVBQUU7UUFDakUsSUFBSSxDQUFDO1lBQ0osR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEdBQUcsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN0RCxJQUFJLEVBQUUsQ0FBQztRQUNSLENBQUM7UUFBQyxNQUFNLENBQUM7WUFDUixJQUFJLEVBQUUsQ0FBQztRQUNSLENBQUM7SUFDRixDQUFDLENBQUMsQ0FBQztJQUVILG9CQUFvQixDQUFDLEdBQUcsRUFBRTtRQUN6QixhQUFhLEVBQUU7UUFDZiwyQkFBMkI7U0FDMUI7UUFDRCx3QkFBd0IsRUFBRTtRQUMxQiwyQkFBMkI7U0FDMUI7S0FDRCxDQUFDLENBQUM7SUFFSCxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUV0QixxQkFBcUI7SUFDckIsSUFBSSxVQUFVLElBQUksY0FBYyxFQUFFLEVBQUUsQ0FBQztRQUNwQyxNQUFNLENBQUMsSUFBSSxDQUFDLHdEQUF3RCxDQUFDLENBQUM7UUFDdEUsR0FBRyxDQUFDLEdBQUcsQ0FDTixPQUFPLENBQUM7WUFDUCxLQUFLLEVBQUUsSUFBSSxVQUFVLENBQUMsRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUFFLEVBQUUsQ0FBQztZQUNuRCxNQUFNLEVBQUUsbUJBQW1CO1lBQzNCLE1BQU0sRUFBRSxLQUFLO1lBQ2IsaUJBQWlCLEVBQUUsS0FBSztZQUN4QixNQUFNLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO1NBQ3hCLENBQUMsQ0FDRixDQUFDO0lBQ0gsQ0FBQztTQUFNLENBQUM7UUFDUCxNQUFNLENBQUMsSUFBSSxDQUFDLG1FQUFtRSxDQUFDLENBQUM7UUFFakYsR0FBRyxDQUFDLEdBQUcsQ0FDTixPQUFPLENBQUM7WUFDUCxNQUFNLEVBQUUscUJBQXFCO1lBQzdCLE1BQU0sRUFBRSxLQUFLO1lBQ2IsaUJBQWlCLEVBQUUsS0FBSztZQUN4QixNQUFNLEVBQUUsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFO1NBQzVCLENBQUMsQ0FDRixDQUFDO0lBQ0gsQ0FBQztJQUVELHFCQUFxQjtJQUNyQixHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQixFQUFFLEVBQUU7UUFDM0QsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUNoRSxJQUFJLEVBQUUsQ0FBQztJQUNSLENBQUMsQ0FBQyxDQUFDO0lBRUgseUJBQXlCO0lBQ3pCLEdBQUcsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7SUFFdEIsT0FBTyxHQUFHLENBQUM7QUFDWixDQUFDO0FBRUQsT0FBTyxFQUFFLGFBQWEsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV4cHJlc3MsIHsgQXBwbGljYXRpb24sIFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBzZXNzaW9uIGZyb20gJ2V4cHJlc3Mtc2Vzc2lvbic7XG5pbXBvcnQgY29va2llUGFyc2VyIGZyb20gJ2Nvb2tpZS1wYXJzZXInO1xuaW1wb3J0IGNvcnMgZnJvbSAnY29ycyc7XG5pbXBvcnQgaHBwIGZyb20gJ2hwcCc7XG5pbXBvcnQgbW9yZ2FuIGZyb20gJ21vcmdhbic7XG5pbXBvcnQgcGFzc3BvcnQgZnJvbSAncGFzc3BvcnQnO1xuaW1wb3J0IGhlbG1ldCwgeyBIZWxtZXRPcHRpb25zIH0gZnJvbSAnaGVsbWV0JztcbmltcG9ydCB7IHJhbmRvbUJ5dGVzIH0gZnJvbSAnY3J5cHRvJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IFJlZGlzU3RvcmUgZnJvbSAnY29ubmVjdC1yZWRpcydcblxuXG5pbnRlcmZhY2UgQXBwRGVwZW5kZW5jaWVzIHtcblx0ZXhwcmVzczogdHlwZW9mIGV4cHJlc3M7XG5cdHNlc3Npb246IHR5cGVvZiBzZXNzaW9uO1xuXHRjb29raWVQYXJzZXI6IHR5cGVvZiBjb29raWVQYXJzZXI7XG5cdGNvcnM6IHR5cGVvZiBjb3JzO1xuXHRocHA6IHR5cGVvZiBocHA7XG5cdG1vcmdhbjogdHlwZW9mIG1vcmdhbjtcblx0cGFzc3BvcnQ6IHR5cGVvZiBwYXNzcG9ydDtcblx0cmFuZG9tQnl0ZXM6IHR5cGVvZiByYW5kb21CeXRlcztcblx0cGF0aDogdHlwZW9mIHBhdGg7XG5cdFJlZGlzU3RvcmU6IHR5cGVvZiBSZWRpc1N0b3JlO1xuXHRpbml0aWFsaXplU3RhdGljUm91dGVzOiAoYXBwOiBBcHBsaWNhdGlvbikgPT4gdm9pZDtcblx0Y3NyZk1pZGRsZXdhcmU6IChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4gdm9pZDtcblx0ZXJyb3JIYW5kbGVyOiAoZXJyOiBhbnksIHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB2b2lkO1xuXHRnZXRSZWRpc0NsaWVudDogKCkgPT4gYW55O1xuXHRpcEJsYWNrbGlzdE1pZGRsZXdhcmU6IChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4gdm9pZDtcblx0Y3JlYXRlVGVzdFJvdXRlcjogKGFwcDogQXBwbGljYXRpb24pID0+IHZvaWQ7XG5cdHJhdGVMaW1pdE1pZGRsZXdhcmU6IChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4gdm9pZDtcblx0c2V0dXBTZWN1cml0eUhlYWRlcnM6IChcblx0XHRhcHA6IEFwcGxpY2F0aW9uLFxuXHRcdG9wdGlvbnM6IHsgaGVsbWV0T3B0aW9ucz86IEhlbG1ldE9wdGlvbnM7IHBlcm1pc3Npb25zUG9saWN5T3B0aW9ucz86IGFueSB9XG5cdCkgPT4gdm9pZDtcblx0c3RhcnRNZW1vcnlNb25pdG9yOiAoKSA9PiBOb2RlSlMuVGltZW91dDtcblx0bG9nZ2VyOiBhbnk7XG5cdHN0YXRpY1Jvb3RQYXRoOiBzdHJpbmc7XG5cdE5PREVfRU5WOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cdFNTTF9GTEFHOiBib29sZWFuO1xuXHRSRURJU19GTEFHOiBib29sZWFuO1xufVxuXG5hc3luYyBmdW5jdGlvbiBpbml0aWFsaXplQXBwKHtcblx0ZXhwcmVzcyxcblx0c2Vzc2lvbixcblx0Y29va2llUGFyc2VyLFxuXHRjb3JzLFxuXHRocHAsXG5cdG1vcmdhbixcblx0cGFzc3BvcnQsXG5cdHJhbmRvbUJ5dGVzLFxuXHRwYXRoLFxuXHRSZWRpc1N0b3JlLFxuXHRpbml0aWFsaXplU3RhdGljUm91dGVzLFxuXHRjc3JmTWlkZGxld2FyZSxcblx0ZXJyb3JIYW5kbGVyLFxuXHRnZXRSZWRpc0NsaWVudCxcblx0aXBCbGFja2xpc3RNaWRkbGV3YXJlLFxuXHRjcmVhdGVUZXN0Um91dGVyLFxuXHRyYXRlTGltaXRNaWRkbGV3YXJlLFxuXHRzZXR1cFNlY3VyaXR5SGVhZGVycyxcblx0c3RhcnRNZW1vcnlNb25pdG9yLFxuXHRsb2dnZXIsXG5cdHN0YXRpY1Jvb3RQYXRoLFxuXHROT0RFX0VOVixcblx0U1NMX0ZMQUcsXG5cdFJFRElTX0ZMQUcsXG59OiBBcHBEZXBlbmRlbmNpZXMpOiBQcm9taXNlPEFwcGxpY2F0aW9uPiB7XG5cdGNvbnN0IGFwcCA9IGV4cHJlc3MoKTtcblxuXHRsZXQgbWVtb3J5TW9uaXRvciA9IE5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnIHx8IE5PREVfRU5WID09PSAndGVzdGluZyc7XG5cdGlmIChtZW1vcnlNb25pdG9yKSB7XG5cdFx0bG9nZ2VyLmluZm8oJ01lbW9yeSBNb25pdG9yIGVuYWJsZWQnKTtcblx0XHRzdGFydE1lbW9yeU1vbml0b3IoKTtcblx0fVxuXG5cdGNvbnN0IG1pZGRsZXdhcmVzID0gW1xuXHRcdGV4cHJlc3MuanNvbigpLFxuXHRcdGV4cHJlc3MudXJsZW5jb2RlZCh7IGV4dGVuZGVkOiB0cnVlIH0pLFxuXHRcdGNvb2tpZVBhcnNlcigpLFxuXHRcdHBhc3Nwb3J0LmluaXRpYWxpemUoKSxcblx0XHRleHByZXNzLnN0YXRpYyhzdGF0aWNSb290UGF0aCksXG5cdFx0aHBwKCksXG5cdFx0cmF0ZUxpbWl0TWlkZGxld2FyZSxcblx0XHRpcEJsYWNrbGlzdE1pZGRsZXdhcmUsXG5cdFx0Y3NyZk1pZGRsZXdhcmVcblx0XTtcblxuXHRhcHAudXNlKC4uLm1pZGRsZXdhcmVzKTtcblxuXHRhcHAudXNlKFxuXHRcdGNvcnMoe1xuXHRcdFx0bWV0aG9kczogJ0dFVCxQT1NULFBVVCxERUxFVEUnLFxuXHRcdFx0YWxsb3dlZEhlYWRlcnM6ICdDb250ZW50LVR5cGUsQXV0aG9yaXphdGlvbicsXG5cdFx0XHRjcmVkZW50aWFsczogdHJ1ZVxuXHRcdH0pXG5cdCk7XG5cblx0YXBwLnVzZShcblx0XHRtb3JnYW4oJ2NvbWJpbmVkJywge1xuXHRcdFx0c3RyZWFtOiB7IHdyaXRlOiAobWVzc2FnZSA9ICcnKSA9PiBsb2dnZXIuaW5mbyhtZXNzYWdlLnRyaW0oKSkgfVxuXHRcdH0pXG5cdCk7XG5cblx0aW5pdGlhbGl6ZVN0YXRpY1JvdXRlcyhhcHApO1xuXG5cdGFwcC51c2UoYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG5cdFx0dHJ5IHtcblx0XHRcdHJlcy5sb2NhbHMuY3NwTm9uY2UgPSByYW5kb21CeXRlcygxNikudG9TdHJpbmcoJ2hleCcpO1xuXHRcdFx0bmV4dCgpO1xuXHRcdH0gY2F0Y2gge1xuXHRcdFx0bmV4dCgpO1xuXHRcdH1cblx0fSk7XG5cblx0c2V0dXBTZWN1cml0eUhlYWRlcnMoYXBwLCB7XG5cdFx0aGVsbWV0T3B0aW9uczoge1xuXHRcdC8vICpERVYtTk9URSogRklMTCBUSElTIE9VVFxuXHRcdH0sXG5cdFx0cGVybWlzc2lvbnNQb2xpY3lPcHRpb25zOiB7XG5cdFx0Ly8gKkRFVi1OT1RFKiBGSUxMIFRISVMgT1VUXG5cdFx0fVxuXHR9KTtcblxuXHRjcmVhdGVUZXN0Um91dGVyKGFwcCk7XG5cblx0Ly8gc2Vzc2lvbiBtYW5hZ2VtZW50XG5cdGlmIChSRURJU19GTEFHICYmIGdldFJlZGlzQ2xpZW50KCkpIHtcblx0XHRsb2dnZXIuaW5mbygnUkVESVNfRkxBRyBpcyB0cnVlLiBVc2luZyBSZWRpcyBmb3Igc2Vzc2lvbiBtYW5hZ2VtZW50Jyk7XG5cdFx0YXBwLnVzZShcblx0XHRcdHNlc3Npb24oe1xuXHRcdFx0XHRzdG9yZTogbmV3IFJlZGlzU3RvcmUoeyBjbGllbnQ6IGdldFJlZGlzQ2xpZW50KCkgfSksXG5cdFx0XHRcdHNlY3JldDogJ3NlY3JldHMuUkVESVNfS0VZJyxcblx0XHRcdFx0cmVzYXZlOiBmYWxzZSxcblx0XHRcdFx0c2F2ZVVuaW5pdGlhbGl6ZWQ6IGZhbHNlLFxuXHRcdFx0XHRjb29raWU6IHsgc2VjdXJlOiB0cnVlIH1cblx0XHRcdH0pXG5cdFx0KTtcblx0fSBlbHNlIHtcblx0XHRsb2dnZXIuaW5mbygnUkVESVNfRkxBRyBpcyBmYWxzZS4gVXNpbmcgaW4tbWVtb3J5IHN0b3JlIGZvciBzZXNzaW9uIG1hbmFnZW1lbnQnKTtcblxuXHRcdGFwcC51c2UoXG5cdFx0XHRzZXNzaW9uKHtcblx0XHRcdFx0c2VjcmV0OiAnc2VjcmV0cy5TRVNTSU9OX0tFWScsXG5cdFx0XHRcdHJlc2F2ZTogZmFsc2UsXG5cdFx0XHRcdHNhdmVVbmluaXRpYWxpemVkOiBmYWxzZSxcblx0XHRcdFx0Y29va2llOiB7IHNlY3VyZTogU1NMX0ZMQUcgfVxuXHRcdFx0fSlcblx0XHQpO1xuXHR9XG5cblx0Ly8gNDA0IGVycm9yIGhhbmRsaW5nXG5cdGFwcC51c2UoKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG5cdFx0cmVzLnN0YXR1cyg0MDQpLnNlbmRGaWxlKHBhdGguam9pbihzdGF0aWNSb290UGF0aCwgJzQwNC5odG1sJykpO1xuXHRcdG5leHQoKTtcblx0fSk7XG5cblx0Ly8gZ2VuZXJhbCBlcnJvciBoYW5kbGluZ1xuXHRhcHAudXNlKGVycm9ySGFuZGxlcik7XG5cblx0cmV0dXJuIGFwcDtcbn1cblxuZXhwb3J0IHsgaW5pdGlhbGl6ZUFwcCB9O1xuIl19
