import { BaseRouter } from './BaseRouter.mjs';
import { ServiceFactory } from '../index/factory.mjs';
import { check } from 'express-validator';
import { handleValidationErrors } from '../utils/validator.mjs';
export class APIRouter extends BaseRouter {
	userController;
	authController;
	constructor(
		logger,
		errorLogger,
		errorHandler,
		envConfig,
		cacheService,
		gatekeeperService,
		helmetService,
		JWTMiddleware,
		passportMiddleware
	) {
		super(
			logger,
			errorLogger,
			errorHandler,
			envConfig,
			cacheService,
			gatekeeperService,
			helmetService,
			JWTMiddleware,
			passportMiddleware
		);
		this.initializeServices().then(() => {
			this.setUpAPIRoutes();
		});
	}
	async initializeServices() {
		this.userController = await ServiceFactory.getUserController();
		this.authController = await ServiceFactory.getAuthController();
	}
	setUpAPIRoutes() {
		this.router.post(
			'/register.html',
			[
				check('username')
					.isLength({ min: 3 })
					.withMessage('Username must be at least 3 characters long')
					.trim()
					.escape(),
				check('email')
					.isEmail()
					.withMessage('Please provide a valid email address')
					.normalizeEmail(),
				check('password')
					.isLength({ min: 8 })
					.withMessage('Password must be at least 8 characters long')
					.matches(/[A-Z]/)
					.withMessage(
						'Password must contain at least one uppercase letter'
					)
					.matches(/[a-z]/)
					.withMessage(
						'Password must contain at least one lowercase letter'
					)
					.matches(/\d/)
					.withMessage('Password must contain at least one digit')
					.matches(/[^\w\s]/)
					.withMessage(
						'Password must contain at least one special character'
					),
				check('confirmPassword')
					.custom((value, { req }) => value === req.body.password)
					.withMessage('Passwords do not match'),
				handleValidationErrors
			],
			this.asyncHandler(async (req, res, next) => {
				try {
					const result = await this.userController.createUser(
						req.body
					);
					return res.json(result);
				} catch (err) {
					next(err);
					return;
				}
			})
		);
		this.router.post(
			'/login',
			[
				check('email')
					.isEmail()
					.withMessage('Please provide a valid email address')
					.normalizeEmail(),
				check('password')
					.notEmpty()
					.withMessage('Password is required'),
				handleValidationErrors
			],
			this.asyncHandler(async (req, res, next) => {
				const cacheKey = `login:${req.body.email}`;
				const cachedResponse = await this.cacheService.get(
					cacheKey,
					'userLogin'
				);
				if (cachedResponse) {
					return res.json(cachedResponse);
				}
				try {
					const result = await this.authController.loginUser(
						req.body.email,
						req.body.password
					);
					await this.cacheService.set(
						cacheKey,
						result,
						'userLogin',
						3600
					);
					return res.json(result);
				} catch (err) {
					next(err);
					return;
				}
			})
		);
		this.router.post(
			'/recover-password',
			[
				check('email')
					.isEmail()
					.withMessage('Please provide a valid email address')
					.normalizeEmail(),
				handleValidationErrors
			],
			this.asyncHandler(async (req, res, next) => {
				const cacheKey = `recover-password:${req.body.email}`;
				const cachedResponse = await this.cacheService.get(
					cacheKey,
					'recoverPassword'
				);
				if (cachedResponse) {
					return res.json(cachedResponse);
				}
				try {
					await this.authController.recoverPassword(req.body.email);
					const response = {
						message: 'Password recovery email sent'
					};
					await this.cacheService.set(
						cacheKey,
						response,
						'recoverPassword',
						3600
					);
					return res.json(response);
				} catch (err) {
					this.errorLogger.logError('Password recovery failed');
					next(err);
					return;
				}
			})
		);
		this.router.post(
			'/generate-totp',
			[
				check('userId').notEmpty().withMessage('User ID is required'),
				handleValidationErrors
			],
			this.asyncHandler(async (req, res, next) => {
				const cacheKey = `generate-totp:${req.body.userId}`;
				const cachedResponse = await this.cacheService.get(
					cacheKey,
					'generateTOTP'
				);
				if (cachedResponse) {
					return res.json(cachedResponse);
				}
				try {
					const result = await this.authController.generateTOTP(
						req.body.userId
					);
					await this.cacheService.set(
						cacheKey,
						result,
						'generateTOTP',
						3600
					);
					return res.json(result);
				} catch (err) {
					this.errorLogger.logError('TOTP generation failed');
					next(err);
					return;
				}
			})
		);
		this.router.post(
			'/verify-totp',
			[
				check('userId').notEmpty().withMessage('User ID is required'),
				check('token').notEmpty().withMessage('Token is required'),
				handleValidationErrors
			],
			this.asyncHandler(async (req, res, next) => {
				try {
					const isValid = await this.authController.verifyTOTP(
						req.body.userId,
						req.body.token
					);
					return res.json({ isValid });
				} catch (err) {
					this.errorLogger.logError('TOTP verification failed');
					next(err);
					return;
				}
			})
		);
		this.router.post(
			'/generate-email-mfa',
			[
				check('email')
					.isEmail()
					.withMessage('Please provide a valid email address')
					.normalizeEmail(),
				handleValidationErrors
			],
			this.asyncHandler(async (req, res, next) => {
				const cacheKey = `generate-email-mfa:${req.body.email}`;
				const cachedResponse = await this.cacheService.get(
					cacheKey,
					'generateEmailMFA'
				);
				if (cachedResponse) {
					return res.json(cachedResponse);
				}
				try {
					await this.authController.generateEmailMFACode(
						req.body.email
					);
					const response = { message: 'MFA code sent' };
					await this.cacheService.set(
						cacheKey,
						response,
						'generateEmailMFA',
						3600
					);
					return res.json(response);
				} catch (err) {
					this.errorLogger.logError('Email MFA generation failed');
					next(err);
					return;
				}
			})
		);
		this.router.post(
			'/verify-email-mfa',
			[
				check('email')
					.isEmail()
					.withMessage('Please provide a valid email address')
					.normalizeEmail(),
				check('emailMFACode')
					.notEmpty()
					.withMessage('MFA code is required'),
				handleValidationErrors
			],
			this.asyncHandler(async (req, res, next) => {
				try {
					const isValid =
						await this.authController.verifyEmailMFACode(
							req.body.email,
							req.body.email2FACode
						);
					return res.json({ isValid });
				} catch (err) {
					this.errorLogger.logError('Email 2FA verification failed');
					next(err);
					return;
				}
			})
		);
	}
	getAPIRouter() {
		return this.router;
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQVBJUm91dGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3JvdXRlcnMvQVBJUm91dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFMUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUMxQyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQWU1RCxNQUFNLE9BQU8sU0FBVSxTQUFRLFVBQVU7SUFDaEMsY0FBYyxDQUEyQjtJQUN6QyxjQUFjLENBQTJCO0lBRWpELFlBQ0MsTUFBaUMsRUFDakMsV0FBd0MsRUFDeEMsWUFBMEMsRUFDMUMsU0FBb0MsRUFDcEMsWUFBbUMsRUFDbkMsaUJBQTZDLEVBQzdDLGFBQStDLEVBQy9DLGFBQWdELEVBQ2hELGtCQUEwRDtRQUUxRCxLQUFLLENBQ0osTUFBTSxFQUNOLFdBQVcsRUFDWCxZQUFZLEVBQ1osU0FBUyxFQUNULFlBQVksRUFDWixpQkFBaUIsRUFDakIsYUFBYSxFQUNiLGFBQWEsRUFDYixrQkFBa0IsQ0FDbEIsQ0FBQztRQUNGLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDbkMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3ZCLENBQUMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVPLEtBQUssQ0FBQyxrQkFBa0I7UUFDL0IsSUFBSSxDQUFDLGNBQWMsR0FBRyxNQUFNLGNBQWMsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQy9ELElBQUksQ0FBQyxjQUFjLEdBQUcsTUFBTSxjQUFjLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztJQUNoRSxDQUFDO0lBRU8sY0FBYztRQUNyQixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDZixnQkFB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QWMsQ0FBQztpQkFDbkIsUUFBUSxFQUFFO2lCQUNWLFdBQVcsQ0FBQyxzQkFBc0IsQ0FBQztZQUNyQyxzQkFBc0I7U0FDdEIsRUFDRCxJQUFJLENBQUMsWUFBWSxDQUNoQixLQUFLLEVBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQixFQUFFLEVBQUU7WUFDekQsSUFBSSxDQUFDO2dCQUNKLE1BQU0sT0FBTyxHQUNaLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxrQkFBa0IsQ0FDM0MsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQ2QsR0FBRyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQ3JCLENBQUM7Z0JBQ0gsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztZQUM5QixDQUFDO1lBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztnQkFDZCxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FDeEIsK0JBQStCLENBQy9CLENBQUM7Z0JBQ0YsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNWLE9BQU87WUFDUixDQUFDO1FBQ0YsQ0FBQyxDQUNELENBQ0QsQ0FBQztJQUNILENBQUM7SUFFTSxZQUFZO1FBQ2xCLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUNwQixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCYXNlUm91dGVyIH0gZnJvbSAnLi9CYXNlUm91dGVyJztcbmltcG9ydCB7IE5leHRGdW5jdGlvbiwgUmVxdWVzdCwgUmVzcG9uc2UsIFJvdXRlciB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgU2VydmljZUZhY3RvcnkgfSBmcm9tICcuLi9pbmRleC9mYWN0b3J5JztcbmltcG9ydCB7IGNoZWNrIH0gZnJvbSAnZXhwcmVzcy12YWxpZGF0b3InO1xuaW1wb3J0IHsgaGFuZGxlVmFsaWRhdGlvbkVycm9ycyB9IGZyb20gJy4uL3V0aWxzL3ZhbGlkYXRvcic7XG5pbXBvcnQge1xuXHRBcHBMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRBdXRoQ29udHJvbGxlckludGVyZmFjZSxcblx0Q2FjaGVTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFbnZDb25maWdTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdEdhdGVrZWVwZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRIZWxtZXRNaWRkbGV3YXJlU2VydmljZUludGVyZmFjZSxcblx0SldUQXV0aE1pZGRsZXdhcmVTZXJ2aWNlSW50ZXJmYWNlLFxuXHRQYXNzcG9ydEF1dGhNaWRkbGV3YXJlU2VydmljZUludGVyZmFjZSxcblx0VXNlckNvbnRyb2xsZXJJbnRlcmZhY2Vcbn0gZnJvbSAnLi4vaW5kZXgvaW50ZXJmYWNlcy9zZXJ2aWNlcyc7XG5cbmV4cG9ydCBjbGFzcyBBUElSb3V0ZXIgZXh0ZW5kcyBCYXNlUm91dGVyIHtcblx0cHJpdmF0ZSB1c2VyQ29udHJvbGxlciE6IFVzZXJDb250cm9sbGVySW50ZXJmYWNlO1xuXHRwcml2YXRlIGF1dGhDb250cm9sbGVyITogQXV0aENvbnRyb2xsZXJJbnRlcmZhY2U7XG5cblx0cHJpdmF0ZSBjb25zdHJ1Y3Rvcihcblx0XHRsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0ZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0XHRlcnJvckhhbmRsZXI6IEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0ZW52Q29uZmlnOiBFbnZDb25maWdTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGNhY2hlU2VydmljZTogQ2FjaGVTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGdhdGVrZWVwZXJTZXJ2aWNlOiBHYXRla2VlcGVyU2VydmljZUludGVyZmFjZSxcblx0XHRoZWxtZXRTZXJ2aWNlOiBIZWxtZXRNaWRkbGV3YXJlU2VydmljZUludGVyZmFjZSxcblx0XHRKV1RNaWRkbGV3YXJlOiBKV1RBdXRoTWlkZGxld2FyZVNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0cGFzc3BvcnRNaWRkbGV3YXJlOiBQYXNzcG9ydEF1dGhNaWRkbGV3YXJlU2VydmljZUludGVyZmFjZVxuXHQpIHtcblx0XHRzdXBlcihcblx0XHRcdGxvZ2dlcixcblx0XHRcdGVycm9yTG9nZ2VyLFxuXHRcdFx0ZXJyb3JIYW5kbGVyLFxuXHRcdFx0ZW52Q29uZmlnLFxuXHRcdFx0Y2FjaGVTZXJ2aWNlLFxuXHRcdFx0Z2F0ZWtlZXBlclNlcnZpY2UsXG5cdFx0XHRoZWxtZXRTZXJ2aWNlLFxuXHRcdFx0SldUTWlkZGxld2FyZSxcblx0XHRcdHBhc3Nwb3J0TWlkZGxld2FyZVxuXHRcdCk7XG5cdFx0dGhpcy5pbml0aWFsaXplU2VydmljZXMoKS50aGVuKCgpID0+IHtcblx0XHRcdHRoaXMuc2V0VXBBUElSb3V0ZXMoKTtcblx0XHR9KTtcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgaW5pdGlhbGl6ZVNlcnZpY2VzKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdHRoaXMudXNlckNvbnRyb2xsZXIgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRVc2VyQ29udHJvbGxlcigpO1xuXHRcdHRoaXMuYXV0aENvbnRyb2xsZXIgPSBhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRBdXRoQ29udHJvbGxlcigpO1xuXHR9XG5cblx0cHJpdmF0ZSBzZXRVcEFQSVJvdXRlcygpOiB2b2lkIHtcblx0XHR0aGlzLnJvdXRlci5wb3N0KFxuXHRcdFx0Jy9yZWdpc3Rlci5odG1sJyxcblx0XHRcdFtcblx0XHRcdFx0Y2hlY2soJ3VzZXJuYW1lJylcblx0XHRcdFx0XHQuaXNMZW5ndGgoeyBtaW46IDMgfSlcblx0XHRcdFx0XHQud2l0aE1lc3NhZ2UoJ1VzZXJuYW1lIG11c3QgYmUgYXQgbGVhc3QgMyBjaGFyYWN0ZXJzIGxvbmcnKVxuXHRcdFx0XHRcdC50cmltKClcblx0XHRcdFx0XHQuZXNjYXBlKCksXG5cdFx0XHRcdGNoZWNrKCdlbWFpbCcpXG5cdFx0XHRcdFx0LmlzRW1haWwoKVxuXHRcdFx0XHRcdC53aXRoTWVzc2FnZSgnUGxlYXNlIHByb3ZpZGUgYSB2YWxpZCBlbWFpbCBhZGRyZXNzJylcblx0XHRcdFx0XHQubm9ybWFsaXplRW1haWwoKSxcblx0XHRcdFx0Y2hlY2soJ3Bhc3N3b3JkJylcblx0XHRcdFx0XHQuaXNMZW5ndGgoeyBtaW46IDggfSlcblx0XHRcdFx0XHQud2l0aE1lc3NhZ2UoJ1Bhc3N3b3JkIG11c3QgYmUgYXQgbGVhc3QgOCBjaGFyYWN0ZXJzIGxvbmcnKVxuXHRcdFx0XHRcdC5tYXRjaGVzKC9bQS1aXS8pXG5cdFx0XHRcdFx0LndpdGhNZXNzYWdlKFxuXHRcdFx0XHRcdFx0J1Bhc3N3b3JkIG11c3QgY29udGFpbiBhdCBsZWFzdCBvbmUgdXBwZXJjYXNlIGxldHRlcidcblx0XHRcdFx0XHQpXG5cdFx0XHRcdFx0Lm1hdGNoZXMoL1thLXpdLylcblx0XHRcdFx0XHQud2l0aE1lc3NhZ2UoXG5cdFx0XHRcdFx0XHQnUGFzc3dvcmQgbXVzdCBjb250YWluIGF0IGxlYXN0IG9uZSBsb3dlcmNhc2UgbGV0dGVyJ1xuXHRcdFx0XHRcdClcblx0XHRcdFx0XHQubWF0Y2hlcygvXFxkLylcblx0XHRcdFx0XHQud2l0aE1lc3NhZ2UoJ1Bhc3N3b3JkIG11c3QgY29udGFpbiBhdCBsZWFzdCBvbmUgZGlnaXQnKVxuXHRcdFx0XHRcdC5tYXRjaGVzKC9bXlxcd1xcc10vKVxuXHRcdFx0XHRcdC53aXRoTWVzc2FnZShcblx0XHRcdFx0XHRcdCdQYXNzd29yZCBtdXN0IGNvbnRhaW4gYXQgbGVhc3Qgb25lIHNwZWNpYWwgY2hhcmFjdGVyJ1xuXHRcdFx0XHRcdCksXG5cdFx0XHRcdGNoZWNrKCdjb25maXJtUGFzc3dvcmQnKVxuXHRcdFx0XHRcdC5jdXN0b20oKHZhbHVlLCB7IHJlcSB9KSA9PiB2YWx1ZSA9PT0gcmVxLmJvZHkucGFzc3dvcmQpXG5cdFx0XHRcdFx0LndpdGhNZXNzYWdlKCdQYXNzd29yZHMgZG8gbm90IG1hdGNoJyksXG5cdFx0XHRcdGhhbmRsZVZhbGlkYXRpb25FcnJvcnNcblx0XHRcdF0sXG5cdFx0XHR0aGlzLmFzeW5jSGFuZGxlcihcblx0XHRcdFx0YXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG5cdFx0XHRcdFx0dHJ5IHtcblx0XHRcdFx0XHRcdGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMudXNlckNvbnRyb2xsZXIuY3JlYXRlVXNlcihcblx0XHRcdFx0XHRcdFx0cmVxLmJvZHlcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRyZXR1cm4gcmVzLmpzb24ocmVzdWx0KTtcblx0XHRcdFx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdFx0XHRcdG5leHQoZXJyKTtcblx0XHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdClcblx0XHQpO1xuXG5cdFx0dGhpcy5yb3V0ZXIucG9zdChcblx0XHRcdCcvbG9naW4nLFxuXHRcdFx0W1xuXHRcdFx0XHRjaGVjaygnZW1haWwnKVxuXHRcdFx0XHRcdC5pc0VtYWlsKClcblx0XHRcdFx0XHQud2l0aE1lc3NhZ2UoJ1BsZWFzZSBwcm92aWRlIGEgdmFsaWQgZW1haWwgYWRkcmVzcycpXG5cdFx0XHRcdFx0Lm5vcm1hbGl6ZUVtYWlsKCksXG5cdFx0XHRcdGNoZWNrKCdwYXNzd29yZCcpXG5cdFx0XHRcdFx0Lm5vdEVtcHR5KClcblx0XHRcdFx0XHQud2l0aE1lc3NhZ2UoJ1Bhc3N3b3JkIGlzIHJlcXVpcmVkJyksXG5cdFx0XHRcdGhhbmRsZVZhbGlkYXRpb25FcnJvcnNcblx0XHRcdF0sXG5cdFx0XHR0aGlzLmFzeW5jSGFuZGxlcihcblx0XHRcdFx0YXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgY2FjaGVLZXkgPSBgbG9naW46JHtyZXEuYm9keS5lbWFpbH1gO1xuXHRcdFx0XHRcdGNvbnN0IGNhY2hlZFJlc3BvbnNlID0gYXdhaXQgdGhpcy5jYWNoZVNlcnZpY2UuZ2V0KFxuXHRcdFx0XHRcdFx0Y2FjaGVLZXksXG5cdFx0XHRcdFx0XHQndXNlckxvZ2luJ1xuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0aWYgKGNhY2hlZFJlc3BvbnNlKSB7XG5cdFx0XHRcdFx0XHRyZXR1cm4gcmVzLmpzb24oY2FjaGVkUmVzcG9uc2UpO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0XHRjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmF1dGhDb250cm9sbGVyLmxvZ2luVXNlcihcblx0XHRcdFx0XHRcdFx0cmVxLmJvZHkuZW1haWwsXG5cdFx0XHRcdFx0XHRcdHJlcS5ib2R5LnBhc3N3b3JkXG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0YXdhaXQgdGhpcy5jYWNoZVNlcnZpY2Uuc2V0KFxuXHRcdFx0XHRcdFx0XHRjYWNoZUtleSxcblx0XHRcdFx0XHRcdFx0cmVzdWx0LFxuXHRcdFx0XHRcdFx0XHQndXNlckxvZ2luJyxcblx0XHRcdFx0XHRcdFx0MzYwMFxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdHJldHVybiByZXMuanNvbihyZXN1bHQpO1xuXHRcdFx0XHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0XHRcdFx0bmV4dChlcnIpO1xuXHRcdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0KVxuXHRcdCk7XG5cblx0XHR0aGlzLnJvdXRlci5wb3N0KFxuXHRcdFx0Jy9yZWNvdmVyLXBhc3N3b3JkJyxcblx0XHRcdFtcblx0XHRcdFx0Y2hlY2soJ2VtYWlsJylcblx0XHRcdFx0XHQuaXNFbWFpbCgpXG5cdFx0XHRcdFx0LndpdGhNZXNzYWdlKCdQbGVhc2UgcHJvdmlkZSBhIHZhbGlkIGVtYWlsIGFkZHJlc3MnKVxuXHRcdFx0XHRcdC5ub3JtYWxpemVFbWFpbCgpLFxuXHRcdFx0XHRoYW5kbGVWYWxpZGF0aW9uRXJyb3JzXG5cdFx0XHRdLFxuXHRcdFx0dGhpcy5hc3luY0hhbmRsZXIoXG5cdFx0XHRcdGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IGNhY2hlS2V5ID0gYHJlY292ZXItcGFzc3dvcmQ6JHtyZXEuYm9keS5lbWFpbH1gO1xuXHRcdFx0XHRcdGNvbnN0IGNhY2hlZFJlc3BvbnNlID0gYXdhaXQgdGhpcy5jYWNoZVNlcnZpY2UuZ2V0KFxuXHRcdFx0XHRcdFx0Y2FjaGVLZXksXG5cdFx0XHRcdFx0XHQncmVjb3ZlclBhc3N3b3JkJ1xuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0aWYgKGNhY2hlZFJlc3BvbnNlKSB7XG5cdFx0XHRcdFx0XHRyZXR1cm4gcmVzLmpzb24oY2FjaGVkUmVzcG9uc2UpO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0XHRhd2FpdCB0aGlzLmF1dGhDb250cm9sbGVyLnJlY292ZXJQYXNzd29yZChcblx0XHRcdFx0XHRcdFx0cmVxLmJvZHkuZW1haWxcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRjb25zdCByZXNwb25zZSA9IHtcblx0XHRcdFx0XHRcdFx0bWVzc2FnZTogJ1Bhc3N3b3JkIHJlY292ZXJ5IGVtYWlsIHNlbnQnXG5cdFx0XHRcdFx0XHR9O1xuXHRcdFx0XHRcdFx0YXdhaXQgdGhpcy5jYWNoZVNlcnZpY2Uuc2V0KFxuXHRcdFx0XHRcdFx0XHRjYWNoZUtleSxcblx0XHRcdFx0XHRcdFx0cmVzcG9uc2UsXG5cdFx0XHRcdFx0XHRcdCdyZWNvdmVyUGFzc3dvcmQnLFxuXHRcdFx0XHRcdFx0XHQzNjAwXG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0cmV0dXJuIHJlcy5qc29uKHJlc3BvbnNlKTtcblx0XHRcdFx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdFx0XHRcdHRoaXMuZXJyb3JMb2dnZXIubG9nRXJyb3IoJ1Bhc3N3b3JkIHJlY292ZXJ5IGZhaWxlZCcpO1xuXHRcdFx0XHRcdFx0bmV4dChlcnIpO1xuXHRcdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0KVxuXHRcdCk7XG5cblx0XHR0aGlzLnJvdXRlci5wb3N0KFxuXHRcdFx0Jy9nZW5lcmF0ZS10b3RwJyxcblx0XHRcdFtcblx0XHRcdFx0Y2hlY2soJ3VzZXJJZCcpLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoJ1VzZXIgSUQgaXMgcmVxdWlyZWQnKSxcblx0XHRcdFx0aGFuZGxlVmFsaWRhdGlvbkVycm9yc1xuXHRcdFx0XSxcblx0XHRcdHRoaXMuYXN5bmNIYW5kbGVyKFxuXHRcdFx0XHRhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcblx0XHRcdFx0XHRjb25zdCBjYWNoZUtleSA9IGBnZW5lcmF0ZS10b3RwOiR7cmVxLmJvZHkudXNlcklkfWA7XG5cdFx0XHRcdFx0Y29uc3QgY2FjaGVkUmVzcG9uc2UgPSBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5nZXQoXG5cdFx0XHRcdFx0XHRjYWNoZUtleSxcblx0XHRcdFx0XHRcdCdnZW5lcmF0ZVRPVFAnXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRpZiAoY2FjaGVkUmVzcG9uc2UpIHtcblx0XHRcdFx0XHRcdHJldHVybiByZXMuanNvbihjYWNoZWRSZXNwb25zZSk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0dHJ5IHtcblx0XHRcdFx0XHRcdGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuYXV0aENvbnRyb2xsZXIuZ2VuZXJhdGVUT1RQKFxuXHRcdFx0XHRcdFx0XHRyZXEuYm9keS51c2VySWRcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5zZXQoXG5cdFx0XHRcdFx0XHRcdGNhY2hlS2V5LFxuXHRcdFx0XHRcdFx0XHRyZXN1bHQsXG5cdFx0XHRcdFx0XHRcdCdnZW5lcmF0ZVRPVFAnLFxuXHRcdFx0XHRcdFx0XHQzNjAwXG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0cmV0dXJuIHJlcy5qc29uKHJlc3VsdCk7XG5cdFx0XHRcdFx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0XHRcdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKCdUT1RQIGdlbmVyYXRpb24gZmFpbGVkJyk7XG5cdFx0XHRcdFx0XHRuZXh0KGVycik7XG5cdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHQpXG5cdFx0KTtcblxuXHRcdHRoaXMucm91dGVyLnBvc3QoXG5cdFx0XHQnL3ZlcmlmeS10b3RwJyxcblx0XHRcdFtcblx0XHRcdFx0Y2hlY2soJ3VzZXJJZCcpLm5vdEVtcHR5KCkud2l0aE1lc3NhZ2UoJ1VzZXIgSUQgaXMgcmVxdWlyZWQnKSxcblx0XHRcdFx0Y2hlY2soJ3Rva2VuJykubm90RW1wdHkoKS53aXRoTWVzc2FnZSgnVG9rZW4gaXMgcmVxdWlyZWQnKSxcblx0XHRcdFx0aGFuZGxlVmFsaWRhdGlvbkVycm9yc1xuXHRcdFx0XSxcblx0XHRcdHRoaXMuYXN5bmNIYW5kbGVyKFxuXHRcdFx0XHRhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcblx0XHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdFx0Y29uc3QgaXNWYWxpZCA9IGF3YWl0IHRoaXMuYXV0aENvbnRyb2xsZXIudmVyaWZ5VE9UUChcblx0XHRcdFx0XHRcdFx0cmVxLmJvZHkudXNlcklkLFxuXHRcdFx0XHRcdFx0XHRyZXEuYm9keS50b2tlblxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdHJldHVybiByZXMuanNvbih7IGlzVmFsaWQgfSk7XG5cdFx0XHRcdFx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0XHRcdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKCdUT1RQIHZlcmlmaWNhdGlvbiBmYWlsZWQnKTtcblx0XHRcdFx0XHRcdG5leHQoZXJyKTtcblx0XHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdClcblx0XHQpO1xuXG5cdFx0dGhpcy5yb3V0ZXIucG9zdChcblx0XHRcdCcvZ2VuZXJhdGUtZW1haWwtbWZhJyxcblx0XHRcdFtcblx0XHRcdFx0Y2hlY2soJ2VtYWlsJylcblx0XHRcdFx0XHQuaXNFbWFpbCgpXG5cdFx0XHRcdFx0LndpdGhNZXNzYWdlKCdQbGVhc2UgcHJvdmlkZSBhIHZhbGlkIGVtYWlsIGFkZHJlc3MnKVxuXHRcdFx0XHRcdC5ub3JtYWxpemVFbWFpbCgpLFxuXHRcdFx0XHRoYW5kbGVWYWxpZGF0aW9uRXJyb3JzXG5cdFx0XHRdLFxuXHRcdFx0dGhpcy5hc3luY0hhbmRsZXIoXG5cdFx0XHRcdGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IGNhY2hlS2V5ID0gYGdlbmVyYXRlLWVtYWlsLW1mYToke3JlcS5ib2R5LmVtYWlsfWA7XG5cdFx0XHRcdFx0Y29uc3QgY2FjaGVkUmVzcG9uc2UgPSBhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5nZXQoXG5cdFx0XHRcdFx0XHRjYWNoZUtleSxcblx0XHRcdFx0XHRcdCdnZW5lcmF0ZUVtYWlsTUZBJ1xuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0aWYgKGNhY2hlZFJlc3BvbnNlKSB7XG5cdFx0XHRcdFx0XHRyZXR1cm4gcmVzLmpzb24oY2FjaGVkUmVzcG9uc2UpO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0XHRhd2FpdCB0aGlzLmF1dGhDb250cm9sbGVyLmdlbmVyYXRlRW1haWxNRkFDb2RlKFxuXHRcdFx0XHRcdFx0XHRyZXEuYm9keS5lbWFpbFxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdGNvbnN0IHJlc3BvbnNlID0geyBtZXNzYWdlOiAnTUZBIGNvZGUgc2VudCcgfTtcblx0XHRcdFx0XHRcdGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLnNldChcblx0XHRcdFx0XHRcdFx0Y2FjaGVLZXksXG5cdFx0XHRcdFx0XHRcdHJlc3BvbnNlLFxuXHRcdFx0XHRcdFx0XHQnZ2VuZXJhdGVFbWFpbE1GQScsXG5cdFx0XHRcdFx0XHRcdDM2MDBcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRyZXR1cm4gcmVzLmpzb24ocmVzcG9uc2UpO1xuXHRcdFx0XHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0XHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcihcblx0XHRcdFx0XHRcdFx0J0VtYWlsIE1GQSBnZW5lcmF0aW9uIGZhaWxlZCdcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRuZXh0KGVycik7XG5cdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHQpXG5cdFx0KTtcblxuXHRcdHRoaXMucm91dGVyLnBvc3QoXG5cdFx0XHQnL3ZlcmlmeS1lbWFpbC1tZmEnLFxuXHRcdFx0W1xuXHRcdFx0XHRjaGVjaygnZW1haWwnKVxuXHRcdFx0XHRcdC5pc0VtYWlsKClcblx0XHRcdFx0XHQud2l0aE1lc3NhZ2UoJ1BsZWFzZSBwcm92aWRlIGEgdmFsaWQgZW1haWwgYWRkcmVzcycpXG5cdFx0XHRcdFx0Lm5vcm1hbGl6ZUVtYWlsKCksXG5cdFx0XHRcdGNoZWNrKCdlbWFpbE1GQUNvZGUnKVxuXHRcdFx0XHRcdC5ub3RFbXB0eSgpXG5cdFx0XHRcdFx0LndpdGhNZXNzYWdlKCdNRkEgY29kZSBpcyByZXF1aXJlZCcpLFxuXHRcdFx0XHRoYW5kbGVWYWxpZGF0aW9uRXJyb3JzXG5cdFx0XHRdLFxuXHRcdFx0dGhpcy5hc3luY0hhbmRsZXIoXG5cdFx0XHRcdGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuXHRcdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0XHRjb25zdCBpc1ZhbGlkID1cblx0XHRcdFx0XHRcdFx0YXdhaXQgdGhpcy5hdXRoQ29udHJvbGxlci52ZXJpZnlFbWFpbE1GQUNvZGUoXG5cdFx0XHRcdFx0XHRcdFx0cmVxLmJvZHkuZW1haWwsXG5cdFx0XHRcdFx0XHRcdFx0cmVxLmJvZHkuZW1haWwyRkFDb2RlXG5cdFx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRyZXR1cm4gcmVzLmpzb24oeyBpc1ZhbGlkIH0pO1xuXHRcdFx0XHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0XHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcihcblx0XHRcdFx0XHRcdFx0J0VtYWlsIDJGQSB2ZXJpZmljYXRpb24gZmFpbGVkJ1xuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdG5leHQoZXJyKTtcblx0XHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdClcblx0XHQpO1xuXHR9XG5cblx0cHVibGljIGdldEFQSVJvdXRlcigpOiBSb3V0ZXIge1xuXHRcdHJldHVybiB0aGlzLnJvdXRlcjtcblx0fVxufVxuIl19
