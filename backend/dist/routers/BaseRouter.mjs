import express from 'express';
import { APIRouter } from './APIRouter.mjs';
import { HealthRouter } from './HealthRouter.mjs';
import { StaticRouter } from './StaticRouter.mjs';
import { TestRouter } from './TestRouter.mjs';
import { ServiceFactory } from '../index/factory.mjs';
import { sanitizeRequestBody } from '../utils/validator.mjs';
import { validateDependencies } from '../utils/helpers.mjs';
import { withRetry } from '../utils/helpers.mjs';
import compression from 'compression';
import hpp from 'hpp';
import passport from 'passport';
import xss from 'xss';
export class BaseRouter {
	static instance = null;
	router;
	logger;
	errorLogger;
	errorHandler;
	envConfig;
	cacheService;
	gatekeeperService;
	helmetService;
	JWTMiddleware;
	passportMiddleware;
	apiRouteTable = {};
	healthRouteTable = {};
	staticRouteTable = {};
	testRouteTable = {};
	constructor(
		logger,
		errorLogger,
		errorHandler,
		envConfig,
		cacheService,
		gatekeeperService,
		helmetService,
		JWTMiddleware,
		passportMiddleware
	) {
		this.router = express.Router();
		this.logger = logger;
		this.errorLogger = errorLogger;
		this.errorHandler = errorHandler;
		this.envConfig = envConfig;
		this.cacheService = cacheService;
		this.gatekeeperService = gatekeeperService;
		this.helmetService = helmetService;
		this.JWTMiddleware = JWTMiddleware;
		this.passportMiddleware = passportMiddleware;
	}
	static async getInstance() {
		if (!BaseRouter.instance) {
			BaseRouter.instance = new BaseRouter(
				await ServiceFactory.getLoggerService(),
				await ServiceFactory.getErrorLoggerService(),
				await ServiceFactory.getErrorHandlerService(),
				await ServiceFactory.getEnvConfigService(),
				await ServiceFactory.getCacheService(),
				await ServiceFactory.getGatekeeperService(),
				await ServiceFactory.getHelmetMiddlewareService(),
				await ServiceFactory.getJWTAuthMiddlewareService(),
				await ServiceFactory.getPassportAuthMiddlewareService()
			);
			await BaseRouter.instance.initializeBaseRouter();
		}
		return BaseRouter.instance;
	}
	getRouter() {
		return this.router;
	}
	async initializeBaseRouter() {
		await withRetry(
			async () => {
				this.router = express.Router();
				await this.loadRouteTables();
				await this.applyMiddlewares();
				this.setUpRoutes();
			},
			10,
			250,
			true
		);
	}
	async loadRouteTables() {
		const apiRouteTable = (await import('../config/routeTables'))
			.apiRouteTable;
		const healthRoutes = (await import('../config/routeTables'))
			.healthRouteTable;
		const staticRoutes = (await import('../config/routeTables'))
			.staticRouteTable;
		const testRoutes = (await import('../config/routeTables'))
			.testRouteTable;
		this.apiRouteTable = apiRouteTable;
		this.healthRouteTable = healthRoutes;
		this.staticRouteTable = staticRoutes;
		this.testRouteTable = testRoutes;
	}
	setUpRoutes() {
		this.router.all('*', this.asyncHandler(this.routeHandler.bind(this)));
	}
	async routeHandler(req, res, next) {
		const method = req.method;
		const path = req.path;
		try {
			if (
				this.staticRouteTable[path] &&
				this.staticRouteTable[path][method]
			) {
				return await this.handleRoute(
					this.staticRouteTable[path][method],
					req,
					res,
					next
				);
			}
			if (this.apiRouteTable[path] && this.apiRouteTable[path][method]) {
				return await this.handleRoute(
					this.apiRouteTable[path][method],
					req,
					res,
					next
				);
			}
			if (
				this.healthRouteTable[path] &&
				this.healthRouteTable[path][method]
			) {
				return await this.handleRoute(
					this.healthRouteTable[path][method],
					req,
					res,
					next
				);
			}
			if (
				this.testRouteTable[path] &&
				this.testRouteTable[path][method] &&
				this.envConfig.getFeatureFlags().loadTestRoutes
			) {
				return await this.handleRoute(
					this.testRouteTable[path][method],
					req,
					res,
					next
				);
			}
			const staticRouterInstance = await StaticRouter.getInstance();
			await staticRouterInstance.serveNotFoundPage(req, res, next);
		} catch (error) {
			this.handleRouteError(error, req, res, next);
		}
	}
	async handleRoute(routerName, req, res, next) {
		await withRetry(
			async () => {
				switch (routerName) {
					case 'staticRouter':
						(await StaticRouter.getInstance()).getRouter()(
							req,
							res,
							next
						);
						break;
					case 'apiRouter':
						(await APIRouter.getInstance()).getRouter()(
							req,
							res,
							next
						);
						break;
					case 'healthRouter':
						(await HealthRouter.getInstance()).getRouter()(
							req,
							res,
							next
						);
						break;
					case 'testRouter':
						(await TestRouter.getInstance()).getRouter()(
							req,
							res,
							next
						);
						break;
					default:
						res.status(500).json({
							message: 'Internal server error'
						});
						next();
				}
			},
			5,
			250,
			true
		).catch(error => {
			this.logger.error(`Failed to handle route: ${error}`);
			res.status(500).json({
				message: 'Failed to handle route after multiple attempts'
			});
			next();
		});
	}
	async applyMiddlewares() {
		const app = express();
		this.applyErrorHandler();
		this.applySanitization();
		this.applyGatekeeper();
		this.applySecurityHeaders(app);
		this.applyCompression();
		this.applyPassportAndJWTAuth();
	}
	applyCompression() {
		this.router.use(compression());
	}
	applyGatekeeper() {
		this.router.use(this.gatekeeperService.rateLimitMiddleware());
		this.router.use(this.gatekeeperService.slowdownMiddleware());
		this.router.use(this.gatekeeperService.ipBlacklistMiddleware());
	}
	applyPassportAndJWTAuth() {
		this.router.use(
			this.asyncHandler(async (req, res, next) => {
				const passportDeps = {
					passport,
					authenticateOptions: { session: false },
					validateDependencies
				};
				this.passportMiddleware.initializePassportAuthMiddleware(
					passportDeps
				);
				passport.session();
				this.JWTMiddleware.initializeJWTAuthMiddleware();
				next();
			})
		);
	}
	applySanitization() {
		this.router.use(
			this.asyncHandler(async (req, res, next) => {
				req.body = await sanitizeRequestBody(req.body);
				for (const key in req.query) {
					if (req.query.hasOwnProperty(key)) {
						req.query[key] = xss(req.query[key]);
					}
				}
				for (const key in req.params) {
					if (req.params.hasOwnProperty(key)) {
						req.params[key] = xss(req.params[key]);
					}
				}
				next();
			})
		);
	}
	async applySecurityHeaders(app) {
		try {
			await withRetry(
				() => this.helmetService.initializeHelmetMiddleware(app),
				3,
				1000
			);
			this.router.use(hpp());
		} catch (error) {
			this.errorLogger.logError('Failed to initialize Helmet middleware');
			this.handleRouteError(error, {}, {}, {});
		}
	}
	asyncHandler = fn => {
		return (req, res, next) => {
			fn(req, res, next).catch(next);
		};
	};
	async shutdown() {
		try {
			this.logger.info('Shutting down Base Router...');
			this.logger.info('Clearing API Router cache...');
			await this.cacheService.clearNamespace('userLogin');
			await this.cacheService.clearNamespace('recoverPassword');
			await this.cacheService.clearNamespace('generateTOTP');
			await this.cacheService.clearNamespace('generateEmailMFA');
			this.logger.info('APIRouter cache cleared successfully.');
			this.logger.info('Clearing Static Router cache...');
			await this.cacheService.clearNamespace('static-files');
			this.logger.info('StaticRouter cache cleared successfully.');
			this.logger.info('Clearing Health Router cache...');
			await this.cacheService.clearNamespace('healthCheck');
			this.logger.info('HealthRouter cache cleared successfully.');
			if (
				this.envConfig.getFeatureFlags().loadTestRoutes &&
				this.envConfig.getEnvVariable('nodeEnv') !== 'production'
			) {
				this.logger.info('Clearing Test Router cache...');
				await this.cacheService.clearNamespace('test');
				this.logger.info('TestRouter cache cleared successfully.');
			}
			this.logger.info(
				'Base Router extension caches cleared. Completing shutdown process'
			);
			BaseRouter.instance = null;
			this.logger.info('Base Router shutdown complete.');
		} catch (error) {
			const utilityError =
				new this.errorHandler.ErrorClasses.UtilityErrorRecoverable(
					`Error during APIRouter shutdown: ${error instanceof Error ? error.message : error}`
				);
			this.errorLogger.logError(utilityError.message);
			this.errorHandler.handleError({ error: utilityError });
		}
	}
	handleRouteError(error, req, res, next) {
		const expressError = new this.errorHandler.ErrorClasses.ExpressError(
			`Route error: ${error instanceof Error ? error.message : 'Unknown error'}`,
			{ exposeToClient: false }
		);
		this.errorLogger.logError(expressError.message);
		this.errorHandler.expressErrorHandler()(expressError, req, res, next);
	}
	applyErrorHandler() {
		this.router.use((err, req, res, next) => {
			this.errorHandler.expressErrorHandler()(err, req, res, next);
		});
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmFzZVJvdXRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXJzL0Jhc2VSb3V0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxPQU1OLE1BQU0sU0FBUyxDQUFDO0FBQ2pCLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDeEMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQWFsRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDN0MsT0FBTyxXQUFXLE1BQU0sYUFBYSxDQUFDO0FBQ3RDLE9BQU8sR0FBRyxNQUFNLEtBQUssQ0FBQztBQUN0QixPQUFPLFFBQVEsTUFBTSxVQUFVLENBQUM7QUFDaEMsT0FBTyxHQUFHLE1BQU0sS0FBSyxDQUFDO0FBRXRCLE1BQU0sT0FBTyxVQUFVO0lBQ2QsTUFBTSxDQUFDLFFBQVEsR0FBc0IsSUFBSSxDQUFDO0lBRXhDLE1BQU0sQ0FBUztJQUVmLE1BQU0sQ0FBNEI7SUFDbEMsV0FBVyxDQUE4QjtJQUN6QyxZQUFZLENBQStCO0lBQzNDLFNBQVMsQ0FBNEI7SUFDckMsWUFBWSxDQUF3QjtJQUNwQyxpQkFBaUIsQ0FBNkI7SUFDOUMsYUFBYSxDQUFtQztJQUNoRCxhQUFhLENBQW9DO0lBQ2pELGtCQUFrQixDQUF5QztJQUUzRCxhQUFhLEdBQTJDLEVBQUUsQ0FBQztJQUMzRCxnQkFBZ0IsR0FBMkMsRUFBRSxD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LENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FDcEYsQ0FBQztZQUNILElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNoRCxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO1FBQ3hELENBQUM7SUFDRixDQUFDO0lBRVMsZ0JBQWdCLENBQ3pCLEtBQWMsRUFDZCxHQUFZLEVBQ1osR0FBYSxFQUNiLElBQWtCO1FBRWxCLE1BQU0sWUFBWSxHQUFHLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUNuRSxnQkFBZ0IsS0FBSyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsZUFBZSxFQUFFLEVBQzFFLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBRSxDQUN6QixDQUFDO1FBQ0YsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2hELElBQUksQ0FBQyxZQUFZLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxZQUFZLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN2RSxDQUFDO0lBRU8saUJBQWlCO1FBQ3hCLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUNkLENBQUMsR0FBWSxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0IsRUFBRSxFQUFFO1lBQ2pFLElBQUksQ0FBQyxZQUFZLENBQUMsbUJBQW1CLEVBQUUsQ0FDdEMsR0FBWSxFQUNaLEdBQUcsRUFDSCxHQUFHLEVBQ0gsSUFBSSxDQUNKLENBQUM7UUFDSCxDQUFDLENBQ0QsQ0FBQztJQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZXhwcmVzcywge1xuXHRBcHBsaWNhdGlvbixcblx0TmV4dEZ1bmN0aW9uLFxuXHRSZXF1ZXN0LFxuXHRSZXNwb25zZSxcblx0Um91dGVyXG59IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgQVBJUm91dGVyIH0gZnJvbSAnLi9BUElSb3V0ZXInO1xuaW1wb3J0IHsgSGVhbHRoUm91dGVyIH0gZnJvbSAnLi9IZWFsdGhSb3V0ZXInO1xuaW1wb3J0IHsgU3RhdGljUm91dGVyIH0gZnJvbSAnLi9TdGF0aWNSb3V0ZXInO1xuaW1wb3J0IHsgVGVzdFJvdXRlciB9IGZyb20gJy4vVGVzdFJvdXRlcic7XG5pbXBvcnQgeyBTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4uL2luZGV4L2ZhY3RvcnknO1xuaW1wb3J0IHtcblx0QXBwTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0QmFzZVJvdXRlckludGVyZmFjZSxcblx0Q2FjaGVTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFbnZDb25maWdTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRFcnJvckxvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdEdhdGVrZWVwZXJTZXJ2aWNlSW50ZXJmYWNlLFxuXHRIZWxtZXRNaWRkbGV3YXJlU2VydmljZUludGVyZmFjZSxcblx0SldUQXV0aE1pZGRsZXdhcmVTZXJ2aWNlSW50ZXJmYWNlLFxuXHRQYXNzcG9ydEF1dGhNaWRkbGV3YXJlU2VydmljZUludGVyZmFjZVxufSBmcm9tICcuLi9pbmRleC9pbnRlcmZhY2VzL3NlcnZpY2VzJztcbmltcG9ydCB7IHNhbml0aXplUmVxdWVzdEJvZHkgfSBmcm9tICcuLi91dGlscy92YWxpZGF0b3InO1xuaW1wb3J0IHsgdmFsaWRhdGVEZXBlbmRlbmNpZXMgfSBmcm9tICcuLi91dGlscy9oZWxwZXJzJztcbmltcG9ydCB7IHdpdGhSZXRyeSB9IGZyb20gJy4uL3V0aWxzL2hlbHBlcnMnO1xuaW1wb3J0IGNvbXByZXNzaW9uIGZyb20gJ2NvbXByZXNzaW9uJztcbmltcG9ydCBocHAgZnJvbSAnaHBwJztcbmltcG9ydCBwYXNzcG9ydCBmcm9tICdwYXNzcG9ydCc7XG5pbXBvcnQgeHNzIGZyb20gJ3hzcyc7XG5cbmV4cG9ydCBjbGFzcyBCYXNlUm91dGVyIGltcGxlbWVudHMgQmFzZVJvdXRlckludGVyZmFjZSB7XG5cdHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBCYXNlUm91dGVyIHwgbnVsbCA9IG51bGw7XG5cblx0cHJvdGVjdGVkIHJvdXRlcjogUm91dGVyO1xuXG5cdHByb3RlY3RlZCBsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByb3RlY3RlZCBlcnJvckxvZ2dlcjogRXJyb3JMb2dnZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcm90ZWN0ZWQgZXJyb3JIYW5kbGVyOiBFcnJvckhhbmRsZXJTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcm90ZWN0ZWQgZW52Q29uZmlnOiBFbnZDb25maWdTZXJ2aWNlSW50ZXJmYWNlO1xuXHRwcm90ZWN0ZWQgY2FjaGVTZXJ2aWNlOiBDYWNoZVNlcnZpY2VJbnRlcmZhY2U7XG5cdHByb3RlY3RlZCBnYXRla2VlcGVyU2VydmljZTogR2F0ZWtlZXBlclNlcnZpY2VJbnRlcmZhY2U7XG5cdHByb3RlY3RlZCBoZWxtZXRTZXJ2aWNlOiBIZWxtZXRNaWRkbGV3YXJlU2VydmljZUludGVyZmFjZTtcblx0cHJvdGVjdGVkIEpXVE1pZGRsZXdhcmU6IEpXVEF1dGhNaWRkbGV3YXJlU2VydmljZUludGVyZmFjZTtcblx0cHJvdGVjdGVkIHBhc3Nwb3J0TWlkZGxld2FyZTogUGFzc3BvcnRBdXRoTWlkZGxld2FyZVNlcnZpY2VJbnRlcmZhY2U7XG5cblx0cHJvdGVjdGVkIGFwaVJvdXRlVGFibGU6IFJlY29yZDxzdHJpbmcsIFJlY29yZDxzdHJpbmcsIHN0cmluZz4+ID0ge307XG5cdHByb3RlY3RlZCBoZWFsdGhSb3V0ZVRhYmxlOiBSZWNvcmQ8c3RyaW5nLCBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+PiA9IHt9O1xuXHRwcm90ZWN0ZWQgc3RhdGljUm91dGVUYWJsZTogUmVjb3JkPHN0cmluZywgUmVjb3JkPHN0cmluZywgc3RyaW5nPj4gPSB7fTtcblx0cHJvdGVjdGVkIHRlc3RSb3V0ZVRhYmxlOiBSZWNvcmQ8c3RyaW5nLCBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+PiA9IHt9O1xuXG5cdHByb3RlY3RlZCBjb25zdHJ1Y3Rvcihcblx0XHRsb2dnZXI6IEFwcExvZ2dlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0ZXJyb3JMb2dnZXI6IEVycm9yTG9nZ2VyU2VydmljZUludGVyZmFjZSxcblx0XHRlcnJvckhhbmRsZXI6IEVycm9ySGFuZGxlclNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0ZW52Q29uZmlnOiBFbnZDb25maWdTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGNhY2hlU2VydmljZTogQ2FjaGVTZXJ2aWNlSW50ZXJmYWNlLFxuXHRcdGdhdGVrZWVwZXJTZXJ2aWNlOiBHYXRla2VlcGVyU2VydmljZUludGVyZmFjZSxcblx0XHRoZWxtZXRTZXJ2aWNlOiBIZWxtZXRNaWRkbGV3YXJlU2VydmljZUludGVyZmFjZSxcblx0XHRKV1RNaWRkbGV3YXJlOiBKV1RBdXRoTWlkZGxld2FyZVNlcnZpY2VJbnRlcmZhY2UsXG5cdFx0cGFzc3BvcnRNaWRkbGV3YXJlOiBQYXNzcG9ydEF1dGhNaWRkbGV3YXJlU2VydmljZUludGVyZmFjZVxuXHQpIHtcblx0XHR0aGlzLnJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG5cdFx0dGhpcy5sb2dnZXIgPSBsb2dnZXI7XG5cdFx0dGhpcy5lcnJvckxvZ2dlciA9IGVycm9yTG9nZ2VyO1xuXHRcdHRoaXMuZXJyb3JIYW5kbGVyID0gZXJyb3JIYW5kbGVyO1xuXHRcdHRoaXMuZW52Q29uZmlnID0gZW52Q29uZmlnO1xuXHRcdHRoaXMuY2FjaGVTZXJ2aWNlID0gY2FjaGVTZXJ2aWNlO1xuXHRcdHRoaXMuZ2F0ZWtlZXBlclNlcnZpY2UgPSBnYXRla2VlcGVyU2VydmljZTtcblx0XHR0aGlzLmhlbG1ldFNlcnZpY2UgPSBoZWxtZXRTZXJ2aWNlO1xuXHRcdHRoaXMuSldUTWlkZGxld2FyZSA9IEpXVE1pZGRsZXdhcmU7XG5cdFx0dGhpcy5wYXNzcG9ydE1pZGRsZXdhcmUgPSBwYXNzcG9ydE1pZGRsZXdhcmU7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGFzeW5jIGdldEluc3RhbmNlKCk6IFByb21pc2U8QmFzZVJvdXRlcj4ge1xuXHRcdGlmICghQmFzZVJvdXRlci5pbnN0YW5jZSkge1xuXHRcdFx0QmFzZVJvdXRlci5pbnN0YW5jZSA9IG5ldyBCYXNlUm91dGVyKFxuXHRcdFx0XHRhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRMb2dnZXJTZXJ2aWNlKCksXG5cdFx0XHRcdGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldEVycm9yTG9nZ2VyU2VydmljZSgpLFxuXHRcdFx0XHRhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRFcnJvckhhbmRsZXJTZXJ2aWNlKCksXG5cdFx0XHRcdGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldEVudkNvbmZpZ1NlcnZpY2UoKSxcblx0XHRcdFx0YXdhaXQgU2VydmljZUZhY3RvcnkuZ2V0Q2FjaGVTZXJ2aWNlKCksXG5cdFx0XHRcdGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldEdhdGVrZWVwZXJTZXJ2aWNlKCksXG5cdFx0XHRcdGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldEhlbG1ldE1pZGRsZXdhcmVTZXJ2aWNlKCksXG5cdFx0XHRcdGF3YWl0IFNlcnZpY2VGYWN0b3J5LmdldEpXVEF1dGhNaWRkbGV3YXJlU2VydmljZSgpLFxuXHRcdFx0XHRhd2FpdCBTZXJ2aWNlRmFjdG9yeS5nZXRQYXNzcG9ydEF1dGhNaWRkbGV3YXJlU2VydmljZSgpXG5cdFx0XHQpO1xuXHRcdFx0YXdhaXQgQmFzZVJvdXRlci5pbnN0YW5jZS5pbml0aWFsaXplQmFzZVJvdXRlcigpO1xuXHRcdH1cblxuXHRcdHJldHVybiBCYXNlUm91dGVyLmluc3RhbmNlO1xuXHR9XG5cblx0cHVibGljIGdldFJvdXRlcigpOiBSb3V0ZXIge1xuXHRcdHJldHVybiB0aGlzLnJvdXRlcjtcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgaW5pdGlhbGl6ZUJhc2VSb3V0ZXIoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0YXdhaXQgd2l0aFJldHJ5KFxuXHRcdFx0YXN5bmMgKCkgPT4ge1xuXHRcdFx0XHR0aGlzLnJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG5cdFx0XHRcdGF3YWl0IHRoaXMubG9hZFJvdXRlVGFibGVzKCk7XG5cdFx0XHRcdGF3YWl0IHRoaXMuYXBwbHlNaWRkbGV3YXJlcygpO1xuXHRcdFx0XHR0aGlzLnNldFVwUm91dGVzKCk7XG5cdFx0XHR9LFxuXHRcdFx0MTAsXG5cdFx0XHQyNTAsXG5cdFx0XHR0cnVlXG5cdFx0KTtcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgbG9hZFJvdXRlVGFibGVzKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGNvbnN0IGFwaVJvdXRlVGFibGUgPSAoYXdhaXQgaW1wb3J0KCcuLi9jb25maWcvcm91dGVUYWJsZXMnKSlcblx0XHRcdC5hcGlSb3V0ZVRhYmxlO1xuXHRcdGNvbnN0IGhlYWx0aFJvdXRlcyA9IChhd2FpdCBpbXBvcnQoJy4uL2NvbmZpZy9yb3V0ZVRhYmxlcycpKVxuXHRcdFx0LmhlYWx0aFJvdXRlVGFibGU7XG5cdFx0Y29uc3Qgc3RhdGljUm91dGVzID0gKGF3YWl0IGltcG9ydCgnLi4vY29uZmlnL3JvdXRlVGFibGVzJykpXG5cdFx0XHQuc3RhdGljUm91dGVUYWJsZTtcblx0XHRjb25zdCB0ZXN0Um91dGVzID0gKGF3YWl0IGltcG9ydCgnLi4vY29uZmlnL3JvdXRlVGFibGVzJykpXG5cdFx0XHQudGVzdFJvdXRlVGFibGU7XG5cblx0XHR0aGlzLmFwaVJvdXRlVGFibGUgPSBhcGlSb3V0ZVRhYmxlO1xuXHRcdHRoaXMuaGVhbHRoUm91dGVUYWJsZSA9IGhlYWx0aFJvdXRlcztcblx0XHR0aGlzLnN0YXRpY1JvdXRlVGFibGUgPSBzdGF0aWNSb3V0ZXM7XG5cdFx0dGhpcy50ZXN0Um91dGVUYWJsZSA9IHRlc3RSb3V0ZXM7XG5cdH1cblxuXHRwcml2YXRlIHNldFVwUm91dGVzKCk6IHZvaWQge1xuXHRcdHRoaXMucm91dGVyLmFsbCgnKicsIHRoaXMuYXN5bmNIYW5kbGVyKHRoaXMucm91dGVIYW5kbGVyLmJpbmQodGhpcykpKTtcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgcm91dGVIYW5kbGVyKFxuXHRcdHJlcTogUmVxdWVzdCxcblx0XHRyZXM6IFJlc3BvbnNlLFxuXHRcdG5leHQ6IE5leHRGdW5jdGlvblxuXHQpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRjb25zdCBtZXRob2QgPSByZXEubWV0aG9kO1xuXHRcdGNvbnN0IHBhdGggPSByZXEucGF0aDtcblx0XHR0cnkge1xuXHRcdFx0aWYgKFxuXHRcdFx0XHR0aGlzLnN0YXRpY1JvdXRlVGFibGVbcGF0aF0gJiZcblx0XHRcdFx0dGhpcy5zdGF0aWNSb3V0ZVRhYmxlW3BhdGhdW21ldGhvZF1cblx0XHRcdCkge1xuXHRcdFx0XHRyZXR1cm4gYXdhaXQgdGhpcy5oYW5kbGVSb3V0ZShcblx0XHRcdFx0XHR0aGlzLnN0YXRpY1JvdXRlVGFibGVbcGF0aF1bbWV0aG9kXSxcblx0XHRcdFx0XHRyZXEsXG5cdFx0XHRcdFx0cmVzLFxuXHRcdFx0XHRcdG5leHRcblx0XHRcdFx0KTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKHRoaXMuYXBpUm91dGVUYWJsZVtwYXRoXSAmJiB0aGlzLmFwaVJvdXRlVGFibGVbcGF0aF1bbWV0aG9kXSkge1xuXHRcdFx0XHRyZXR1cm4gYXdhaXQgdGhpcy5oYW5kbGVSb3V0ZShcblx0XHRcdFx0XHR0aGlzLmFwaVJvdXRlVGFibGVbcGF0aF1bbWV0aG9kXSxcblx0XHRcdFx0XHRyZXEsXG5cdFx0XHRcdFx0cmVzLFxuXHRcdFx0XHRcdG5leHRcblx0XHRcdFx0KTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKFxuXHRcdFx0XHR0aGlzLmhlYWx0aFJvdXRlVGFibGVbcGF0aF0gJiZcblx0XHRcdFx0dGhpcy5oZWFsdGhSb3V0ZVRhYmxlW3BhdGhdW21ldGhvZF1cblx0XHRcdCkge1xuXHRcdFx0XHRyZXR1cm4gYXdhaXQgdGhpcy5oYW5kbGVSb3V0ZShcblx0XHRcdFx0XHR0aGlzLmhlYWx0aFJvdXRlVGFibGVbcGF0aF1bbWV0aG9kXSxcblx0XHRcdFx0XHRyZXEsXG5cdFx0XHRcdFx0cmVzLFxuXHRcdFx0XHRcdG5leHRcblx0XHRcdFx0KTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKFxuXHRcdFx0XHR0aGlzLnRlc3RSb3V0ZVRhYmxlW3BhdGhdICYmXG5cdFx0XHRcdHRoaXMudGVzdFJvdXRlVGFibGVbcGF0aF1bbWV0aG9kXSAmJlxuXHRcdFx0XHR0aGlzLmVudkNvbmZpZy5nZXRGZWF0dXJlRmxhZ3MoKS5sb2FkVGVzdFJvdXRlc1xuXHRcdFx0KSB7XG5cdFx0XHRcdHJldHVybiBhd2FpdCB0aGlzLmhhbmRsZVJvdXRlKFxuXHRcdFx0XHRcdHRoaXMudGVzdFJvdXRlVGFibGVbcGF0aF1bbWV0aG9kXSxcblx0XHRcdFx0XHRyZXEsXG5cdFx0XHRcdFx0cmVzLFxuXHRcdFx0XHRcdG5leHRcblx0XHRcdFx0KTtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3Qgc3RhdGljUm91dGVySW5zdGFuY2UgPVxuXHRcdFx0XHQoYXdhaXQgU3RhdGljUm91dGVyLmdldEluc3RhbmNlKCkpIGFzIFN0YXRpY1JvdXRlcjtcblx0XHRcdGF3YWl0IHN0YXRpY1JvdXRlckluc3RhbmNlLnNlcnZlTm90Rm91bmRQYWdlKHJlcSwgcmVzLCBuZXh0KTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5oYW5kbGVSb3V0ZUVycm9yKGVycm9yLCByZXEsIHJlcywgbmV4dCk7XG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBoYW5kbGVSb3V0ZShcblx0XHRyb3V0ZXJOYW1lOiBzdHJpbmcsXG5cdFx0cmVxOiBSZXF1ZXN0LFxuXHRcdHJlczogUmVzcG9uc2UsXG5cdFx0bmV4dDogTmV4dEZ1bmN0aW9uXG5cdCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGF3YWl0IHdpdGhSZXRyeShcblx0XHRcdGFzeW5jICgpID0+IHtcblx0XHRcdFx0c3dpdGNoIChyb3V0ZXJOYW1lKSB7XG5cdFx0XHRcdFx0Y2FzZSAnc3RhdGljUm91dGVyJzpcblx0XHRcdFx0XHRcdChhd2FpdCBTdGF0aWNSb3V0ZXIuZ2V0SW5zdGFuY2UoKSkuZ2V0Um91dGVyKCkoXG5cdFx0XHRcdFx0XHRcdHJlcSxcblx0XHRcdFx0XHRcdFx0cmVzLFxuXHRcdFx0XHRcdFx0XHRuZXh0XG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0Y2FzZSAnYXBpUm91dGVyJzpcblx0XHRcdFx0XHRcdChhd2FpdCBBUElSb3V0ZXIuZ2V0SW5zdGFuY2UoKSkuZ2V0Um91dGVyKCkoXG5cdFx0XHRcdFx0XHRcdHJlcSxcblx0XHRcdFx0XHRcdFx0cmVzLFxuXHRcdFx0XHRcdFx0XHRuZXh0XG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0Y2FzZSAnaGVhbHRoUm91dGVyJzpcblx0XHRcdFx0XHRcdChhd2FpdCBIZWFsdGhSb3V0ZXIuZ2V0SW5zdGFuY2UoKSkuZ2V0Um91dGVyKCkoXG5cdFx0XHRcdFx0XHRcdHJlcSxcblx0XHRcdFx0XHRcdFx0cmVzLFxuXHRcdFx0XHRcdFx0XHRuZXh0XG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0Y2FzZSAndGVzdFJvdXRlcic6XG5cdFx0XHRcdFx0XHQoYXdhaXQgVGVzdFJvdXRlci5nZXRJbnN0YW5jZSgpKS5nZXRSb3V0ZXIoKShcblx0XHRcdFx0XHRcdFx0cmVxLFxuXHRcdFx0XHRcdFx0XHRyZXMsXG5cdFx0XHRcdFx0XHRcdG5leHRcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRcdFx0cmVzLnN0YXR1cyg1MDApLmpzb24oe1xuXHRcdFx0XHRcdFx0XHRtZXNzYWdlOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJ1xuXHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRuZXh0KCk7XG5cdFx0XHRcdH1cblx0XHRcdH0sXG5cdFx0XHQ1LFxuXHRcdFx0MjUwLFxuXHRcdFx0dHJ1ZVxuXHRcdCkuY2F0Y2goZXJyb3IgPT4ge1xuXHRcdFx0dGhpcy5sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBoYW5kbGUgcm91dGU6ICR7ZXJyb3J9YCk7XG5cdFx0XHRyZXMuc3RhdHVzKDUwMCkuanNvbih7XG5cdFx0XHRcdG1lc3NhZ2U6ICdGYWlsZWQgdG8gaGFuZGxlIHJvdXRlIGFmdGVyIG11bHRpcGxlIGF0dGVtcHRzJ1xuXHRcdFx0fSk7XG5cdFx0XHRuZXh0KCk7XG5cdFx0fSk7XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIGFwcGx5TWlkZGxld2FyZXMoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgYXBwID0gZXhwcmVzcygpO1xuXG5cdFx0dGhpcy5hcHBseUVycm9ySGFuZGxlcigpO1xuXHRcdHRoaXMuYXBwbHlTYW5pdGl6YXRpb24oKTtcblx0XHR0aGlzLmFwcGx5R2F0ZWtlZXBlcigpO1xuXHRcdHRoaXMuYXBwbHlTZWN1cml0eUhlYWRlcnMoYXBwKTtcblx0XHR0aGlzLmFwcGx5Q29tcHJlc3Npb24oKTtcblx0XHR0aGlzLmFwcGx5UGFzc3BvcnRBbmRKV1RBdXRoKCk7XG5cdH1cblxuXHRwcml2YXRlIGFwcGx5Q29tcHJlc3Npb24oKTogdm9pZCB7XG5cdFx0dGhpcy5yb3V0ZXIudXNlKGNvbXByZXNzaW9uKCkpO1xuXHR9XG5cblx0cHJpdmF0ZSBhcHBseUdhdGVrZWVwZXIoKTogdm9pZCB7XG5cdFx0dGhpcy5yb3V0ZXIudXNlKHRoaXMuZ2F0ZWtlZXBlclNlcnZpY2UucmF0ZUxpbWl0TWlkZGxld2FyZSgpKTtcblx0XHR0aGlzLnJvdXRlci51c2UodGhpcy5nYXRla2VlcGVyU2VydmljZS5zbG93ZG93bk1pZGRsZXdhcmUoKSk7XG5cdFx0dGhpcy5yb3V0ZXIudXNlKHRoaXMuZ2F0ZWtlZXBlclNlcnZpY2UuaXBCbGFja2xpc3RNaWRkbGV3YXJlKCkpO1xuXHR9XG5cblx0cHJpdmF0ZSBhcHBseVBhc3Nwb3J0QW5kSldUQXV0aCgpOiB2b2lkIHtcblx0XHR0aGlzLnJvdXRlci51c2UoXG5cdFx0XHR0aGlzLmFzeW5jSGFuZGxlcihhc3luYyAocmVxLCByZXMsIG5leHQpID0+IHtcblx0XHRcdFx0Y29uc3QgcGFzc3BvcnREZXBzID0ge1xuXHRcdFx0XHRcdHBhc3Nwb3J0LFxuXHRcdFx0XHRcdGF1dGhlbnRpY2F0ZU9wdGlvbnM6IHsgc2Vzc2lvbjogZmFsc2UgfSxcblx0XHRcdFx0XHR2YWxpZGF0ZURlcGVuZGVuY2llc1xuXHRcdFx0XHR9O1xuXG5cdFx0XHRcdHRoaXMucGFzc3BvcnRNaWRkbGV3YXJlLmluaXRpYWxpemVQYXNzcG9ydEF1dGhNaWRkbGV3YXJlKFxuXHRcdFx0XHRcdHBhc3Nwb3J0RGVwc1xuXHRcdFx0XHQpO1xuXHRcdFx0XHRwYXNzcG9ydC5zZXNzaW9uKCk7XG5cdFx0XHRcdHRoaXMuSldUTWlkZGxld2FyZS5pbml0aWFsaXplSldUQXV0aE1pZGRsZXdhcmUoKTtcblx0XHRcdFx0bmV4dCgpO1xuXHRcdFx0fSlcblx0XHQpO1xuXHR9XG5cblx0cHJpdmF0ZSBhcHBseVNhbml0aXphdGlvbigpOiB2b2lkIHtcblx0XHR0aGlzLnJvdXRlci51c2UoXG5cdFx0XHR0aGlzLmFzeW5jSGFuZGxlcihcblx0XHRcdFx0YXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG5cdFx0XHRcdFx0cmVxLmJvZHkgPSBhd2FpdCBzYW5pdGl6ZVJlcXVlc3RCb2R5KHJlcS5ib2R5KTtcblxuXHRcdFx0XHRcdGZvciAoY29uc3Qga2V5IGluIHJlcS5xdWVyeSkge1xuXHRcdFx0XHRcdFx0aWYgKHJlcS5xdWVyeS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG5cdFx0XHRcdFx0XHRcdHJlcS5xdWVyeVtrZXldID0geHNzKHJlcS5xdWVyeVtrZXldIGFzIHN0cmluZyk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0Zm9yIChjb25zdCBrZXkgaW4gcmVxLnBhcmFtcykge1xuXHRcdFx0XHRcdFx0aWYgKHJlcS5wYXJhbXMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuXHRcdFx0XHRcdFx0XHRyZXEucGFyYW1zW2tleV0gPSB4c3MocmVxLnBhcmFtc1trZXldKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRuZXh0KCk7XG5cdFx0XHRcdH1cblx0XHRcdClcblx0XHQpO1xuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBhcHBseVNlY3VyaXR5SGVhZGVycyhhcHA6IEFwcGxpY2F0aW9uKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGF3YWl0IHdpdGhSZXRyeShcblx0XHRcdFx0KCkgPT4gdGhpcy5oZWxtZXRTZXJ2aWNlLmluaXRpYWxpemVIZWxtZXRNaWRkbGV3YXJlKGFwcCksXG5cdFx0XHRcdDMsXG5cdFx0XHRcdDEwMDBcblx0XHRcdCk7XG5cdFx0XHR0aGlzLnJvdXRlci51c2UoaHBwKCkpO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKCdGYWlsZWQgdG8gaW5pdGlhbGl6ZSBIZWxtZXQgbWlkZGxld2FyZScpO1xuXHRcdFx0dGhpcy5oYW5kbGVSb3V0ZUVycm9yKFxuXHRcdFx0XHRlcnJvcixcblx0XHRcdFx0e30gYXMgUmVxdWVzdCxcblx0XHRcdFx0e30gYXMgUmVzcG9uc2UsXG5cdFx0XHRcdHt9IGFzIE5leHRGdW5jdGlvblxuXHRcdFx0KTtcblx0XHR9XG5cdH1cblxuXHRwcm90ZWN0ZWQgYXN5bmNIYW5kbGVyID0gKFxuXHRcdGZuOiAoXG5cdFx0XHRyZXE6IFJlcXVlc3QsXG5cdFx0XHRyZXM6IFJlc3BvbnNlLFxuXHRcdFx0bmV4dDogTmV4dEZ1bmN0aW9uXG5cdFx0KSA9PiBQcm9taXNlPHZvaWQgfCBSZXNwb25zZT5cblx0KTogKChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4gdm9pZCkgPT4ge1xuXHRcdHJldHVybiAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcblx0XHRcdGZuKHJlcSwgcmVzLCBuZXh0KS5jYXRjaChuZXh0KTtcblx0XHR9O1xuXHR9O1xuXG5cdHB1YmxpYyBhc3luYyBzaHV0ZG93bigpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHR0cnkge1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnU2h1dHRpbmcgZG93biBCYXNlIFJvdXRlci4uLicpO1xuXG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdDbGVhcmluZyBBUEkgUm91dGVyIGNhY2hlLi4uJyk7XG5cdFx0XHRhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5jbGVhck5hbWVzcGFjZSgndXNlckxvZ2luJyk7XG5cdFx0XHRhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5jbGVhck5hbWVzcGFjZSgncmVjb3ZlclBhc3N3b3JkJyk7XG5cdFx0XHRhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5jbGVhck5hbWVzcGFjZSgnZ2VuZXJhdGVUT1RQJyk7XG5cdFx0XHRhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5jbGVhck5hbWVzcGFjZSgnZ2VuZXJhdGVFbWFpbE1GQScpO1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnQVBJUm91dGVyIGNhY2hlIGNsZWFyZWQgc3VjY2Vzc2Z1bGx5LicpO1xuXG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdDbGVhcmluZyBTdGF0aWMgUm91dGVyIGNhY2hlLi4uJyk7XG5cdFx0XHRhd2FpdCB0aGlzLmNhY2hlU2VydmljZS5jbGVhck5hbWVzcGFjZSgnc3RhdGljLWZpbGVzJyk7XG5cdFx0XHR0aGlzLmxvZ2dlci5pbmZvKCdTdGF0aWNSb3V0ZXIgY2FjaGUgY2xlYXJlZCBzdWNjZXNzZnVsbHkuJyk7XG5cblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ0NsZWFyaW5nIEhlYWx0aCBSb3V0ZXIgY2FjaGUuLi4nKTtcblx0XHRcdGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLmNsZWFyTmFtZXNwYWNlKCdoZWFsdGhDaGVjaycpO1xuXHRcdFx0dGhpcy5sb2dnZXIuaW5mbygnSGVhbHRoUm91dGVyIGNhY2hlIGNsZWFyZWQgc3VjY2Vzc2Z1bGx5LicpO1xuXG5cdFx0XHRpZiAoXG5cdFx0XHRcdHRoaXMuZW52Q29uZmlnLmdldEZlYXR1cmVGbGFncygpLmxvYWRUZXN0Um91dGVzICYmXG5cdFx0XHRcdHRoaXMuZW52Q29uZmlnLmdldEVudlZhcmlhYmxlKCdub2RlRW52JykgIT09ICdwcm9kdWN0aW9uJ1xuXHRcdFx0KSB7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ0NsZWFyaW5nIFRlc3QgUm91dGVyIGNhY2hlLi4uJyk7XG5cdFx0XHRcdGF3YWl0IHRoaXMuY2FjaGVTZXJ2aWNlLmNsZWFyTmFtZXNwYWNlKCd0ZXN0Jyk7XG5cdFx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ1Rlc3RSb3V0ZXIgY2FjaGUgY2xlYXJlZCBzdWNjZXNzZnVsbHkuJyk7XG5cdFx0XHR9XG5cblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oXG5cdFx0XHRcdCdCYXNlIFJvdXRlciBleHRlbnNpb24gY2FjaGVzIGNsZWFyZWQuIENvbXBsZXRpbmcgc2h1dGRvd24gcHJvY2Vzcydcblx0XHRcdCk7XG5cdFx0XHRCYXNlUm91dGVyLmluc3RhbmNlID0gbnVsbDtcblx0XHRcdHRoaXMubG9nZ2VyLmluZm8oJ0Jhc2UgUm91dGVyIHNodXRkb3duIGNvbXBsZXRlLicpO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHRjb25zdCB1dGlsaXR5RXJyb3IgPVxuXHRcdFx0XHRuZXcgdGhpcy5lcnJvckhhbmRsZXIuRXJyb3JDbGFzc2VzLlV0aWxpdHlFcnJvclJlY292ZXJhYmxlKFxuXHRcdFx0XHRcdGBFcnJvciBkdXJpbmcgQVBJUm91dGVyIHNodXRkb3duOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogZXJyb3J9YFxuXHRcdFx0XHQpO1xuXHRcdFx0dGhpcy5lcnJvckxvZ2dlci5sb2dFcnJvcih1dGlsaXR5RXJyb3IubWVzc2FnZSk7XG5cdFx0XHR0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcih7IGVycm9yOiB1dGlsaXR5RXJyb3IgfSk7XG5cdFx0fVxuXHR9XG5cblx0cHJvdGVjdGVkIGhhbmRsZVJvdXRlRXJyb3IoXG5cdFx0ZXJyb3I6IHVua25vd24sXG5cdFx0cmVxOiBSZXF1ZXN0LFxuXHRcdHJlczogUmVzcG9uc2UsXG5cdFx0bmV4dDogTmV4dEZ1bmN0aW9uXG5cdCk6IHZvaWQge1xuXHRcdGNvbnN0IGV4cHJlc3NFcnJvciA9IG5ldyB0aGlzLmVycm9ySGFuZGxlci5FcnJvckNsYXNzZXMuRXhwcmVzc0Vycm9yKFxuXHRcdFx0YFJvdXRlIGVycm9yOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InfWAsXG5cdFx0XHR7IGV4cG9zZVRvQ2xpZW50OiBmYWxzZSB9XG5cdFx0KTtcblx0XHR0aGlzLmVycm9yTG9nZ2VyLmxvZ0Vycm9yKGV4cHJlc3NFcnJvci5tZXNzYWdlKTtcblx0XHR0aGlzLmVycm9ySGFuZGxlci5leHByZXNzRXJyb3JIYW5kbGVyKCkoZXhwcmVzc0Vycm9yLCByZXEsIHJlcywgbmV4dCk7XG5cdH1cblxuXHRwcml2YXRlIGFwcGx5RXJyb3JIYW5kbGVyKCk6IHZvaWQge1xuXHRcdHRoaXMucm91dGVyLnVzZShcblx0XHRcdChlcnI6IHVua25vd24sIHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG5cdFx0XHRcdHRoaXMuZXJyb3JIYW5kbGVyLmV4cHJlc3NFcnJvckhhbmRsZXIoKShcblx0XHRcdFx0XHRlcnIgYXMgRXJyb3IsXG5cdFx0XHRcdFx0cmVxLFxuXHRcdFx0XHRcdHJlcyxcblx0XHRcdFx0XHRuZXh0XG5cdFx0XHRcdCk7XG5cdFx0XHR9XG5cdFx0KTtcblx0fVxufVxuIl19
