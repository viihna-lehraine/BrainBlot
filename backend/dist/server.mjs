import argon2 from 'argon2';
import { execSync } from 'child_process';
import RedisStore from 'connect-redis';
import cookieParser from 'cookie-parser';
import cors from 'cors';
import { constants, randomBytes } from 'crypto';
import csrf from 'csrf';
import express from 'express';
import session from 'express-session';
import * as fs from 'fs';
import * as fsPromises from 'fs/promises';
import gracefulShutdown from 'http-graceful-shutdown';
import hpp from 'hpp';
import https from 'https';
import morgan from 'morgan';
import passport from 'passport';
import os from 'os';
import path, { dirname } from 'path';
import { fileURLToPath } from 'url';
import { initializeApp } from './config/app.mjs';
import { getSequelizeInstance, initializeDatabase } from './config/db.mjs';
import { getFeatureFlags } from './config/featureFlags.mjs';
import { setupHttp } from './config/http.mjs';
import setupLogger from './config/logger.mjs';
import configurePassport from './config/passport.mjs';
import { getRedisClient } from './config/redis.mjs';
import { startServer } from './config/startServer.mjs';
import { createCsrfMiddleware } from './middleware/csrf.mjs';
import errorHandler from './middleware/errorHandler.mjs';
import { createIpBlacklist } from './middleware/ipBlacklist.mjs';
import { rateLimitMiddleware } from './middleware/rateLimit.mjs';
import { setupSecurityHeaders } from './middleware/securityHeaders.mjs';
import { initializeModels } from './models/ModelsIndex.mjs';
import createUserModel from './models/User.mjs';
import { initializeStaticRoutes } from './routes/staticRoutes.mjs';
import createTestRouter from './routes/testRoutes.mjs';
import { loadEnv } from './utils/loadEnv.mjs';
import { createMemoryMonitor } from './utils/memoryMonitor.mjs';
import sops from './utils/sops.mjs';
loadEnv({ logger: setupLogger() });
const logger = setupLogger();
const featureFlags = getFeatureFlags(logger);
const csrfProtection = new csrf();
const testRouter = createTestRouter({ logger });
const NODE_ENV = process.env.NODE_ENV;
const SSL_FLAG = featureFlags.enableSslFlag;
const REDIS_FLAG = featureFlags.enableRedisFlag;
const SERVER_PORT = Number(process.env.SERVER_PORT) || 3000;
const staticRootPath = process.env.STATIC_ROOT_PATH;
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
try {
	logger.info('Logger is working');
	logger.info('Environment Variables:', {
		NODE_ENV: process.env.NODE_ENV,
		SERVER_PORT: parseInt(process.env.SERVER_PORT || '3000', 10),
		EMAIL_USER: process.env.EMAIL_USER,
		BACKEND_LOG_EXPORT_PATH: process.env.BACKEND_LOG_EXPORT_PATH,
		STATIC_ROOT_PATH: process.env.STATIC_ROOT_PATH,
		FRONTEND_APP_JS_PATH: process.env.FRONTEND_APP_JS_PATH,
		FRONTEND_BROWSER_CONFIG_XML_PATH:
			process.env.FRONTEND_BROWSER_CONFIG_XML_PATH,
		FRONTEND_CSS_PATH: process.env.FRONTEND_CSS_PATH,
		FRONTEND_FONTS_PATH: process.env.FRONTEND_FONTS_PATH,
		FRONTEND_HUMANS_MD_PATH: process.env.FRONTEND_HUMANS_MD_PATH,
		FRONTEND_ICONS_PATH: process.env.FRONTEND_ICONS_PATH,
		FRONTEND_IMAGES_PATH: process.env.FRONTEND_IMAGES_PATH,
		FRONTEND_JS_PATH: process.env.FRONTEND_JS_PATH,
		FRONTEND_KEYS_PATH: process.env.FRONTEND_KEYS_PATH,
		FRONTEND_LOGOS_PATH: process.env.FRONTEND_LOGOS_PATH,
		FRONTEND_ROBOTS_TXT_PATH: process.env.FRONTEND_ROBOTS_TXT_PATH,
		FRONTEND_SECURITY_MD_PATH: process.env.FRONTEND_SECURITY_MD_PATH,
		FRONTEND_SECRETS_PATH: process.env.FRONTEND_SECRETS_PATH,
		FRONTEND_SITEMAP_XML_PATH: process.env.FRONTEND_SITEMAP_XML_PATH,
		SERVER_DATA_FILE_PATH_1: process.env.SERVER_DATA_FILE_PATH_1,
		SERVER_DATA_FILE_PATH_2: process.env.SERVER_DATA_FILE_PATH_2,
		SERVER_DATA_FILE_PATH_3: process.env.SERVER_DATA_FILE_PATH_3,
		SERVER_DATA_FILE_PATH_4: process.env.SERVER_DATA_FILE_PATH_4,
		SERVER_LOG_PATH: process.env.SERVER_LOG_PATH,
		SERVER_NPM_LOG_PATH: process.env.SERVER_NPM_LOG_PATH,
		SERVER_SSL_KEY_PATH: process.env.SERVER_SSL_KEY_PATH,
		SERVER_SSL_CERT_PATH: process.env.SERVER_SSL_CERT_PATH,
		FEATURE_API_ROUTES_CSRF: process.env.FEATURE_API_ROUTES_CSRF,
		FEATURE_DB_SYNC: process.env.FEATURE_DB_SYNC,
		FEATURE_HTTPS_REDIRECT: process.env.FEATURE_HTTPS_REDIRECT,
		FEATURE_IP_BLACKLIST: process.env.FEATURE_IP_BLACKLIST,
		FEATURE_LOAD_STATIC_ROUTES: process.env.FEATURE_LOAD_STATIC_ROUTES,
		FEATURE_LOAD_TEST_ROUTES: process.env.FEATURE_LOAD_TEST_ROUTES,
		FEATURE_SECURE_HEADERS: process.env.FEATURE_SECURE_HEADERS,
		FEATURE_SEQUELIZE_LOGGING: process.env.FEATURE_SEQUELIZE_LOGGING,
		LOGGER: parseInt(process.env.LOGGER || '1', 10),
		YUBICO_API_URL: process.env.YUBICO_API_URL
	});
	logger.info('Initializing database');
	const sequelize = await initializeDatabase({
		logger,
		getFeatureFlags,
		getSecrets: () =>
			sops.getSecrets({
				logger,
				execSync,
				getDirectoryPath: () => process.cwd()
			})
	});
	logger.info('Initializing models');
	initializeModels(sequelize);
	logger.info('Initializing passport');
	const UserModel = createUserModel(sequelize);
	await configurePassport({
		passport,
		logger,
		getSecrets: () =>
			sops.getSecrets({
				logger,
				execSync,
				getDirectoryPath: () => process.cwd()
			}),
		UserModel,
		argon2
	});
	logger.info('Initializing IP blacklist');
	const ipBlacklist = createIpBlacklist({
		logger,
		featureFlags,
		__dirname,
		fsModule: fs
	});
	await ipBlacklist.initializeBlacklist();
	const csrfMiddleware = createCsrfMiddleware({
		featureFlags,
		logger,
		csrfProtection
	});
	const { startMemoryMonitor } = createMemoryMonitor({
		logger,
		os,
		process,
		setInterval
	});
	logger.info('Initializing app');
	const app = await initializeApp({
		express,
		session,
		cookieParser,
		cors,
		hpp,
		morgan,
		passport,
		randomBytes,
		path,
		RedisStore,
		initializeStaticRoutes,
		csrfMiddleware,
		errorHandler,
		getRedisClient,
		ipBlacklistMiddleware: ipBlacklist.ipBlacklistMiddleware,
		createTestRouter: app => app.use(testRouter),
		rateLimitMiddleware,
		setupSecurityHeaders,
		startMemoryMonitor,
		logger,
		staticRootPath,
		NODE_ENV,
		SSL_FLAG,
		REDIS_FLAG
	});
	const dbSyncFlag = featureFlags?.dbSyncFlag ?? false;
	if (dbSyncFlag) {
		logger.info('Testing database connection and syncing models');
		const sequelize = getSequelizeInstance({ logger });
		try {
			await sequelize.sync();
			logger.info('Database and tables created!');
		} catch (err) {
			logger.error(
				'Database Connection Test and Sync: Server error:',
				err
			);
			process.exit(1);
		}
	}
	// Setup HTTP/HTTPS server
	const { options } = await setupHttp({
		app,
		sops,
		fs: fsPromises,
		logger,
		constants,
		getFeatureFlags: () => getFeatureFlags(logger),
		getRedisClient,
		getSequelizeInstance: () => getSequelizeInstance({ logger }),
		initializeDatabase: async () =>
			initializeDatabase({
				logger,
				getFeatureFlags: () => getFeatureFlags(logger),
				getSecrets: () =>
					sops.getSecrets({
						logger,
						execSync,
						getDirectoryPath: () => process.cwd()
					})
			}),
		SERVER_PORT,
		SSL_FLAG: featureFlags.enableSslFlag,
		REDIS_FLAG: featureFlags.enableRedisFlag
	});
	// Start server with appropriate options
	try {
		logger.info(`Starting HTTP server on port ${SERVER_PORT}`);
		logger.info('Initializing database before starting server.');
		const sequelize = getSequelizeInstance({ logger });
		await sequelize.authenticate();
		logger.info('Database connection has been established successfully.');
		let server;
		if (SSL_FLAG && options) {
			server = https
				.createServer(options, app)
				.listen(SERVER_PORT, () => {
					logger.info(`HTTPS server running on port ${SERVER_PORT}`);
				});
		} else {
			server = app.listen(SERVER_PORT, () => {
				logger.info(`HTTP server running on port ${SERVER_PORT}`);
			});
		}
		gracefulShutdown(server, {
			signals: 'SIGINT SIGTERM',
			timeout: 30000,
			development: false,
			onShutdown: async () => {
				try {
					await sequelize.close();
					logger.info('Database connection closed');
					if (REDIS_FLAG) {
						const redisClient = getRedisClient();
						if (redisClient) {
							await redisClient.quit();
							logger.info('Redis connection closed');
						}
					}
					logger.close();
					console.log('Logger closed');
				} catch (error) {
					logger.error(`Error during shutdown: ${error}`);
				}
			},
			finally: () => console.log('Server has gracefully shut down')
		});
	} catch (error) {
		logger.error(`Failed to start server: ${error}`);
		process.exit(1);
	}
} catch (err) {
	logger.error('Unhandled error during server initialization:', err);
	process.exit(1);
}
export default startServer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3NlcnZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLE1BQU0sTUFBTSxRQUFRLENBQUM7QUFDNUIsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLFVBQVUsTUFBTSxlQUFlLENBQUM7QUFDdkMsT0FBTyxZQUFZLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUN4QixPQUFPLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUNoRCxPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxPQUFPLE1BQU0sU0FBUyxDQUFDO0FBQzlCLE9BQU8sT0FBTyxNQUFNLGlCQUFpQixDQUFDO0FBQ3RDLE9BQU8sS0FBSyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3pCLE9BQU8sS0FBSyxVQUFVLE1BQU0sYUFBYSxDQUFDO0FBQzFDLE9BQU8sZ0JBQWdCLE1BQU0sd0JBQXdCLENBQUM7QUFDdEQsT0FBTyxHQUFHLE1BQU0sS0FBSyxDQUFDO0FBQ3RCLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMxQixPQUFPLE1BQU0sTUFBTSxRQUFRLENBQUM7QUFDNUIsT0FBTyxRQUFRLE1BQU0sVUFBVSxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQztBQUNwQixPQUFPLElBQUksRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUVyQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sS0FBSyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDN0MsT0FBTyxFQUFFLG9CQUFvQixFQUFFLGtCQUFrQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3ZFLE9BQU8sRUFBZ0IsZUFBZSxFQUFFLE1BQU0sdUJBQXVC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bjIgZnJvbSAnYXJnb24yJztcbmltcG9ydCB7IGV4ZWNTeW5jIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgUmVkaXNTdG9yZSBmcm9tICdjb25uZWN0LXJlZGlzJztcbmltcG9ydCBjb29raWVQYXJzZXIgZnJvbSAnY29va2llLXBhcnNlcic7XG5pbXBvcnQgY29ycyBmcm9tICdjb3JzJztcbmltcG9ydCB7IGNvbnN0YW50cywgcmFuZG9tQnl0ZXMgfSBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IGNzcmYgZnJvbSAnY3NyZic7XG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCBzZXNzaW9uIGZyb20gJ2V4cHJlc3Mtc2Vzc2lvbic7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBmc1Byb21pc2VzIGZyb20gJ2ZzL3Byb21pc2VzJztcbmltcG9ydCBncmFjZWZ1bFNodXRkb3duIGZyb20gJ2h0dHAtZ3JhY2VmdWwtc2h1dGRvd24nO1xuaW1wb3J0IGhwcCBmcm9tICdocHAnO1xuaW1wb3J0IGh0dHBzIGZyb20gJ2h0dHBzJztcbmltcG9ydCBtb3JnYW4gZnJvbSAnbW9yZ2FuJztcbmltcG9ydCBwYXNzcG9ydCBmcm9tICdwYXNzcG9ydCc7XG5pbXBvcnQgb3MgZnJvbSAnb3MnO1xuaW1wb3J0IHBhdGgsIHsgZGlybmFtZSB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgU2VxdWVsaXplIH0gZnJvbSAnc2VxdWVsaXplJztcbmltcG9ydCB7IGZpbGVVUkxUb1BhdGggfSBmcm9tICd1cmwnO1xuaW1wb3J0IHsgaW5pdGlhbGl6ZUFwcCB9IGZyb20gJy4vY29uZmlnL2FwcCc7XG5pbXBvcnQgeyBnZXRTZXF1ZWxpemVJbnN0YW5jZSwgaW5pdGlhbGl6ZURhdGFiYXNlIH0gZnJvbSAnLi9jb25maWcvZGInO1xuaW1wb3J0IHsgRmVhdHVyZUZsYWdzLCBnZXRGZWF0dXJlRmxhZ3MgfSBmcm9tICcuL2NvbmZpZy9mZWF0dXJlRmxhZ3MnO1xuaW1wb3J0IHsgc2V0dXBIdHRwIH0gZnJvbSAnLi9jb25maWcvaHR0cCc7XG5pbXBvcnQgc2V0dXBMb2dnZXIgZnJvbSAnLi9jb25maWcvbG9nZ2VyJztcbmltcG9ydCBjb25maWd1cmVQYXNzcG9ydCBmcm9tICcuL2NvbmZpZy9wYXNzcG9ydCc7XG5pbXBvcnQgeyBnZXRSZWRpc0NsaWVudCB9IGZyb20gJy4vY29uZmlnL3JlZGlzJztcbmltcG9ydCB7IHN0YXJ0U2VydmVyIH0gZnJvbSAnLi9jb25maWcvc3RhcnRTZXJ2ZXInO1xuaW1wb3J0IHsgY3JlYXRlQ3NyZk1pZGRsZXdhcmUgfSBmcm9tICcuL21pZGRsZXdhcmUvY3NyZic7XG5pbXBvcnQgZXJyb3JIYW5kbGVyIGZyb20gJy4vbWlkZGxld2FyZS9lcnJvckhhbmRsZXInO1xuaW1wb3J0IHsgY3JlYXRlSXBCbGFja2xpc3QgfSBmcm9tICcuL21pZGRsZXdhcmUvaXBCbGFja2xpc3QnO1xuaW1wb3J0IHsgcmF0ZUxpbWl0TWlkZGxld2FyZSB9IGZyb20gJy4vbWlkZGxld2FyZS9yYXRlTGltaXQnO1xuaW1wb3J0IHsgc2V0dXBTZWN1cml0eUhlYWRlcnMgfSBmcm9tICcuL21pZGRsZXdhcmUvc2VjdXJpdHlIZWFkZXJzJztcbmltcG9ydCB7IGluaXRpYWxpemVNb2RlbHMgfSBmcm9tICcuL21vZGVscy9Nb2RlbHNJbmRleCc7XG5pbXBvcnQgY3JlYXRlVXNlck1vZGVsIGZyb20gJy4vbW9kZWxzL1VzZXInO1xuaW1wb3J0IHsgaW5pdGlhbGl6ZVN0YXRpY1JvdXRlcyB9IGZyb20gJy4vcm91dGVzL3N0YXRpY1JvdXRlcyc7XG5pbXBvcnQgY3JlYXRlVGVzdFJvdXRlciBmcm9tICcuL3JvdXRlcy90ZXN0Um91dGVzJztcbmltcG9ydCB7IGxvYWRFbnYgfSBmcm9tICcuL3V0aWxzL2xvYWRFbnYnO1xuaW1wb3J0IHsgY3JlYXRlTWVtb3J5TW9uaXRvciB9IGZyb20gJy4vdXRpbHMvbWVtb3J5TW9uaXRvcic7XG5pbXBvcnQgc29wcyBmcm9tICcuL3V0aWxzL3NvcHMnO1xuXG5sb2FkRW52KHsgbG9nZ2VyOiBzZXR1cExvZ2dlcigpIH0pO1xuXG5jb25zdCBsb2dnZXIgPSBzZXR1cExvZ2dlcigpO1xuY29uc3QgZmVhdHVyZUZsYWdzOiBGZWF0dXJlRmxhZ3MgPSBnZXRGZWF0dXJlRmxhZ3MobG9nZ2VyKTtcblxuY29uc3QgY3NyZlByb3RlY3Rpb24gPSBuZXcgY3NyZigpO1xuY29uc3QgdGVzdFJvdXRlciA9IGNyZWF0ZVRlc3RSb3V0ZXIoeyBsb2dnZXIgfSk7XG5cbmNvbnN0IE5PREVfRU5WID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlYhO1xuY29uc3QgU1NMX0ZMQUcgPSBmZWF0dXJlRmxhZ3MuZW5hYmxlU3NsRmxhZztcbmNvbnN0IFJFRElTX0ZMQUcgPSBmZWF0dXJlRmxhZ3MuZW5hYmxlUmVkaXNGbGFnO1xuY29uc3QgU0VSVkVSX1BPUlQgPSBOdW1iZXIocHJvY2Vzcy5lbnYuU0VSVkVSX1BPUlQpIHx8IDMwMDA7XG5jb25zdCBzdGF0aWNSb290UGF0aCA9IHByb2Nlc3MuZW52LlNUQVRJQ19ST09UX1BBVEghO1xuXG5jb25zdCBfX2ZpbGVuYW1lID0gZmlsZVVSTFRvUGF0aChpbXBvcnQubWV0YS51cmwpO1xuY29uc3QgX19kaXJuYW1lID0gZGlybmFtZShfX2ZpbGVuYW1lKTtcblxudHJ5IHtcblx0bG9nZ2VyLmluZm8oJ0xvZ2dlciBpcyB3b3JraW5nJyk7XG5cblx0bG9nZ2VyLmluZm8oJ0Vudmlyb25tZW50IFZhcmlhYmxlczonLCB7XG5cdFx0Tk9ERV9FTlY6IHByb2Nlc3MuZW52Lk5PREVfRU5WLFxuXHRcdFNFUlZFUl9QT1JUOiBwYXJzZUludChwcm9jZXNzLmVudi5TRVJWRVJfUE9SVCB8fCAnMzAwMCcsIDEwKSxcblx0XHRFTUFJTF9VU0VSOiBwcm9jZXNzLmVudi5FTUFJTF9VU0VSLFxuXHRcdEJBQ0tFTkRfTE9HX0VYUE9SVF9QQVRIOiBwcm9jZXNzLmVudi5CQUNLRU5EX0xPR19FWFBPUlRfUEFUSCxcblx0XHRTVEFUSUNfUk9PVF9QQVRIOiBwcm9jZXNzLmVudi5TVEFUSUNfUk9PVF9QQVRILFxuXHRcdEZST05URU5EX0FQUF9KU19QQVRIOiBwcm9jZXNzLmVudi5GUk9OVEVORF9BUFBfSlNfUEFUSCxcblx0XHRGUk9OVEVORF9CUk9XU0VSX0NPTkZJR19YTUxfUEFUSDpcblx0XHRcdHByb2Nlc3MuZW52LkZST05URU5EX0JST1dTRVJfQ09ORklHX1hNTF9QQVRILFxuXHRcdEZST05URU5EX0NTU19QQVRIOiBwcm9jZXNzLmVudi5GUk9OVEVORF9DU1NfUEFUSCxcblx0XHRGUk9OVEVORF9GT05UU19QQVRIOiBwcm9jZXNzLmVudi5GUk9OVEVORF9GT05UU19QQVRILFxuXHRcdEZST05URU5EX0hVTUFOU19NRF9QQVRIOiBwcm9jZXNzLmVudi5GUk9OVEVORF9IVU1BTlNfTURfUEFUSCxcblx0XHRGUk9OVEVORF9JQ09OU19QQVRIOiBwcm9jZXNzLmVudi5GUk9OVEVORF9JQ09OU19QQVRILFxuXHRcdEZST05URU5EX0lNQUdFU19QQVRIOiBwcm9jZXNzLmVudi5GUk9OVEVORF9JTUFHRVNfUEFUSCxcblx0XHRGUk9OVEVORF9KU19QQVRIOiBwcm9jZXNzLmVudi5GUk9OVEVORF9KU19QQVRILFxuXHRcdEZST05URU5EX0tFWVNfUEFUSDogcHJvY2Vzcy5lbnYuRlJPTlRFTkRfS0VZU19QQVRILFxuXHRcdEZST05URU5EX0xPR09TX1BBVEg6IHByb2Nlc3MuZW52LkZST05URU5EX0xPR09TX1BBVEgsXG5cdFx0RlJPTlRFTkRfUk9CT1RTX1RYVF9QQVRIOiBwcm9jZXNzLmVudi5GUk9OVEVORF9ST0JPVFNfVFhUX1BBVEgsXG5cdFx0RlJPTlRFTkRfU0VDVVJJVFlfTURfUEFUSDogcHJvY2Vzcy5lbnYuRlJPTlRFTkRfU0VDVVJJVFlfTURfUEFUSCxcblx0XHRGUk9OVEVORF9TRUNSRVRTX1BBVEg6IHByb2Nlc3MuZW52LkZST05URU5EX1NFQ1JFVFNfUEFUSCxcblx0XHRGUk9OVEVORF9TSVRFTUFQX1hNTF9QQVRIOiBwcm9jZXNzLmVudi5GUk9OVEVORF9TSVRFTUFQX1hNTF9QQVRILFxuXHRcdFNFUlZFUl9EQVRBX0ZJTEVfUEFUSF8xOiBwcm9jZXNzLmVudi5TRVJWRVJfREFUQV9GSUxFX1BBVEhfMSxcblx0XHRTRVJWRVJfREFUQV9GSUxFX1BBVEhfMjogcHJvY2Vzcy5lbnYuU0VSVkVSX0RBVEFfRklMRV9QQVRIXzIsXG5cdFx0U0VSVkVSX0RBVEFfRklMRV9QQVRIXzM6IHByb2Nlc3MuZW52LlNFUlZFUl9EQVRBX0ZJTEVfUEFUSF8zLFxuXHRcdFNFUlZFUl9EQVRBX0ZJTEVfUEFUSF80OiBwcm9jZXNzLmVudi5TRVJWRVJfREFUQV9GSUxFX1BBVEhfNCxcblx0XHRTRVJWRVJfTE9HX1BBVEg6IHByb2Nlc3MuZW52LlNFUlZFUl9MT0dfUEFUSCxcblx0XHRTRVJWRVJfTlBNX0xPR19QQVRIOiBwcm9jZXNzLmVudi5TRVJWRVJfTlBNX0xPR19QQVRILFxuXHRcdFNFUlZFUl9TU0xfS0VZX1BBVEg6IHByb2Nlc3MuZW52LlNFUlZFUl9TU0xfS0VZX1BBVEgsXG5cdFx0U0VSVkVSX1NTTF9DRVJUX1BBVEg6IHByb2Nlc3MuZW52LlNFUlZFUl9TU0xfQ0VSVF9QQVRILFxuXHRcdEZFQVRVUkVfQVBJX1JPVVRFU19DU1JGOiBwcm9jZXNzLmVudi5GRUFUVVJFX0FQSV9ST1VURVNfQ1NSRixcblx0XHRGRUFUVVJFX0RCX1NZTkM6IHByb2Nlc3MuZW52LkZFQVRVUkVfREJfU1lOQyxcblx0XHRGRUFUVVJFX0hUVFBTX1JFRElSRUNUOiBwcm9jZXNzLmVudi5GRUFUVVJFX0hUVFBTX1JFRElSRUNULFxuXHRcdEZFQVRVUkVfSVBfQkxBQ0tMSVNUOiBwcm9jZXNzLmVudi5GRUFUVVJFX0lQX0JMQUNLTElTVCxcblx0XHRGRUFUVVJFX0xPQURfU1RBVElDX1JPVVRFUzogcHJvY2Vzcy5lbnYuRkVBVFVSRV9MT0FEX1NUQVRJQ19ST1VURVMsXG5cdFx0RkVBVFVSRV9MT0FEX1RFU1RfUk9VVEVTOiBwcm9jZXNzLmVudi5GRUFUVVJFX0xPQURfVEVTVF9ST1VURVMsXG5cdFx0RkVBVFVSRV9TRUNVUkVfSEVBREVSUzogcHJvY2Vzcy5lbnYuRkVBVFVSRV9TRUNVUkVfSEVBREVSUyxcblx0XHRGRUFUVVJFX1NFUVVFTElaRV9MT0dHSU5HOiBwcm9jZXNzLmVudi5GRUFUVVJFX1NFUVVFTElaRV9MT0dHSU5HLFxuXHRcdExPR0dFUjogcGFyc2VJbnQocHJvY2Vzcy5lbnYuTE9HR0VSIHx8ICcxJywgMTApLFxuXHRcdFlVQklDT19BUElfVVJMOiBwcm9jZXNzLmVudi5ZVUJJQ09fQVBJX1VSTFxuXHR9KTtcblxuXHRsb2dnZXIuaW5mbygnSW5pdGlhbGl6aW5nIGRhdGFiYXNlJyk7XG5cdGNvbnN0IHNlcXVlbGl6ZSA9IGF3YWl0IGluaXRpYWxpemVEYXRhYmFzZSh7XG5cdFx0bG9nZ2VyLFxuXHRcdGdldEZlYXR1cmVGbGFncyxcblx0XHRnZXRTZWNyZXRzOiAoKSA9PlxuXHRcdFx0c29wcy5nZXRTZWNyZXRzKHtcblx0XHRcdFx0bG9nZ2VyLFxuXHRcdFx0XHRleGVjU3luYyxcblx0XHRcdFx0Z2V0RGlyZWN0b3J5UGF0aDogKCkgPT4gcHJvY2Vzcy5jd2QoKVxuXHRcdFx0fSlcblx0fSk7XG5cblx0bG9nZ2VyLmluZm8oJ0luaXRpYWxpemluZyBtb2RlbHMnKTtcblx0aW5pdGlhbGl6ZU1vZGVscyhzZXF1ZWxpemUpO1xuXG5cdGxvZ2dlci5pbmZvKCdJbml0aWFsaXppbmcgcGFzc3BvcnQnKTtcblx0Y29uc3QgVXNlck1vZGVsID0gY3JlYXRlVXNlck1vZGVsKHNlcXVlbGl6ZSk7XG5cdGF3YWl0IGNvbmZpZ3VyZVBhc3Nwb3J0KHtcblx0XHRwYXNzcG9ydCxcblx0XHRsb2dnZXIsXG5cdFx0Z2V0U2VjcmV0czogKCkgPT5cblx0XHRcdHNvcHMuZ2V0U2VjcmV0cyh7XG5cdFx0XHRcdGxvZ2dlcixcblx0XHRcdFx0ZXhlY1N5bmMsXG5cdFx0XHRcdGdldERpcmVjdG9yeVBhdGg6ICgpID0+IHByb2Nlc3MuY3dkKClcblx0XHRcdH0pLFxuXHRcdFVzZXJNb2RlbCxcblx0XHRhcmdvbjJcblx0fSk7XG5cblx0bG9nZ2VyLmluZm8oJ0luaXRpYWxpemluZyBJUCBibGFja2xpc3QnKTtcblx0Y29uc3QgaXBCbGFja2xpc3QgPSBjcmVhdGVJcEJsYWNrbGlzdCh7XG5cdFx0bG9nZ2VyLFxuXHRcdGZlYXR1cmVGbGFncyxcblx0XHRfX2Rpcm5hbWUsXG5cdFx0ZnNNb2R1bGU6IGZzXG5cdH0pO1xuXHRhd2FpdCBpcEJsYWNrbGlzdC5pbml0aWFsaXplQmxhY2tsaXN0KCk7XG5cblx0Y29uc3QgY3NyZk1pZGRsZXdhcmUgPSBjcmVhdGVDc3JmTWlkZGxld2FyZSh7XG5cdFx0ZmVhdHVyZUZsYWdzLFxuXHRcdGxvZ2dlcixcblx0XHRjc3JmUHJvdGVjdGlvblxuXHR9KTtcblxuXHRjb25zdCB7IHN0YXJ0TWVtb3J5TW9uaXRvciB9ID0gY3JlYXRlTWVtb3J5TW9uaXRvcih7XG5cdFx0bG9nZ2VyLFxuXHRcdG9zLFxuXHRcdHByb2Nlc3MsXG5cdFx0c2V0SW50ZXJ2YWxcblx0fSk7XG5cblx0bG9nZ2VyLmluZm8oJ0luaXRpYWxpemluZyBhcHAnKTtcblx0Y29uc3QgYXBwID0gYXdhaXQgaW5pdGlhbGl6ZUFwcCh7XG5cdFx0ZXhwcmVzcyxcblx0XHRzZXNzaW9uLFxuXHRcdGNvb2tpZVBhcnNlcixcblx0XHRjb3JzLFxuXHRcdGhwcCxcblx0XHRtb3JnYW4sXG5cdFx0cGFzc3BvcnQsXG5cdFx0cmFuZG9tQnl0ZXMsXG5cdFx0cGF0aCxcblx0XHRSZWRpc1N0b3JlLFxuXHRcdGluaXRpYWxpemVTdGF0aWNSb3V0ZXMsXG5cdFx0Y3NyZk1pZGRsZXdhcmUsXG5cdFx0ZXJyb3JIYW5kbGVyLFxuXHRcdGdldFJlZGlzQ2xpZW50LFxuXHRcdGlwQmxhY2tsaXN0TWlkZGxld2FyZTogaXBCbGFja2xpc3QuaXBCbGFja2xpc3RNaWRkbGV3YXJlLFxuXHRcdGNyZWF0ZVRlc3RSb3V0ZXI6IGFwcCA9PiBhcHAudXNlKHRlc3RSb3V0ZXIpLFxuXHRcdHJhdGVMaW1pdE1pZGRsZXdhcmUsXG5cdFx0c2V0dXBTZWN1cml0eUhlYWRlcnMsXG5cdFx0c3RhcnRNZW1vcnlNb25pdG9yLFxuXHRcdGxvZ2dlcixcblx0XHRzdGF0aWNSb290UGF0aCxcblx0XHROT0RFX0VOVixcblx0XHRTU0xfRkxBRyxcblx0XHRSRURJU19GTEFHXG5cdH0pO1xuXG5cdGNvbnN0IGRiU3luY0ZsYWcgPSBmZWF0dXJlRmxhZ3M/LmRiU3luY0ZsYWcgPz8gZmFsc2U7XG5cdGlmIChkYlN5bmNGbGFnKSB7XG5cdFx0bG9nZ2VyLmluZm8oJ1Rlc3RpbmcgZGF0YWJhc2UgY29ubmVjdGlvbiBhbmQgc3luY2luZyBtb2RlbHMnKTtcblx0XHRjb25zdCBzZXF1ZWxpemUgPSBnZXRTZXF1ZWxpemVJbnN0YW5jZSh7IGxvZ2dlciB9KTtcblx0XHR0cnkge1xuXHRcdFx0YXdhaXQgc2VxdWVsaXplLnN5bmMoKTtcblx0XHRcdGxvZ2dlci5pbmZvKCdEYXRhYmFzZSBhbmQgdGFibGVzIGNyZWF0ZWQhJyk7XG5cdFx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0XHRsb2dnZXIuZXJyb3IoXG5cdFx0XHRcdCdEYXRhYmFzZSBDb25uZWN0aW9uIFRlc3QgYW5kIFN5bmM6IFNlcnZlciBlcnJvcjonLFxuXHRcdFx0XHRlcnJcblx0XHRcdCk7XG5cdFx0XHRwcm9jZXNzLmV4aXQoMSk7XG5cdFx0fVxuXHR9XG5cblx0Ly8gU2V0dXAgSFRUUC9IVFRQUyBzZXJ2ZXJcblx0Y29uc3QgeyBvcHRpb25zIH0gPSBhd2FpdCBzZXR1cEh0dHAoe1xuXHRcdGFwcCxcblx0XHRzb3BzLFxuXHRcdGZzOiBmc1Byb21pc2VzLFxuXHRcdGxvZ2dlcixcblx0XHRjb25zdGFudHMsXG5cdFx0Z2V0RmVhdHVyZUZsYWdzOiAoKSA9PiBnZXRGZWF0dXJlRmxhZ3MobG9nZ2VyKSxcblx0XHRnZXRSZWRpc0NsaWVudCxcblx0XHRnZXRTZXF1ZWxpemVJbnN0YW5jZTogKCkgPT4gZ2V0U2VxdWVsaXplSW5zdGFuY2UoeyBsb2dnZXIgfSksXG5cdFx0aW5pdGlhbGl6ZURhdGFiYXNlOiBhc3luYyAoKTogUHJvbWlzZTxTZXF1ZWxpemU+ID0+XG5cdFx0XHRpbml0aWFsaXplRGF0YWJhc2Uoe1xuXHRcdFx0XHRsb2dnZXIsXG5cdFx0XHRcdGdldEZlYXR1cmVGbGFnczogKCkgPT4gZ2V0RmVhdHVyZUZsYWdzKGxvZ2dlciksXG5cdFx0XHRcdGdldFNlY3JldHM6ICgpID0+XG5cdFx0XHRcdFx0c29wcy5nZXRTZWNyZXRzKHtcblx0XHRcdFx0XHRcdGxvZ2dlcixcblx0XHRcdFx0XHRcdGV4ZWNTeW5jLFxuXHRcdFx0XHRcdFx0Z2V0RGlyZWN0b3J5UGF0aDogKCkgPT4gcHJvY2Vzcy5jd2QoKVxuXHRcdFx0XHRcdH0pXG5cdFx0XHR9KSxcblx0XHRTRVJWRVJfUE9SVCxcblx0XHRTU0xfRkxBRzogZmVhdHVyZUZsYWdzLmVuYWJsZVNzbEZsYWcsXG5cdFx0UkVESVNfRkxBRzogZmVhdHVyZUZsYWdzLmVuYWJsZVJlZGlzRmxhZ1xuXHR9KTtcblxuXHQvLyBTdGFydCBzZXJ2ZXIgd2l0aCBhcHByb3ByaWF0ZSBvcHRpb25zXG5cdHRyeSB7XG5cdFx0bG9nZ2VyLmluZm8oYFN0YXJ0aW5nIEhUVFAgc2VydmVyIG9uIHBvcnQgJHtTRVJWRVJfUE9SVH1gKTtcblx0XHRsb2dnZXIuaW5mbygnSW5pdGlhbGl6aW5nIGRhdGFiYXNlIGJlZm9yZSBzdGFydGluZyBzZXJ2ZXIuJyk7XG5cblx0XHRjb25zdCBzZXF1ZWxpemUgPSBnZXRTZXF1ZWxpemVJbnN0YW5jZSh7IGxvZ2dlciB9KTtcblx0XHRhd2FpdCBzZXF1ZWxpemUuYXV0aGVudGljYXRlKCk7XG5cdFx0bG9nZ2VyLmluZm8oJ0RhdGFiYXNlIGNvbm5lY3Rpb24gaGFzIGJlZW4gZXN0YWJsaXNoZWQgc3VjY2Vzc2Z1bGx5LicpO1xuXG5cdFx0bGV0IHNlcnZlcjtcblxuXHRcdGlmIChTU0xfRkxBRyAmJiBvcHRpb25zKSB7XG5cdFx0XHRzZXJ2ZXIgPSBodHRwc1xuXHRcdFx0XHQuY3JlYXRlU2VydmVyKG9wdGlvbnMsIGFwcClcblx0XHRcdFx0Lmxpc3RlbihTRVJWRVJfUE9SVCwgKCkgPT4ge1xuXHRcdFx0XHRcdGxvZ2dlci5pbmZvKGBIVFRQUyBzZXJ2ZXIgcnVubmluZyBvbiBwb3J0ICR7U0VSVkVSX1BPUlR9YCk7XG5cdFx0XHRcdH0pO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRzZXJ2ZXIgPSBhcHAubGlzdGVuKFNFUlZFUl9QT1JULCAoKSA9PiB7XG5cdFx0XHRcdGxvZ2dlci5pbmZvKGBIVFRQIHNlcnZlciBydW5uaW5nIG9uIHBvcnQgJHtTRVJWRVJfUE9SVH1gKTtcblx0XHRcdH0pO1xuXHRcdH1cblxuXHRcdGdyYWNlZnVsU2h1dGRvd24oc2VydmVyLCB7XG5cdFx0XHRzaWduYWxzOiAnU0lHSU5UIFNJR1RFUk0nLFxuXHRcdFx0dGltZW91dDogMzAwMDAsXG5cdFx0XHRkZXZlbG9wbWVudDogZmFsc2UsXG5cdFx0XHRvblNodXRkb3duOiBhc3luYyAoKSA9PiB7XG5cdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0YXdhaXQgc2VxdWVsaXplLmNsb3NlKCk7XG5cdFx0XHRcdFx0bG9nZ2VyLmluZm8oJ0RhdGFiYXNlIGNvbm5lY3Rpb24gY2xvc2VkJyk7XG5cblx0XHRcdFx0XHRpZiAoUkVESVNfRkxBRykge1xuXHRcdFx0XHRcdFx0Y29uc3QgcmVkaXNDbGllbnQgPSBnZXRSZWRpc0NsaWVudCgpO1xuXHRcdFx0XHRcdFx0aWYgKHJlZGlzQ2xpZW50KSB7XG5cdFx0XHRcdFx0XHRcdGF3YWl0IHJlZGlzQ2xpZW50LnF1aXQoKTtcblx0XHRcdFx0XHRcdFx0bG9nZ2VyLmluZm8oJ1JlZGlzIGNvbm5lY3Rpb24gY2xvc2VkJyk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGxvZ2dlci5jbG9zZSgpO1xuXHRcdFx0XHRcdGNvbnNvbGUubG9nKCdMb2dnZXIgY2xvc2VkJyk7XG5cdFx0XHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHRcdFx0bG9nZ2VyLmVycm9yKGBFcnJvciBkdXJpbmcgc2h1dGRvd246ICR7ZXJyb3J9YCk7XG5cdFx0XHRcdH1cblx0XHRcdH0sXG5cdFx0XHRmaW5hbGx5OiAoKSA9PiBjb25zb2xlLmxvZygnU2VydmVyIGhhcyBncmFjZWZ1bGx5IHNodXQgZG93bicpXG5cdFx0fSk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0bG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gc3RhcnQgc2VydmVyOiAke2Vycm9yfWApO1xuXHRcdHByb2Nlc3MuZXhpdCgxKTtcblx0fVxufSBjYXRjaCAoZXJyKSB7XG5cdGxvZ2dlci5lcnJvcignVW5oYW5kbGVkIGVycm9yIGR1cmluZyBzZXJ2ZXIgaW5pdGlhbGl6YXRpb246JywgZXJyKTtcblx0cHJvY2Vzcy5leGl0KDEpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBzdGFydFNlcnZlcjtcbiJdfQ==
