import argon2 from 'argon2';
import { execSync } from 'child_process';
import RedisStore from 'connect-redis';
import cookieParser from 'cookie-parser';
import cors from 'cors';
import { constants, randomBytes } from 'crypto';
import csrf from 'csrf';
import express from 'express';
import session from 'express-session';
import * as fs from 'fs';
import * as fsPromises from 'fs/promises';
import hpp from 'hpp';
import morgan from 'morgan';
import passport from 'passport';
import os from 'os';
import path, { dirname } from 'path';
import { fileURLToPath } from 'url';
import { initializeApp } from './config/app';
import { getSequelizeInstance, initializeDatabase } from './config/db';
import { environmentVariables } from './config/environmentVariables';
import { getFeatureFlags } from './utils/featureFlags';
import { setupHttp } from './config/http';
import setupLogger from './config/logger';
import configurePassport from './config/passport';
import { getRedisClient } from './config/redis';
import { createCsrfMiddleware } from './middleware/csrf';
import errorHandler from './middleware/errorHandler';
import { createIpBlacklist } from './middleware/ipBlacklist';
import { rateLimitMiddleware } from './middleware/rateLimit';
import { setupSecurityHeaders } from './middleware/securityHeaders';
import { initializeModels } from './models/ModelsIndex';
import createUserModel from './models/User';
import { initializeStaticRoutes } from './routes/staticRoutes';
import createTestRouter from './routes/testRoutes';
import { createMemoryMonitor } from './utils/memoryMonitor';
import sops from './utils/sops';
const logger = setupLogger();
const featureFlags = getFeatureFlags(logger);
const csrfProtection = new csrf();
const testRouter = createTestRouter({ logger });
const staticRootPath = environmentVariables.STATIC_ROOT_PATH;
logger.info(`Static root path defined as ${staticRootPath}`);
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
async function start() {
	try {
		logger.info('Logger is working');
		logger.info('Initializing database');
		const sequelize = await initializeDatabase({
			logger,
			getFeatureFlags,
			getSecrets: () =>
				sops.getSecrets({
					logger,
					execSync,
					getDirectoryPath: () => process.cwd()
				})
		});
		logger.info('Initializing models');
		initializeModels(sequelize);
		logger.info('Initializing passport');
		const UserModel = createUserModel(sequelize);
		await configurePassport({
			passport,
			logger,
			getSecrets: () =>
				sops.getSecrets({
					logger,
					execSync,
					getDirectoryPath: () => process.cwd()
				}),
			UserModel,
			argon2
		});
		logger.info('Initializing IP blacklist');
		const ipBlacklist = createIpBlacklist({
			logger,
			featureFlags,
			__dirname,
			fsModule: fs
		});
		await ipBlacklist.initializeBlacklist();
		const csrfMiddleware = createCsrfMiddleware({
			featureFlags,
			logger,
			csrfProtection
		});
		const { startMemoryMonitor } = createMemoryMonitor({
			logger,
			os,
			process,
			setInterval
		});
		logger.info('Initializing app');
		const app = await initializeApp({
			express,
			session,
			cookieParser,
			cors,
			hpp,
			morgan,
			passport,
			randomBytes,
			path,
			RedisStore,
			initializeStaticRoutes,
			csrfMiddleware,
			errorHandler,
			getRedisClient,
			ipBlacklistMiddleware: ipBlacklist.ipBlacklistMiddleware,
			createTestRouter: app => app.use(testRouter),
			rateLimitMiddleware,
			setupSecurityHeaders,
			startMemoryMonitor,
			logger,
			staticRootPath
		});
		const dbSyncFlag = featureFlags?.dbSyncFlag ?? false;
		if (dbSyncFlag) {
			logger.info('Testing database connection and syncing models');
			await sequelize.sync();
			logger.info('Database and tables created!');
		}
		// Setup HTTP/HTTPS server
		const { startServer } = await setupHttp({
			app,
			sops,
			fs: fsPromises,
			logger,
			constants,
			getFeatureFlags: () => getFeatureFlags(logger),
			getRedisClient,
			getSequelizeInstance: () => getSequelizeInstance({ logger })
		});
		startServer();
	} catch (error) {
		logger.error('Unhandled error during server initialization:', error);
		process.exit(1);
	}
}
await start();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3NlcnZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLE1BQU0sTUFBTSxRQUFRLENBQUM7QUFDNUIsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLFVBQVUsTUFBTSxlQUFlLENBQUM7QUFDdkMsT0FBTyxZQUFZLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUN4QixPQUFPLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUNoRCxPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxPQUFPLE1BQU0sU0FBUyxDQUFDO0FBQzlCLE9BQU8sT0FBTyxNQUFNLGlCQUFpQixDQUFDO0FBQ3RDLE9BQU8sS0FBSyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3pCLE9BQU8sS0FBSyxVQUFVLE1BQU0sYUFBYSxDQUFDO0FBQzFDLE9BQU8sR0FBRyxNQUFNLEtBQUssQ0FBQztBQUN0QixPQUFPLE1BQU0sTUFBTSxRQUFRLENBQUM7QUFDNUIsT0FBTyxRQUFRLE1BQU0sVUFBVSxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQztBQUNwQixPQUFPLElBQUksRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNyQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sS0FBSyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDN0MsT0FBTyxFQUFFLG9CQUFvQixFQUFFLGtCQUFrQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ3JFLE9BQU8sRUFBZ0IsZUFBZSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDckUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxQyxPQUFPLFdBQVcsTUFBTSxpQkFBaUIsQ0FBQztBQUMxQyxPQUFPLGlCQUFpQixNQUFNLG1CQUFtQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNoRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN6RCxPQUFPLFlBQVksTUFBTSwyQkFBMkIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM3RCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN4RCxPQUFPLGVBQWUsTUFBTSxlQUFlLENBQUM7QUFDNUMsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDL0QsT0FBTyxnQkFBZ0IsTUFBTSxxQkFBcUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUM1RCxPQUFPLElBQUksTUFBTSxjQUFjLENBQUM7QUFFaEMsTUFBTSxNQUFNLEdBQUcsV0FBVyxFQUFFLENBQUM7QUFDN0IsTUFBTSxZQUFZLEdBQWlCLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUUzRCxNQUFNLGNBQWMsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO0FBQ2xDLE1BQU0sVUFBVSxHQUFHLGdCQUFnQixDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztBQUVoRCxNQUFNLGNBQWMsR0FBRyxvQkFBb0IsQ0FBQyxnQkFBZ0IsQ0FBQztBQUU3RCxNQUFNLENBQUMsSUFBSSxDQUFDLCtCQUErQixjQUFjLEVBQUUsQ0FBQyxDQUFDO0FBRTdELE1BQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2xELE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUV0QyxLQUFLLFVBQVUsS0FBSztJQUNuQixJQUFJLENBQUM7UUFDSixNQUFNLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFFakMsTUFBTSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1FBQ3JDLE1BQU0sU0FBUyxHQUFHLE1BQU0sa0JBQWtCLENBQUM7WUFDMUMsTUFBTTtZQUNOLGVBQWU7WUFDZixVQUFVLEVBQUUsR0FBRyxFQUFFLENBQ2hCLElBQUksQ0FBQyxVQUFVLENBQUM7Z0JBQ2YsTUFBTTtnQkFDTixRQUFRO2dCQUNSLGdCQUFnQixFQUFFLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUU7YUFDckMsQ0FBQztTQUNILENBQUMsQ0FBQztRQUVILE1BQU0sQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUNuQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUU1QixNQUFNLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDckMsTUFBTSxTQUFTLEdBQUcsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzdDLE1BQU0saUJBQWlCLENBQUM7WUFDdkIsUUFBUTtZQUNSLE1BQU07WUFDTixVQUFVLEVBQUUsR0FBRyxFQUFFLENBQ2hCLElBQUksQ0FBQyxVQUFVLENBQUM7Z0JBQ2YsTUFBTTtnQkFDTixRQUFRO2dCQUNSLGdCQUFnQixFQUFFLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUU7YUFDckMsQ0FBQztZQUNILFNBQVM7WUFDVCxNQUFNO1NBQ04sQ0FBQyxDQUFDO1FBRUgsTUFBTSxDQUFDLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sV0FBVyxHQUFHLGlCQUFpQixDQUFDO1lBQ3JDLE1BQU07WUFDTixZQUFZO1lBQ1osU0FBUztZQUNULFFBQVEsRUFBRSxFQUFFO1NBQ1osQ0FBQyxDQUFDO1FBQ0gsTUFBTSxXQUFXLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUV4QyxNQUFNLGNBQWMsR0FBRyxvQkFBb0IsQ0FBQztZQUMzQyxZQUFZO1lBQ1osTUFBTTtZQUNOLGNBQWM7U0FDZCxDQUFDLENBQUM7UUFFSCxNQUFNLEVBQUUsa0JBQWtCLEVBQUUsR0FBRyxtQkFBbUIsQ0FBQztZQUNsRCxNQUFNO1lBQ04sRUFBRTtZQUNGLE9BQU87WUFDUCxXQUFXO1NBQ1gsQ0FBQyxDQUFDO1FBRUgsTUFBTSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ2hDLE1BQU0sR0FBRyxHQUFHLE1BQU0sYUFBYSxDQUFDO1lBQy9CLE9BQU87WUFDUCxPQUFPO1lBQ1AsWUFBWTtZQUNaLElBQUk7WUFDSixHQUFHO1lBQ0gsTUFBTTtZQUNOLFFBQVE7WUFDUixXQUFXO1lBQ1gsSUFBSTtZQUNKLFVBQVU7WUFDVixzQkFBc0I7WUFDdEIsY0FBYztZQUNkLFlBQVk7WUFDWixjQUFjO1lBQ2QscUJBQXFCLEVBQUUsV0FBVyxDQUFDLHFCQUFxQjtZQUN4RCxnQkFBZ0IsRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDO1lBQzVDLG1CQUFtQjtZQUNuQixvQkFBb0I7WUFDcEIsa0JBQWtCO1lBQ2xCLE1BQU07WUFDTixjQUFjO1NBQ2QsQ0FBQyxDQUFDO1FBRUgsTUFBTSxVQUFVLEdBQUcsWUFBWSxFQUFFLFVBQVUsSUFBSSxLQUFLLENBQUM7UUFDckQsSUFBSSxVQUFVLEVBQUUsQ0FBQztZQUNoQixNQUFNLENBQUMsSUFBSSxDQUFDLGdEQUFnRCxDQUFDLENBQUM7WUFDOUQsTUFBTSxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDdkIsTUFBTSxDQUFDLElBQUksQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO1FBQzdDLENBQUM7UUFFRCwwQkFBMEI7UUFDMUIsTUFBTSxFQUFFLFdBQVcsRUFBRSxHQUFHLE1BQU0sU0FBUyxDQUFDO1lBQ3ZDLEdBQUc7WUFDSCxJQUFJO1lBQ0osRUFBRSxFQUFFLFVBQVU7WUFDZCxNQUFNO1lBQ04sU0FBUztZQUNULGVBQWUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDO1lBQzlDLGNBQWM7WUFDZCxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDO1NBQzVELENBQUMsQ0FBQztRQUVILFdBQVcsRUFBRSxDQUFDO0lBQ2YsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDaEIsTUFBTSxDQUFDLEtBQUssQ0FBQywrQ0FBK0MsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNyRSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pCLENBQUM7QUFDRixDQUFDO0FBRUQsTUFBTSxLQUFLLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBhcmdvbjIgZnJvbSAnYXJnb24yJztcbmltcG9ydCB7IGV4ZWNTeW5jIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgUmVkaXNTdG9yZSBmcm9tICdjb25uZWN0LXJlZGlzJztcbmltcG9ydCBjb29raWVQYXJzZXIgZnJvbSAnY29va2llLXBhcnNlcic7XG5pbXBvcnQgY29ycyBmcm9tICdjb3JzJztcbmltcG9ydCB7IGNvbnN0YW50cywgcmFuZG9tQnl0ZXMgfSBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IGNzcmYgZnJvbSAnY3NyZic7XG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCBzZXNzaW9uIGZyb20gJ2V4cHJlc3Mtc2Vzc2lvbic7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBmc1Byb21pc2VzIGZyb20gJ2ZzL3Byb21pc2VzJztcbmltcG9ydCBocHAgZnJvbSAnaHBwJztcbmltcG9ydCBtb3JnYW4gZnJvbSAnbW9yZ2FuJztcbmltcG9ydCBwYXNzcG9ydCBmcm9tICdwYXNzcG9ydCc7XG5pbXBvcnQgb3MgZnJvbSAnb3MnO1xuaW1wb3J0IHBhdGgsIHsgZGlybmFtZSB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZmlsZVVSTFRvUGF0aCB9IGZyb20gJ3VybCc7XG5pbXBvcnQgeyBpbml0aWFsaXplQXBwIH0gZnJvbSAnLi9jb25maWcvYXBwJztcbmltcG9ydCB7IGdldFNlcXVlbGl6ZUluc3RhbmNlLCBpbml0aWFsaXplRGF0YWJhc2UgfSBmcm9tICcuL2NvbmZpZy9kYic7XG5pbXBvcnQgeyBlbnZpcm9ubWVudFZhcmlhYmxlcyB9IGZyb20gJy4vY29uZmlnL2Vudmlyb25tZW50VmFyaWFibGVzJztcbmltcG9ydCB7IEZlYXR1cmVGbGFncywgZ2V0RmVhdHVyZUZsYWdzIH0gZnJvbSAnLi91dGlscy9mZWF0dXJlRmxhZ3MnO1xuaW1wb3J0IHsgc2V0dXBIdHRwIH0gZnJvbSAnLi9jb25maWcvaHR0cCc7XG5pbXBvcnQgc2V0dXBMb2dnZXIgZnJvbSAnLi9jb25maWcvbG9nZ2VyJztcbmltcG9ydCBjb25maWd1cmVQYXNzcG9ydCBmcm9tICcuL2NvbmZpZy9wYXNzcG9ydCc7XG5pbXBvcnQgeyBnZXRSZWRpc0NsaWVudCB9IGZyb20gJy4vY29uZmlnL3JlZGlzJztcbmltcG9ydCB7IGNyZWF0ZUNzcmZNaWRkbGV3YXJlIH0gZnJvbSAnLi9taWRkbGV3YXJlL2NzcmYnO1xuaW1wb3J0IGVycm9ySGFuZGxlciBmcm9tICcuL21pZGRsZXdhcmUvZXJyb3JIYW5kbGVyJztcbmltcG9ydCB7IGNyZWF0ZUlwQmxhY2tsaXN0IH0gZnJvbSAnLi9taWRkbGV3YXJlL2lwQmxhY2tsaXN0JztcbmltcG9ydCB7IHJhdGVMaW1pdE1pZGRsZXdhcmUgfSBmcm9tICcuL21pZGRsZXdhcmUvcmF0ZUxpbWl0JztcbmltcG9ydCB7IHNldHVwU2VjdXJpdHlIZWFkZXJzIH0gZnJvbSAnLi9taWRkbGV3YXJlL3NlY3VyaXR5SGVhZGVycyc7XG5pbXBvcnQgeyBpbml0aWFsaXplTW9kZWxzIH0gZnJvbSAnLi9tb2RlbHMvTW9kZWxzSW5kZXgnO1xuaW1wb3J0IGNyZWF0ZVVzZXJNb2RlbCBmcm9tICcuL21vZGVscy9Vc2VyJztcbmltcG9ydCB7IGluaXRpYWxpemVTdGF0aWNSb3V0ZXMgfSBmcm9tICcuL3JvdXRlcy9zdGF0aWNSb3V0ZXMnO1xuaW1wb3J0IGNyZWF0ZVRlc3RSb3V0ZXIgZnJvbSAnLi9yb3V0ZXMvdGVzdFJvdXRlcyc7XG5pbXBvcnQgeyBjcmVhdGVNZW1vcnlNb25pdG9yIH0gZnJvbSAnLi91dGlscy9tZW1vcnlNb25pdG9yJztcbmltcG9ydCBzb3BzIGZyb20gJy4vdXRpbHMvc29wcyc7XG5cbmNvbnN0IGxvZ2dlciA9IHNldHVwTG9nZ2VyKCk7XG5jb25zdCBmZWF0dXJlRmxhZ3M6IEZlYXR1cmVGbGFncyA9IGdldEZlYXR1cmVGbGFncyhsb2dnZXIpO1xuXG5jb25zdCBjc3JmUHJvdGVjdGlvbiA9IG5ldyBjc3JmKCk7XG5jb25zdCB0ZXN0Um91dGVyID0gY3JlYXRlVGVzdFJvdXRlcih7IGxvZ2dlciB9KTtcblxuY29uc3Qgc3RhdGljUm9vdFBhdGggPSBlbnZpcm9ubWVudFZhcmlhYmxlcy5TVEFUSUNfUk9PVF9QQVRIO1xuXG5sb2dnZXIuaW5mbyhgU3RhdGljIHJvb3QgcGF0aCBkZWZpbmVkIGFzICR7c3RhdGljUm9vdFBhdGh9YCk7XG5cbmNvbnN0IF9fZmlsZW5hbWUgPSBmaWxlVVJMVG9QYXRoKGltcG9ydC5tZXRhLnVybCk7XG5jb25zdCBfX2Rpcm5hbWUgPSBkaXJuYW1lKF9fZmlsZW5hbWUpO1xuXG5hc3luYyBmdW5jdGlvbiBzdGFydCgpOiBQcm9taXNlPHZvaWQ+IHtcblx0dHJ5IHtcblx0XHRsb2dnZXIuaW5mbygnTG9nZ2VyIGlzIHdvcmtpbmcnKTtcblxuXHRcdGxvZ2dlci5pbmZvKCdJbml0aWFsaXppbmcgZGF0YWJhc2UnKTtcblx0XHRjb25zdCBzZXF1ZWxpemUgPSBhd2FpdCBpbml0aWFsaXplRGF0YWJhc2Uoe1xuXHRcdFx0bG9nZ2VyLFxuXHRcdFx0Z2V0RmVhdHVyZUZsYWdzLFxuXHRcdFx0Z2V0U2VjcmV0czogKCkgPT5cblx0XHRcdFx0c29wcy5nZXRTZWNyZXRzKHtcblx0XHRcdFx0XHRsb2dnZXIsXG5cdFx0XHRcdFx0ZXhlY1N5bmMsXG5cdFx0XHRcdFx0Z2V0RGlyZWN0b3J5UGF0aDogKCkgPT4gcHJvY2Vzcy5jd2QoKVxuXHRcdFx0XHR9KVxuXHRcdH0pO1xuXG5cdFx0bG9nZ2VyLmluZm8oJ0luaXRpYWxpemluZyBtb2RlbHMnKTtcblx0XHRpbml0aWFsaXplTW9kZWxzKHNlcXVlbGl6ZSk7XG5cblx0XHRsb2dnZXIuaW5mbygnSW5pdGlhbGl6aW5nIHBhc3Nwb3J0Jyk7XG5cdFx0Y29uc3QgVXNlck1vZGVsID0gY3JlYXRlVXNlck1vZGVsKHNlcXVlbGl6ZSk7XG5cdFx0YXdhaXQgY29uZmlndXJlUGFzc3BvcnQoe1xuXHRcdFx0cGFzc3BvcnQsXG5cdFx0XHRsb2dnZXIsXG5cdFx0XHRnZXRTZWNyZXRzOiAoKSA9PlxuXHRcdFx0XHRzb3BzLmdldFNlY3JldHMoe1xuXHRcdFx0XHRcdGxvZ2dlcixcblx0XHRcdFx0XHRleGVjU3luYyxcblx0XHRcdFx0XHRnZXREaXJlY3RvcnlQYXRoOiAoKSA9PiBwcm9jZXNzLmN3ZCgpXG5cdFx0XHRcdH0pLFxuXHRcdFx0VXNlck1vZGVsLFxuXHRcdFx0YXJnb24yXG5cdFx0fSk7XG5cblx0XHRsb2dnZXIuaW5mbygnSW5pdGlhbGl6aW5nIElQIGJsYWNrbGlzdCcpO1xuXHRcdGNvbnN0IGlwQmxhY2tsaXN0ID0gY3JlYXRlSXBCbGFja2xpc3Qoe1xuXHRcdFx0bG9nZ2VyLFxuXHRcdFx0ZmVhdHVyZUZsYWdzLFxuXHRcdFx0X19kaXJuYW1lLFxuXHRcdFx0ZnNNb2R1bGU6IGZzXG5cdFx0fSk7XG5cdFx0YXdhaXQgaXBCbGFja2xpc3QuaW5pdGlhbGl6ZUJsYWNrbGlzdCgpO1xuXG5cdFx0Y29uc3QgY3NyZk1pZGRsZXdhcmUgPSBjcmVhdGVDc3JmTWlkZGxld2FyZSh7XG5cdFx0XHRmZWF0dXJlRmxhZ3MsXG5cdFx0XHRsb2dnZXIsXG5cdFx0XHRjc3JmUHJvdGVjdGlvblxuXHRcdH0pO1xuXG5cdFx0Y29uc3QgeyBzdGFydE1lbW9yeU1vbml0b3IgfSA9IGNyZWF0ZU1lbW9yeU1vbml0b3Ioe1xuXHRcdFx0bG9nZ2VyLFxuXHRcdFx0b3MsXG5cdFx0XHRwcm9jZXNzLFxuXHRcdFx0c2V0SW50ZXJ2YWxcblx0XHR9KTtcblxuXHRcdGxvZ2dlci5pbmZvKCdJbml0aWFsaXppbmcgYXBwJyk7XG5cdFx0Y29uc3QgYXBwID0gYXdhaXQgaW5pdGlhbGl6ZUFwcCh7XG5cdFx0XHRleHByZXNzLFxuXHRcdFx0c2Vzc2lvbixcblx0XHRcdGNvb2tpZVBhcnNlcixcblx0XHRcdGNvcnMsXG5cdFx0XHRocHAsXG5cdFx0XHRtb3JnYW4sXG5cdFx0XHRwYXNzcG9ydCxcblx0XHRcdHJhbmRvbUJ5dGVzLFxuXHRcdFx0cGF0aCxcblx0XHRcdFJlZGlzU3RvcmUsXG5cdFx0XHRpbml0aWFsaXplU3RhdGljUm91dGVzLFxuXHRcdFx0Y3NyZk1pZGRsZXdhcmUsXG5cdFx0XHRlcnJvckhhbmRsZXIsXG5cdFx0XHRnZXRSZWRpc0NsaWVudCxcblx0XHRcdGlwQmxhY2tsaXN0TWlkZGxld2FyZTogaXBCbGFja2xpc3QuaXBCbGFja2xpc3RNaWRkbGV3YXJlLFxuXHRcdFx0Y3JlYXRlVGVzdFJvdXRlcjogYXBwID0+IGFwcC51c2UodGVzdFJvdXRlciksXG5cdFx0XHRyYXRlTGltaXRNaWRkbGV3YXJlLFxuXHRcdFx0c2V0dXBTZWN1cml0eUhlYWRlcnMsXG5cdFx0XHRzdGFydE1lbW9yeU1vbml0b3IsXG5cdFx0XHRsb2dnZXIsXG5cdFx0XHRzdGF0aWNSb290UGF0aFxuXHRcdH0pO1xuXG5cdFx0Y29uc3QgZGJTeW5jRmxhZyA9IGZlYXR1cmVGbGFncz8uZGJTeW5jRmxhZyA/PyBmYWxzZTtcblx0XHRpZiAoZGJTeW5jRmxhZykge1xuXHRcdFx0bG9nZ2VyLmluZm8oJ1Rlc3RpbmcgZGF0YWJhc2UgY29ubmVjdGlvbiBhbmQgc3luY2luZyBtb2RlbHMnKTtcblx0XHRcdGF3YWl0IHNlcXVlbGl6ZS5zeW5jKCk7XG5cdFx0XHRsb2dnZXIuaW5mbygnRGF0YWJhc2UgYW5kIHRhYmxlcyBjcmVhdGVkIScpO1xuXHRcdH1cblxuXHRcdC8vIFNldHVwIEhUVFAvSFRUUFMgc2VydmVyXG5cdFx0Y29uc3QgeyBzdGFydFNlcnZlciB9ID0gYXdhaXQgc2V0dXBIdHRwKHtcblx0XHRcdGFwcCxcblx0XHRcdHNvcHMsXG5cdFx0XHRmczogZnNQcm9taXNlcyxcblx0XHRcdGxvZ2dlcixcblx0XHRcdGNvbnN0YW50cyxcblx0XHRcdGdldEZlYXR1cmVGbGFnczogKCkgPT4gZ2V0RmVhdHVyZUZsYWdzKGxvZ2dlciksXG5cdFx0XHRnZXRSZWRpc0NsaWVudCxcblx0XHRcdGdldFNlcXVlbGl6ZUluc3RhbmNlOiAoKSA9PiBnZXRTZXF1ZWxpemVJbnN0YW5jZSh7IGxvZ2dlciB9KVxuXHRcdH0pO1xuXG5cdFx0c3RhcnRTZXJ2ZXIoKTtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRsb2dnZXIuZXJyb3IoJ1VuaGFuZGxlZCBlcnJvciBkdXJpbmcgc2VydmVyIGluaXRpYWxpemF0aW9uOicsIGVycm9yKTtcblx0XHRwcm9jZXNzLmV4aXQoMSk7XG5cdH1cbn1cblxuYXdhaXQgc3RhcnQoKTtcbiJdfQ==
