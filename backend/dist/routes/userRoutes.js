import express from 'express';
import argon2 from 'argon2';
import bcrypt from 'bcrypt';
import jwt from 'jsonwebtoken';
import axios from 'axios';
import zxcvbn from 'zxcvbn';
import { v4 as uuidv4 } from 'uuid';
import xss from 'xss';
import {
	generateConfirmationEmailTemplate,
	generateEmail2FACode,
	generateQRCode,
	generateTOTPSecret,
	getTransporter,
	verifyEmail2FACode,
	verifyTOTPToken
} from '../index.js';
import setupLogger from '../middleware/logger.js';
import getSecrets from '../config/secrets.js';
import UserModelPromise from '../models/User.js';
let router = express.Router();
// Password strength checker
let checkPasswordStrength = (password) => {
	let { score } = zxcvbn(password);
	return score >= 3;
};
// Register
router.post('/register', async (req, res) => {
	let { username, email, password, confirmPassword } = req.body;
	let secrets = await getSecrets();
	let logger = await setupLogger();
	// Sanitize inputs
	let sanitizedUsername = xss(username);
	let sanitizedEmail = xss(email);
	let sanitizedPassword = xss(password);
	if (sanitizedPassword !== confirmPassword) {
		logger.info('Registration failure: passwords do not match');
		return res
			.status(400)
			.json({ password: 'Registration failure: passwords do not match' });
	}
	let User = await UserModelPromise;
	if (!User.validatePassword(sanitizedPassword)) {
		logger.info(
			'Registration failure: passwords do not meet complexity requirements'
		);
		return res.status(400).json({
			password:
				'Registration failure: password does not meet complexity requirements'
		});
	}
	if (!checkPasswordStrength(sanitizedPassword)) {
		logger.info('Registration failure: password is too weak');
		return res
			.status(400)
			.json({ password: 'Registration failure: password is too weak' });
	}
	// let didHibpCheckFail = false; // *DEV-NOTE* need to figure out what, if anything, to do with this variable
	try {
		let pwnedResponse = await axios.get(
			`https://api.pwnedpasswords.com/range/${sanitizedPassword.substring(0, 5)}`
		);
		let pwnedList = pwnedResponse.data
			.split('\n')
			.map((p) => p.split(':')[0]);
		if (pwnedList.includes(sanitizedPassword.substring(5).toUpperCase())) {
			logger.warn(
				'Registration warning: password has been exposed in a data breach'
			);
			return res.status(400).json({
				password:
					'Registration warning: password has been exposed in a data breach'
			});
		}
	} catch (error) {
		console.error(error);
		logger.error('Registration error: HIBP API check failed');
		// didHibpCheckFail = true;
	}
	try {
		let user = await User.findOne({ where: { email: sanitizedEmail } });
		if (user) {
			logger.info('Registration failure: email already exists');
			return res
				.status(400)
				.json({ email: 'Registration failure: email already exists' });
		} else {
			let hashedPassword = await argon2.hash(
				sanitizedPassword + secrets.PEPPER,
				{
					type: argon2.argon2id
				}
			);
			let newUser = await User.create({
				id: uuidv4(),
				username: sanitizedUsername,
				password: hashedPassword,
				email: sanitizedEmail,
				isAccountVerified: false,
				resetPasswordToken: null, // Set to null initially
				resetPasswordExpires: null, // Set to null initially
				isMfaEnabled: false,
				creationDate: new Date()
			});
			// Generate a confirmation token
			let confirmationToken = jwt.sign(
				{ id: newUser.id },
				secrets.JWT_SECRET,
				{ expiresIn: '1d' }
			);
			let confirmationUrl = `http://localhost:${process.env.SERVER_PORT}/api/users/confirm/${confirmationToken}`;
			// Send confirmation email
			let mailOptions = {
				from: process.env.EMAIL_USER,
				to: newUser.email,
				subject: 'Guestbook - Account Confirmation',
				html: generateConfirmationEmailTemplate(
					newUser.username,
					confirmationUrl
				)
			};
			await (await getTransporter()).sendMail(mailOptions);
			logger.info('User registration complete');
			res.json({
				message:
					'Registration successful. Please check your email to confirm your account.'
			});
		}
	} catch (err) {
		logger.error('User Registration: server error: ', err);
		res.status(500).json({ error: 'User registration: server error' });
	}
	return;
});
// Login
router.post('/login', async (req, res) => {
	let secrets = await getSecrets();
	let logger = await setupLogger();
	let { email, password } = req.body;
	// sanitize inputs
	let sanitizedEmail = xss(email);
	let sanitizedPassword = xss(password);
	try {
		let User = await UserModelPromise;
		let user = await User.findOne({ where: { email: sanitizedEmail } });
		if (!user) {
			logger.info('400 - User not found');
			return res.status(400).json({ email: 'User not found' });
		}
		let isMatch = await argon2.verify(
			user.password,
			sanitizedPassword + secrets.PEPPER
		);
		if (isMatch) {
			let payload = { id: user.userid, username: user.username };
			let token = jwt.sign(payload, secrets.JWT_SECRET, {
				expiresIn: '1h'
			});
			res.json({ success: true, token: `Bearer ${token}` });
		} else {
			return res.status(400).json({ password: 'Incorrect password' });
		}
	} catch (err) {
		console.error(err);
		logger.error('Login - server error');
		res.status(500).json({ error: 'Login - Server error' });
	}
	return;
});
// Password Recovery (simplified)
router.post('/recover-password', async (req, res) => {
	let logger = await setupLogger();
	let { email } = req.body;
	// sanitize inputs
	let sanitizedEmail = xss(email);
	try {
		let User = await UserModelPromise;
		let user = await User.findOne({ where: { email: sanitizedEmail } });
		if (!user) {
			return res.status(404).json({ email: 'User not found' });
		}
		// Generate a token (customize this later)
		let token = await bcrypt.genSalt(25);
		// let passwordResetUrl = `https://localhost:${process.env.SERVER_PORT}/password-reset${token}`;
		// Store the token in the database (simplified for now)
		user.resetPasswordToken = token;
		user.resetPasswordExpires = new Date(Date.now() + 1800000); // 30 min
		await user.save();
		// Send password reset email
		logger.info('Password reset link sent to user ', user.email);
		res.json({ message: `Password reset link sent to ${user.email}` });
	} catch (err) {
		logger.error('Password Recovery - Server error: ', err);
		res.status(500).json({ error: 'Password Recovery - Server error' });
	}
	return;
});
// Route for TOTP secret generation
router.post('/generate-totp', async (req, res) => {
	let logger = await setupLogger();
	// let { username } = req.body; // *DEV-NOTE* does this even need to be here?
	// sanitize username input
	// let sanitizedUsername = xss(username); // *DEV-NOTE* or this?
	// *DEV-NOTE* here, we could store the secret in the session or send it to the client
	// depending on the use case; food for thought
	try {
		let { base32, otpauth_url } = generateTOTPSecret();
		let qrCodeUrl = await generateQRCode(otpauth_url);
		res.json({ secret: base32, qrCodeUrl });
	} catch (err) {
		logger.error('Error generating TOTP secret: ', err);
		res.status(500).json({ error: 'Internal server error' });
	}
});
// Route to verify TOTP tokens
router.post('/verify-totp', async (req, res) => {
	let logger = await setupLogger();
	// Extract token and secret from req.body
	let { token, secret } = req.body;
	try {
		// Verify the TOTP token using the provided secret
		let isTOTPTokenValid = verifyTOTPToken(secret, token);
		res.json({ isTOTPTokenValid });
	} catch (err) {
		logger.error('Error verifying TOTP token: ', err);
		res.status(500).json({ error: 'Internal server error' });
	}
	return;
});
// Route to generate and send 2FA codes by email
router.post('/generate-2fa', async (req, res) => {
	let logger = await setupLogger();
	let { email } = req.body;
	// sanitize email input
	let sanitizedEmail = xss(email);
	try {
		let User = await UserModelPromise;
		let user = await User.findOne({ where: { email: sanitizedEmail } });
		if (!user) {
			return res
				.status(404)
				.json({ error: 'Generate 2FA: user not found' });
		}
		// generate 2FA token
		let { email2FAToken } = await generateEmail2FACode();
		// save the 2FA token and expiration time in the user's record
		user.resetPasswordToken = email2FAToken;
		user.resetPasswordExpires = new Date(Date.now() + 30 * 60000); // 30 min
		await user.save(); // save the user data with the new 2FA token and expiration time
		// send the 2FA code to user's email
		await (
			await getTransporter()
		).sendMail({
			// send the 2FA code to user's email
			to: sanitizedEmail,
			subject: 'Guestbook - Your Login Code',
			text: `Your 2FA code is ${email2FAToken}`
		});
		// respond with success message
		res.json({ message: '2FA code sent to email' });
	} catch (err) {
		// log the error and respond with a 500 status message
		logger.error('Error generating 2FA code: ', err);
		res.status(500).json({ error: 'Generate 2FA: internal server error' });
	}
	return;
});
// Route to verify email 2FA code
router.post('/verify-2fa', async (req, res) => {
	let logger = await setupLogger();
	let { email, email2FACode } = req.body;
	// sanitize inputs
	let sanitizedEmail = xss(email);
	try {
		let User = await UserModelPromise;
		let user = await User.findOne({ where: { email: sanitizedEmail } });
		if (!user) {
			logger.error('Verify 2FA: user not found');
			return res
				.status(404)
				.json({ error: 'Verify 2FA: User not found' });
		}
		let resetPasswordToken = user.resetPasswordToken || '';
		let isEmail2FACodeValid = verifyEmail2FACode(
			resetPasswordToken,
			email2FACode
		);
		if (!isEmail2FACodeValid) {
			logger.error('Invalid or expired 2FA code');
			return res
				.status(400)
				.json({ error: 'Invalid or expired 2FA code' });
		}
		res.json({ message: '2FA code verified successfully' });
	} catch (err) {
		logger.error('Error verifying 2FA code:', err);
		res.status(500).json({ error: 'Internal server error' });
	}
	return;
});
export default router;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlclJvdXRlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXMvdXNlclJvdXRlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLE9BQThCLE1BQU0sU0FBUyxDQUFDO0FBQ3JELE9BQU8sTUFBTSxNQUFNLFFBQVEsQ0FBQztBQUM1QixPQUFPLE1BQU0sTUFBTSxRQUFRLENBQUM7QUFDNUIsT0FBTyxHQUFHLE1BQU0sY0FBYyxDQUFDO0FBQy9CLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMxQixPQUFPLE1BQU0sTUFBTSxRQUFRLENBQUM7QUFDNUIsT0FBTyxFQUFFLEVBQUUsSUFBSSxNQUFNLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDcEMsT0FBTyxHQUFHLE1BQU0sS0FBSyxDQUFDO0FBQ3RCLE9BQU8sRUFDTixpQ0FBaUMsRUFDakMsb0JBQW9CLEVBQ3BCLGNBQWMsRUFDZCxrQkFBa0IsRUFDbEIsY0FBYyxFQUNkLGtCQUFrQixFQUNsQixlQUFlLEVBQ2YsTUFBTSxhQUFhLENBQUM7QUFDckIsT0FBTyxXQUFXLE1BQU0sc0JBQXNCLENBQUM7QUFDL0MsT0FBTyxVQUFVLE1BQU0sbUJBQW1CLENBQUM7QUFDM0MsT0FBTyxnQkFBZ0IsTUFBTSxnQkFBZ0IsQ0FBQztBQUU5QyxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7QUFFOUIsNEJBQTRCO0FBQzVCLElBQUkscUJBQXFCLEdBQUcsQ0FBQyxRQUFnQixFQUFFLEVBQUU7SUFDaEQsSUFBSSxFQUFFLEtBQUssRUFBRSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNqQyxPQUFPLEtBQUssSUFBSSxDQUFDLENBQUM7QUFDbkIsQ0FBQyxDQUFDO0FBRUYsV0FBVztBQUNYLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7SUFDOUQsSUFBSSxF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QUFDLEdBQUcsQ0FBQztpQkFDWCxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsNkJBQTZCLEVBQUUsQ0FBQyxDQUFDO1FBQ2xELENBQUM7UUFFRCxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNkLE1BQU0sQ0FBQyxLQUFLLENBQUMsMkJBQTJCLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDL0MsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFFRCxPQUFPO0FBQ1IsQ0FBQyxDQUFDLENBQUM7QUFFSCxlQUFlLE1BQU0sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBleHByZXNzLCB7IFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgYXJnb24yIGZyb20gJ2FyZ29uMic7XG5pbXBvcnQgYmNyeXB0IGZyb20gJ2JjcnlwdCc7XG5pbXBvcnQgand0IGZyb20gJ2pzb253ZWJ0b2tlbic7XG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IHp4Y3ZibiBmcm9tICd6eGN2Ym4nO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XG5pbXBvcnQgeHNzIGZyb20gJ3hzcyc7XG5pbXBvcnQge1xuXHRnZW5lcmF0ZUNvbmZpcm1hdGlvbkVtYWlsVGVtcGxhdGUsXG5cdGdlbmVyYXRlRW1haWwyRkFDb2RlLFxuXHRnZW5lcmF0ZVFSQ29kZSxcblx0Z2VuZXJhdGVUT1RQU2VjcmV0LFxuXHRnZXRUcmFuc3BvcnRlcixcblx0dmVyaWZ5RW1haWwyRkFDb2RlLFxuXHR2ZXJpZnlUT1RQVG9rZW5cbn0gZnJvbSAnLi4vaW5kZXguanMnO1xuaW1wb3J0IHNldHVwTG9nZ2VyIGZyb20gJy4uL21pZGRsZXdhcmUvbG9nZ2VyJztcbmltcG9ydCBnZXRTZWNyZXRzIGZyb20gJy4uL2NvbmZpZy9zZWNyZXRzJztcbmltcG9ydCBVc2VyTW9kZWxQcm9taXNlIGZyb20gJy4uL21vZGVscy9Vc2VyJztcblxubGV0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG5cbi8vIFBhc3N3b3JkIHN0cmVuZ3RoIGNoZWNrZXJcbmxldCBjaGVja1Bhc3N3b3JkU3RyZW5ndGggPSAocGFzc3dvcmQ6IHN0cmluZykgPT4ge1xuXHRsZXQgeyBzY29yZSB9ID0genhjdmJuKHBhc3N3b3JkKTtcblx0cmV0dXJuIHNjb3JlID49IDM7XG59O1xuXG4vLyBSZWdpc3Rlclxucm91dGVyLnBvc3QoJy9yZWdpc3RlcicsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcblx0bGV0IHsgdXNlcm5hbWUsIGVtYWlsLCBwYXNzd29yZCwgY29uZmlybVBhc3N3b3JkIH0gPSByZXEuYm9keTtcblx0bGV0IHNlY3JldHMgPSBhd2FpdCBnZXRTZWNyZXRzKCk7XG5cdGxldCBsb2dnZXIgPSBhd2FpdCBzZXR1cExvZ2dlcigpO1xuXG5cdC8vIFNhbml0aXplIGlucHV0c1xuXHRsZXQgc2FuaXRpemVkVXNlcm5hbWUgPSB4c3ModXNlcm5hbWUpO1xuXHRsZXQgc2FuaXRpemVkRW1haWwgPSB4c3MoZW1haWwpO1xuXHRsZXQgc2FuaXRpemVkUGFzc3dvcmQgPSB4c3MocGFzc3dvcmQpO1xuXG5cdGlmIChzYW5pdGl6ZWRQYXNzd29yZCAhPT0gY29uZmlybVBhc3N3b3JkKSB7XG5cdFx0bG9nZ2VyLmluZm8oJ1JlZ2lzdHJhdGlvbiBmYWlsdXJlOiBwYXNzd29yZHMgZG8gbm90IG1hdGNoJyk7XG5cdFx0cmV0dXJuIHJlc1xuXHRcdFx0LnN0YXR1cyg0MDApXG5cdFx0XHQuanNvbih7IHBhc3N3b3JkOiAnUmVnaXN0cmF0aW9uIGZhaWx1cmU6IHBhc3N3b3JkcyBkbyBub3QgbWF0Y2gnIH0pO1xuXHR9XG5cblx0bGV0IFVzZXIgPSBhd2FpdCBVc2VyTW9kZWxQcm9taXNlO1xuXHRpZiAoIVVzZXIudmFsaWRhdGVQYXNzd29yZChzYW5pdGl6ZWRQYXNzd29yZCkpIHtcblx0XHRsb2dnZXIuaW5mbyhcblx0XHRcdCdSZWdpc3RyYXRpb24gZmFpbHVyZTogcGFzc3dvcmRzIGRvIG5vdCBtZWV0IGNvbXBsZXhpdHkgcmVxdWlyZW1lbnRzJ1xuXHRcdCk7XG5cdFx0cmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcblx0XHRcdHBhc3N3b3JkOlxuXHRcdFx0XHQnUmVnaXN0cmF0aW9uIGZhaWx1cmU6IHBhc3N3b3JkIGRvZXMgbm90IG1lZXQgY29tcGxleGl0eSByZXF1aXJlbWVudHMnXG5cdFx0fSk7XG5cdH1cblxuXHRpZiAoIWNoZWNrUGFzc3dvcmRTdHJlbmd0aChzYW5pdGl6ZWRQYXNzd29yZCkpIHtcblx0XHRsb2dnZXIuaW5mbygnUmVnaXN0cmF0aW9uIGZhaWx1cmU6IHBhc3N3b3JkIGlzIHRvbyB3ZWFrJyk7XG5cdFx0cmV0dXJuIHJlc1xuXHRcdFx0LnN0YXR1cyg0MDApXG5cdFx0XHQuanNvbih7IHBhc3N3b3JkOiAnUmVnaXN0cmF0aW9uIGZhaWx1cmU6IHBhc3N3b3JkIGlzIHRvbyB3ZWFrJyB9KTtcblx0fVxuXG5cdC8vIGxldCBkaWRIaWJwQ2hlY2tGYWlsID0gZmFsc2U7IC8vICpERVYtTk9URSogbmVlZCB0byBmaWd1cmUgb3V0IHdoYXQsIGlmIGFueXRoaW5nLCB0byBkbyB3aXRoIHRoaXMgdmFyaWFibGVcblxuXHR0cnkge1xuXHRcdGxldCBwd25lZFJlc3BvbnNlID0gYXdhaXQgYXhpb3MuZ2V0KFxuXHRcdFx0YGh0dHBzOi8vYXBpLnB3bmVkcGFzc3dvcmRzLmNvbS9yYW5nZS8ke3Nhbml0aXplZFBhc3N3b3JkLnN1YnN0cmluZygwLCA1KX1gXG5cdFx0KTtcblx0XHRsZXQgcHduZWRMaXN0ID0gcHduZWRSZXNwb25zZS5kYXRhXG5cdFx0XHQuc3BsaXQoJ1xcbicpXG5cdFx0XHQubWFwKChwOiBzdHJpbmcpID0+IHAuc3BsaXQoJzonKVswXSk7XG5cdFx0aWYgKHB3bmVkTGlzdC5pbmNsdWRlcyhzYW5pdGl6ZWRQYXNzd29yZC5zdWJzdHJpbmcoNSkudG9VcHBlckNhc2UoKSkpIHtcblx0XHRcdGxvZ2dlci53YXJuKFxuXHRcdFx0XHQnUmVnaXN0cmF0aW9uIHdhcm5pbmc6IHBhc3N3b3JkIGhhcyBiZWVuIGV4cG9zZWQgaW4gYSBkYXRhIGJyZWFjaCdcblx0XHRcdCk7XG5cdFx0XHRyZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuXHRcdFx0XHRwYXNzd29yZDpcblx0XHRcdFx0XHQnUmVnaXN0cmF0aW9uIHdhcm5pbmc6IHBhc3N3b3JkIGhhcyBiZWVuIGV4cG9zZWQgaW4gYSBkYXRhIGJyZWFjaCdcblx0XHRcdH0pO1xuXHRcdH1cblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRjb25zb2xlLmVycm9yKGVycm9yKTtcblx0XHRsb2dnZXIuZXJyb3IoJ1JlZ2lzdHJhdGlvbiBlcnJvcjogSElCUCBBUEkgY2hlY2sgZmFpbGVkJyk7XG5cdFx0Ly8gZGlkSGlicENoZWNrRmFpbCA9IHRydWU7XG5cdH1cblxuXHR0cnkge1xuXHRcdGxldCB1c2VyID0gYXdhaXQgVXNlci5maW5kT25lKHsgd2hlcmU6IHsgZW1haWw6IHNhbml0aXplZEVtYWlsIH0gfSk7XG5cdFx0aWYgKHVzZXIpIHtcblx0XHRcdGxvZ2dlci5pbmZvKCdSZWdpc3RyYXRpb24gZmFpbHVyZTogZW1haWwgYWxyZWFkeSBleGlzdHMnKTtcblx0XHRcdHJldHVybiByZXNcblx0XHRcdFx0LnN0YXR1cyg0MDApXG5cdFx0XHRcdC5qc29uKHsgZW1haWw6ICdSZWdpc3RyYXRpb24gZmFpbHVyZTogZW1haWwgYWxyZWFkeSBleGlzdHMnIH0pO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRsZXQgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCBhcmdvbjIuaGFzaChcblx0XHRcdFx0c2FuaXRpemVkUGFzc3dvcmQgKyBzZWNyZXRzLlBFUFBFUixcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHR5cGU6IGFyZ29uMi5hcmdvbjJpZFxuXHRcdFx0XHR9XG5cdFx0XHQpO1xuXHRcdFx0bGV0IG5ld1VzZXIgPSBhd2FpdCBVc2VyLmNyZWF0ZSh7XG5cdFx0XHRcdGlkOiB1dWlkdjQoKSxcblx0XHRcdFx0dXNlcm5hbWU6IHNhbml0aXplZFVzZXJuYW1lLFxuXHRcdFx0XHRwYXNzd29yZDogaGFzaGVkUGFzc3dvcmQsXG5cdFx0XHRcdGVtYWlsOiBzYW5pdGl6ZWRFbWFpbCxcblx0XHRcdFx0aXNBY2NvdW50VmVyaWZpZWQ6IGZhbHNlLFxuXHRcdFx0XHRyZXNldFBhc3N3b3JkVG9rZW46IG51bGwsIC8vIFNldCB0byBudWxsIGluaXRpYWxseVxuXHRcdFx0XHRyZXNldFBhc3N3b3JkRXhwaXJlczogbnVsbCwgLy8gU2V0IHRvIG51bGwgaW5pdGlhbGx5XG5cdFx0XHRcdGlzTWZhRW5hYmxlZDogZmFsc2UsXG5cdFx0XHRcdGNyZWF0aW9uRGF0ZTogbmV3IERhdGUoKVxuXHRcdFx0fSk7XG5cblx0XHRcdC8vIEdlbmVyYXRlIGEgY29uZmlybWF0aW9uIHRva2VuXG5cdFx0XHRsZXQgY29uZmlybWF0aW9uVG9rZW4gPSBqd3Quc2lnbihcblx0XHRcdFx0eyBpZDogbmV3VXNlci5pZCB9LFxuXHRcdFx0XHRzZWNyZXRzLkpXVF9TRUNSRVQsXG5cdFx0XHRcdHsgZXhwaXJlc0luOiAnMWQnIH1cblx0XHRcdCk7XG5cdFx0XHRsZXQgY29uZmlybWF0aW9uVXJsID0gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtwcm9jZXNzLmVudi5TRVJWRVJfUE9SVH0vYXBpL3VzZXJzL2NvbmZpcm0vJHtjb25maXJtYXRpb25Ub2tlbn1gO1xuXG5cdFx0XHQvLyBTZW5kIGNvbmZpcm1hdGlvbiBlbWFpbFxuXHRcdFx0bGV0IG1haWxPcHRpb25zID0ge1xuXHRcdFx0XHRmcm9tOiBwcm9jZXNzLmVudi5FTUFJTF9VU0VSLFxuXHRcdFx0XHR0bzogbmV3VXNlci5lbWFpbCxcblx0XHRcdFx0c3ViamVjdDogJ0d1ZXN0Ym9vayAtIEFjY291bnQgQ29uZmlybWF0aW9uJyxcblx0XHRcdFx0aHRtbDogZ2VuZXJhdGVDb25maXJtYXRpb25FbWFpbFRlbXBsYXRlKFxuXHRcdFx0XHRcdG5ld1VzZXIudXNlcm5hbWUsXG5cdFx0XHRcdFx0Y29uZmlybWF0aW9uVXJsXG5cdFx0XHRcdClcblx0XHRcdH07XG5cblx0XHRcdGF3YWl0IChhd2FpdCBnZXRUcmFuc3BvcnRlcigpKS5zZW5kTWFpbChtYWlsT3B0aW9ucyk7XG5cblx0XHRcdGxvZ2dlci5pbmZvKCdVc2VyIHJlZ2lzdHJhdGlvbiBjb21wbGV0ZScpO1xuXHRcdFx0cmVzLmpzb24oe1xuXHRcdFx0XHRtZXNzYWdlOlxuXHRcdFx0XHRcdCdSZWdpc3RyYXRpb24gc3VjY2Vzc2Z1bC4gUGxlYXNlIGNoZWNrIHlvdXIgZW1haWwgdG8gY29uZmlybSB5b3VyIGFjY291bnQuJ1xuXHRcdFx0fSk7XG5cdFx0fVxuXHR9IGNhdGNoIChlcnIpIHtcblx0XHRsb2dnZXIuZXJyb3IoJ1VzZXIgUmVnaXN0cmF0aW9uOiBzZXJ2ZXIgZXJyb3I6ICcsIGVycik7XG5cdFx0cmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ1VzZXIgcmVnaXN0cmF0aW9uOiBzZXJ2ZXIgZXJyb3InIH0pO1xuXHR9XG5cblx0cmV0dXJuO1xufSk7XG5cbi8vIExvZ2luXG5yb3V0ZXIucG9zdCgnL2xvZ2luJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuXHRsZXQgc2VjcmV0cyA9IGF3YWl0IGdldFNlY3JldHMoKTtcblx0bGV0IGxvZ2dlciA9IGF3YWl0IHNldHVwTG9nZ2VyKCk7XG5cdGxldCB7IGVtYWlsLCBwYXNzd29yZCB9ID0gcmVxLmJvZHk7XG5cblx0Ly8gc2FuaXRpemUgaW5wdXRzXG5cdGxldCBzYW5pdGl6ZWRFbWFpbCA9IHhzcyhlbWFpbCk7XG5cdGxldCBzYW5pdGl6ZWRQYXNzd29yZCA9IHhzcyhwYXNzd29yZCk7XG5cblx0dHJ5IHtcblx0XHRsZXQgVXNlciA9IGF3YWl0IFVzZXJNb2RlbFByb21pc2U7XG5cdFx0bGV0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRPbmUoeyB3aGVyZTogeyBlbWFpbDogc2FuaXRpemVkRW1haWwgfSB9KTtcblx0XHRpZiAoIXVzZXIpIHtcblx0XHRcdGxvZ2dlci5pbmZvKCc0MDAgLSBVc2VyIG5vdCBmb3VuZCcpO1xuXHRcdFx0cmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZW1haWw6ICdVc2VyIG5vdCBmb3VuZCcgfSk7XG5cdFx0fVxuXHRcdGxldCBpc01hdGNoID0gYXdhaXQgYXJnb24yLnZlcmlmeShcblx0XHRcdHVzZXIucGFzc3dvcmQsXG5cdFx0XHRzYW5pdGl6ZWRQYXNzd29yZCArIHNlY3JldHMuUEVQUEVSXG5cdFx0KTtcblx0XHRpZiAoaXNNYXRjaCkge1xuXHRcdFx0bGV0IHBheWxvYWQgPSB7IGlkOiB1c2VyLnVzZXJpZCwgdXNlcm5hbWU6IHVzZXIudXNlcm5hbWUgfTtcblx0XHRcdGxldCB0b2tlbiA9IGp3dC5zaWduKHBheWxvYWQsIHNlY3JldHMuSldUX1NFQ1JFVCwge1xuXHRcdFx0XHRleHBpcmVzSW46ICcxaCdcblx0XHRcdH0pO1xuXHRcdFx0cmVzLmpzb24oeyBzdWNjZXNzOiB0cnVlLCB0b2tlbjogYEJlYXJlciAke3Rva2VufWAgfSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IHBhc3N3b3JkOiAnSW5jb3JyZWN0IHBhc3N3b3JkJyB9KTtcblx0XHR9XG5cdH0gY2F0Y2ggKGVycikge1xuXHRcdGNvbnNvbGUuZXJyb3IoZXJyKTtcblx0XHRsb2dnZXIuZXJyb3IoJ0xvZ2luIC0gc2VydmVyIGVycm9yJyk7XG5cdFx0cmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0xvZ2luIC0gU2VydmVyIGVycm9yJyB9KTtcblx0fVxuXG5cdHJldHVybjtcbn0pO1xuXG4vLyBQYXNzd29yZCBSZWNvdmVyeSAoc2ltcGxpZmllZClcbnJvdXRlci5wb3N0KCcvcmVjb3Zlci1wYXNzd29yZCcsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcblx0bGV0IGxvZ2dlciA9IGF3YWl0IHNldHVwTG9nZ2VyKCk7XG5cdGxldCB7IGVtYWlsIH0gPSByZXEuYm9keTtcblxuXHQvLyBzYW5pdGl6ZSBpbnB1dHNcblx0bGV0IHNhbml0aXplZEVtYWlsID0geHNzKGVtYWlsKTtcblxuXHR0cnkge1xuXHRcdGxldCBVc2VyID0gYXdhaXQgVXNlck1vZGVsUHJvbWlzZTtcblx0XHRsZXQgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZSh7IHdoZXJlOiB7IGVtYWlsOiBzYW5pdGl6ZWRFbWFpbCB9IH0pO1xuXHRcdGlmICghdXNlcikge1xuXHRcdFx0cmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZW1haWw6ICdVc2VyIG5vdCBmb3VuZCcgfSk7XG5cdFx0fVxuXHRcdC8vIEdlbmVyYXRlIGEgdG9rZW4gKGN1c3RvbWl6ZSB0aGlzIGxhdGVyKVxuXHRcdGxldCB0b2tlbiA9IGF3YWl0IGJjcnlwdC5nZW5TYWx0KDI1KTtcblx0XHQvLyBsZXQgcGFzc3dvcmRSZXNldFVybCA9IGBodHRwczovL2xvY2FsaG9zdDoke3Byb2Nlc3MuZW52LlNFUlZFUl9QT1JUfS9wYXNzd29yZC1yZXNldCR7dG9rZW59YDtcblxuXHRcdC8vIFN0b3JlIHRoZSB0b2tlbiBpbiB0aGUgZGF0YWJhc2UgKHNpbXBsaWZpZWQgZm9yIG5vdylcblx0XHR1c2VyLnJlc2V0UGFzc3dvcmRUb2tlbiA9IHRva2VuO1xuXHRcdHVzZXIucmVzZXRQYXNzd29yZEV4cGlyZXMgPSBuZXcgRGF0ZShEYXRlLm5vdygpICsgMTgwMDAwMCk7IC8vIDMwIG1pblxuXHRcdGF3YWl0IHVzZXIuc2F2ZSgpO1xuXG5cdFx0Ly8gU2VuZCBwYXNzd29yZCByZXNldCBlbWFpbFxuXHRcdGxvZ2dlci5pbmZvKCdQYXNzd29yZCByZXNldCBsaW5rIHNlbnQgdG8gdXNlciAnLCB1c2VyLmVtYWlsKTtcblx0XHRyZXMuanNvbih7IG1lc3NhZ2U6IGBQYXNzd29yZCByZXNldCBsaW5rIHNlbnQgdG8gJHt1c2VyLmVtYWlsfWAgfSk7XG5cdH0gY2F0Y2ggKGVycikge1xuXHRcdGxvZ2dlci5lcnJvcignUGFzc3dvcmQgUmVjb3ZlcnkgLSBTZXJ2ZXIgZXJyb3I6ICcsIGVycik7XG5cdFx0cmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ1Bhc3N3b3JkIFJlY292ZXJ5IC0gU2VydmVyIGVycm9yJyB9KTtcblx0fVxuXG5cdHJldHVybjtcbn0pO1xuXG4vLyBSb3V0ZSBmb3IgVE9UUCBzZWNyZXQgZ2VuZXJhdGlvblxucm91dGVyLnBvc3QoJy9nZW5lcmF0ZS10b3RwJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuXHRsZXQgbG9nZ2VyID0gYXdhaXQgc2V0dXBMb2dnZXIoKTtcblx0Ly8gbGV0IHsgdXNlcm5hbWUgfSA9IHJlcS5ib2R5OyAvLyAqREVWLU5PVEUqIGRvZXMgdGhpcyBldmVuIG5lZWQgdG8gYmUgaGVyZT9cblxuXHQvLyBzYW5pdGl6ZSB1c2VybmFtZSBpbnB1dFxuXHQvLyBsZXQgc2FuaXRpemVkVXNlcm5hbWUgPSB4c3ModXNlcm5hbWUpOyAvLyAqREVWLU5PVEUqIG9yIHRoaXM/XG5cblx0Ly8gKkRFVi1OT1RFKiBoZXJlLCB3ZSBjb3VsZCBzdG9yZSB0aGUgc2VjcmV0IGluIHRoZSBzZXNzaW9uIG9yIHNlbmQgaXQgdG8gdGhlIGNsaWVudFxuXHQvLyBkZXBlbmRpbmcgb24gdGhlIHVzZSBjYXNlOyBmb29kIGZvciB0aG91Z2h0XG5cblx0dHJ5IHtcblx0XHRsZXQgeyBiYXNlMzIsIG90cGF1dGhfdXJsIH0gPSBnZW5lcmF0ZVRPVFBTZWNyZXQoKTtcblx0XHRsZXQgcXJDb2RlVXJsID0gYXdhaXQgZ2VuZXJhdGVRUkNvZGUob3RwYXV0aF91cmwpO1xuXHRcdHJlcy5qc29uKHsgc2VjcmV0OiBiYXNlMzIsIHFyQ29kZVVybCB9KTtcblx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0bG9nZ2VyLmVycm9yKCdFcnJvciBnZW5lcmF0aW5nIFRPVFAgc2VjcmV0OiAnLCBlcnIpO1xuXHRcdHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InIH0pO1xuXHR9XG59KTtcblxuLy8gUm91dGUgdG8gdmVyaWZ5IFRPVFAgdG9rZW5zXG5yb3V0ZXIucG9zdCgnL3ZlcmlmeS10b3RwJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuXHRsZXQgbG9nZ2VyID0gYXdhaXQgc2V0dXBMb2dnZXIoKTtcblxuXHQvLyBFeHRyYWN0IHRva2VuIGFuZCBzZWNyZXQgZnJvbSByZXEuYm9keVxuXHRsZXQgeyB0b2tlbiwgc2VjcmV0IH0gPSByZXEuYm9keTtcblxuXHR0cnkge1xuXHRcdC8vIFZlcmlmeSB0aGUgVE9UUCB0b2tlbiB1c2luZyB0aGUgcHJvdmlkZWQgc2VjcmV0XG5cdFx0bGV0IGlzVE9UUFRva2VuVmFsaWQgPSB2ZXJpZnlUT1RQVG9rZW4oc2VjcmV0LCB0b2tlbik7XG5cdFx0cmVzLmpzb24oeyBpc1RPVFBUb2tlblZhbGlkIH0pO1xuXHR9IGNhdGNoIChlcnIpIHtcblx0XHRsb2dnZXIuZXJyb3IoJ0Vycm9yIHZlcmlmeWluZyBUT1RQIHRva2VuOiAnLCBlcnIpO1xuXHRcdHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InIH0pO1xuXHR9XG5cblx0cmV0dXJuO1xufSk7XG5cbi8vIFJvdXRlIHRvIGdlbmVyYXRlIGFuZCBzZW5kIDJGQSBjb2RlcyBieSBlbWFpbFxucm91dGVyLnBvc3QoJy9nZW5lcmF0ZS0yZmEnLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG5cdGxldCBsb2dnZXIgPSBhd2FpdCBzZXR1cExvZ2dlcigpO1xuXHRsZXQgeyBlbWFpbCB9ID0gcmVxLmJvZHk7XG5cblx0Ly8gc2FuaXRpemUgZW1haWwgaW5wdXRcblx0bGV0IHNhbml0aXplZEVtYWlsID0geHNzKGVtYWlsKTtcblxuXHR0cnkge1xuXHRcdGxldCBVc2VyID0gYXdhaXQgVXNlck1vZGVsUHJvbWlzZTtcblx0XHRsZXQgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZSh7IHdoZXJlOiB7IGVtYWlsOiBzYW5pdGl6ZWRFbWFpbCB9IH0pO1xuXG5cdFx0aWYgKCF1c2VyKSB7XG5cdFx0XHRyZXR1cm4gcmVzXG5cdFx0XHRcdC5zdGF0dXMoNDA0KVxuXHRcdFx0XHQuanNvbih7IGVycm9yOiAnR2VuZXJhdGUgMkZBOiB1c2VyIG5vdCBmb3VuZCcgfSk7XG5cdFx0fVxuXG5cdFx0Ly8gZ2VuZXJhdGUgMkZBIHRva2VuXG5cdFx0bGV0IHsgZW1haWwyRkFUb2tlbiB9ID0gYXdhaXQgZ2VuZXJhdGVFbWFpbDJGQUNvZGUoKTtcblxuXHRcdC8vIHNhdmUgdGhlIDJGQSB0b2tlbiBhbmQgZXhwaXJhdGlvbiB0aW1lIGluIHRoZSB1c2VyJ3MgcmVjb3JkXG5cdFx0dXNlci5yZXNldFBhc3N3b3JkVG9rZW4gPSBlbWFpbDJGQVRva2VuO1xuXHRcdHVzZXIucmVzZXRQYXNzd29yZEV4cGlyZXMgPSBuZXcgRGF0ZShEYXRlLm5vdygpICsgMzAgKiA2MDAwMCk7IC8vIDMwIG1pblxuXHRcdGF3YWl0IHVzZXIuc2F2ZSgpOyAvLyBzYXZlIHRoZSB1c2VyIGRhdGEgd2l0aCB0aGUgbmV3IDJGQSB0b2tlbiBhbmQgZXhwaXJhdGlvbiB0aW1lXG5cblx0XHQvLyBzZW5kIHRoZSAyRkEgY29kZSB0byB1c2VyJ3MgZW1haWxcblx0XHRhd2FpdCAoXG5cdFx0XHRhd2FpdCBnZXRUcmFuc3BvcnRlcigpXG5cdFx0KS5zZW5kTWFpbCh7XG5cdFx0XHQvLyBzZW5kIHRoZSAyRkEgY29kZSB0byB1c2VyJ3MgZW1haWxcblx0XHRcdHRvOiBzYW5pdGl6ZWRFbWFpbCxcblx0XHRcdHN1YmplY3Q6ICdHdWVzdGJvb2sgLSBZb3VyIExvZ2luIENvZGUnLFxuXHRcdFx0dGV4dDogYFlvdXIgMkZBIGNvZGUgaXMgJHtlbWFpbDJGQVRva2VufWBcblx0XHR9KTtcblxuXHRcdC8vIHJlc3BvbmQgd2l0aCBzdWNjZXNzIG1lc3NhZ2Vcblx0XHRyZXMuanNvbih7IG1lc3NhZ2U6ICcyRkEgY29kZSBzZW50IHRvIGVtYWlsJyB9KTtcblx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0Ly8gbG9nIHRoZSBlcnJvciBhbmQgcmVzcG9uZCB3aXRoIGEgNTAwIHN0YXR1cyBtZXNzYWdlXG5cdFx0bG9nZ2VyLmVycm9yKCdFcnJvciBnZW5lcmF0aW5nIDJGQSBjb2RlOiAnLCBlcnIpO1xuXHRcdHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6ICdHZW5lcmF0ZSAyRkE6IGludGVybmFsIHNlcnZlciBlcnJvcicgfSk7XG5cdH1cblxuXHRyZXR1cm47XG59KTtcblxuLy8gUm91dGUgdG8gdmVyaWZ5IGVtYWlsIDJGQSBjb2RlXG5yb3V0ZXIucG9zdCgnL3ZlcmlmeS0yZmEnLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG5cdGxldCBsb2dnZXIgPSBhd2FpdCBzZXR1cExvZ2dlcigpO1xuXHRsZXQgeyBlbWFpbCwgZW1haWwyRkFDb2RlIH0gPSByZXEuYm9keTtcblxuXHQvLyBzYW5pdGl6ZSBpbnB1dHNcblx0bGV0IHNhbml0aXplZEVtYWlsID0geHNzKGVtYWlsKTtcblxuXHR0cnkge1xuXHRcdGxldCBVc2VyID0gYXdhaXQgVXNlck1vZGVsUHJvbWlzZTtcblx0XHRsZXQgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZSh7IHdoZXJlOiB7IGVtYWlsOiBzYW5pdGl6ZWRFbWFpbCB9IH0pO1xuXHRcdGlmICghdXNlcikge1xuXHRcdFx0bG9nZ2VyLmVycm9yKCdWZXJpZnkgMkZBOiB1c2VyIG5vdCBmb3VuZCcpO1xuXHRcdFx0cmV0dXJuIHJlc1xuXHRcdFx0XHQuc3RhdHVzKDQwNClcblx0XHRcdFx0Lmpzb24oeyBlcnJvcjogJ1ZlcmlmeSAyRkE6IFVzZXIgbm90IGZvdW5kJyB9KTtcblx0XHR9XG5cblx0XHRsZXQgcmVzZXRQYXNzd29yZFRva2VuID0gdXNlci5yZXNldFBhc3N3b3JkVG9rZW4gfHwgJyc7XG5cblx0XHRsZXQgaXNFbWFpbDJGQUNvZGVWYWxpZCA9IHZlcmlmeUVtYWlsMkZBQ29kZShcblx0XHRcdHJlc2V0UGFzc3dvcmRUb2tlbixcblx0XHRcdGVtYWlsMkZBQ29kZVxuXHRcdCk7XG5cdFx0aWYgKCFpc0VtYWlsMkZBQ29kZVZhbGlkKSB7XG5cdFx0XHRsb2dnZXIuZXJyb3IoJ0ludmFsaWQgb3IgZXhwaXJlZCAyRkEgY29kZScpO1xuXHRcdFx0cmV0dXJuIHJlc1xuXHRcdFx0XHQuc3RhdHVzKDQwMClcblx0XHRcdFx0Lmpzb24oeyBlcnJvcjogJ0ludmFsaWQgb3IgZXhwaXJlZCAyRkEgY29kZScgfSk7XG5cdFx0fVxuXG5cdFx0cmVzLmpzb24oeyBtZXNzYWdlOiAnMkZBIGNvZGUgdmVyaWZpZWQgc3VjY2Vzc2Z1bGx5JyB9KTtcblx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0bG9nZ2VyLmVycm9yKCdFcnJvciB2ZXJpZnlpbmcgMkZBIGNvZGU6JywgZXJyKTtcblx0XHRyZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyB9KTtcblx0fVxuXG5cdHJldHVybjtcbn0pO1xuXG5leHBvcnQgZGVmYXVsdCByb3V0ZXI7XG4iXX0=
