import express from 'express';
import { execSync } from 'child_process';
import path from 'path';
import zxcvbn from 'zxcvbn';
import nodemailer from 'nodemailer';
import sops from '../utils/sops';
import createEmail2FAUtil from '../auth/email2FAUtil';
import { environmentVariables } from '../config/environmentConfig';
import { validateDependencies } from '../utils/validateDependencies';
import { processError } from '../utils/processError';
import { hashPassword } from '../config/hashConfig';
const port = environmentVariables.serverPort;
function getDirectoryPath() {
	return path.resolve(process.cwd());
}
export default function initializeUserRoutes({
	logger,
	secrets,
	UserRoutes,
	argon2,
	jwt,
	axios,
	bcrypt,
	uuidv4,
	xss,
	generateConfirmationEmailTemplate,
	getTransporter,
	totpUtil
}) {
	try {
		validateDependencies(
			[
				{ name: 'logger', instance: logger },
				{ name: 'secrets', instance: secrets },
				{ name: 'UserRoutes', instance: UserRoutes },
				{ name: 'argon2', instance: argon2 },
				{ name: 'jwt', instance: jwt },
				{ name: 'axios', instance: axios },
				{ name: 'bcrypt', instance: bcrypt },
				{ name: 'uuidv4', instance: uuidv4 },
				{ name: 'xss', instance: xss },
				{
					name: 'generateConfirmationEmailTemplate',
					instance: generateConfirmationEmailTemplate
				},
				{ name: 'getTransporter', instance: getTransporter },
				{ name: 'totpUtil', instance: totpUtil }
			],
			logger
		);
	} catch (error) {
		processError(error, logger || console);
		throw error;
	}
	const router = express.Router();
	const checkPasswordStrength = password => {
		const { score } = zxcvbn(password);
		return score >= 3;
	};
	// Register route
	router.post('/register', async (req, res) => {
		try {
			const { username, email, password, confirmPassword } = req.body;
			const sanitizedUsername = xss(username);
			const sanitizedEmail = xss(email);
			const sanitizedPassword = xss(password);
			if (sanitizedPassword !== confirmPassword) {
				logger.debug('Registration failure: passwords do not match');
				return res.status(400).json({
					password: 'Registration failure: passwords do not match'
				});
			}
			if (!UserRoutes.validatePassword(sanitizedPassword, logger)) {
				logger.debug(
					'Registration failure: passwords do not meet complexity requirements'
				);
				return res.status(400).json({
					password:
						'Registration failure: password does not meet complexity requirements'
				});
			}
			if (!checkPasswordStrength(sanitizedPassword)) {
				logger.debug('Registration failure: password is too weak');
				return res.status(400).json({
					password: 'Registration failure: password is too weak'
				});
			}
			// check password exposure in breaches
			const pwnedResponse = await axios.get(
				`https://api.pwnedpasswords.com/range/${sanitizedPassword.substring(0, 5)}`
			);
			const pwnedList = pwnedResponse.data
				.split('\n')
				.map(p => p.split(':')[0]);
			if (
				pwnedList.includes(sanitizedPassword.substring(5).toUpperCase())
			) {
				logger.warn(
					'Registration warning: password exposed in a breach'
				);
				return res.status(400).json({
					password:
						'Warning! This password has been exposed in a data breach.'
				});
			}
			const existingUser = await UserRoutes.findOne({
				where: { email: sanitizedEmail }
			});
			if (existingUser) {
				logger.info('Registration failure: email already exists');
				return res.status(400).json({
					email: 'Registration failure: email already exists'
				});
			}
			const hashedPassword = await hashPassword({
				password: sanitizedPassword,
				secrets,
				logger
			});
			const newUser = await UserRoutes.create({
				id: uuidv4(),
				username: sanitizedUsername,
				password: hashedPassword,
				email: sanitizedEmail,
				isAccountVerified: false,
				resetPasswordToken: null,
				resetPasswordExpires: null,
				isMfaEnabled: false,
				creationDate: new Date()
			});
			const confirmationToken = jwt.sign(
				{ id: newUser.id },
				secrets.JWT_SECRET,
				{ expiresIn: '1d' }
			);
			const confirmationUrl = `http://localhost:${port}/api/users/confirm/${confirmationToken}`;
			// Send confirmation email
			const mailOptions = {
				from: environmentVariables.emailUser,
				to: newUser.email,
				subject: 'Guestbook - Account Confirmation',
				html: generateConfirmationEmailTemplate(
					newUser.username,
					confirmationUrl,
					logger
				)
			};
			const transporter = await getTransporter({
				nodemailer,
				getSecrets: () =>
					sops.getSecrets({ logger, execSync, getDirectoryPath }),
				emailUser: environmentVariables.emailUser,
				logger
			});
			await transporter.sendMail(mailOptions);
			logger.info(
				`User registration for ${newUser.username} complete. Confirmation email sent.`
			);
			return res.json({
				message: 'Account registered! Please confirm via email.'
			});
		} catch (err) {
			processError(err, logger || console);
			return res
				.status(500)
				.json({ error: 'Registration failed. Please try again.' });
		}
	});
	// login route
	router.post('/login', async (req, res) => {
		try {
			const { email, password } = req.body;
			const sanitizedEmail = xss(email);
			const sanitizedPassword = xss(password);
			const user = await UserRoutes.findOne({
				where: { email: sanitizedEmail }
			});
			if (!user) {
				logger.debug('400 - User not found');
				return res.status(400).json({ email: 'User not found' });
			}
			const isMatch = await argon2.verify(
				user.password,
				sanitizedPassword + secrets.PEPPER
			);
			if (isMatch) {
				const payload = { id: user.userid, username: user.username };
				const token = jwt.sign(payload, secrets.JWT_SECRET, {
					expiresIn: '1h'
				});
				return res.json({ success: true, token: `Bearer ${token}` });
			} else {
				return res.status(400).json({ password: 'Incorrect password' });
			}
		} catch (err) {
			processError(err, logger || console);
			return res.status(500).json({ error: 'Login - Server error' });
		}
	});
	// password recovery route
	router.post('/recover-password', async (req, res) => {
		const { email } = req.body;
		const sanitizedEmail = xss(email);
		try {
			const user = await UserRoutes.findOne({
				where: { email: sanitizedEmail }
			});
			if (!user) {
				logger.error('Recover password: User not found');
				return res.status(404).json({
					email: 'Unable to find your user account. Please try again.'
				});
			}
			const token = await bcrypt.genSalt(25);
			user.resetPasswordToken = token;
			user.resetPasswordExpires = new Date(Date.now() + 1800000); // 30 minutes
			await user.save();
			// send password reset email
			const transporter = await getTransporter({
				nodemailer,
				getSecrets: () =>
					sops.getSecrets({ logger, execSync, getDirectoryPath }),
				emailUser: environmentVariables.emailUser,
				logger
			});
			await transporter.sendMail({
				to: sanitizedEmail,
				subject: 'Guestbook - Password Reset',
				text: `You have requested a password reset. Please use the following token: ${token}. This token will expire in 30 minutes.`
			});
			logger.debug(`Password reset link sent to ${user.email}`);
			return res.json({
				message: `Password reset link sent to ${user.email}`
			});
		} catch (err) {
			processError(err, logger || console);
			return res.status(500).json({
				error: 'Password recovery failed due to an unknown error. Please try again.'
			});
		}
	});
	// route for TOTP secret generation
	router.post('/generate-totp', async (req, res) => {
		try {
			const { base32, otpauth_url } = totpUtil.generateTOTPSecret();
			const qrCodeUrl = await totpUtil.generateQRCode(otpauth_url);
			return res.json({ secret: base32, qrCodeUrl });
		} catch (err) {
			processError(err, logger || console);
			return res.status(500).json({
				error: 'Unable to generate TOTP secret. Please try again.'
			});
		}
	});
	// route for TOTP token verification
	router.post('/verify-totp', async (req, res) => {
		const { token, secret } = req.body;
		try {
			const isTOTPTokenValid = totpUtil.verifyTOTPToken(secret, token);
			return res.json({ isTOTPTokenValid });
		} catch (err) {
			processError(err, logger || console);
			return res.status(500).json({
				error: 'Unable to verify TOTP token. Please try again.'
			});
		}
	});
	// route to generate and send 2FA codes via email
	router.post('/generate-2fa', async (req, res) => {
		const { email } = req.body;
		const sanitizedEmail = xss(email);
		try {
			const user = await UserRoutes.findOne({
				where: { email: sanitizedEmail }
			});
			if (!user) {
				logger.error('Generate 2FA: User not found');
				return res
					.status(404)
					.json({ error: 'Generate 2FA: User not found' });
			}
			const email2FAUtil = await createEmail2FAUtil({
				logger,
				getSecrets: () =>
					sops.getSecrets({ logger, execSync, getDirectoryPath }),
				bcrypt,
				jwt
			});
			const { email2FAToken } = await email2FAUtil.generateEmail2FACode();
			user.resetPasswordToken = email2FAToken;
			user.resetPasswordExpires = new Date(Date.now() + 30 * 60000); // 30 minutes
			await user.save();
			const transporter = await getTransporter({
				nodemailer,
				getSecrets: () =>
					sops.getSecrets({ logger, execSync, getDirectoryPath }),
				emailUser: environmentVariables.emailUser,
				logger
			});
			await transporter.sendMail({
				to: sanitizedEmail,
				subject: 'Guestbook - Your Login Code',
				text: `Your 2FA code is ${email2FAToken}`
			});
			return res.json({ message: '2FA code sent to email' });
		} catch (err) {
			processError(err, logger || console);
			return res.status(500).json({
				error: 'Generate 2FA: internal server error'
			});
		}
	});
	// route to verify email 2FA code
	router.post('/verify-2fa', async (req, res) => {
		const { email, email2FACode } = req.body;
		const sanitizedEmail = xss(email);
		try {
			const user = await UserRoutes.findOne({
				where: { email: sanitizedEmail }
			});
			if (!user) {
				logger.error('Verify 2FA: User not found');
				return res
					.status(404)
					.json({ error: 'Verify 2FA: User not found' });
			}
			const resetPasswordToken = user.resetPasswordToken || '';
			const email2FAUtil = await createEmail2FAUtil({
				logger,
				getSecrets: () =>
					sops.getSecrets({ logger, execSync, getDirectoryPath }),
				bcrypt,
				jwt
			});
			const isEmail2FACodeValid = await email2FAUtil.verifyEmail2FACode(
				resetPasswordToken,
				email2FACode
			);
			if (!isEmail2FACodeValid) {
				logger.error('Invalid or expired 2FA code');
				return res
					.status(400)
					.json({ error: 'Invalid or expired 2FA code' });
			}
			return res.json({ message: '2FA code verified successfully' });
		} catch (err) {
			processError(err, logger || console);
			return res.status(500).json({ error: 'Internal server error' });
		}
	});
	return router;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlclJvdXRlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXMvdXNlclJvdXRlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLE9BQXNDLE1BQU0sU0FBUyxDQUFDO0FBQzdELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBS3hCLE9BQU8sTUFBTSxNQUFNLFFBQVEsQ0FBQztBQUk1QixPQUFPLFVBQVUsTUFBTSxZQUFZLENBQUM7QUFDcEMsT0FBTyxJQUFJLE1BQU0sZUFBZSxDQUFDO0FBQ2pDLE9BQU8sa0JBQWtCLE1BQU0sc0JBQXNCLENBQUM7QUFJdEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDbkUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDckUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3JELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQStDcEQsTUFBTSxJQUFJLEdBQUcsb0JBQW9CLENBQUMsVUFBVSxDQUFDO0FBRTdDLFNBQVMsZ0JBQWdCO0lBQ3hCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztBQUNwQyxDQUFDO0FBRUQsTUFBTSxDQUFDLE9BQU8sVUFBVSxvQkFBb0IsQ0FBQyxFQUM1QyxNQUFNLEVBQ04sT0FBTyxFQUNQLFVBQVUsRUFDVixNQUFNLEVBQ04sR0FBRyxFQUNILEtBQUssRUFDTCxNQUFNLEVBQ04sTUFBTSxFQUNOLEdBQUcsRUFDSCxpQ0FBaUMsRUFDakMsY0FBYyxFQUNkLFFBQVEsRUFDZTtJQUN2QixJQUFJLENBQUM7UUFDSixvQkFBb0IsQ0FDbkI7WUFDQyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFF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VSxDQUFDLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxnQkFBZ0IsRUFBRSxDQUFDO2dCQUN4RCxNQUFNO2dCQUNOLEdBQUc7YUFDSCxDQUFDLENBQUM7WUFFSCxNQUFNLG1CQUFtQixHQUFHLE1BQU0sWUFBWSxDQUFDLGtCQUFrQixDQUNoRSxrQkFBa0IsRUFDbEIsWUFBWSxDQUNaLENBQUM7WUFFRixJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztnQkFDMUIsTUFBTSxDQUFDLEtBQUssQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO2dCQUM1QyxPQUFPLEdBQUc7cUJBQ1IsTUFBTSxDQUFDLEdBQUcsQ0FBQztxQkFDWCxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsNkJBQTZCLEVBQUUsQ0FBQyxDQUFDO1lBQ2xELENBQUM7WUFFRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsQ0FBQyxDQUFDO1FBQ2hFLENBQUM7UUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1lBQ2QsWUFBWSxDQUFDLEdBQUcsRUFBRSxNQUFNLElBQUksT0FBTyxDQUFDLENBQUM7WUFDckMsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSx1QkFBdUIsRUFBRSxDQUFDLENBQUM7UUFDakUsQ0FBQztJQUNGLENBQUMsQ0FBQyxDQUFDO0lBRUgsT0FBTyxNQUFNLENBQUM7QUFDZixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV4cHJlc3MsIHsgUmVxdWVzdCwgUmVzcG9uc2UsIFJvdXRlciB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgZXhlY1N5bmMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGFyZ29uMiBmcm9tICdhcmdvbjInO1xuaW1wb3J0IGJjcnlwdCBmcm9tICdiY3J5cHQnO1xuaW1wb3J0IGp3dCBmcm9tICdqc29ud2VidG9rZW4nO1xuaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJztcbmltcG9ydCB6eGN2Ym4gZnJvbSAnenhjdmJuJztcbmltcG9ydCB7IHY0IGFzIHV1aWR2NCB9IGZyb20gJ3V1aWQnO1xuaW1wb3J0IHhzcyBmcm9tICd4c3MnO1xuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSAnLi4vY29uZmlnL2xvZ2dlcic7XG5pbXBvcnQgbm9kZW1haWxlciBmcm9tICdub2RlbWFpbGVyJztcbmltcG9ydCBzb3BzIGZyb20gJy4uL3V0aWxzL3NvcHMnO1xuaW1wb3J0IGNyZWF0ZUVtYWlsMkZBVXRpbCBmcm9tICcuLi9hdXRoL2VtYWlsMkZBVXRpbCc7XG5pbXBvcnQgY3JlYXRlVE9UUFV0aWwgZnJvbSAnLi4vYXV0aC90b3RwVXRpbCc7XG5pbXBvcnQgZ2VuZXJhdGVDb25maXJtYXRpb25FbWFpbFRlbXBsYXRlIGZyb20gJy4uL3RlbXBsYXRlcy9jb25maXJtYXRpb25FbWFpbFRlbXBsYXRlJztcbmltcG9ydCB7IGdldFRyYW5zcG9ydGVyIH0gZnJvbSAnLi4vY29uZmlnL21haWxlcic7XG5pbXBvcnQgeyBlbnZpcm9ubWVudFZhcmlhYmxlcyB9IGZyb20gJy4uL2NvbmZpZy9lbnZpcm9ubWVudENvbmZpZyc7XG5pbXBvcnQgeyB2YWxpZGF0ZURlcGVuZGVuY2llcyB9IGZyb20gJy4uL3V0aWxzL3ZhbGlkYXRlRGVwZW5kZW5jaWVzJztcbmltcG9ydCB7IHByb2Nlc3NFcnJvciB9IGZyb20gJy4uL3V0aWxzL3Byb2Nlc3NFcnJvcic7XG5pbXBvcnQgeyBoYXNoUGFzc3dvcmQgfSBmcm9tICcuLi9jb25maWcvaGFzaENvbmZpZyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVXNlclNlY3JldHMge1xuXHRKV1RfU0VDUkVUOiBzdHJpbmc7XG5cdFBFUFBFUjogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFVzZXJSb3V0ZXNNb2RlbCB7XG5cdHZhbGlkYXRlUGFzc3dvcmQ6IChwYXNzd29yZDogc3RyaW5nLCBsb2dnZXI6IExvZ2dlcikgPT4gYm9vbGVhbjtcblx0ZmluZE9uZTogKGNyaXRlcmlhOiBvYmplY3QpID0+IFByb21pc2U8VXNlckluc3RhbmNlIHwgbnVsbD47XG5cdGNyZWF0ZTogKHVzZXI6IFBhcnRpYWw8VXNlckluc3RhbmNlPikgPT4gUHJvbWlzZTxVc2VySW5zdGFuY2U+O1xufVxuXG5pbnRlcmZhY2UgVXNlckluc3RhbmNlIHtcblx0aWQ6IHN0cmluZztcblx0dXNlcmlkOiBudW1iZXI7XG5cdHVzZXJuYW1lOiBzdHJpbmc7XG5cdHBhc3N3b3JkOiBzdHJpbmc7XG5cdGVtYWlsOiBzdHJpbmc7XG5cdGlzQWNjb3VudFZlcmlmaWVkOiBib29sZWFuO1xuXHRyZXNldFBhc3N3b3JkVG9rZW46IHN0cmluZyB8IG51bGw7XG5cdHJlc2V0UGFzc3dvcmRFeHBpcmVzOiBEYXRlIHwgbnVsbDtcblx0aXNNZmFFbmFibGVkOiBib29sZWFuO1xuXHRjcmVhdGlvbkRhdGU6IERhdGU7XG5cdGNvbXBhcmVQYXNzd29yZDogKFxuXHRcdHBhc3N3b3JkOiBzdHJpbmcsXG5cdFx0YXJnb24yOiB0eXBlb2YgaW1wb3J0KCdhcmdvbjInKSxcblx0XHRzZWNyZXRzOiBVc2VyU2VjcmV0c1xuXHQpID0+IFByb21pc2U8Ym9vbGVhbj47XG5cdHNhdmU6ICgpID0+IFByb21pc2U8dm9pZD47XG59XG5cbmludGVyZmFjZSBVc2VyUm91dGVEZXBlbmRlbmNpZXMge1xuXHRsb2dnZXI6IExvZ2dlcjtcblx0c2VjcmV0czogVXNlclNlY3JldHM7XG5cdFVzZXJSb3V0ZXM6IFVzZXJSb3V0ZXNNb2RlbDtcblx0YXJnb24yOiB0eXBlb2YgYXJnb24yO1xuXHRqd3Q6IHR5cGVvZiBqd3Q7XG5cdGF4aW9zOiB0eXBlb2YgYXhpb3M7XG5cdGJjcnlwdDogdHlwZW9mIGJjcnlwdDtcblx0dXVpZHY0OiB0eXBlb2YgdXVpZHY0O1xuXHR4c3M6IHR5cGVvZiB4c3M7XG5cdGdlbmVyYXRlQ29uZmlybWF0aW9uRW1haWxUZW1wbGF0ZTogdHlwZW9mIGdlbmVyYXRlQ29uZmlybWF0aW9uRW1haWxUZW1wbGF0ZTtcblx0Z2V0VHJhbnNwb3J0ZXI6IHR5cGVvZiBnZXRUcmFuc3BvcnRlcjtcblx0dG90cFV0aWw6IFJldHVyblR5cGU8dHlwZW9mIGNyZWF0ZVRPVFBVdGlsPjtcbn1cblxuY29uc3QgcG9ydCA9IGVudmlyb25tZW50VmFyaWFibGVzLnNlcnZlclBvcnQ7XG5cbmZ1bmN0aW9uIGdldERpcmVjdG9yeVBhdGgoKTogc3RyaW5nIHtcblx0cmV0dXJuIHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpKTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gaW5pdGlhbGl6ZVVzZXJSb3V0ZXMoe1xuXHRsb2dnZXIsXG5cdHNlY3JldHMsXG5cdFVzZXJSb3V0ZXMsXG5cdGFyZ29uMixcblx0and0LFxuXHRheGlvcyxcblx0YmNyeXB0LFxuXHR1dWlkdjQsXG5cdHhzcyxcblx0Z2VuZXJhdGVDb25maXJtYXRpb25FbWFpbFRlbXBsYXRlLFxuXHRnZXRUcmFuc3BvcnRlcixcblx0dG90cFV0aWxcbn06IFVzZXJSb3V0ZURlcGVuZGVuY2llcyk6IFJvdXRlciB7XG5cdHRyeSB7XG5cdFx0dmFsaWRhdGVEZXBlbmRlbmNpZXMoXG5cdFx0XHRbXG5cdFx0XHRcdHsgbmFtZTogJ2xvZ2dlcicsIGluc3RhbmNlOiBsb2dnZXIgfSxcblx0XHRcdFx0eyBuYW1lOiAnc2VjcmV0cycsIGluc3RhbmNlOiBzZWNyZXRzIH0sXG5cdFx0XHRcdHsgbmFtZTogJ1VzZXJSb3V0ZXMnLCBpbnN0YW5jZTogVXNlclJvdXRlcyB9LFxuXHRcdFx0XHR7IG5hbWU6ICdhcmdvbjInLCBpbnN0YW5jZTogYXJnb24yIH0sXG5cdFx0XHRcdHsgbmFtZTogJ2p3dCcsIGluc3RhbmNlOiBqd3QgfSxcblx0XHRcdFx0eyBuYW1lOiAnYXhpb3MnLCBpbnN0YW5jZTogYXhpb3MgfSxcblx0XHRcdFx0eyBuYW1lOiAnYmNyeXB0JywgaW5zdGFuY2U6IGJjcnlwdCB9LFxuXHRcdFx0XHR7IG5hbWU6ICd1dWlkdjQnLCBpbnN0YW5jZTogdXVpZHY0IH0sXG5cdFx0XHRcdHsgbmFtZTogJ3hzcycsIGluc3RhbmNlOiB4c3MgfSxcblx0XHRcdFx0e1xuXHRcdFx0XHRcdG5hbWU6ICdnZW5lcmF0ZUNvbmZpcm1hdGlvbkVtYWlsVGVtcGxhdGUnLFxuXHRcdFx0XHRcdGluc3RhbmNlOiBnZW5lcmF0ZUNvbmZpcm1hdGlvbkVtYWlsVGVtcGxhdGVcblx0XHRcdFx0fSxcblx0XHRcdFx0eyBuYW1lOiAnZ2V0VHJhbnNwb3J0ZXInLCBpbnN0YW5jZTogZ2V0VHJhbnNwb3J0ZXIgfSxcblx0XHRcdFx0eyBuYW1lOiAndG90cFV0aWwnLCBpbnN0YW5jZTogdG90cFV0aWwgfVxuXHRcdFx0XSxcblx0XHRcdGxvZ2dlclxuXHRcdCk7XG5cdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0cHJvY2Vzc0Vycm9yKGVycm9yIGFzIEVycm9yLCBsb2dnZXIgfHwgY29uc29sZSk7XG5cdFx0dGhyb3cgZXJyb3I7XG5cdH1cblxuXHRjb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuXG5cdGNvbnN0IGNoZWNrUGFzc3dvcmRTdHJlbmd0aCA9IChwYXNzd29yZDogc3RyaW5nKTogYm9vbGVhbiA9PiB7XG5cdFx0Y29uc3QgeyBzY29yZSB9ID0genhjdmJuKHBhc3N3b3JkKTtcblx0XHRyZXR1cm4gc2NvcmUgPj0gMztcblx0fTtcblxuXHQvLyBSZWdpc3RlciByb3V0ZVxuXHRyb3V0ZXIucG9zdCgnL3JlZ2lzdGVyJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCB7IHVzZXJuYW1lLCBlbWFpbCwgcGFzc3dvcmQsIGNvbmZpcm1QYXNzd29yZCB9ID0gcmVxLmJvZHk7XG5cblx0XHRcdGNvbnN0IHNhbml0aXplZFVzZXJuYW1lID0geHNzKHVzZXJuYW1lKTtcblx0XHRcdGNvbnN0IHNhbml0aXplZEVtYWlsID0geHNzKGVtYWlsKTtcblx0XHRcdGNvbnN0IHNhbml0aXplZFBhc3N3b3JkID0geHNzKHBhc3N3b3JkKTtcblxuXHRcdFx0aWYgKHNhbml0aXplZFBhc3N3b3JkICE9PSBjb25maXJtUGFzc3dvcmQpIHtcblx0XHRcdFx0bG9nZ2VyLmRlYnVnKCdSZWdpc3RyYXRpb24gZmFpbHVyZTogcGFzc3dvcmRzIGRvIG5vdCBtYXRjaCcpO1xuXHRcdFx0XHRyZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuXHRcdFx0XHRcdHBhc3N3b3JkOiAnUmVnaXN0cmF0aW9uIGZhaWx1cmU6IHBhc3N3b3JkcyBkbyBub3QgbWF0Y2gnXG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoIVVzZXJSb3V0ZXMudmFsaWRhdGVQYXNzd29yZChzYW5pdGl6ZWRQYXNzd29yZCwgbG9nZ2VyKSkge1xuXHRcdFx0XHRsb2dnZXIuZGVidWcoXG5cdFx0XHRcdFx0J1JlZ2lzdHJhdGlvbiBmYWlsdXJlOiBwYXNzd29yZHMgZG8gbm90IG1lZXQgY29tcGxleGl0eSByZXF1aXJlbWVudHMnXG5cdFx0XHRcdCk7XG5cdFx0XHRcdHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG5cdFx0XHRcdFx0cGFzc3dvcmQ6XG5cdFx0XHRcdFx0XHQnUmVnaXN0cmF0aW9uIGZhaWx1cmU6IHBhc3N3b3JkIGRvZXMgbm90IG1lZXQgY29tcGxleGl0eSByZXF1aXJlbWVudHMnXG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoIWNoZWNrUGFzc3dvcmRTdHJlbmd0aChzYW5pdGl6ZWRQYXNzd29yZCkpIHtcblx0XHRcdFx0bG9nZ2VyLmRlYnVnKCdSZWdpc3RyYXRpb24gZmFpbHVyZTogcGFzc3dvcmQgaXMgdG9vIHdlYWsnKTtcblx0XHRcdFx0cmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcblx0XHRcdFx0XHRwYXNzd29yZDogJ1JlZ2lzdHJhdGlvbiBmYWlsdXJlOiBwYXNzd29yZCBpcyB0b28gd2Vhaydcblx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cblx0XHRcdC8vIGNoZWNrIHBhc3N3b3JkIGV4cG9zdXJlIGluIGJyZWFjaGVzXG5cdFx0XHRjb25zdCBwd25lZFJlc3BvbnNlID0gYXdhaXQgYXhpb3MuZ2V0KFxuXHRcdFx0XHRgaHR0cHM6Ly9hcGkucHduZWRwYXNzd29yZHMuY29tL3JhbmdlLyR7c2FuaXRpemVkUGFzc3dvcmQuc3Vic3RyaW5nKDAsIDUpfWBcblx0XHRcdCk7XG5cdFx0XHRjb25zdCBwd25lZExpc3QgPSBwd25lZFJlc3BvbnNlLmRhdGFcblx0XHRcdFx0LnNwbGl0KCdcXG4nKVxuXHRcdFx0XHQubWFwKChwOiBzdHJpbmcpID0+IHAuc3BsaXQoJzonKVswXSk7XG5cdFx0XHRpZiAoXG5cdFx0XHRcdHB3bmVkTGlzdC5pbmNsdWRlcyhzYW5pdGl6ZWRQYXNzd29yZC5zdWJzdHJpbmcoNSkudG9VcHBlckNhc2UoKSlcblx0XHRcdCkge1xuXHRcdFx0XHRsb2dnZXIud2Fybihcblx0XHRcdFx0XHQnUmVnaXN0cmF0aW9uIHdhcm5pbmc6IHBhc3N3b3JkIGV4cG9zZWQgaW4gYSBicmVhY2gnXG5cdFx0XHRcdCk7XG5cdFx0XHRcdHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG5cdFx0XHRcdFx0cGFzc3dvcmQ6XG5cdFx0XHRcdFx0XHQnV2FybmluZyEgVGhpcyBwYXNzd29yZCBoYXMgYmVlbiBleHBvc2VkIGluIGEgZGF0YSBicmVhY2guJ1xuXHRcdFx0XHR9KTtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgZXhpc3RpbmdVc2VyID0gYXdhaXQgVXNlclJvdXRlcy5maW5kT25lKHtcblx0XHRcdFx0d2hlcmU6IHsgZW1haWw6IHNhbml0aXplZEVtYWlsIH1cblx0XHRcdH0pO1xuXG5cdFx0XHRpZiAoZXhpc3RpbmdVc2VyKSB7XG5cdFx0XHRcdGxvZ2dlci5pbmZvKCdSZWdpc3RyYXRpb24gZmFpbHVyZTogZW1haWwgYWxyZWFkeSBleGlzdHMnKTtcblx0XHRcdFx0cmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcblx0XHRcdFx0XHRlbWFpbDogJ1JlZ2lzdHJhdGlvbiBmYWlsdXJlOiBlbWFpbCBhbHJlYWR5IGV4aXN0cydcblx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IGhhc2hlZFBhc3N3b3JkID0gYXdhaXQgaGFzaFBhc3N3b3JkKHtcblx0XHRcdFx0cGFzc3dvcmQ6IHNhbml0aXplZFBhc3N3b3JkLFxuXHRcdFx0XHRzZWNyZXRzLFxuXHRcdFx0XHRsb2dnZXJcblx0XHRcdH0pO1xuXG5cdFx0XHRjb25zdCBuZXdVc2VyID0gYXdhaXQgVXNlclJvdXRlcy5jcmVhdGUoe1xuXHRcdFx0XHRpZDogdXVpZHY0KCksXG5cdFx0XHRcdHVzZXJuYW1lOiBzYW5pdGl6ZWRVc2VybmFtZSxcblx0XHRcdFx0cGFzc3dvcmQ6IGhhc2hlZFBhc3N3b3JkLFxuXHRcdFx0XHRlbWFpbDogc2FuaXRpemVkRW1haWwsXG5cdFx0XHRcdGlzQWNjb3VudFZlcmlmaWVkOiBmYWxzZSxcblx0XHRcdFx0cmVzZXRQYXNzd29yZFRva2VuOiBudWxsLFxuXHRcdFx0XHRyZXNldFBhc3N3b3JkRXhwaXJlczogbnVsbCxcblx0XHRcdFx0aXNNZmFFbmFibGVkOiBmYWxzZSxcblx0XHRcdFx0Y3JlYXRpb25EYXRlOiBuZXcgRGF0ZSgpXG5cdFx0XHR9KTtcblxuXHRcdFx0Y29uc3QgY29uZmlybWF0aW9uVG9rZW4gPSBqd3Quc2lnbihcblx0XHRcdFx0eyBpZDogbmV3VXNlci5pZCB9LFxuXHRcdFx0XHRzZWNyZXRzLkpXVF9TRUNSRVQsXG5cdFx0XHRcdHsgZXhwaXJlc0luOiAnMWQnIH1cblx0XHRcdCk7XG5cdFx0XHRjb25zdCBjb25maXJtYXRpb25VcmwgPSBgaHR0cDovL2xvY2FsaG9zdDoke3BvcnR9L2FwaS91c2Vycy9jb25maXJtLyR7Y29uZmlybWF0aW9uVG9rZW59YDtcblxuXHRcdFx0Ly8gU2VuZCBjb25maXJtYXRpb24gZW1haWxcblx0XHRcdGNvbnN0IG1haWxPcHRpb25zID0ge1xuXHRcdFx0XHRmcm9tOiBlbnZpcm9ubWVudFZhcmlhYmxlcy5lbWFpbFVzZXIsXG5cdFx0XHRcdHRvOiBuZXdVc2VyLmVtYWlsLFxuXHRcdFx0XHRzdWJqZWN0OiAnR3Vlc3Rib29rIC0gQWNjb3VudCBDb25maXJtYXRpb24nLFxuXHRcdFx0XHRodG1sOiBnZW5lcmF0ZUNvbmZpcm1hdGlvbkVtYWlsVGVtcGxhdGUoXG5cdFx0XHRcdFx0bmV3VXNlci51c2VybmFtZSxcblx0XHRcdFx0XHRjb25maXJtYXRpb25VcmwsXG5cdFx0XHRcdFx0bG9nZ2VyXG5cdFx0XHRcdClcblx0XHRcdH07XG5cblx0XHRcdGNvbnN0IHRyYW5zcG9ydGVyID0gYXdhaXQgZ2V0VHJhbnNwb3J0ZXIoe1xuXHRcdFx0XHRub2RlbWFpbGVyLFxuXHRcdFx0XHRnZXRTZWNyZXRzOiAoKSA9PlxuXHRcdFx0XHRcdHNvcHMuZ2V0U2VjcmV0cyh7IGxvZ2dlciwgZXhlY1N5bmMsIGdldERpcmVjdG9yeVBhdGggfSksXG5cdFx0XHRcdGVtYWlsVXNlcjogZW52aXJvbm1lbnRWYXJpYWJsZXMuZW1haWxVc2VyIGFzIHN0cmluZyxcblx0XHRcdFx0bG9nZ2VyXG5cdFx0XHR9KTtcblxuXHRcdFx0YXdhaXQgdHJhbnNwb3J0ZXIuc2VuZE1haWwobWFpbE9wdGlvbnMpO1xuXG5cdFx0XHRsb2dnZXIuaW5mbyhcblx0XHRcdFx0YFVzZXIgcmVnaXN0cmF0aW9uIGZvciAke25ld1VzZXIudXNlcm5hbWV9IGNvbXBsZXRlLiBDb25maXJtYXRpb24gZW1haWwgc2VudC5gXG5cdFx0XHQpO1xuXHRcdFx0cmV0dXJuIHJlcy5qc29uKHtcblx0XHRcdFx0bWVzc2FnZTogJ0FjY291bnQgcmVnaXN0ZXJlZCEgUGxlYXNlIGNvbmZpcm0gdmlhIGVtYWlsLidcblx0XHRcdH0pO1xuXHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0cHJvY2Vzc0Vycm9yKGVyciwgbG9nZ2VyIHx8IGNvbnNvbGUpO1xuXHRcdFx0cmV0dXJuIHJlc1xuXHRcdFx0XHQuc3RhdHVzKDUwMClcblx0XHRcdFx0Lmpzb24oeyBlcnJvcjogJ1JlZ2lzdHJhdGlvbiBmYWlsZWQuIFBsZWFzZSB0cnkgYWdhaW4uJyB9KTtcblx0XHR9XG5cdH0pO1xuXG5cdC8vIGxvZ2luIHJvdXRlXG5cdHJvdXRlci5wb3N0KCcvbG9naW4nLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IHsgZW1haWwsIHBhc3N3b3JkIH0gPSByZXEuYm9keTtcblxuXHRcdFx0Y29uc3Qgc2FuaXRpemVkRW1haWwgPSB4c3MoZW1haWwpO1xuXHRcdFx0Y29uc3Qgc2FuaXRpemVkUGFzc3dvcmQgPSB4c3MocGFzc3dvcmQpO1xuXG5cdFx0XHRjb25zdCB1c2VyID0gYXdhaXQgVXNlclJvdXRlcy5maW5kT25lKHtcblx0XHRcdFx0d2hlcmU6IHsgZW1haWw6IHNhbml0aXplZEVtYWlsIH1cblx0XHRcdH0pO1xuXG5cdFx0XHRpZiAoIXVzZXIpIHtcblx0XHRcdFx0bG9nZ2VyLmRlYnVnKCc0MDAgLSBVc2VyIG5vdCBmb3VuZCcpO1xuXHRcdFx0XHRyZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlbWFpbDogJ1VzZXIgbm90IGZvdW5kJyB9KTtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgaXNNYXRjaCA9IGF3YWl0IGFyZ29uMi52ZXJpZnkoXG5cdFx0XHRcdHVzZXIucGFzc3dvcmQsXG5cdFx0XHRcdHNhbml0aXplZFBhc3N3b3JkICsgc2VjcmV0cy5QRVBQRVJcblx0XHRcdCk7XG5cblx0XHRcdGlmIChpc01hdGNoKSB7XG5cdFx0XHRcdGNvbnN0IHBheWxvYWQgPSB7IGlkOiB1c2VyLnVzZXJpZCwgdXNlcm5hbWU6IHVzZXIudXNlcm5hbWUgfTtcblx0XHRcdFx0Y29uc3QgdG9rZW4gPSBqd3Quc2lnbihwYXlsb2FkLCBzZWNyZXRzLkpXVF9TRUNSRVQsIHtcblx0XHRcdFx0XHRleHBpcmVzSW46ICcxaCdcblx0XHRcdFx0fSk7XG5cblx0XHRcdFx0cmV0dXJuIHJlcy5qc29uKHsgc3VjY2VzczogdHJ1ZSwgdG9rZW46IGBCZWFyZXIgJHt0b2tlbn1gIH0pO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0cmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgcGFzc3dvcmQ6ICdJbmNvcnJlY3QgcGFzc3dvcmQnIH0pO1xuXHRcdFx0fVxuXHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0cHJvY2Vzc0Vycm9yKGVyciwgbG9nZ2VyIHx8IGNvbnNvbGUpO1xuXHRcdFx0cmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6ICdMb2dpbiAtIFNlcnZlciBlcnJvcicgfSk7XG5cdFx0fVxuXHR9KTtcblxuXHQvLyBwYXNzd29yZCByZWNvdmVyeSByb3V0ZVxuXHRyb3V0ZXIucG9zdCgnL3JlY292ZXItcGFzc3dvcmQnLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG5cdFx0Y29uc3QgeyBlbWFpbCB9ID0gcmVxLmJvZHk7XG5cblx0XHRjb25zdCBzYW5pdGl6ZWRFbWFpbCA9IHhzcyhlbWFpbCk7XG5cblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgdXNlciA9IGF3YWl0IFVzZXJSb3V0ZXMuZmluZE9uZSh7XG5cdFx0XHRcdHdoZXJlOiB7IGVtYWlsOiBzYW5pdGl6ZWRFbWFpbCB9XG5cdFx0XHR9KTtcblx0XHRcdGlmICghdXNlcikge1xuXHRcdFx0XHRsb2dnZXIuZXJyb3IoJ1JlY292ZXIgcGFzc3dvcmQ6IFVzZXIgbm90IGZvdW5kJyk7XG5cdFx0XHRcdHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7XG5cdFx0XHRcdFx0ZW1haWw6ICdVbmFibGUgdG8gZmluZCB5b3VyIHVzZXIgYWNjb3VudC4gUGxlYXNlIHRyeSBhZ2Fpbi4nXG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCB0b2tlbiA9IGF3YWl0IGJjcnlwdC5nZW5TYWx0KDI1KTtcblx0XHRcdHVzZXIucmVzZXRQYXNzd29yZFRva2VuID0gdG9rZW47XG5cdFx0XHR1c2VyLnJlc2V0UGFzc3dvcmRFeHBpcmVzID0gbmV3IERhdGUoRGF0ZS5ub3coKSArIDE4MDAwMDApOyAvLyAzMCBtaW51dGVzXG5cdFx0XHRhd2FpdCB1c2VyLnNhdmUoKTtcblxuXHRcdFx0Ly8gc2VuZCBwYXNzd29yZCByZXNldCBlbWFpbFxuXHRcdFx0Y29uc3QgdHJhbnNwb3J0ZXIgPSBhd2FpdCBnZXRUcmFuc3BvcnRlcih7XG5cdFx0XHRcdG5vZGVtYWlsZXIsXG5cdFx0XHRcdGdldFNlY3JldHM6ICgpID0+XG5cdFx0XHRcdFx0c29wcy5nZXRTZWNyZXRzKHsgbG9nZ2VyLCBleGVjU3luYywgZ2V0RGlyZWN0b3J5UGF0aCB9KSxcblx0XHRcdFx0ZW1haWxVc2VyOiBlbnZpcm9ubWVudFZhcmlhYmxlcy5lbWFpbFVzZXIgYXMgc3RyaW5nLFxuXHRcdFx0XHRsb2dnZXJcblx0XHRcdH0pO1xuXG5cdFx0XHRhd2FpdCB0cmFuc3BvcnRlci5zZW5kTWFpbCh7XG5cdFx0XHRcdHRvOiBzYW5pdGl6ZWRFbWFpbCxcblx0XHRcdFx0c3ViamVjdDogJ0d1ZXN0Ym9vayAtIFBhc3N3b3JkIFJlc2V0Jyxcblx0XHRcdFx0dGV4dDogYFlvdSBoYXZlIHJlcXVlc3RlZCBhIHBhc3N3b3JkIHJlc2V0LiBQbGVhc2UgdXNlIHRoZSBmb2xsb3dpbmcgdG9rZW46ICR7dG9rZW59LiBUaGlzIHRva2VuIHdpbGwgZXhwaXJlIGluIDMwIG1pbnV0ZXMuYFxuXHRcdFx0fSk7XG5cblx0XHRcdGxvZ2dlci5kZWJ1ZyhgUGFzc3dvcmQgcmVzZXQgbGluayBzZW50IHRvICR7dXNlci5lbWFpbH1gKTtcblx0XHRcdHJldHVybiByZXMuanNvbih7XG5cdFx0XHRcdG1lc3NhZ2U6IGBQYXNzd29yZCByZXNldCBsaW5rIHNlbnQgdG8gJHt1c2VyLmVtYWlsfWBcblx0XHRcdH0pO1xuXHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0cHJvY2Vzc0Vycm9yKGVyciwgbG9nZ2VyIHx8IGNvbnNvbGUpO1xuXHRcdFx0cmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcblx0XHRcdFx0ZXJyb3I6ICdQYXNzd29yZCByZWNvdmVyeSBmYWlsZWQgZHVlIHRvIGFuIHVua25vd24gZXJyb3IuIFBsZWFzZSB0cnkgYWdhaW4uJ1xuXHRcdFx0fSk7XG5cdFx0fVxuXHR9KTtcblxuXHQvLyByb3V0ZSBmb3IgVE9UUCBzZWNyZXQgZ2VuZXJhdGlvblxuXHRyb3V0ZXIucG9zdCgnL2dlbmVyYXRlLXRvdHAnLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IHsgYmFzZTMyLCBvdHBhdXRoX3VybCB9ID0gdG90cFV0aWwuZ2VuZXJhdGVUT1RQU2VjcmV0KCk7XG5cdFx0XHRjb25zdCBxckNvZGVVcmwgPSBhd2FpdCB0b3RwVXRpbC5nZW5lcmF0ZVFSQ29kZShvdHBhdXRoX3VybCk7XG5cdFx0XHRyZXR1cm4gcmVzLmpzb24oeyBzZWNyZXQ6IGJhc2UzMiwgcXJDb2RlVXJsIH0pO1xuXHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0cHJvY2Vzc0Vycm9yKGVyciwgbG9nZ2VyIHx8IGNvbnNvbGUpO1xuXHRcdFx0cmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcblx0XHRcdFx0ZXJyb3I6ICdVbmFibGUgdG8gZ2VuZXJhdGUgVE9UUCBzZWNyZXQuIFBsZWFzZSB0cnkgYWdhaW4uJ1xuXHRcdFx0fSk7XG5cdFx0fVxuXHR9KTtcblxuXHQvLyByb3V0ZSBmb3IgVE9UUCB0b2tlbiB2ZXJpZmljYXRpb25cblx0cm91dGVyLnBvc3QoJy92ZXJpZnktdG90cCcsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcblx0XHRjb25zdCB7IHRva2VuLCBzZWNyZXQgfSA9IHJlcS5ib2R5O1xuXG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IGlzVE9UUFRva2VuVmFsaWQgPSB0b3RwVXRpbC52ZXJpZnlUT1RQVG9rZW4oc2VjcmV0LCB0b2tlbik7XG5cdFx0XHRyZXR1cm4gcmVzLmpzb24oeyBpc1RPVFBUb2tlblZhbGlkIH0pO1xuXHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0cHJvY2Vzc0Vycm9yKGVyciwgbG9nZ2VyIHx8IGNvbnNvbGUpO1xuXHRcdFx0cmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcblx0XHRcdFx0ZXJyb3I6ICdVbmFibGUgdG8gdmVyaWZ5IFRPVFAgdG9rZW4uIFBsZWFzZSB0cnkgYWdhaW4uJ1xuXHRcdFx0fSk7XG5cdFx0fVxuXHR9KTtcblxuXHQvLyByb3V0ZSB0byBnZW5lcmF0ZSBhbmQgc2VuZCAyRkEgY29kZXMgdmlhIGVtYWlsXG5cdHJvdXRlci5wb3N0KCcvZ2VuZXJhdGUtMmZhJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuXHRcdGNvbnN0IHsgZW1haWwgfSA9IHJlcS5ib2R5O1xuXG5cdFx0Y29uc3Qgc2FuaXRpemVkRW1haWwgPSB4c3MoZW1haWwpO1xuXG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyUm91dGVzLmZpbmRPbmUoe1xuXHRcdFx0XHR3aGVyZTogeyBlbWFpbDogc2FuaXRpemVkRW1haWwgfVxuXHRcdFx0fSk7XG5cblx0XHRcdGlmICghdXNlcikge1xuXHRcdFx0XHRsb2dnZXIuZXJyb3IoJ0dlbmVyYXRlIDJGQTogVXNlciBub3QgZm91bmQnKTtcblx0XHRcdFx0cmV0dXJuIHJlc1xuXHRcdFx0XHRcdC5zdGF0dXMoNDA0KVxuXHRcdFx0XHRcdC5qc29uKHsgZXJyb3I6ICdHZW5lcmF0ZSAyRkE6IFVzZXIgbm90IGZvdW5kJyB9KTtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgZW1haWwyRkFVdGlsID0gYXdhaXQgY3JlYXRlRW1haWwyRkFVdGlsKHtcblx0XHRcdFx0bG9nZ2VyLFxuXHRcdFx0XHRnZXRTZWNyZXRzOiAoKSA9PlxuXHRcdFx0XHRcdHNvcHMuZ2V0U2VjcmV0cyh7IGxvZ2dlciwgZXhlY1N5bmMsIGdldERpcmVjdG9yeVBhdGggfSksXG5cdFx0XHRcdGJjcnlwdCxcblx0XHRcdFx0and0XG5cdFx0XHR9KTtcblxuXHRcdFx0Y29uc3QgeyBlbWFpbDJGQVRva2VuIH0gPSBhd2FpdCBlbWFpbDJGQVV0aWwuZ2VuZXJhdGVFbWFpbDJGQUNvZGUoKTtcblxuXHRcdFx0dXNlci5yZXNldFBhc3N3b3JkVG9rZW4gPSBlbWFpbDJGQVRva2VuO1xuXHRcdFx0dXNlci5yZXNldFBhc3N3b3JkRXhwaXJlcyA9IG5ldyBEYXRlKERhdGUubm93KCkgKyAzMCAqIDYwMDAwKTsgLy8gMzAgbWludXRlc1xuXHRcdFx0YXdhaXQgdXNlci5zYXZlKCk7XG5cblx0XHRcdGNvbnN0IHRyYW5zcG9ydGVyID0gYXdhaXQgZ2V0VHJhbnNwb3J0ZXIoe1xuXHRcdFx0XHRub2RlbWFpbGVyLFxuXHRcdFx0XHRnZXRTZWNyZXRzOiAoKSA9PlxuXHRcdFx0XHRcdHNvcHMuZ2V0U2VjcmV0cyh7IGxvZ2dlciwgZXhlY1N5bmMsIGdldERpcmVjdG9yeVBhdGggfSksXG5cdFx0XHRcdGVtYWlsVXNlcjogZW52aXJvbm1lbnRWYXJpYWJsZXMuZW1haWxVc2VyIGFzIHN0cmluZyxcblx0XHRcdFx0bG9nZ2VyXG5cdFx0XHR9KTtcblxuXHRcdFx0YXdhaXQgdHJhbnNwb3J0ZXIuc2VuZE1haWwoe1xuXHRcdFx0XHR0bzogc2FuaXRpemVkRW1haWwsXG5cdFx0XHRcdHN1YmplY3Q6ICdHdWVzdGJvb2sgLSBZb3VyIExvZ2luIENvZGUnLFxuXHRcdFx0XHR0ZXh0OiBgWW91ciAyRkEgY29kZSBpcyAke2VtYWlsMkZBVG9rZW59YFxuXHRcdFx0fSk7XG5cblx0XHRcdHJldHVybiByZXMuanNvbih7IG1lc3NhZ2U6ICcyRkEgY29kZSBzZW50IHRvIGVtYWlsJyB9KTtcblx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdHByb2Nlc3NFcnJvcihlcnIsIGxvZ2dlciB8fCBjb25zb2xlKTtcblx0XHRcdHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG5cdFx0XHRcdGVycm9yOiAnR2VuZXJhdGUgMkZBOiBpbnRlcm5hbCBzZXJ2ZXIgZXJyb3InXG5cdFx0XHR9KTtcblx0XHR9XG5cdH0pO1xuXG5cdC8vIHJvdXRlIHRvIHZlcmlmeSBlbWFpbCAyRkEgY29kZVxuXHRyb3V0ZXIucG9zdCgnL3ZlcmlmeS0yZmEnLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG5cdFx0Y29uc3QgeyBlbWFpbCwgZW1haWwyRkFDb2RlIH0gPSByZXEuYm9keTtcblxuXHRcdGNvbnN0IHNhbml0aXplZEVtYWlsID0geHNzKGVtYWlsKTtcblxuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCB1c2VyID0gYXdhaXQgVXNlclJvdXRlcy5maW5kT25lKHtcblx0XHRcdFx0d2hlcmU6IHsgZW1haWw6IHNhbml0aXplZEVtYWlsIH1cblx0XHRcdH0pO1xuXHRcdFx0aWYgKCF1c2VyKSB7XG5cdFx0XHRcdGxvZ2dlci5lcnJvcignVmVyaWZ5IDJGQTogVXNlciBub3QgZm91bmQnKTtcblx0XHRcdFx0cmV0dXJuIHJlc1xuXHRcdFx0XHRcdC5zdGF0dXMoNDA0KVxuXHRcdFx0XHRcdC5qc29uKHsgZXJyb3I6ICdWZXJpZnkgMkZBOiBVc2VyIG5vdCBmb3VuZCcgfSk7XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IHJlc2V0UGFzc3dvcmRUb2tlbiA9IHVzZXIucmVzZXRQYXNzd29yZFRva2VuIHx8ICcnO1xuXG5cdFx0XHRjb25zdCBlbWFpbDJGQVV0aWwgPSBhd2FpdCBjcmVhdGVFbWFpbDJGQVV0aWwoe1xuXHRcdFx0XHRsb2dnZXIsXG5cdFx0XHRcdGdldFNlY3JldHM6ICgpID0+XG5cdFx0XHRcdFx0c29wcy5nZXRTZWNyZXRzKHsgbG9nZ2VyLCBleGVjU3luYywgZ2V0RGlyZWN0b3J5UGF0aCB9KSxcblx0XHRcdFx0YmNyeXB0LFxuXHRcdFx0XHRqd3Rcblx0XHRcdH0pO1xuXG5cdFx0XHRjb25zdCBpc0VtYWlsMkZBQ29kZVZhbGlkID0gYXdhaXQgZW1haWwyRkFVdGlsLnZlcmlmeUVtYWlsMkZBQ29kZShcblx0XHRcdFx0cmVzZXRQYXNzd29yZFRva2VuLFxuXHRcdFx0XHRlbWFpbDJGQUNvZGVcblx0XHRcdCk7XG5cblx0XHRcdGlmICghaXNFbWFpbDJGQUNvZGVWYWxpZCkge1xuXHRcdFx0XHRsb2dnZXIuZXJyb3IoJ0ludmFsaWQgb3IgZXhwaXJlZCAyRkEgY29kZScpO1xuXHRcdFx0XHRyZXR1cm4gcmVzXG5cdFx0XHRcdFx0LnN0YXR1cyg0MDApXG5cdFx0XHRcdFx0Lmpzb24oeyBlcnJvcjogJ0ludmFsaWQgb3IgZXhwaXJlZCAyRkEgY29kZScgfSk7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiByZXMuanNvbih7IG1lc3NhZ2U6ICcyRkEgY29kZSB2ZXJpZmllZCBzdWNjZXNzZnVsbHknIH0pO1xuXHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0cHJvY2Vzc0Vycm9yKGVyciwgbG9nZ2VyIHx8IGNvbnNvbGUpO1xuXHRcdFx0cmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InIH0pO1xuXHRcdH1cblx0fSk7XG5cblx0cmV0dXJuIHJvdXRlcjtcbn1cbiJdfQ==
