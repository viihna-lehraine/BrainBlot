import express from 'express';
import { execSync } from 'child_process';
import path from 'path';
import zxcvbn from 'zxcvbn';
import nodemailer from 'nodemailer';
import sops from '../utils/sops.mjs';
import createEmail2FAUtil from '../utils/auth/email2FAUtil.mjs';
function getDirectoryPath() {
	return path.resolve(process.cwd());
}
export default function createUserRoutes({
	logger,
	secrets,
	User,
	argon2,
	jwt,
	axios,
	bcrypt,
	uuidv4,
	xss,
	generateConfirmationEmailTemplate,
	getTransporter,
	totpUtil
}) {
	const router = express.Router();
	// Password strength checker
	const checkPasswordStrength = password => {
		const { score } = zxcvbn(password);
		return score >= 3;
	};
	// Register
	router.post('/register', async (req, res) => {
		const { username, email, password, confirmPassword } = req.body;
		// Sanitize inputs
		const sanitizedUsername = xss(username);
		const sanitizedEmail = xss(email);
		const sanitizedPassword = xss(password);
		if (sanitizedPassword !== confirmPassword) {
			logger.info('Registration failure: passwords do not match');
			return res.status(400).json({
				password: 'Registration failure: passwords do not match'
			});
		}
		if (!User.validatePassword(sanitizedPassword)) {
			logger.info(
				'Registration failure: passwords do not meet complexity requirements'
			);
			return res.status(400).json({
				password:
					'Registration failure: password does not meet complexity requirements'
			});
		}
		if (!checkPasswordStrength(sanitizedPassword)) {
			logger.info('Registration failure: password is too weak');
			return res.status(400).json({
				password: 'Registration failure: password is too weak'
			});
		}
		try {
			const pwnedResponse = await axios.get(
				`https://api.pwnedpasswords.com/range/${sanitizedPassword.substring(0, 5)}`
			);
			const pwnedList = pwnedResponse.data
				.split('\n')
				.map(p => p.split(':')[0]);
			if (
				pwnedList.includes(sanitizedPassword.substring(5).toUpperCase())
			) {
				logger.warn(
					'Registration warning: password has been exposed in a data breach'
				);
				return res.status(400).json({
					password:
						'Registration warning: password has been exposed in a data breach'
				});
			}
		} catch (error) {
			if (error instanceof Error) {
				logger.error(error.message);
				logger.error('Registration error: HIBP API check failed');
			} else {
				logger.error(String(error));
			}
		}
		try {
			const user = await User.findOne({
				where: { email: sanitizedEmail }
			});
			if (user) {
				logger.info('Registration failure: email already exists');
				return res.status(400).json({
					email: 'Registration failure: email already exists'
				});
			} else {
				const hashedPassword = await argon2.hash(
					sanitizedPassword + secrets.PEPPER,
					{
						type: argon2.argon2id
					}
				);
				const newUser = await User.create({
					id: uuidv4(),
					username: sanitizedUsername,
					password: hashedPassword,
					email: sanitizedEmail,
					isAccountVerified: false,
					resetPasswordToken: null,
					resetPasswordExpires: null,
					isMfaEnabled: false,
					creationDate: new Date()
				});
				// Generate a confirmation token
				const confirmationToken = jwt.sign(
					{ id: newUser.id },
					secrets.JWT_SECRET,
					{ expiresIn: '1d' }
				);
				const confirmationUrl = `http://localhost:${process.env.SERVER_PORT}/api/users/confirm/${confirmationToken}`;
				// Send confirmation email
				const mailOptions = {
					from: process.env.EMAIL_USER,
					to: newUser.email,
					subject: 'Guestbook - Account Confirmation',
					html: generateConfirmationEmailTemplate(
						newUser.username,
						confirmationUrl
					)
				};
				const transporter = await getTransporter({
					nodemailer,
					getSecrets: () =>
						sops.getSecrets({ logger, execSync, getDirectoryPath }),
					emailUser: process.env.EMAIL_USER
				});
				await transporter.sendMail(mailOptions);
				logger.info('User registration complete');
				res.json({
					message:
						'Registration successful. Please check your email to confirm your account.'
				});
			}
		} catch (err) {
			logger.error(`User Registration: server error: ${err}`);
			res.status(500).json({ error: 'User registration: server error' });
		}
		return;
	});
	// Login
	router.post('/login', async (req, res) => {
		const { email, password } = req.body;
		// Sanitize inputs
		const sanitizedEmail = xss(email);
		const sanitizedPassword = xss(password);
		try {
			const user = await User.findOne({
				where: { email: sanitizedEmail }
			});
			if (!user) {
				logger.info('400 - User not found');
				return res.status(400).json({ email: 'User not found' });
			}
			const isMatch = await argon2.verify(
				user.password,
				sanitizedPassword + secrets.PEPPER
			);
			if (isMatch) {
				const payload = { id: user.userid, username: user.username };
				const token = jwt.sign(payload, secrets.JWT_SECRET, {
					expiresIn: '1h'
				});
				res.json({ success: true, token: `Bearer ${token}` });
			} else {
				return res.status(400).json({ password: 'Incorrect password' });
			}
		} catch (err) {
			console.error(err);
			logger.error('Login - server error');
			res.status(500).json({ error: 'Login - Server error' });
		}
		return;
	});
	// Password Recovery (simplified)
	router.post('/recover-password', async (req, res) => {
		const { email } = req.body;
		// Sanitize inputs
		const sanitizedEmail = xss(email);
		try {
			const user = await User.findOne({
				where: { email: sanitizedEmail }
			});
			if (!user) {
				return res.status(404).json({ email: 'User not found' });
			}
			// Generate a token (customize this later)
			const token = await bcrypt.genSalt(25);
			// Store the token in the database (simplified for now)
			user.resetPasswordToken = token;
			user.resetPasswordExpires = new Date(Date.now() + 1800000); // 30 min
			await user.save();
			// Send password reset email
			logger.info(`Password reset link sent to user ${user.email}`);
			res.json({ message: `Password reset link sent to ${user.email}` });
		} catch (err) {
			logger.error(`Password Recovery - Server error: ${err}`);
			res.status(500).json({ error: 'Password Recovery - Server error' });
		}
		return;
	});
	// Route for TOTP secret generation
	router.post('/generate-totp', async (req, res) => {
		try {
			const { base32, otpauth_url } = totpUtil.generateTOTPSecret();
			const qrCodeUrl = await totpUtil.generateQRCode(otpauth_url);
			res.json({ secret: base32, qrCodeUrl });
		} catch (err) {
			logger.error(`Error generating TOTP secret: ${err}`);
			res.status(500).json({ error: 'Internal server error' });
		}
	});
	// Route to verify TOTP tokens
	router.post('/verify-totp', async (req, res) => {
		const { token, secret } = req.body;
		try {
			// Verify TOTP token using the secret
			const isTOTPTokenValid = totpUtil.verifyTOTPToken(secret, token);
			res.json({ isTOTPTokenValid });
		} catch (err) {
			logger.error(`Error verifying TOTP token: ${err}`);
			res.status(500).json({ error: 'Internal server error' });
		}
		return;
	});
	// Route to generate and send 2FA codes by email
	router.post('/generate-2fa', async (req, res) => {
		const { email } = req.body;
		// Sanitize email input
		const sanitizedEmail = xss(email);
		try {
			const user = await User.findOne({
				where: { email: sanitizedEmail }
			});
			if (!user) {
				return res
					.status(404)
					.json({ error: 'Generate 2FA: user not found' });
			}
			const email2FAUtil = await createEmail2FAUtil({
				logger,
				getSecrets: () =>
					sops.getSecrets({ logger, execSync, getDirectoryPath }),
				bcrypt,
				jwt
			});
			const { email2FAToken } = await email2FAUtil.generateEmail2FACode();
			// Save 2FA token and expiration in user's record
			user.resetPasswordToken = email2FAToken;
			user.resetPasswordExpires = new Date(Date.now() + 30 * 60000); // 30 min
			await user.save(); // Save user data with the new 2FA token and expiration
			// Send the 2FA code to user's email
			const transporter = await getTransporter({
				nodemailer,
				getSecrets: () =>
					sops.getSecrets({ logger, execSync, getDirectoryPath }),
				emailUser: process.env.EMAIL_USER
			});
			await transporter.sendMail({
				to: sanitizedEmail,
				subject: 'Guestbook - Your Login Code',
				text: `Your 2FA code is ${email2FAToken}`
			});
			res.json({ message: '2FA code sent to email' });
		} catch (err) {
			logger.error(`Error generating 2FA code: ', ${err}`);
			res.status(500).json({
				error: 'Generate 2FA: internal server error'
			});
		}
		return;
	});
	// Route to verify email 2FA code
	router.post('/verify-2fa', async (req, res) => {
		const { email, email2FACode } = req.body;
		// Sanitize inputs
		const sanitizedEmail = xss(email);
		try {
			const user = await User.findOne({
				where: { email: sanitizedEmail }
			});
			if (!user) {
				logger.error('Verify 2FA: user not found');
				return res
					.status(404)
					.json({ error: 'Verify 2FA: User not found' });
			}
			const resetPasswordToken = user.resetPasswordToken || '';
			const email2FAUtil = await createEmail2FAUtil({
				logger,
				getSecrets: () =>
					sops.getSecrets({ logger, execSync, getDirectoryPath }),
				bcrypt,
				jwt
			});
			const isEmail2FACodeValid = await email2FAUtil.verifyEmail2FACode(
				resetPasswordToken,
				email2FACode
			);
			if (!isEmail2FACodeValid) {
				logger.error('Invalid or expired 2FA code');
				return res
					.status(400)
					.json({ error: 'Invalid or expired 2FA code' });
			}
			res.json({ message: '2FA code verified successfully' });
		} catch (err) {
			logger.error(`Error verifying 2FA code:', ${err}`);
			res.status(500).json({ error: 'Internal server error' });
		}
		return;
	});
	return router;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlclJvdXRlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXMvdXNlclJvdXRlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLE9BQXNDLE1BQU0sU0FBUyxDQUFDO0FBQzdELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBS3hCLE9BQU8sTUFBTSxNQUFNLFFBQVEsQ0FBQztBQUk1QixPQUFPLFVBQVUsTUFBTSxZQUFZLENBQUM7QUFDcEMsT0FBTyxJQUFJLE1BQU0sZUFBZSxDQUFDO0FBQ2pDLE9BQU8sa0JBQWtCLE1BQU0sNEJBQTRCLENBQUM7QUFrRDVELFNBQVMsZ0JBQWdCO0lBQ3hCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztBQUNwQyxDQUFDO0FBRUQsTUFBTSxDQUFDLE9BQU8sVUFBVSxnQkFBZ0IsQ0FBQyxFQUN4QyxNQUFNLEVBQ04sT0FBTyxFQUNQLElBQUksRUFDSixNQUFNLEVBQ04sR0FBRyxFQUNILEtBQUssRUFDTCxNQUFNLEVBQ04sTUFBTSxFQUNOLEdBQUcsRUFDSCxpQ0FBaUMsRUFDakMsY0FBYyxFQUNkLFFBQVEsRUFDZTtJQUN2QixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7SUFFaEMsNEJBQTRCO0lBQzVCLE1BQU0scUJBQXFCLEdBQUcsQ0FBQyxRQUFnQixFQUFXLEVBQUU7UUFDM0QsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNuQyxPQUFPLEtBQUssSUFBSSxDQUFDLENBQUM7SUFDbkIsQ0FBQyxDQUFDO0lBRUYsV0FBVztJQUNYLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEtBQUssRUFBRSxHQUFZLEVBQUUsR0FBYSxFQUFFLEVBQUU7UUFDOUQs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Q0FBQztnQkFDeEQsTUFBTTtnQkFDTixHQUFHO2FBQ0gsQ0FBQyxDQUFDO1lBRUgsTUFBTSxtQkFBbUIsR0FBRyxNQUFNLFlBQVksQ0FBQyxrQkFBa0IsQ0FDaEUsa0JBQWtCLEVBQ2xCLFlBQVksQ0FDWixDQUFDO1lBQ0YsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7Z0JBQzFCLE1BQU0sQ0FBQyxLQUFLLENBQUMsNkJBQTZCLENBQUMsQ0FBQztnQkFDNUMsT0FBTyxHQUFHO3FCQUNSLE1BQU0sQ0FBQyxHQUFHLENBQUM7cUJBQ1gsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLDZCQUE2QixFQUFFLENBQUMsQ0FBQztZQUNsRCxDQUFDO1lBRUQsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxnQ0FBZ0MsRUFBRSxDQUFDLENBQUM7UUFDekQsQ0FBQztRQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7WUFDZCxNQUFNLENBQUMsS0FBSyxDQUFDLCtCQUErQixHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ25ELEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLHVCQUF1QixFQUFFLENBQUMsQ0FBQztRQUMxRCxDQUFDO1FBRUQsT0FBTztJQUNSLENBQUMsQ0FBQyxDQUFDO0lBRUgsT0FBTyxNQUFNLENBQUM7QUFDZixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV4cHJlc3MsIHsgUmVxdWVzdCwgUmVzcG9uc2UsIFJvdXRlciB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgZXhlY1N5bmMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGFyZ29uMiBmcm9tICdhcmdvbjInO1xuaW1wb3J0IGJjcnlwdCBmcm9tICdiY3J5cHQnO1xuaW1wb3J0IGp3dCBmcm9tICdqc29ud2VidG9rZW4nO1xuaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJztcbmltcG9ydCB6eGN2Ym4gZnJvbSAnenhjdmJuJztcbmltcG9ydCB7IHY0IGFzIHV1aWR2NCB9IGZyb20gJ3V1aWQnO1xuaW1wb3J0IHhzcyBmcm9tICd4c3MnO1xuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSAnd2luc3Rvbic7XG5pbXBvcnQgbm9kZW1haWxlciBmcm9tICdub2RlbWFpbGVyJztcbmltcG9ydCBzb3BzIGZyb20gJy4uL3V0aWxzL3NvcHMnO1xuaW1wb3J0IGNyZWF0ZUVtYWlsMkZBVXRpbCBmcm9tICcuLi91dGlscy9hdXRoL2VtYWlsMkZBVXRpbCc7XG5pbXBvcnQgY3JlYXRlVE9UUFV0aWwgZnJvbSAnLi4vdXRpbHMvYXV0aC90b3RwVXRpbCc7XG5pbXBvcnQgZ2VuZXJhdGVDb25maXJtYXRpb25FbWFpbFRlbXBsYXRlIGZyb20gJy4uL3V0aWxzL2VtYWlsVGVtcGxhdGVzL2NvbmZpcm1hdGlvbkVtYWlsVGVtcGxhdGUnO1xuaW1wb3J0IHsgZ2V0VHJhbnNwb3J0ZXIgfSBmcm9tICcuLi9jb25maWcvbWFpbGVyJztcblxuaW50ZXJmYWNlIFVzZXJTZWNyZXRzIHtcblx0SldUX1NFQ1JFVDogc3RyaW5nO1xuXHRQRVBQRVI6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIFVzZXJNb2RlbCB7XG5cdHZhbGlkYXRlUGFzc3dvcmQ6IChwYXNzd29yZDogc3RyaW5nKSA9PiBib29sZWFuO1xuXHRmaW5kT25lOiAoY3JpdGVyaWE6IG9iamVjdCkgPT4gUHJvbWlzZTxVc2VySW5zdGFuY2UgfCBudWxsPjtcblx0Y3JlYXRlOiAodXNlcjogUGFydGlhbDxVc2VySW5zdGFuY2U+KSA9PiBQcm9taXNlPFVzZXJJbnN0YW5jZT47XG59XG5cbmludGVyZmFjZSBVc2VySW5zdGFuY2Uge1xuXHRpZDogc3RyaW5nO1xuXHR1c2VyaWQ6IG51bWJlcjtcblx0dXNlcm5hbWU6IHN0cmluZztcblx0cGFzc3dvcmQ6IHN0cmluZztcblx0ZW1haWw6IHN0cmluZztcblx0aXNBY2NvdW50VmVyaWZpZWQ6IGJvb2xlYW47XG5cdHJlc2V0UGFzc3dvcmRUb2tlbjogc3RyaW5nIHwgbnVsbDtcblx0cmVzZXRQYXNzd29yZEV4cGlyZXM6IERhdGUgfCBudWxsO1xuXHRpc01mYUVuYWJsZWQ6IGJvb2xlYW47XG5cdGNyZWF0aW9uRGF0ZTogRGF0ZTtcblx0Y29tcGFyZVBhc3N3b3JkOiAoXG5cdFx0cGFzc3dvcmQ6IHN0cmluZyxcblx0XHRhcmdvbjI6IHR5cGVvZiBpbXBvcnQoJ2FyZ29uMicpLFxuXHRcdHNlY3JldHM6IFVzZXJTZWNyZXRzXG5cdCkgPT4gUHJvbWlzZTxib29sZWFuPjtcblx0c2F2ZTogKCkgPT4gUHJvbWlzZTx2b2lkPjtcbn1cblxuaW50ZXJmYWNlIFVzZXJSb3V0ZURlcGVuZGVuY2llcyB7XG5cdGxvZ2dlcjogTG9nZ2VyO1xuXHRzZWNyZXRzOiBVc2VyU2VjcmV0cztcblx0VXNlcjogVXNlck1vZGVsO1xuXHRhcmdvbjI6IHR5cGVvZiBhcmdvbjI7XG5cdGp3dDogdHlwZW9mIGp3dDtcblx0YXhpb3M6IHR5cGVvZiBheGlvcztcblx0YmNyeXB0OiB0eXBlb2YgYmNyeXB0O1xuXHR1dWlkdjQ6IHR5cGVvZiB1dWlkdjQ7XG5cdHhzczogdHlwZW9mIHhzcztcblx0Z2VuZXJhdGVDb25maXJtYXRpb25FbWFpbFRlbXBsYXRlOiB0eXBlb2YgZ2VuZXJhdGVDb25maXJtYXRpb25FbWFpbFRlbXBsYXRlO1xuXHRnZXRUcmFuc3BvcnRlcjogdHlwZW9mIGdldFRyYW5zcG9ydGVyO1xuXHR0b3RwVXRpbDogUmV0dXJuVHlwZTx0eXBlb2YgY3JlYXRlVE9UUFV0aWw+O1xufVxuXG5mdW5jdGlvbiBnZXREaXJlY3RvcnlQYXRoKCk6IHN0cmluZyB7XG5cdHJldHVybiBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGNyZWF0ZVVzZXJSb3V0ZXMoe1xuXHRsb2dnZXIsXG5cdHNlY3JldHMsXG5cdFVzZXIsXG5cdGFyZ29uMixcblx0and0LFxuXHRheGlvcyxcblx0YmNyeXB0LFxuXHR1dWlkdjQsXG5cdHhzcyxcblx0Z2VuZXJhdGVDb25maXJtYXRpb25FbWFpbFRlbXBsYXRlLFxuXHRnZXRUcmFuc3BvcnRlcixcblx0dG90cFV0aWxcbn06IFVzZXJSb3V0ZURlcGVuZGVuY2llcyk6IFJvdXRlciB7XG5cdGNvbnN0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG5cblx0Ly8gUGFzc3dvcmQgc3RyZW5ndGggY2hlY2tlclxuXHRjb25zdCBjaGVja1Bhc3N3b3JkU3RyZW5ndGggPSAocGFzc3dvcmQ6IHN0cmluZyk6IGJvb2xlYW4gPT4ge1xuXHRcdGNvbnN0IHsgc2NvcmUgfSA9IHp4Y3ZibihwYXNzd29yZCk7XG5cdFx0cmV0dXJuIHNjb3JlID49IDM7XG5cdH07XG5cblx0Ly8gUmVnaXN0ZXJcblx0cm91dGVyLnBvc3QoJy9yZWdpc3RlcicsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcblx0XHRjb25zdCB7IHVzZXJuYW1lLCBlbWFpbCwgcGFzc3dvcmQsIGNvbmZpcm1QYXNzd29yZCB9ID0gcmVxLmJvZHk7XG5cblx0XHQvLyBTYW5pdGl6ZSBpbnB1dHNcblx0XHRjb25zdCBzYW5pdGl6ZWRVc2VybmFtZSA9IHhzcyh1c2VybmFtZSk7XG5cdFx0Y29uc3Qgc2FuaXRpemVkRW1haWwgPSB4c3MoZW1haWwpO1xuXHRcdGNvbnN0IHNhbml0aXplZFBhc3N3b3JkID0geHNzKHBhc3N3b3JkKTtcblxuXHRcdGlmIChzYW5pdGl6ZWRQYXNzd29yZCAhPT0gY29uZmlybVBhc3N3b3JkKSB7XG5cdFx0XHRsb2dnZXIuaW5mbygnUmVnaXN0cmF0aW9uIGZhaWx1cmU6IHBhc3N3b3JkcyBkbyBub3QgbWF0Y2gnKTtcblx0XHRcdHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG5cdFx0XHRcdHBhc3N3b3JkOiAnUmVnaXN0cmF0aW9uIGZhaWx1cmU6IHBhc3N3b3JkcyBkbyBub3QgbWF0Y2gnXG5cdFx0XHR9KTtcblx0XHR9XG5cblx0XHRpZiAoIVVzZXIudmFsaWRhdGVQYXNzd29yZChzYW5pdGl6ZWRQYXNzd29yZCkpIHtcblx0XHRcdGxvZ2dlci5pbmZvKFxuXHRcdFx0XHQnUmVnaXN0cmF0aW9uIGZhaWx1cmU6IHBhc3N3b3JkcyBkbyBub3QgbWVldCBjb21wbGV4aXR5IHJlcXVpcmVtZW50cydcblx0XHRcdCk7XG5cdFx0XHRyZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuXHRcdFx0XHRwYXNzd29yZDpcblx0XHRcdFx0XHQnUmVnaXN0cmF0aW9uIGZhaWx1cmU6IHBhc3N3b3JkIGRvZXMgbm90IG1lZXQgY29tcGxleGl0eSByZXF1aXJlbWVudHMnXG5cdFx0XHR9KTtcblx0XHR9XG5cblx0XHRpZiAoIWNoZWNrUGFzc3dvcmRTdHJlbmd0aChzYW5pdGl6ZWRQYXNzd29yZCkpIHtcblx0XHRcdGxvZ2dlci5pbmZvKCdSZWdpc3RyYXRpb24gZmFpbHVyZTogcGFzc3dvcmQgaXMgdG9vIHdlYWsnKTtcblx0XHRcdHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG5cdFx0XHRcdHBhc3N3b3JkOiAnUmVnaXN0cmF0aW9uIGZhaWx1cmU6IHBhc3N3b3JkIGlzIHRvbyB3ZWFrJ1xuXHRcdFx0fSk7XG5cdFx0fVxuXG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IHB3bmVkUmVzcG9uc2UgPSBhd2FpdCBheGlvcy5nZXQoXG5cdFx0XHRcdGBodHRwczovL2FwaS5wd25lZHBhc3N3b3Jkcy5jb20vcmFuZ2UvJHtzYW5pdGl6ZWRQYXNzd29yZC5zdWJzdHJpbmcoMCwgNSl9YFxuXHRcdFx0KTtcblx0XHRcdGNvbnN0IHB3bmVkTGlzdCA9IHB3bmVkUmVzcG9uc2UuZGF0YVxuXHRcdFx0XHQuc3BsaXQoJ1xcbicpXG5cdFx0XHRcdC5tYXAoKHA6IHN0cmluZykgPT4gcC5zcGxpdCgnOicpWzBdKTtcblx0XHRcdGlmIChcblx0XHRcdFx0cHduZWRMaXN0LmluY2x1ZGVzKHNhbml0aXplZFBhc3N3b3JkLnN1YnN0cmluZyg1KS50b1VwcGVyQ2FzZSgpKVxuXHRcdFx0KSB7XG5cdFx0XHRcdGxvZ2dlci53YXJuKFxuXHRcdFx0XHRcdCdSZWdpc3RyYXRpb24gd2FybmluZzogcGFzc3dvcmQgaGFzIGJlZW4gZXhwb3NlZCBpbiBhIGRhdGEgYnJlYWNoJ1xuXHRcdFx0XHQpO1xuXHRcdFx0XHRyZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuXHRcdFx0XHRcdHBhc3N3b3JkOlxuXHRcdFx0XHRcdFx0J1JlZ2lzdHJhdGlvbiB3YXJuaW5nOiBwYXNzd29yZCBoYXMgYmVlbiBleHBvc2VkIGluIGEgZGF0YSBicmVhY2gnXG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHRpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcikge1xuXHRcdFx0XHRsb2dnZXIuZXJyb3IoZXJyb3IubWVzc2FnZSk7XG5cdFx0XHRcdGxvZ2dlci5lcnJvcignUmVnaXN0cmF0aW9uIGVycm9yOiBISUJQIEFQSSBjaGVjayBmYWlsZWQnKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGxvZ2dlci5lcnJvcihTdHJpbmcoZXJyb3IpKTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZSh7XG5cdFx0XHRcdHdoZXJlOiB7IGVtYWlsOiBzYW5pdGl6ZWRFbWFpbCB9XG5cdFx0XHR9KTtcblx0XHRcdGlmICh1c2VyKSB7XG5cdFx0XHRcdGxvZ2dlci5pbmZvKCdSZWdpc3RyYXRpb24gZmFpbHVyZTogZW1haWwgYWxyZWFkeSBleGlzdHMnKTtcblx0XHRcdFx0cmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcblx0XHRcdFx0XHRlbWFpbDogJ1JlZ2lzdHJhdGlvbiBmYWlsdXJlOiBlbWFpbCBhbHJlYWR5IGV4aXN0cydcblx0XHRcdFx0fSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRjb25zdCBoYXNoZWRQYXNzd29yZCA9IGF3YWl0IGFyZ29uMi5oYXNoKFxuXHRcdFx0XHRcdHNhbml0aXplZFBhc3N3b3JkICsgc2VjcmV0cy5QRVBQRVIsXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0dHlwZTogYXJnb24yLmFyZ29uMmlkXG5cdFx0XHRcdFx0fVxuXHRcdFx0XHQpO1xuXHRcdFx0XHRjb25zdCBuZXdVc2VyID0gYXdhaXQgVXNlci5jcmVhdGUoe1xuXHRcdFx0XHRcdGlkOiB1dWlkdjQoKSxcblx0XHRcdFx0XHR1c2VybmFtZTogc2FuaXRpemVkVXNlcm5hbWUsXG5cdFx0XHRcdFx0cGFzc3dvcmQ6IGhhc2hlZFBhc3N3b3JkLFxuXHRcdFx0XHRcdGVtYWlsOiBzYW5pdGl6ZWRFbWFpbCxcblx0XHRcdFx0XHRpc0FjY291bnRWZXJpZmllZDogZmFsc2UsXG5cdFx0XHRcdFx0cmVzZXRQYXNzd29yZFRva2VuOiBudWxsLFxuXHRcdFx0XHRcdHJlc2V0UGFzc3dvcmRFeHBpcmVzOiBudWxsLFxuXHRcdFx0XHRcdGlzTWZhRW5hYmxlZDogZmFsc2UsXG5cdFx0XHRcdFx0Y3JlYXRpb25EYXRlOiBuZXcgRGF0ZSgpXG5cdFx0XHRcdH0pO1xuXG5cdFx0XHRcdC8vIEdlbmVyYXRlIGEgY29uZmlybWF0aW9uIHRva2VuXG5cdFx0XHRcdGNvbnN0IGNvbmZpcm1hdGlvblRva2VuID0gand0LnNpZ24oXG5cdFx0XHRcdFx0eyBpZDogbmV3VXNlci5pZCB9LFxuXHRcdFx0XHRcdHNlY3JldHMuSldUX1NFQ1JFVCxcblx0XHRcdFx0XHR7IGV4cGlyZXNJbjogJzFkJyB9XG5cdFx0XHRcdCk7XG5cdFx0XHRcdGNvbnN0IGNvbmZpcm1hdGlvblVybCA9IGBodHRwOi8vbG9jYWxob3N0OiR7cHJvY2Vzcy5lbnYuU0VSVkVSX1BPUlR9L2FwaS91c2Vycy9jb25maXJtLyR7Y29uZmlybWF0aW9uVG9rZW59YDtcblxuXHRcdFx0XHQvLyBTZW5kIGNvbmZpcm1hdGlvbiBlbWFpbFxuXHRcdFx0XHRjb25zdCBtYWlsT3B0aW9ucyA9IHtcblx0XHRcdFx0XHRmcm9tOiBwcm9jZXNzLmVudi5FTUFJTF9VU0VSLFxuXHRcdFx0XHRcdHRvOiBuZXdVc2VyLmVtYWlsLFxuXHRcdFx0XHRcdHN1YmplY3Q6ICdHdWVzdGJvb2sgLSBBY2NvdW50IENvbmZpcm1hdGlvbicsXG5cdFx0XHRcdFx0aHRtbDogZ2VuZXJhdGVDb25maXJtYXRpb25FbWFpbFRlbXBsYXRlKFxuXHRcdFx0XHRcdFx0bmV3VXNlci51c2VybmFtZSxcblx0XHRcdFx0XHRcdGNvbmZpcm1hdGlvblVybFxuXHRcdFx0XHRcdClcblx0XHRcdFx0fTtcblxuXHRcdFx0XHRjb25zdCB0cmFuc3BvcnRlciA9IGF3YWl0IGdldFRyYW5zcG9ydGVyKHtcblx0XHRcdFx0XHRub2RlbWFpbGVyLFxuXHRcdFx0XHRcdGdldFNlY3JldHM6ICgpID0+XG5cdFx0XHRcdFx0XHRzb3BzLmdldFNlY3JldHMoeyBsb2dnZXIsIGV4ZWNTeW5jLCBnZXREaXJlY3RvcnlQYXRoIH0pLFxuXHRcdFx0XHRcdGVtYWlsVXNlcjogcHJvY2Vzcy5lbnYuRU1BSUxfVVNFUiBhcyBzdHJpbmdcblx0XHRcdFx0fSk7XG5cblx0XHRcdFx0YXdhaXQgdHJhbnNwb3J0ZXIuc2VuZE1haWwobWFpbE9wdGlvbnMpO1xuXG5cdFx0XHRcdGxvZ2dlci5pbmZvKCdVc2VyIHJlZ2lzdHJhdGlvbiBjb21wbGV0ZScpO1xuXHRcdFx0XHRyZXMuanNvbih7XG5cdFx0XHRcdFx0bWVzc2FnZTpcblx0XHRcdFx0XHRcdCdSZWdpc3RyYXRpb24gc3VjY2Vzc2Z1bC4gUGxlYXNlIGNoZWNrIHlvdXIgZW1haWwgdG8gY29uZmlybSB5b3VyIGFjY291bnQuJ1xuXHRcdFx0XHR9KTtcblx0XHRcdH1cblx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdGxvZ2dlci5lcnJvcihgVXNlciBSZWdpc3RyYXRpb246IHNlcnZlciBlcnJvcjogJHtlcnJ9YCk7XG5cdFx0XHRyZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnVXNlciByZWdpc3RyYXRpb246IHNlcnZlciBlcnJvcicgfSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuO1xuXHR9KTtcblxuXHQvLyBMb2dpblxuXHRyb3V0ZXIucG9zdCgnL2xvZ2luJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuXHRcdGNvbnN0IHsgZW1haWwsIHBhc3N3b3JkIH0gPSByZXEuYm9keTtcblxuXHRcdC8vIFNhbml0aXplIGlucHV0c1xuXHRcdGNvbnN0IHNhbml0aXplZEVtYWlsID0geHNzKGVtYWlsKTtcblx0XHRjb25zdCBzYW5pdGl6ZWRQYXNzd29yZCA9IHhzcyhwYXNzd29yZCk7XG5cblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZSh7XG5cdFx0XHRcdHdoZXJlOiB7IGVtYWlsOiBzYW5pdGl6ZWRFbWFpbCB9XG5cdFx0XHR9KTtcblx0XHRcdGlmICghdXNlcikge1xuXHRcdFx0XHRsb2dnZXIuaW5mbygnNDAwIC0gVXNlciBub3QgZm91bmQnKTtcblx0XHRcdFx0cmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZW1haWw6ICdVc2VyIG5vdCBmb3VuZCcgfSk7XG5cdFx0XHR9XG5cdFx0XHRjb25zdCBpc01hdGNoID0gYXdhaXQgYXJnb24yLnZlcmlmeShcblx0XHRcdFx0dXNlci5wYXNzd29yZCxcblx0XHRcdFx0c2FuaXRpemVkUGFzc3dvcmQgKyBzZWNyZXRzLlBFUFBFUlxuXHRcdFx0KTtcblx0XHRcdGlmIChpc01hdGNoKSB7XG5cdFx0XHRcdGNvbnN0IHBheWxvYWQgPSB7IGlkOiB1c2VyLnVzZXJpZCwgdXNlcm5hbWU6IHVzZXIudXNlcm5hbWUgfTtcblx0XHRcdFx0Y29uc3QgdG9rZW4gPSBqd3Quc2lnbihwYXlsb2FkLCBzZWNyZXRzLkpXVF9TRUNSRVQsIHtcblx0XHRcdFx0XHRleHBpcmVzSW46ICcxaCdcblx0XHRcdFx0fSk7XG5cdFx0XHRcdHJlcy5qc29uKHsgc3VjY2VzczogdHJ1ZSwgdG9rZW46IGBCZWFyZXIgJHt0b2tlbn1gIH0pO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0cmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgcGFzc3dvcmQ6ICdJbmNvcnJlY3QgcGFzc3dvcmQnIH0pO1xuXHRcdFx0fVxuXHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0Y29uc29sZS5lcnJvcihlcnIpO1xuXHRcdFx0bG9nZ2VyLmVycm9yKCdMb2dpbiAtIHNlcnZlciBlcnJvcicpO1xuXHRcdFx0cmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0xvZ2luIC0gU2VydmVyIGVycm9yJyB9KTtcblx0XHR9XG5cblx0XHRyZXR1cm47XG5cdH0pO1xuXG5cdC8vIFBhc3N3b3JkIFJlY292ZXJ5IChzaW1wbGlmaWVkKVxuXHRyb3V0ZXIucG9zdCgnL3JlY292ZXItcGFzc3dvcmQnLCBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG5cdFx0Y29uc3QgeyBlbWFpbCB9ID0gcmVxLmJvZHk7XG5cblx0XHQvLyBTYW5pdGl6ZSBpbnB1dHNcblx0XHRjb25zdCBzYW5pdGl6ZWRFbWFpbCA9IHhzcyhlbWFpbCk7XG5cblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZSh7XG5cdFx0XHRcdHdoZXJlOiB7IGVtYWlsOiBzYW5pdGl6ZWRFbWFpbCB9XG5cdFx0XHR9KTtcblx0XHRcdGlmICghdXNlcikge1xuXHRcdFx0XHRyZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBlbWFpbDogJ1VzZXIgbm90IGZvdW5kJyB9KTtcblx0XHRcdH1cblx0XHRcdC8vIEdlbmVyYXRlIGEgdG9rZW4gKGN1c3RvbWl6ZSB0aGlzIGxhdGVyKVxuXHRcdFx0Y29uc3QgdG9rZW4gPSBhd2FpdCBiY3J5cHQuZ2VuU2FsdCgyNSk7XG5cblx0XHRcdC8vIFN0b3JlIHRoZSB0b2tlbiBpbiB0aGUgZGF0YWJhc2UgKHNpbXBsaWZpZWQgZm9yIG5vdylcblx0XHRcdHVzZXIucmVzZXRQYXNzd29yZFRva2VuID0gdG9rZW47XG5cdFx0XHR1c2VyLnJlc2V0UGFzc3dvcmRFeHBpcmVzID0gbmV3IERhdGUoRGF0ZS5ub3coKSArIDE4MDAwMDApOyAvLyAzMCBtaW5cblx0XHRcdGF3YWl0IHVzZXIuc2F2ZSgpO1xuXG5cdFx0XHQvLyBTZW5kIHBhc3N3b3JkIHJlc2V0IGVtYWlsXG5cdFx0XHRsb2dnZXIuaW5mbyhgUGFzc3dvcmQgcmVzZXQgbGluayBzZW50IHRvIHVzZXIgJHt1c2VyLmVtYWlsfWApO1xuXHRcdFx0cmVzLmpzb24oeyBtZXNzYWdlOiBgUGFzc3dvcmQgcmVzZXQgbGluayBzZW50IHRvICR7dXNlci5lbWFpbH1gIH0pO1xuXHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0bG9nZ2VyLmVycm9yKGBQYXNzd29yZCBSZWNvdmVyeSAtIFNlcnZlciBlcnJvcjogJHtlcnJ9YCk7XG5cdFx0XHRyZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnUGFzc3dvcmQgUmVjb3ZlcnkgLSBTZXJ2ZXIgZXJyb3InIH0pO1xuXHRcdH1cblxuXHRcdHJldHVybjtcblx0fSk7XG5cblx0Ly8gUm91dGUgZm9yIFRPVFAgc2VjcmV0IGdlbmVyYXRpb25cblx0cm91dGVyLnBvc3QoJy9nZW5lcmF0ZS10b3RwJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCB7IGJhc2UzMiwgb3RwYXV0aF91cmwgfSA9IHRvdHBVdGlsLmdlbmVyYXRlVE9UUFNlY3JldCgpO1xuXHRcdFx0Y29uc3QgcXJDb2RlVXJsID0gYXdhaXQgdG90cFV0aWwuZ2VuZXJhdGVRUkNvZGUob3RwYXV0aF91cmwpO1xuXHRcdFx0cmVzLmpzb24oeyBzZWNyZXQ6IGJhc2UzMiwgcXJDb2RlVXJsIH0pO1xuXHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0bG9nZ2VyLmVycm9yKGBFcnJvciBnZW5lcmF0aW5nIFRPVFAgc2VjcmV0OiAke2Vycn1gKTtcblxuXHRcdFx0cmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicgfSk7XG5cdFx0fVxuXHR9KTtcblxuXHQvLyBSb3V0ZSB0byB2ZXJpZnkgVE9UUCB0b2tlbnNcblx0cm91dGVyLnBvc3QoJy92ZXJpZnktdG90cCcsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcblx0XHRjb25zdCB7IHRva2VuLCBzZWNyZXQgfSA9IHJlcS5ib2R5O1xuXG5cdFx0dHJ5IHtcblx0XHRcdC8vIFZlcmlmeSBUT1RQIHRva2VuIHVzaW5nIHRoZSBzZWNyZXRcblx0XHRcdGNvbnN0IGlzVE9UUFRva2VuVmFsaWQgPSB0b3RwVXRpbC52ZXJpZnlUT1RQVG9rZW4oc2VjcmV0LCB0b2tlbik7XG5cdFx0XHRyZXMuanNvbih7IGlzVE9UUFRva2VuVmFsaWQgfSk7XG5cdFx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0XHRsb2dnZXIuZXJyb3IoYEVycm9yIHZlcmlmeWluZyBUT1RQIHRva2VuOiAke2Vycn1gKTtcblx0XHRcdHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InIH0pO1xuXHRcdH1cblxuXHRcdHJldHVybjtcblx0fSk7XG5cblx0Ly8gUm91dGUgdG8gZ2VuZXJhdGUgYW5kIHNlbmQgMkZBIGNvZGVzIGJ5IGVtYWlsXG5cdHJvdXRlci5wb3N0KCcvZ2VuZXJhdGUtMmZhJywgYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuXHRcdGNvbnN0IHsgZW1haWwgfSA9IHJlcS5ib2R5O1xuXG5cdFx0Ly8gU2FuaXRpemUgZW1haWwgaW5wdXRcblx0XHRjb25zdCBzYW5pdGl6ZWRFbWFpbCA9IHhzcyhlbWFpbCk7XG5cblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZSh7XG5cdFx0XHRcdHdoZXJlOiB7IGVtYWlsOiBzYW5pdGl6ZWRFbWFpbCB9XG5cdFx0XHR9KTtcblxuXHRcdFx0aWYgKCF1c2VyKSB7XG5cdFx0XHRcdHJldHVybiByZXNcblx0XHRcdFx0XHQuc3RhdHVzKDQwNClcblx0XHRcdFx0XHQuanNvbih7IGVycm9yOiAnR2VuZXJhdGUgMkZBOiB1c2VyIG5vdCBmb3VuZCcgfSk7XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IGVtYWlsMkZBVXRpbCA9IGF3YWl0IGNyZWF0ZUVtYWlsMkZBVXRpbCh7XG5cdFx0XHRcdGxvZ2dlcixcblx0XHRcdFx0Z2V0U2VjcmV0czogKCkgPT5cblx0XHRcdFx0XHRzb3BzLmdldFNlY3JldHMoeyBsb2dnZXIsIGV4ZWNTeW5jLCBnZXREaXJlY3RvcnlQYXRoIH0pLFxuXHRcdFx0XHRiY3J5cHQsXG5cdFx0XHRcdGp3dFxuXHRcdFx0fSk7XG5cblx0XHRcdGNvbnN0IHsgZW1haWwyRkFUb2tlbiB9ID0gYXdhaXQgZW1haWwyRkFVdGlsLmdlbmVyYXRlRW1haWwyRkFDb2RlKCk7XG5cblx0XHRcdC8vIFNhdmUgMkZBIHRva2VuIGFuZCBleHBpcmF0aW9uIGluIHVzZXIncyByZWNvcmRcblx0XHRcdHVzZXIucmVzZXRQYXNzd29yZFRva2VuID0gZW1haWwyRkFUb2tlbjtcblx0XHRcdHVzZXIucmVzZXRQYXNzd29yZEV4cGlyZXMgPSBuZXcgRGF0ZShEYXRlLm5vdygpICsgMzAgKiA2MDAwMCk7IC8vIDMwIG1pblxuXHRcdFx0YXdhaXQgdXNlci5zYXZlKCk7IC8vIFNhdmUgdXNlciBkYXRhIHdpdGggdGhlIG5ldyAyRkEgdG9rZW4gYW5kIGV4cGlyYXRpb25cblxuXHRcdFx0Ly8gU2VuZCB0aGUgMkZBIGNvZGUgdG8gdXNlcidzIGVtYWlsXG5cdFx0XHRjb25zdCB0cmFuc3BvcnRlciA9IGF3YWl0IGdldFRyYW5zcG9ydGVyKHtcblx0XHRcdFx0bm9kZW1haWxlcixcblx0XHRcdFx0Z2V0U2VjcmV0czogKCkgPT5cblx0XHRcdFx0XHRzb3BzLmdldFNlY3JldHMoeyBsb2dnZXIsIGV4ZWNTeW5jLCBnZXREaXJlY3RvcnlQYXRoIH0pLFxuXHRcdFx0XHRlbWFpbFVzZXI6IHByb2Nlc3MuZW52LkVNQUlMX1VTRVIgYXMgc3RyaW5nXG5cdFx0XHR9KTtcblxuXHRcdFx0YXdhaXQgdHJhbnNwb3J0ZXIuc2VuZE1haWwoe1xuXHRcdFx0XHR0bzogc2FuaXRpemVkRW1haWwsXG5cdFx0XHRcdHN1YmplY3Q6ICdHdWVzdGJvb2sgLSBZb3VyIExvZ2luIENvZGUnLFxuXHRcdFx0XHR0ZXh0OiBgWW91ciAyRkEgY29kZSBpcyAke2VtYWlsMkZBVG9rZW59YFxuXHRcdFx0fSk7XG5cblx0XHRcdHJlcy5qc29uKHsgbWVzc2FnZTogJzJGQSBjb2RlIHNlbnQgdG8gZW1haWwnIH0pO1xuXHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0bG9nZ2VyLmVycm9yKGBFcnJvciBnZW5lcmF0aW5nIDJGQSBjb2RlOiAnLCAke2Vycn1gKTtcblx0XHRcdHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcblx0XHRcdFx0ZXJyb3I6ICdHZW5lcmF0ZSAyRkE6IGludGVybmFsIHNlcnZlciBlcnJvcidcblx0XHRcdH0pO1xuXHRcdH1cblxuXHRcdHJldHVybjtcblx0fSk7XG5cblx0Ly8gUm91dGUgdG8gdmVyaWZ5IGVtYWlsIDJGQSBjb2RlXG5cdHJvdXRlci5wb3N0KCcvdmVyaWZ5LTJmYScsIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcblx0XHRjb25zdCB7IGVtYWlsLCBlbWFpbDJGQUNvZGUgfSA9IHJlcS5ib2R5O1xuXG5cdFx0Ly8gU2FuaXRpemUgaW5wdXRzXG5cdFx0Y29uc3Qgc2FuaXRpemVkRW1haWwgPSB4c3MoZW1haWwpO1xuXG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRPbmUoe1xuXHRcdFx0XHR3aGVyZTogeyBlbWFpbDogc2FuaXRpemVkRW1haWwgfVxuXHRcdFx0fSk7XG5cdFx0XHRpZiAoIXVzZXIpIHtcblx0XHRcdFx0bG9nZ2VyLmVycm9yKCdWZXJpZnkgMkZBOiB1c2VyIG5vdCBmb3VuZCcpO1xuXHRcdFx0XHRyZXR1cm4gcmVzXG5cdFx0XHRcdFx0LnN0YXR1cyg0MDQpXG5cdFx0XHRcdFx0Lmpzb24oeyBlcnJvcjogJ1ZlcmlmeSAyRkE6IFVzZXIgbm90IGZvdW5kJyB9KTtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgcmVzZXRQYXNzd29yZFRva2VuID0gdXNlci5yZXNldFBhc3N3b3JkVG9rZW4gfHwgJyc7XG5cblx0XHRcdGNvbnN0IGVtYWlsMkZBVXRpbCA9IGF3YWl0IGNyZWF0ZUVtYWlsMkZBVXRpbCh7XG5cdFx0XHRcdGxvZ2dlcixcblx0XHRcdFx0Z2V0U2VjcmV0czogKCkgPT5cblx0XHRcdFx0XHRzb3BzLmdldFNlY3JldHMoeyBsb2dnZXIsIGV4ZWNTeW5jLCBnZXREaXJlY3RvcnlQYXRoIH0pLFxuXHRcdFx0XHRiY3J5cHQsXG5cdFx0XHRcdGp3dFxuXHRcdFx0fSk7XG5cblx0XHRcdGNvbnN0IGlzRW1haWwyRkFDb2RlVmFsaWQgPSBhd2FpdCBlbWFpbDJGQVV0aWwudmVyaWZ5RW1haWwyRkFDb2RlKFxuXHRcdFx0XHRyZXNldFBhc3N3b3JkVG9rZW4sXG5cdFx0XHRcdGVtYWlsMkZBQ29kZVxuXHRcdFx0KTtcblx0XHRcdGlmICghaXNFbWFpbDJGQUNvZGVWYWxpZCkge1xuXHRcdFx0XHRsb2dnZXIuZXJyb3IoJ0ludmFsaWQgb3IgZXhwaXJlZCAyRkEgY29kZScpO1xuXHRcdFx0XHRyZXR1cm4gcmVzXG5cdFx0XHRcdFx0LnN0YXR1cyg0MDApXG5cdFx0XHRcdFx0Lmpzb24oeyBlcnJvcjogJ0ludmFsaWQgb3IgZXhwaXJlZCAyRkEgY29kZScgfSk7XG5cdFx0XHR9XG5cblx0XHRcdHJlcy5qc29uKHsgbWVzc2FnZTogJzJGQSBjb2RlIHZlcmlmaWVkIHN1Y2Nlc3NmdWxseScgfSk7XG5cdFx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0XHRsb2dnZXIuZXJyb3IoYEVycm9yIHZlcmlmeWluZyAyRkEgY29kZTonLCAke2Vycn1gKTtcblx0XHRcdHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InIH0pO1xuXHRcdH1cblxuXHRcdHJldHVybjtcblx0fSk7XG5cblx0cmV0dXJuIHJvdXRlcjtcbn1cbiJdfQ==
