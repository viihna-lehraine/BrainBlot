import express from 'express';
import path from 'path';
import { environmentVariables } from '../config/environmentConfig';
import { validateDependencies } from '../utils/validateDependencies';
import { processError } from '../utils/processError';
const router = express.Router();
// Helper function to serve static files and handle errors
function serveStaticFile(filePath, route, res, next, logger) {
	try {
		validateDependencies(
			[
				{ name: 'filePath', instance: filePath },
				{ name: 'route', instance: route },
				{ name: 'res', instance: res },
				{ name: 'next', instance: next },
				{ name: 'logger', instance: logger }
			],
			logger || console
		);
		if (!filePath) {
			logger.error(`File path for ${route} is undefined.`);
			res.status(500).json({ error: `Internal server error` });
			return;
		}
		res.sendFile(filePath, err => {
			if (err) {
				processError(err, logger || console, undefined, console);
				return next(new Error(`File ${route} not found`));
			}
			logger.debug(`${route} was accessed`);
		});
	} catch (error) {
		processError(error, logger || console);
		next(error);
	}
}
export function setupStaticRoutes({
	logger,
	staticRootPath = environmentVariables.staticRootPath,
	appJsPath = environmentVariables.frontendAppJsPath,
	secretsPath = environmentVariables.frontendSecretsPath,
	browserConfigXmlPath = environmentVariables.frontendBrowserConfigXmlPath,
	humansMdPath = environmentVariables.frontendHumansMdPath,
	robotsTxtPath = environmentVariables.frontendRobotsTxtPath
}) {
	try {
		validateDependencies(
			[
				{ name: 'logger', instance: logger },
				{ name: 'staticRootPath', instance: staticRootPath },
				{ name: 'appJsPath', instance: appJsPath },
				{ name: 'secretsPath', instance: secretsPath },
				{
					name: 'browserConfigXmlPath',
					instance: browserConfigXmlPath
				},
				{ name: 'humansMdPath', instance: humansMdPath },
				{ name: 'robotsTxtPath', instance: robotsTxtPath }
			],
			logger || console
		);
		// middleware to log static asset access
		router.use((req, res, next) => {
			try {
				validateDependencies(
					[
						{ name: 'req', instance: req },
						{ name: 'res', instance: res },
						{ name: 'next', instance: next },
						{ name: 'logger', instance: logger }
					],
					logger
				);
				const assetTypes = [
					'css',
					'/mjs',
					'js',
					'/fonts',
					'/icons',
					'/images'
				];
				if (assetTypes.some(type => req.url.startsWith(type))) {
					logger.debug(`GET request received at ${req.url}`);
				}
				next();
			} catch (error) {
				processError(error, logger);
				next(error);
			}
		});
		// serve root HTML files
		router.get('/:page', (req, res, next) => {
			try {
				validateDependencies(
					[
						{ name: 'req', instance: req },
						{ name: 'res', instance: res },
						{ name: 'next', instance: next },
						{
							name: 'staticRootPath',
							instance: staticRootPath
						},
						{ name: 'logger', instance: logger }
					],
					logger
				);
				const page = req.params.page;
				const filePath = path.join(staticRootPath, `${page}.html`);
				serveStaticFile(filePath, `/${page}.html`, res, next, logger);
			} catch (error) {
				processError(error, logger, req);
				next(error);
			}
		});
		// serve static directories
		const staticDirectories = {
			css: path.join(staticRootPath, 'assets/css'),
			mjs: path.join(staticRootPath, 'assets/mjs'),
			js: path.join(staticRootPath, 'assets/js'),
			fonts: path.join(staticRootPath, 'assets/fonts'),
			icons: path.join(staticRootPath, 'assets/icons'),
			images: path.join(staticRootPath, 'assets/images')
		};
		Object.entries(staticDirectories).forEach(([route, dirPath]) => {
			router.use(`/${route}`, express.static(dirPath));
		});
		// serve specific static files
		const staticFiles = [
			{ route: '/app.js', filePath: appJsPath },
			{ route: '/secrets.json.gpg', filePath: secretsPath },
			{ route: '/browserconfig.xml', filePath: browserConfigXmlPath },
			{ route: '/humans.md', filePath: humansMdPath },
			{ route: '/robots.txt', filePath: robotsTxtPath }
		];
		staticFiles.forEach(file => {
			router.get(file.route, (_req, res, next) => {
				try {
					validateDependencies(
						[
							{ name: 'filePath', instance: file.filePath },
							{ name: 'route', instance: file.route },
							{ name: 'res', instance: res },
							{ name: 'next', instance: next },
							{ name: 'logger', instance: logger }
						],
						logger
					);
					logger.debug(`GET request received at ${file.route}`);
					serveStaticFile(
						file.filePath,
						file.route,
						res,
						next,
						logger
					);
				} catch (error) {
					processError(error, logger);
					next(error);
				}
			});
		});
		// 404 handler for unmatched routes
		router.use((req, res, next) => {
			try {
				validateDependencies(
					[
						{ name: 'req', instance: req },
						{ name: 'res', instance: res },
						{ name: 'next', instance: next },
						{ name: 'staticRootPath', instance: staticRootPath },
						{ name: 'logger', instance: logger }
					],
					logger
				);
				logger.info(`404 - ${req.url} was not found`);
				const notFoundFilePath = path.join(
					staticRootPath,
					'not-found.html'
				);
				// attempt to send the 404 file
				res.sendFile(notFoundFilePath, err => {
					if (err) {
						processError(err, logger, req);
						res.status(500).json({
							error: 'Internal server error'
						});
						return next(err);
					} else {
						logger.debug(
							`not-found.html was accessed for ${req.url}`
						);
					}
				});
			} catch (error) {
				processError(error, logger, req);
				next(error);
			}
		});
		return router;
	} catch (error) {
		processError(error, logger);
		throw error;
	}
}
export function initializeStaticRoutes(app, staticRootPath, logger) {
	try {
		validateDependencies(
			[
				{ name: 'app', instance: app },
				{ name: 'staticRootPath', instance: staticRootPath },
				{ name: 'logger', instance: logger }
			],
			logger
		);
		// set up the static routes
		const router = setupStaticRoutes({
			logger,
			staticRootPath,
			appJsPath: environmentVariables.frontendAppJsPath,
			secretsPath: environmentVariables.frontendSecretsPath,
			browserConfigXmlPath:
				environmentVariables.frontendBrowserConfigXmlPath,
			humansMdPath: environmentVariables.frontendHumansMdPath,
			robotsTxtPath: environmentVariables.frontendRobotsTxtPath
		});
		app.use('/', router);
	} catch (error) {
		processError(error, logger);
		throw error;
	}
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGljUm91dGVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3JvdXRlcy9zdGF0aWNSb3V0ZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxPQUE0QyxNQUFNLFNBQVMsQ0FBQztBQUNuRSxPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFFbkUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDckUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRXJELE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQVloQywwREFBMEQ7QUFDMUQsU0FBUyxlQUFlLENBQ3ZCLFFBQWdCLEVBQ2hCLEtBQWEsRUFDYixHQUFhLEVBQ2IsSUFBa0IsRUFDbEIsTUFBYztJQUVkLElBQUksQ0FBQztRQUNKLG9CQUFvQixDQUNuQjtZQUNDLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFO1lBQ3hDLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFO1lBQ2xDLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFO1lBQzlCLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFO1lBQ2hDLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFO1NBQ3BDLEVBQ0QsTUFBTSxJQUFJLE9BQU8sQ0FDakIsQ0FBQztRQUVGLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNmLE1BQU0sQ0FBQyxLQUFLLENBQUMsaUJBQWlCLEtBQUssZ0JBQWdCLENBQUMsQ0FBQztZQUNyRCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElB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ckMsTUFBTSxLQUFLLENBQUM7SUFDYixDQUFDO0FBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBleHByZXNzLCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZW52aXJvbm1lbnRWYXJpYWJsZXMgfSBmcm9tICcuLi9jb25maWcvZW52aXJvbm1lbnRDb25maWcnO1xuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSAnLi4vY29uZmlnL2xvZ2dlcic7XG5pbXBvcnQgeyB2YWxpZGF0ZURlcGVuZGVuY2llcyB9IGZyb20gJy4uL3V0aWxzL3ZhbGlkYXRlRGVwZW5kZW5jaWVzJztcbmltcG9ydCB7IHByb2Nlc3NFcnJvciB9IGZyb20gJy4uL3V0aWxzL3Byb2Nlc3NFcnJvcic7XG5cbmNvbnN0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG5cbmludGVyZmFjZSBTdGF0aWNSb3V0ZXNEZXBlbmRlbmNpZXMge1xuXHRsb2dnZXI6IExvZ2dlcjtcblx0c3RhdGljUm9vdFBhdGg6IHN0cmluZztcblx0YXBwSnNQYXRoOiBzdHJpbmc7XG5cdHNlY3JldHNQYXRoOiBzdHJpbmc7XG5cdGJyb3dzZXJDb25maWdYbWxQYXRoOiBzdHJpbmc7XG5cdGh1bWFuc01kUGF0aDogc3RyaW5nO1xuXHRyb2JvdHNUeHRQYXRoOiBzdHJpbmc7XG59XG5cbi8vIEhlbHBlciBmdW5jdGlvbiB0byBzZXJ2ZSBzdGF0aWMgZmlsZXMgYW5kIGhhbmRsZSBlcnJvcnNcbmZ1bmN0aW9uIHNlcnZlU3RhdGljRmlsZShcblx0ZmlsZVBhdGg6IHN0cmluZyxcblx0cm91dGU6IHN0cmluZyxcblx0cmVzOiBSZXNwb25zZSxcblx0bmV4dDogTmV4dEZ1bmN0aW9uLFxuXHRsb2dnZXI6IExvZ2dlclxuKTogdm9pZCB7XG5cdHRyeSB7XG5cdFx0dmFsaWRhdGVEZXBlbmRlbmNpZXMoXG5cdFx0XHRbXG5cdFx0XHRcdHsgbmFtZTogJ2ZpbGVQYXRoJywgaW5zdGFuY2U6IGZpbGVQYXRoIH0sXG5cdFx0XHRcdHsgbmFtZTogJ3JvdXRlJywgaW5zdGFuY2U6IHJvdXRlIH0sXG5cdFx0XHRcdHsgbmFtZTogJ3JlcycsIGluc3RhbmNlOiByZXMgfSxcblx0XHRcdFx0eyBuYW1lOiAnbmV4dCcsIGluc3RhbmNlOiBuZXh0IH0sXG5cdFx0XHRcdHsgbmFtZTogJ2xvZ2dlcicsIGluc3RhbmNlOiBsb2dnZXIgfVxuXHRcdFx0XSxcblx0XHRcdGxvZ2dlciB8fCBjb25zb2xlXG5cdFx0KTtcblxuXHRcdGlmICghZmlsZVBhdGgpIHtcblx0XHRcdGxvZ2dlci5lcnJvcihgRmlsZSBwYXRoIGZvciAke3JvdXRlfSBpcyB1bmRlZmluZWQuYCk7XG5cdFx0XHRyZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiBgSW50ZXJuYWwgc2VydmVyIGVycm9yYCB9KTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRyZXMuc2VuZEZpbGUoZmlsZVBhdGgsIGVyciA9PiB7XG5cdFx0XHRpZiAoZXJyKSB7XG5cdFx0XHRcdHByb2Nlc3NFcnJvcihlcnIsIGxvZ2dlciB8fCBjb25zb2xlLCB1bmRlZmluZWQsIGNvbnNvbGUpO1xuXHRcdFx0XHRyZXR1cm4gbmV4dChuZXcgRXJyb3IoYEZpbGUgJHtyb3V0ZX0gbm90IGZvdW5kYCkpO1xuXHRcdFx0fVxuXHRcdFx0bG9nZ2VyLmRlYnVnKGAke3JvdXRlfSB3YXMgYWNjZXNzZWRgKTtcblx0XHR9KTtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRwcm9jZXNzRXJyb3IoZXJyb3IgYXMgRXJyb3IsIGxvZ2dlciB8fCBjb25zb2xlKTtcblx0XHRuZXh0KGVycm9yKTtcblx0fVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0dXBTdGF0aWNSb3V0ZXMoe1xuXHRsb2dnZXIsXG5cdHN0YXRpY1Jvb3RQYXRoID0gZW52aXJvbm1lbnRWYXJpYWJsZXMuc3RhdGljUm9vdFBhdGgsXG5cdGFwcEpzUGF0aCA9IGVudmlyb25tZW50VmFyaWFibGVzLmZyb250ZW5kQXBwSnNQYXRoLFxuXHRzZWNyZXRzUGF0aCA9IGVudmlyb25tZW50VmFyaWFibGVzLmZyb250ZW5kU2VjcmV0c1BhdGgsXG5cdGJyb3dzZXJDb25maWdYbWxQYXRoID0gZW52aXJvbm1lbnRWYXJpYWJsZXMuZnJvbnRlbmRCcm93c2VyQ29uZmlnWG1sUGF0aCxcblx0aHVtYW5zTWRQYXRoID0gZW52aXJvbm1lbnRWYXJpYWJsZXMuZnJvbnRlbmRIdW1hbnNNZFBhdGgsXG5cdHJvYm90c1R4dFBhdGggPSBlbnZpcm9ubWVudFZhcmlhYmxlcy5mcm9udGVuZFJvYm90c1R4dFBhdGhcbn06IFN0YXRpY1JvdXRlc0RlcGVuZGVuY2llcyk6IGV4cHJlc3MuUm91dGVyIHtcblx0dHJ5IHtcblx0XHR2YWxpZGF0ZURlcGVuZGVuY2llcyhcblx0XHRcdFtcblx0XHRcdFx0eyBuYW1lOiAnbG9nZ2VyJywgaW5zdGFuY2U6IGxvZ2dlciB9LFxuXHRcdFx0XHR7IG5hbWU6ICdzdGF0aWNSb290UGF0aCcsIGluc3RhbmNlOiBzdGF0aWNSb290UGF0aCB9LFxuXHRcdFx0XHR7IG5hbWU6ICdhcHBKc1BhdGgnLCBpbnN0YW5jZTogYXBwSnNQYXRoIH0sXG5cdFx0XHRcdHsgbmFtZTogJ3NlY3JldHNQYXRoJywgaW5zdGFuY2U6IHNlY3JldHNQYXRoIH0sXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRuYW1lOiAnYnJvd3NlckNvbmZpZ1htbFBhdGgnLFxuXHRcdFx0XHRcdGluc3RhbmNlOiBicm93c2VyQ29uZmlnWG1sUGF0aFxuXHRcdFx0XHR9LFxuXHRcdFx0XHR7IG5hbWU6ICdodW1hbnNNZFBhdGgnLCBpbnN0YW5jZTogaHVtYW5zTWRQYXRoIH0sXG5cdFx0XHRcdHsgbmFtZTogJ3JvYm90c1R4dFBhdGgnLCBpbnN0YW5jZTogcm9ib3RzVHh0UGF0aCB9XG5cdFx0XHRdLFxuXHRcdFx0bG9nZ2VyIHx8IGNvbnNvbGVcblx0XHQpO1xuXG5cdFx0Ly8gbWlkZGxld2FyZSB0byBsb2cgc3RhdGljIGFzc2V0IGFjY2Vzc1xuXHRcdHJvdXRlci51c2UoKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHR2YWxpZGF0ZURlcGVuZGVuY2llcyhcblx0XHRcdFx0XHRbXG5cdFx0XHRcdFx0XHR7IG5hbWU6ICdyZXEnLCBpbnN0YW5jZTogcmVxIH0sXG5cdFx0XHRcdFx0XHR7IG5hbWU6ICdyZXMnLCBpbnN0YW5jZTogcmVzIH0sXG5cdFx0XHRcdFx0XHR7IG5hbWU6ICduZXh0JywgaW5zdGFuY2U6IG5leHQgfSxcblx0XHRcdFx0XHRcdHsgbmFtZTogJ2xvZ2dlcicsIGluc3RhbmNlOiBsb2dnZXIgfVxuXHRcdFx0XHRcdF0sXG5cdFx0XHRcdFx0bG9nZ2VyXG5cdFx0XHRcdCk7XG5cblx0XHRcdFx0Y29uc3QgYXNzZXRUeXBlcyA9IFtcblx0XHRcdFx0XHQnY3NzJyxcblx0XHRcdFx0XHQnL21qcycsXG5cdFx0XHRcdFx0J2pzJyxcblx0XHRcdFx0XHQnL2ZvbnRzJyxcblx0XHRcdFx0XHQnL2ljb25zJyxcblx0XHRcdFx0XHQnL2ltYWdlcydcblx0XHRcdFx0XTtcblxuXHRcdFx0XHRpZiAoYXNzZXRUeXBlcy5zb21lKHR5cGUgPT4gcmVxLnVybC5zdGFydHNXaXRoKHR5cGUpKSkge1xuXHRcdFx0XHRcdGxvZ2dlci5kZWJ1ZyhgR0VUIHJlcXVlc3QgcmVjZWl2ZWQgYXQgJHtyZXEudXJsfWApO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0bmV4dCgpO1xuXHRcdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdFx0cHJvY2Vzc0Vycm9yKGVycm9yLCBsb2dnZXIpO1xuXHRcdFx0XHRuZXh0KGVycm9yKTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdC8vIHNlcnZlIHJvb3QgSFRNTCBmaWxlc1xuXHRcdHJvdXRlci5nZXQoXG5cdFx0XHQnLzpwYWdlJyxcblx0XHRcdChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuXHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdHZhbGlkYXRlRGVwZW5kZW5jaWVzKFxuXHRcdFx0XHRcdFx0W1xuXHRcdFx0XHRcdFx0XHR7IG5hbWU6ICdyZXEnLCBpbnN0YW5jZTogcmVxIH0sXG5cdFx0XHRcdFx0XHRcdHsgbmFtZTogJ3JlcycsIGluc3RhbmNlOiByZXMgfSxcblx0XHRcdFx0XHRcdFx0eyBuYW1lOiAnbmV4dCcsIGluc3RhbmNlOiBuZXh0IH0sXG5cdFx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0XHRuYW1lOiAnc3RhdGljUm9vdFBhdGgnLFxuXHRcdFx0XHRcdFx0XHRcdGluc3RhbmNlOiBzdGF0aWNSb290UGF0aFxuXHRcdFx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdFx0XHR7IG5hbWU6ICdsb2dnZXInLCBpbnN0YW5jZTogbG9nZ2VyIH1cblx0XHRcdFx0XHRcdF0sXG5cdFx0XHRcdFx0XHRsb2dnZXJcblx0XHRcdFx0XHQpO1xuXG5cdFx0XHRcdFx0Y29uc3QgcGFnZSA9IHJlcS5wYXJhbXMucGFnZTtcblx0XHRcdFx0XHRjb25zdCBmaWxlUGF0aCA9IHBhdGguam9pbihzdGF0aWNSb290UGF0aCwgYCR7cGFnZX0uaHRtbGApO1xuXG5cdFx0XHRcdFx0c2VydmVTdGF0aWNGaWxlKFxuXHRcdFx0XHRcdFx0ZmlsZVBhdGgsXG5cdFx0XHRcdFx0XHRgLyR7cGFnZX0uaHRtbGAsXG5cdFx0XHRcdFx0XHRyZXMsXG5cdFx0XHRcdFx0XHRuZXh0LFxuXHRcdFx0XHRcdFx0bG9nZ2VyXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdFx0XHRwcm9jZXNzRXJyb3IoZXJyb3IgYXMgRXJyb3IsIGxvZ2dlciwgcmVxKTtcblx0XHRcdFx0XHRuZXh0KGVycm9yKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdCk7XG5cblx0XHQvLyBzZXJ2ZSBzdGF0aWMgZGlyZWN0b3JpZXNcblx0XHRjb25zdCBzdGF0aWNEaXJlY3RvcmllcyA9IHtcblx0XHRcdGNzczogcGF0aC5qb2luKHN0YXRpY1Jvb3RQYXRoLCAnYXNzZXRzL2NzcycpLFxuXHRcdFx0bWpzOiBwYXRoLmpvaW4oc3RhdGljUm9vdFBhdGgsICdhc3NldHMvbWpzJyksXG5cdFx0XHRqczogcGF0aC5qb2luKHN0YXRpY1Jvb3RQYXRoLCAnYXNzZXRzL2pzJyksXG5cdFx0XHRmb250czogcGF0aC5qb2luKHN0YXRpY1Jvb3RQYXRoLCAnYXNzZXRzL2ZvbnRzJyksXG5cdFx0XHRpY29uczogcGF0aC5qb2luKHN0YXRpY1Jvb3RQYXRoLCAnYXNzZXRzL2ljb25zJyksXG5cdFx0XHRpbWFnZXM6IHBhdGguam9pbihzdGF0aWNSb290UGF0aCwgJ2Fzc2V0cy9pbWFnZXMnKVxuXHRcdH07XG5cblx0XHRPYmplY3QuZW50cmllcyhzdGF0aWNEaXJlY3RvcmllcykuZm9yRWFjaCgoW3JvdXRlLCBkaXJQYXRoXSkgPT4ge1xuXHRcdFx0cm91dGVyLnVzZShgLyR7cm91dGV9YCwgZXhwcmVzcy5zdGF0aWMoZGlyUGF0aCkpO1xuXHRcdH0pO1xuXG5cdFx0Ly8gc2VydmUgc3BlY2lmaWMgc3RhdGljIGZpbGVzXG5cdFx0Y29uc3Qgc3RhdGljRmlsZXMgPSBbXG5cdFx0XHR7IHJvdXRlOiAnL2FwcC5qcycsIGZpbGVQYXRoOiBhcHBKc1BhdGggfSxcblx0XHRcdHsgcm91dGU6ICcvc2VjcmV0cy5qc29uLmdwZycsIGZpbGVQYXRoOiBzZWNyZXRzUGF0aCB9LFxuXHRcdFx0eyByb3V0ZTogJy9icm93c2VyY29uZmlnLnhtbCcsIGZpbGVQYXRoOiBicm93c2VyQ29uZmlnWG1sUGF0aCB9LFxuXHRcdFx0eyByb3V0ZTogJy9odW1hbnMubWQnLCBmaWxlUGF0aDogaHVtYW5zTWRQYXRoIH0sXG5cdFx0XHR7IHJvdXRlOiAnL3JvYm90cy50eHQnLCBmaWxlUGF0aDogcm9ib3RzVHh0UGF0aCB9XG5cdFx0XTtcblxuXHRcdHN0YXRpY0ZpbGVzLmZvckVhY2goZmlsZSA9PiB7XG5cdFx0XHRyb3V0ZXIuZ2V0KFxuXHRcdFx0XHRmaWxlLnJvdXRlLFxuXHRcdFx0XHQoX3JlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG5cdFx0XHRcdFx0dHJ5IHtcblx0XHRcdFx0XHRcdHZhbGlkYXRlRGVwZW5kZW5jaWVzKFxuXHRcdFx0XHRcdFx0XHRbXG5cdFx0XHRcdFx0XHRcdFx0eyBuYW1lOiAnZmlsZVBhdGgnLCBpbnN0YW5jZTogZmlsZS5maWxlUGF0aCB9LFxuXHRcdFx0XHRcdFx0XHRcdHsgbmFtZTogJ3JvdXRlJywgaW5zdGFuY2U6IGZpbGUucm91dGUgfSxcblx0XHRcdFx0XHRcdFx0XHR7IG5hbWU6ICdyZXMnLCBpbnN0YW5jZTogcmVzIH0sXG5cdFx0XHRcdFx0XHRcdFx0eyBuYW1lOiAnbmV4dCcsIGluc3RhbmNlOiBuZXh0IH0sXG5cdFx0XHRcdFx0XHRcdFx0eyBuYW1lOiAnbG9nZ2VyJywgaW5zdGFuY2U6IGxvZ2dlciB9XG5cdFx0XHRcdFx0XHRcdF0sXG5cdFx0XHRcdFx0XHRcdGxvZ2dlclxuXHRcdFx0XHRcdFx0KTtcblxuXHRcdFx0XHRcdFx0bG9nZ2VyLmRlYnVnKGBHRVQgcmVxdWVzdCByZWNlaXZlZCBhdCAke2ZpbGUucm91dGV9YCk7XG5cblx0XHRcdFx0XHRcdHNlcnZlU3RhdGljRmlsZShcblx0XHRcdFx0XHRcdFx0ZmlsZS5maWxlUGF0aCxcblx0XHRcdFx0XHRcdFx0ZmlsZS5yb3V0ZSxcblx0XHRcdFx0XHRcdFx0cmVzLFxuXHRcdFx0XHRcdFx0XHRuZXh0LFxuXHRcdFx0XHRcdFx0XHRsb2dnZXJcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdFx0XHRcdHByb2Nlc3NFcnJvcihlcnJvciBhcyBFcnJvciwgbG9nZ2VyKTtcblx0XHRcdFx0XHRcdG5leHQoZXJyb3IpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0KTtcblx0XHR9KTtcblxuXHRcdC8vIDQwNCBoYW5kbGVyIGZvciB1bm1hdGNoZWQgcm91dGVzXG5cdFx0cm91dGVyLnVzZSgocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdHZhbGlkYXRlRGVwZW5kZW5jaWVzKFxuXHRcdFx0XHRcdFtcblx0XHRcdFx0XHRcdHsgbmFtZTogJ3JlcScsIGluc3RhbmNlOiByZXEgfSxcblx0XHRcdFx0XHRcdHsgbmFtZTogJ3JlcycsIGluc3RhbmNlOiByZXMgfSxcblx0XHRcdFx0XHRcdHsgbmFtZTogJ25leHQnLCBpbnN0YW5jZTogbmV4dCB9LFxuXHRcdFx0XHRcdFx0eyBuYW1lOiAnc3RhdGljUm9vdFBhdGgnLCBpbnN0YW5jZTogc3RhdGljUm9vdFBhdGggfSxcblx0XHRcdFx0XHRcdHsgbmFtZTogJ2xvZ2dlcicsIGluc3RhbmNlOiBsb2dnZXIgfVxuXHRcdFx0XHRcdF0sXG5cdFx0XHRcdFx0bG9nZ2VyXG5cdFx0XHRcdCk7XG5cblx0XHRcdFx0bG9nZ2VyLmluZm8oYDQwNCAtICR7cmVxLnVybH0gd2FzIG5vdCBmb3VuZGApO1xuXG5cdFx0XHRcdGNvbnN0IG5vdEZvdW5kRmlsZVBhdGggPSBwYXRoLmpvaW4oXG5cdFx0XHRcdFx0c3RhdGljUm9vdFBhdGgsXG5cdFx0XHRcdFx0J25vdC1mb3VuZC5odG1sJ1xuXHRcdFx0XHQpO1xuXG5cdFx0XHRcdC8vIGF0dGVtcHQgdG8gc2VuZCB0aGUgNDA0IGZpbGVcblx0XHRcdFx0cmVzLnNlbmRGaWxlKG5vdEZvdW5kRmlsZVBhdGgsIGVyciA9PiB7XG5cdFx0XHRcdFx0aWYgKGVycikge1xuXHRcdFx0XHRcdFx0cHJvY2Vzc0Vycm9yKGVyciwgbG9nZ2VyLCByZXEpO1xuXHRcdFx0XHRcdFx0cmVzLnN0YXR1cyg1MDApLmpzb24oe1xuXHRcdFx0XHRcdFx0XHRlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcidcblx0XHRcdFx0XHRcdH0pO1xuXG5cdFx0XHRcdFx0XHRyZXR1cm4gbmV4dChlcnIpO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRsb2dnZXIuZGVidWcoXG5cdFx0XHRcdFx0XHRcdGBub3QtZm91bmQuaHRtbCB3YXMgYWNjZXNzZWQgZm9yICR7cmVxLnVybH1gXG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSk7XG5cdFx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0XHRwcm9jZXNzRXJyb3IoZXJyb3IgYXMgRXJyb3IsIGxvZ2dlciwgcmVxKTtcblx0XHRcdFx0bmV4dChlcnJvcik7XG5cdFx0XHR9XG5cdFx0fSk7XG5cblx0XHRyZXR1cm4gcm91dGVyO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdHByb2Nlc3NFcnJvcihlcnJvciBhcyBFcnJvciwgbG9nZ2VyKTtcblx0XHR0aHJvdyBlcnJvcjtcblx0fVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaW5pdGlhbGl6ZVN0YXRpY1JvdXRlcyhcblx0YXBwOiBleHByZXNzLkFwcGxpY2F0aW9uLFxuXHRzdGF0aWNSb290UGF0aDogc3RyaW5nLFxuXHRsb2dnZXI6IExvZ2dlclxuKTogdm9pZCB7XG5cdHRyeSB7XG5cdFx0dmFsaWRhdGVEZXBlbmRlbmNpZXMoXG5cdFx0XHRbXG5cdFx0XHRcdHsgbmFtZTogJ2FwcCcsIGluc3RhbmNlOiBhcHAgfSxcblx0XHRcdFx0eyBuYW1lOiAnc3RhdGljUm9vdFBhdGgnLCBpbnN0YW5jZTogc3RhdGljUm9vdFBhdGggfSxcblx0XHRcdFx0eyBuYW1lOiAnbG9nZ2VyJywgaW5zdGFuY2U6IGxvZ2dlciB9XG5cdFx0XHRdLFxuXHRcdFx0bG9nZ2VyXG5cdFx0KTtcblxuXHRcdC8vIHNldCB1cCB0aGUgc3RhdGljIHJvdXRlc1xuXHRcdGNvbnN0IHJvdXRlciA9IHNldHVwU3RhdGljUm91dGVzKHtcblx0XHRcdGxvZ2dlcixcblx0XHRcdHN0YXRpY1Jvb3RQYXRoLFxuXHRcdFx0YXBwSnNQYXRoOiBlbnZpcm9ubWVudFZhcmlhYmxlcy5mcm9udGVuZEFwcEpzUGF0aCEsXG5cdFx0XHRzZWNyZXRzUGF0aDogZW52aXJvbm1lbnRWYXJpYWJsZXMuZnJvbnRlbmRTZWNyZXRzUGF0aCEsXG5cdFx0XHRicm93c2VyQ29uZmlnWG1sUGF0aDpcblx0XHRcdFx0ZW52aXJvbm1lbnRWYXJpYWJsZXMuZnJvbnRlbmRCcm93c2VyQ29uZmlnWG1sUGF0aCEsXG5cdFx0XHRodW1hbnNNZFBhdGg6IGVudmlyb25tZW50VmFyaWFibGVzLmZyb250ZW5kSHVtYW5zTWRQYXRoISxcblx0XHRcdHJvYm90c1R4dFBhdGg6IGVudmlyb25tZW50VmFyaWFibGVzLmZyb250ZW5kUm9ib3RzVHh0UGF0aCFcblx0XHR9KTtcblxuXHRcdGFwcC51c2UoJy8nLCByb3V0ZXIpO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdHByb2Nlc3NFcnJvcihlcnJvciBhcyBFcnJvciwgbG9nZ2VyKTtcblx0XHR0aHJvdyBlcnJvcjtcblx0fVxufVxuIl19
