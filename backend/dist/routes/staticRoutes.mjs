import express from 'express';
import path from 'path';
import setupLogger from '../config/logger';
const router = express.Router();
// Setup static routes
export function setupStaticRoutes({
	staticRootPath,
	appMjsPath,
	appJsPath,
	secretsPath,
	browserConfigXmlPath,
	humansMdPath,
	robotsTxtPath,
	logLevel = 'info',
	logDirectory = './logs',
	serviceName = 'StaticRouter',
	isProduction = process.env.NODE_ENV === 'development' // *DEV-NOTE* change default value to production before deployment
}) {
	const logger = setupLogger({
		logLevel,
		logDirectory,
		serviceName,
		isProduction
	});
	// middleware to log static asset access
	router.use((req, res, next) => {
		const assetTypes = ['css', '/mjs', 'js', '/fonts', '/icons', '/images'];
		if (assetTypes.some(type => req.url.startsWith(type))) {
			logger.info(`GET request received at ${req.url}`);
		}
		next();
	});
	// serve root HTML files
	router.get('/:page', (req, res) => {
		const page = req.params.page;
		const filePath = path.join(staticRootPath, `${page}.html`);
		res.sendFile(filePath, err => {
			if (err) {
				logger.error(`Failed to send ${page}.html: ${err}`);
				res.status(404).send('Page not found');
			} else {
				logger.info(`${page}.html was accessed`);
			}
		});
	});
	// serve static directories using Optional Chaining
	const staticDirectories = {
		css: path.join(staticRootPath, 'assets/css'),
		mjs: path.join(staticRootPath, 'assets/mjs'),
		js: path.join(staticRootPath, 'assets/js'),
		fonts: path.join(staticRootPath, 'assets/fonts'),
		icons: path.join(staticRootPath, 'assets/icons'),
		images: path.join(staticRootPath, 'assets/images')
	};
	Object.entries(staticDirectories).forEach(([route, dirPath]) => {
		router.use(`/${route}`, express.static(dirPath ?? './fallback'));
	});
	// serve nested HTML files
	router.get('/*', (req, res) => {
		const filePath = path.join(staticRootPath, `${req.path}.html`);
		res.sendFile(filePath, err => {
			if (err) {
				logger.error(`Failed to send ${req.path}.html: ${err}`);
				res.status(404).send('Page not found');
			} else {
				logger.info(`${req.path}.html was accessed`);
			}
		});
	});
	// serve specific static files
	const staticFiles = [
		{ route: '/app.mjs', filePath: appMjsPath },
		{ route: '/app.js', filePath: appJsPath },
		{ route: '/secrets.json.gpg', filePath: secretsPath },
		{ route: '/browserconfig.xml', filePath: browserConfigXmlPath },
		{ route: '/humans.md', filePath: humansMdPath },
		{ route: '/robots.txt', filePath: robotsTxtPath }
	];
	staticFiles.forEach(file => {
		router.get(file.route, (req, res) => {
			logger.info(`GET request received at ${file.route}`);
			res.sendFile(file.filePath ?? './fallback', err => {
				if (err) {
					logger.error(`Failed to send ${file.route}: ${err}`);
					res.status(404).send('File not found');
				} else {
					logger.info(`${file.route} was accessed`);
				}
			});
		});
	});
	// 404 handler for unmatched routes
	router.use((req, res) => {
		logger.info(`404 - ${req.url} was not found`);
		res.status(404).sendFile(
			path.join(staticRootPath, 'not-found.html'),
			err => {
				if (err) {
					logger.error(`Failed to send not-found.html: ${err}`);
					res.status(500).send('Internal server error');
				}
			}
		);
	});
	return router;
}
// Initialize the static routes
export function initializeStaticRoutes(app, staticRootPath) {
	const router = setupStaticRoutes({
		// *DEV-NOTE* refactor to use environmentVariables
		staticRootPath,
		appMjsPath: process.env.FRONTEND_APP_MJS_PATH,
		appJsPath: process.env.FRONTEND_APP_JS_PATH,
		secretsPath: process.env.FRONTEND_SECRETS_PATH,
		browserConfigXmlPath: process.env.FRONTEND_BROWSER_CONFIG_XML_PATH,
		humansMdPath: process.env.FRONTEND_HUMANS_MD_PATH,
		robotsTxtPath: process.env.FRONTEND_ROBOTS_TXT_PATH,
		logLevel: process.env.LOG_LEVEL,
		logDirectory: process.env.LOG_DIRECTORY,
		serviceName: process.env.SERVICE_NAME,
		isProduction: process.env.NODE_ENV === 'developpment' // *DEV-NOTE* change default value to production before deployment
	});
	app.use('/', router);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGljUm91dGVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3JvdXRlcy9zdGF0aWNSb3V0ZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxPQUE0QyxNQUFNLFNBQVMsQ0FBQztBQUNuRSxPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxXQUFXLE1BQU0sa0JBQWtCLENBQUM7QUFFM0MsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBZ0JoQyxzQkFBc0I7QUFDdEIsTUFBTSxVQUFVLGlCQUFpQixDQUFDLEVBQ2pDLGNBQWMsRUFDZCxVQUFVLEVBQ1YsU0FBUyxFQUNULFdBQVcsRUFDWCxvQkFBb0IsRUFDcEIsWUFBWSxFQUNaLGFBQWEsRUFDYixRQUFRLEdBQUcsTUFBTSxFQUNqQixZQUFZLEdBQUcsUUFBUSxFQUN2QixXQUFXLEdBQUcsY0FBYyxFQUM1QixZQUFZLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssYUFBYSxDQUFDLGtFQUFrRTtFQUM5RjtJQUMxQixNQUFNLE1BQU0sR0FBRyxXQUFXLENBQUM7UUFDMUIsUUFBUTtRQUNSLFlBQVk7UUFDWixXQUFXO1FBQ1gsWUFBWTtLQUNaLENBQUMsQ0FBQztJQUVILHdDQUF3QztJQUN4QyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQixFQUFFLEVBQUU7UUFDOUQsTUFBTSxVQUFVLEdBQUcsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3hFLElBQUksVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUN2RCxNQUFNLENBQUMsSUFBSSxDQUFD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O1FBQ3hDLFdBQVcsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQWE7UUFDdEMsWUFBWSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLGNBQWMsQ0FBQyxrRUFBa0U7S0FDeEgsQ0FBQyxDQUFDO0lBQ0gsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDdEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBleHByZXNzLCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHNldHVwTG9nZ2VyIGZyb20gJy4uL2NvbmZpZy9sb2dnZXInO1xuXG5jb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuXG5pbnRlcmZhY2UgU3RhdGljUm91dGVzRGVwZW5kZW5jaWVzIHtcblx0bG9nTGV2ZWw/OiBzdHJpbmc7XG5cdGxvZ0RpcmVjdG9yeT86IHN0cmluZztcblx0c2VydmljZU5hbWU/OiBzdHJpbmc7XG5cdGlzUHJvZHVjdGlvbj86IGJvb2xlYW47XG5cdHN0YXRpY1Jvb3RQYXRoOiBzdHJpbmc7XG5cdGFwcE1qc1BhdGg6IHN0cmluZztcblx0YXBwSnNQYXRoOiBzdHJpbmc7XG5cdHNlY3JldHNQYXRoOiBzdHJpbmc7XG5cdGJyb3dzZXJDb25maWdYbWxQYXRoOiBzdHJpbmc7XG5cdGh1bWFuc01kUGF0aDogc3RyaW5nO1xuXHRyb2JvdHNUeHRQYXRoOiBzdHJpbmc7XG59XG5cbi8vIFNldHVwIHN0YXRpYyByb3V0ZXNcbmV4cG9ydCBmdW5jdGlvbiBzZXR1cFN0YXRpY1JvdXRlcyh7XG5cdHN0YXRpY1Jvb3RQYXRoLFxuXHRhcHBNanNQYXRoLFxuXHRhcHBKc1BhdGgsXG5cdHNlY3JldHNQYXRoLFxuXHRicm93c2VyQ29uZmlnWG1sUGF0aCxcblx0aHVtYW5zTWRQYXRoLFxuXHRyb2JvdHNUeHRQYXRoLFxuXHRsb2dMZXZlbCA9ICdpbmZvJyxcblx0bG9nRGlyZWN0b3J5ID0gJy4vbG9ncycsXG5cdHNlcnZpY2VOYW1lID0gJ1N0YXRpY1JvdXRlcicsXG5cdGlzUHJvZHVjdGlvbiA9IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnIC8vICpERVYtTk9URSogY2hhbmdlIGRlZmF1bHQgdmFsdWUgdG8gcHJvZHVjdGlvbiBiZWZvcmUgZGVwbG95bWVudFxufTogU3RhdGljUm91dGVzRGVwZW5kZW5jaWVzKTogZXhwcmVzcy5Sb3V0ZXIge1xuXHRjb25zdCBsb2dnZXIgPSBzZXR1cExvZ2dlcih7XG5cdFx0bG9nTGV2ZWwsXG5cdFx0bG9nRGlyZWN0b3J5LFxuXHRcdHNlcnZpY2VOYW1lLFxuXHRcdGlzUHJvZHVjdGlvblxuXHR9KTtcblxuXHQvLyBtaWRkbGV3YXJlIHRvIGxvZyBzdGF0aWMgYXNzZXQgYWNjZXNzXG5cdHJvdXRlci51c2UoKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG5cdFx0Y29uc3QgYXNzZXRUeXBlcyA9IFsnY3NzJywgJy9tanMnLCAnanMnLCAnL2ZvbnRzJywgJy9pY29ucycsICcvaW1hZ2VzJ107XG5cdFx0aWYgKGFzc2V0VHlwZXMuc29tZSh0eXBlID0+IHJlcS51cmwuc3RhcnRzV2l0aCh0eXBlKSkpIHtcblx0XHRcdGxvZ2dlci5pbmZvKGBHRVQgcmVxdWVzdCByZWNlaXZlZCBhdCAke3JlcS51cmx9YCk7XG5cdFx0fVxuXHRcdG5leHQoKTtcblx0fSk7XG5cblx0Ly8gc2VydmUgcm9vdCBIVE1MIGZpbGVzXG5cdHJvdXRlci5nZXQoJy86cGFnZScsIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcblx0XHRjb25zdCBwYWdlID0gcmVxLnBhcmFtcy5wYWdlO1xuXHRcdGNvbnN0IGZpbGVQYXRoID0gcGF0aC5qb2luKHN0YXRpY1Jvb3RQYXRoLCBgJHtwYWdlfS5odG1sYCk7XG5cdFx0cmVzLnNlbmRGaWxlKGZpbGVQYXRoLCBlcnIgPT4ge1xuXHRcdFx0aWYgKGVycikge1xuXHRcdFx0XHRsb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBzZW5kICR7cGFnZX0uaHRtbDogJHtlcnJ9YCk7XG5cdFx0XHRcdHJlcy5zdGF0dXMoNDA0KS5zZW5kKCdQYWdlIG5vdCBmb3VuZCcpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0bG9nZ2VyLmluZm8oYCR7cGFnZX0uaHRtbCB3YXMgYWNjZXNzZWRgKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fSk7XG5cblx0Ly8gc2VydmUgc3RhdGljIGRpcmVjdG9yaWVzIHVzaW5nIE9wdGlvbmFsIENoYWluaW5nXG5cdGNvbnN0IHN0YXRpY0RpcmVjdG9yaWVzID0ge1xuXHRcdGNzczogcGF0aC5qb2luKHN0YXRpY1Jvb3RQYXRoLCAnYXNzZXRzL2NzcycpLFxuXHRcdG1qczogcGF0aC5qb2luKHN0YXRpY1Jvb3RQYXRoLCAnYXNzZXRzL21qcycpLFxuXHRcdGpzOiBwYXRoLmpvaW4oc3RhdGljUm9vdFBhdGgsICdhc3NldHMvanMnKSxcblx0XHRmb250czogcGF0aC5qb2luKHN0YXRpY1Jvb3RQYXRoLCAnYXNzZXRzL2ZvbnRzJyksXG5cdFx0aWNvbnM6IHBhdGguam9pbihzdGF0aWNSb290UGF0aCwgJ2Fzc2V0cy9pY29ucycpLFxuXHRcdGltYWdlczogcGF0aC5qb2luKHN0YXRpY1Jvb3RQYXRoLCAnYXNzZXRzL2ltYWdlcycpXG5cdH07XG5cblx0T2JqZWN0LmVudHJpZXMoc3RhdGljRGlyZWN0b3JpZXMpLmZvckVhY2goKFtyb3V0ZSwgZGlyUGF0aF0pID0+IHtcblx0XHRyb3V0ZXIudXNlKGAvJHtyb3V0ZX1gLCBleHByZXNzLnN0YXRpYyhkaXJQYXRoID8/ICcuL2ZhbGxiYWNrJykpO1xuXHR9KTtcblxuXHQvLyBzZXJ2ZSBuZXN0ZWQgSFRNTCBmaWxlc1xuXHRyb3V0ZXIuZ2V0KCcvKicsIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcblx0XHRjb25zdCBmaWxlUGF0aCA9IHBhdGguam9pbihzdGF0aWNSb290UGF0aCwgYCR7cmVxLnBhdGh9Lmh0bWxgKTtcblx0XHRyZXMuc2VuZEZpbGUoZmlsZVBhdGgsIGVyciA9PiB7XG5cdFx0XHRpZiAoZXJyKSB7XG5cdFx0XHRcdGxvZ2dlci5lcnJvcihgRmFpbGVkIHRvIHNlbmQgJHtyZXEucGF0aH0uaHRtbDogJHtlcnJ9YCk7XG5cdFx0XHRcdHJlcy5zdGF0dXMoNDA0KS5zZW5kKCdQYWdlIG5vdCBmb3VuZCcpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0bG9nZ2VyLmluZm8oYCR7cmVxLnBhdGh9Lmh0bWwgd2FzIGFjY2Vzc2VkYCk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH0pO1xuXG5cdC8vIHNlcnZlIHNwZWNpZmljIHN0YXRpYyBmaWxlc1xuXHRjb25zdCBzdGF0aWNGaWxlcyA9IFtcblx0XHR7IHJvdXRlOiAnL2FwcC5tanMnLCBmaWxlUGF0aDogYXBwTWpzUGF0aCB9LFxuXHRcdHsgcm91dGU6ICcvYXBwLmpzJywgZmlsZVBhdGg6IGFwcEpzUGF0aCB9LFxuXHRcdHsgcm91dGU6ICcvc2VjcmV0cy5qc29uLmdwZycsIGZpbGVQYXRoOiBzZWNyZXRzUGF0aCB9LFxuXHRcdHsgcm91dGU6ICcvYnJvd3NlcmNvbmZpZy54bWwnLCBmaWxlUGF0aDogYnJvd3NlckNvbmZpZ1htbFBhdGggfSxcblx0XHR7IHJvdXRlOiAnL2h1bWFucy5tZCcsIGZpbGVQYXRoOiBodW1hbnNNZFBhdGggfSxcblx0XHR7IHJvdXRlOiAnL3JvYm90cy50eHQnLCBmaWxlUGF0aDogcm9ib3RzVHh0UGF0aCB9XG5cdF07XG5cblx0c3RhdGljRmlsZXMuZm9yRWFjaChmaWxlID0+IHtcblx0XHRyb3V0ZXIuZ2V0KGZpbGUucm91dGUsIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcblx0XHRcdGxvZ2dlci5pbmZvKGBHRVQgcmVxdWVzdCByZWNlaXZlZCBhdCAke2ZpbGUucm91dGV9YCk7XG5cdFx0XHRyZXMuc2VuZEZpbGUoZmlsZS5maWxlUGF0aCA/PyAnLi9mYWxsYmFjaycsIGVyciA9PiB7XG5cdFx0XHRcdGlmIChlcnIpIHtcblx0XHRcdFx0XHRsb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBzZW5kICR7ZmlsZS5yb3V0ZX06ICR7ZXJyfWApO1xuXHRcdFx0XHRcdHJlcy5zdGF0dXMoNDA0KS5zZW5kKCdGaWxlIG5vdCBmb3VuZCcpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdGxvZ2dlci5pbmZvKGAke2ZpbGUucm91dGV9IHdhcyBhY2Nlc3NlZGApO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblx0XHR9KTtcblx0fSk7XG5cblx0Ly8gNDA0IGhhbmRsZXIgZm9yIHVubWF0Y2hlZCByb3V0ZXNcblx0cm91dGVyLnVzZSgocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG5cdFx0bG9nZ2VyLmluZm8oYDQwNCAtICR7cmVxLnVybH0gd2FzIG5vdCBmb3VuZGApO1xuXHRcdHJlcy5zdGF0dXMoNDA0KS5zZW5kRmlsZShcblx0XHRcdHBhdGguam9pbihzdGF0aWNSb290UGF0aCwgJ25vdC1mb3VuZC5odG1sJyksXG5cdFx0XHRlcnIgPT4ge1xuXHRcdFx0XHRpZiAoZXJyKSB7XG5cdFx0XHRcdFx0bG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gc2VuZCBub3QtZm91bmQuaHRtbDogJHtlcnJ9YCk7XG5cdFx0XHRcdFx0cmVzLnN0YXR1cyg1MDApLnNlbmQoJ0ludGVybmFsIHNlcnZlciBlcnJvcicpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0KTtcblx0fSk7XG5cblx0cmV0dXJuIHJvdXRlcjtcbn1cblxuLy8gSW5pdGlhbGl6ZSB0aGUgc3RhdGljIHJvdXRlc1xuZXhwb3J0IGZ1bmN0aW9uIGluaXRpYWxpemVTdGF0aWNSb3V0ZXMoXG5cdGFwcDogZXhwcmVzcy5BcHBsaWNhdGlvbixcblx0c3RhdGljUm9vdFBhdGg6IHN0cmluZ1xuKTogdm9pZCB7XG5cdGNvbnN0IHJvdXRlciA9IHNldHVwU3RhdGljUm91dGVzKHtcblx0XHQvLyAqREVWLU5PVEUqIHJlZmFjdG9yIHRvIHVzZSBlbnZpcm9ubWVudFZhcmlhYmxlc1xuXHRcdHN0YXRpY1Jvb3RQYXRoLFxuXHRcdGFwcE1qc1BhdGg6IHByb2Nlc3MuZW52LkZST05URU5EX0FQUF9NSlNfUEFUSCEsXG5cdFx0YXBwSnNQYXRoOiBwcm9jZXNzLmVudi5GUk9OVEVORF9BUFBfSlNfUEFUSCEsXG5cdFx0c2VjcmV0c1BhdGg6IHByb2Nlc3MuZW52LkZST05URU5EX1NFQ1JFVFNfUEFUSCEsXG5cdFx0YnJvd3NlckNvbmZpZ1htbFBhdGg6IHByb2Nlc3MuZW52LkZST05URU5EX0JST1dTRVJfQ09ORklHX1hNTF9QQVRIISxcblx0XHRodW1hbnNNZFBhdGg6IHByb2Nlc3MuZW52LkZST05URU5EX0hVTUFOU19NRF9QQVRIISxcblx0XHRyb2JvdHNUeHRQYXRoOiBwcm9jZXNzLmVudi5GUk9OVEVORF9ST0JPVFNfVFhUX1BBVEghLFxuXHRcdGxvZ0xldmVsOiBwcm9jZXNzLmVudi5MT0dfTEVWRUwhLFxuXHRcdGxvZ0RpcmVjdG9yeTogcHJvY2Vzcy5lbnYuTE9HX0RJUkVDVE9SWSEsXG5cdFx0c2VydmljZU5hbWU6IHByb2Nlc3MuZW52LlNFUlZJQ0VfTkFNRSEsXG5cdFx0aXNQcm9kdWN0aW9uOiBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2RldmVsb3BwbWVudCcgLy8gKkRFVi1OT1RFKiBjaGFuZ2UgZGVmYXVsdCB2YWx1ZSB0byBwcm9kdWN0aW9uIGJlZm9yZSBkZXBsb3ltZW50XG5cdH0pO1xuXHRhcHAudXNlKCcvJywgcm91dGVyKTtcbn1cbiJdfQ==
