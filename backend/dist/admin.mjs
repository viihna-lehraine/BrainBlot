import argon2 from 'argon2';
import { config } from 'dotenv';
import fs from 'fs';
import os from 'os';
import path from 'path';
import { stdout as output } from 'process';
import readline from 'readline';
import { createLogger, format } from 'winston';
import DailyRotateFile from 'winston-daily-rotate-file';
import { dirname } from 'path';
import { fileURLToPath } from 'url';
export const __filename = fileURLToPath(import.meta.url);
export const __dirname = dirname(__filename);
config({ path: path.resolve(__dirname, '../config/env/backend.startup.env') });
function setupLogging() {
	const logDirectory = process.env.APP_INIT_LOGS_PATH;
	if (logDirectory) {
		if (!fs.existsSync(logDirectory)) {
			fs.mkdirSync(logDirectory, { recursive: true });
		}
	} else {
		handleFatalError(
			'Log directory is undefined. Please check APP_INIT_LOGS_PATH.'
		);
	}
	return createLogger({
		format: format.combine(format.timestamp(), format.json()),
		transports: [
			new DailyRotateFile({
				filename: path.join(
					logDirectory,
					'adminLoginAttempts-%DATE%.log'
				),
				datePattern: 'YYYY-MM-DD',
				maxSize: '20m',
				maxFiles: '30d',
				zippedArchive: true
			})
		]
	});
}
const startupLogger = setupLogging();
function getSystemDetails() {
	const interfaces = os.networkInterfaces();
	let ipv4;
	let ipv6;
	for (const name of Object.keys(interfaces)) {
		for (const net of interfaces[name] || []) {
			if (net.family === 'IPv4' && !net.internal && !ipv4)
				ipv4 = net.address;
			if (net.family === 'IPv6' && !net.internal && !ipv6)
				ipv6 = net.address;
		}
	}
	return {
		hostname: os.hostname(),
		platform: os.platform(),
		cpuArch: os.arch(),
		ipv4: ipv4 || 'N/A',
		ipv6: ipv6 || 'N/A'
	};
}
function handleFatalError(message) {
	console.error(`${message}\nShutting down...`);
	process.exit(1);
}
async function promptCredentials() {
	const rl = readline.createInterface({
		input: process.stdin,
		output: process.stdout
	});
	const username = await new Promise(resolve =>
		rl.question('Enter Admin Username: ', resolve)
	);
	const password = await new Promise(resolve => {
		let input = '';
		readline.emitKeypressEvents(process.stdin);
		process.stdin.setRawMode(true);
		process.stdin.on('keypress', (str, key) => {
			if (key.name === 'return') {
				process.stdin.setRawMode(false);
				rl.write('\n');
				process.stdin.removeAllListeners('keypress');
				rl.close();
				resolve(input);
			} else if (key.name === 'backspace') {
				if (input.length > 0) {
					input = input.slice(0, -1);
					output.write('\b \b');
				}
			} else {
				input += str;
				output.write('*');
			}
		});
	});
	return { username, password };
}
async function promptAdminSecret(promptMessage) {
	const rl = readline.createInterface({
		input: process.stdin,
		output: process.stdout
	});
	const secret = await new Promise(resolve =>
		rl.question(promptMessage, resolve)
	);
	rl.close();
	return secret;
}
function getAdminCredentials() {
	const usernameToPasswordMap = {};
	const usernameToAdminIdMap = {};
	for (const key of Object.keys(process.env)) {
		if (key.startsWith('ADMIN_USERNAME_')) {
			const adminIndex = key.split('_')[2];
			usernameToPasswordMap[process.env[key]] =
				process.env[`ADMIN_PASSWORD_${adminIndex}`];
			usernameToAdminIdMap[process.env[key]] =
				process.env[`ADMIN_ID_${adminIndex}`];
		}
	}
	return { usernameToPasswordMap, usernameToAdminIdMap };
}
async function validateCredentials(username, password, adminCredentials) {
	const storedHashedPassword = adminCredentials[username];
	return storedHashedPassword
		? argon2.verify(storedHashedPassword, password)
		: false;
}
async function validateAdminSecret(key, prefix) {
	const allowedKeys = Object.keys(process.env)
		.filter(envKey => envKey.startsWith(prefix))
		.map(envKey => process.env[envKey]);
	return Promise.any(
		allowedKeys.map(hashedKey => argon2.verify(hashedKey, key))
	)
		.then(() => true)
		.catch(() => false);
}
async function logAttempt(success, username, eventType) {
	startupLogger.info({
		timestamp: new Date().toISOString(),
		username: username || 'Unknown',
		success,
		eventType,
		systemUser: os.userInfo().username,
		...getSystemDetails()
	});
}
export async function login() {
	let retries = 3;
	console.log(
		'Welcome to the application Admin Login. Please enter your credentials.'
	);
	const { usernameToPasswordMap, usernameToAdminIdMap } =
		getAdminCredentials();
	if (!Object.keys(usernameToPasswordMap).length)
		handleFatalError('No admin credentials found.');
	while (retries > 0) {
		const { username, password } = await promptCredentials();
		const valid = await validateCredentials(
			username,
			password,
			usernameToPasswordMap
		);
		if (valid) {
			const adminId = usernameToAdminIdMap[username];
			if (!adminId) {
				handleFatalError('Admin ID not found.');
				return {
					encryptionKey: null,
					gpgPassphrase: null,
					adminId: null
				};
			}
			const encryptionKey = await handleSecretValidation(
				'Enter Encryption Key: ',
				'ENCRYPTION_KEY_'
			);
			const gpgPassphrase = await handleSecretValidation(
				'Enter GPG Passphrase: ',
				'GPG_PASSPHRASE_'
			);
			return {
				encryptionKey,
				gpgPassphrase,
				adminId: parseInt(adminId, 10)
			};
		} else {
			retries--;
			console.log(`Invalid credentials. Attempts left: ${retries}`);
			await logAttempt(false, username, 'login');
		}
	}
	handleFatalError('Maximum retries reached.');
	return { encryptionKey: null, gpgPassphrase: null, adminId: null };
}
async function handleSecretValidation(promptMessage, prefix) {
	for (let attempts = 0; attempts < 3; attempts++) {
		const secret = await promptAdminSecret(promptMessage);
		if (await validateAdminSecret(secret, prefix)) {
			await logAttempt(
				true,
				undefined,
				`${prefix.toLowerCase()}-validation`
			);
			return secret;
		} else {
			console.log(`Invalid ${promptMessage.trim()}. Please try again.`);
		}
	}
	handleFatalError(`Maximum ${promptMessage.trim()} retries reached.`);
	return '';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRtaW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvYWRtaW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxNQUFNLE1BQU0sUUFBUSxDQUFDO0FBQzVCLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDaEMsT0FBTyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3BCLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQztBQUNwQixPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxFQUFFLE1BQU0sSUFBSSxNQUFNLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDM0MsT0FBTyxRQUFRLE1BQU0sVUFBVSxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQy9DLE9BQU8sZUFBZSxNQUFNLDJCQUEyQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLEtBQUssQ0FBQztBQUVwQyxNQUFNLENBQUMsTUFBTSxVQUFVLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDekQsTUFBTSxDQUFDLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUU3QyxNQUFNLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsbUNBQW1DLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFL0UsU0FBUyxZQUFZO0lBQ3BCLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUM7SUFFcEQsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUNsQixJQUFJLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDO1lBQ2xDLEVBQUUsQ0FBQyxT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T0FBTyxDQUFDLENBQUM7UUFDNUMsQ0FBQztJQUNGLENBQUM7SUFFRCxnQkFBZ0IsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0lBRTdDLE9BQU8sRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDO0FBQ3BFLENBQUM7QUFFRCxLQUFLLFVBQVUsc0JBQXNCLENBQ3BDLGFBQXFCLEVBQ3JCLE1BQWM7SUFFZCxLQUFLLElBQUksUUFBUSxHQUFHLENBQUMsRUFBRSxRQUFRLEdBQUcsQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLENBQUM7UUFDakQsTUFBTSxNQUFNLEdBQUcsTUFBTSxpQkFBaUIsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN0RCxJQUFJLE1BQU0sbUJBQW1CLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDL0MsTUFBTSxVQUFVLENBQ2YsSUFBSSxFQUNKLFNBQVMsRUFDVCxHQUFHLE1BQU0sQ0FBQyxXQUFXLEVBQUUsYUFBYSxDQUNwQyxDQUFDO1lBQ0YsT0FBTyxNQUFNLENBQUM7UUFDZixDQUFDO2FBQU0sQ0FBQztZQUNQLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxhQUFhLENBQUMsSUFBSSxFQUFFLHFCQUFxQixDQUFDLENBQUM7UUFDbkUsQ0FBQztJQUNGLENBQUM7SUFFRCxnQkFBZ0IsQ0FBQyxXQUFXLGFBQWEsQ0FBQyxJQUFJLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztJQUNyRSxPQUFPLEVBQUUsQ0FBQztBQUNYLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXJnb24yIGZyb20gJ2FyZ29uMic7XG5pbXBvcnQgeyBjb25maWcgfSBmcm9tICdkb3RlbnYnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHN0ZG91dCBhcyBvdXRwdXQgfSBmcm9tICdwcm9jZXNzJztcbmltcG9ydCByZWFkbGluZSBmcm9tICdyZWFkbGluZSc7XG5pbXBvcnQgeyBjcmVhdGVMb2dnZXIsIGZvcm1hdCB9IGZyb20gJ3dpbnN0b24nO1xuaW1wb3J0IERhaWx5Um90YXRlRmlsZSBmcm9tICd3aW5zdG9uLWRhaWx5LXJvdGF0ZS1maWxlJztcbmltcG9ydCB7IGRpcm5hbWUgfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZpbGVVUkxUb1BhdGggfSBmcm9tICd1cmwnO1xuXG5leHBvcnQgY29uc3QgX19maWxlbmFtZSA9IGZpbGVVUkxUb1BhdGgoaW1wb3J0Lm1ldGEudXJsKTtcbmV4cG9ydCBjb25zdCBfX2Rpcm5hbWUgPSBkaXJuYW1lKF9fZmlsZW5hbWUpO1xuXG5jb25maWcoeyBwYXRoOiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vY29uZmlnL2Vudi9iYWNrZW5kLnN0YXJ0dXAuZW52JykgfSk7XG5cbmZ1bmN0aW9uIHNldHVwTG9nZ2luZygpOiBSZXR1cm5UeXBlPHR5cGVvZiBjcmVhdGVMb2dnZXI+IHtcblx0Y29uc3QgbG9nRGlyZWN0b3J5ID0gcHJvY2Vzcy5lbnYuQVBQX0lOSVRfTE9HU19QQVRIO1xuXG5cdGlmIChsb2dEaXJlY3RvcnkpIHtcblx0XHRpZiAoIWZzLmV4aXN0c1N5bmMobG9nRGlyZWN0b3J5KSkge1xuXHRcdFx0ZnMubWtkaXJTeW5jKGxvZ0RpcmVjdG9yeSwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG5cdFx0fVxuXHR9IGVsc2Uge1xuXHRcdGhhbmRsZUZhdGFsRXJyb3IoXG5cdFx0XHQnTG9nIGRpcmVjdG9yeSBpcyB1bmRlZmluZWQuIFBsZWFzZSBjaGVjayBBUFBfSU5JVF9MT0dTX1BBVEguJ1xuXHRcdCk7XG5cdH1cblxuXHRyZXR1cm4gY3JlYXRlTG9nZ2VyKHtcblx0XHRmb3JtYXQ6IGZvcm1hdC5jb21iaW5lKGZvcm1hdC50aW1lc3RhbXAoKSwgZm9ybWF0Lmpzb24oKSksXG5cdFx0dHJhbnNwb3J0czogW1xuXHRcdFx0bmV3IERhaWx5Um90YXRlRmlsZSh7XG5cdFx0XHRcdGZpbGVuYW1lOiBwYXRoLmpvaW4oXG5cdFx0XHRcdFx0bG9nRGlyZWN0b3J5ISxcblx0XHRcdFx0XHQnYWRtaW5Mb2dpbkF0dGVtcHRzLSVEQVRFJS5sb2cnXG5cdFx0XHRcdCksXG5cdFx0XHRcdGRhdGVQYXR0ZXJuOiAnWVlZWS1NTS1ERCcsXG5cdFx0XHRcdG1heFNpemU6ICcyMG0nLFxuXHRcdFx0XHRtYXhGaWxlczogJzMwZCcsXG5cdFx0XHRcdHppcHBlZEFyY2hpdmU6IHRydWVcblx0XHRcdH0pXG5cdFx0XVxuXHR9KTtcbn1cblxuY29uc3Qgc3RhcnR1cExvZ2dlciA9IHNldHVwTG9nZ2luZygpO1xuXG5mdW5jdGlvbiBnZXRTeXN0ZW1EZXRhaWxzKCk6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4ge1xuXHRjb25zdCBpbnRlcmZhY2VzID0gb3MubmV0d29ya0ludGVyZmFjZXMoKTtcblx0bGV0IGlwdjQ6IHN0cmluZyB8IHVuZGVmaW5lZDtcblx0bGV0IGlwdjY6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuXHRmb3IgKGNvbnN0IG5hbWUgb2YgT2JqZWN0LmtleXMoaW50ZXJmYWNlcykpIHtcblx0XHRmb3IgKGNvbnN0IG5ldCBvZiBpbnRlcmZhY2VzW25hbWVdIHx8IFtdKSB7XG5cdFx0XHRpZiAobmV0LmZhbWlseSA9PT0gJ0lQdjQnICYmICFuZXQuaW50ZXJuYWwgJiYgIWlwdjQpXG5cdFx0XHRcdGlwdjQgPSBuZXQuYWRkcmVzcztcblx0XHRcdGlmIChuZXQuZmFtaWx5ID09PSAnSVB2NicgJiYgIW5ldC5pbnRlcm5hbCAmJiAhaXB2Nilcblx0XHRcdFx0aXB2NiA9IG5ldC5hZGRyZXNzO1xuXHRcdH1cblx0fVxuXG5cdHJldHVybiB7XG5cdFx0aG9zdG5hbWU6IG9zLmhvc3RuYW1lKCksXG5cdFx0cGxhdGZvcm06IG9zLnBsYXRmb3JtKCksXG5cdFx0Y3B1QXJjaDogb3MuYXJjaCgpLFxuXHRcdGlwdjQ6IGlwdjQgfHwgJ04vQScsXG5cdFx0aXB2NjogaXB2NiB8fCAnTi9BJ1xuXHR9O1xufVxuXG5mdW5jdGlvbiBoYW5kbGVGYXRhbEVycm9yKG1lc3NhZ2U6IHN0cmluZyk6IHZvaWQge1xuXHRjb25zb2xlLmVycm9yKGAke21lc3NhZ2V9XFxuU2h1dHRpbmcgZG93bi4uLmApO1xuXHRwcm9jZXNzLmV4aXQoMSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHByb21wdENyZWRlbnRpYWxzKCk6IFByb21pc2U8e1xuXHR1c2VybmFtZTogc3RyaW5nO1xuXHRwYXNzd29yZDogc3RyaW5nO1xufT4ge1xuXHRjb25zdCBybCA9IHJlYWRsaW5lLmNyZWF0ZUludGVyZmFjZSh7XG5cdFx0aW5wdXQ6IHByb2Nlc3Muc3RkaW4sXG5cdFx0b3V0cHV0OiBwcm9jZXNzLnN0ZG91dFxuXHR9KTtcblxuXHRjb25zdCB1c2VybmFtZSA9IGF3YWl0IG5ldyBQcm9taXNlPHN0cmluZz4ocmVzb2x2ZSA9PlxuXHRcdHJsLnF1ZXN0aW9uKCdFbnRlciBBZG1pbiBVc2VybmFtZTogJywgcmVzb2x2ZSlcblx0KTtcblxuXHRjb25zdCBwYXNzd29yZCA9IGF3YWl0IG5ldyBQcm9taXNlPHN0cmluZz4ocmVzb2x2ZSA9PiB7XG5cdFx0bGV0IGlucHV0ID0gJyc7XG5cdFx0cmVhZGxpbmUuZW1pdEtleXByZXNzRXZlbnRzKHByb2Nlc3Muc3RkaW4pO1xuXHRcdHByb2Nlc3Muc3RkaW4uc2V0UmF3TW9kZSh0cnVlKTtcblxuXHRcdHByb2Nlc3Muc3RkaW4ub24oJ2tleXByZXNzJywgKHN0ciwga2V5KSA9PiB7XG5cdFx0XHRpZiAoa2V5Lm5hbWUgPT09ICdyZXR1cm4nKSB7XG5cdFx0XHRcdHByb2Nlc3Muc3RkaW4uc2V0UmF3TW9kZShmYWxzZSk7XG5cdFx0XHRcdHJsLndyaXRlKCdcXG4nKTtcblx0XHRcdFx0cHJvY2Vzcy5zdGRpbi5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2tleXByZXNzJyk7XG5cdFx0XHRcdHJsLmNsb3NlKCk7XG5cdFx0XHRcdHJlc29sdmUoaW5wdXQpO1xuXHRcdFx0fSBlbHNlIGlmIChrZXkubmFtZSA9PT0gJ2JhY2tzcGFjZScpIHtcblx0XHRcdFx0aWYgKGlucHV0Lmxlbmd0aCA+IDApIHtcblx0XHRcdFx0XHRpbnB1dCA9IGlucHV0LnNsaWNlKDAsIC0xKTtcblx0XHRcdFx0XHRvdXRwdXQud3JpdGUoJ1xcYiBcXGInKTtcblx0XHRcdFx0fVxuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0aW5wdXQgKz0gc3RyO1xuXHRcdFx0XHRvdXRwdXQud3JpdGUoJyonKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fSk7XG5cblx0cmV0dXJuIHsgdXNlcm5hbWUsIHBhc3N3b3JkIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHByb21wdEFkbWluU2VjcmV0KHByb21wdE1lc3NhZ2U6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG5cdGNvbnN0IHJsID0gcmVhZGxpbmUuY3JlYXRlSW50ZXJmYWNlKHtcblx0XHRpbnB1dDogcHJvY2Vzcy5zdGRpbixcblx0XHRvdXRwdXQ6IHByb2Nlc3Muc3Rkb3V0XG5cdH0pO1xuXHRjb25zdCBzZWNyZXQgPSBhd2FpdCBuZXcgUHJvbWlzZTxzdHJpbmc+KHJlc29sdmUgPT5cblx0XHRybC5xdWVzdGlvbihwcm9tcHRNZXNzYWdlLCByZXNvbHZlKVxuXHQpO1xuXHRybC5jbG9zZSgpO1xuXHRyZXR1cm4gc2VjcmV0O1xufVxuXG5mdW5jdGlvbiBnZXRBZG1pbkNyZWRlbnRpYWxzKCk6IHtcblx0dXNlcm5hbWVUb1Bhc3N3b3JkTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCB1bmRlZmluZWQ+O1xuXHR1c2VybmFtZVRvQWRtaW5JZE1hcDogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgdW5kZWZpbmVkPjtcbn0ge1xuXHRjb25zdCB1c2VybmFtZVRvUGFzc3dvcmRNYXA6IFJlY29yZDxzdHJpbmcsIHN0cmluZyB8IHVuZGVmaW5lZD4gPSB7fTtcblx0Y29uc3QgdXNlcm5hbWVUb0FkbWluSWRNYXA6IFJlY29yZDxzdHJpbmcsIHN0cmluZyB8IHVuZGVmaW5lZD4gPSB7fTtcblxuXHRmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhwcm9jZXNzLmVudikpIHtcblx0XHRpZiAoa2V5LnN0YXJ0c1dpdGgoJ0FETUlOX1VTRVJOQU1FXycpKSB7XG5cdFx0XHRjb25zdCBhZG1pbkluZGV4ID0ga2V5LnNwbGl0KCdfJylbMl07XG5cdFx0XHR1c2VybmFtZVRvUGFzc3dvcmRNYXBbcHJvY2Vzcy5lbnZba2V5XSFdID1cblx0XHRcdFx0cHJvY2Vzcy5lbnZbYEFETUlOX1BBU1NXT1JEXyR7YWRtaW5JbmRleH1gXTtcblx0XHRcdHVzZXJuYW1lVG9BZG1pbklkTWFwW3Byb2Nlc3MuZW52W2tleV0hXSA9XG5cdFx0XHRcdHByb2Nlc3MuZW52W2BBRE1JTl9JRF8ke2FkbWluSW5kZXh9YF07XG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIHsgdXNlcm5hbWVUb1Bhc3N3b3JkTWFwLCB1c2VybmFtZVRvQWRtaW5JZE1hcCB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiB2YWxpZGF0ZUNyZWRlbnRpYWxzKFxuXHR1c2VybmFtZTogc3RyaW5nLFxuXHRwYXNzd29yZDogc3RyaW5nLFxuXHRhZG1pbkNyZWRlbnRpYWxzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCB1bmRlZmluZWQ+XG4pOiBQcm9taXNlPGJvb2xlYW4+IHtcblx0Y29uc3Qgc3RvcmVkSGFzaGVkUGFzc3dvcmQgPSBhZG1pbkNyZWRlbnRpYWxzW3VzZXJuYW1lXTtcblx0cmV0dXJuIHN0b3JlZEhhc2hlZFBhc3N3b3JkXG5cdFx0PyBhcmdvbjIudmVyaWZ5KHN0b3JlZEhhc2hlZFBhc3N3b3JkLCBwYXNzd29yZClcblx0XHQ6IGZhbHNlO1xufVxuXG5hc3luYyBmdW5jdGlvbiB2YWxpZGF0ZUFkbWluU2VjcmV0KFxuXHRrZXk6IHN0cmluZyxcblx0cHJlZml4OiBzdHJpbmdcbik6IFByb21pc2U8Ym9vbGVhbj4ge1xuXHRjb25zdCBhbGxvd2VkS2V5cyA9IE9iamVjdC5rZXlzKHByb2Nlc3MuZW52KVxuXHRcdC5maWx0ZXIoZW52S2V5ID0+IGVudktleS5zdGFydHNXaXRoKHByZWZpeCkpXG5cdFx0Lm1hcChlbnZLZXkgPT4gcHJvY2Vzcy5lbnZbZW52S2V5XSEpO1xuXG5cdHJldHVybiBQcm9taXNlLmFueShcblx0XHRhbGxvd2VkS2V5cy5tYXAoaGFzaGVkS2V5ID0+IGFyZ29uMi52ZXJpZnkoaGFzaGVkS2V5LCBrZXkpKVxuXHQpXG5cdFx0LnRoZW4oKCkgPT4gdHJ1ZSlcblx0XHQuY2F0Y2goKCkgPT4gZmFsc2UpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBsb2dBdHRlbXB0KFxuXHRzdWNjZXNzOiBib29sZWFuLFxuXHR1c2VybmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkLFxuXHRldmVudFR5cGU6IHN0cmluZ1xuKTogUHJvbWlzZTx2b2lkPiB7XG5cdHN0YXJ0dXBMb2dnZXIuaW5mbyh7XG5cdFx0dGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG5cdFx0dXNlcm5hbWU6IHVzZXJuYW1lIHx8ICdVbmtub3duJyxcblx0XHRzdWNjZXNzLFxuXHRcdGV2ZW50VHlwZSxcblx0XHRzeXN0ZW1Vc2VyOiBvcy51c2VySW5mbygpLnVzZXJuYW1lLFxuXHRcdC4uLmdldFN5c3RlbURldGFpbHMoKVxuXHR9KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxvZ2luKCk6IFByb21pc2U8e1xuXHRlbmNyeXB0aW9uS2V5OiBzdHJpbmcgfCBudWxsO1xuXHRncGdQYXNzcGhyYXNlOiBzdHJpbmcgfCBudWxsO1xuXHRhZG1pbklkOiBudW1iZXIgfCBudWxsO1xufT4ge1xuXHRsZXQgcmV0cmllcyA9IDM7XG5cblx0Y29uc29sZS5sb2coXG5cdFx0J1dlbGNvbWUgdG8gdGhlIGFwcGxpY2F0aW9uIEFkbWluIExvZ2luLiBQbGVhc2UgZW50ZXIgeW91ciBjcmVkZW50aWFscy4nXG5cdCk7XG5cblx0Y29uc3QgeyB1c2VybmFtZVRvUGFzc3dvcmRNYXAsIHVzZXJuYW1lVG9BZG1pbklkTWFwIH0gPVxuXHRcdGdldEFkbWluQ3JlZGVudGlhbHMoKTtcblx0aWYgKCFPYmplY3Qua2V5cyh1c2VybmFtZVRvUGFzc3dvcmRNYXApLmxlbmd0aClcblx0XHRoYW5kbGVGYXRhbEVycm9yKCdObyBhZG1pbiBjcmVkZW50aWFscyBmb3VuZC4nKTtcblxuXHR3aGlsZSAocmV0cmllcyA+IDApIHtcblx0XHRjb25zdCB7IHVzZXJuYW1lLCBwYXNzd29yZCB9ID0gYXdhaXQgcHJvbXB0Q3JlZGVudGlhbHMoKTtcblx0XHRjb25zdCB2YWxpZCA9IGF3YWl0IHZhbGlkYXRlQ3JlZGVudGlhbHMoXG5cdFx0XHR1c2VybmFtZSxcblx0XHRcdHBhc3N3b3JkLFxuXHRcdFx0dXNlcm5hbWVUb1Bhc3N3b3JkTWFwXG5cdFx0KTtcblxuXHRcdGlmICh2YWxpZCkge1xuXHRcdFx0Y29uc3QgYWRtaW5JZCA9IHVzZXJuYW1lVG9BZG1pbklkTWFwW3VzZXJuYW1lXTtcblx0XHRcdGlmICghYWRtaW5JZCkge1xuXHRcdFx0XHRoYW5kbGVGYXRhbEVycm9yKCdBZG1pbiBJRCBub3QgZm91bmQuJyk7XG5cdFx0XHRcdHJldHVybiB7XG5cdFx0XHRcdFx0ZW5jcnlwdGlvbktleTogbnVsbCxcblx0XHRcdFx0XHRncGdQYXNzcGhyYXNlOiBudWxsLFxuXHRcdFx0XHRcdGFkbWluSWQ6IG51bGxcblx0XHRcdFx0fTtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgZW5jcnlwdGlvbktleSA9IGF3YWl0IGhhbmRsZVNlY3JldFZhbGlkYXRpb24oXG5cdFx0XHRcdCdFbnRlciBFbmNyeXB0aW9uIEtleTogJyxcblx0XHRcdFx0J0VOQ1JZUFRJT05fS0VZXydcblx0XHRcdCk7XG5cdFx0XHRjb25zdCBncGdQYXNzcGhyYXNlID0gYXdhaXQgaGFuZGxlU2VjcmV0VmFsaWRhdGlvbihcblx0XHRcdFx0J0VudGVyIEdQRyBQYXNzcGhyYXNlOiAnLFxuXHRcdFx0XHQnR1BHX1BBU1NQSFJBU0VfJ1xuXHRcdFx0KTtcblxuXHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0ZW5jcnlwdGlvbktleSxcblx0XHRcdFx0Z3BnUGFzc3BocmFzZSxcblx0XHRcdFx0YWRtaW5JZDogcGFyc2VJbnQoYWRtaW5JZCwgMTApXG5cdFx0XHR9O1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRyZXRyaWVzLS07XG5cdFx0XHRjb25zb2xlLmxvZyhgSW52YWxpZCBjcmVkZW50aWFscy4gQXR0ZW1wdHMgbGVmdDogJHtyZXRyaWVzfWApO1xuXHRcdFx0YXdhaXQgbG9nQXR0ZW1wdChmYWxzZSwgdXNlcm5hbWUsICdsb2dpbicpO1xuXHRcdH1cblx0fVxuXG5cdGhhbmRsZUZhdGFsRXJyb3IoJ01heGltdW0gcmV0cmllcyByZWFjaGVkLicpO1xuXG5cdHJldHVybiB7IGVuY3J5cHRpb25LZXk6IG51bGwsIGdwZ1Bhc3NwaHJhc2U6IG51bGwsIGFkbWluSWQ6IG51bGwgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaGFuZGxlU2VjcmV0VmFsaWRhdGlvbihcblx0cHJvbXB0TWVzc2FnZTogc3RyaW5nLFxuXHRwcmVmaXg6IHN0cmluZ1xuKTogUHJvbWlzZTxzdHJpbmc+IHtcblx0Zm9yIChsZXQgYXR0ZW1wdHMgPSAwOyBhdHRlbXB0cyA8IDM7IGF0dGVtcHRzKyspIHtcblx0XHRjb25zdCBzZWNyZXQgPSBhd2FpdCBwcm9tcHRBZG1pblNlY3JldChwcm9tcHRNZXNzYWdlKTtcblx0XHRpZiAoYXdhaXQgdmFsaWRhdGVBZG1pblNlY3JldChzZWNyZXQsIHByZWZpeCkpIHtcblx0XHRcdGF3YWl0IGxvZ0F0dGVtcHQoXG5cdFx0XHRcdHRydWUsXG5cdFx0XHRcdHVuZGVmaW5lZCxcblx0XHRcdFx0YCR7cHJlZml4LnRvTG93ZXJDYXNlKCl9LXZhbGlkYXRpb25gXG5cdFx0XHQpO1xuXHRcdFx0cmV0dXJuIHNlY3JldDtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc29sZS5sb2coYEludmFsaWQgJHtwcm9tcHRNZXNzYWdlLnRyaW0oKX0uIFBsZWFzZSB0cnkgYWdhaW4uYCk7XG5cdFx0fVxuXHR9XG5cblx0aGFuZGxlRmF0YWxFcnJvcihgTWF4aW11bSAke3Byb21wdE1lc3NhZ2UudHJpbSgpfSByZXRyaWVzIHJlYWNoZWQuYCk7XG5cdHJldHVybiAnJztcbn1cbiJdfQ==
