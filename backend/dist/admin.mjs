import argon2 from 'argon2';
import { config } from 'dotenv';
import fs from 'fs';
import os from 'os';
import path from 'path';
import { stdout as output } from 'process';
import readline from 'readline';
import { createLogger, format } from 'winston';
import DailyRotateFile from 'winston-daily-rotate-file';
config({ path: path.resolve(__dirname, '../config/env/backend.startup.env') });
function setupLogging() {
	const logDirectory = process.env.APP_INIT_LOGS_PATH;
	if (logDirectory) {
		if (!fs.existsSync(logDirectory)) {
			fs.mkdirSync(logDirectory, { recursive: true });
		}
	} else {
		handleFatalError(
			'Log directory is undefined. Please check APP_INIT_LOGS_PATH.'
		);
	}
	return createLogger({
		format: format.combine(format.timestamp(), format.json()),
		transports: [
			new DailyRotateFile({
				filename: path.join(
					logDirectory,
					'adminLoginAttempts-%DATE%.log'
				),
				datePattern: 'YYYY-MM-DD',
				maxSize: '20m',
				maxFiles: '30d',
				zippedArchive: true
			})
		]
	});
}
const startupLogger = setupLogging();
function getSystemDetails() {
	const interfaces = os.networkInterfaces();
	let ipv4;
	let ipv6;
	for (const name of Object.keys(interfaces)) {
		for (const net of interfaces[name] || []) {
			if (net.family === 'IPv4' && !net.internal && !ipv4)
				ipv4 = net.address;
			if (net.family === 'IPv6' && !net.internal && !ipv6)
				ipv6 = net.address;
		}
	}
	return {
		hostname: os.hostname(),
		platform: os.platform(),
		cpuArch: os.arch(),
		ipv4: ipv4 || 'N/A',
		ipv6: ipv6 || 'N/A'
	};
}
function handleFatalError(message) {
	console.error(`${message}\nShutting down...`);
	process.exit(1);
}
async function promptCredentials() {
	const rl = readline.createInterface({
		input: process.stdin,
		output: process.stdout
	});
	const username = await new Promise(resolve =>
		rl.question('Enter Admin Username: ', resolve)
	);
	const password = await new Promise(resolve => {
		let input = '';
		readline.emitKeypressEvents(process.stdin);
		process.stdin.setRawMode(true);
		process.stdin.on('keypress', (str, key) => {
			if (key.name === 'return') {
				process.stdin.setRawMode(false);
				rl.write('\n');
				process.stdin.removeAllListeners('keypress');
				rl.close();
				resolve(input);
			} else if (key.name === 'backspace') {
				if (input.length > 0) {
					input = input.slice(0, -1);
					output.write('\b \b');
				}
			} else {
				input += str;
				output.write('*');
			}
		});
	});
	return { username, password };
}
async function promptAdminSecret(promptMessage) {
	const rl = readline.createInterface({
		input: process.stdin,
		output: process.stdout
	});
	const secret = await new Promise(resolve =>
		rl.question(promptMessage, resolve)
	);
	rl.close();
	return secret;
}
function getAdminCredentials() {
	const usernameToPasswordMap = {};
	const usernameToAdminIdMap = {};
	for (const key of Object.keys(process.env)) {
		if (key.startsWith('ADMIN_USERNAME_')) {
			const adminIndex = key.split('_')[2];
			usernameToPasswordMap[process.env[key]] =
				process.env[`ADMIN_PASSWORD_${adminIndex}`];
			usernameToAdminIdMap[process.env[key]] =
				process.env[`ADMIN_ID_${adminIndex}`];
		}
	}
	return { usernameToPasswordMap, usernameToAdminIdMap };
}
async function validateCredentials(username, password, adminCredentials) {
	const storedHashedPassword = adminCredentials[username];
	return storedHashedPassword
		? argon2.verify(storedHashedPassword, password)
		: false;
}
async function validateAdminSecret(key, prefix) {
	const allowedKeys = Object.keys(process.env)
		.filter(envKey => envKey.startsWith(prefix))
		.map(envKey => process.env[envKey]);
	return Promise.any(
		allowedKeys.map(hashedKey => argon2.verify(hashedKey, key))
	)
		.then(() => true)
		.catch(() => false);
}
async function logAttempt(success, username, eventType) {
	startupLogger.info({
		timestamp: new Date().toISOString(),
		username: username || 'Unknown',
		success,
		eventType,
		systemUser: os.userInfo().username,
		...getSystemDetails()
	});
}
export async function login() {
	let retries = 3;
	console.log(
		'Welcome to the application Admin Login. Please enter your credentials.'
	);
	const { usernameToPasswordMap, usernameToAdminIdMap } =
		getAdminCredentials();
	if (!Object.keys(usernameToPasswordMap).length)
		handleFatalError('No admin credentials found.');
	while (retries > 0) {
		const { username, password } = await promptCredentials();
		const valid = await validateCredentials(
			username,
			password,
			usernameToPasswordMap
		);
		if (valid) {
			const adminId = usernameToAdminIdMap[username];
			if (!adminId) {
				handleFatalError('Admin ID not found.');
				return {
					encryptionKey: null,
					gpgPassphrase: null,
					adminId: null
				};
			}
			const encryptionKey = await handleSecretValidation(
				'Enter Encryption Key: ',
				'ENCRYPTION_KEY_'
			);
			const gpgPassphrase = await handleSecretValidation(
				'Enter GPG Passphrase: ',
				'GPG_PASSPHRASE_'
			);
			return {
				encryptionKey,
				gpgPassphrase,
				adminId: parseInt(adminId, 10)
			};
		} else {
			retries--;
			console.log(`Invalid credentials. Attempts left: ${retries}`);
			await logAttempt(false, username, 'login');
		}
	}
	handleFatalError('Maximum retries reached.');
	return { encryptionKey: null, gpgPassphrase: null, adminId: null };
}
async function handleSecretValidation(promptMessage, prefix) {
	for (let attempts = 0; attempts < 3; attempts++) {
		const secret = await promptAdminSecret(promptMessage);
		if (await validateAdminSecret(secret, prefix)) {
			await logAttempt(
				true,
				undefined,
				`${prefix.toLowerCase()}-validation`
			);
			return secret;
		} else {
			console.log(`Invalid ${promptMessage.trim()}. Please try again.`);
		}
	}
	handleFatalError(`Maximum ${promptMessage.trim()} retries reached.`);
	return '';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRtaW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvYWRtaW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxNQUFNLE1BQU0sUUFBUSxDQUFDO0FBQzVCLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDaEMsT0FBTyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3BCLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQztBQUNwQixPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxFQUFFLE1BQU0sSUFBSSxNQUFNLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDM0MsT0FBTyxRQUFRLE1BQU0sVUFBVSxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQy9DLE9BQU8sZUFBZSxNQUFNLDJCQUEyQixDQUFDO0FBRXhELE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxtQ0FBbUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUUvRSxTQUFTLFlBQVk7SUFDcEIsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQztJQUVwRCxJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUM7WUFDbEMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNqRCxDQUFDO0lBQ0YsQ0FBQztTQUFNLENBQUM7UUFDUCxnQkFBZ0IsQ0FDZiw4REFBOEQsQ0FDOUQsQ0FBQztJQUNILENBQUM7SUFFRCxPQUFPLFlBQVksQ0FBQztRQUNuQixNQUFNLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLEVBQUUsTUFB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QUssSUFBSSxRQUFRLEdBQUcsQ0FBQyxFQUFFLFFBQVEsR0FBRyxDQUFDLEVBQUUsUUFBUSxFQUFFLEVBQUUsQ0FBQztRQUNqRCxNQUFNLE1BQU0sR0FBRyxNQUFNLGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3RELElBQUksTUFBTSxtQkFBbUIsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUMvQyxNQUFNLFVBQVUsQ0FDZixJQUFJLEVBQ0osU0FBUyxFQUNULEdBQUcsTUFBTSxDQUFDLFdBQVcsRUFBRSxhQUFhLENBQ3BDLENBQUM7WUFDRixPQUFPLE1BQU0sQ0FBQztRQUNmLENBQUM7YUFBTSxDQUFDO1lBQ1AsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLGFBQWEsQ0FBQyxJQUFJLEVBQUUscUJBQXFCLENBQUMsQ0FBQztRQUNuRSxDQUFDO0lBQ0YsQ0FBQztJQUVELGdCQUFnQixDQUFDLFdBQVcsYUFBYSxDQUFDLElBQUksRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO0lBQ3JFLE9BQU8sRUFBRSxDQUFDO0FBQ1gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBhcmdvbjIgZnJvbSAnYXJnb24yJztcbmltcG9ydCB7IGNvbmZpZyB9IGZyb20gJ2RvdGVudic7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgc3Rkb3V0IGFzIG91dHB1dCB9IGZyb20gJ3Byb2Nlc3MnO1xuaW1wb3J0IHJlYWRsaW5lIGZyb20gJ3JlYWRsaW5lJztcbmltcG9ydCB7IGNyZWF0ZUxvZ2dlciwgZm9ybWF0IH0gZnJvbSAnd2luc3Rvbic7XG5pbXBvcnQgRGFpbHlSb3RhdGVGaWxlIGZyb20gJ3dpbnN0b24tZGFpbHktcm90YXRlLWZpbGUnO1xuXG5jb25maWcoeyBwYXRoOiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vY29uZmlnL2Vudi9iYWNrZW5kLnN0YXJ0dXAuZW52JykgfSk7XG5cbmZ1bmN0aW9uIHNldHVwTG9nZ2luZygpOiBSZXR1cm5UeXBlPHR5cGVvZiBjcmVhdGVMb2dnZXI+IHtcblx0Y29uc3QgbG9nRGlyZWN0b3J5ID0gcHJvY2Vzcy5lbnYuQVBQX0lOSVRfTE9HU19QQVRIO1xuXG5cdGlmIChsb2dEaXJlY3RvcnkpIHtcblx0XHRpZiAoIWZzLmV4aXN0c1N5bmMobG9nRGlyZWN0b3J5KSkge1xuXHRcdFx0ZnMubWtkaXJTeW5jKGxvZ0RpcmVjdG9yeSwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG5cdFx0fVxuXHR9IGVsc2Uge1xuXHRcdGhhbmRsZUZhdGFsRXJyb3IoXG5cdFx0XHQnTG9nIGRpcmVjdG9yeSBpcyB1bmRlZmluZWQuIFBsZWFzZSBjaGVjayBBUFBfSU5JVF9MT0dTX1BBVEguJ1xuXHRcdCk7XG5cdH1cblxuXHRyZXR1cm4gY3JlYXRlTG9nZ2VyKHtcblx0XHRmb3JtYXQ6IGZvcm1hdC5jb21iaW5lKGZvcm1hdC50aW1lc3RhbXAoKSwgZm9ybWF0Lmpzb24oKSksXG5cdFx0dHJhbnNwb3J0czogW1xuXHRcdFx0bmV3IERhaWx5Um90YXRlRmlsZSh7XG5cdFx0XHRcdGZpbGVuYW1lOiBwYXRoLmpvaW4oXG5cdFx0XHRcdFx0bG9nRGlyZWN0b3J5ISxcblx0XHRcdFx0XHQnYWRtaW5Mb2dpbkF0dGVtcHRzLSVEQVRFJS5sb2cnXG5cdFx0XHRcdCksXG5cdFx0XHRcdGRhdGVQYXR0ZXJuOiAnWVlZWS1NTS1ERCcsXG5cdFx0XHRcdG1heFNpemU6ICcyMG0nLFxuXHRcdFx0XHRtYXhGaWxlczogJzMwZCcsXG5cdFx0XHRcdHppcHBlZEFyY2hpdmU6IHRydWVcblx0XHRcdH0pXG5cdFx0XVxuXHR9KTtcbn1cblxuY29uc3Qgc3RhcnR1cExvZ2dlciA9IHNldHVwTG9nZ2luZygpO1xuXG5mdW5jdGlvbiBnZXRTeXN0ZW1EZXRhaWxzKCk6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4ge1xuXHRjb25zdCBpbnRlcmZhY2VzID0gb3MubmV0d29ya0ludGVyZmFjZXMoKTtcblx0bGV0IGlwdjQ6IHN0cmluZyB8IHVuZGVmaW5lZDtcblx0bGV0IGlwdjY6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuXHRmb3IgKGNvbnN0IG5hbWUgb2YgT2JqZWN0LmtleXMoaW50ZXJmYWNlcykpIHtcblx0XHRmb3IgKGNvbnN0IG5ldCBvZiBpbnRlcmZhY2VzW25hbWVdIHx8IFtdKSB7XG5cdFx0XHRpZiAobmV0LmZhbWlseSA9PT0gJ0lQdjQnICYmICFuZXQuaW50ZXJuYWwgJiYgIWlwdjQpXG5cdFx0XHRcdGlwdjQgPSBuZXQuYWRkcmVzcztcblx0XHRcdGlmIChuZXQuZmFtaWx5ID09PSAnSVB2NicgJiYgIW5ldC5pbnRlcm5hbCAmJiAhaXB2Nilcblx0XHRcdFx0aXB2NiA9IG5ldC5hZGRyZXNzO1xuXHRcdH1cblx0fVxuXG5cdHJldHVybiB7XG5cdFx0aG9zdG5hbWU6IG9zLmhvc3RuYW1lKCksXG5cdFx0cGxhdGZvcm06IG9zLnBsYXRmb3JtKCksXG5cdFx0Y3B1QXJjaDogb3MuYXJjaCgpLFxuXHRcdGlwdjQ6IGlwdjQgfHwgJ04vQScsXG5cdFx0aXB2NjogaXB2NiB8fCAnTi9BJ1xuXHR9O1xufVxuXG5mdW5jdGlvbiBoYW5kbGVGYXRhbEVycm9yKG1lc3NhZ2U6IHN0cmluZyk6IHZvaWQge1xuXHRjb25zb2xlLmVycm9yKGAke21lc3NhZ2V9XFxuU2h1dHRpbmcgZG93bi4uLmApO1xuXHRwcm9jZXNzLmV4aXQoMSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHByb21wdENyZWRlbnRpYWxzKCk6IFByb21pc2U8e1xuXHR1c2VybmFtZTogc3RyaW5nO1xuXHRwYXNzd29yZDogc3RyaW5nO1xufT4ge1xuXHRjb25zdCBybCA9IHJlYWRsaW5lLmNyZWF0ZUludGVyZmFjZSh7XG5cdFx0aW5wdXQ6IHByb2Nlc3Muc3RkaW4sXG5cdFx0b3V0cHV0OiBwcm9jZXNzLnN0ZG91dFxuXHR9KTtcblxuXHRjb25zdCB1c2VybmFtZSA9IGF3YWl0IG5ldyBQcm9taXNlPHN0cmluZz4ocmVzb2x2ZSA9PlxuXHRcdHJsLnF1ZXN0aW9uKCdFbnRlciBBZG1pbiBVc2VybmFtZTogJywgcmVzb2x2ZSlcblx0KTtcblxuXHRjb25zdCBwYXNzd29yZCA9IGF3YWl0IG5ldyBQcm9taXNlPHN0cmluZz4ocmVzb2x2ZSA9PiB7XG5cdFx0bGV0IGlucHV0ID0gJyc7XG5cdFx0cmVhZGxpbmUuZW1pdEtleXByZXNzRXZlbnRzKHByb2Nlc3Muc3RkaW4pO1xuXHRcdHByb2Nlc3Muc3RkaW4uc2V0UmF3TW9kZSh0cnVlKTtcblxuXHRcdHByb2Nlc3Muc3RkaW4ub24oJ2tleXByZXNzJywgKHN0ciwga2V5KSA9PiB7XG5cdFx0XHRpZiAoa2V5Lm5hbWUgPT09ICdyZXR1cm4nKSB7XG5cdFx0XHRcdHByb2Nlc3Muc3RkaW4uc2V0UmF3TW9kZShmYWxzZSk7XG5cdFx0XHRcdHJsLndyaXRlKCdcXG4nKTtcblx0XHRcdFx0cHJvY2Vzcy5zdGRpbi5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2tleXByZXNzJyk7XG5cdFx0XHRcdHJsLmNsb3NlKCk7XG5cdFx0XHRcdHJlc29sdmUoaW5wdXQpO1xuXHRcdFx0fSBlbHNlIGlmIChrZXkubmFtZSA9PT0gJ2JhY2tzcGFjZScpIHtcblx0XHRcdFx0aWYgKGlucHV0Lmxlbmd0aCA+IDApIHtcblx0XHRcdFx0XHRpbnB1dCA9IGlucHV0LnNsaWNlKDAsIC0xKTtcblx0XHRcdFx0XHRvdXRwdXQud3JpdGUoJ1xcYiBcXGInKTtcblx0XHRcdFx0fVxuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0aW5wdXQgKz0gc3RyO1xuXHRcdFx0XHRvdXRwdXQud3JpdGUoJyonKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fSk7XG5cblx0cmV0dXJuIHsgdXNlcm5hbWUsIHBhc3N3b3JkIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHByb21wdEFkbWluU2VjcmV0KHByb21wdE1lc3NhZ2U6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG5cdGNvbnN0IHJsID0gcmVhZGxpbmUuY3JlYXRlSW50ZXJmYWNlKHtcblx0XHRpbnB1dDogcHJvY2Vzcy5zdGRpbixcblx0XHRvdXRwdXQ6IHByb2Nlc3Muc3Rkb3V0XG5cdH0pO1xuXHRjb25zdCBzZWNyZXQgPSBhd2FpdCBuZXcgUHJvbWlzZTxzdHJpbmc+KHJlc29sdmUgPT5cblx0XHRybC5xdWVzdGlvbihwcm9tcHRNZXNzYWdlLCByZXNvbHZlKVxuXHQpO1xuXHRybC5jbG9zZSgpO1xuXHRyZXR1cm4gc2VjcmV0O1xufVxuXG5mdW5jdGlvbiBnZXRBZG1pbkNyZWRlbnRpYWxzKCk6IHtcblx0dXNlcm5hbWVUb1Bhc3N3b3JkTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCB1bmRlZmluZWQ+O1xuXHR1c2VybmFtZVRvQWRtaW5JZE1hcDogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgdW5kZWZpbmVkPjtcbn0ge1xuXHRjb25zdCB1c2VybmFtZVRvUGFzc3dvcmRNYXA6IFJlY29yZDxzdHJpbmcsIHN0cmluZyB8IHVuZGVmaW5lZD4gPSB7fTtcblx0Y29uc3QgdXNlcm5hbWVUb0FkbWluSWRNYXA6IFJlY29yZDxzdHJpbmcsIHN0cmluZyB8IHVuZGVmaW5lZD4gPSB7fTtcblxuXHRmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhwcm9jZXNzLmVudikpIHtcblx0XHRpZiAoa2V5LnN0YXJ0c1dpdGgoJ0FETUlOX1VTRVJOQU1FXycpKSB7XG5cdFx0XHRjb25zdCBhZG1pbkluZGV4ID0ga2V5LnNwbGl0KCdfJylbMl07XG5cdFx0XHR1c2VybmFtZVRvUGFzc3dvcmRNYXBbcHJvY2Vzcy5lbnZba2V5XSFdID1cblx0XHRcdFx0cHJvY2Vzcy5lbnZbYEFETUlOX1BBU1NXT1JEXyR7YWRtaW5JbmRleH1gXTtcblx0XHRcdHVzZXJuYW1lVG9BZG1pbklkTWFwW3Byb2Nlc3MuZW52W2tleV0hXSA9XG5cdFx0XHRcdHByb2Nlc3MuZW52W2BBRE1JTl9JRF8ke2FkbWluSW5kZXh9YF07XG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIHsgdXNlcm5hbWVUb1Bhc3N3b3JkTWFwLCB1c2VybmFtZVRvQWRtaW5JZE1hcCB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiB2YWxpZGF0ZUNyZWRlbnRpYWxzKFxuXHR1c2VybmFtZTogc3RyaW5nLFxuXHRwYXNzd29yZDogc3RyaW5nLFxuXHRhZG1pbkNyZWRlbnRpYWxzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCB1bmRlZmluZWQ+XG4pOiBQcm9taXNlPGJvb2xlYW4+IHtcblx0Y29uc3Qgc3RvcmVkSGFzaGVkUGFzc3dvcmQgPSBhZG1pbkNyZWRlbnRpYWxzW3VzZXJuYW1lXTtcblx0cmV0dXJuIHN0b3JlZEhhc2hlZFBhc3N3b3JkXG5cdFx0PyBhcmdvbjIudmVyaWZ5KHN0b3JlZEhhc2hlZFBhc3N3b3JkLCBwYXNzd29yZClcblx0XHQ6IGZhbHNlO1xufVxuXG5hc3luYyBmdW5jdGlvbiB2YWxpZGF0ZUFkbWluU2VjcmV0KFxuXHRrZXk6IHN0cmluZyxcblx0cHJlZml4OiBzdHJpbmdcbik6IFByb21pc2U8Ym9vbGVhbj4ge1xuXHRjb25zdCBhbGxvd2VkS2V5cyA9IE9iamVjdC5rZXlzKHByb2Nlc3MuZW52KVxuXHRcdC5maWx0ZXIoZW52S2V5ID0+IGVudktleS5zdGFydHNXaXRoKHByZWZpeCkpXG5cdFx0Lm1hcChlbnZLZXkgPT4gcHJvY2Vzcy5lbnZbZW52S2V5XSEpO1xuXG5cdHJldHVybiBQcm9taXNlLmFueShcblx0XHRhbGxvd2VkS2V5cy5tYXAoaGFzaGVkS2V5ID0+IGFyZ29uMi52ZXJpZnkoaGFzaGVkS2V5LCBrZXkpKVxuXHQpXG5cdFx0LnRoZW4oKCkgPT4gdHJ1ZSlcblx0XHQuY2F0Y2goKCkgPT4gZmFsc2UpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBsb2dBdHRlbXB0KFxuXHRzdWNjZXNzOiBib29sZWFuLFxuXHR1c2VybmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkLFxuXHRldmVudFR5cGU6IHN0cmluZ1xuKTogUHJvbWlzZTx2b2lkPiB7XG5cdHN0YXJ0dXBMb2dnZXIuaW5mbyh7XG5cdFx0dGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG5cdFx0dXNlcm5hbWU6IHVzZXJuYW1lIHx8ICdVbmtub3duJyxcblx0XHRzdWNjZXNzLFxuXHRcdGV2ZW50VHlwZSxcblx0XHRzeXN0ZW1Vc2VyOiBvcy51c2VySW5mbygpLnVzZXJuYW1lLFxuXHRcdC4uLmdldFN5c3RlbURldGFpbHMoKVxuXHR9KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxvZ2luKCk6IFByb21pc2U8e1xuXHRlbmNyeXB0aW9uS2V5OiBzdHJpbmcgfCBudWxsO1xuXHRncGdQYXNzcGhyYXNlOiBzdHJpbmcgfCBudWxsO1xuXHRhZG1pbklkOiBudW1iZXIgfCBudWxsO1xufT4ge1xuXHRsZXQgcmV0cmllcyA9IDM7XG5cblx0Y29uc29sZS5sb2coXG5cdFx0J1dlbGNvbWUgdG8gdGhlIGFwcGxpY2F0aW9uIEFkbWluIExvZ2luLiBQbGVhc2UgZW50ZXIgeW91ciBjcmVkZW50aWFscy4nXG5cdCk7XG5cblx0Y29uc3QgeyB1c2VybmFtZVRvUGFzc3dvcmRNYXAsIHVzZXJuYW1lVG9BZG1pbklkTWFwIH0gPVxuXHRcdGdldEFkbWluQ3JlZGVudGlhbHMoKTtcblx0aWYgKCFPYmplY3Qua2V5cyh1c2VybmFtZVRvUGFzc3dvcmRNYXApLmxlbmd0aClcblx0XHRoYW5kbGVGYXRhbEVycm9yKCdObyBhZG1pbiBjcmVkZW50aWFscyBmb3VuZC4nKTtcblxuXHR3aGlsZSAocmV0cmllcyA+IDApIHtcblx0XHRjb25zdCB7IHVzZXJuYW1lLCBwYXNzd29yZCB9ID0gYXdhaXQgcHJvbXB0Q3JlZGVudGlhbHMoKTtcblx0XHRjb25zdCB2YWxpZCA9IGF3YWl0IHZhbGlkYXRlQ3JlZGVudGlhbHMoXG5cdFx0XHR1c2VybmFtZSxcblx0XHRcdHBhc3N3b3JkLFxuXHRcdFx0dXNlcm5hbWVUb1Bhc3N3b3JkTWFwXG5cdFx0KTtcblxuXHRcdGlmICh2YWxpZCkge1xuXHRcdFx0Y29uc3QgYWRtaW5JZCA9IHVzZXJuYW1lVG9BZG1pbklkTWFwW3VzZXJuYW1lXTtcblx0XHRcdGlmICghYWRtaW5JZCkge1xuXHRcdFx0XHRoYW5kbGVGYXRhbEVycm9yKCdBZG1pbiBJRCBub3QgZm91bmQuJyk7XG5cdFx0XHRcdHJldHVybiB7XG5cdFx0XHRcdFx0ZW5jcnlwdGlvbktleTogbnVsbCxcblx0XHRcdFx0XHRncGdQYXNzcGhyYXNlOiBudWxsLFxuXHRcdFx0XHRcdGFkbWluSWQ6IG51bGxcblx0XHRcdFx0fTtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgZW5jcnlwdGlvbktleSA9IGF3YWl0IGhhbmRsZVNlY3JldFZhbGlkYXRpb24oXG5cdFx0XHRcdCdFbnRlciBFbmNyeXB0aW9uIEtleTogJyxcblx0XHRcdFx0J0VOQ1JZUFRJT05fS0VZXydcblx0XHRcdCk7XG5cdFx0XHRjb25zdCBncGdQYXNzcGhyYXNlID0gYXdhaXQgaGFuZGxlU2VjcmV0VmFsaWRhdGlvbihcblx0XHRcdFx0J0VudGVyIEdQRyBQYXNzcGhyYXNlOiAnLFxuXHRcdFx0XHQnR1BHX1BBU1NQSFJBU0VfJ1xuXHRcdFx0KTtcblxuXHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0ZW5jcnlwdGlvbktleSxcblx0XHRcdFx0Z3BnUGFzc3BocmFzZSxcblx0XHRcdFx0YWRtaW5JZDogcGFyc2VJbnQoYWRtaW5JZCwgMTApXG5cdFx0XHR9O1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRyZXRyaWVzLS07XG5cdFx0XHRjb25zb2xlLmxvZyhgSW52YWxpZCBjcmVkZW50aWFscy4gQXR0ZW1wdHMgbGVmdDogJHtyZXRyaWVzfWApO1xuXHRcdFx0YXdhaXQgbG9nQXR0ZW1wdChmYWxzZSwgdXNlcm5hbWUsICdsb2dpbicpO1xuXHRcdH1cblx0fVxuXG5cdGhhbmRsZUZhdGFsRXJyb3IoJ01heGltdW0gcmV0cmllcyByZWFjaGVkLicpO1xuXG5cdHJldHVybiB7IGVuY3J5cHRpb25LZXk6IG51bGwsIGdwZ1Bhc3NwaHJhc2U6IG51bGwsIGFkbWluSWQ6IG51bGwgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaGFuZGxlU2VjcmV0VmFsaWRhdGlvbihcblx0cHJvbXB0TWVzc2FnZTogc3RyaW5nLFxuXHRwcmVmaXg6IHN0cmluZ1xuKTogUHJvbWlzZTxzdHJpbmc+IHtcblx0Zm9yIChsZXQgYXR0ZW1wdHMgPSAwOyBhdHRlbXB0cyA8IDM7IGF0dGVtcHRzKyspIHtcblx0XHRjb25zdCBzZWNyZXQgPSBhd2FpdCBwcm9tcHRBZG1pblNlY3JldChwcm9tcHRNZXNzYWdlKTtcblx0XHRpZiAoYXdhaXQgdmFsaWRhdGVBZG1pblNlY3JldChzZWNyZXQsIHByZWZpeCkpIHtcblx0XHRcdGF3YWl0IGxvZ0F0dGVtcHQoXG5cdFx0XHRcdHRydWUsXG5cdFx0XHRcdHVuZGVmaW5lZCxcblx0XHRcdFx0YCR7cHJlZml4LnRvTG93ZXJDYXNlKCl9LXZhbGlkYXRpb25gXG5cdFx0XHQpO1xuXHRcdFx0cmV0dXJuIHNlY3JldDtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc29sZS5sb2coYEludmFsaWQgJHtwcm9tcHRNZXNzYWdlLnRyaW0oKX0uIFBsZWFzZSB0cnkgYWdhaW4uYCk7XG5cdFx0fVxuXHR9XG5cblx0aGFuZGxlRmF0YWxFcnJvcihgTWF4aW11bSAke3Byb21wdE1lc3NhZ2UudHJpbSgpfSByZXRyaWVzIHJlYWNoZWQuYCk7XG5cdHJldHVybiAnJztcbn1cbiJdfQ==
